"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9569],{39569:(ve,Z,s)=>{s.d(Z,{L:()=>At});var l=s(96540),Q=s(63329),X=s(79971),z=s(80095),Y=s(94701);function v({children:n,width:e,height:i,onLoad:t,onChange:a}){const o=(0,l.useId)(),[r,c]=(0,l.useState)(!1),[d,u]=(0,l.useState)(!1),p=(0,l.useRef)(null);return(0,Y.A)(()=>{v.addCallback(o,C=>{!r&&C.isIntersecting&&(c(!0),t?.()),u(C.isIntersecting),a?.(C.isIntersecting)});const g=p.current;return g&&v.observer.observe(g),()=>{delete v.callbacks[o],g&&v.observer.unobserve(g),Object.keys(v.callbacks).length===0&&v.observer.disconnect()}}),l.createElement("div",{id:o,ref:p,style:{width:e,height:i}},r&&(typeof n=="function"?n({isInView:d}):n))}const q={};v.callbacks=q,v.addCallback=(n,e)=>v.callbacks[n]=e,v.observer=new IntersectionObserver(n=>{for(const e of n)v.callbacks[e.target.id]&&v.callbacks[e.target.id](e)},{rootMargin:"100px"});var J=s(64423),y=s(39070),B=s(43127),x=s(7376),S=s(91052),T=s(2913),H=s(15054),K=s(40334),b=s(74856),_=s(36663),le=s(72574),F=s(12131),ye=s(32264),E=s(7758),V=s(16560),Ie=s(32349),Pe=s(8480),R=s(32196),ee=s(43585),ce=s(40845),te=s(56034),j=s(14578),De=s(15666),U=s(38138),Se=s(83122),Te=s(27746);function Ne({panelLinks:n,onShowPanelLinks:e}){const i=(0,ce.of)(Oe),t=()=>{const a=e();return l.createElement(U.W,null,a?.map((o,r)=>l.createElement(U.W.Item,{key:r,label:o.title,url:o.href,target:o.target,onClick:o.onClick})))};if(n.length===1){const a=e()[0];return l.createElement(S.NR.TitleItem,{href:a.href,onClick:a.onClick,target:a.target,title:a.title},l.createElement(j.I,{name:"external-link-alt",size:"md"}))}else return l.createElement(Se.m,{overlay:t},l.createElement(Te.I,{icon:"external-link-alt",iconSize:"md","aria-label":"panel links",className:i.menuTrigger}))}const Oe=n=>({menuTrigger:(0,R.css)({height:"100%",background:"inherit",border:"none",borderRadius:`${n.shape.radius.default}`,cursor:"context-menu"})});var Ae=s(2038);function Me(n){const{alertState:e,data:i,panelId:t,onShowPanelLinks:a,panelLinks:o,angularNotice:r}=n,c=(0,ce.of)(Re),d=l.createElement(te.m,{content:e??"unknown"},l.createElement(S.NR.TitleItem,{className:(0,R.cx)({[c.ok]:e===ee.O.OK,[c.pending]:e===ee.O.Pending,[c.alerting]:e===ee.O.Alerting})},l.createElement(j.I,{name:e==="alerting"?"heart-break":"heart",className:"panel-alert-icon",size:"md"}))),u=l.createElement(l.Fragment,null,i.request&&i.request.timeInfo&&l.createElement(te.m,{content:l.createElement(De.xS,{timeRange:i.request?.range,timeZone:i.request?.timezone})},l.createElement(S.NR.TitleItem,{className:c.timeshift},l.createElement(j.I,{name:"clock-nine",size:"md"})," ",i.request?.timeInfo))),p=`This ${xe(r)} requires Angular (deprecated).`,g=l.createElement(te.m,{content:p},l.createElement(S.NR.TitleItem,{className:c.angularNotice,"data-testid":"angular-deprecation-icon"},l.createElement(j.I,{name:"exclamation-triangle",size:"md"})));return l.createElement(l.Fragment,null,o&&o.length>0&&a&&l.createElement(Ne,{onShowPanelLinks:a,panelLinks:o}),l.createElement(Ae.Z,{panelId:t,frames:i.series}),u,e&&d,r?.show&&g)}const xe=n=>n?.isAngularPanel?"panel":n?.isAngularDatasource?"data source":"panel or data source",Re=n=>({ok:(0,R.css)({color:n.colors.success.text}),pending:(0,R.css)({color:n.colors.warning.text}),alerting:(0,R.css)({color:n.colors.error.text}),timeshift:(0,R.css)({color:n.colors.text.link,gap:n.spacing(.5),whiteSpace:"nowrap","&:hover":{color:n.colors.emphasize(n.colors.text.link,.03)}}),angularNotice:(0,R.css)({color:n.colors.warning.text})});function de(n){function e(){return n.data.request&&n.data.request.timeInfo?!1:!n.panel.hasTitle()}const i=()=>{const I=(0,le.w)().replace(n.panel.description,n.panel.scopedVars);return(0,_.G)(I)},t=()=>{const I=(0,Ie.E7)(n.panel);if(!I)return[];const f=I&&I.getLinks(n.panel.replaceVariables);return f.map(w=>({...w,onClick:(...$)=>{E.c.panelLinkClicked({has_multiple_links:f.length>1}),w.onClick?.(...$)}}))},a=(I,f)=>{I.stopPropagation(),F.Ny.partial({inspect:n.panel.id,inspectTab:f})},o=I=>{I.stopPropagation(),F.Ny.partial({inspect:n.panel.id,inspectTab:V.q.Error}),E.c.panelStatusMessageClicked()},r=()=>{n.panel.getQueryRunner().cancelQuery(),E.c.panelCancelQueryClicked({data_state:n.data.state})},c=n.plugin.noPadding?"none":"md",d=n.data.alertState?.state,u=n.panel.datasource?.uid?(0,Pe.Hv)(n.panel.datasource?.uid):!1,p=n.panel.isAngularPlugin()&&!n.plugin.meta.angular?.hideDeprecation,g=(ye.$.featureToggles.angularDeprecationUI??!1)&&(u||p),D=(n.panel.links&&n.panel.links.length>0&&t||n.data.series.length>0&&n.data.series.some(I=>(I.meta?.notices?.length??0)>0)||n.data.request&&n.data.request.timeInfo||g||d)&&l.createElement(Me,{alertState:d,data:n.data,panelId:n.panel.id,panelLinks:n.panel.links,angularNotice:{show:g,isAngularDatasource:u,isAngularPanel:p},onShowPanelLinks:t}),W=n.panel.description?i:void 0,P=!(n.isViewing||n.isEditing)&&(n.isDraggable??!0)?"grid-drag-handle":"",k=n.panel.getDisplayTitle();return{hasOverlayHeader:e,onShowPanelDescription:i,onShowPanelLinks:t,onOpenInspector:a,onOpenErrorInspect:o,onCancelQuery:r,padding:c,description:W,dragClass:P,title:k,titleItems:D,onOpenMenu:()=>{E.c.panelMenuShown()}}}var Le=s(13544);function Fe({items:n}){const e=i=>i.map(t=>{switch(t.type){case"divider":return l.createElement(U.W.Divider,{key:t.text});case"group":return l.createElement(U.W.Group,{key:t.text,label:t.text},t.subMenu?e(t.subMenu):void 0);default:return l.createElement(U.W.Item,{key:t.text,label:t.text,icon:t.iconClassName,childItems:t.subMenu?e(t.subMenu):void 0,url:t.href,onClick:t.onClick,shortcut:t.shortcut,testId:Le.Tp.components.Panels.Panel.menuItems(t.text)})}});return l.createElement(U.W,null,e(n))}var Ve=s(31678),Ue=s(76885),ke=s(74135),He=s(1933),be=s(4402),Ge=s(3169),m=s(44836),We=s(16001),he=s(16233),we=s(94954),Qe=s(87490),ze=s(63066),M=s(19752),Je=s(82792),Be=s(75462),Ke=s(14348),ne=s(99140),je=s(75471),$e=s(29436);function Ze(n,e,i){const t=h=>{h.preventDefault(),F.Ny.partial({viewPanel:e.id}),E.c.panelMenuItemClicked("view")},a=h=>{h.preventDefault(),F.Ny.partial({editPanel:e.id}),E.c.panelMenuItemClicked("edit")},o=h=>{h.preventDefault(),(0,M.Mc)(n,e),E.c.panelMenuItemClicked("share")},r=h=>{h.preventDefault(),(0,M.d7)(n,e),E.c.panelMenuItemClicked("createLibraryPanel")},c=h=>{h.preventDefault(),(0,M.ZY)(e),E.c.panelMenuItemClicked("unlinkLibraryPanel")},d=h=>{F.Ny.partial({inspect:e.id,inspectTab:h}),E.c.panelMenuInspectClicked(h??V.q.Data)},u=h=>{h.preventDefault()},p=h=>{h.preventDefault(),(0,M.iU)(n,e),E.c.panelMenuItemClicked("duplicate")},g=h=>{h.preventDefault(),(0,M.KJ)(e),E.c.panelMenuItemClicked("copy")},C=h=>{h.preventDefault(),(0,M.FC)(n,e,!0),E.c.panelMenuItemClicked("remove")},D=h=>{h.preventDefault();const O=h.ctrlKey||h.metaKey?A=>window.open(`${T.Ay.appSubUrl}${A}`):void 0;ne.M_.dispatch((0,$e.ow)(e,{timeRange:(0,b.jG)().timeRange(),getExploreUrl:Qe.Xe,openInNewWindow:O})),E.c.panelMenuItemClicked("explore")},W=h=>{h.preventDefault(),(0,M.ET)(e),E.c.panelMenuItemClicked("toggleLegend")},P=[];e.isEditing||P.push({text:(0,m.t)("panel.header-menu.view","View"),iconClassName:"eye",onClick:t,shortcut:"v"}),n.canEditPanel(e)&&!e.isEditing&&P.push({text:(0,m.t)("panel.header-menu.edit","Edit"),iconClassName:"edit",onClick:a,shortcut:"e"}),P.push({text:(0,m.t)("panel.header-menu.share","Share"),iconClassName:"share-alt",onClick:o,shortcut:"p s"}),he.TP.hasAccessToExplore()&&!(e.plugin&&e.plugin.meta.skipDataQuery)&&e.datasource?.uid!==Ke.K&&P.push({text:(0,m.t)("panel.header-menu.explore","Explore"),iconClassName:"compass",onClick:D,shortcut:"p x"});const k=[];e.plugin&&!e.plugin.meta.skipDataQuery&&(k.push({text:(0,m.t)("panel.header-menu.inspect-data","Data"),onClick:h=>d(V.q.Data)}),n.meta.canEdit&&k.push({text:(0,m.t)("panel.header-menu.query","Query"),onClick:h=>d(V.q.Query)})),k.push({text:(0,m.t)("panel.header-menu.inspect-json","Panel JSON"),onClick:h=>d(V.q.JSON)}),P.push({type:"submenu",text:(0,m.t)("panel.header-menu.inspect","Inspect"),iconClassName:"info-circle",onClick:h=>{const O=h.currentTarget,A=h.target;(A===O||A instanceof HTMLElement&&A.closest('[role="menuitem"]')===O)&&d()},shortcut:"i",subMenu:k});const fe=async()=>{let h;try{h=await(0,ze.mp)(e,n)}catch(A){const L=`Error getting rule values from the panel: ${(0,we.q)(A)}`;(0,ne.JD)((0,We.dx)((0,Ge.gi)(L)));return}const O=Ue.kM.renderUrl("/alerting/new",{defaults:JSON.stringify(h),returnTo:location.pathname+location.search});F.Ny.push(O)},I=h=>{h.preventDefault(),fe(),E.c.panelMenuItemClicked("create-alert")},f=[],w=n.canEditPanel(e),$=(0,je.q0)();if(e.isViewing||e.isEditing||(w?(f.push({text:(0,m.t)("panel.header-menu.duplicate","Duplicate"),onClick:p,shortcut:"p d"}),f.push({text:(0,m.t)("panel.header-menu.copy","Copy"),onClick:g}),(0,Je.X)(e)?f.push({text:(0,m.t)("panel.header-menu.unlink-library-panel","Unlink library panel"),onClick:c}):f.push({text:(0,m.t)("panel.header-menu.create-library-panel","Create library panel"),onClick:r})):he.TP.isEditor&&f.push({text:(0,m.t)("panel.header-menu.copy","Copy"),onClick:g})),$&&f.push({text:(0,m.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:I}),i){const h=i.getScope(),O=h.$$childHead.ctrl,A=O.getExtendedMenu();for(const L of A){const Ce={text:L.text,href:L.href,shortcut:L.shortcut};L.click&&(Ce.onClick=()=>{h.$eval(L.click,{ctrl:O})}),f.push(Ce)}}e.options.legend&&f.push({text:e.options.legend.showLegend?(0,m.t)("panel.header-menu.hide-legend","Hide legend"):(0,m.t)("panel.header-menu.show-legend","Show legend"),onClick:W,shortcut:"p l"}),e.isEditing&&(f.length=0,$&&f.push({text:(0,m.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:I})),w&&e.plugin&&!e.plugin.meta.skipDataQuery&&f.push({text:(0,m.t)("panel.header-menu.get-help","Get help"),onClick:h=>d(V.q.Help)});const{extensions:Ee}=(0,be.Kf)({extensionPointId:ke.S.DashboardPanelMenu,context:Xe(e,n),limitPerPlugin:3});return Ee.length>0&&!e.isEditing&&P.push({text:"Extensions",iconClassName:"plug",type:"submenu",subMenu:(0,Be.N9)(Ee)}),f.length&&P.push({type:"submenu",text:(0,m.t)("panel.header-menu.more","More..."),iconClassName:"cube",subMenu:f,onClick:u}),n.canEditPanel(e)&&!e.isEditing&&!e.isViewing&&(P.push({type:"divider",text:""}),P.push({text:(0,m.t)("panel.header-menu.remove","Remove"),iconClassName:"trash-alt",onClick:C,shortcut:"p r"})),P}function Xe(n,e){return{id:n.id,pluginId:n.type,title:n.title,timeRange:e.time,timeZone:(0,He.O)({timeZone:e.timezone}),dashboard:{uid:e.uid,title:e.title,tags:Array.from(e.tags)},targets:n.targets,scopedVars:n.scopedVars,data:n.getQueryRunner().getLastResult()}}function Ye({panel:n,dashboard:e,loadingState:i,children:t}){const[a,o]=(0,l.useState)([]),r=(0,Ve.useSelector)(c=>(0,K.U)(c,n)?.angularComponent);return(0,l.useEffect)(()=>{o(Ze(e,n,r))},[e,n,r,i,o]),t({items:a})}function ue({style:n,panel:e,dashboard:i,loadingState:t}){return l.createElement(Ye,{panel:e,dashboard:i,loadingState:t},({items:a})=>l.createElement(Fe,{style:n,items:a}))}class qe extends l.PureComponent{constructor(e){super(e),this.element=null,this.timeSrv=(0,b.jG)(),this.subs=new J.yU,this.state={data:{state:y.Gu.NotStarted,series:[],timeRange:(0,B.E2)()}}}componentDidMount(){const{panel:e}=this.props;this.loadAngularPanel();const i=e.getQueryRunner();this.subs.add(i.getData({withTransforms:!1,withFieldConfig:!1}).subscribe({next:t=>this.onPanelDataUpdate(t)}))}onPanelDataUpdate(e){let i;if(e.state===y.Gu.Error){const{error:t}=e;t&&i!==t.message&&(i=t.message)}this.setState({data:e,errorMessage:i})}componentWillUnmount(){this.subs.unsubscribe(),this.props.angularComponent&&this.props.angularComponent?.destroy()}componentDidUpdate(e,i){const{plugin:t,height:a,width:o,panel:r}=this.props;e.plugin!==t&&this.loadAngularPanel(),(e.width!==o||e.height!==a)&&this.scopeProps&&(this.scopeProps.size.height=this.getInnerPanelHeight(),this.scopeProps.size.width=this.getInnerPanelWidth(),r.render())}getInnerPanelHeight(){const{plugin:e,height:i}=this.props,{theme:t}=T.Ay,a=this.hasOverlayHeader()?0:t.panelHeaderHeight,o=e.noPadding?0:t.panelPadding;return i-a-o*2-H.IZ}getInnerPanelWidth(){const{plugin:e,width:i}=this.props,{theme:t}=T.Ay,a=e.noPadding?0:t.panelPadding;return i-a*2-H.IZ}loadAngularPanel(){const{panel:e,dashboard:i,setPanelAngularComponent:t}=this.props;if(!this.element)return;const a=(0,x.E)(),o='<plugin-component type="panel" class="panel-height-helper"></plugin-component>';this.scopeProps={panel:e,dashboard:i,size:{width:this.getInnerPanelWidth(),height:this.getInnerPanelHeight()}},t({key:e.key,angularComponent:a.load(this.element,this.scopeProps,o)})}hasOverlayHeader(){const{panel:e}=this.props,{data:i}=this.state;return i.request&&i.request.timeInfo?!1:!e.hasTitle()}render(){const{dashboard:e,panel:i}=this.props,{errorMessage:t,data:a}=this.state,{transparent:o}=i,r=de({...this.props,data:a}),c=(i.gridPos?.y??0)===0?-16:void 0,d=l.createElement("div",{"data-testid":"panel-dropdown"},l.createElement(ue,{panel:i,dashboard:e,loadingState:a.state}));return l.createElement(S.NR,{width:this.props.width,height:this.props.height,title:r.title,loadingState:a.state,statusMessage:t,statusMessageOnClick:r.onOpenErrorInspect,description:r.description,titleItems:r.titleItems,menu:this.props.hideMenu?void 0:d,dragClass:r.dragClass,dragClassCancel:"grid-drag-cancel",padding:r.padding,hoverHeaderOffset:c,hoverHeader:r.hasOverlayHeader(),displayMode:o?"transparent":"default",onCancelQuery:r.onCancelQuery,onOpenMenu:r.onOpenMenu},()=>l.createElement("div",{ref:u=>this.element=u,className:"panel-height-helper"}))}}const _e=(n,e)=>({angularComponent:(0,K.U)(n,e.panel)?.angularComponent}),et={setPanelAngularComponent:z.S3},tt=(0,Q.connect)(_e,et)(qe);var nt=s(94624),G=s(41987),ae=s(69129),pe=s(47232),at=s(22391),st=s(14236),it=s(3591),ot=s(79041),rt=s(66602),lt=s(18898),ct=s(31193),dt=s(26260),ht=s(90478),ge=s(1173),ut=s(24293);const pt=(n,e,i)=>{const{overrides:t}=i,a=i.overrides.findIndex(u=>u.matcher.id===ge.Ct.byName&&u.matcher.options===n);if(a<0)return{...i,overrides:[...i.overrides,gt(n,e)]};const o=Array.from(t),r=o[a],c=r.properties.findIndex(u=>u.id==="color");if(c<0)return o[a]={...r,properties:[...r.properties,se(e)]},{...i,overrides:o};const d=Array.from(r.properties);return d[c]=se(e),o[a]={...r,properties:d},{...i,overrides:o}},gt=(n,e)=>({matcher:{id:ge.Ct.byName,options:n},properties:[se(e)]}),se=n=>({id:"color",value:{mode:ut.Y.Fixed,fixedColor:n}});var mt=s(28444),ie=s(10154),oe=s(42972),ft=s(60444),me=s(32631),N=(n=>(n.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT="field config overrides changed",n.NEW_PANEL_OPTION_EVENT="new panel option",n.PANEL_OPTION_CHANGED_EVENT="panel option changed",n.NEW_DEFAULT_FIELD_CONFIG_EVENT="new default field config",n.DEFAULT_FIELD_CONFIG_CHANGED_EVENT="default field config changed",n.NEW_CUSTOM_FIELD_CONFIG_EVENT="new custom field config",n.CUSTOM_FIELD_CONFIG_CHANGED_EVENT="custom field config changed",n.MEASURE_PANEL_LOAD_TIME_EVENT="measure panel load time",n.THRESHOLDS_COUNT_CHANGED_EVENT="thresholds count changed",n.THRESHOLDS_MODE_CHANGED_EVENT="thresholds mode changed",n.MAPPINGS_COUNT_CHANGED_EVENT="mappings count changed",n.LINKS_COUNT_CHANGED_EVENT="links count changed",n.PANEL_ERROR="panel error",n))(N||{});const Et="overrides",Ct="custom",vt=n=>{const e=performance.now();return(0,l.useEffect)(()=>{T.config.grafanaJavascriptAgent.enabled&&requestAnimationFrame(()=>{setTimeout(()=>{me.P.api.pushMeasurement({type:N.MEASURE_PANEL_LOAD_TIME_EVENT,values:{start_loading_time_ms:e,load_time_ms:performance.now()-e}},{context:{panel_type:n.panelType,panel_id:String(n.panelId),panel_title:n.panelTitle}})},0)})},[]),null};var yt=s(91126),re=s(61582);class It{constructor(e,i,t){this.logChanges=(a,o)=>{this.logPanelOptionChanges(a,this.initialPanelOptions),this.logFieldConfigChanges(o,this.initialFieldConfig),this.initialPanelOptions=a,this.initialFieldConfig=o},this.logPanelEvent=(a,o,r,c)=>{const d={key:o,newValue:r,oldValue:c??"",panelTitle:this.panelLogInfo.panelTitle,panelId:this.panelLogInfo.panelId,panelType:this.panelLogInfo.panelType};me.P.api.pushEvent(a,d)},this.logPanelOptionChanges=(a,o)=>{if(typeof a!="object"||a===null||typeof o!="object"||o===null)return;const r={...o};for(const[c,d]of Object.entries(a)){const u=typeof d!="string"?JSON.stringify(d):d,p=typeof d!="string"?JSON.stringify(r[c]):String(r[c]);r[c]===void 0?this.logPanelEvent(N.NEW_PANEL_OPTION_EVENT,c,u):p!==u&&this.logPanelEvent(N.PANEL_OPTION_CHANGED_EVENT,c,u,p)}},this.logFieldConfigChanges=(a,o)=>{const r=JSON.stringify(o.overrides),c=JSON.stringify(a.overrides);r!==c&&this.logPanelEvent(N.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT,Et,c,r);const d={...o.defaults};for(const[p,g]of Object.entries(a.defaults)){if(p===Ct)continue;const C=typeof g!="string"?JSON.stringify(g):g,D=typeof g!="string"?JSON.stringify(d[p]):String(d[p]);d[p]===void 0?this.logPanelEvent(N.NEW_DEFAULT_FIELD_CONFIG_EVENT,p,C):D!==C&&this.logPanelEvent(N.DEFAULT_FIELD_CONFIG_CHANGED_EVENT,p,C,D)}if(!a.defaults.custom||d.custom===void 0)return;const u={...d.custom};for(const[p,g]of Object.entries(a.defaults.custom)){if(d.custom===null||u[p]===null)continue;const C=typeof g!="string"?JSON.stringify(g):g,D=typeof g!="string"?JSON.stringify(u[p]):String(u[p]);u[p]===void 0?this.logPanelEvent(N.NEW_CUSTOM_FIELD_CONFIG_EVENT,p,C):D!==C&&this.logPanelEvent(N.CUSTOM_FIELD_CONFIG_CHANGED_EVENT,p,C,D)}},this.initialPanelOptions=e,this.initialFieldConfig=i,this.panelLogInfo=t}}const Pt="Error in plugin";class Dt extends l.PureComponent{constructor(e){super(e),this.timeSrv=(0,b.jG)(),this.subs=new J.yU,this.eventFilter={onlyLocal:!0},this.panelOptionsLogger=void 0,this.getSync=()=>this.props.isEditing?nt.y.Off:this.props.dashboard.graphTooltip,this.onInstanceStateChange=t=>{this.props.onInstanceStateChange(t),this.setState({context:{...this.state.context,instanceState:t}})},this.onUpdateData=t=>(0,ht.H)(this.props.panel,t),this.onSeriesColorChange=(t,a)=>{this.onFieldConfigChange(pt(t,a,this.props.panel.fieldConfig))},this.onSeriesVisibilityChange=(t,a)=>{this.onFieldConfigChange((0,yt.M)(t,a,this.props.panel.fieldConfig,this.state.data.series))},this.onToggleLegendSort=t=>{const a=this.props.panel.options.legend;if(!a)return;let o=a.sortDesc,r=a.sortBy;t!==r&&(o=void 0),o===!1?(r=void 0,o=void 0):(o=!o,r=t),this.onOptionsChange({...this.props.panel.options,legend:{...a,sortBy:r,sortDesc:o}})},this.onRefresh=()=>{const{dashboard:t,panel:a,isInView:o,width:r}=this.props;if(!t.snapshot&&!o){a.refreshWhenInView=!0;return}const c=(0,M.nk)(a,this.timeSrv.timeRange());if(this.wantsQueryExecution){if(r<0)return;a.refreshWhenInView=!1,a.runAllPanelQueries({dashboardUID:t.uid,dashboardTimezone:t.getTimezone(),timeData:c,width:r})}else this.setState({data:{...this.state.data,timeRange:this.timeSrv.timeRange()},renderCounter:this.state.renderCounter+1,liveTime:void 0})},this.onRender=()=>{const t={renderCounter:this.state.renderCounter+1};this.setState(t)},this.onOptionsChange=t=>{this.props.panel.updateOptions(t)},this.onFieldConfigChange=t=>{this.props.panel.updateFieldConfig(t)},this.onPanelError=t=>{T.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===G.Jk.PanelEditor&&this.logPanelChangesOnError();const a=t.message||Pt;this.state.errorMessage!==a&&this.setState({errorMessage:a})},this.onPanelErrorRecover=()=>{this.setState({errorMessage:void 0})},this.onAnnotationCreate=async t=>{const a=t.from!==t.to,o={dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:t.from,timeEnd:a?t.to:0,tags:t.tags,text:t.description};await(0,ie.vJ)(o),(0,oe.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new ae.We(o))},this.onAnnotationDelete=async t=>{await(0,ie.Xm)({id:t}),(0,oe.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new ae.We({id:t}))},this.onAnnotationUpdate=async t=>{const a=t.from!==t.to,o={id:t.id,dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:t.from,timeEnd:a?t.to:0,tags:t.tags,text:t.description};await(0,ie.rJ)(o),(0,oe.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new ae.We(o))},this.onChangeTimeRange=t=>{this.timeSrv.setTime({from:(0,pe.yT)(t.from),to:(0,pe.yT)(t.to)})},this.onAddAdHocFilter=t=>{const{key:a,value:o,operator:r}=t,c=(0,ct.tR)().getInstanceSettings(this.props.panel.datasource),d=c&&(0,at.p$)(c);d&&(0,ne.JD)((0,dt.z_)({datasource:d,key:a,operator:r,value:o}))};const i=e.dashboard.events.newScopedBus(`panel:${e.panel.id}`,this.eventFilter);if(this.state={isFirstLoad:!0,renderCounter:0,context:{eventsScope:"__global_",eventBus:i,app:this.getPanelContextApp(),sync:this.getSync,onSeriesColorChange:this.onSeriesColorChange,onToggleSeriesVisibility:this.onSeriesVisibilityChange,onAnnotationCreate:this.onAnnotationCreate,onAnnotationUpdate:this.onAnnotationUpdate,onAnnotationDelete:this.onAnnotationDelete,onInstanceStateChange:this.onInstanceStateChange,onToggleLegendSort:this.onToggleLegendSort,canAddAnnotations:e.dashboard.canAddAnnotations.bind(e.dashboard),canEditAnnotations:e.dashboard.canEditAnnotations.bind(e.dashboard),canDeleteAnnotations:e.dashboard.canDeleteAnnotations.bind(e.dashboard),onAddAdHocFilter:this.onAddAdHocFilter,onUpdateData:this.onUpdateData},data:this.getInitialPanelDataState()},T.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===G.Jk.PanelEditor){const t={panelId:String(e.panel.id),panelType:e.panel.type,panelTitle:e.panel.title};this.panelOptionsLogger=new It(e.panel.getOptions(),e.panel.fieldConfig,t)}}getPanelContextApp(){return this.props.isEditing?G.Jk.PanelEditor:this.props.isViewing?G.Jk.PanelViewer:G.Jk.Dashboard}getInitialPanelDataState(){return{state:y.Gu.NotStarted,series:[],timeRange:(0,B.E2)()}}componentDidMount(){const{panel:e,dashboard:i}=this.props;if(this.subs.add(e.events.subscribe(it._,this.onRefresh)),this.subs.add(e.events.subscribe(mt.XM,this.onRender)),i.panelInitialized(this.props.panel),this.hasPanelSnapshot){this.setState({data:(0,ft.d)(e,i),isFirstLoad:!1});return}this.wantsQueryExecution||this.setState({isFirstLoad:!1}),this.subs.add(e.getQueryRunner().getData({withTransforms:!0,withFieldConfig:!0}).subscribe({next:t=>this.onDataUpdate(t)})),re.a.listen(this)}componentWillUnmount(){this.subs.unsubscribe(),re.a.remove(this)}liveTimeChanged(e){const{data:i}=this.state;if(i.timeRange){const t=e.to.valueOf()-i.timeRange.to.valueOf();if(t<100){console.log("Skip tick render",this.props.panel.title,t);return}}this.setState({liveTime:e})}componentDidUpdate(e){const{isInView:i,width:t,panel:a}=this.props,{context:o}=this.state,r=this.getPanelContextApp();o.app!==r&&this.setState({context:{...o,app:r}}),i!==e.isInView&&i&&a.refreshWhenInView&&this.onRefresh(),t!==e.width&&re.a.updateInterval(this)}onDataUpdate(e){const{dashboard:i,panel:t,plugin:a}=this.props;if(a.meta.skipDataQuery){this.setState({data:this.getInitialPanelDataState()});return}let{isFirstLoad:o}=this.state,r;switch(e.state){case y.Gu.Loading:if(this.state.data.state===y.Gu.Loading)return;break;case y.Gu.Error:const{error:c,errors:d}=e;d?.length?d.length===1?r=d[0].message:r="Multiple errors found. Click for more details":c&&r!==c.message&&(r=c.message);break;case y.Gu.Done:i.snapshot&&(t.snapshotData=e.series.map(u=>(0,st.Kl)(u))),o&&(o=!1);break}this.setState({isFirstLoad:o,errorMessage:r,data:e,liveTime:void 0})}logPanelChangesOnError(){this.panelOptionsLogger.logChanges(this.props.panel.getOptions(),this.props.panel.fieldConfig)}get hasPanelSnapshot(){const{panel:e}=this.props;return e.snapshotData&&e.snapshotData.length}get wantsQueryExecution(){return!(this.props.plugin.meta.skipDataQuery||this.hasPanelSnapshot)}shouldSignalRenderingCompleted(e,i){return e===y.Gu.Done||e===y.Gu.Streaming||e===y.Gu.Error||i.skipDataQuery}skipFirstRender(e){const{isFirstLoad:i}=this.state;return this.wantsQueryExecution&&i&&(e===y.Gu.Loading||e===y.Gu.NotStarted)}renderPanelContent(e,i){const{panel:t,plugin:a,dashboard:o}=this.props,{renderCounter:r,data:c}=this.state,{state:d}=c;if(this.skipFirstRender(d))return null;this.shouldSignalRenderingCompleted(d,a.meta)&&lt.E.renderingCompleted();const u=a.panel,p=this.state.liveTime??c.timeRange??this.timeSrv.timeRange(),g=t.getOptions();return this.eventFilter.onlyLocal=o.graphTooltip===0,l.createElement(l.Fragment,null,l.createElement(ot.XF,{value:this.state.context},l.createElement(u,{id:t.id,data:c,title:t.title,timeRange:p,timeZone:this.props.dashboard.getTimezone(),options:g,fieldConfig:t.fieldConfig,transparent:t.transparent,width:e,height:i,renderCounter:r,replaceVariables:t.replaceVariables,onOptionsChange:this.onOptionsChange,onFieldConfigChange:this.onFieldConfigChange,onChangeTimeRange:this.onChangeTimeRange,eventBus:o.events}),T.Ay.featureToggles.panelMonitoring&&this.state.errorMessage===void 0&&l.createElement(vt,{panelType:a.meta.id,panelId:t.id,panelTitle:t.title})))}render(){const{dashboard:e,panel:i,width:t,height:a,plugin:o}=this.props,{errorMessage:r,data:c}=this.state,{transparent:d}=i,u=de({...this.props,data:c}),p=(i.gridPos?.y??0)===0?-16:void 0,g=l.createElement("div",{"data-testid":"panel-dropdown"},l.createElement(ue,{panel:i,dashboard:e,loadingState:c.state}));return l.createElement(S.NR,{width:t,height:a,title:u.title,loadingState:c.state,statusMessage:r,statusMessageOnClick:u.onOpenErrorInspect,description:u.description,titleItems:u.titleItems,menu:this.props.hideMenu?void 0:g,dragClass:u.dragClass,dragClassCancel:"grid-drag-cancel",padding:u.padding,hoverHeaderOffset:p,hoverHeader:u.hasOverlayHeader(),displayMode:d?"transparent":"default",onCancelQuery:u.onCancelQuery,onOpenMenu:u.onOpenMenu},(C,D)=>l.createElement(l.Fragment,null,l.createElement(rt.tH,{dependencies:[c,o,i.getOptions()],onError:this.onPanelError,onRecover:this.onPanelErrorRecover},({error:W})=>W?null:this.renderPanelContent(C,D))))}}const St=(n,e)=>{const i=n.panels[e.stateKey];return i?{plugin:i.plugin,instanceState:i.instanceState}:{plugin:void 0}},Tt={initPanelState:X.Ap,setPanelInstanceState:z.nF},Nt=(0,Q.connect)(St,Tt);class Ot extends l.PureComponent{constructor(){super(...arguments),this.onInstanceStateChange=e=>{this.props.setPanelInstanceState({key:this.props.stateKey,value:e})},this.onVisibilityChange=e=>{this.props.panel.isInView=e},this.onPanelLoad=()=>{this.props.plugin||this.props.initPanelState(this.props.panel)},this.renderPanel=({isInView:e})=>{const{dashboard:i,panel:t,isViewing:a,isEditing:o,width:r,height:c,plugin:d,timezone:u,hideMenu:p,isDraggable:g=!0}=this.props;return d?d&&d.angularPanelCtrl?l.createElement(tt,{plugin:d,panel:t,dashboard:i,isViewing:a,isEditing:o,isInView:e,isDraggable:g,width:r,height:c}):l.createElement(Dt,{plugin:d,panel:t,dashboard:i,isViewing:a,isEditing:o,isInView:e,isDraggable:g,width:r,height:c,onInstanceStateChange:this.onInstanceStateChange,timezone:u,hideMenu:p}):null}}static{this.defaultProps={lazy:!0}}componentDidMount(){this.props.panel.isInView=!this.props.lazy,this.props.lazy||this.onPanelLoad()}render(){const{width:e,height:i,lazy:t}=this.props;return t?l.createElement(v,{width:e,height:i,onChange:this.onVisibilityChange,onLoad:this.onPanelLoad},this.renderPanel):this.renderPanel({isInView:!0})}}const At=Nt(Ot)},60444:(ve,Z,s)=>{s.d(Z,{d:()=>B});var l=s(14236),Q=s(43127),X=s(33948),z=s(39070),Y=s(90708),v=s(2913),q=s(85595),J=s(74856),y=s(19752);function B(x,S){const T=(0,l.Bt)(x.snapshotData),H=new q.F,K={dashboard:S,range:(0,Q.E2)()},b=H.canWork(K)?H.getAnnotationsInSnapshot(S,x.id):[],_=[(0,X.I)(b)];return{timeRange:(0,y.nk)(x,(0,J.jG)().timeRange()).timeRange,state:z.Gu.Done,series:(0,Y.we)({data:T,fieldConfig:{defaults:{},overrides:[]},replaceVariables:x.replaceVariables,fieldConfigRegistry:x.plugin.fieldConfigRegistry,theme:v.config.theme2,timeZone:S.getTimezone()}),structureRev:1,annotations:_}}}}]);

//# sourceMappingURL=9569.55b46609f5376144534a.js.map