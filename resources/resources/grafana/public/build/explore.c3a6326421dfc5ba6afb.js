"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9604],{2864:(Yt,Ae,u)=>{u.d(Ae,{h:()=>V,j:()=>N});var h=u(91890),t=u(44836);function V(X){switch(X){case h.CC.Logfmt:return{label:(0,t.t)("correlations.trans-details.logfmt-label","Logfmt"),value:h.CC.Logfmt,description:(0,t.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case h.CC.Regex:return{label:(0,t.t)("correlations.trans-details.regex-label","Regular expression"),value:h.CC.Regex,description:(0,t.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,t.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,t.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:X,value:X,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const N=()=>Object.values(h.CC).map(X=>{const Ce=V(X);return{label:Ce.label,value:Ce.value,description:Ce.description}})},88322:(Yt,Ae,u)=>{u.r(Ae),u.d(Ae,{default:()=>Li});var h=u(32196),t=u(96540),V=u(32264),N=u(40845),X=u(66602),Ce=u(58720),$e=u(76888),Jt=u(25249),D=u(31678),ro=u(58476),Je=u(2739),io=function(e,o){e===void 0&&(e=!0);var n=(0,t.useCallback)(function(s){var a=typeof e=="function"?e():!0;if(a)return s.preventDefault(),o&&(s.returnValue=o),o},[e,o]);(0,t.useEffect)(function(){if(e)return(0,Je.on)(window,"beforeunload",n),function(){return(0,Je.AU)(window,"beforeunload",n)}},[e,n])};const Xt=io;var lo=u(64305),Et=u(23596),z=u(14110),co=u(66864),ge=u(56034),le=u(14578),U=u(55852),Xe=u(37390);const uo=({onSave:e,onDiscard:o,onCancel:n,message:s})=>t.createElement(Xe.a,{isOpen:!0,title:"Unsaved changes to correlation",onDismiss:n,icon:"exclamation-triangle",className:(0,h.css)({width:"600px"})},t.createElement("h5",null,s),t.createElement(Xe.a.ButtonRow,null,t.createElement(U.$n,{variant:"secondary",onClick:n,fill:"outline"},"Cancel"),t.createElement(U.$n,{variant:"destructive",onClick:o},"Continue without saving"),t.createElement(U.$n,{variant:"primary",onClick:e},"Save correlation")));var te=u(2543),po=(e=>(e.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",e.FULL_QUERY_LOSS="lose the changed query",e.FULL_CORR_LOSS="cause the correlation in progress to be lost",e.INVALID_VAR="remove the variables, and your changed query may no longer be valid",e))(po||{});const ho=(e,o,n,s)=>{const a=(0,te.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let r="",i="";if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE)if(r="Closing the pane",o)if(n)i="cause the correlation in progress to be lost";else if(s)i="cause the query in the right pane to be re-ran and links added to that data";else return;else if(n)i="cause the correlation in progress to be lost";else if(s)i="lose the changed query";else return;else if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE)if(r="Changing the datasource",o)if(n)i="cause the correlation in progress to be lost";else return;else if(s)i="lose the changed query";else return;else if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR)if(r="Closing the editor",n)i="cause the correlation in progress to be lost";else if(s)i="remove the variables, and your changed query may no longer be valid";else return;return a({actionStr:r,consequenceStr:i})};var go=u(324),Ne=u(62860),Ee=u(62256),G=u(29436),q=u(23994),J=u(9955);const mo=({panes:e})=>{const o=(0,D.useDispatch)(),n=(0,N.of)(fo),s=(0,D.useSelector)(J.vC),a=(0,D.useSelector)(J.st),[r,i]=(0,t.useState)(void 0);Xt(s?.correlationDirty||!1,"Save correlation?"),Xt(!s?.correlationDirty&&s?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,t.useEffect)(()=>{if(s?.isExiting){const{correlationDirty:p,queryEditorDirty:y}=s;let m,v;s.postConfirmAction?(m=s.postConfirmAction.isActionLeft,v=s.postConfirmAction.action):(v=D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR,m=!1);const b=ho(v,m,p,y);if(b!==void 0)i(b);else if(v===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&s.postConfirmAction){const{exploreId:E,changeDatasourceUid:C}=s?.postConfirmAction;E&&C&&(o((0,Ne.wh)({exploreId:E,datasource:C,options:{importQueries:!0}})),o((0,G.am)({isExiting:!1})))}else if(v===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE&&s.postConfirmAction){const{exploreId:E}=s?.postConfirmAction;E!==void 0&&(o((0,G.J8)(E)),o((0,G.am)({isExiting:!1})))}else v===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR&&o((0,G.am)({editorMode:!1}))}},[s,o,a]),(0,lo.A)(()=>{o((0,G.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(p=>{o((0,Ee.nE)({exploreId:p[0],correlationEditorHelperData:void 0})),o((0,q.Od)({exploreId:p[0]}))})});const l=()=>{o((0,G.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(p=>{o((0,Ee.nE)({exploreId:p[0],correlationEditorHelperData:void 0})),o((0,q.Od)({exploreId:p[0]}))})},c=p=>{i(void 0),o((0,G.J8)(p)),(0,z.rR)("grafana_explore_split_view_closed")},g=(p,y)=>{i(void 0),o((0,Ne.wh)({exploreId:p,datasource:y,options:{importQueries:!0}}))},d=p=>{if(o((0,go.v)(s?.label,s?.description,s?.transformations)),!p&&s?.postConfirmAction!==void 0){const{exploreId:y,action:m,changeDatasourceUid:v}=s?.postConfirmAction;m===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?(c(y),l()):m===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&v!==void 0&&((0,Ne.wh)({exploreId:y,datasource:v}),l())}else o((0,G.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return t.createElement(t.Fragment,null,t.createElement(ro.XG,{message:p=>p.pathname!=="/explore"&&s?.editorMode&&s?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),r!==void 0&&t.createElement(uo,{onDiscard:()=>{if(s?.postConfirmAction!==void 0){const{exploreId:p,action:y,changeDatasourceUid:m}=s?.postConfirmAction;y===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?c(p):y===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&m!==void 0&&g(p,m),o((0,G.am)({isExiting:!1}))}else o((0,G.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{o((0,G.am)({isExiting:!1})),i(void 0)},onSave:()=>{d(!1)},message:r}),t.createElement("div",{className:n.correlationEditorTop},t.createElement(co.Gy,{spacing:"md",justify:"flex-end"},t.createElement(ge.m,{content:"Correlations editor in Explore is an experimental feature."},t.createElement(le.I,{className:n.iconColor,name:"info-circle",size:"xl"})),t.createElement(U.$n,{variant:"secondary",disabled:!s?.canSave,fill:"outline",className:s?.canSave?n.buttonColor:n.disabledButtonColor,onClick:()=>{d(!0)}},"Save"),t.createElement(U.$n,{variant:"secondary",fill:"outline",className:n.buttonColor,icon:"times",onClick:()=>{o((0,G.am)({isExiting:!0})),(0,z.rR)("grafana_explore_correlation_editor_exit_pressed")}},"Exit correlation editor"))))},fo=e=>{const o=e.colors.getContrastText(e.colors.primary.main),n=Et.lighten(e.colors.primary.main,.1),s=Et.darken(e.colors.primary.main,.2),a=Et.darken(o,.2);return{correlationEditorTop:(0,h.css)({backgroundColor:e.colors.primary.main,marginTop:"3px",padding:e.spacing(1)}),iconColor:(0,h.css)({color:o}),buttonColor:(0,h.css)({color:o,borderColor:o,"&:hover":{color:o,borderColor:o,backgroundColor:n}}),disabledButtonColor:(0,h.css)({color:`${a} !important`,backgroundColor:`${s} !important`})}};var xt=u(1503),_e=u(16233),et=u(14678);const yo=()=>{const[e,o]=(0,t.useState)([]),{query:n}=(0,xt.useKBar)(),s=(0,D.useDispatch)(),a=(0,D.useSelector)(J.Qb),r=(0,D.useSelector)(J.pF),i=_e.TP.hasPermission(D.AccessControlAction.DataSourcesWrite);return(0,t.useEffect)(()=>{const l=Object.keys(a),c={name:"Explore",priority:xt.Priority.HIGH+1},g=[];if(r)g.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{s((0,q.Od)({exploreId:l[0]}))},section:c}),a[1],g.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{s((0,q.Od)({exploreId:l[1]}))},section:c}),g.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{s((0,G.J8)(l[0]))},section:c}),g.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{s((0,G.J8)(l[1]))},section:c});else{const d=Object.values(a).some(p=>p?.datasourceInstance?.uid===et.uv);V.$.featureToggles.correlations&&i&&!d&&g.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{s((0,G.am)({editorMode:!0})),s((0,q.Od)({exploreId:l[0]}))},section:c}),g.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{s((0,q.Od)({exploreId:l[0]}))},section:c}),g.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{s((0,G.ve)())},section:c})}o(g)},[a,r,n,s,i]),(0,xt.useRegisterActions)(n?e:[],[e,n]),null};var me=u(63329),vo=u(18226),tt=u(13544),nt=u(40276),Be=u(87490),ze=u(41811),bo=u(70713),Y=u(9557),ce=u(39070),He=u(19347),St=u(52494),ot=u(88407),We=u(11401),Eo=u(48543),st=u(32901),_t=u(42941),xo=u(23535),So=function(e){var o=(0,xo.A)({x:0,y:0}),n=o[0],s=o[1];return(0,t.useEffect)(function(){var a=function(){e.current&&s({x:e.current.scrollLeft,y:e.current.scrollTop})};return e.current&&(0,Je.on)(e.current,"scroll",a,{capture:!1,passive:!0}),function(){e.current&&(0,Je.AU)(e.current,"scroll",a)}},[e]),n};const Co=So,en=(0,t.createContext)(void 0);function Ro({children:e,refreshDependencies:o}){const[n,s]=(0,t.useState)([]),a=(0,t.useRef)({}),r=(0,t.useCallback)(c=>{const g=(0,te.uniqueId)(`${c.panelId}-${c.title}-${c.icon}_`);return s(d=>{if(c.level==="root"){const p=tn(a,c);return[...d,{...c,id:g,children:a.current[c.panelId]||[],mergeSingleChild:p}].sort(Ct)}if(c.level==="child"){const p=d.findIndex(E=>E.panelId===c.panelId&&E.level==="root");if(p===-1)return Object.keys(a.current).find(C=>C===c.panelId)?a.current[c.panelId].push({...c,id:g}):a.current[c.panelId]=[{...c,id:g}],[...d];const y=[...d],m={...y[p]},v=[...m.children||[],{...c,id:g}];v.sort(Ct);const b=tn(a,m);return y[p]={...m,children:v,mergeSingleChild:b},y}return[...d]}),g},[]),i=(0,t.useCallback)(c=>{s(g=>g.filter(d=>d.id!==c).map(d=>(d.children&&(d.children=d.children.filter(p=>p.id!==c)),d)))},[]),l=(0,t.useCallback)(c=>{s(c)},[]);return(0,t.useEffect)(()=>{s(c=>{const g=[...c];for(const d of g)d.children?.sort(Ct);return g})},[o]),t.createElement(en.Provider,{value:{outlineItems:n,register:r,unregister:i,updateOutlineItems:l}},e)}function Ct(e,o){if(e.ref&&o.ref){const n=e.ref.compareDocumentPosition(o.ref);if(n===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(n===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function tn(e,o){return(e.current[o.panelId]||[]).length===1&&o.mergeSingleChild}function nn(){return(0,t.useContext)(en)}var wo=u(8887);function Rt({contentOutlineExpanded:e,title:o,icon:n,tooltip:s,tooltipPlacement:a="bottom",className:r,indentStyle:i,collapsible:l,collapsed:c,isActive:g,sectionId:d,toggleCollapsed:p,...y}){const m=(0,N.of)(To),v=(0,h.cx)(m.button,r),b=(0,t.useRef)(null),[E,C]=(0,t.useState)(!1);(0,t.useEffect)(()=>{b.current&&C(b.current?.scrollWidth>b.current?.clientWidth)},[o]);const f=t.createElement("div",{className:(0,h.cx)(m.buttonContainer,i)},l&&t.createElement("button",{className:m.collapseButton,onClick:p,"aria-label":"Content outline item collapse button","aria-expanded":!c,"aria-controls":d},t.createElement(on,{icon:c?"angle-right":"angle-down"})),t.createElement("button",{className:(0,h.cx)(v,{[m.active]:g}),"aria-label":s,...y},t.createElement(on,{icon:n}),o&&t.createElement("span",{className:m.textContainer,ref:b},o)));return s&&(!e||E)?t.createElement(ge.m,{content:s,placement:a},f):f}function on({icon:e}){return e?(0,wo.n6)(e)?t.createElement(le.I,{name:e,size:"lg",title:e}):e:null}const To=e=>({buttonContainer:(0,h.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:e.spacing(1),overflow:"hidden",width:"100%"}),button:(0,h.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:e.spacing(e.components.height.md),padding:e.spacing(0,1),gap:e.spacing(1),color:e.colors.text.secondary,width:"100%",background:"transparent",border:"none"}),collapseButton:(0,h.css)({display:"flex",alignItems:"center",justifyContent:"center",width:e.spacing(3),height:e.spacing(4),borderRadius:e.shape.radius.default,color:e.colors.text.secondary,background:"transparent",border:"none","&:hover":{color:e.colors.text.primary,background:e.colors.secondary.shade}}),textContainer:(0,h.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),active:(0,h.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative","&::before":{backgroundImage:e.colors.gradients.brandVertical,borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}})});function Lo({scroller:e,panelId:o}){const[n,s]=(0,_t.A)(!1),a=(0,N.of)(Io,n),r=(0,t.useRef)(e||null),{y:i}=Co(r),{outlineItems:l}=nn()??{outlineItems:[]},[c,g]=(0,t.useState)(l[0]?.id),[d,p]=(0,t.useState)(l[0]?.children?.[0]?.id),y=l.some(f=>f.children&&!(f.mergeSingleChild&&f.children?.length===1)&&f.children.length>0),[m,v]=(0,t.useState)(()=>l.reduce((f,x)=>(f[x.id]=!1,f),{})),b=(f,x,R=0)=>{let I=0,L=f;do I+=L?.offsetTop||0,L=L?.offsetParent;while(L&&L!==e);e?.scroll({top:I+R,behavior:"smooth"}),(0,z.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:x})},E=()=>{s(),(0,z.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n?"minimize":"expand"})},C=f=>{v(x=>({...x,[f]:!x[f]})),(0,z.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:m[f]?"expand":"minimize"})};return(0,t.useEffect)(()=>{let f;for(const x of l){let R=x?.ref?.getBoundingClientRect().top;R&&R>=0&&(f=x);const I=x.children?.find(L=>{const P=L.customTopOffset||0;let O=L?.ref?.getBoundingClientRect().top;return O&&O>=P});if(I){p(I.id),g(x.id);break}if(f){g(f.id),p(void 0);break}}},[l,i]),t.createElement(St._,{className:a.wrapper,id:o},t.createElement(nt.E,null,t.createElement("div",{className:a.content},t.createElement(Rt,{icon:"arrow-from-right",tooltip:n?"Collapse outline":"Expand outline",tooltipPlacement:n?"right":"bottom",onClick:E,className:(0,h.cx)(a.toggleContentOutlineButton,{[a.justifyCenter]:!n&&!y}),"aria-expanded":n}),l.map(f=>t.createElement(t.Fragment,{key:f.id},t.createElement(Rt,{key:f.id,title:n?f.title:void 0,contentOutlineExpanded:n,className:(0,h.cx)(a.buttonStyles,{[a.justifyCenter]:!n,[a.sectionHighlighter]:at(f,d)&&!n}),indentStyle:(0,h.cx)({[a.indentRoot]:y&&f.children?.length===0,[a.sectionHighlighter]:at(f,d)&&!n&&m[f.id]}),icon:f.icon,onClick:()=>b(f.ref,f.panelId),tooltip:f.title,collapsible:Fo(f),collapsed:!m[f.id],toggleCollapsed:()=>C(f.id),isActive:at(f,d)&&!m[f.id]||c===f.id&&!m[f.id],sectionId:f.id}),t.createElement("div",{id:f.id,"data-testid":`section-wrapper-${f.id}`},f.children&&(!f.mergeSingleChild||f.children.length!==1)&&m[f.id]&&f.children.map((x,R)=>t.createElement("div",{key:x.id,className:a.itemWrapper},n&&t.createElement("div",{className:(0,h.cx)(a.itemConnector,{[a.firstItemConnector]:R===0,[a.lastItemConnector]:R===(f.children?.length||0)-1})}),t.createElement(Rt,{key:x.id,title:n?x.title:void 0,contentOutlineExpanded:n,icon:n?void 0:f.icon,className:(0,h.cx)(a.buttonStyles,{[a.justifyCenter]:!n,[a.sectionHighlighter]:at(f,d)&&!n}),indentStyle:a.indentChild,onClick:()=>b(x.ref,x.panelId,x.customTopOffset),tooltip:x.title,isActive:d===x.id})))))))))}const Io=(e,o)=>({wrapper:(0,h.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:e.spacing(1),height:"100%",backgroundColor:e.colors.background.primary,width:o?"160px":void 0,minWidth:o?"160px":void 0}),content:(0,h.css)({label:"content",marginLeft:e.spacing(.5),top:0}),buttonStyles:(0,h.css)({display:"flex","&:hover":{color:e.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,h.css)({"&:hover":{color:e.colors.text.primary},transform:o?"rotate(180deg)":"",marginRight:o?e.spacing(.5):void 0}),indentRoot:(0,h.css)({paddingLeft:e.spacing(4)}),indentChild:(0,h.css)({paddingLeft:o?e.spacing(7):e.spacing(4)}),itemWrapper:(0,h.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),itemConnector:(0,h.css)({position:"relative",height:"100%",width:e.spacing(1.5),"&::before":{borderRight:`1px solid ${e.colors.border.medium}`,content:'""',height:"100%",left:48,position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,h.css)({"&::before":{top:e.spacing(1),height:`calc(100% - ${e.spacing(1)})`}}),lastItemConnector:(0,h.css)({"&::before":{height:`calc(100% - ${e.spacing(1)})`}}),justifyCenter:(0,h.css)({justifyContent:"center"}),sectionHighlighter:(0,h.css)({backgroundColor:e.colors.background.secondary})});function Fo(e){return!!(e.children&&e.children.length>0&&(!e.mergeSingleChild||e.children.length!==1))}function at(e,o){return e.children?.some(n=>n.id===o)}function he({panelId:e,title:o,icon:n,customTopOffset:s,children:a,className:r,level:i="root",mergeSingleChild:l}){const{register:c,unregister:g}=nn()??{},d=(0,t.useRef)(null);return(0,t.useEffect)(()=>{if(!c||!g)return;const p=c({panelId:e,title:o,icon:n,ref:d.current,customTopOffset:s,level:i,mergeSingleChild:l});return()=>g(p)},[e,o,n,s,i,l,c,g]),t.createElement("div",{className:r,ref:d},a)}var rt=u(49785),sn=u(16817),Ve=u(42418),it=u(82762),Qe=u(67061),xe=u(88575),je=u(10354),lt=u(10860),Me=u(29158),Oo=u(91605),wt=u(67023),Do=u(18380),Ao=u(23257),No=u.n(Ao),zo=u(60029),Re=u(88323),Tt=u(2864);const an=({label:e,tooltipText:o})=>t.createElement(Qe.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start"},t.createElement(zo.J,null,e),t.createElement(ge.m,{content:o},t.createElement(le.I,{name:"info-circle",size:"sm"}))),Ho=({onSave:e,onCancel:o,fieldList:n,transformationToEdit:s})=>{const[a,r]=(0,t.useState)(void 0),[i,l]=(0,t.useState)({}),[c,g]=(0,t.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[d,p]=(0,t.useState)(!1),[y,m]=(0,t.useState)(!1),{getValues:v,control:b,register:E,watch:C}=(0,rt.mN)({defaultValues:(0,t.useMemo)(()=>{if(s){const x=n[s?.field];r(x),s?.expression&&p(!0);const R=(0,Tt.h)(s?.type);g({mapValueDetails:R.mapValueDetails,expressionDetails:R.expressionDetails});const I=(0,wt.k)({type:s?.type,expression:s?.expression,mapValue:s?.mapValue},x||"",s?.field);return l({...I}),m(!0),{type:s?.type,field:s?.field,mapValue:s?.mapValue,expression:s?.expression}}else return},[n,s])}),f=(0,t.useId)();return(0,t.useEffect)(()=>{const x=C(R=>{const I=R.expression;let L=!1;if(I!==void 0){L=!0;try{new RegExp(I)}catch{L=!1}}else L=!c.expressionDetails.show;p(L);let P=[];if(R.type){const O=(0,wt.k)({type:R.type,expression:L?I:"",mapValue:R.mapValue},n[R.field]||"",R.field);P=Object.keys(O),l(P.length>0?{...O}:{})}P.length===0||!L?m(!1):m(!0)});return()=>x.unsubscribe()},[n,c.expressionDetails.show,C]),t.createElement(Xe.a,{isOpen:!0,title:`${s?"Edit":"Add"} transformation`,onDismiss:o,className:(0,h.css)({width:"700px"})},t.createElement("p",null,"A transformation extracts variables out of a single field. These variables will be available along with your field variables."),t.createElement(xe.D,{label:"Field"},t.createElement(rt.xI,{control:b,render:({field:{onChange:x,ref:R,...I}})=>t.createElement(Re.l6,{...I,onChange:L=>{L.value&&(x(L.value),r(n[L.value]))},options:Object.entries(n).map(L=>({label:L[0],value:L[0]})),"aria-label":"field"}),name:"field"})),a&&t.createElement(t.Fragment,null,t.createElement("pre",null,t.createElement(No(),{textToHighlight:a,searchWords:[d?v("expression")??"":""],autoEscape:!1})),t.createElement(xe.D,{label:"Type"},t.createElement(rt.xI,{control:b,render:({field:{onChange:x,ref:R,...I}})=>t.createElement(Re.l6,{...I,onChange:L=>{x(L.value);const P=(0,Tt.h)(L.value);g({mapValueDetails:P.mapValueDetails,expressionDetails:P.expressionDetails})},options:(0,Tt.j)(),"aria-label":"type"}),name:"type"})),c.expressionDetails.show&&t.createElement(xe.D,{label:c.expressionDetails.helpText?t.createElement(an,{label:"Expression",tooltipText:c.expressionDetails.helpText}):"Expression",htmlFor:`${f}-expression`,required:c.expressionDetails.required},t.createElement(je.p,{...E("expression"),id:`${f}-expression`})),c.mapValueDetails.show&&t.createElement(xe.D,{label:c.mapValueDetails.helpText?t.createElement(an,{label:"Variable Name",tooltipText:c.mapValueDetails.helpText}):"Variable Name",htmlFor:`${f}-mapValue`},t.createElement(je.p,{...E("mapValue"),id:`${f}-mapValue`})),Object.entries(i).length>0&&t.createElement(t.Fragment,null,"This transformation will add the following variables:",t.createElement("pre",null,Object.entries(i).map(x=>`\${${x[0]}} = ${x[1]?.value}
`)))),t.createElement(Xe.a.ButtonRow,null,t.createElement(U.$n,{variant:"secondary",onClick:o,fill:"outline"},"Cancel"),t.createElement(U.$n,{variant:"primary",onClick:()=>e(v()),disabled:!y},s?"Edit transformation":"Add transformation to correlation")))},Mo=({exploreId:e,correlations:o})=>{const n=(0,D.useDispatch)(),s=(0,N.of)(Po),a=(0,D.useSelector)(J.Qb),r=Object.values(a),{value:i,loading:l}=(0,sn.A)(async()=>await(0,Do.tZ)(r[0],r[1]),[r[0]?.datasourceInstance,r[0]?.queries[0].datasource,r[1]?.datasourceInstance,r[1]?.queries[0].datasource]),{register:c,watch:g,getValues:d,setValue:p}=(0,rt.mN)(),[y,m]=(0,t.useState)(!1),[v,b]=(0,t.useState)(!1),[E,C]=(0,t.useState)(!1),[f,x]=(0,t.useState)([]),[R,I]=(0,t.useState)(void 0),L=(0,D.useSelector)(J.vC),P=(0,t.useId)();return(0,t.useEffect)(()=>(n((0,G.am)({canSave:!0})),()=>{n((0,G.am)({canSave:!1}))}),[n]),(0,t.useEffect)(()=>{!l&&i!==void 0&&!L?.correlationDirty&&d("label")!==""&&p("label",i)},[L?.correlationDirty,i,d,l,p]),(0,t.useEffect)(()=>{const O=g(k=>{let $=L?.correlationDirty||!1,w=k.description||"";!$&&(k.label!==i||w!=="")?$=!0:$&&k.label===i&&w.trim()===""&&($=!1),n((0,G.am)({label:k.label,description:k.description,correlationDirty:$}))});return()=>O.unsubscribe()},[L?.correlationDirty,i,n,g]),(0,t.useEffect)(()=>{const O=!L?.correlationDirty&&f.length>0?!0:L?.correlationDirty;n((0,G.am)({transformations:f,correlationDirty:O}));let k={};f.forEach($=>{const w=(0,wt.k)({type:$.type,expression:$.expression,mapValue:$.mapValue},o.vars[$.field],$.field);Object.keys(w).forEach(H=>{k[H]=w[H]?.value})}),n((0,Ee.nE)({exploreId:e,correlationEditorHelperData:{resultField:o.resultField,origVars:o.origVars,vars:{...o.origVars,...k}}}))},[n,f]),t.createElement(t.Fragment,null,E&&t.createElement(Ho,{onCancel:()=>{I(void 0),C(!1)},onSave:O=>{if(R!==void 0){const k=[...f];k[R]=O,x(k),I(void 0)}else x([...f,O]);C(!1)},fieldList:o.origVars,transformationToEdit:R!==void 0?f[R]:void 0}),t.createElement(Ve.F,{title:"Correlation details",severity:"info"},"The correlation link will appear by the ",t.createElement("code",null,o.resultField)," field. You can use the following variables to set up your correlations:",t.createElement("pre",null,Object.entries(o.vars).map(O=>`\${${O[0]}} = ${O[1]}
`)),t.createElement(it.S,{collapsible:!0,isOpen:y,onToggle:()=>{m(!y)},label:t.createElement(Qe.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center"},"Label / Description",!y&&!l&&t.createElement("span",{className:s.labelCollapseDetails},`Label: ${d("label")||i}`))},t.createElement(xe.D,{label:"Label",htmlFor:`${P}-label`},t.createElement(je.p,{...c("label"),id:`${P}-label`,onBlur:()=>{d("label")===""&&i!==void 0&&p("label",i)}})),t.createElement(xe.D,{label:"Description",htmlFor:`${P}-description`},t.createElement(je.p,{...c("description"),id:`${P}-description`}))),t.createElement(it.S,{collapsible:!0,isOpen:v,onToggle:()=>{b(!v)},label:t.createElement(Qe.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center"},"Transformations",t.createElement(ge.m,{content:"A transformation extracts one or more variables out of a single field."},t.createElement(le.I,{name:"info-circle",size:"sm"})))},t.createElement(U.$n,{variant:"secondary",fill:"outline",onClick:()=>{C(!0)},className:s.transformationAction},"Add transformation"),f.map((O,k)=>{const{type:$,field:w,expression:H,mapValue:Z}=O,B=[(Z??"").length>0?`Variable name: ${Z}`:void 0,(H??"").length>0?t.createElement(t.Fragment,null,"Expression: ",t.createElement("code",null,H)):void 0].filter(re=>re);return t.createElement(lt.Z,{key:`trans-${k}`},t.createElement(lt.Z.Heading,null,w,": ",$),B.length>0&&t.createElement(lt.Z.Meta,{className:s.transformationMeta},B),t.createElement(lt.Z.SecondaryActions,null,t.createElement(Me.K,{key:"edit",name:"edit","aria-label":"edit transformation",onClick:()=>{I(k),C(!0)}}),t.createElement(Oo.e,{"aria-label":"delete transformation",onConfirm:()=>x(f.filter((re,T)=>k!==T)),closeOnConfirm:!0})))}))))},Po=e=>({labelCollapseDetails:(0,h.css)({marginLeft:e.spacing(2),...e.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,h.css)({marginBottom:e.spacing(2)}),transformationMeta:(0,h.css)({alignItems:"baseline"})});var we=u(47232),ko=u(24308),$o=u(79041),Se=u(91052),Bo=u(15162),Wo=u(33368);function Vo({width:e,height:o,timeZone:n,state:s,pluginId:a,frames:r,absoluteRange:i,splitOpenFn:l,eventBus:c}){const g=(0,t.useMemo)(()=>({from:(0,we.KQ)(i.from),to:(0,we.KQ)(i.to),raw:{from:(0,we.KQ)(i.from),to:(0,we.KQ)(i.to)}}),[i.from,i.to]),d=(0,Bo.d4)(a),y={dataLinkPostProcessor:(0,Wo.h)(l,g),eventBus:c,eventsScope:"explore"};return t.createElement($o.XF,{value:y},t.createElement(Se.NR,{title:d.name,width:e,height:o,loadingState:s},(m,v)=>t.createElement(ko.m,{data:{series:r,state:s,timeRange:g},pluginId:a,title:"",width:m,height:v,timeZone:n})))}var Ue=u(41987),K=u(52622),rn=u(60734),Qo=u(40961),jo=function(){var e=function(o,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,a){s.__proto__=a}||function(s,a){for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(s[r]=a[r])},e(o,n)};return function(o,n){e(o,n);function s(){this.constructor=o}o.prototype=n===null?Object.create(n):(s.prototype=n.prototype,new s)}}(),_=function(){return _=Object.assign||function(e){for(var o,n=1,s=arguments.length;n<s;n++){o=arguments[n];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},_.apply(this,arguments)},ln={width:"100%",height:"10px",top:"0px",left:"0px",cursor:"row-resize"},cn={width:"10px",height:"100%",top:"0px",left:"0px",cursor:"col-resize"},ct={width:"20px",height:"20px",position:"absolute"},Uo={top:_(_({},ln),{top:"-5px"}),right:_(_({},cn),{left:void 0,right:"-5px"}),bottom:_(_({},ln),{top:void 0,bottom:"-5px"}),left:_(_({},cn),{left:"-5px"}),topRight:_(_({},ct),{right:"-10px",top:"-10px",cursor:"ne-resize"}),bottomRight:_(_({},ct),{right:"-10px",bottom:"-10px",cursor:"se-resize"}),bottomLeft:_(_({},ct),{left:"-10px",bottom:"-10px",cursor:"sw-resize"}),topLeft:_(_({},ct),{left:"-10px",top:"-10px",cursor:"nw-resize"})},Go=function(e){jo(o,e);function o(){var n=e!==null&&e.apply(this,arguments)||this;return n.onMouseDown=function(s){n.props.onResizeStart(s,n.props.direction)},n.onTouchStart=function(s){n.props.onResizeStart(s,n.props.direction)},n}return o.prototype.render=function(){return t.createElement("div",{className:this.props.className||"",style:_(_({position:"absolute",userSelect:"none"},Uo[this.props.direction]),this.props.replaceStyles||{}),onMouseDown:this.onMouseDown,onTouchStart:this.onTouchStart},this.props.children)},o}(t.PureComponent),qo=function(){var e=function(o,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,a){s.__proto__=a}||function(s,a){for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(s[r]=a[r])},e(o,n)};return function(o,n){e(o,n);function s(){this.constructor=o}o.prototype=n===null?Object.create(n):(s.prototype=n.prototype,new s)}}(),fe=function(){return fe=Object.assign||function(e){for(var o,n=1,s=arguments.length;n<s;n++){o=arguments[n];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},fe.apply(this,arguments)},Ko={width:"auto",height:"auto"},dt=function(e,o,n){return Math.max(Math.min(e,n),o)},dn=function(e,o){return Math.round(e/o)*o},Pe=function(e,o){return new RegExp(e,"i").test(o)},ut=function(e){return!!(e.touches&&e.touches.length)},Zo=function(e){return!!((e.clientX||e.clientX===0)&&(e.clientY||e.clientY===0))},un=function(e,o,n){n===void 0&&(n=0);var s=o.reduce(function(r,i,l){return Math.abs(i-e)<Math.abs(o[r]-e)?l:r},0),a=Math.abs(o[s]-e);return n===0||a<n?o[s]:e},Lt=function(e){return e=e.toString(),e==="auto"||e.endsWith("px")||e.endsWith("%")||e.endsWith("vh")||e.endsWith("vw")||e.endsWith("vmax")||e.endsWith("vmin")?e:e+"px"},pt=function(e,o,n,s){if(e&&typeof e=="string"){if(e.endsWith("px"))return Number(e.replace("px",""));if(e.endsWith("%")){var a=Number(e.replace("%",""))/100;return o*a}if(e.endsWith("vw")){var a=Number(e.replace("vw",""))/100;return n*a}if(e.endsWith("vh")){var a=Number(e.replace("vh",""))/100;return s*a}}return e},Yo=function(e,o,n,s,a,r,i){return s=pt(s,e.width,o,n),a=pt(a,e.height,o,n),r=pt(r,e.width,o,n),i=pt(i,e.height,o,n),{maxWidth:typeof s>"u"?void 0:Number(s),maxHeight:typeof a>"u"?void 0:Number(a),minWidth:typeof r>"u"?void 0:Number(r),minHeight:typeof i>"u"?void 0:Number(i)}},Jo=["as","style","className","grid","snap","bounds","boundsByDirection","size","defaultSize","minWidth","minHeight","maxWidth","maxHeight","lockAspectRatio","lockAspectRatioExtraWidth","lockAspectRatioExtraHeight","enable","handleStyles","handleClasses","handleWrapperStyle","handleWrapperClass","children","onResizeStart","onResize","onResizeStop","handleComponent","scale","resizeRatio","snapGap"],pn="__resizable_base__",hn=function(e){qo(o,e);function o(n){var s=e.call(this,n)||this;return s.ratio=1,s.resizable=null,s.parentLeft=0,s.parentTop=0,s.resizableLeft=0,s.resizableRight=0,s.resizableTop=0,s.resizableBottom=0,s.targetLeft=0,s.targetTop=0,s.appendBase=function(){if(!s.resizable||!s.window)return null;var a=s.parentNode;if(!a)return null;var r=s.window.document.createElement("div");return r.style.width="100%",r.style.height="100%",r.style.position="absolute",r.style.transform="scale(0, 0)",r.style.left="0",r.style.flex="0 0 100%",r.classList?r.classList.add(pn):r.className+=pn,a.appendChild(r),r},s.removeBase=function(a){var r=s.parentNode;r&&r.removeChild(a)},s.ref=function(a){a&&(s.resizable=a)},s.state={isResizing:!1,width:typeof(s.propsSize&&s.propsSize.width)>"u"?"auto":s.propsSize&&s.propsSize.width,height:typeof(s.propsSize&&s.propsSize.height)>"u"?"auto":s.propsSize&&s.propsSize.height,direction:"right",original:{x:0,y:0,width:0,height:0},backgroundStyle:{height:"100%",width:"100%",backgroundColor:"rgba(0,0,0,0)",cursor:"auto",opacity:0,position:"fixed",zIndex:9999,top:"0",left:"0",bottom:"0",right:"0"},flexBasis:void 0},s.onResizeStart=s.onResizeStart.bind(s),s.onMouseMove=s.onMouseMove.bind(s),s.onMouseUp=s.onMouseUp.bind(s),s}return Object.defineProperty(o.prototype,"parentNode",{get:function(){return this.resizable?this.resizable.parentNode:null},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"window",{get:function(){return!this.resizable||!this.resizable.ownerDocument?null:this.resizable.ownerDocument.defaultView},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"propsSize",{get:function(){return this.props.size||this.props.defaultSize||Ko},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"size",{get:function(){var n=0,s=0;if(this.resizable&&this.window){var a=this.resizable.offsetWidth,r=this.resizable.offsetHeight,i=this.resizable.style.position;i!=="relative"&&(this.resizable.style.position="relative"),n=this.resizable.style.width!=="auto"?this.resizable.offsetWidth:a,s=this.resizable.style.height!=="auto"?this.resizable.offsetHeight:r,this.resizable.style.position=i}return{width:n,height:s}},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"sizeStyle",{get:function(){var n=this,s=this.props.size,a=function(l){if(typeof n.state[l]>"u"||n.state[l]==="auto")return"auto";if(n.propsSize&&n.propsSize[l]&&n.propsSize[l].toString().endsWith("%")){if(n.state[l].toString().endsWith("%"))return n.state[l].toString();var c=n.getParentSize(),g=Number(n.state[l].toString().replace("px","")),d=g/c[l]*100;return d+"%"}return Lt(n.state[l])},r=s&&typeof s.width<"u"&&!this.state.isResizing?Lt(s.width):a("width"),i=s&&typeof s.height<"u"&&!this.state.isResizing?Lt(s.height):a("height");return{width:r,height:i}},enumerable:!1,configurable:!0}),o.prototype.getParentSize=function(){if(!this.parentNode)return this.window?{width:this.window.innerWidth,height:this.window.innerHeight}:{width:0,height:0};var n=this.appendBase();if(!n)return{width:0,height:0};var s=!1,a=this.parentNode.style.flexWrap;a!=="wrap"&&(s=!0,this.parentNode.style.flexWrap="wrap"),n.style.position="relative",n.style.minWidth="100%",n.style.minHeight="100%";var r={width:n.offsetWidth,height:n.offsetHeight};return s&&(this.parentNode.style.flexWrap=a),this.removeBase(n),r},o.prototype.bindEvents=function(){this.window&&(this.window.addEventListener("mouseup",this.onMouseUp),this.window.addEventListener("mousemove",this.onMouseMove),this.window.addEventListener("mouseleave",this.onMouseUp),this.window.addEventListener("touchmove",this.onMouseMove,{capture:!0,passive:!1}),this.window.addEventListener("touchend",this.onMouseUp))},o.prototype.unbindEvents=function(){this.window&&(this.window.removeEventListener("mouseup",this.onMouseUp),this.window.removeEventListener("mousemove",this.onMouseMove),this.window.removeEventListener("mouseleave",this.onMouseUp),this.window.removeEventListener("touchmove",this.onMouseMove,!0),this.window.removeEventListener("touchend",this.onMouseUp))},o.prototype.componentDidMount=function(){if(!(!this.resizable||!this.window)){var n=this.window.getComputedStyle(this.resizable);this.setState({width:this.state.width||this.size.width,height:this.state.height||this.size.height,flexBasis:n.flexBasis!=="auto"?n.flexBasis:void 0})}},o.prototype.componentWillUnmount=function(){this.window&&this.unbindEvents()},o.prototype.createSizeForCssProperty=function(n,s){var a=this.propsSize&&this.propsSize[s];return this.state[s]==="auto"&&this.state.original[s]===n&&(typeof a>"u"||a==="auto")?"auto":n},o.prototype.calculateNewMaxFromBoundary=function(n,s){var a=this.props.boundsByDirection,r=this.state.direction,i=a&&Pe("left",r),l=a&&Pe("top",r),c,g;if(this.props.bounds==="parent"){var d=this.parentNode;d&&(c=i?this.resizableRight-this.parentLeft:d.offsetWidth+(this.parentLeft-this.resizableLeft),g=l?this.resizableBottom-this.parentTop:d.offsetHeight+(this.parentTop-this.resizableTop))}else this.props.bounds==="window"?this.window&&(c=i?this.resizableRight:this.window.innerWidth-this.resizableLeft,g=l?this.resizableBottom:this.window.innerHeight-this.resizableTop):this.props.bounds&&(c=i?this.resizableRight-this.targetLeft:this.props.bounds.offsetWidth+(this.targetLeft-this.resizableLeft),g=l?this.resizableBottom-this.targetTop:this.props.bounds.offsetHeight+(this.targetTop-this.resizableTop));return c&&Number.isFinite(c)&&(n=n&&n<c?n:c),g&&Number.isFinite(g)&&(s=s&&s<g?s:g),{maxWidth:n,maxHeight:s}},o.prototype.calculateNewSizeFromDirection=function(n,s){var a=this.props.scale||1,r=this.props.resizeRatio||1,i=this.state,l=i.direction,c=i.original,g=this.props,d=g.lockAspectRatio,p=g.lockAspectRatioExtraHeight,y=g.lockAspectRatioExtraWidth,m=c.width,v=c.height,b=p||0,E=y||0;return Pe("right",l)&&(m=c.width+(n-c.x)*r/a,d&&(v=(m-E)/this.ratio+b)),Pe("left",l)&&(m=c.width-(n-c.x)*r/a,d&&(v=(m-E)/this.ratio+b)),Pe("bottom",l)&&(v=c.height+(s-c.y)*r/a,d&&(m=(v-b)*this.ratio+E)),Pe("top",l)&&(v=c.height-(s-c.y)*r/a,d&&(m=(v-b)*this.ratio+E)),{newWidth:m,newHeight:v}},o.prototype.calculateNewSizeFromAspectRatio=function(n,s,a,r){var i=this.props,l=i.lockAspectRatio,c=i.lockAspectRatioExtraHeight,g=i.lockAspectRatioExtraWidth,d=typeof r.width>"u"?10:r.width,p=typeof a.width>"u"||a.width<0?n:a.width,y=typeof r.height>"u"?10:r.height,m=typeof a.height>"u"||a.height<0?s:a.height,v=c||0,b=g||0;if(l){var E=(y-v)*this.ratio+b,C=(m-v)*this.ratio+b,f=(d-b)/this.ratio+v,x=(p-b)/this.ratio+v,R=Math.max(d,E),I=Math.min(p,C),L=Math.max(y,f),P=Math.min(m,x);n=dt(n,R,I),s=dt(s,L,P)}else n=dt(n,d,p),s=dt(s,y,m);return{newWidth:n,newHeight:s}},o.prototype.setBoundingClientRect=function(){if(this.props.bounds==="parent"){var n=this.parentNode;if(n){var s=n.getBoundingClientRect();this.parentLeft=s.left,this.parentTop=s.top}}if(this.props.bounds&&typeof this.props.bounds!="string"){var a=this.props.bounds.getBoundingClientRect();this.targetLeft=a.left,this.targetTop=a.top}if(this.resizable){var r=this.resizable.getBoundingClientRect(),i=r.left,l=r.top,c=r.right,g=r.bottom;this.resizableLeft=i,this.resizableRight=c,this.resizableTop=l,this.resizableBottom=g}},o.prototype.onResizeStart=function(n,s){if(!(!this.resizable||!this.window)){var a=0,r=0;if(n.nativeEvent&&Zo(n.nativeEvent)?(a=n.nativeEvent.clientX,r=n.nativeEvent.clientY):n.nativeEvent&&ut(n.nativeEvent)&&(a=n.nativeEvent.touches[0].clientX,r=n.nativeEvent.touches[0].clientY),this.props.onResizeStart&&this.resizable){var i=this.props.onResizeStart(n,s,this.resizable);if(i===!1)return}this.props.size&&(typeof this.props.size.height<"u"&&this.props.size.height!==this.state.height&&this.setState({height:this.props.size.height}),typeof this.props.size.width<"u"&&this.props.size.width!==this.state.width&&this.setState({width:this.props.size.width})),this.ratio=typeof this.props.lockAspectRatio=="number"?this.props.lockAspectRatio:this.size.width/this.size.height;var l,c=this.window.getComputedStyle(this.resizable);if(c.flexBasis!=="auto"){var g=this.parentNode;if(g){var d=this.window.getComputedStyle(g).flexDirection;this.flexDir=d.startsWith("row")?"row":"column",l=c.flexBasis}}this.setBoundingClientRect(),this.bindEvents();var p={original:{x:a,y:r,width:this.size.width,height:this.size.height},isResizing:!0,backgroundStyle:fe(fe({},this.state.backgroundStyle),{cursor:this.window.getComputedStyle(n.target).cursor||"auto"}),direction:s,flexBasis:l};this.setState(p)}},o.prototype.onMouseMove=function(n){var s=this;if(!(!this.state.isResizing||!this.resizable||!this.window)){if(this.window.TouchEvent&&ut(n))try{n.preventDefault(),n.stopPropagation()}catch{}var a=this.props,r=a.maxWidth,i=a.maxHeight,l=a.minWidth,c=a.minHeight,g=ut(n)?n.touches[0].clientX:n.clientX,d=ut(n)?n.touches[0].clientY:n.clientY,p=this.state,y=p.direction,m=p.original,v=p.width,b=p.height,E=this.getParentSize(),C=Yo(E,this.window.innerWidth,this.window.innerHeight,r,i,l,c);r=C.maxWidth,i=C.maxHeight,l=C.minWidth,c=C.minHeight;var f=this.calculateNewSizeFromDirection(g,d),x=f.newHeight,R=f.newWidth,I=this.calculateNewMaxFromBoundary(r,i);this.props.snap&&this.props.snap.x&&(R=un(R,this.props.snap.x,this.props.snapGap)),this.props.snap&&this.props.snap.y&&(x=un(x,this.props.snap.y,this.props.snapGap));var L=this.calculateNewSizeFromAspectRatio(R,x,{width:I.maxWidth,height:I.maxHeight},{width:l,height:c});if(R=L.newWidth,x=L.newHeight,this.props.grid){var P=dn(R,this.props.grid[0]),O=dn(x,this.props.grid[1]),k=this.props.snapGap||0;R=k===0||Math.abs(P-R)<=k?P:R,x=k===0||Math.abs(O-x)<=k?O:x}var $={width:R-m.width,height:x-m.height};if(v&&typeof v=="string"){if(v.endsWith("%")){var w=R/E.width*100;R=w+"%"}else if(v.endsWith("vw")){var H=R/this.window.innerWidth*100;R=H+"vw"}else if(v.endsWith("vh")){var Z=R/this.window.innerHeight*100;R=Z+"vh"}}if(b&&typeof b=="string"){if(b.endsWith("%")){var w=x/E.height*100;x=w+"%"}else if(b.endsWith("vw")){var H=x/this.window.innerWidth*100;x=H+"vw"}else if(b.endsWith("vh")){var Z=x/this.window.innerHeight*100;x=Z+"vh"}}var B={width:this.createSizeForCssProperty(R,"width"),height:this.createSizeForCssProperty(x,"height")};this.flexDir==="row"?B.flexBasis=B.width:this.flexDir==="column"&&(B.flexBasis=B.height),(0,Qo.flushSync)(function(){s.setState(B)}),this.props.onResize&&this.props.onResize(n,y,this.resizable,$)}},o.prototype.onMouseUp=function(n){var s=this.state,a=s.isResizing,r=s.direction,i=s.original;if(!(!a||!this.resizable)){var l={width:this.size.width-i.width,height:this.size.height-i.height};this.props.onResizeStop&&this.props.onResizeStop(n,r,this.resizable,l),this.props.size&&this.setState(this.props.size),this.unbindEvents(),this.setState({isResizing:!1,backgroundStyle:fe(fe({},this.state.backgroundStyle),{cursor:"auto"})})}},o.prototype.updateSize=function(n){this.setState({width:n.width,height:n.height})},o.prototype.renderResizer=function(){var n=this,s=this.props,a=s.enable,r=s.handleStyles,i=s.handleClasses,l=s.handleWrapperStyle,c=s.handleWrapperClass,g=s.handleComponent;if(!a)return null;var d=Object.keys(a).map(function(p){return a[p]!==!1?t.createElement(Go,{key:p,direction:p,onResizeStart:n.onResizeStart,replaceStyles:r&&r[p],className:i&&i[p]},g&&g[p]?g[p]:null):null});return t.createElement("div",{className:c,style:l},d)},o.prototype.render=function(){var n=this,s=Object.keys(this.props).reduce(function(i,l){return Jo.indexOf(l)!==-1||(i[l]=n.props[l]),i},{}),a=fe(fe(fe({position:"relative",userSelect:this.state.isResizing?"none":"auto"},this.props.style),this.sizeStyle),{maxWidth:this.props.maxWidth,maxHeight:this.props.maxHeight,minWidth:this.props.minWidth,minHeight:this.props.minHeight,boxSizing:"border-box",flexShrink:0});this.state.flexBasis&&(a.flexBasis=this.state.flexBasis);var r=this.props.as||"div";return t.createElement(r,fe({ref:this.ref,style:a,className:this.props.className},s),this.state.isResizing&&t.createElement("div",{style:this.state.backgroundStyle}),this.props.children,this.renderResizer())},o.defaultProps={as:"div",onResizeStart:function(){},onResize:function(){},onResizeStop:function(){},enable:{top:!0,right:!0,bottom:!0,left:!0,topRight:!0,bottomRight:!0,bottomLeft:!0,topLeft:!0},style:{},grid:[1,1],lockAspectRatio:!1,lockAspectRatioExtraWidth:0,lockAspectRatioExtraHeight:0,scale:1,resizeRatio:1,snapGap:0},o}(t.PureComponent),Xo=u(69144);function gn(e){const{width:o,children:n,onResize:s}=e,a=(0,N.$j)(),r=(0,N.of)(es),i=(0,Xo.l)(a),l=`${o+31.5}px`;return t.createElement(hn,{className:(0,h.cx)(r.fixed,r.container,r.drawerActive),defaultSize:{width:l,height:`${a.components.horizontalDrawer.defaultHeight}px`},handleClasses:{top:i.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",maxWidth:l,minWidth:l,onResize:s},n)}const _o=e=>(0,h.keyframes)`
  0% {
    transform: translateY(${e.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,es=e=>({fixed:(0,h.css)({position:"fixed !important"}),container:(0,h.css)({bottom:0,background:e.colors.background.primary,borderTop:`1px solid ${e.colors.border.weak}`,margin:e.spacing(0,-2,0,-2),boxShadow:e.shadows.z3,zIndex:e.zIndex.navbarFixed}),drawerActive:(0,h.css)({opacity:1,animation:`0.5s ease-out ${_o(e)}`})});var ts=u(61453),ns=u(82344),os=u(61396),ss=u(32067),as=u(90820);function rs(e){const{width:o,onClose:n,queryResponse:s,timeZone:a,isMixed:r,exploreId:i}=e,[l,c]=(0,t.useState)({withTransforms:!1,withFieldConfig:!0}),g=s?.series||[];let d=s?.errors;!d?.length&&s?.error&&(d=[s.error]),(0,t.useEffect)(()=>{(0,z.rR)("grafana_explore_query_inspector_opened")},[]);const p={label:"Stats",value:"stats",icon:"chart-line",content:t.createElement(ss.N,{data:s,timeZone:s?.request?.timezone??K.vp})},y={label:"JSON",value:"json",icon:"brackets-curly",content:t.createElement(os.w,{data:s,onClose:n})},m={label:"Data",value:"data",icon:"database",content:t.createElement(ts.q,{data:g,dataName:"Explore",isLoading:s.state===ce.Gu.Loading,options:l,timeZone:a,app:Ue.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:c})},v={label:"Query",value:"query",icon:"info-circle",content:t.createElement(as.e,{instanceId:r?(0,et.qM)(0,(0,Be.uq)(i)):(0,Be.uq)(i),data:s,onRefreshQuery:()=>e.runQueries({exploreId:i})})},b=[p,v,y,m];if(d?.length){const E={label:"Error",value:"error",icon:"exclamation-triangle",content:t.createElement(ns.y,{errors:d})};b.push(E)}return t.createElement(gn,{width:o},t.createElement(rn.q,{tabs:b,onClose:n,closeIconTooltip:"Close query inspector"}))}function is(e,{exploreId:o}){const s=e.explore.panes[o],{queryResponse:a}=s;return{queryResponse:a}}const ls={runQueries:q.Od},cs=(0,me.connect)(is,ls)(rs);var ds=u(67570),us=u(95247),ae=u(27746),mn=u(19727),ht=u(11134),ps=u(75269),S=u(44836),hs=u(51612),It=u(76698),de=u(64756),Ft=u(10096),fn=u(81862),yn=u(85858),gs=u(25573),vn=u(80582);function ms(e){const{onClick:o,isSynced:n}=e,s=()=>{const{isSynced:a}=e,r=a?"Unsync all views":"Sync all views to this time range";return t.createElement(t.Fragment,null,r)};return t.createElement(ge.m,{content:s,placement:"bottom"},t.createElement(ae.I,{icon:"link",variant:n?"active":"canvas","aria-label":n?"Synced times":"Unsynced times",onClick:o}))}class fs extends t.Component{constructor(){super(...arguments),this.onMoveTimePicker=o=>{const{range:n,onChangeTime:s,timeZone:a}=this.props,{from:r,to:i}=(0,vn.Wb)(o,n),l={from:(0,we.oZ)(a,r),to:(0,we.oZ)(a,i)};s(l)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=o=>{const n=yn.isMathString(o.raw.from)?o.raw.from:o.from,s=yn.isMathString(o.raw.to)?o.raw.to:o.to;this.props.onChangeTime({from:n,to:s}),(0,z.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:n,timeRangeTo:s})},this.onZoom=()=>{const{range:o,onChangeTime:n,timeZone:s}=this.props,{from:a,to:r}=(0,vn.Zk)(o,2),i={from:(0,we.oZ)(s,a),to:(0,we.oZ)(s,r)};n(i)}}render(){const{range:o,timeZone:n,fiscalYearStartMonth:s,splitted:a,syncedTimes:r,onChangeTimeSync:i,hideText:l,onChangeTimeZone:c,onChangeFiscalYearStartMonth:g}=this.props,d=a?t.createElement(ms,{onClick:i,isSynced:r}):void 0,p={value:o,timeZone:n,fiscalYearStartMonth:s,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:l};return t.createElement(gs.m,{isOnCanvas:!0,...p,timeSyncButton:d,isSynced:r,widthOverride:a?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:c,onChangeFiscalYearStartMonth:g})}}var bn=u(66588);function ys(e){const{start:o,pause:n,resume:s,isLive:a,isPaused:r,stop:i,splitted:l}=e,c=a&&!r?"active":"canvas",g=a?r?s:n:o;return t.createElement(mn.e,null,t.createElement(ge.m,{content:a&&!r?t.createElement(t.Fragment,null,"Pause the live stream"):t.createElement(t.Fragment,null,"Start live stream your logs"),placement:"bottom"},t.createElement(ae.I,{iconOnly:l,variant:c,icon:!a||r?"play":"pause",onClick:g},a&&r?"Paused":"Live")),t.createElement(bn.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:a,classNames:{enter:gt.stopButtonEnter,enterActive:gt.stopButtonEnterActive,exit:gt.stopButtonExit,exitActive:gt.stopButtonExitActive}},t.createElement(ge.m,{content:t.createElement(t.Fragment,null,"Stop and exit the live stream"),placement:"bottom"},t.createElement(ae.I,{variant:c,onClick:i,icon:"square-shape"}))))}const gt={stopButtonEnter:(0,h.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,h.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,h.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,h.css)({label:"stopButtonExitActive",opacity:0,width:0})};var ke=u(38138),vs=u(59093),bs=u(15068),Ot=u(83122),Dt=u(7030),Ie=u(96192);const Es={key:"copy-link",label:(0,S.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1};function xs(){const e=(0,D.useSelector)(J.Qb),[o,n]=(0,t.useState)(!1),[s,a]=(0,t.useState)(Es),r=(c,g,d)=>{c?((0,Dt.V)(d||u.g.location.href),(0,z.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:g})):((0,Be.uJ)(d!==void 0?`${window.location.protocol}//${window.location.host}${V.$.appSubUrl}${d}`:u.g.location.href),(0,z.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:g}))},i=[{key:"normal",label:(0,S.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,S.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,S.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,S.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,S.t)("explore.toolbar.copy-shortened-link-abs-time","Copy Absolute Shortened URL"),shorten:!0,getUrl:()=>(0,Ie._O)(e),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,S.t)("explore.toolbar.copy-link-abs-time","Copy Absolute Shortened URL"),shorten:!1,getUrl:()=>(0,Ie._O)(e),absTime:!0}]}],l=t.createElement(ke.W,null,i.map(c=>t.createElement(vs.r,{key:c.key,label:c.label},c.items.map(g=>t.createElement(ke.W.Item,{key:g.key,label:g.label,icon:g.icon,onClick:()=>{const d=g.getUrl();r(g.shorten,g.absTime,d),a(g)}})))));return t.createElement(bs.U,null,t.createElement(Qe.B,{gap:0,direction:"row",alignItems:"center",wrap:"nowrap"},t.createElement(ae.I,{tooltip:s.label,icon:s.icon,iconOnly:!0,narrow:!0,onClick:()=>{const c=s.getUrl();r(s.shorten,s.absTime,c)},"aria-label":(0,S.t)("explore.toolbar.copy-shortened-link","Copy shortened URL")}),t.createElement(Ot.m,{overlay:l,placement:"bottom-end",onVisibleChange:n},t.createElement(ae.I,{narrow:!0,isOpen:o,"aria-label":(0,S.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")}))))}var Ss=u(1933),Cs=u(74135),Rs=u(4402),ws=u(24401),Ts=u(30973);const Ls=(0,t.lazy)(()=>u.e(4787).then(u.bind(u,74787)).then(({AddToDashboard:e})=>({default:e})));function Is(e){const{exploreId:o}=e,[n,s]=(0,t.useState)(),[a,r]=(0,t.useState)(!1),i=Fs(e),l=Os(i),c=(0,J.qq)(o),g=(0,D.useSelector)(c)?.queries?.length;if(l.length<=1)return _e.TP.hasPermission(D.AccessControlAction.DashboardsCreate)||_e.TP.hasPermission(D.AccessControlAction.DashboardsWrite)?t.createElement(t.Suspense,{fallback:null},t.createElement(Ls,{exploreId:o})):null;const d=t.createElement(Ts.w,{extensions:l,onSelect:s});return t.createElement(t.Fragment,null,t.createElement(Ot.m,{onVisibleChange:r,placement:"bottom-start",overlay:d},t.createElement(ae.I,{"aria-label":"Add",disabled:!g,variant:"canvas",isOpen:a},"Add")),!!n&&!!n.path&&t.createElement(ws.s,{path:n.path,title:n.title,onDismiss:()=>s(void 0)}))}function Fs(e){const{exploreId:o,timeZone:n}=e,a=(0,D.useSelector)(J.vC)?.editorMode||!1,{queries:r,queryResponse:i,range:l}=(0,D.useSelector)((0,J.qq)(o)),c=(0,D.useSelector)((0,J.Jr)(o)),g=r.map(y=>y?.datasource?.uid).filter(y=>y!==void 0),d=[...new Set(g)].length,p=_e.TP.hasPermission(D.AccessControlAction.DataSourcesWrite);return(0,t.useMemo)(()=>({exploreId:o,targets:r,data:i,timeRange:l.raw,timeZone:(0,Ss.O)({timeZone:n}),shouldShowAddCorrelation:V.$.featureToggles.correlations===!0&&p&&!a&&c&&d===1}),[o,r,i,l.raw,n,p,a,c,d])}function Os(e){return(0,t.useMemo)(()=>{const{extensions:o}=(0,Rs.Kf)({extensionPointId:Cs.S.ExploreToolbarAction,context:e,limitPerPlugin:3});return o},[e])}var ue=u(89224);function Ds(e){const o=(0,D.useDispatch)(),n=(0,t.useCallback)(()=>{o((0,q.qk)({exploreId:e,isPaused:!0}))},[e,o]),s=(0,t.useCallback)(()=>{o((0,q.qk)({exploreId:e,isPaused:!1}))},[e,o]),a=(0,t.useCallback)(()=>{n(),o((0,ue.hO)({exploreId:e,refreshInterval:ht.cC.offOption.value})),o((0,q.Od)({exploreId:e}))},[e,o,n]),r=(0,t.useCallback)(()=>{o((0,ue.hO)({exploreId:e,refreshInterval:ht.cC.liveOption.value}))},[e,o]),i=(0,t.useCallback)(()=>{o((0,q.rR)({exploreId:e}))},[e,o]);return{pause:n,resume:s,stop:a,start:r,clear:i}}function En(e){const o=Ds(e.exploreId);return e.children(o)}const As=(e,o)=>({rotateIcon:(0,h.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,h.css)({display:"flex",justifyContent:"center",marginRight:e.spacing(.5),width:o&&e.spacing(6)})});function Ns({exploreId:e,onChangeTime:o,onContentOutlineToogle:n,isContentOutlineOpen:s}){const a=(0,de.wA)(),r=(0,de.d4)(J.pF),i=(0,N.of)(As,r),l=(0,de.d4)(F=>(0,st.O)(F.user)),c=(0,de.d4)(F=>(0,st.q)(F.user)),{refreshInterval:g,datasourceInstance:d,range:p,isLive:y,isPaused:m,syncedTimes:v}=(0,de.d4)(F=>({...(0,te.pick)(F.explore.panes[e],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:F.explore.syncedTimes}),me.shallowEqual),b=(0,de.d4)((0,q.h1)(e)),E=(0,de.d4)(F=>F.explore.largerExploreId===e),C=(0,de.d4)(F=>r||F.explore.panes[e].containerWidth<1210),f=(0,de.d4)(F=>F.explore.panes[e].containerWidth<(r?700:800)),x=(0,de.d4)(J.K6),R=(0,de.d4)(J.vC),I=R?.editorMode||!1,L=(0,de.d4)((0,J.Jr)(e)),P=(0,t.useMemo)(()=>L&&E||!L&&!E,[L,E]),O=b?(0,S.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,S.t)("explore.toolbar.refresh-picker-run","Run query"),k=async F=>{I?R?.correlationDirty||R?.queryEditorDirty?a((0,G.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:It.IW.CHANGE_DATASOURCE,changeDatasourceUid:F.uid,isActionLeft:L}})):(L&&x.forEach(Q=>{a((0,Ee.nE)({exploreId:Q[0],correlationEditorHelperData:void 0}))}),a((0,Ne.wh)({exploreId:e,datasource:F.uid,options:{importQueries:!0}}))):a((0,Ne.wh)({exploreId:e,datasource:F.uid,options:{importQueries:!0}}))},$=(F=!1)=>a(F?(0,q.hS)(e):(0,q.Od)({exploreId:e})),w=F=>a((0,fn.Cj)(F)),H=()=>{a((0,G.ve)()),(0,z.rR)("grafana_explore_split_view_opened",{origin:"menu"})},Z=()=>{I?R?.correlationDirty||R?.queryEditorDirty?a((0,G.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:It.IW.CLOSE_PANE,isActionLeft:L}})):(x.forEach(F=>{a((0,Ee.nE)({exploreId:F[0],correlationEditorHelperData:void 0}))}),a((0,G.J8)(e)),(0,z.rR)("grafana_explore_split_view_closed")):(a((0,G.J8)(e)),(0,z.rR)("grafana_explore_split_view_closed"))},B=()=>{a(E?(0,G.JA)():(0,G.tP)({exploreId:e}))},re=()=>{a((0,ue.iO)(e))},T=F=>a((0,fn.c1)(F)),A=F=>{a((0,ue.hO)({exploreId:e,refreshInterval:F}))},M=[t.createElement(xs,{key:"share"}),t.createElement("div",{style:{flex:1},key:"spacer0"})];return t.createElement("div",null,g&&t.createElement(ds.u,{func:$,interval:g,loading:b}),t.createElement("div",null,t.createElement(ps.H,{actions:M})),t.createElement(us.d,{"aria-label":(0,S.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[V.$.featureToggles.exploreContentOutline&&t.createElement(ae.I,{key:"content-outline",variant:"canvas",tooltip:"Content outline",icon:"list-ui-alt",iconOnly:r,onClick:n,"aria-expanded":s,"aria-controls":s?"content-outline-container":void 0,className:i.toolbarButton},"Outline"),t.createElement(hs.s,{key:`${e}-ds-picker`,mixed:!I,onChange:k,current:d?.getRef(),hideTextValue:f,width:f?8:void 0})].filter(Boolean),forceShowLeftItems:!0},[r?t.createElement(mn.e,{key:"split-controls"},t.createElement(ae.I,{variant:"canvas",tooltip:E?(0,S.t)("explore.toolbar.split-narrow","Narrow pane"):(0,S.t)("explore.toolbar.split-widen","Widen pane"),onClick:B,icon:E?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,h.cx)(P&&i.rotateIcon)}),t.createElement(ae.I,{tooltip:(0,S.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:Z,icon:"times",variant:"canvas"},t.createElement(S.x6,{i18nKey:"explore.toolbar.split-close"}," Close "))):t.createElement(ae.I,{variant:"canvas",key:"split",tooltip:(0,S.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:H,icon:"columns",disabled:y},t.createElement(S.x6,{i18nKey:"explore.toolbar.split-title"},"Split")),t.createElement(Is,{key:"toolbar-extension-point",exploreId:e,timeZone:l}),!y&&t.createElement(fs,{key:"timeControls",exploreId:e,range:p,timeZone:l,fiscalYearStartMonth:c,onChangeTime:o,splitted:r,syncedTimes:v,onChangeTimeSync:re,hideText:C,onChangeTimeZone:w,onChangeFiscalYearStartMonth:T}),t.createElement(ht.cC,{key:"refreshPicker",onIntervalChanged:A,value:g,isLoading:b,text:C?void 0:O,tooltip:C?O:void 0,intervals:Ft.TP.getValidIntervals(ht.cb),isLive:y,onRefresh:()=>$(b),noIntervalPicker:y,primary:!0,width:(C?35:108)+"px"}),d?.meta.streaming&&t.createElement(En,{key:"liveControls",exploreId:e},F=>{const Q={...F,start:()=>{(0,z.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:d?.type}),F.start()}};return t.createElement(ys,{splitted:r,isLive:y,isPaused:m,start:Q.start,pause:Q.pause,resume:Q.resume,stop:Q.stop})})].filter(Boolean)))}var zs=u(85194);function mt(e,o={}){(0,z.rR)(`grafana_flamegraph_${e}`,{app:Ue.Jk.Unknown,grafana_version:V.$.buildInfo.version,...o})}const Hs=e=>{const o=(0,N.of)(n=>Ms(n));return t.createElement("div",{className:o.container},t.createElement(zs.A,{data:e.dataFrames[0],stickyHeader:!0,getTheme:()=>V.$.theme2,onTableSymbolClick:()=>mt("table_item_selected"),onViewSelected:n=>mt("view_selected",{view:n}),onTextAlignSelected:n=>mt("text_align_selected",{align:n}),onTableSort:n=>mt("table_sort_selected",{sort:n}),disableCollapsing:!V.$.featureToggles.flameGraphItemCollapsing}))},Ms=e=>({container:(0,h.css)({background:e.colors.background.primary,display:"flow-root",padding:e.spacing(0,1,1,1),border:`1px solid ${e.components.panel.borderColor}`,borderRadius:e.shape.radius.default})});var Ps=u(72519),xn=u(84140),At=u(72724),ks=u(85492),$s=u(77020),Te=u(91002),Bs=u(10940),Ws=u(97814);const Sn=150,Vs=({resetKey:e,humanize:o,className:n})=>{const[s,a]=(0,t.useState)(0);return(0,Bs.A)(()=>a(s+Sn),Sn),(0,t.useEffect)(()=>a(0),[e]),t.createElement(Ws.g,{timeInMs:s,className:n,humanize:o})};var Qs=u(34028);const js=e=>({logsRowsLive:(0,h.css)`
    label: logs-rows-live;
    font-family: ${e.typography.fontFamilyMonospace};
    font-size: ${e.typography.bodySmall.fontSize};
    display: flex;
    flex-flow: column nowrap;
    height: 60vh;
    overflow-y: scroll;
    :first-child {
      margin-top: auto !important;
    }
  `,logsRowFade:(0,h.css)`
    label: logs-row-fresh;
    color: ${e.colors.text};
    background-color: ${(0,xn.A)(e.colors.info.transparent).setAlpha(.25).toString()};
    animation: fade 1s ease-out 1s 1 normal forwards;
    @keyframes fade {
      from {
        background-color: ${(0,xn.A)(e.colors.info.transparent).setAlpha(.25).toString()};
      }
      to {
        background-color: transparent;
      }
    }
  `,logsRowsIndicator:(0,h.css)`
    font-size: ${e.typography.h6.fontSize};
    padding-top: ${e.spacing(1)};
    display: flex;
    align-items: center;
  `,button:(0,h.css)`
    margin-right: ${e.spacing(1)};
  `,fullWidth:(0,h.css)`
    width: 100%;
  `});class Us extends t.PureComponent{constructor(o){super(o),this.liveEndDiv=null,this.scrollContainerRef=t.createRef(),this.onScroll=n=>{const{isPaused:s,onPause:a}=this.props,{scrollTop:r,clientHeight:i,scrollHeight:l}=n.currentTarget;l-(r+i)>=5&&!s&&a()},this.rowsToRender=()=>{const{isPaused:n}=this.props;let{logRowsToRender:s=[]}=this.state;return n||(s=(0,Te.oR)(s,K.uH.Ascending).slice(-100)),s},this.state={logRowsToRender:o.logRows}}static getDerivedStateFromProps(o,n){return o.isPaused&&o.clearedAtIndex?{logRowsToRender:(0,Qs.pg)(o.clearedAtIndex,n.logRowsToRender)}:o.isPaused?null:{logRowsToRender:o.logRows}}render(){const{theme:o,timeZone:n,onPause:s,onResume:a,onClear:r,isPaused:i}=this.props,l=js(o),{logsRow:c,logsRowLocalTime:g,logsRowMessage:d}=(0,$s.D)(o);return t.createElement("div",null,t.createElement("table",{className:l.fullWidth},t.createElement("tbody",{onScroll:i?void 0:this.onScroll,className:l.logsRowsLive,ref:this.scrollContainerRef},this.rowsToRender().map(p=>t.createElement("tr",{className:(0,h.cx)(c,l.logsRowFade),key:p.uid},t.createElement("td",{className:g},(0,At.LE)(p.timeEpochMs,{timeZone:n})),t.createElement("td",{className:d},p.hasAnsi?t.createElement(ks.$,{value:p.raw}):p.entry))),t.createElement("tr",{ref:p=>{this.liveEndDiv=p,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!i&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}}))),t.createElement("div",{className:l.logsRowsIndicator},t.createElement(U.$n,{icon:i?"play":"pause",variant:"secondary",onClick:i?a:s,className:l.button},i?"Resume":"Pause"),t.createElement(U.$n,{icon:"trash-alt",variant:"secondary",onClick:r,className:l.button},"Clear logs"),t.createElement(U.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:l.button},"Exit live mode"),i||this.rowsToRender().length>0&&t.createElement("span",null,"Last line received: ",t.createElement(Vs,{resetKey:this.props.logRows,humanize:!0})," ago")))}}const Gs=(0,N.cV)(Us);var Cn=u(69129),Rn=u(76885),Ge=u(65879),ft=u(94354),qs=u(39268),ye=u(14186),Fe=u(15292),ne=u(33390),wn=u(81073);const Ks=({children:e,loading:o,loadMoreLogs:n,range:s,rows:a,scrollElement:r,sortOrder:i,timeZone:l,topScrollEnabled:c=!1})=>{const[g,d]=(0,t.useState)(!1),[p,y]=(0,t.useState)(!1),[m,v]=(0,t.useState)(!1),[b,E]=(0,t.useState)(!1),C=(0,t.useRef)(a),f=(0,t.useRef)(r?.scrollTop||0);(0,t.useEffect)(()=>{d(!1),y(!1)},[s,a,i]),(0,t.useEffect)(()=>{o||(v(!1),E(!1))},[o]),(0,t.useEffect)(()=>{b&&r&&r.scrollTo(0,r.scrollHeight-r.clientHeight)},[b,r]),(0,t.useEffect)(()=>{a!==C.current&&a.length===C.current.length&&(m||b)&&(i===K.uH.Descending&&b?y(!0):i===K.uH.Ascending&&m&&d(!0)),C.current=a},[b,a,i,m]),(0,t.useEffect)(()=>{if(!r||!n)return;function I(O){if(!r||!n||!a.length||o||!V.$.featureToggles.logsInfiniteScrolling)return;O.stopImmediatePropagation();const k=Js(O,r,f.current);f.current=r.scrollTop,k!==0&&(k===-1&&c?L():k===1&&P())}function L(){const O=Xs(Ln(a),s,l,i);if(!O){d(!0);return}d(!1),n?.(O),v(!0),(0,z.rR)("grafana_logs_infinite_scrolling",{direction:"top",sort_order:i})}function P(){const O=_s(Ln(a),s,l,i);if(!O){y(!0);return}y(!1),n?.(O),E(!0),(0,z.rR)("grafana_logs_infinite_scrolling",{direction:"bottom",sort_order:i})}return r.addEventListener("scroll",I),r.addEventListener("wheel",I),()=>{r.removeEventListener("scroll",I),r.removeEventListener("wheel",I)}},[n,o,s,a,r,i,l,c]);const x=i===K.uH.Descending&&(0,Ge.isRelativeTime)(s.raw.to),R=i===K.uH.Ascending&&(0,Ge.isRelativeTime)(s.raw.to);return t.createElement(t.Fragment,null,m&&t.createElement(wn.I,{adjective:i===K.uH.Descending?"newer":"older"}),!x&&g&&Tn,e,!R&&p&&Tn,b&&t.createElement(wn.I,{adjective:i===K.uH.Descending?"older":"newer"}))},Zs={messageContainer:(0,h.css)({textAlign:"center",padding:.25})},Tn=t.createElement("div",{className:Zs.messageContainer,"data-testid":"end-of-range"},"End of the selected time range.");var Ys=(e=>(e[e.Top=-1]="Top",e[e.Bottom=1]="Bottom",e[e.NoScroll=0]="NoScroll",e))(Ys||{});function Js(e,o,n){if(o.scrollHeight<=o.clientHeight)return 0;const s=e instanceof WheelEvent?e.deltaY:o.scrollTop-n;if(s===0)return 0;const a=s<0?-1:1;return(a===-1?o.scrollTop:o.scrollHeight-o.scrollTop-o.clientHeight)<=1?a:0}function Ln(e){const o=e[0].timeEpochMs,n=e[e.length-1].timeEpochMs;return n<o?{from:n,to:o}:{from:o,to:n}}function In(e,o){return{from:o.from.valueOf(),to:e.from}}function Fn(e,o,n){return o=Nt(o,n),{from:e.to,to:o.to.valueOf()}}const yt=1e3;function Xs(e,o,n,s){return s===K.uH.Descending?(o=Nt(o,n),o.to.valueOf()-e.to>yt?Fn(e,o,n):void 0):Math.abs(o.from.valueOf()-e.from)>yt?In(e,o):void 0}function _s(e,o,n,s){return s===K.uH.Descending?Math.abs(o.from.valueOf()-e.from)>yt?In(e,o):void 0:(o=Nt(o,n),o.to.valueOf()-e.to>yt?Fn(e,o,n):void 0)}function Nt(e,o){return(0,Ge.isRelativeTimeRange)(e.raw)?(0,Ge.convertRawToRange)(e.raw,o):e}var Le=u(99140),On=u(14647),ea=u(81166),zt=u(69147),Dn=u(39590);function ta({feedbackUrl:e}){const o=(0,N.of)(na);return t.createElement(Qe.B,null,t.createElement("a",{href:e,className:o.link,title:"The logs table is new, please let us know how we can improve it",target:"_blank",rel:"noreferrer noopener"},t.createElement(le.I,{name:"comment-alt-message"})," Give feedback"))}function na(e){return{link:(0,h.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,":hover":{color:e.colors.text.link}})}}var oa=u(4213),sa=u.n(oa),An=u(75505),Nn=u(2514),zn=u(18358),aa=u(93463),ra=u(40455);const Hn=e=>({metaContainer:(0,h.css)({flex:1,color:e.colors.text.secondary,marginBottom:e.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,h.css)({marginRight:e.spacing(2),marginTop:e.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:e.colors.error.text}}),metaLabel:(0,h.css)({marginRight:`calc(${e.spacing(2)} / 2)`,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium}),metaValue:(0,h.css)({fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize})}),ia=(0,t.memo)(function(o){const n=(0,N.of)(Hn),{label:s,value:a}=o;return t.createElement("div",{"data-testid":"meta-info-text-item",className:n.metaItem},s&&t.createElement("span",{className:n.metaLabel},s,":"),t.createElement("span",{className:n.metaValue},a))}),Ht=(0,t.memo)(function(o){const n=(0,N.of)(Hn),{metaItems:s}=o;return t.createElement("div",{className:n.metaContainer,"data-testid":"meta-info-text"},s.map((a,r)=>t.createElement(ia,{key:`${r}-${a.label}`,label:a.label,value:a.value})))});var Mn=u(14236),vt=u(90708),qe=u(11261),Pn=u(41260),Mt=u(77093);function la(e){const{timeZone:o,splitOpen:n,range:s,logsSortOrder:a,width:r,dataFrame:i,columnsWithMeta:l,logsFrame:c}=e,[g,d]=(0,t.useState)(void 0),p=c?.timeField.index,y=(0,t.useCallback)(v=>{if(!v.length)return v;const b=(0,Mn.ES)(v,p,a===K.uH.Descending),[E]=(0,vt.we)({data:[b],timeZone:o,theme:V.$.theme2,replaceVariables:C=>C,fieldConfig:{defaults:{custom:{}},overrides:[]}});for(const C of E.fields)C.getLinks=f=>(0,Ie.QL)({field:C,rowIndex:f.valueRowIndex,splitOpenFn:n,range:s,dataFrame:b}),C.config={...C.config,custom:{inspect:!0,filterable:!0,width:pa(C),...C.config.custom},filterable:ca(C,c?.bodyField.name??"",c?.timeField.name??"")},C.type=C.type===qe.PU.string?(0,Mn.dF)(C)??qe.PU.string:C.type;return E},[a,o,n,s,c?.bodyField.name,c?.timeField.name,p]);if((0,t.useEffect)(()=>{(async()=>{if(!c?.timeField.name||!c?.bodyField.name){d(void 0);return}const b=kn(i);let E=da(l);const C=ua(E);if(C?b.push(C):b.push({id:"organize",options:{indexByName:{[c.bodyField.name]:0,[c.timeField.name]:1},includeByName:{[c.bodyField.name]:!0,[c.timeField.name]:!0}}}),b.length>0){const f=await(0,An.s)((0,Nn.m)(b,[i])),x=y(f[0]);d(x)}else d(y(i))})()},[l,i,a,y,c?.bodyField.name,c?.timeField.name]),!g)return null;const m=v=>{const{value:b,key:E,operator:C}=v,{onClickFilterLabel:f,onClickFilterOutLabel:x}=e;!f||!x||(C===ot.mc&&f(E,b,i),C===ot.Zi&&x(E,b,i))};return t.createElement(Mt.X,{data:g,width:r,onCellFilterAdded:e.onClickFilterLabel&&e.onClickFilterOutLabel?m:void 0,height:e.height,footerOptions:{show:!0,reducer:["count"],countRows:!0}})}const ca=(e,o,n)=>!(!o||!n||o===e.name||n===e.name||e.config.links?.length);function kn(e){return e.fields.filter(o=>{const n=o.typeInfo?.frame==="json.RawMessage"&&o.name==="labels"&&e?.meta?.type!==Pn.m.LogLines,s=o.name==="labels"&&o.type===qe.PU.other&&e?.meta?.type===Pn.m.LogLines;return n||s}).flatMap(o=>[{id:"extractFields",options:{format:"json",keepTime:!1,replace:!1,source:o.name}}])}function da(e){let o={};return Object.keys(e).filter(n=>e[n].active).forEach(n=>{const s=e[n].index;s!==void 0&&(o[n]=s)}),o}function ua(e){let o={};for(const n in e)o[n]=!0;return Object.keys(e).length>0?{id:"organize",options:{indexByName:e,includeByName:o}}:null}function pa(e){if(e.type===qe.PU.time)return 200}const ha=()=>({metaContainer:(0,h.css)`
    flex: 1;
    display: flex;
    flex-wrap: wrap;
  `});var ga=(e=>(e.Text="text",e.Json="json",e.CSV="csv",e))(ga||{});const $n=t.memo(({meta:e,dedupStrategy:o,dedupCount:n,displayedFields:s,clearDetectedFields:a,hasUnescapedContent:r,forceEscape:i,onEscapeNewlines:l,logRows:c})=>{const g=(0,N.of)(ha),d=async m=>{switch((0,z.rR)("grafana_logs_download_logs_clicked",{app:Ue.Jk.Explore,format:m,area:"logs-meta-row"}),m){case"text":(0,zn.Zy)({meta:e,rows:c},"Explore");break;case"json":const v=(0,Te.Dg)(c),b=new Blob([JSON.stringify(v)],{type:"application/json;charset=utf-8"}),E=`Explore-logs-${(0,At.LE)(new Date)}.json`;sa()(b,E);break;case"csv":const C=new Map;c.forEach(f=>{f.dataFrame?.refId&&!C.has(f.dataFrame?.refId)&&C.set(f.dataFrame?.refId,f.dataFrame)}),C.forEach(async f=>{const x=kn(f);x.push({id:"organize",options:{excludeByName:{labels:!0,labelTypes:!0}}});const R=await(0,An.s)((0,Nn.m)(x,[f]));(0,zn.EM)(R[0],`Explore-logs-${f.refId}`)})}},p=[...e];o!==K.fY.none&&p.push({label:"Deduplication count",value:n,kind:Y.tG.Number}),c.some(m=>m.entry.length>ra.S)&&p.push({label:"Info",value:"Logs with more than 100,000 characters could not be parsed and highlighted",kind:Y.tG.String}),s?.length>0&&p.push({label:"Showing only selected fields",value:Bn(s,Y.tG.LabelsMap)},{label:"",value:t.createElement(U.$n,{variant:"secondary",size:"sm",onClick:a},"Show original line")}),r&&p.push({label:"Your logs might have incorrectly escaped content",value:t.createElement(ge.m,{content:"Fix incorrectly escaped newline and tab sequences in log lines. Manually review the results to confirm that the replacements are correct.",placement:"right"},t.createElement(U.$n,{variant:"secondary",size:"sm",onClick:l},i?"Remove escaping":"Escape newlines"))});const y=t.createElement(ke.W,null,t.createElement(ke.W.Item,{label:"txt",onClick:()=>d("text")}),t.createElement(ke.W.Item,{label:"json",onClick:()=>d("json")}),t.createElement(ke.W.Item,{label:"csv",onClick:()=>d("csv")}));return t.createElement(t.Fragment,null,p&&t.createElement("div",{className:g.metaContainer},t.createElement(Ht,{metaItems:p.map(m=>({label:m.label,value:"kind"in m?Bn(m.value,m.kind):m.value}))}),t.createElement(Ot.m,{overlay:y},t.createElement(ae.I,{isOpen:!1,variant:"canvas",icon:"download-alt"},"Download"))))});$n.displayName="LogsMetaRow";function Bn(e,o){return o===Y.tG.LabelsMap?t.createElement(aa.A,{labels:e}):o===Y.tG.Error?t.createElement("span",{className:"logs-meta-item__error"},e):e}var Pt=u(62930),ma=u(57571),fa=u(42994);function ya({pages:e,currentPageIndex:o,oldestLogsFirst:n,timeZone:s,loading:a,onClick:r}){const i=d=>`${(0,At.LE)(d,{format:fa.WC.interval.second,timeZone:s})}`,l=(d,p)=>{if(o===p&&a)return t.createElement(Pt.y,null);const y=i(n?d.logsRange.from:d.logsRange.to),m=i(n?d.logsRange.to:d.logsRange.from);return`${y} \u2014 ${m}`},c=(0,N.$j)(),g=va(c,a);return t.createElement(nt.E,{autoHide:!0},t.createElement("div",{className:g.pagesWrapper,"data-testid":"logsNavigationPages"},t.createElement("div",{className:g.pagesContainer},e.map((d,p)=>t.createElement("button",{type:"button","data-testid":`page${p+1}`,className:(0,h.cx)((0,U.my)(c),g.page),key:d.queryRange.to,onClick:()=>{r(d,p+1)},disabled:a},t.createElement("div",{className:(0,h.cx)(g.line,{selectedBg:o===p})}),t.createElement("div",{className:(0,h.cx)(g.time,{selectedText:o===p})},l(d,p)))))))}const va=(e,o)=>({pagesWrapper:(0,h.css)`
      height: 100%;
      padding-left: ${e.spacing(.5)};
      display: flex;
      flex-direction: column;
      overflow-y: scroll;
      &::after {
        content: '';
        display: block;
        background: repeating-linear-gradient(
          135deg,
          ${e.colors.background.primary},
          ${e.colors.background.primary} 5px,
          ${e.colors.background.secondary} 5px,
          ${e.colors.background.secondary} 15px
        );
        width: 3px;
        height: inherit;
        margin-bottom: 8px;
      }
    `,pagesContainer:(0,h.css)`
      display: flex;
      padding: 0;
      flex-direction: column;
    `,page:(0,h.css)`
      display: flex;
      margin: ${e.spacing(2)} 0;
      cursor: ${o?"auto":"pointer"};
      white-space: normal;
      .selectedBg {
        background: ${e.colors.primary.main};
      }
      .selectedText {
        color: ${e.colors.primary.main};
      }
    `,line:(0,h.css)`
      width: 3px;
      height: 100%;
      align-items: center;
      background: ${e.colors.text.secondary};
    `,time:(0,h.css)`
      width: 60px;
      min-height: 80px;
      font-size: ${e.v1.typography.size.sm};
      padding-left: ${e.spacing(.5)};
      display: flex;
      align-items: center;
    `});function ba({absoluteRange:e,logsSortOrder:o,timeZone:n,loading:s,onChangeTime:a,scrollToTopLogs:r,visibleRange:i,queries:l,clearCache:c,addResultsToCache:g}){const[d,p]=(0,t.useState)([]),y=(0,t.useRef)(),m=(0,t.useRef)(),v=(0,t.useRef)(0),b=(0,t.useMemo)(()=>d.findIndex(w=>w.queryRange.to===e.to),[e.to,d]),E=o===K.uH.Ascending,C=E?b===d.length-1:b===0,f=E?b===0:b===d.length-1,x=(0,N.$j)(),R=xa(x,E);(0,t.useEffect)(()=>{const w={logsRange:i,queryRange:e};let H=[];!(0,te.isEqual)(m.current,e)||!(0,te.isEqual)(y.current,l)?(c(),p([w]),y.current=l,v.current=e.to-e.from):p(Z=>(H=Z.filter(B=>!(0,te.isEqual)(w.queryRange,B.queryRange)),H=[...H,w].sort((B,re)=>L(B,re,o)),H))},[i,e,o,l,c,g]);const I=(0,t.useCallback)(({from:w,to:H})=>{g(),m.current={from:w,to:H},a({from:w,to:H})},[a,g]),L=(w,H,Z)=>Z===K.uH.Ascending?w.queryRange.to>H.queryRange.to?1:-1:w.queryRange.to>H.queryRange.to?-1:1,P=t.createElement(U.$n,{"data-testid":"olderLogsButton",className:R.navButton,variant:"secondary",onClick:()=>{if((0,z.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),f)I({from:i.from-v.current,to:i.from});else{const w=E?-1:1;I({from:d[b+w].queryRange.from,to:d[b+w].queryRange.to})}r()},disabled:s},t.createElement("div",{className:R.navButtonContent},s?t.createElement(Pt.y,null):t.createElement(le.I,{name:E?"angle-up":"angle-down",size:"lg"}),"Older logs")),O=t.createElement(U.$n,{"data-testid":"newerLogsButton",className:R.navButton,variant:"secondary",onClick:()=>{if((0,z.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!C){const w=E?1:-1;I({from:d[b+w].queryRange.from,to:d[b+w].queryRange.to})}r()},disabled:s||C},t.createElement("div",{className:R.navButtonContent},s&&t.createElement(Pt.y,null),C||s?null:t.createElement(le.I,{name:E?"angle-down":"angle-up",size:"lg"}),C?"Start of range":"Newer logs")),k=(0,t.useCallback)((w,H)=>{(0,z.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:H}),I({from:w.queryRange.from,to:w.queryRange.to}),r()},[I,r]),$=(0,t.useCallback)(()=>{(0,z.rR)("grafana_explore_logs_scroll_top_clicked"),r()},[r]);return t.createElement("div",{className:R.navContainer},!V.$.featureToggles.logsInfiniteScrolling&&t.createElement(t.Fragment,null,E?P:O,t.createElement(ya,{pages:d,currentPageIndex:b,oldestLogsFirst:E,timeZone:n,loading:s,onClick:k}),E?O:P),t.createElement(U.$n,{"data-testid":"scrollToTop",className:R.scrollToTopButton,variant:"secondary",onClick:$,title:"Scroll to top"},t.createElement(le.I,{name:"arrow-up",size:"lg"})))}const Ea=(0,t.memo)(ba),xa=(e,o)=>{const n=`calc(100vh - 2*${e.spacing(2)} - 2*${ma.l}px)`;return{navContainer:(0,h.css)`
      max-height: ${n};
      display: flex;
      flex-direction: column;
      ${V.$.featureToggles.logsInfiniteScrolling?"justify-content: flex-end;":`justify-content: ${o?"flex-start":"space-between"};`}
      position: sticky;
      top: ${e.spacing(2)};
      right: 0;
    `,navButton:(0,h.css)`
      width: 58px;
      height: 68px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      line-height: 1;
    `,navButtonContent:(0,h.css)`
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      white-space: normal;
    `,scrollToTopButton:(0,h.css)`
      width: 40px;
      height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: ${e.spacing(1)};
    `}};var Wn=u(98101);function Sa(e){return{searchWrap:(0,h.css)({padding:`${e.spacing(.4)} 0 ${e.spacing(.4)} ${e.spacing(.4)}`})}}function Ca(e){const o=(0,N.$j)(),n=Sa(o);return t.createElement(xe.D,{className:n.searchWrap},t.createElement(je.p,{value:e.value,type:"text",placeholder:"Search fields by name",onChange:e.onChange}))}var kt=u(55244);function Ra(e){return{empty:(0,h.css)({marginBottom:e.spacing(2),marginLeft:e.spacing(1.75),fontSize:e.typography.fontSize})}}function Vn(){const e=(0,N.$j)(),o=Ra(e);return t.createElement("div",{className:o.empty},"No fields")}var wa=u(10880);function Ta(e){return{dragIcon:(0,h.css)({cursor:"drag",marginLeft:e.spacing(1),opacity:.4}),labelCount:(0,h.css)({marginLeft:e.spacing(.5),marginRight:e.spacing(.5),appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11),opacity:.6}),contentWrap:(0,h.css)({display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"}),checkboxLabel:(0,h.css)({"> span":{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block",maxWidth:"100%"}})}}function Qn(e){const o=(0,N.$j)(),n=Ta(o);if(e.labels[e.label])return t.createElement(t.Fragment,null,t.createElement("div",{className:n.contentWrap},t.createElement(wa.S,{className:n.checkboxLabel,label:e.label,onChange:e.onChange,checked:e.labels[e.label]?.active??!1}),e.showCount&&t.createElement("button",{className:n.labelCount,onClick:e.onChange},e.labels[e.label]?.percentOfLinesWithLabel,"%")),e.draggable&&t.createElement(le.I,{"aria-label":"Drag and drop icon",title:"Drag and drop to reorder",name:"draggabledots",size:"lg",className:n.dragIcon}))}function jn(e){return{wrap:(0,h.css)({marginTop:e.spacing(1),marginBottom:e.spacing(1),display:"flex",background:e.colors.background.primary}),dragging:(0,h.css)({background:e.colors.background.secondary}),columnWrapper:(0,h.css)({marginBottom:e.spacing(1.5),paddingLeft:e.spacing(.5)})}}function La(e){return(o,n)=>{const s=e[o],a=e[n];return s.index!=null&&a.index!=null?s.index-a.index:0}}const Ia=e=>{const{reorderColumn:o,labels:n,valueFilter:s,toggleColumn:a}=e,r=(0,N.$j)(),i=jn(r),l=Object.keys(n).filter(d=>s(d)),c=d=>{d.destination&&o(d.source.index,d.destination.index)},g=d=>{const p=n[d];if(p)return`${d} appears in ${p?.percentOfLinesWithLabel}% of log lines`};return l.length?t.createElement(kt.JY,{onDragEnd:c},t.createElement(kt.gL,{droppableId:"order-fields",direction:"vertical"},d=>t.createElement("div",{className:i.columnWrapper,...d.droppableProps,ref:d.innerRef},l.sort(La(n)).map((p,y)=>t.createElement(kt.sx,{draggableId:p,key:p,index:y},(m,v)=>t.createElement("div",{className:(0,h.cx)(i.wrap,v.isDragging?i.dragging:void 0),ref:m.innerRef,...m.draggableProps,...m.dragHandleProps,title:g(p)},t.createElement(Qn,{label:p,onChange:()=>a(p),labels:n,draggable:!0})))),d.placeholder))):t.createElement(Vn,null)},Fa=new Intl.Collator(void 0,{sensitivity:"base"});function Oa(e){return(o,n)=>{const s=e[o],a=e[n];return s!=null&&a!=null?+(a.type==="TIME_FIELD")-+(s.type==="TIME_FIELD")||+(a.type==="BODY_FIELD")-+(s.type==="BODY_FIELD")||Fa.compare(o,n):0}}const Da=e=>{const{labels:o,valueFilter:n,toggleColumn:s}=e,a=(0,N.$j)(),r=jn(a),i=Object.keys(o).filter(l=>n(l));return i.length?t.createElement("div",{className:r.columnWrapper},i.sort(Oa(o)).map((l,c)=>t.createElement("div",{key:l,className:r.wrap,title:`${l} appears in ${o[l]?.percentOfLinesWithLabel}% of log lines`},t.createElement(Qn,{showCount:!0,label:l,onChange:()=>s(l),labels:o})))):t.createElement(Vn,null)};function Aa(e){return{sidebarWrap:(0,h.css)({overflowY:"scroll",height:"calc(100% - 50px)","&::-webkit-scrollbar":{display:"none"},scrollbarWidth:"none"}),columnHeaderButton:(0,h.css)({appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11)}),columnHeader:(0,h.css)({display:"flex",justifyContent:"space-between",fontSize:e.typography.h6.fontSize,background:e.colors.background.secondary,position:"sticky",top:0,left:0,paddingTop:e.spacing(.75),paddingRight:e.spacing(.75),paddingBottom:e.spacing(.75),paddingLeft:e.spacing(1.5),zIndex:3,marginBottom:e.spacing(2)})}}const Na=e=>{const o=(0,N.$j)(),n=Aa(o);return t.createElement("div",{className:n.sidebarWrap},t.createElement(t.Fragment,null,t.createElement("div",{className:n.columnHeader},"Selected fields",t.createElement("button",{onClick:e.clear,className:n.columnHeaderButton},"Reset")),t.createElement(Ia,{reorderColumn:e.reorderColumn,toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:s=>e.columnsWithMeta[s]?.active??!1,id:"selected-fields"}),t.createElement("div",{className:n.columnHeader},"Fields"),t.createElement(Da,{toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:s=>!e.columnsWithMeta[s]?.active})))};var Un=u(53076);const za=new Un.A({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function Gn(e,o,n){const[s,a,r]=za.search(e,o,0,1e5);let i=[],l=new Set;if(s&&r){const c=(g,d)=>{d&&l.add(g)};for(let g=0;g<r.length;g++){let d=r[g];Un.A.highlight(e[a.idx[d]],a.ranges[d],c),i.push(e[a.idx[d]])}n([i,[...l]])}else o||n([[],[]])}const Mi=(0,te.debounce)(Gn,300);function Ha(e){const{logsFrames:o,updatePanelState:n,panelState:s}=e,a=s?.columns,[r,i]=(0,t.useState)(void 0),[l,c]=(0,t.useState)(void 0),[g,d]=(0,t.useState)(""),p=qn(),y=e?.panelState?.refId,[m,v]=(0,t.useState)(o.find(T=>T.refId===y)??o[0]),b=(0,t.useCallback)(T=>{const A=e.panelState?.columns;return A&&Object.values(A).forEach((M,F)=>{T[M]&&(T[M].active=!0,T[M].index=F)}),T},[e.panelState?.columns]),E=(0,Wn.O)(m);(0,t.useEffect)(()=>{if(E?.timeField.name&&E?.bodyField.name&&!a){const T={0:E?.timeField.name??"",1:E?.bodyField.name??""};n({columns:Object.values(T),visualisationType:"table",labelFieldName:E?.getLabelFieldName()??void 0})}},[E,a,n]),(0,t.useEffect)(()=>{const T=o.find(A=>A.refId===y)??o[0];T&&v(T)},[o,y]),(0,t.useEffect)(()=>{if(!r||!l)return;let T={...l},A=!1;Object.keys(r).forEach(M=>{T[M]&&T[M].active!==r[M].active&&(T[M]=r[M],A=!0)}),A&&c(T)},[r,l]),(0,t.useEffect)(()=>{if(!m.length)return;const T=m?m.length:0,A=(0,Wn.O)(m),M=A?.getLogFrameLabelsAsLabels(),F=[];A&&F.push(...A.extraFields.filter(ee=>!ee?.config?.custom?.hidden)),A?.severityField&&F.push(A?.severityField),A?.bodyField&&F.push(A?.bodyField),A?.timeField&&F.push(A?.timeField);const Q=new Map;let W={};M?.length&&T&&(M.forEach(ee=>{Object.keys(ee).forEach(pe=>{if(Q.has(pe)){const ie=Q.get(pe);ie&&(ie?.active?Q.set(pe,{percentOfLinesWithLabel:ie.percentOfLinesWithLabel+1,active:!0,index:ie.index}):Q.set(pe,{percentOfLinesWithLabel:ie.percentOfLinesWithLabel+1,active:!1,index:void 0}))}else Q.set(pe,{percentOfLinesWithLabel:1,active:!1,index:void 0})})}),W=Object.fromEntries(Q),Object.keys(W).forEach(ee=>{W[ee].percentOfLinesWithLabel=$t(W[ee].percentOfLinesWithLabel,T)})),F.forEach(ee=>{const j=W[ee.name]?.active,pe=W[ee.name]?.index;j&&pe!==void 0?W[ee.name]={percentOfLinesWithLabel:$t(ee.values.filter(ie=>ie!=null).length,T),active:!0,index:pe}:W[ee.name]={percentOfLinesWithLabel:$t(ee.values.filter(ie=>ie!=null).length,T),active:!1,index:void 0}}),W=b(W),Object.keys(W).filter(ee=>W[ee].active).length===0&&(A?.bodyField?.name&&(W[A.bodyField.name].active=!0),A?.timeField?.name&&(W[A.timeField.name].active=!0)),A?.bodyField?.name&&A?.timeField?.name&&(W[A.bodyField.name].type="BODY_FIELD",W[A.timeField.name].type="TIME_FIELD"),i(W)},[m,b]);const[C,f]=(0,t.useState)(220),x=e.width-C;if(!r)return null;function R(T){if(r){const A=!r[T]?.active,M=Object.keys(r).filter(Q=>r[Q]?.active)?.length,F={columnAction:A?"add":"remove",columnCount:A?M+1:M-1,datasourceType:e.datasourceType};(0,z.rR)("grafana_explore_logs_table_column_filter_clicked",F)}}function I(T){(0,z.rR)("grafana_explore_logs_table_text_search_result_count",{resultCount:T,datasourceType:e.datasourceType??"unknown"})}const L=()=>{const T={...r};let A=0;Object.keys(T).forEach(M=>{const F=!!T[M].type;T[M].active=F,T[M].index=F?A++:void 0}),i(T)},P=(T,A)=>{if(T===A)return;const M={...r},F=Object.keys(M).filter(W=>M[W].active).map(W=>({fieldName:W,index:M[W].index??0})).sort((W,be)=>W.index-be.index),[Q]=F.splice(T,1);F.splice(A,0,Q),F.forEach((W,be)=>{M[W.fieldName].index=be}),i(M),O(M)};function O(T){const A=Object.keys(T).filter(W=>T[W]?.active).sort((W,be)=>{const ee=T[W],j=T[be];return ee.index!==void 0&&j.index!==void 0?ee.index-j.index:0}),M=Object.assign({},A),F={0:E?.timeField.name??"",1:E?.bodyField.name??""},Q={...e.panelState,columns:Object.keys(M).length?M:F,refId:m.refId,visualisationType:"table",labelFieldName:E?.getLabelFieldName()??void 0};n(Q)}const k=T=>{if(!r||!(T in r)){console.warn("failed to get column",r);return}const A=Object.keys(r).filter(Q=>r[Q].active).length,M=r[T].active?void 0:!0;let F;if(M?F={...r,[T]:{...r[T],active:M,index:A}}:F={...r,[T]:{...r[T],active:!1,index:void 0}},R(T),i(F),l){const Q=!l[T]?.active;let W;Q?W={...l,[T]:{...l[T],active:Q,index:A}}:W={...l,[T]:{...l[T],active:!1,index:void 0}},c(W)}O(F)},$=T=>{const A=T[0];let M={},F=0;A.forEach(Q=>{Q in r&&(M[Q]=r[Q],F++)}),c(M),I(F)},w=T=>{Gn(Object.keys(r),T,$)},H=T=>{const A=T.currentTarget?.value;d(A),A?w(A):c(void 0)},Z=T=>{o.find(M=>M.refId===T.value)&&v(o.find(M=>M.refId===T.value)??o[0]),e.updatePanelState({refId:T.value,labelFieldName:E?.getLabelFieldName()??void 0})},B=Ma(e.theme,p,C),re=(T,A,M)=>{const F=Number(M.style.width.slice(0,-2));isNaN(F)||f(F)};return t.createElement(t.Fragment,null,t.createElement("div",null,o.length>1&&t.createElement("div",null,t.createElement(ye.I,{label:"Select query",htmlFor:"explore_logs_table_frame_selector",labelWidth:22,tooltip:"Select a query to visualize in the table."},t.createElement(Re.l6,{inputId:"explore_logs_table_frame_selector","aria-label":"Select query by name",value:m.refId,options:o.map(T=>({label:T.refId,value:T.refId})),onChange:Z})))),t.createElement("div",{className:B.wrapper},t.createElement(hn,{enable:{right:!0},handleClasses:{right:B.rzHandle},onResize:re},t.createElement("section",{className:B.sidebar},t.createElement(Ca,{value:g,onChange:H}),t.createElement(Na,{reorderColumn:P,toggleColumn:k,filteredColumnsWithMeta:l,columnsWithMeta:r,clear:L}))),t.createElement(la,{logsFrame:E,onClickFilterLabel:e.onClickFilterLabel,onClickFilterOutLabel:e.onClickFilterOutLabel,logsSortOrder:e.logsSortOrder,range:e.range,splitOpen:e.splitOpen,timeZone:e.timeZone,width:x,dataFrame:m,columnsWithMeta:r,height:p})))}const $t=(e,o)=>Math.ceil(100*e/o);function Ma(e,o,n){return{wrapper:(0,h.css)({display:"flex"}),sidebar:(0,h.css)({height:o,fontSize:e.typography.pxToRem(11),overflowY:"hidden",width:n,paddingRight:e.spacing(3)}),rzHandle:(0,h.css)({background:e.colors.secondary.main,transition:"0.3s background ease-in-out",position:"relative",height:"50% !important",width:`${e.spacing(1)} !important`,top:"25% !important",right:`${e.spacing(1)} !important`,cursor:"grab",borderRadius:e.shape.radius.pill,"&:hover":{background:e.colors.secondary.shade}})}}const qn=()=>Math.max(window.innerHeight-500,500);function Bt(e){const[o,n]=(0,t.useState)(!1),s=100,{error:a,title:r,suggestedAction:i,onSuggestedAction:l,onRemove:c,severity:g="warning"}=e,d=a?.message||a?.data?.message||"",p=!o&&d.length>s,y=(0,N.$j)(),m=Pa(y);return t.createElement("div",{className:m.supplementaryErrorContainer},t.createElement(Ve.F,{title:r,severity:g,onRemove:c},t.createElement("div",{className:m.suggestedActionWrapper},p?t.createElement(U.$n,{variant:"secondary",size:"xs",onClick:()=>{n(!0)}},"Show details"):d,i&&l&&t.createElement("div",{className:m.suggestedActionWrapper},t.createElement(U.$n,{variant:"primary",size:"xs",onClick:l},i)))))}const Pa=e=>({supplementaryErrorContainer:(0,h.css)({width:"50%",minWidth:`${e.breakpoints.values.sm}px`,margin:"0 auto"}),suggestedActionWrapper:(0,h.css)({height:e.spacing(6),button:{position:"absolute",right:e.spacing(2),top:e.spacing(7)}})});var ka=u(9791);function $a(e){const{width:o,timeZone:n,splitOpen:s,onUpdateTimeRange:a,onHiddenSeriesChanged:r,allLogsVolumeMaximum:i}=e,l=(0,N.$j)(),c=(0,N.of)(Ba),g=parseInt(l.spacing(2).slice(0,-2),10),d=150,p=e.logsVolumeData,y=(0,Te.Dm)(p?.data);let m=y?`${y.name}`:"";(0,Te.e3)(p.data)&&(m=[m,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(te.identity).join(". "));let v=t.createElement("span",null,m);return p.state===ce.Gu.Streaming&&(v=t.createElement(t.Fragment,null,v,t.createElement(ge.m,{content:"Streaming"},t.createElement(le.I,{name:"circle-mono",size:"md",className:c.streaming,"data-testid":"logs-volume-streaming"})))),t.createElement("div",{style:{height:d},className:c.contentContainer},t.createElement(ka.k,{vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:p.state??ce.Gu.Done,data:p.data,height:d,width:o-g*2,absoluteRange:e.absoluteRange,onChangeTime:a,timeZone:n,splitOpenFn:s,tooltipDisplayMode:K.$N.Multi,onHiddenSeriesChanged:r,anchorToZero:!0,yAxisMaximum:i,eventBus:e.eventBus,annotations:e.annotations}),v&&t.createElement("div",{className:c.extraInfoContainer},v))}const Ba=e=>({extraInfoContainer:(0,h.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: -10px;
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,contentContainer:(0,h.css)`
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    `,streaming:(0,h.css)`
      color: ${e.colors.success.text};
    `});function Wa(e){return!e||!e.error&&!e.errors?!1:(e.error?[e.error]:e.errors||[]).some(n=>(`${n.message||n.data?.message}`?.toLowerCase()).includes("timeout"))}const Va=({logsVolumeData:e,absoluteRange:o,onUpdateTimeRange:n,width:s,onLoadLogsVolume:a,onHiddenSeriesChanged:r,eventBus:i,splitOpen:l,timeZone:c,onClose:g})=>{const{logVolumes:d,maximumValue:p,maximumRange:y,annotations:m}=(0,t.useMemo)(()=>{let x=-1/0;const R=e?.data.filter($=>$.meta?.dataTopic!==K.QR.Annotations),I=e?.data.filter($=>$.meta?.dataTopic===K.QR.Annotations)||[],L=(0,te.sortBy)(R||[],"meta.custom.datasourceName"),P=(0,te.groupBy)(L,"meta.custom.datasourceName"),O=(0,te.mapValues)(P,$=>{const w=(0,Te.oT)($);return x=Math.max(x,w.maximum),w.dataFrames}),k=(0,Te.Dx)((0,te.flatten)(Object.values(O)));return{maximumValue:x,maximumRange:k,logVolumes:O,annotations:I}},[e]),v=(0,N.of)(Qa),b=Object.keys(d).length,E=Object.values(d).some(x=>{const R=ja(x,o);return!(0,Te.e3)(x)&&R&&R<1}),C=Wa(e),f={from:Math.max(o.from,y.from),to:Math.min(o.to,y.to)};return e?.state===ce.Gu.Loading?t.createElement("span",null,"Loading..."):C?t.createElement(Bt,{title:"The logs volume query has timed out",severity:"info",suggestedAction:"Retry",onSuggestedAction:a,onRemove:g}):e?.error!==void 0?t.createElement(Bt,{error:e.error,title:"Failed to load log volume for this query"}):b===0?t.createElement("div",{className:v.alertContainer},t.createElement(Ve.F,{severity:"info",title:"No logs volume available"},"No volume information available for the current queries and time range.")):t.createElement("div",{className:v.listContainer},Object.keys(d).map((x,R)=>{const I={data:d[x]};return t.createElement($a,{key:R,absoluteRange:f,allLogsVolumeMaximum:p,width:s,logsVolumeData:I,onUpdateTimeRange:n,timeZone:c,splitOpen:l,onLoadLogsVolume:a,onHiddenSeriesChanged:b>1?()=>{}:r,eventBus:i,annotations:m})}),E&&t.createElement("div",{className:v.extraInfoContainer},t.createElement(ye.I,{label:"Reload log volume",transparent:!0},t.createElement(U.$n,{size:"xs",icon:"sync",variant:"secondary",onClick:a,id:"reload-volume"}))))},Qa=e=>({listContainer:(0,h.css)`
      padding-top: 10px;
    `,extraInfoContainer:(0,h.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: 5px;
    `,oldInfoText:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,alertContainer:(0,h.css)`
      width: 50%;
      min-width: ${e.breakpoints.values.sm}px;
      margin: 0 auto;
    `});function ja(e,o){const n=e&&e[0]&&e[0].meta?.custom?.absoluteRange;return n?(o.from-o.to)/(n.from-n.to):void 0}var oe=u(97186);const Ua=[K.fY.none,K.fY.exact,K.fY.numbers,K.fY.signature],Wt=()=>ne.A.get(oe.r)==="table"?"table":"logs";class Ga extends t.PureComponent{constructor(o){super(o),this.topLogsRef=(0,t.createRef)(),this.state={showLabels:ne.A.getBool(oe.$.showLabels,!1),showTime:ne.A.getBool(oe.$.showTime,!0),wrapLogMessage:ne.A.getBool(oe.$.wrapLogMessage,!0),prettifyLogMessage:ne.A.getBool(oe.$.prettifyLogMessage,!1),dedupStrategy:K.fY.none,hiddenLogLevels:[],logsSortOrder:ne.A.get(oe.$.logsSortOrder)||K.uH.Descending,isFlipping:!1,displayedFields:[],forceEscape:!1,contextOpen:!1,contextRow:void 0,tableFrame:void 0,visualisationType:this.props.panelState?.logs?.visualisationType??Wt(),logsContainer:void 0},this.updatePanelState=n=>{const s=(0,Le.Gu)().explore.panes[this.props.exploreId];s?.panelsState&&(0,Le.JD)((0,Ee.EA)(this.props.exploreId,"logs",{...s.panelsState.logs,columns:n.columns??this.props.panelState?.logs?.columns,visualisationType:n.visualisationType??this.state.visualisationType,labelFieldName:n.labelFieldName,refId:n.refId??this.props.panelState?.logs?.refId}))},this.onLogRowHover=n=>{n?this.props.eventBus.publish(new Cn.b_({point:{time:n.timeEpochMs}})):this.props.eventBus.publish(new Cn.ql)},this.onLogsContainerRef=n=>{this.setState({logsContainer:n})},this.onChangeLogsSortOrder=()=>{this.setState({isFlipping:!0}),this.flipOrderTimer=window.setTimeout(()=>{this.setState(n=>{const s=n.logsSortOrder===K.uH.Descending?K.uH.Ascending:K.uH.Descending;return ne.A.set(oe.$.logsSortOrder,s),{logsSortOrder:s}})},0),this.cancelFlippingTimer=window.setTimeout(()=>this.setState({isFlipping:!1}),1e3)},this.onEscapeNewlines=()=>{this.setState(n=>({forceEscape:!n.forceEscape}))},this.onChangeVisualisation=n=>{this.setState(()=>({visualisationType:n}));const s={...this.props.panelState?.logs,visualisationType:n};this.updatePanelState(s),(0,z.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:n,datasourceType:this.props.datasourceType??"unknown"})},this.onChangeDedup=n=>{(0,z.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:n,datasourceType:this.props.datasourceType}),this.setState({dedupStrategy:n})},this.onChangeLabels=n=>{const{target:s}=n;if(s){const a=s.checked;this.setState({showLabels:a}),ne.A.set(oe.$.showLabels,a)}},this.onChangeTime=n=>{const{target:s}=n;if(s){const a=s.checked;this.setState({showTime:a}),ne.A.set(oe.$.showTime,a)}},this.onChangeWrapLogMessage=n=>{const{target:s}=n;if(s){const a=s.checked;this.setState({wrapLogMessage:a}),ne.A.set(oe.$.wrapLogMessage,a)}},this.onChangePrettifyLogMessage=n=>{const{target:s}=n;if(s){const a=s.checked;this.setState({prettifyLogMessage:a}),ne.A.set(oe.$.prettifyLogMessage,a)}},this.onToggleLogLevel=n=>{const s=n.map(a=>(0,Te.EK)(a));this.setState({hiddenLogLevels:s})},this.onToggleLogsVolumeCollapse=n=>{this.props.onSetLogsVolumeEnabled(!n),(0,z.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:this.props.datasourceType,type:n?"close":"open"})},this.onClickScan=n=>{n.preventDefault(),this.props.onStartScanning&&(this.props.onStartScanning(),(0,z.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:this.props.datasourceType}))},this.onClickStopScan=n=>{n.preventDefault(),this.props.onStopScanning&&this.props.onStopScanning()},this.showField=n=>{this.state.displayedFields.indexOf(n)===-1&&this.setState(a=>({displayedFields:a.displayedFields.concat(n)}))},this.hideField=n=>{this.state.displayedFields.indexOf(n)>-1&&this.setState(a=>({displayedFields:a.displayedFields.filter(r=>n!==r)}))},this.clearDetectedFields=()=>{this.setState(n=>({displayedFields:[]}))},this.onCloseContext=()=>{this.setState({contextOpen:!1,contextRow:void 0})},this.onOpenContext=(n,s)=>{this.setState({contextOpen:!0,contextRow:n}),(0,z.rR)("grafana_explore_logs_log_context_opened",{datasourceType:n.datasourceType,logRowUid:n.uid}),this.onCloseContext=()=>{this.setState({contextOpen:!1,contextRow:void 0}),(0,z.rR)("grafana_explore_logs_log_context_closed",{datasourceType:n.datasourceType,logRowUid:n.uid}),s()}},this.onPermalinkClick=async n=>{if(n.rowId===void 0)return;const s=(0,Dn.m)((0,Le.Gu)().explore.panes[this.props.exploreId]);s.panelsState={...this.props.panelState,logs:{id:n.uid,visualisationType:this.state.visualisationType??Wt()}},s.range=this.getPermalinkRange(n);const a=(0,Rn.Pp)(s),r=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],i=Rn.kM.renderUrl(`${r}/explore`,{left:a});await(0,Dt.V)(i),(0,z.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:n.datasourceType??"unknown",logRowUid:n.uid,logRowLevel:n.logLevel})},this.scrollIntoView=n=>{if(V.$.featureToggles.logsInfiniteScrolling){this.state.logsContainer&&(this.topLogsRef.current?.scrollIntoView(),this.state.logsContainer.scroll({behavior:"smooth",top:this.state.logsContainer.scrollTop+n.getBoundingClientRect().top-window.innerHeight/2}));return}const{scrollElement:s}=this.props;s&&s.scroll({behavior:"smooth",top:s.scrollTop+n.getBoundingClientRect().top-window.innerHeight/2})},this.checkUnescapedContent=(0,ze.A)(n=>!!n.some(s=>s.hasUnescapedContent)),this.dedupRows=(0,ze.A)((n,s)=>{const a=(0,zt.M0)(n,s),r=a.reduce((i,l)=>l.duplicates?i+l.duplicates:i,0);return{dedupedRows:a,dedupCount:r}}),this.filterRows=(0,ze.A)((n,s)=>(0,zt.ct)(n,new Set(s))),this.createNavigationRange=(0,ze.A)(n=>{if(!n||n.length===0)return;const s=n[0].timeEpochMs,a=n[n.length-1].timeEpochMs;return a<s?{from:a,to:s}:{from:s,to:a}}),this.scrollToTopLogs=()=>{V.$.featureToggles.logsInfiniteScrolling&&this.state.logsContainer&&this.state.logsContainer.scroll({behavior:"auto",top:0}),this.topLogsRef.current?.scrollIntoView()},this.logsVolumeEventBus=o.eventBus.newScopedBus("logsvolume",{onlyLocal:!1})}componentWillUnmount(){this.flipOrderTimer&&window.clearTimeout(this.flipOrderTimer),this.cancelFlippingTimer&&window.clearTimeout(this.cancelFlippingTimer),(this.props?.panelState?.logs?.columns||this.props?.panelState?.logs?.refId||this.props?.panelState?.logs?.labelFieldName)&&(0,Le.JD)((0,Ee.EA)(this.props.exploreId,"logs",{...this.props.panelState?.logs,columns:void 0,visualisationType:this.state.visualisationType,labelFieldName:void 0,refId:void 0}))}componentDidUpdate(o){if(this.props.loading&&!o.loading&&this.props.panelState?.logs?.id&&(delete this.props.panelState.logs.id,(0,Le.JD)((0,Ee.EA)(this.props.exploreId,"logs",{...this.props.panelState}))),this.props.panelState?.logs?.visualisationType!==o.panelState?.logs?.visualisationType){const n=this.props.panelState?.logs?.visualisationType??Wt();this.setState({visualisationType:n}),ne.A.set(oe.r,n)}}getPreviousLog(o,n){for(let s=n.indexOf(o)-1;s>=0;s--)if(n[s].timeEpochMs>o.timeEpochMs)return n[s];return null}getPermalinkRange(o){const n={from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(this.props.absoluteRange.to).toISOString()};if(!V.$.featureToggles.logsInfiniteScrolling)return n;const s=this.props.logRows.filter(r=>r.dataFrame.refId===o.dataFrame.refId),a=this.getPreviousLog(o,s);return o.timeEpochMs>this.props.absoluteRange.to&&!a?{from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(o.timeEpochMs+1).toISOString()}:{from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(a?a.timeEpochMs:this.props.absoluteRange.to).toISOString()}}render(){const{width:o,splitOpen:n,logRows:s,logsMeta:a,logsVolumeEnabled:r,logsVolumeData:i,loadLogsVolumeData:l,loading:c=!1,onClickFilterLabel:g,onClickFilterOutLabel:d,timeZone:p,scanning:y,scanRange:m,showContextToggle:v,absoluteRange:b,onChangeTime:E,getFieldLinks:C,theme:f,logsQueries:x,clearCache:R,addResultsToCache:I,exploreId:L,getRowContext:P,getLogRowContextUi:O,getRowContextQuery:k,loadMoreLogs:$}=this.props,{showLabels:w,showTime:H,wrapLogMessage:Z,prettifyLogMessage:B,dedupStrategy:re,hiddenLogLevels:T,logsSortOrder:A,isFlipping:M,displayedFields:F,forceEscape:Q,contextOpen:W,contextRow:be}=this.state,ee=qn(),j=Ka(f,Z,ee),pe=s&&s.length>0,ie=this.checkUnescapedContent(s),Fi=this.filterRows(s,T),{dedupedRows:Oi,dedupCount:Di}=this.dedupRows(Fi,re),Ai=this.createNavigationRange(s),Ni=m?`Scanning ${Ge.describeTimeRange(m)}`:"Scanning...";return t.createElement(t.Fragment,null,P&&be&&t.createElement(ea.V,{open:W,row:be,onClose:this.onCloseContext,getRowContext:(Ye,zi)=>P(Ye,be,zi),getRowContextQuery:k,getLogRowContextUi:O,logsSortOrder:A,timeZone:p}),t.createElement(Se.NR,{title:"Logs volume",collapsible:!0,collapsed:!r,onToggleCollapse:this.onToggleLogsVolumeCollapse},r&&t.createElement(Va,{absoluteRange:b,width:o,logsVolumeData:i,onUpdateTimeRange:E,timeZone:p,splitOpen:n,onLoadLogsVolume:l,onHiddenSeriesChanged:this.onToggleLogLevel,eventBus:this.logsVolumeEventBus,onClose:()=>this.onToggleLogsVolumeCollapse(!0)})),t.createElement(Se.NR,{titleItems:[V.$.featureToggles.logsExploreTableVisualisation?this.state.visualisationType==="logs"?null:t.createElement(Se.NR.TitleItem,{title:"Feedback",key:"A"},t.createElement(ta,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})):null],title:"Logs",actions:t.createElement(t.Fragment,null,V.$.featureToggles.logsExploreTableVisualisation&&t.createElement("div",{className:j.visualisationType},t.createElement(ft.z,{className:j.visualisationTypeRadio,options:[{label:"Logs",value:"logs",description:"Show results in logs visualisation"},{label:"Table",value:"table",description:"Show results in table visualisation"}],size:"sm",value:this.state.visualisationType,onChange:this.onChangeVisualisation}))),loadingState:c?ce.Gu.Loading:ce.Gu.Done},t.createElement("div",{className:j.stickyNavigation},this.state.visualisationType!=="table"&&t.createElement("div",{className:j.logOptions},t.createElement(qs.C,null,t.createElement(ye.I,{label:"Time",className:j.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:H,onChange:this.onChangeTime,className:j.horizontalInlineSwitch,transparent:!0,id:`show-time_${L}`})),t.createElement(ye.I,{label:"Unique labels",className:j.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:w,onChange:this.onChangeLabels,className:j.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${L}`})),t.createElement(ye.I,{label:"Wrap lines",className:j.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:Z,onChange:this.onChangeWrapLogMessage,className:j.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${L}`})),t.createElement(ye.I,{label:"Prettify JSON",className:j.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:B,onChange:this.onChangePrettifyLogMessage,className:j.horizontalInlineSwitch,transparent:!0,id:`prettify_${L}`})),t.createElement(ye.I,{label:"Deduplication",className:j.horizontalInlineLabel,transparent:!0},t.createElement(ft.z,{options:Ua.map(Ye=>({label:(0,te.capitalize)(Ye),value:Ye,description:Y._C[Ye]})),value:re,onChange:this.onChangeDedup,className:j.radioButtons}))),t.createElement("div",null,t.createElement(ye.I,{label:"Display results",className:j.horizontalInlineLabel,transparent:!0,disabled:M||c},t.createElement(ft.z,{options:[{label:"Newest first",value:K.uH.Descending,description:"Show results newest to oldest"},{label:"Oldest first",value:K.uH.Ascending,description:"Show results oldest to newest"}],value:A,onChange:this.onChangeLogsSortOrder,className:j.radioButtons})))),t.createElement("div",{ref:this.topLogsRef}),t.createElement($n,{logRows:s,meta:a||[],dedupStrategy:re,dedupCount:Di,hasUnescapedContent:ie,forceEscape:Q,displayedFields:F,onEscapeNewlines:this.onEscapeNewlines,clearDetectedFields:this.clearDetectedFields})),t.createElement("div",{className:(0,h.cx)(j.logsSection,this.state.visualisationType==="table"?j.logsTable:void 0)},this.state.visualisationType==="table"&&pe&&t.createElement("div",{className:j.logRows,"data-testid":"logRowsTable"},t.createElement(Ha,{logsSortOrder:this.state.logsSortOrder,range:this.props.range,splitOpen:this.props.splitOpen,timeZone:p,width:o-80,logsFrames:this.props.logsFrames??[],onClickFilterLabel:g,onClickFilterOutLabel:d,panelState:this.props.panelState?.logs,theme:f,updatePanelState:this.updatePanelState,datasourceType:this.props.datasourceType})),this.state.visualisationType==="logs"&&pe&&t.createElement("div",{className:V.$.featureToggles.logsInfiniteScrolling?j.scrollableLogRows:j.logRows,"data-testid":"logRows",ref:this.onLogsContainerRef},t.createElement(Ks,{loading:c,loadMoreLogs:$,range:this.props.range,timeZone:p,rows:s,scrollElement:this.state.logsContainer,sortOrder:A},t.createElement(On.k,{logRows:s,deduplicatedRows:Oi,dedupStrategy:re,onClickFilterLabel:g,onClickFilterOutLabel:d,showContextToggle:v,getRowContextQuery:k,showLabels:w,showTime:H,enableLogDetails:!0,forceEscape:Q,wrapLogMessage:Z,prettifyLogMessage:B,timeZone:p,getFieldLinks:C,logsSortOrder:A,displayedFields:F,onClickShowField:this.showField,onClickHideField:this.hideField,app:Ue.Jk.Explore,onLogRowHover:this.onLogRowHover,onOpenContext:this.onOpenContext,onPermalinkClick:this.onPermalinkClick,permalinkedRowId:this.props.panelState?.logs?.id,scrollIntoView:this.scrollIntoView,isFilterLabelActive:this.props.isFilterLabelActive,containerRendered:!!this.state.logsContainer,onClickFilterValue:this.props.onClickFilterValue,onClickFilterOutValue:this.props.onClickFilterOutValue}))),!c&&!pe&&!y&&t.createElement("div",{className:j.logRows},t.createElement("div",{className:j.noData},"No logs found.",t.createElement(U.$n,{size:"sm",variant:"secondary",onClick:this.onClickScan},"Scan for older logs"))),y&&t.createElement("div",{className:j.logRows},t.createElement("div",{className:j.noData},t.createElement("span",null,Ni),t.createElement(U.$n,{size:"sm",variant:"secondary",onClick:this.onClickStopScan},"Stop scan"))),t.createElement(Ea,{logsSortOrder:A,visibleRange:Ai??b,absoluteRange:b,timeZone:p,onChangeTime:E,loading:c,queries:x??[],scrollToTopLogs:this.scrollToTopLogs,addResultsToCache:I,clearCache:R}))))}}const qa=(0,N.cV)(Ga),Ka=(e,o,n)=>({noData:(0,h.css)({"& > *":{marginLeft:"0.5em"}}),logOptions:(0,h.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:e.colors.background.primary,padding:`${e.spacing(1)} ${e.spacing(2)}`,borderRadius:e.shape.radius.default,margin:`${e.spacing(0,0,1)}`,border:`1px solid ${e.colors.border.medium}`}),headerButton:(0,h.css)({margin:`${e.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,h.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,h.css)({padding:`0 ${e.spacing(1)} 0 0`}),radioButtons:(0,h.css)({margin:"0"}),logsSection:(0,h.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),logsTable:(0,h.css)({maxHeight:`${n}px`}),scrollableLogRows:(0,h.css)({overflowY:"scroll",width:"100%",maxHeight:"75vh"}),logRows:(0,h.css)({overflowX:`${o?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),visualisationType:(0,h.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,h.css)({margin:`0 0 0 ${e.spacing(1)}`}),stickyNavigation:(0,h.css)({overflow:"visible",...V.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),Vt=500,Qt=100,Za=(0,ze.A)(()=>({logsEnter:(0,h.css)`
      label: logsEnter;
      position: absolute;
      opacity: 0;
      height: auto;
      width: 100%;
    `,logsEnterActive:(0,h.css)`
      label: logsEnterActive;
      opacity: 1;
      transition: opacity ${Vt}ms ease-out ${Qt}ms;
    `,logsExit:(0,h.css)`
      label: logsExit;
      position: absolute;
      opacity: 1;
      height: auto;
      width: 100%;
    `,logsExitActive:(0,h.css)`
      label: logsExitActive;
      opacity: 0;
      transition: opacity ${Vt}ms ease-out ${Qt}ms;
    `}));function Kn(e){const{visible:o,children:n}=e,s=Za();return t.createElement(bn.A,{in:o,mountOnEnter:!0,unmountOnExit:!0,timeout:Vt+Qt,classNames:{enter:s.logsEnter,enterActive:s.logsEnterActive,exit:s.logsExit,exitActive:s.logsExitActive}},n)}class Ya extends t.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=o=>{const{exploreId:n,updateTimeRange:s}=this.props;s({exploreId:n,absoluteRange:o})},this.loadMoreLogs=o=>{const{exploreId:n,loadMoreLogs:s}=this.props;s({exploreId:n,absoluteRange:o})},this.getLogRowContext=async(o,n,s)=>{const{logsQueries:a}=this.props;if(!n.dataFrame.refId||!this.state.dsInstances[n.dataFrame.refId])return Promise.resolve([]);const r=this.state.dsInstances[n.dataFrame.refId];if(!(0,Y.Ol)(r))return Promise.resolve([]);const i=this.getQuery(a,n,r);return i?r.getLogRowContext(o,s,i):Promise.resolve([])},this.getLogRowContextQuery=async(o,n,s=!0)=>{const{logsQueries:a}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return Promise.resolve(null);const r=this.state.dsInstances[o.dataFrame.refId];if(!(0,Y.Ol)(r))return Promise.resolve(null);const i=this.getQuery(a,o,r);return i&&r.getLogRowContextQuery?r.getLogRowContextQuery(o,n,i,s):Promise.resolve(null)},this.getLogRowContextUi=(o,n)=>{const{logsQueries:s}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return t.createElement(t.Fragment,null);const a=this.state.dsInstances[o.dataFrame.refId];if(!(0,Y.Ol)(a))return t.createElement(t.Fragment,null);const r=this.getQuery(s,o,a);return r&&(0,Y.wj)(a)&&a.getLogRowContextUi?a.getLogRowContextUi(o,n,r):t.createElement(t.Fragment,null)},this.showContextToggle=o=>!o?.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId]?!1:(0,Y.Ol)(this.state.dsInstances[o.dataFrame.refId]),this.getFieldLinks=(o,n,s)=>{const{splitOpenFn:a,range:r}=this.props;return(0,Ie.QL)({field:o,rowIndex:n,splitOpenFn:a,range:r,dataFrame:s})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(o=>o?.modifyQuery||(0,Y._0)(o)||(0,Y.FP)(o)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,Y._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,Y._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(o){o.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:o,datasourceInstance:n}=this.props;if(!o||!n)return;const s={};if(n.uid!==et.uv){o.forEach(({refId:r})=>{s[r]=n}),this.setState({dsInstances:s});return}const a=[];for(const r of o){if(!r.datasource)continue;(!s[r.refId]||s[r.refId].uid!==r.datasource.uid)&&a.push(new Promise(l=>{(0,He.l)().get(r.datasource).then(c=>{l({ds:c,refId:r.refId})})}))}a.length&&Promise.all(a).then(r=>{r.forEach(({ds:i,refId:l})=>{s[l]=i}),this.setState({dsInstances:s})})}getQuery(o,n,s){return(o??[]).find(a=>a.refId===n.dataFrame.refId&&a.datasource!=null&&a.datasource.type===s.type)}render(){const{loading:o,loadingState:n,logRows:s,logsMeta:a,logsSeries:r,logsQueries:i,loadSupplementaryQueryData:l,setSupplementaryQueryEnabled:c,onClickFilterLabel:g,onClickFilterOutLabel:d,onStartScanning:p,onStopScanning:y,absoluteRange:m,timeZone:v,visibleRange:b,scanning:E,range:C,width:f,splitOpenFn:x,isLive:R,exploreId:I,logsVolume:L,scrollElement:P}=this.props;return s?t.createElement(t.Fragment,null,t.createElement(Kn,{visible:R},t.createElement(it.S,{label:"Logs",loading:!1,isOpen:!0},t.createElement(En,{exploreId:I},O=>t.createElement(Gs,{logRows:s,timeZone:v,stopLive:O.stop,isPaused:this.props.isPaused,onPause:O.pause,onResume:O.resume,onClear:O.clear,clearedAtIndex:this.props.clearedAtIndex})))),t.createElement(Kn,{visible:!R},t.createElement(qa,{exploreId:I,datasourceType:this.props.datasourceInstance?.type,logRows:s,logsMeta:a,logsSeries:r,logsVolumeEnabled:L.enabled,onSetLogsVolumeEnabled:O=>c(I,O,Y.cF.LogsVolume),logsVolumeData:L.data,logsQueries:i,width:f,splitOpen:x,loading:o,loadingState:n,loadLogsVolumeData:()=>l(I,Y.cF.LogsVolume),onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?g:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?d:void 0,onStartScanning:p,onStopScanning:y,absoluteRange:m,visibleRange:b,timeZone:v,scanning:E,scanRange:C.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:P,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:C,onClickFilterValue:this.filterValueAvailable()?this.props.onClickFilterValue:void 0,onClickFilterOutValue:this.filterOutValueAvailable()?this.props.onClickFilterOutValue:void 0}))):null}}function Ja(e,{exploreId:o}){const s=e.explore.panes[o],{logsResult:a,scanning:r,datasourceInstance:i,isLive:l,isPaused:c,clearedAtIndex:g,range:d,absoluteRange:p,supplementaryQueries:y}=s,m=(0,q.h1)(o)(e),v=s.panelsState,b=(0,st.O)(e.user),E=y[Y.cF.LogsVolume];return{loading:m,logRows:a?.rows,logsMeta:a?.meta,logsSeries:a?.series,logsQueries:a?.queries,visibleRange:a?.visibleRange,scanning:r,timeZone:b,datasourceInstance:i,isLive:l,isPaused:c,clearedAtIndex:g,range:d,absoluteRange:p,logsVolume:E,panelState:v,logsFrames:s.queryResponse.logsFrames}}const Xa={updateTimeRange:ue.GH,loadMoreLogs:ue.zY,addResultsToCache:q.He,clearCache:q.IL,loadSupplementaryQueryData:q.Az,setSupplementaryQueryEnabled:q.TO},_a=(0,me.connect)(Ja,Xa)(Ya);function er(e){const{queryResponse:o,timeZone:n,enabled:s,setLogsSampleEnabled:a,datasourceInstance:r,queries:i,splitOpen:l}=e,c=(0,N.of)(tr),g=y=>{a(y),(0,z.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:r?.type??"unknown",type:y?"open":"close"})},d=()=>{if(!r||!(0,Y.Nc)(r,Y.cF.LogsSample))return null;const y=i.map(v=>r.getSupplementaryQuery({type:Y.cF.LogsSample},v)).filter(v=>!!v);if(!y.length)return null;const m=()=>{l({queries:y,datasourceUid:r.uid}),(0,z.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:r?.type??"unknown",queriesCount:y.length})};return t.createElement(U.$n,{size:"sm",className:c.logSamplesButton,onClick:m},"Open logs in split view")};let p;if(o===void 0)p=null;else if(o.error!==void 0)p=t.createElement(Bt,{error:o.error,title:"Failed to load logs sample for this query"});else if(o.state===ce.Gu.Loading)p=t.createElement("span",null,"Logs sample is loading...");else if(o.data.length===0||o.data.every(y=>y.length===0))p=t.createElement("span",null,"No logs sample data.");else{const y=(0,zt.HT)(o.data);p=t.createElement(t.Fragment,null,t.createElement(d,null),t.createElement("div",{className:c.logContainer},t.createElement(On.k,{logRows:y.rows,dedupStrategy:K.fY.none,showLabels:ne.A.getBool(oe.$.showLabels,!1),showTime:ne.A.getBool(oe.$.showTime,!0),wrapLogMessage:ne.A.getBool(oe.$.wrapLogMessage,!0),prettifyLogMessage:ne.A.getBool(oe.$.prettifyLogMessage,!1),timeZone:n,enableLogDetails:!0})))}return o?.state!==ce.Gu.NotStarted?t.createElement(it.S,{label:t.createElement("div",null,"Logs sample",t.createElement(ge.m,{content:"Show log lines that contributed to visualized metrics"},t.createElement(le.I,{name:"info-circle",className:c.infoTooltip}))),isOpen:s,collapsible:!0,onToggle:g},p):null}const tr=e=>({logSamplesButton:(0,h.css)`
      position: absolute;
      top: ${e.spacing(1)};
      right: ${e.spacing(1)};
    `,logContainer:(0,h.css)`
      overflow: scroll;
    `,infoTooltip:(0,h.css)`
      margin-left: ${e.spacing(1)};
    `}),nr=()=>{const e=(0,N.of)(or);return t.createElement(t.Fragment,null,t.createElement(St._,{"data-testid":"explore-no-data",className:e.wrapper},t.createElement("span",{className:e.message},"No data")))},or=e=>({wrapper:(0,h.css)({label:"no-data-card",padding:e.spacing(3),background:e.colors.background.primary,borderRadius:e.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,h.css)({fontSize:e.typography.h2.fontSize,padding:e.spacing(4),color:e.colors.text.disabled})});var sr=u(76442);function ar(e){return(0,h.css)({maxWidth:`${e.breakpoints.values.lg}px`,marginTop:e.spacing(2),alignSelf:"center"})}const rr=()=>{const e=(0,N.of)(ar),o=Ft.TP.hasPermission(D.AccessControlAction.DataSourcesCreate)&&Ft.TP.hasPermission(D.AccessControlAction.DataSourcesWrite),n="Explore requires at least one data source. Once you have added a data source, you can query it here.",s=t.createElement(t.Fragment,null,t.createElement(le.I,{name:"rocket"}),t.createElement(t.Fragment,null," ProTip: You can also define data sources through configuration files. "),t.createElement("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link"},"Learn more")),a=t.createElement(U.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!o},"Add data source");return t.createElement(sr.c,{callToActionElement:a,className:e,footer:s,message:n})};var jt=u(52908),ir=u(95511),lr=u(94382);const cr=e=>({warningText:(0,h.css)`
    label: warningText;
    display: flex;
    align-items: center;
    font-size: ${e.typography.bodySmall.fontSize};
    color: ${e.colors.text.secondary};
  `});function dr(e){const{dataFrames:o,range:n,splitOpenFn:s,withTraceView:a,datasourceType:r}=e,i=(0,Ie.JQ)(n,s),l=(0,N.$j)(),c=(0,N.of)(cr),g=(0,vt.we)({fieldConfig:{defaults:{},overrides:[]},data:o,replaceVariables:R=>R,theme:l}),{nodes:d}=(0,lr.d)(g),[p,y]=(0,_t.A)(!0),m=()=>{y(),(0,z.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:r,grafana_version:V.$.buildInfo.version,isExpanded:!open})},{height:v}=(0,jt.A)(),b=(0,t.useRef)(null),[E,C]=(0,t.useState)(250);(0,t.useEffect)(()=>{if(b.current){const{top:R}=b.current.getBoundingClientRect();C(R)}},[b]);const f=v-E-32,x=a&&d[0]?.length>1e3?t.createElement("span",{className:c.warningText}," (",d[0].length," nodes, can be slow to load)"):null;return t.createElement(Se.NR,{title:"Node graph",titleItems:x,collapsible:!!a,collapsed:a?p:!1,onToggleCollapse:a?m:void 0},t.createElement("div",{ref:b,style:a?{height:500}:{minHeight:600,height:f}},t.createElement(ir.F,{dataFrames:g,getLinks:i})))}function ur(e,{exploreId:o}){return{range:e.explore.panes[o].range}}const pr=(0,me.connect)(ur,{})(dr);var Ke=u(1081),hr=u(21969),Zn=u(31193),gr=u(44932);const mr=e=>{const o=(0,J.qq)(e);return{getQueries:(0,Ke.Mz)(o,n=>n.queries),getQueryResponse:(0,Ke.Mz)(o,n=>n.queryResponse),getHistory:(0,Ke.Mz)(o,n=>n.history),getEventBridge:(0,Ke.Mz)(o,n=>n.eventBridge),getDatasourceInstanceSettings:(0,Ke.Mz)(o,n=>(0,Zn.tR)().getInstanceSettings(n.datasourceInstance?.uid))}},fr=({exploreId:e})=>{const o=(0,D.useDispatch)(),{getQueries:n,getDatasourceInstanceSettings:s,getQueryResponse:a,getHistory:r,getEventBridge:i}=(0,t.useMemo)(()=>mr(e),[e]),l=(0,D.useSelector)(n),c=(0,D.useSelector)(s),g=(0,D.useSelector)(a),d=(0,D.useSelector)(r),p=(0,D.useSelector)(i),y=(0,t.useCallback)(()=>{o((0,q.Od)({exploreId:e}))},[o,e]),m=(0,t.useCallback)(f=>{o((0,q.bO)({exploreId:e,queries:f}))},[o,e]),v=(0,t.useCallback)(f=>{m([...l,{...f,refId:(0,hr.W3)(l)}])},[m,l]),b=()=>{(0,z.rR)("grafana_explore_query_row_copy")},E=()=>{(0,z.rR)("grafana_explore_query_row_remove")},C=f=>{(0,z.rR)("grafana_query_row_toggle",f===void 0?{}:{queryEnabled:f})};return t.createElement(gr.L,{dsSettings:c,queries:l,onQueriesChange:m,onAddQuery:v,onRunQueries:y,onQueryCopied:b,onQueryRemoved:E,onQueryToggled:C,data:g,app:Ue.Jk.Explore,history:d,eventBus:p,queryRowWrapper:(f,x)=>t.createElement(he,{title:x,icon:"arrow",key:x,panelId:"Queries",customTopOffset:-10,level:"child"},f)})};var bt=u(72574),Ut=u(2913),yr=u(15054),vr=u(97222),br=u(9651),Er=u(9663),Yn=u(57408);const Ze={wrapper:(0,h.css)`
    height: 100%;
    overflow: scroll;
  `,switchWrapper:(0,h.css)`
    display: flex;
    flex-direction: row;
    margin-bottom: 0;
  `,switchLabel:(0,h.css)`
    margin-left: 15px;
    margin-bottom: 0;
  `,switch:(0,h.css)`
    margin-left: 10px;
  `,resultCount:(0,h.css)`
    margin-bottom: 4px;
  `,header:(0,h.css)`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 12px;
    line-height: 1.25;
  `},xr=480,Sr=2,Cr=e=>{const{tableResult:o}=e,n=(0,te.cloneDeep)(o),s=(0,t.useRef)(null),a=n.fields.filter(m=>m.name.includes("Value")),r=(0,Yn.E)(n),{width:i}=(0,jt.A)(),[l,c]=(0,t.useState)(i<=xr||a.length>Sr),g=()=>{c(!l);const m={isExpanded:!l};(0,z.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",m)};(0,t.useEffect)(()=>{s.current?.resetAfterIndex(0,!0)},[l]);const d=m=>{if(m<10){let E=0;for(let C=0;C<m;C++)E+=p(C,!0);return Math.min(600,E)}return 600},p=(m,v)=>{if(!v)return 32;const C=r[m];return 1.5*32+(Object.keys(C).length-a.length)*22},y=`isExpandedView ${(0,t.useId)()}`;return t.createElement("section",null,t.createElement("header",{className:Ze.header},t.createElement(xe.D,{className:Ze.switchWrapper,label:"Expand results",htmlFor:"isExpandedView"},t.createElement("div",{className:Ze.switch},t.createElement(Fe.d,{onChange:g,id:y,value:l,label:"Expand results"}))),t.createElement("div",{className:Ze.resultCount},"Result series: ",r.length)),t.createElement("div",{role:"table"},t.createElement(t.Fragment,null,a.length>1&&!l&&t.createElement(br.d,{valueLabels:a,expanded:l}),t.createElement(vr._m,{ref:s,itemCount:r.length,className:Ze.wrapper,itemSize:m=>p(m,l),height:d(r.length),width:"100%"},({index:m,style:v})=>{let b;return l&&(b=a.filter(E=>{const C=r[m][E.name];return C&&C!==Yn.M})),t.createElement("div",{role:"row",style:{...v,overflow:"hidden"}},t.createElement(Er.Ay,{isExpandedView:l,valueLabels:b,totalNumberOfValues:a.length,listKey:r[m].__name__,listItemData:r[m]}))}))))};function Rr(e,{exploreId:o}){const s=e.explore.panes[o],{tableResult:a,rawPrometheusResult:r,range:i,queryResponse:l}=s,c=r?[r]:[],g=(a?.length??0)>0&&r?a:c;return{loading:l.state,tableResult:g,range:i}}const wr=(0,me.connect)(Rr,{});class Tr extends t.PureComponent{constructor(o){super(o),this.onChangeResultsStyle=n=>{this.setState({resultsStyle:n})},this.renderLabel=()=>{const n=(0,h.css)({display:"flex",justifyContent:"space-between",flex:"1"}),s=It.jH.map(a=>({value:a,label:a[0].toUpperCase()+a.slice(1).replace(/_/," ")}));return t.createElement("div",{className:n},t.createElement(ft.z,{onClick:()=>{const a={state:this.state.resultsStyle===D.TABLE_RESULTS_STYLE.table?D.TABLE_RESULTS_STYLE.raw:D.TABLE_RESULTS_STYLE.table};(0,z.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",a)},size:"sm",options:s,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle}))},o.showRawPrometheus&&(this.state={resultsStyle:D.TABLE_RESULTS_STYLE.raw})}getTableHeight(){const{tableResult:o}=this.props;return!o||o.length===0?200:Math.max(Math.min(600,o[0].length*35)+35)}render(){const{loading:o,onCellFilterAdded:n,tableResult:s,width:a,splitOpenFn:r,range:i,ariaLabel:l,timeZone:c}=this.props,g=this.getTableHeight(),d=a-Ut.config.theme.panelPadding*2-yr.IZ;let p=s;const y=(0,Ie.YV)(r,i);p?.length&&(p=(0,vt.we)({data:p,timeZone:c,theme:Ut.config.theme2,replaceVariables:(0,bt.w)().replace.bind((0,bt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:y}));const m=p?.filter(C=>!!C&&C.length!==0),v=this.state.resultsStyle===D.TABLE_RESULTS_STYLE.raw?"Raw":"Table",b=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",E=!this.state?.resultsStyle||this.state?.resultsStyle===D.TABLE_RESULTS_STYLE.table;return t.createElement(Se.NR,{title:v,actions:b,loadingState:o},m?.length&&t.createElement(t.Fragment,null,E&&t.createElement(Mt.X,{ariaLabel:l,data:m[0],width:d,height:g,onCellFilterAdded:n}),this.state?.resultsStyle===D.TABLE_RESULTS_STYLE.raw&&t.createElement(Cr,{tableResult:m[0]})),!m?.length&&t.createElement(Ht,{metaItems:[{value:"0 series returned"}]}))}}const Lr=wr(Tr);var Ir=u(22669);const Fr=e=>{const o={transition:`opacity ${e.duration}ms linear`,opacity:0},n={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return t.createElement(Ir.Ay,{in:e.in,timeout:e.duration,unmountOnExit:e.unmountOnExit||!1,onExited:e.onExited},s=>t.createElement("div",{style:{...o,...n[s]}},e.children))},Or=e=>{const{queryError:o}=e,n=!!o,s=n?100:10,a=o?"Query error":"Unknown error",r=o?.message||o?.data?.message||null;return t.createElement(Fr,{in:n,duration:s},t.createElement(Ve.F,{severity:"error",title:a,topSpacing:2},r))};function Dr(e){const o=(0,D.useSelector)(s=>s.explore.panes[e.exploreId].queryResponse),n=o?.state===ce.Gu.Error?o?.error:void 0;return n?.refId?null:t.createElement(Or,{queryError:n})}var ve=u(72433),se=u(81523),Ar=u(47097),Jn=u(67647),Oe=u(3591),Nr=u(21744),zr=u(39558),Gt=u(82467),qt=u(3169),De=u(28444);function Hr(e,{exploreId:o}){const n=e.explore,{datasourceInstance:s}=n.panes[o];return{exploreId:o,datasourceInstance:s}}const Mr={changeDatasource:Ne.wh,deleteHistoryItem:ve.VM,commentHistoryItem:ve.H9,starHistoryItem:ve.sh,setQueries:q.Rk},Pr=(0,me.connect)(Hr,Mr),kr=e=>{const o="240px",n="170px",s=e.colors.background.secondary;return{queryCard:(0,h.css)`
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid ${e.colors.border.weak};
      margin: ${e.spacing(1)} 0;
      background-color: ${s};
      border-radius: ${e.shape.radius.default};
      .starred {
        color: ${e.v1.palette.orange};
      }
    `,cardRow:(0,h.css)`
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: ${e.spacing(1)};
      border-bottom: none;
      :first-of-type {
        border-bottom: 1px solid ${e.colors.border.weak};
        padding: ${e.spacing(.5,1)};
      }
      img {
        height: ${e.typography.fontSize}px;
        max-width: ${e.typography.fontSize}px;
        margin-right: ${e.spacing(1)};
      }
    `,queryActionButtons:(0,h.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      font-size: ${e.typography.size.base};
      button {
        margin-left: ${e.spacing(1)};
      }
    `,queryContainer:(0,h.css)`
      font-weight: ${e.typography.fontWeightMedium};
      width: calc(100% - ${o});
    `,updateCommentContainer:(0,h.css)`
      width: calc(100% + ${o});
      margin-top: ${e.spacing(1)};
    `,comment:(0,h.css)`
      overflow-wrap: break-word;
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-top: ${e.spacing(.5)};
    `,commentButtonRow:(0,h.css)`
      > * {
        margin-top: ${e.spacing(1)};
        margin-right: ${e.spacing(1)};
      }
    `,textArea:(0,h.css)`
      width: 100%;
    `,runButton:(0,h.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      button {
        height: auto;
        padding: ${e.spacing(.5,2)};
        line-height: 1.4;
        span {
          white-space: normal !important;
        }
      }
    `,loader:(0,h.css)`
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: ${e.colors.background.secondary};
    `}};function $r(e){const{queryHistoryItem:o,commentHistoryItem:n,starHistoryItem:s,deleteHistoryItem:a,changeDatasource:r,exploreId:i,datasourceInstance:l,setQueries:c}=e,[g,d]=(0,t.useState)(!1),[p,y]=(0,t.useState)(o.comment),{value:m,loading:v}=(0,sn.A)(async()=>{let w;try{w=await(0,He.l)().get(o.datasourceUid)}catch{}return{datasourceInstance:w,queries:await Promise.all(o.queries.map(async H=>{let Z;if(w?.meta.mixed)try{Z=await(0,He.l)().get(H.datasource)}catch{}else Z=w;return{query:H,datasource:Z}}))}},[o.datasourceUid,o.queries]),b=(0,N.of)(kr),E=async()=>{const w=o.queries,H=o.datasourceUid!==l?.uid;H&&await r({exploreId:i,datasource:o.datasourceUid}),c(i,w),(0,z.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:V.$.queryHistoryEnabled,differentDataSource:H})},C=async()=>{const w=[...o.queries.map(Z=>Z.datasource?.type||"unknown")];if((0,z.rR)("grafana_explore_query_history_copy_query",{datasources:w,mixed:!!m?.datasourceInstance?.meta.mixed}),v||!m)return;const H=m.queries.map(Z=>(0,se.Ax)(Z.query,Z.datasource)).join(`
`);(0,Be.uJ)(H),(0,Le.JD)((0,Gt.dx)((0,qt.tZ)((0,S.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},f=async()=>{const w=(0,se.U3)(o);await(0,Dt.V)(w)},x=()=>{const w=H=>{a(H),(0,Le.JD)((0,Gt.dx)((0,qt.tZ)((0,S.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,z.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:V.$.queryHistoryEnabled})};o.starred?(0,Oe.J7)().publish(new De.bY({title:(0,S.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,S.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,S.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>w(o.id)})):w(o.id)},R=()=>{s(o.id,!o.starred),(0,z.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:V.$.queryHistoryEnabled,newValue:!o.starred})},I=()=>d(!g),L=()=>{n(o.id,p),d(!1),(0,z.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:V.$.queryHistoryEnabled})},P=()=>{d(!1),y(o.comment)},O=w=>{w.key==="Enter"&&(w.shiftKey||w.ctrlKey)&&L(),w.key==="Escape"&&P()},k=t.createElement("div",{className:b.updateCommentContainer,"aria-label":p?(0,S.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,S.t)("explore.rich-history-card.add-comment-form","Add comment form")},t.createElement(Nr.f,{onKeyDown:O,value:p,placeholder:p?void 0:(0,S.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:w=>y(w.currentTarget.value),className:b.textArea}),t.createElement("div",{className:b.commentButtonRow},t.createElement(U.$n,{onClick:L},t.createElement(S.x6,{i18nKey:"explore.rich-history-card.save-comment"},"Save comment")),t.createElement(U.$n,{variant:"secondary",onClick:P},t.createElement(S.x6,{i18nKey:"explore.rich-history-card.cancel"},"Cancel")))),$=t.createElement("div",{className:b.queryActionButtons},t.createElement(Me.K,{name:"comment-alt",onClick:I,tooltip:o.comment?.length>0?(0,S.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,S.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),t.createElement(Me.K,{name:"copy",onClick:C,tooltip:(0,S.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),m?.datasourceInstance&&t.createElement(Me.K,{name:"share-alt",onClick:f,tooltip:t.createElement(S.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip"},"Copy shortened link to clipboard")}),t.createElement(Me.K,{name:"trash-alt",title:(0,S.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,S.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:x}),t.createElement(Me.K,{name:o.starred?"favorite":"star",iconType:o.starred?"mono":"default",onClick:R,tooltip:o.starred?(0,S.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,S.t)("explore.rich-history-card.star-query-tooltip","Star query")}));return t.createElement("div",{className:b.queryCard},t.createElement("div",{className:b.cardRow},t.createElement(Xn,{dsApi:m?.datasourceInstance,size:"sm"}),$),t.createElement("div",{className:(0,h.cx)(b.cardRow)},t.createElement("div",{className:b.queryContainer},m?.queries.map((w,H)=>t.createElement(Wr,{query:w,key:`${w}-${H}`,showDsInfo:m?.datasourceInstance?.meta.mixed})),!g&&o.comment&&t.createElement("div",{"aria-label":(0,S.t)("explore.rich-history-card.query-comment-label","Query comment"),className:b.comment},o.comment),g&&k),!g&&t.createElement("div",{className:b.runButton},t.createElement(U.$n,{variant:"secondary",onClick:E,disabled:!m?.datasourceInstance||m.queries.some(w=>!w.datasource)},l?.uid===o.datasourceUid?t.createElement(S.x6,{i18nKey:"explore.rich-history-card.run-query-button"},"Run query"):t.createElement(S.x6,{i18nKey:"explore.rich-history-card.switch-datasource-button"},"Switch data source and run query")))),v&&t.createElement(zr._,{text:(0,S.t)("explore.rich-history-card.loading-text","loading..."),className:b.loader}))}const Br=e=>({queryRow:(0,h.css)`
    border-top: 1px solid ${e.colors.border.weak};
    display: flex;
    flex-direction: row;
    padding: 4px 0px;
    gap: 4px;
    :first-child {
      border-top: none;
    }
  `,dsInfoContainer:(0,h.css)`
    display: flex;
    align-items: center;
  `,queryText:(0,h.css)`
    word-break: break-all;
  `}),Wr=({query:e,showDsInfo:o=!1})=>{const n=(0,N.of)(Br);return t.createElement("div",{className:n.queryRow},o&&t.createElement("div",{className:n.dsInfoContainer},t.createElement(Xn,{dsApi:e.datasource,size:"md"}),": "),t.createElement("span",{"aria-label":(0,S.t)("explore.rich-history-card.query-text-label","Query text"),className:n.queryText},(0,se.Ax)(e.query,e.datasource)))},Vr=e=>o=>(0,h.css)`
  display: flex;
  align-items: center;
  font-size: ${o.typography[e==="sm"?"bodySmall":"body"].fontSize};
  font-weight: ${o.typography.fontWeightMedium};
  white-space: nowrap;
`;function Xn({dsApi:e,size:o}){const n=(0,t.useCallback)(a=>Vr(o)(a),[o]),s=(0,N.of)(n);return t.createElement("div",{className:s},t.createElement("img",{src:e?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:e?.type||(0,S.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,S.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),t.createElement("div",{"aria-label":(0,S.t)("explore.rich-history-card.datasource-name-label","Data source name")},e?.name||(0,S.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")))}const _n=Pr($r),Qr=(e,o)=>({container:(0,h.css)`
      display: flex;
    `,labelSlider:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      &:last-of-type {
        margin-top: ${e.spacing(3)};
      }
      &:first-of-type {
        font-weight: ${e.typography.fontWeightMedium};
        margin-bottom: ${e.spacing(2)};
      }
    `,containerContent:(0,h.css)`
      /* 134px is based on the width of the Query history tabs bar, so the content is aligned to right side of the tab */
      width: calc(100% - 134px);
    `,containerSlider:(0,h.css)`
      width: 129px;
      margin-right: ${e.spacing(1)};
    `,fixedSlider:(0,h.css)`
      position: fixed;
    `,slider:(0,h.css)`
      bottom: 10px;
      height: ${o-180}px;
      width: 129px;
      padding: ${e.spacing(1)} 0;
    `,selectors:(0,h.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,filterInput:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `,multiselect:(0,h.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,h.css)`
      width: 170px;
    `,sessionName:(0,h.css)`
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: ${e.spacing(3)};
      h4 {
        margin: 0 10px 0 0;
      }
    `,heading:(0,h.css)`
      font-size: ${e.typography.h4.fontSize};
      margin: ${e.spacing(2,.25,1,.25)};
    `,footer:(0,h.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `,queries:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-left: ${e.spacing(.5)};
    `});function jr(e){const{queries:o,totalQueries:n,loading:s,richHistorySearchFilters:a,updateFilters:r,clearRichHistoryResults:i,loadMoreRichHistory:l,richHistorySettings:c,exploreId:g,height:d,activeDatasourceInstance:p}=e,y=(0,N.of)(Qr,d),m=(0,se.TR)();if((0,t.useEffect)(()=>{const f=!c.activeDatasourceOnly&&c.lastUsedDatasourceFilters?c.lastUsedDatasourceFilters:[p],x={search:"",sortOrder:se.xB.Descending,datasourceFilters:f,from:0,to:c.retentionPeriod,starred:!1};return r(x),()=>{i()}},[]),!a)return t.createElement("span",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.loading"},"Loading..."),";");const v=(0,se.x8)(o,a.sortOrder),b=to(),E=o.length&&o.length!==n,C=[a.from||0,a.to||c.retentionPeriod];return t.createElement("div",{className:y.container},t.createElement("div",{className:y.containerSlider},t.createElement("div",{className:y.fixedSlider},t.createElement("div",{className:y.labelSlider},t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history"},"Filter history")),t.createElement("div",{className:y.labelSlider},(0,se.IA)(C[0])),t.createElement("div",{className:y.slider},t.createElement(Ar.F,{tooltipAlwaysVisible:!1,min:0,max:c.retentionPeriod,value:C,orientation:"vertical",formatTooltipResult:se.IA,reverse:!0,onAfterChange:f=>{r({from:f[0],to:f[1]})}})),t.createElement("div",{className:y.labelSlider},(0,se.IA)(C[1])))),t.createElement("div",{className:y.containerContent,"data-testid":"query-history-queries-tab"},t.createElement("div",{className:y.selectors},!c.activeDatasourceOnly&&t.createElement(Re.KF,{className:y.multiselect,options:m.map(f=>({value:f.name,label:f.name})),value:a.datasourceFilters,placeholder:(0,S.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,S.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:f=>{r({datasourceFilters:f.map(x=>x.value)})}}),t.createElement("div",{className:y.filterInput},t.createElement(Jn.Z,{escapeRegex:!1,placeholder:(0,S.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:a.search,onChange:f=>r({search:f})})),t.createElement("div",{"aria-label":(0,S.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:y.sort},t.createElement(Re.l6,{value:b.filter(f=>f.value===a.sortOrder),options:b,placeholder:(0,S.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:f=>r({sortOrder:f.value})}))),s&&t.createElement("span",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results"},"Loading results...")),!s&&Object.keys(v).map(f=>t.createElement("div",{key:f},t.createElement("div",{className:y.heading},f," ",t.createElement("span",{className:y.queries},E?t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:v[f].length}}):t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:v[f].length}}))),v[f].map(x=>t.createElement(_n,{queryHistoryItem:x,key:x.id,exploreId:g})))),E?t.createElement("div",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:o.length,total:n},components:[t.createElement(U.$n,{onClick:l,key:"loadMoreButton"},"Load more")]})):null,t.createElement("div",{className:y.footer},V.$.queryHistoryEnabled?"":(0,S.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others."))))}var Ur=u(53919);const Gr=e=>({container:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
    `,spaceBetween:(0,h.css)`
      margin-bottom: ${e.spacing(3)};
    `,input:(0,h.css)`
      max-width: 200px;
    `,bold:(0,h.css)`
      font-weight: ${e.typography.fontWeightBold};
    `,bottomMargin:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `}),eo=[{value:2,label:(0,S.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,S.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,S.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,S.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}];function qr(e){const{retentionPeriod:o,starredTabAsFirstTab:n,activeDatasourceOnly:s,onChangeRetentionPeriod:a,toggleStarredTabAsFirstTab:r,toggleactiveDatasourceOnly:i,deleteRichHistory:l}=e,c=(0,N.of)(Gr),g=eo.find(p=>p.value===o),d=()=>{(0,Oe.J7)().publish(new De.bY({title:(0,S.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,S.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,S.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{l(),(0,Le.JD)((0,Gt.dx)((0,qt.tZ)((0,S.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return t.createElement("div",{className:c.container},(0,We.gQ)().changeRetention?t.createElement(xe.D,{label:(0,S.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,S.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:Ur.$H})},t.createElement("div",{className:c.input},t.createElement(Re.l6,{value:g,options:eo,onChange:a}))):t.createElement(Ve.F,{severity:"info",title:(0,S.t)("explore.rich-history-settings-tab.history-time-span","History time span")},(0,S.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:g?.label})),t.createElement(ye.I,{label:(0,S.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:c.spaceBetween},t.createElement(Fe.K,{id:"explore-query-history-settings-default-active-tab",value:n,onChange:r})),(0,We.gQ)().onlyActiveDataSource&&t.createElement(ye.I,{label:(0,S.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:c.spaceBetween},t.createElement(Fe.K,{id:"explore-query-history-settings-data-source-behavior",value:s,onChange:i})),(0,We.gQ)().clearHistory&&t.createElement("div",null,t.createElement("div",{className:c.bold},t.createElement(S.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history"},"Clear query history")),t.createElement("div",{className:c.bottomMargin},t.createElement(S.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info"},"Delete all of your query history, permanently.")),t.createElement(U.$n,{variant:"destructive",onClick:d},t.createElement(S.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button"},"Clear query history"))))}const Kr=e=>({container:(0,h.css)`
      display: flex;
    `,containerContent:(0,h.css)`
      width: 100%;
    `,selectors:(0,h.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,multiselect:(0,h.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,filterInput:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,h.css)`
      width: 170px;
    `,footer:(0,h.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `});function Zr(e){const{updateFilters:o,clearRichHistoryResults:n,loadMoreRichHistory:s,activeDatasourceInstance:a,richHistorySettings:r,queries:i,totalQueries:l,loading:c,richHistorySearchFilters:g,exploreId:d}=e,p=(0,N.of)(Kr),y=(0,se.TR)();if((0,t.useEffect)(()=>{const v=r.activeDatasourceOnly&&r.lastUsedDatasourceFilters?r.lastUsedDatasourceFilters:[a],b={search:"",sortOrder:se.xB.Descending,datasourceFilters:v,from:0,to:r.retentionPeriod,starred:!0};return o(b),()=>{n()}},[]),!g)return t.createElement("span",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-starred-tab.loading"},"Loading..."),";");const m=to();return t.createElement("div",{className:p.container},t.createElement("div",{className:p.containerContent},t.createElement("div",{className:p.selectors},!r.activeDatasourceOnly&&t.createElement(Re.KF,{className:p.multiselect,options:y.map(v=>({value:v.name,label:v.name})),value:g.datasourceFilters,placeholder:(0,S.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,S.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:v=>{o({datasourceFilters:v.map(b=>b.value)})}}),t.createElement("div",{className:p.filterInput},t.createElement(Jn.Z,{escapeRegex:!1,placeholder:(0,S.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:g.search,onChange:v=>o({search:v})})),t.createElement("div",{"aria-label":(0,S.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:p.sort},t.createElement(Re.l6,{value:m.filter(v=>v.value===g.sortOrder),options:m,placeholder:(0,S.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:v=>o({sortOrder:v.value})}))),c&&t.createElement("span",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results"},"Loading results...")),!c&&i.map(v=>t.createElement(_n,{queryHistoryItem:v,key:v.id,exploreId:d})),i.length&&i.length!==l?t.createElement("div",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:i.length,total:l},components:[t.createElement(U.$n,{onClick:s,key:"loadMoreButton"},"Load more")]})):null,t.createElement("div",{className:p.footer},V.$.queryHistoryEnabled?"":(0,S.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others."))))}var Kt=(e=>(e.RichHistory="Query history",e.Starred="Starred",e.Settings="Settings",e))(Kt||{});const to=()=>[{label:(0,S.t)("explore.rich-history.newest-first","Newest first"),value:se.xB.Descending},{label:(0,S.t)("explore.rich-history.oldest-first","Oldest first"),value:se.xB.Ascending},{label:(0,S.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:se.xB.DatasourceAZ},{label:(0,S.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:se.xB.DatasourceZA}].filter(e=>(0,We.gQ)().availableFilters.includes(e.value));function Yr(e){const{richHistory:o,richHistoryTotal:n,height:s,exploreId:a,deleteRichHistory:r,onClose:i,firstTab:l,activeDatasourceInstance:c}=e,[g,d]=(0,t.useState)(!1),p=I=>{e.updateHistorySettings({...e.richHistorySettings,...I})},y=I=>{const L={...e.richHistorySearchFilters,...I,page:1};e.updateHistorySearchFilters(e.exploreId,L),m()},m=(0,te.debounce)(()=>{e.loadRichHistory(e.exploreId),d(!0)},300),v=I=>{I.value!==void 0&&p({retentionPeriod:I.value})},b=()=>p({starredTabAsFirstTab:!e.richHistorySettings.starredTabAsFirstTab}),E=()=>p({activeDatasourceOnly:!e.richHistorySettings.activeDatasourceOnly});(0,t.useEffect)(()=>{d(!1)},[o]);const C={label:(0,S.t)("explore.rich-history.query-history","Query history"),value:"Query history",content:t.createElement(jr,{queries:o,totalQueries:n||0,loading:g,updateFilters:y,clearRichHistoryResults:()=>e.clearRichHistoryResults(e.exploreId),loadMoreRichHistory:()=>e.loadMoreRichHistory(e.exploreId),activeDatasourceInstance:c,richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters,exploreId:a,height:s}),icon:"history"},f={label:(0,S.t)("explore.rich-history.starred","Starred"),value:"Starred",content:t.createElement(Zr,{queries:o,totalQueries:n||0,loading:g,activeDatasourceInstance:c,updateFilters:y,clearRichHistoryResults:()=>e.clearRichHistoryResults(e.exploreId),loadMoreRichHistory:()=>e.loadMoreRichHistory(e.exploreId),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters,exploreId:a}),icon:"star"},x={label:(0,S.t)("explore.rich-history.settings","Settings"),value:"Settings",content:t.createElement(qr,{retentionPeriod:e.richHistorySettings.retentionPeriod,starredTabAsFirstTab:e.richHistorySettings.starredTabAsFirstTab,activeDatasourceOnly:e.richHistorySettings.activeDatasourceOnly,onChangeRetentionPeriod:v,toggleStarredTabAsFirstTab:b,toggleactiveDatasourceOnly:E,deleteRichHistory:r}),icon:"sliders-v-alt"};let R=[C,f,x];return t.createElement(rn.q,{tabs:R,onClose:i,defaultTab:l,closeIconTooltip:(0,S.t)("explore.rich-history.close-tooltip","Close query history")})}function Jr(e,{exploreId:o}){const n=e.explore,s=n.panes[o],a=s.richHistorySearchFilters,r=n.richHistorySettings,{datasourceInstance:i}=s,l=r?.starredTabAsFirstTab?Kt.Starred:Kt.RichHistory,{richHistory:c,richHistoryTotal:g}=s;return{richHistory:c,richHistoryTotal:g,firstTab:l,activeDatasourceInstance:i.name,richHistorySettings:r,richHistorySearchFilters:a}}const Xr={initRichHistory:ve.PA,loadRichHistory:ve.jX,loadMoreRichHistory:ve.Uu,clearRichHistoryResults:ve.wk,updateHistorySettings:ve.fP,updateHistorySearchFilters:ve.Bj,deleteRichHistory:ve.s1},_r=(0,me.connect)(Jr,Xr);function ei(e){const o=(0,N.$j)(),[n,s]=(0,t.useState)(o.components.horizontalDrawer.defaultHeight),{richHistory:a,richHistoryTotal:r,width:i,firstTab:l,activeDatasourceInstance:c,exploreId:g,deleteRichHistory:d,initRichHistory:p,loadRichHistory:y,loadMoreRichHistory:m,clearRichHistoryResults:v,richHistorySettings:b,updateHistorySettings:E,richHistorySearchFilters:C,updateHistorySearchFilters:f,onClose:x}=e;return(0,t.useEffect)(()=>{p(),(0,z.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:V.$.queryHistoryEnabled})},[p]),b?t.createElement(gn,{width:i,onResize:(R,I,L)=>{s(Number(L.style.height.slice(0,-2)))}},t.createElement(Yr,{richHistory:a,richHistoryTotal:r,firstTab:l,activeDatasourceInstance:c,exploreId:g,onClose:x,height:n,deleteRichHistory:d,richHistorySettings:b,richHistorySearchFilters:C,updateHistorySettings:E,updateHistorySearchFilters:f,loadRichHistory:y,loadMoreRichHistory:m,clearRichHistoryResults:v})):t.createElement("span",null,t.createElement(S.x6,{i18nKey:"explore.rich-history-container.loading"},"Loading..."))}const ti=_r(ei);var ni=u(13390);const oi=e=>({containerMargin:(0,h.css)({display:"flex",flexWrap:"wrap",gap:e.spacing(1),marginTop:e.spacing(2)})});function si(e){const o=(0,N.$j)(),n=oi(o);return t.createElement("div",{className:n.containerMargin},!e.addQueryRowButtonHidden&&t.createElement(ae.I,{variant:"canvas","aria-label":(0,S.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:e.onClickAddQueryRowButton,disabled:e.addQueryRowButtonDisabled,icon:"plus"},t.createElement(S.x6,{i18nKey:"explore.secondary-actions.query-add-button"},"Add query")),!e.richHistoryRowButtonHidden&&t.createElement(ae.I,{variant:e.richHistoryButtonActive?"active":"canvas","aria-label":(0,S.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:e.onClickRichHistoryButton,"data-testid":ni.X.QueryTab.queryHistoryButton,icon:"history"},t.createElement(S.x6,{i18nKey:"explore.secondary-actions.query-history-button"},"Query history")),t.createElement(ae.I,{variant:e.queryInspectorButtonActive?"active":"canvas","aria-label":(0,S.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:e.onClickQueryInspectorButton,icon:"info-circle"},t.createElement(S.x6,{i18nKey:"explore.secondary-actions.query-inspector-button"},"Query inspector")))}var no=u(65885);function ai(e,{exploreId:o}){const s=e.explore.panes[o],{tableResult:a,range:r}=s,i=(0,q.h1)(o);return{loading:a&&a.length>0?!1:i,tableResult:a,range:r}}const ri=(0,me.connect)(ai,{});class oo extends t.PureComponent{constructor(){super(...arguments),this.hasSubFrames=o=>o.fields.some(n=>n.type===qe.PU.nestedFrames)}getTableHeight(o,n){return o===0?200:Math.min(600,Math.max(o*36,n?300:0)+40+46)}getTableTitle(o,n,s){let a=n.name;return!a&&(o?.length??0)>1&&(a=n.refId||`${s}`),a?(0,S.t)("explore.table.title-with-name","Table - {{name}}",{name:a,interpolation:{escapeValue:!1}}):(0,S.t)("explore.table.title","Table")}render(){const{loading:o,onCellFilterAdded:n,tableResult:s,width:a,splitOpenFn:r,range:i,ariaLabel:l,timeZone:c,theme:g}=this.props;let d=(0,no.gy)(s)?(0,no.S5)(s):s;const p=(0,Ie.YV)(r,i);d?.length&&(d=(0,vt.we)({data:d,timeZone:c,theme:Ut.config.theme2,replaceVariables:(0,bt.w)().replace.bind((0,bt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:p}));const y=d?.filter(m=>!!m&&m.length!==0);return t.createElement(t.Fragment,null,y&&y.length===0&&t.createElement(Se.NR,{title:(0,S.t)("explore.table.title","Table"),width:a,height:200},()=>t.createElement(Ht,{metaItems:[{value:(0,S.t)("explore.table.no-data","0 series returned")}]})),y&&y.length>0&&t.createElement("div",{className:(0,h.css)({display:"flex",flexDirection:"column",gap:g.spacing(1)})},y.map((m,v)=>t.createElement(Se.NR,{key:m.refId||`table-${v}`,title:this.getTableTitle(d,m,v),width:a,height:this.getTableHeight(m.length,this.hasSubFrames(m)),loadingState:o?ce.Gu.Loading:void 0},(b,E)=>t.createElement(Mt.X,{ariaLabel:l,data:m,width:b,height:E,onCellFilterAdded:n})))))}}const Bi=(0,N.cV)(oo),ii=(0,N.cV)(ri(oo));var li=u(92599),ci=u(35090);function di(e){const o=e.dataFrames[0],{dataFrames:n,splitOpenFn:s,exploreId:a,scrollElement:r}=e,i=(0,t.useMemo)(()=>(0,ci.L)(o),[o]),l=(0,D.useSelector)(c=>c.explore.panes[e.exploreId]?.datasourceInstance??void 0);return i?t.createElement(Se.NR,{padding:"none",title:"Trace"},t.createElement(li.V,{exploreId:a,dataFrames:n,splitOpenFn:s,scrollElement:r,traceProp:i,datasource:l})):null}const ui=e=>({exploreMain:(0,h.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:e.spacing(1)}),queryContainer:(0,h.css)({label:"queryContainer",padding:e.spacing(1)}),exploreContainer:(0,h.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:e.spacing(2),marginBottom:e.spacing(2)}),wrapper:(0,h.css)({position:"absolute",top:0,left:e.spacing(2),right:0,bottom:0,display:"flex"})});var pi=(e=>(e[e.RichHistory=0]="RichHistory",e[e.QueryInspector=1]="QueryInspector",e))(pi||{});class hi extends t.PureComponent{constructor(o){super(o),this.memoizedGetNodeGraphDataFrames=(0,ze.A)(Eo.BR),this.onChangeTime=n=>{const{updateTimeRange:s,exploreId:a}=this.props;s({exploreId:a,rawRange:n})},this.onClickExample=n=>{this.props.setQueries(this.props.exploreId,[n])},this.onCellFilterAdded=n=>{const{value:s,key:a,operator:r}=n;r===ot.mc&&this.onClickFilterLabel(a,s),r===ot.Zi&&this.onClickFilterOutLabel(a,s)},this.onContentOutlineToogle=()=>{this.setState(n=>((0,z.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n.contentOutlineVisible?"close":"open"}),{contentOutlineVisible:!n.contentOutlineVisible}))},this.isFilterLabelActive=async(n,s,a)=>{const r=this.props.queries.find(l=>l.refId===a);if(!r)return!1;const i=await(0,He.l)().get(r.datasource);return!!((0,Y.FP)(i)&&i.queryHasFilter(r,{key:n,value:s.toString()}))},this.onClickFilterLabel=(n,s,a)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:n,value:s.toString()},frame:a},a?.refId)},this.onClickFilterOutLabel=(n,s,a)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:n,value:s.toString()},frame:a},a?.refId)},this.onClickFilterValue=(n,s)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:n.toString()}},s)},this.onClickFilterOutValue=(n,s)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:n.toString()}},s)},this.onClickAddQueryRowButton=()=>{const{exploreId:n,queryKeys:s}=this.props;this.props.addQueryRow(n,s.length)},this.onModifyQueries=(n,s)=>{const a=async(r,i)=>{if(s&&s!==r.refId)return r;const{datasource:l}=r;if(l==null)return r;const c=await(0,He.l)().get(l),g=["ADD_FILTER","ADD_FILTER_OUT"];return(0,Y.FP)(c)&&g.includes(i.type)?c.toggleQueryFilter(r,{type:i.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:i.options??{},frame:i.frame}):c.modifyQuery?c.modifyQuery(r,i):r};this.props.modifyQueries(this.props.exploreId,n,a)},this.onResize=n=>{this.props.changeSize(this.props.exploreId,n)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=n=>{const{exploreId:s,updateTimeRange:a}=this.props;a({exploreId:s,absoluteRange:n})},this.toggleShowRichHistory=()=>{this.setState(n=>({openDrawer:n.openDrawer===0?void 0:0}))},this.toggleShowQueryInspector=()=>{this.setState(n=>({openDrawer:n.openDrawer===1?void 0:1}))},this.onSplitOpen=n=>async s=>{if(this.props.splitOpen(s),s&&this.props.datasourceInstance){const a=(await(0,He.l)().get(s.datasourceUid)).type,r=this.props.datasourceInstance.uid===et.uv?(0,te.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,i={origin:"panel",panelType:n,source:r,target:a,exploreId:this.props.exploreId};(0,z.rR)("grafana_explore_split_view_opened",i)}},this.state={openDrawer:void 0,contentOutlineVisible:!1},this.graphEventBus=o.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=o.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(o){return t.createElement("div",{className:(0,h.cx)(o)},t.createElement(rr,null))}renderNoData(){return t.createElement(nr,null)}renderCustom(o){const{timeZone:n,queryResponse:s,absoluteRange:a,eventBus:r}=this.props,i=(0,te.groupBy)(s?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(i).map(([l,c],g)=>t.createElement(he,{panelId:l,title:l,icon:"plug",key:g},t.createElement(Vo,{key:g,timeZone:n,pluginId:l,frames:c,state:s.state,absoluteRange:a,height:400,width:o,splitOpenFn:this.onSplitOpen(l),eventBus:r})))}renderGraphPanel(o){const{graphResult:n,absoluteRange:s,timeZone:a,queryResponse:r,showFlameGraph:i}=this.props;return t.createElement(he,{panelId:"Graph",title:"Graph",icon:"graph-bar"},t.createElement(Ps.y,{data:n,height:i?180:400,width:o,absoluteRange:s,timeZone:a,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus}))}renderTablePanel(o){const{exploreId:n,timeZone:s}=this.props;return t.createElement(he,{panelId:"Table",title:"Table",icon:"table"},t.createElement(ii,{ariaLabel:tt.Tp.pages.Explore.General.table,width:o,exploreId:n,onCellFilterAdded:this.onCellFilterAdded,timeZone:s,splitOpenFn:this.onSplitOpen("table")}))}renderRawPrometheus(o){const{exploreId:n,datasourceInstance:s,timeZone:a}=this.props;return t.createElement(he,{panelId:"Raw Prometheus",title:"Raw Prometheus",icon:"gf-prometheus"},t.createElement(Lr,{showRawPrometheus:!0,ariaLabel:tt.Tp.pages.Explore.General.table,width:o,exploreId:n,onCellFilterAdded:s?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:a,splitOpenFn:this.onSplitOpen("table")}))}renderLogsPanel(o){const{exploreId:n,syncedTimes:s,theme:a,queryResponse:r}=this.props,i=parseInt(a.spacing(2).slice(0,-2),10),l=(0,h.css)({display:"flex",flexDirection:"column",gap:a.spacing(1)});return t.createElement(he,{panelId:"Logs",title:"Logs",icon:"gf-logs",className:l},t.createElement(_a,{exploreId:n,loadingState:r.state,syncedTimes:s,width:o-i,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.onSplitOpen("logs"),scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterValue:this.onClickFilterValue,onClickFilterOutValue:this.onClickFilterOutValue}))}renderLogsSamplePanel(){const{logsSample:o,timeZone:n,setSupplementaryQueryEnabled:s,exploreId:a,datasourceInstance:r,queries:i}=this.props;return t.createElement(he,{panelId:"Logs Sample",title:"Logs Sample",icon:"gf-logs"},t.createElement(er,{queryResponse:o.data,timeZone:n,enabled:o.enabled,queries:i,datasourceInstance:r,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:l=>s(a,l,Y.cF.LogsSample)}))}renderNodeGraphPanel(){const{exploreId:o,showTrace:n,queryResponse:s,datasourceInstance:a}=this.props,r=a?a?.type:"unknown";return t.createElement(he,{panelId:"Node Graph",title:"Node Graph",icon:"code-branch"},t.createElement(pr,{dataFrames:this.memoizedGetNodeGraphDataFrames(s.series),exploreId:o,withTraceView:n,datasourceType:r,splitOpenFn:this.onSplitOpen("nodeGraph")}))}renderFlameGraphPanel(){const{queryResponse:o}=this.props;return t.createElement(he,{panelId:"Flame Graph",title:"Flame Graph",icon:"fire"},t.createElement(Hs,{dataFrames:o.flameGraphFrames}))}renderTraceViewPanel(){const{queryResponse:o,exploreId:n}=this.props,s=o.series.filter(a=>a.meta?.preferredVisualisationType==="trace");return s.length&&t.createElement(he,{panelId:"Traces",title:"Traces",icon:"file-alt"},t.createElement(di,{exploreId:n,dataFrames:s,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement}))}render(){const{datasourceInstance:o,exploreId:n,graphResult:s,queryResponse:a,isLive:r,theme:i,showMetrics:l,showTable:c,showRawPrometheus:g,showLogs:d,showTrace:p,showCustom:y,showNodeGraph:m,showFlameGraph:v,timeZone:b,showLogsSample:E,correlationEditorDetails:C,correlationEditorHelperData:f}=this.props,{openDrawer:x,contentOutlineVisible:R}=this.state,I=ui(i),L=a&&a.state!==ce.Gu.NotStarted,P=x===0,O=!(0,We.gQ)().queryHistoryAvailable,k=x===1,$=a.state===ce.Gu.Done&&[a.logsFrames,a.graphFrames,a.nodeGraphFrames,a.flameGraphFrames,a.tableFrames,a.rawPrometheusFrames,a.traceFrames,a.customFrames].every(B=>B.length===0);let w;const H=C?.editorMode;return!!(H||C?.correlationDirty)&&f!==void 0&&(w=t.createElement(Mo,{exploreId:n,correlations:f})),t.createElement(Ro,{refreshDependencies:this.props.queries},t.createElement(Ns,{exploreId:n,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:R}),t.createElement("div",{style:{position:"relative",height:"100%",paddingLeft:i.spacing(2)}},t.createElement("div",{className:I.wrapper},R&&t.createElement(Lo,{scroller:this.scrollElement,panelId:`content-outline-container-${n}`}),t.createElement(nt.E,{testId:tt.Tp.pages.Explore.General.scrollView,scrollRefCallback:B=>this.scrollElement=B||void 0,hideHorizontalTrack:!0},t.createElement("div",{className:I.exploreContainer},o?t.createElement(t.Fragment,null,t.createElement(he,{panelId:"Queries",title:"Queries",icon:"arrow",mergeSingleChild:!0},t.createElement(St._,{className:I.queryContainer},w,t.createElement(fr,{exploreId:n}),t.createElement(si,{addQueryRowButtonDisabled:r||H&&o.meta.mixed,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:O,richHistoryButtonActive:P,queryInspectorButtonActive:k,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickRichHistoryButton:this.toggleShowRichHistory,onClickQueryInspectorButton:this.toggleShowQueryInspector}),t.createElement(Dr,{exploreId:n}))),t.createElement(bo.Ay,{onResize:this.onResize,disableHeight:!0},({width:B})=>B===0?null:t.createElement("main",{className:(0,h.cx)(I.exploreMain),style:{width:B}},t.createElement(X.Xw,null,L&&t.createElement(t.Fragment,null,l&&s&&t.createElement(X.Xw,null,this.renderGraphPanel(B)),g&&t.createElement(X.Xw,null,this.renderRawPrometheus(B)),c&&t.createElement(X.Xw,null,this.renderTablePanel(B)),d&&t.createElement(X.Xw,null,this.renderLogsPanel(B)),m&&t.createElement(X.Xw,null,this.renderNodeGraphPanel()),v&&t.createElement(X.Xw,null,this.renderFlameGraphPanel()),p&&t.createElement(X.Xw,null,this.renderTraceViewPanel()),E&&t.createElement(X.Xw,null,this.renderLogsSamplePanel()),y&&t.createElement(X.Xw,null,this.renderCustom(B)),$&&t.createElement(X.Xw,null,this.renderNoData())),P&&t.createElement(ti,{width:B,exploreId:n,onClose:this.toggleShowRichHistory}),k&&t.createElement(cs,{exploreId:n,width:B,onClose:this.toggleShowQueryInspector,timeZone:b,isMixed:o.meta.mixed||!1}))))):this.renderEmptyState(I.exploreContainer))))))}}function gi(e,{exploreId:o}){const n=e.explore,{syncedTimes:s}=n,a=n.panes[o],r=(0,st.O)(e.user),{datasourceInstance:i,queryKeys:l,queries:c,isLive:g,graphResult:d,tableResult:p,logsResult:y,showLogs:m,showMetrics:v,showTable:b,showTrace:E,showCustom:C,absoluteRange:f,queryResponse:x,showNodeGraph:R,showFlameGraph:I,showRawPrometheus:L,supplementaryQueries:P,correlationEditorHelperData:O}=a,k=(0,q.h1)(o)(e),$=P[Y.cF.LogsSample],w=!!($.dataProvider!==void 0&&!y&&(d||p));return{datasourceInstance:i,queryKeys:l,queries:c,isLive:g,graphResult:d,logsResult:y??void 0,absoluteRange:f,queryResponse:x,syncedTimes:s,timeZone:r,showLogs:m,showMetrics:v,showTable:b,showTrace:E,showCustom:C,showNodeGraph:R,showRawPrometheus:L,showFlameGraph:I,splitted:(0,J.pF)(e),loading:k,logsSample:$,showLogsSample:w,correlationEditorHelperData:O,correlationEditorDetails:n.correlationEditorDetails}}const mi={changeSize:Ee.QZ,modifyQueries:q.PD,scanStart:q.GI,scanStopAction:q.q9,setQueries:q.Rk,updateTimeRange:ue.GH,addQueryRow:q._0,splitOpen:G.ve,setSupplementaryQueryEnabled:q.TO},fi=(0,me.connect)(gi,mi),yi=(0,N.cV)(fi(hi)),vi=(0,h.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function bi({exploreId:e}){Si(e);const o=(0,t.useRef)(new vo.o),n=(0,t.useRef)(null);return(0,t.useEffect)(()=>{const s=o.current;return()=>s.removeAllListeners()},[]),t.createElement(nt.E,{hideVerticalTrack:!0},t.createElement("div",{className:vi,ref:n,"data-testid":tt.Tp.pages.Explore.General.container},t.createElement(yi,{exploreId:e,eventBus:o.current})))}function Ei(e,o){return{pane:e.explore.panes[o.exploreId]}}const xi=(0,me.connect)(Ei)(bi);function Si(e){const o=(0,t.useMemo)(()=>(0,J.qq)(e),[e]),n=(0,t.useRef)();n.current=(0,D.useSelector)(o),(0,t.useEffect)(()=>()=>{(0,Be._u)(n.current?.querySubscription)},[])}var so=u(19361),ao=u(15961);function Ci(e){const o=(0,t.useRef)();o.current=(0,Jt.C)("explore");const n=(0,t.useRef)((0,Zn.tR)());(0,t.useEffect)(()=>{if(!e.panes||typeof e.panes!="string")return;let s;try{s=JSON.parse(e.panes)}catch{return}typeof s!="object"||s===null||Promise.allSettled(Object.values(s).map(a=>!a||typeof a!="object"||!(0,ao.C)("datasource",a)||!a.datasource||typeof a.datasource!="string"?Promise.reject():n.current.get(a.datasource))).then(a=>a.filter(ao.s).map(r=>r.value)).then(a=>{if(!o.current)return;const r=a.map(i=>i.name);if(r.length===0){u.g.document.title=`${o.current.main.text} - ${so.M.AppTitle}`;return}u.g.document.title=`${o.current.main.text} - ${r.join(" | ")} - ${so.M.AppTitle}`})},[e.panes])}function Ri(){const{keybindings:e}=(0,$e.Il)(),o=(0,D.useDispatch)();(0,t.useEffect)(()=>{e.setupTimeRangeBindings(!1);const n=[];return n.push((0,Oe.J7)().subscribe(De.Rh,()=>{o((0,ue.$_)())})),n.push((0,Oe.J7)().subscribe(De.Io,s=>{o((0,ue.Iy)(s.payload.direction))})),n.push((0,Oe.J7)().subscribe(De.U0,s=>{o((0,ue.ke)(s.payload.scale))})),n.push((0,Oe.J7)().subscribe(De.Bt,()=>{o((0,ue.Xk)())})),n.push((0,Oe.J7)().subscribe(De.VZ,()=>{o((0,ue.GA)())})),()=>{n.forEach(s=>s.unsubscribe())}},[o,e])}const wi=e=>{const o=(0,D.useDispatch)(),{width:n}=(0,jt.A)(),s=(0,D.useSelector)(J.K6),a=(0,D.useSelector)(J.pF),[r,i]=(0,t.useState)(.5),l=(0,D.useSelector)(d=>d.explore),c=d=>{const p=n/2,y=(0,te.inRange)(d,p-100,p+100);o(y?(0,G.nD)({largerExploreId:void 0}):(0,G.nD)({largerExploreId:d>p?s[1][0]:s[0][0]})),i(d/n)};let g=0;return a&&(!l.evenSplitPanes&&l.maxedExploreId?g=l.maxedExploreId===s[1][0]?n-e:e:l.evenSplitPanes?g=Math.floor(n/2):r!==void 0&&(g=n*r)),{updateSplitSize:c,widthCalc:g}};function Ti(){const{location:e}=(0,$e.Il)();(0,t.useEffect)(()=>{const o=e.getSearchObject();(o.from||o.to)&&e.partial({from:void 0,to:void 0},!0)},[e])}const Zt=200;function Li(e){const o=(0,N.of)(Ii),n=(0,N.$j)();Ti(),(0,Dn.s)(e.queryParams),Ci(e.queryParams);const{chrome:s}=(0,$e.Il)(),a=(0,Jt.C)("explore"),{updateSplitSize:r,widthCalc:i}=wi(Zt),l=(0,D.useSelector)(J.K6),c=(0,D.useSelector)(J.pF),g=(0,D.useSelector)(J.vC),d=V.$.featureToggles.correlations&&(g?.editorMode||!1);return(0,t.useEffect)(()=>{s.update({sectionNav:a})},[s,a]),Ri(),t.createElement("div",{className:(0,h.cx)(o.pageScrollbarWrapper,{[o.correlationsEditorIndicator]:d})},t.createElement(yo,null),d&&t.createElement(mo,{panes:l}),t.createElement(Ce.g,{splitOrientation:"vertical",paneSize:i,minSize:Zt,maxSize:Zt*-1,primary:"second",splitVisible:c,parentStyle:d?{height:`calc(100% - ${n.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:p=>p&&r(p)},l.map(([p])=>t.createElement(X.Xw,{key:p,style:"page"},t.createElement(xi,{exploreId:p})))))}const Ii=e=>({pageScrollbarWrapper:(0,h.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative"}),correlationsEditorIndicator:(0,h.css)({borderLeft:`4px solid ${e.colors.primary.main}`,borderRight:`4px solid ${e.colors.primary.main}`,borderBottom:`4px solid ${e.colors.primary.main}`,overflow:"scroll"})})},10940:(Yt,Ae,u)=>{u.d(Ae,{A:()=>V});var h=u(96540),t=function(N,X){var Ce=(0,h.useRef)(function(){});(0,h.useEffect)(function(){Ce.current=N}),(0,h.useEffect)(function(){if(X!==null){var $e=setInterval(function(){return Ce.current()},X||0);return function(){return clearInterval($e)}}},[X])};const V=t}}]);

//# sourceMappingURL=explore.c3a6326421dfc5ba6afb.js.map