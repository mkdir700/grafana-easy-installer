"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9040],{56694:(Xe,L,s)=>{s.r(L),s.d(L,{plugin:()=>Se});var $=s(40187),b=s(36224),F=s(32196),e=s(96540),N=s(40845);function M(){const t=(0,N.of)(k);return e.createElement("div",null,e.createElement("h2",null,"MSSQL cheat sheet"),"Time series:",e.createElement("ul",{className:t.ulPadding},e.createElement("li",null,"return column named time (in UTC), as a unix time stamp or any sql native date data type. You can use the macros below."),e.createElement("li",null,"any other columns returned will be the time point values.")),"Optional:",e.createElement("ul",{className:t.ulPadding},e.createElement("li",null,"return column named ",e.createElement("i",null,"metric")," to represent the series name."),e.createElement("li",null,"If multiple value columns are returned the metric column is used as prefix."),e.createElement("li",null,"If no column named metric is found the column name of the value column is used as series name")),e.createElement("p",null,"Resultsets of time series queries need to be sorted by time."),"Table:",e.createElement("ul",{className:t.ulPadding},e.createElement("li",null,"return any set of columns")),"Macros:",e.createElement("ul",{className:t.ulPadding},e.createElement("li",null,"$__time(column) -> column AS time"),e.createElement("li",null,"$__timeEpoch(column) -> DATEDIFF(second, '1970-01-01', column) AS time"),e.createElement("li",null,"$__timeFilter(column) -> column BETWEEN '2017-04-21T05:01:17Z' AND '2017-04-21T05:01:17Z'"),e.createElement("li",null,"$__unixEpochFilter(column) -> column >= 1492750877 AND column <= 1492750877"),e.createElement("li",null,"$__unixEpochNanoFilter(column) -> column >= 1494410783152415214 AND column <= 1494497183142514872"),e.createElement("li",null,"$__timeGroup(column, '5m'[, fillvalue]) -> CAST(ROUND(DATEDIFF(second, '1970-01-01', column)/300.0, 0) as bigint)*300 by setting fillvalue grafana will fill in missing values according to the interval fillvalue can be either a literal value, NULL or previous; previous will fill in the previous seen value or NULL if none has been seen yet"),e.createElement("li",null,"$__timeGroupAlias(column, '5m'[, fillvalue]) -> CAST(ROUND(DATEDIFF(second, '1970-01-01', column)/300.0, 0) as bigint)*300 AS [time]"),e.createElement("li",null,"$__unixEpochGroup(column,'5m') -> FLOOR(column/300)*300"),e.createElement("li",null,"$__unixEpochGroupAlias(column,'5m') -> FLOOR(column/300)*300 AS [time]")),e.createElement("p",null,"Example of group by and order by with $__timeGroup:"),e.createElement("pre",null,e.createElement("code",null,"SELECT $__timeGroup(date_time_col, '1h') AS time, sum(value) as value ",e.createElement("br",null),"FROM yourtable",e.createElement("br",null),"GROUP BY $__timeGroup(date_time_col, '1h')",e.createElement("br",null),"ORDER BY 1",e.createElement("br",null))),"Or build your own conditionals using these macros which just return the values:",e.createElement("ul",{className:t.ulPadding},e.createElement("li",null,"$__timeFrom() -> '2017-04-21T05:01:17Z'"),e.createElement("li",null,"$__timeTo() -> '2017-04-21T05:01:17Z'"),e.createElement("li",null,"$__unixEpochFrom() -> 1492750877"),e.createElement("li",null,"$__unixEpochTo() -> 1492750877"),e.createElement("li",null,"$__unixEpochNanoFrom() -> 1494410783152415214"),e.createElement("li",null,"$__unixEpochNanoTo() -> 1494497183142514872")))}function k(t){return{ulPadding:(0,F.css)({margin:t.spacing(1,0),paddingLeft:t.spacing(5)})}}var p=s(22391),W=s(68704),A=s(91062),P=s(29020),x=s(42418),U=s(50720),z=s(25994),c=s(88575),d=s(10354),T=s(88323),B=s(15292),K=s(9226),S=s(84167),j=s(17081),q=s(60188),O=s(2913),G=s(94701),w=s(32264),h=(t=>(t.sqlAuth="SQL Server Authentication",t.windowsAuth="Windows Authentication",t.azureAuth="Azure AD Authentication",t.kerberosRaw="Windows AD: Username + password",t.kerberosKeytab="Windows AD: Keytab",t.kerberosCredentialCache="Windows AD: Credential cache",t.kerberosCredentialCacheLookupFile="Windows AD: Credential cache file",t))(h||{}),y=(t=>(t.disable="disable",t.false="false",t.true="true",t))(y||{}),X=(t=>(t.Public="AzureCloud",t.None="",t))(X||{}),f=(t=>(t.MSI="msi",t.CLIENT_SECRET="clientsecret",t))(f||{}),Q=(t=>(t.Public="AzureCloud",t.None="",t))(Q||{});const J=[{value:"AzureCloud",label:"Azure"}];function Ie(t){switch(t.authType){case AzureAuthType.MSI:return!0;case AzureAuthType.CLIENT_SECRET:return!!(t.azureCloud&&t.tenantId&&t.clientId&&t.clientSecret)}}const H=(t,a)=>t?{authType:f.MSI}:{authType:f.CLIENT_SECRET,azureCloud:a},V=(t,a)=>{const n=Symbol("Concealed client secret");return t?n:typeof a=="string"&&a.length>0?a:void 0},Y=(t,a)=>{const n=t.jsonData?.azureCredentials,r=t.secureJsonFields?.azureClientSecret,l=t.secureJsonData?.azureClientSecret,i=!!a.azure?.managedIdentityEnabled,u=a.azure?.cloud||X.Public;if(!n)return H(i,u);switch(n.authType){case f.MSI:return i?{authType:f.MSI}:{authType:f.CLIENT_SECRET,azureCloud:u};case f.CLIENT_SECRET:return{authType:f.CLIENT_SECRET,azureCloud:n.azureCloud||u,tenantId:n.tenantId,clientId:n.clientId,clientSecret:V(r,l)}}},Z=(t,a,n)=>{const r=!!a.azure?.managedIdentityEnabled,l=a.azure?.cloud||X.Public;switch(n.authType){case f.MSI:if(!r)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return t={...t,jsonData:{...t.jsonData,azureCredentials:{authType:f.MSI}}},t;case f.CLIENT_SECRET:return t={...t,jsonData:{...t.jsonData,azureCredentials:{authType:f.CLIENT_SECRET,azureCloud:n.azureCloud||l,tenantId:n.tenantId,clientId:n.clientId}},secureJsonData:{...t.secureJsonData,azureClientSecret:typeof n.clientSecret=="string"&&n.clientSecret.length>0?n.clientSecret:void 0},secureJsonFields:{...t.secureJsonFields,azureClientSecret:typeof n.clientSecret=="symbol"}},t}};var _=s(55852);const R=[{value:f.MSI,label:"Managed Identity"},{value:f.CLIENT_SECRET,label:"App Registration"}],ee=t=>{const{managedIdentityEnabled:a,credentials:n,azureCloudOptions:r,onCredentialsChange:l,disabled:i}=t,u=o=>{if(l){const m={...n,authType:o.value||f.MSI};l(m)}},E=({property:o,value:m})=>{if(l&&n.authType==="clientsecret"){const D={...n,[o]:m};l(D)}};return e.createElement("div",null,a&&e.createElement(c.D,{label:"Authentication",description:"Choose the type of authentication to Azure services",htmlFor:"authentication-type"},e.createElement(T.l6,{width:20,value:R.find(o=>o.value===n.authType),options:R,onChange:u,disabled:i})),n.authType==="clientsecret"&&e.createElement(e.Fragment,null,r&&e.createElement(c.D,{label:"Azure Cloud",htmlFor:"azure-cloud-type",disabled:i},e.createElement(T.l6,{value:r.find(o=>o.value===n.azureCloud),options:r,onChange:o=>{const m=o.value||"";E({property:"azureCloud",value:m})},isDisabled:i,inputId:"azure-cloud-type","aria-label":"Azure Cloud",width:20})),e.createElement(c.D,{label:"Directory (tenant) ID",required:!0,htmlFor:"tenant-id",invalid:!n.tenantId,error:"Tenant ID is required"},e.createElement(d.p,{width:45,placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:n.tenantId||"",onChange:o=>{const m=o.target.value;E({property:"tenantId",value:m})},disabled:i,"aria-label":"Tenant ID"})),e.createElement(c.D,{label:"Application (client) ID",required:!0,htmlFor:"client-id",invalid:!n.clientId,error:"Client ID is required"},e.createElement(d.p,{width:45,placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:n.clientId||"",onChange:o=>{const m=o.target.value;E({property:"clientId",value:m})},disabled:i,"aria-label":"Client ID"})),!i&&(typeof n.clientSecret=="symbol"?e.createElement(c.D,{label:"Client Secret",htmlFor:"client-secret",required:!0},e.createElement("div",{className:"width-30",style:{display:"flex",gap:"4px"}},e.createElement(d.p,{"aria-label":"Client Secret",placeholder:"configured",disabled:!0,"data-testid":"client-secret",width:45}),e.createElement(_.$n,{variant:"secondary",type:"button",onClick:()=>{E({property:"clientSecret",value:""})},disabled:i},"Reset"))):e.createElement(c.D,{label:"Client Secret",required:!0,htmlFor:"client-secret",invalid:!n.clientSecret,error:"Client secret is required"},e.createElement(d.p,{width:45,"aria-label":"Client Secret",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:n.clientSecret||"",onChange:o=>{const m=o.target.value;E({property:"clientSecret",value:m})},id:"client-secret",disabled:i})))))},Le=null,te=t=>{const{dataSourceConfig:a,onChange:n}=t,r=w.$.azure.managedIdentityEnabled,l=(0,e.useMemo)(()=>Y(a,w.$),[a]),i=u=>{n(Z(a,w.$,u))};return(0,G.A)(()=>{a.jsonData.authType||i(l)}),e.createElement(ee,{managedIdentityEnabled:r,credentials:l,azureCloudOptions:J,onCredentialsChange:i,disabled:a.readOnly})},Fe=null,I=e.createElement("span",null,"Use the format ",e.createElement("code",null,"user@EXAMPLE.COM"),". Realm is derived from the username."),ae=t=>{const{options:a,onOptionsChange:n}=t,r=a.jsonData,l=40,i=r?.keytabFilePath,u=r?.credentialCache,E=r?.credentialCacheLookupFile,o=v=>{(0,p.lO)(t,"keytabFilePath",v.currentTarget.value)},m=v=>{(0,p.lO)(t,"credentialCache",v.currentTarget.value)},D=v=>{(0,p.lO)(t,"credentialCacheLookupFile",v.currentTarget.value)};return e.createElement(e.Fragment,null,r.authenticationType===h.kerberosKeytab&&e.createElement(S.n,{label:"Windows AD: Keytab"},e.createElement(c.D,{label:"Username",required:!0,invalid:!a.user,error:"Username is required",description:I},e.createElement(d.p,{value:a.user||"",placeholder:"name@EXAMPLE.COM",onChange:v=>n({...a,user:v.currentTarget.value}),width:l})),e.createElement(c.D,{label:"Keytab file path",required:!0,invalid:!i,error:"Keytab file path is required"},e.createElement(d.p,{placeholder:"/home/grot/grot.keytab",onChange:o,width:l,required:!0,value:i||""}))),r.authenticationType===h.kerberosCredentialCache&&e.createElement(S.n,{label:"Windows AD: Credential cache"},e.createElement(c.D,{label:"Credential cache path",required:!0,invalid:!u,error:"Credential cache path is required"},e.createElement(d.p,{placeholder:"/tmp/krb5cc_1000",onChange:m,width:l,value:u||"",required:!0}))),r.authenticationType===h.kerberosCredentialCacheLookupFile&&e.createElement(S.n,{label:"Windows AD: Credential cache file"},e.createElement(c.D,{label:"Username",required:!0,invalid:!a.user,error:"Username is required",description:I},e.createElement(d.p,{value:a.user||"",placeholder:"name@EXAMPLE.COM",onChange:v=>n({...a,user:v.currentTarget.value}),width:l})),e.createElement(c.D,{label:"Credential cache file path",required:!0,invalid:!E,error:"Credential cache file path is required"},e.createElement(d.p,{placeholder:"/home/grot/cache.json",onChange:D,width:l,value:E||"",required:!0}))))},ne=t=>{const{options:a}=t,n=a.jsonData,r=n?.configFilePath,l=40,i=o=>{(0,p.lO)(t,"UDPConnectionLimit",o)},u=o=>{(0,p.lO)(t,"enableDNSLookupKDC",o.currentTarget.value)},E=o=>{(0,p.lO)(t,"configFilePath",o.currentTarget.value)};return e.createElement(e.Fragment,null,e.createElement(P.I,{title:"Windows AD: Advanced Settings"},e.createElement(S.n,null,e.createElement(c.D,{label:"UDP Preference Limit",description:e.createElement("span",null,"The default is ",e.createElement("code",null,"1")," and means always use TCP and is optional.")},e.createElement(d.p,{type:"text",width:l,placeholder:"0",defaultValue:n.UDPConnectionLimit,onChange:o=>{const m=Number(o.currentTarget.value);Number.isNaN(m)||i(m)}})),e.createElement(c.D,{label:"DNS Lookup KDC",description:e.createElement("span",null,"Indicate whether DNS `SRV` records should be used to locate the KDCs and other servers for a realm. The default is ",e.createElement("code",null,"true"),".")},e.createElement(d.p,{type:"text",width:l,placeholder:"true",defaultValue:n.enableDNSLookupKDC,onChange:u})),e.createElement(c.D,{label:"krb5 config file path",description:e.createElement("span",null,"The path to the configuration file for the"," ",e.createElement("a",{href:"https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html"},"MIT krb5 package"),". The default is ",e.createElement("code",null,"/etc/krb5.conf"),".")},e.createElement(d.p,{onChange:E,width:l,required:!0,value:r||"/etc/krb5.conf"})))))},C=40,re=t=>{(0,b.nj)(t);const{options:a,onOptionsChange:n}=t,r=(0,N.of)(le),l=a.jsonData,i=O.config.azureAuthEnabled,u={azureAuthIsSupported:i,azureAuthSettingsUI:te},E=()=>{(0,p.QP)(t,"password")},o=g=>we=>{n({...a,[g]:we.currentTarget.value})},m=g=>{(0,p.lO)(t,"tlsSkipVerify",g.currentTarget.checked)},D=g=>{(0,p.lO)(t,"encrypt",g.value)},v=g=>{n({...a,jsonData:{...l,authenticationType:g.value,azureCredentials:void 0,keytabFilePath:void 0,credentialCache:void 0,credentialCacheLookupFile:void 0},secureJsonData:{...a.secureJsonData,password:""},secureJsonFields:{...a.secureJsonFields,password:!1},user:""})},De=g=>{(0,p.lO)(t,"connectionTimeout",g??0)},Ae=()=>{const g=[{value:h.sqlAuth,label:"SQL Server Authentication"},{value:h.windowsAuth,label:"Windows Authentication"},{value:h.kerberosRaw,label:"Windows AD: Username + password"},{value:h.kerberosKeytab,label:"Windows AD: Keytab file"},{value:h.kerberosCredentialCache,label:"Windows AD: Credential cache"},{value:h.kerberosCredentialCacheLookupFile,label:"Windows AD: Credential cache file"}];return i?[...g,{value:h.azureAuth,label:"Azure AD Authentication"}]:g},Te=[{value:y.disable,label:"disable"},{value:y.false,label:"false"},{value:y.true,label:"true"}];return e.createElement(e.Fragment,null,e.createElement(W.I,{dataSourceName:"Microsoft SQL Server",docsLink:"https://grafana.com/docs/grafana/latest/datasources/mssql/",hasRequiredFields:!0}),e.createElement(x.F,{title:"User Permission",severity:"info"},"The database user should only be granted SELECT permissions on the specified database and tables you want to query. Grafana does not validate that queries are safe so queries can contain any SQL statement. For example, statements like ",e.createElement("code",null,"USE otherdb;")," and ",e.createElement("code",null,"DROP TABLE user;")," would be executed. To protect against this we ",e.createElement("em",null,"highly")," recommend you create a specific MS SQL user with restricted permissions. Check out the"," ",e.createElement(U.N,{rel:"noreferrer",target:"_blank",href:"http://docs.grafana.org/features/datasources/mssql/"},"Microsoft SQL Server Data Source Docs")," ","for more information."),e.createElement(z.c,null),e.createElement(A.A,{title:"Connection"},e.createElement(c.D,{label:"Host",required:!0,invalid:!a.url,error:"Host is required"},e.createElement(d.p,{width:C,name:"host",type:"text",value:a.url||"",placeholder:"localhost:1433",onChange:o("url")})),e.createElement(c.D,{label:"Database",required:!0,invalid:!l.database,error:"Database is required"},e.createElement(d.p,{width:C,name:"database",value:l.database||"",placeholder:"database name",onChange:(0,p.PG)(t,"database")}))),e.createElement(A.A,{title:"TLS/SSL Auth"},e.createElement(c.D,{htmlFor:"encrypt",description:e.createElement(e.Fragment,null,"Determines whether or to which extent a secure SSL TCP/IP connection will be negotiated with the server.",e.createElement("ul",{className:r.ulPadding},e.createElement("li",null,e.createElement("i",null,"disable")," - Data sent between client and server is not encrypted."),e.createElement("li",null,e.createElement("i",null,"false")," - Data sent between client and server is not encrypted beyond the login packet. (default)"),e.createElement("li",null,e.createElement("i",null,"true")," - Data sent between client and server is encrypted.")),"If you're using an older version of Microsoft SQL Server like 2008 and 2008R2 you may need to disable encryption to be able to connect."),label:"Encrypt"},e.createElement(T.l6,{options:Te,value:l.encrypt||y.false,inputId:"encrypt",onChange:D,width:C})),l.encrypt===y.true?e.createElement(e.Fragment,null,e.createElement(c.D,{htmlFor:"skipTlsVerify",label:"Skip TLS Verify"},e.createElement(B.d,{id:"skipTlsVerify",onChange:m,value:l.tlsSkipVerify||!1})),l.tlsSkipVerify?null:e.createElement(e.Fragment,null,e.createElement(c.D,{description:e.createElement("span",null,"Path to file containing the public key certificate of the CA that signed the SQL Server certificate. Needed when the server certificate is self signed."),label:"TLS/SSL Root Certificate"},e.createElement(d.p,{value:l.sslRootCertFile||"",onChange:(0,p.PG)(t,"sslRootCertFile"),placeholder:"TLS/SSL root certificate file path",width:C})),e.createElement(c.D,{label:"Hostname in server certificate"},e.createElement(d.p,{placeholder:"Common Name (CN) in server certificate",value:l.serverName||"",onChange:(0,p.PG)(t,"serverName"),width:C})))):null),e.createElement(A.A,{title:"Authentication"},e.createElement(c.D,{label:"Authentication Type",htmlFor:"authenticationType",description:e.createElement("ul",{className:r.ulPadding},e.createElement("li",null,e.createElement("i",null,"SQL Server Authentication")," This is the default mechanism to connect to MS SQL Server. Enter the SQL Server Authentication login or the Windows Authentication login in the DOMAIN\\User format."),e.createElement("li",null,e.createElement("i",null,"Windows Authentication")," Windows Integrated Security - single sign on for users who are already logged onto Windows and have enabled this option for MS SQL Server."),i&&e.createElement("li",null,e.createElement("i",null,"Azure Authentication")," Securely authenticate and access Azure resources and applications using Azure AD credentials - Managed Service Identity and Client Secret Credentials are supported."),e.createElement("li",null,e.createElement("i",null,"Windows AD: Username + password")," Windows Active Directory - Sign on for domain user via username/password."),e.createElement("li",null,e.createElement("i",null,"Windows AD: Keytab")," Windows Active Directory - Sign on for domain user via keytab file."),e.createElement("li",null,e.createElement("i",null,"Windows AD: Credential cache")," Windows Active Directory - Sign on for domain user via credential cache."),e.createElement("li",null,e.createElement("i",null,"Windows AD: Credential cache file")," Windows Active Directory - Sign on for domain user via credential cache file."))},e.createElement(T.l6,{value:l.authenticationType||h.sqlAuth,inputId:"authenticationType",options:Ae(),onChange:v,width:C})),e.createElement(ae,{...t}),(l.authenticationType===h.sqlAuth||l.authenticationType===h.kerberosRaw||!l.authenticationType)&&e.createElement(e.Fragment,null,e.createElement(c.D,{label:"Username",required:!0,invalid:!a.user,error:"Username is required",description:l.authenticationType===h.kerberosRaw?I:""},e.createElement(d.p,{value:a.user||"",placeholder:l.authenticationType===h.kerberosRaw?"name@EXAMPLE.COM":"user",onChange:o("user"),width:C})),e.createElement(c.D,{label:"Password",required:!0,invalid:!a.secureJsonFields.password&&!a.secureJsonData?.password,error:"Password is required"},e.createElement(K.L4,{width:C,placeholder:"Password",isConfigured:a.secureJsonFields&&a.secureJsonFields.password,onReset:E,onChange:(0,p.mn)(t,"password"),required:!0}))),i&&l.authenticationType===h.azureAuth&&e.createElement(S.n,{label:"Azure Authentication Settings"},e.createElement(u.azureAuthSettingsUI,{dataSourceConfig:a,onChange:n}))),e.createElement(z.c,null),e.createElement(A.A,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source. This includes connection limits, connection timeout, group-by time interval, and Secure Socks Proxy.",isCollapsible:!0,isInitiallyOpen:!0},e.createElement(b.jN,{options:a,onOptionsChange:n}),e.createElement(P.I,{title:"Connection details"},e.createElement(c.D,{description:e.createElement("span",null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example",e.createElement("code",null,"1m")," if your data is written every minute."),label:"Min time interval"},e.createElement(d.p,{width:C,placeholder:"1m",value:l.timeInterval||"",onChange:(0,p.PG)(t,"timeInterval")})),e.createElement(c.D,{description:e.createElement("span",null,"The number of seconds to wait before canceling the request when connecting to the database. The default is ",e.createElement("code",null,"0"),", meaning no timeout."),label:"Connection timeout"},e.createElement(q.Q,{width:C,placeholder:"60",min:0,value:l.connectionTimeout,onChange:De}))),O.config.secureSocksDSProxyEnabled&&e.createElement(j.Y,{options:a,onOptionsChange:n}),e.createElement(ne,{...t})))};function le(t){return{ulPadding:(0,F.css)({margin:t.spacing(1,0),paddingLeft:t.spacing(5)})}}function ie(){return"SELECT name FROM sys.databases WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb');"}function oe(t){return`SELECT TABLE_SCHEMA + '.' + TABLE_NAME as schemaAndName
    FROM [${t}].INFORMATION_SCHEMA.TABLES`}function se(t,a){return`
   USE ${t}
   SELECT COLUMN_NAME as 'column',DATA_TYPE as 'type'
   FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='${a}';`}class ce{constructor(a,n,r){this.target=(0,b.To)(a||{refId:"A"}),this.templateSrv=n,this.scopedVars=r}quoteLiteral(a){return"'"+a.replace(/'/g,"''")+"'"}}var ue=s(33125),de=s(98765);const me=({getColumns:t,getTables:a})=>(n,r)=>({...r&&(0,ue.N)(n,r),tables:{resolve:async l=>await a.current(l?.table),parseName:l=>{if(!l)return{table:""};let i=l,u=i.value;for(;i.next&&i.next.type!==de.ks.Whitespace;)u+=i.next.value,i=i.next;return i.value.endsWith(".")&&(u=i.value.slice(0,i.value.length-1)),{table:u}}},columns:{resolve:async l=>{if(!l?.table)return[];const[i,u,E]=l.table.split(".");return await t.current({table:`${u}.${E}`,dataset:i,refId:"A"})}}});async function he(t,a){const n=await t.fields(a);return n.length>0?n.map(r=>({name:r.value,type:r.value,description:r.value})):[]}async function Ee(t,a){return await t.lookup?.(a)||[]}var pe=s(2543);function fe(t){switch(t){case"datetimeoffset":case"date":case"datetime2":case"smalldatetime":case"datetime":case"time":return"clock-nine";case"bit":return"toggle-off";case"tinyint":case"smallint":case"int":case"bigint":case"decimal":case"numeric":case"real":case"float":case"money":case"smallmoney":return"calculator-alt";case"char":case"varchar":case"text":case"nchar":case"nvarchar":case"ntext":case"binary":case"varbinary":case"image":return"text";default:return}}function ge(t){switch(t){case"datetimeoffset":case"datetime2":case"smalldatetime":case"datetime":return"datetime";case"time":return"time";case"date":return"date";case"bit":return"boolean";case"tinyint":case"smallint":case"int":case"bigint":case"decimal":case"numeric":case"real":case"float":case"money":case"smallmoney":return"number";case"char":case"varchar":case"text":case"nchar":case"nvarchar":case"ntext":case"binary":case"varbinary":case"image":return"text";default:return"text"}}function ve({sql:t,dataset:a,table:n}){let r="";if(!t||!(0,b.YW)(t.columns))return r;if(r+=Ce(t.columns,t.limit),a&&n&&(r+=`FROM ${a}.${n} `),t.whereString&&(r+=`WHERE ${t.whereString} `),t.groupBy?.[0]?.property.name){const l=t.groupBy.map(i=>i.property.name).filter(i=>!(0,pe.isEmpty)(i));r+=`GROUP BY ${l.join(", ")} `}return t.orderBy?.property.name&&(r+=`ORDER BY ${t.orderBy.property.name} `),t.orderBy?.property.name&&t.orderByDirection&&(r+=`${t.orderByDirection} `),r}function Ce(t,a){const n=t.map(r=>{let l="";return r.name&&r.alias?l+=`${r.name}(${r.parameters?.map(i=>`${i.name}`)}) AS ${r.alias}`:r.name?l+=`${r.name}(${r.parameters?.map(i=>`${i.name}`)})`:r.alias?l+=`${r.parameters?.map(i=>`${i.name}`)} AS ${r.alias}`:l+=`${r.parameters?.map(i=>`${i.name}`)}`,l});return`SELECT ${be(a)?"TOP("+a+")":""} ${n.join(", ")} `}const be=t=>t!==void 0&&t>=0;class ye extends b.oK{constructor(a){super(a),this.sqlLanguageDefinition=void 0}getQueryModel(a,n,r){return new ce(a,n,r)}async fetchDatasets(){return(await this.runSql(ie(),{refId:"datasets"})).fields.name?.values.flat()??[]}async fetchTables(a){return(await this.runSql(oe(a),{refId:"tables"})).fields.schemaAndName?.values.flat()??[]}async fetchFields(a){if(!a.table)return[];const[n,r]=a.table.split("."),l=await this.runSql(se(a.dataset,r),{refId:"columns"}),i=[];for(let u=0;u<l.length;u++){const E=l.fields.column.values[u],o=l.fields.type.values[u];i.push({label:E,value:E,type:o,icon:fe(o),raqbFieldType:ge(o)})}return i}getSqlLanguageDefinition(a){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const n={getColumns:{current:r=>he(a,r)},getTables:{current:r=>Ee(a,r)}};return this.sqlLanguageDefinition={id:"sql",completionProvider:me(n),formatter:b.se},this.sqlLanguageDefinition}getDB(){return this.db!==void 0?this.db:{init:()=>Promise.resolve(!0),datasets:()=>this.fetchDatasets(),tables:a=>this.fetchTables(a),getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition(this.db),fields:async a=>!a?.dataset||!a?.table?[]:this.fetchFields(a),validateQuery:a=>Promise.resolve({isError:!1,isValid:!0,query:a,error:"",rawSql:a.rawSql}),dsID:()=>this.id,dispose:a=>{},toRawSql:ve,lookup:async a=>{if(a){const n=a.split(".").filter(r=>r);return n.length>2?[]:n.length===1?(await this.fetchTables(n[0])).map(l=>({name:l,completion:l})):[]}else return(await this.fetchDatasets()).map(r=>({name:r,completion:`${r}.`}))}}}}const Se=new $.tD(ye).setQueryEditor(b.e_).setQueryEditorHelp(M).setConfigEditor(re)}}]);

//# sourceMappingURL=mssqlPlugin.801882102ec33aa3c7c3.js.map