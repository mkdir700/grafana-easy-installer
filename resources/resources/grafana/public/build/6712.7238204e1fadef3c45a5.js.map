{"version":3,"file":"6712.7238204e1fadef3c45a5.js","mappings":"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SAAU,iCACV,YAAa,4EACf,EACA,CACE,SAAU,2BACV,YAAa,uDACf,EACA,CACE,SAAU,oCACV,YAAa,0FACf,EACA,CACE,SAAU,wBACV,YAAa,8DACf,EACA,CACE,SAAU,mCACV,YACE,kIACJ,EACA,CACE,SAAU,2CACV,YAAa,kEACf,EACA,CACE,SAAU,wDACV,YAAa,iDACf,EACA,CACE,SAAU,8CACV,YAAa,qEACf,EACA,CACE,SAAU,4BACV,YAAa,mEACf,EACA,CACE,SAAU,4BACV,YAAa,8EACf,EACA,CACE,SAAU,qCACV,YAAa,iDACf,CACF,EAEaC,GAAqC,CAChD,CACE,SAAU,2DACV,YACE,4KACJ,EACA,CACE,SAAU,gDACV,YAAa,6DACf,EACA,CACE,SAAU,2DACV,YAAa,6FACf,EACA,CACE,SAAU,oCACV,YAAa,6BACf,CACF,EAEaC,GAAiC,CAC5C,CACE,SAAU,yBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,4DACf,EACA,CACE,SAAU,0BACV,YAAa,kGACf,EACA,CACE,SAAU,kBACV,YAAa,uDACf,EACA,CACE,SAAU,kBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,sFACf,EACA,CACE,SAAU,kBACV,YAAa,yCACf,EACA,CACE,SAAU,mBACV,YAAa,4CACf,EACA,CACE,SAAU,gCACV,YAAa,yCACf,EACA,CACE,SAAU,gCACV,YAAa,uDACf,EACA,CACE,SAAU,qCACV,YAAa,oDACf,EACA,CACE,SAAU,wBACV,YAAa,6FACf,EACA,CACE,SAAU,4CACV,YACE,+GACJ,EACA,CACE,SAAU,gCACV,YAAa,uEACf,EACA,CACE,SAAU,kBACV,YAAa,qCACf,EACA,CACE,SAAU,kBACV,YAAa,kDACf,EACA,CACE,SAAU,2CACV,YAAa,oDACf,EACA,CACE,SAAU,sBACV,YAAa,yDACf,EACA,CACE,SAAU,yBACV,YAAa,+DACf,EACA,CACE,SAAU,kCACV,YAAa,sEACf,EACA,CACE,SAAU,qCACV,YAAa,8CACf,EACA,CACE,SAAU,mCACV,Y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V,YAAa,uEACf,EACA,CACE,SAAU,8CACV,YAAa,uFACf,EACA,CACE,SAAU,0BACV,YAAa,iDACf,EACA,CACE,SAAU,kBACV,YAAa,4EACf,EACA,CACE,SAAU,mBACV,YAAa,mDACf,EACA,CACE,SAAU,kBACV,YAAa,mBACf,EACA,CACE,SAAU,0CACV,YAAa,mDACf,EACA,CACE,SAAU,kCACV,YAAa,uDACf,CACF,EAEa,GAAmC,CAC9C,CACE,SAAU,mCACV,YACE,8GACJ,EACA,CACE,SAAU,uBACV,YAAa,uDACf,EACA,CACE,SAAU,uCACV,YACE,wHACJ,EACA,CACE,SAAU,4BACV,YAAa,+EACf,EACA,CACE,SAAU,iCACV,YAAa,4EACf,EACA,CACE,SAAU,2BACV,YAAa,uDACf,EACA,CACE,SAAU,oCACV,YAAa,0FACf,EACA,CACE,SAAU,wBACV,YAAa,8DACf,EACA,CACE,SAAU,mCACV,YACE,kIACJ,EACA,CACE,SAAU,2CACV,YAAa,kEACf,EACA,CACE,SAAU,wDACV,YAAa,iDACf,EACA,CACE,SAAU,8CACV,YAAa,qEACf,EACA,CACE,SAAU,4BACV,YAAa,mEACf,EACA,CACE,SAAU,4BACV,YAAa,8EACf,EACA,CACE,SAAU,qCACV,YAAa,iDACf,CACF,EAEa,GAAqC,CAChD,CACE,SAAU,2DACV,YACE,4KACJ,EACA,CACE,SAAU,gDACV,YAAa,6DACf,EACA,CACE,SAAU,2DACV,YAAa,6FACf,EACA,CACE,SAAU,oCACV,YAAa,6BACf,CACF,EAEa,GAAiC,CAC5C,CACE,SAAU,yBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,4DACf,EACA,CACE,SAAU,0BACV,YAAa,kGACf,EACA,CACE,SAAU,kBACV,YAAa,uDACf,EACA,CACE,SAAU,kBACV,YAAa,sDACf,EACA,CACE,SAAU,kBACV,YAAa,sFACf,EACA,CACE,SAAU,kBACV,YAAa,yCACf,EACA,CACE,SAAU,mBACV,YAAa,4CACf,EACA,CACE,SAAU,gCACV,YAAa,yCACf,EACA,CACE,SAAU,g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","sources":["webpack://grafana/./packages/grafana-prometheus/src/add_label_to_query.ts","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/app/core/store.ts","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/app/core/components/LocalStorageValueProvider/LocalStorageValueProvider.tsx","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/app/core/utils/CancelablePromise.ts","webpack://grafana/./packages/grafana-prometheus/src/types.ts","webpack://grafana/./packages/grafana-prometheus/src/language_provider.ts","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/packages/grafana-ui/src/components/Select/SelectBase.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/state/helpers.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/AdditionalSettings.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/FeedbackLink.tsx","webpack://grafana/./packages/grafana-prometheus/src/configuration/ConfigEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/ResultsTable.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/state/state.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/styles.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/uFuzzy.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/metrics-modal/MetricsModal.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/MetricSelect.tsx","webpack://grafana/./packages/grafana-prometheus/src/language_utils.ts","webpack://grafana/./packages/grafana-prometheus/src/components/PrometheusMetricsBrowser.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/getOverrideServices.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/monaco-completion-provider/util.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/monaco-completion-provider/completions.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/monaco-completion-provider/situation.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/monaco-completion-provider/index.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/monaco-completion-provider/validation.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/promql.ts","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/MonacoQueryField.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/MonacoQueryFieldLazy.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/monaco-query-field/MonacoQueryFieldWrapper.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromQueryField.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationExplainedBox.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/RawQuery.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationListExplained.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryBuilderExplained.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryCodeEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/AnnotationQueryEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/migrations/variableMigration.ts","webpack://grafana/./packages/grafana-prometheus/src/metric_find_query.ts","webpack://grafana/./packages/grafana-prometheus/src/query_hints.ts","webpack://grafana/./packages/grafana-prometheus/node_modules/@grafana/faro-core/dist/esm/sdk/registerFaro.js","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/app/features/live/data/amendTimeSeries.ts","webpack://grafana/./packages/grafana-prometheus/src/querycache/QueryCache.ts","webpack://grafana/./packages/grafana-prometheus/src/result_transformer.ts","webpack://grafana/./packages/grafana-prometheus/src/tracking.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/LabelFilterItem.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/LabelFilters.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/MetricsLabelsSection.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/VariableQueryEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/variables.ts","webpack://grafana/./packages/grafana-prometheus/src/datasource.ts","webpack://grafana/./packages/grafana-prometheus/src/gcopypaste/app/core/utils/query.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/QueryPattern.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/QueryPatternsModal.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/hooks/useFlag.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/types.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/QueryEditorModeToggle.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/QueryHeaderSwitch.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/state.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationInfoButton.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationHeader.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationParamEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationList.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/OperationsEditorRow.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/QueryBuilderHints.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/NestedQuery.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/NestedQueryList.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/QuerySuggestionItem.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/types.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/QuerySuggestionContainer.tsx","webpack://grafana/./node_modules/@grafana/experimental/dist/esm/llms/vector.js","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/prompts.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/state/state.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/state/templates.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/state/helpers.ts","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/PromQail.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/promQail/QueryAssistantButton.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryBuilder.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/QueryPreview.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryBuilderContainer.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromExemplarField.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromExploreExtraField.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/shared/QueryOptionGroup.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryLegendEditor.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryBuilderOptions.tsx","webpack://grafana/./packages/grafana-prometheus/src/querybuilder/components/PromQueryEditorSelector.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromQueryEditorForAlerting.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromQueryEditorByApp.tsx","webpack://grafana/./packages/grafana-prometheus/src/components/PromCheatSheet.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromCheatSheet.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPattern.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/QueryPatternsModal.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/hooks/useFlag.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryEditorModeToggle.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryHeaderSwitch.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/state.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationInfoButton.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationHeader.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationParamEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/OperationList.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryBuilderHints.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQuery.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/NestedQueryList.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/QuerySuggestionItem.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/types.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/QuerySuggestionContainer.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/prompts.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/state.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/templates.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/state/helpers.ts","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/PromQail.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/promQail/QueryAssistantButton.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilder.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/QueryPreview.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderContainer.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExemplarField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromExploreExtraField.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/shared/QueryOptionGroup.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryLegendEditor.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryBuilderOptions.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/querybuilder/components/PromQueryEditorSelector.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorForAlerting.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/components/PromQueryEditorByApp.tsx","webpack://grafana/./packages/grafana-prometheus/src/configuration/AlertingSettingsOverhaul.tsx","webpack://grafana/./packages/grafana-prometheus/src/configuration/ExemplarSetting.tsx","webpack://grafana/./packages/grafana-prometheus/src/configuration/ExemplarsSettings.tsx","webpack://grafana/./packages/grafana-prometheus/src/configuration/PromFlavorVersions.ts","webpack://grafana/./packages/grafana-prometheus/src/configuration/PromSettings.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/DataSourceHttpSettingsOverhaulPackage.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/configuration/ConfigEditorPackage.tsx","webpack://grafana/./public/app/plugins/datasource/prometheus/module.ts","webpack://grafana/./node_modules/monaco-promql/promql/promql.contribution.js","webpack://grafana/./node_modules/react-use/esm/useLatest.js"],"sourcesContent":["import { parser, VectorSelector } from '@prometheus-io/lezer-promql';\n\nimport { PromQueryModeller } from './querybuilder/PromQueryModeller';\nimport { buildVisualQueryFromString } from './querybuilder/parsing';\nimport { QueryBuilderLabelFilter } from './querybuilder/shared/types';\nimport { PromVisualQuery } from './querybuilder/types';\n\n/**\n * Adds label filter to existing query. Useful for query modification for example for ad hoc filters.\n *\n * It uses PromQL parser to find instances of metric and labels, alters them and then splices them back into the query.\n * Ideally we could use the parse -> change -> render is a simple 3 steps but right now building the visual query\n * object does not support all possible queries.\n *\n * So instead this just operates on substrings of the query with labels and operates just on those. This makes this\n * more robust and can alter even invalid queries, and preserves in general the query structure and whitespace.\n * @param query\n * @param key\n * @param value\n * @param operator\n */\nexport function addLabelToQuery(query: string, key: string, value: string | number, operator = '='): string {\n  if (!key || !value) {\n    throw new Error('Need label to add to query.');\n  }\n\n  const vectorSelectorPositions = getVectorSelectorPositions(query);\n  if (!vectorSelectorPositions.length) {\n    return query;\n  }\n\n  const filter = toLabelFilter(key, value, operator);\n  return addFilter(query, vectorSelectorPositions, filter);\n}\n\ntype VectorSelectorPosition = { from: number; to: number; query: PromVisualQuery };\n\n/**\n * Parse the string and get all VectorSelector positions in the query together with parsed representation of the vector\n * selector.\n * @param query\n */\nfunction getVectorSelectorPositions(query: string): VectorSelectorPosition[] {\n  const tree = parser.parse(query);\n  const positions: VectorSelectorPosition[] = [];\n  tree.iterate({\n    enter: ({ to, from, type }): false | void => {\n      if (type.id === VectorSelector) {\n        const visQuery = buildVisualQueryFromString(query.substring(from, to));\n        positions.push({ query: visQuery.query, from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\nfunction toLabelFilter(key: string, value: string | number, operator: string): QueryBuilderLabelFilter {\n  // We need to make sure that we convert the value back to string because it may be a number\n  const transformedValue = value === Infinity ? '+Inf' : value.toString();\n  return { label: key, op: operator, value: transformedValue };\n}\n\nfunction addFilter(\n  query: string,\n  vectorSelectorPositions: VectorSelectorPosition[],\n  filter: QueryBuilderLabelFilter\n): string {\n  const modeller = new PromQueryModeller();\n  let newQuery = '';\n  let prev = 0;\n\n  for (let i = 0; i < vectorSelectorPositions.length; i++) {\n    // This is basically just doing splice on a string for each matched vector selector.\n\n    const match = vectorSelectorPositions[i];\n    const isLast = i === vectorSelectorPositions.length - 1;\n\n    const start = query.substring(prev, match.from);\n    const end = isLast ? query.substring(match.to) : '';\n\n    if (!labelExists(match.query.labels, filter)) {\n      // We don't want to add duplicate labels.\n      match.query.labels.push(filter);\n    }\n    const newLabels = modeller.renderQuery(match.query);\n    newQuery += start + newLabels + end;\n    prev = match.to;\n  }\n  return newQuery;\n}\n\n/**\n * Check if label exists in the list of labels but ignore the operator.\n * @param labels\n * @param filter\n */\nfunction labelExists(labels: QueryBuilderLabelFilter[], filter: QueryBuilderLabelFilter) {\n  return labels.find((label) => label.label === filter.label && label.value === filter.value);\n}\n","type StoreValue = string | number | boolean | null;\n\nexport class Store {\n  get(key: string) {\n    return window.localStorage[key];\n  }\n\n  set(key: string, value: StoreValue) {\n    window.localStorage[key] = value;\n  }\n\n  getBool(key: string, def: boolean): boolean {\n    if (def !== void 0 && !this.exists(key)) {\n      return def;\n    }\n    return window.localStorage[key] === 'true';\n  }\n\n  getObject<T = unknown>(key: string): T | undefined;\n  getObject<T = unknown>(key: string, def: T): T;\n  getObject<T = unknown>(key: string, def?: T) {\n    let ret = def;\n    if (this.exists(key)) {\n      const json = window.localStorage[key];\n      try {\n        ret = JSON.parse(json);\n      } catch (error) {\n        console.error(`Error parsing store object: ${key}. Returning default: ${def}. [${error}]`);\n      }\n    }\n    return ret;\n  }\n\n  /* Returns true when successfully stored, throws error if not successfully stored */\n  setObject(key: string, value: unknown) {\n    let json;\n    try {\n      json = JSON.stringify(value);\n    } catch (error) {\n      throw new Error(`Could not stringify object: ${key}. [${error}]`);\n    }\n    try {\n      this.set(key, json);\n    } catch (error) {\n      // Likely hitting storage quota\n      const errorToThrow = new Error(`Could not save item in localStorage: ${key}. [${error}]`);\n      if (error instanceof Error) {\n        errorToThrow.name = error.name;\n      }\n      throw errorToThrow;\n    }\n    return true;\n  }\n\n  exists(key: string) {\n    return window.localStorage[key] !== void 0;\n  }\n\n  delete(key: string) {\n    window.localStorage.removeItem(key);\n  }\n}\n\nconst store = new Store();\nexport default store;\n","import React, { useEffect, useState } from 'react';\n\nimport store from '../../store';\n\nexport interface Props<T> {\n  storageKey: string;\n  defaultValue: T;\n  children: (value: T, onSaveToStore: (value: T) => void, onDeleteFromStore: () => void) => React.ReactNode;\n}\n\nexport const LocalStorageValueProvider = <T,>(props: Props<T>) => {\n  const { children, storageKey, defaultValue } = props;\n\n  const [state, setState] = useState({ value: store.getObject(props.storageKey, props.defaultValue) });\n\n  useEffect(() => {\n    const onStorageUpdate = (v: StorageEvent) => {\n      if (v.key === storageKey) {\n        setState({ value: store.getObject(props.storageKey, props.defaultValue) });\n      }\n    };\n\n    window.addEventListener('storage', onStorageUpdate);\n\n    return () => {\n      window.removeEventListener('storage', onStorageUpdate);\n    };\n  });\n\n  const onSaveToStore = (value: T) => {\n    try {\n      store.setObject(storageKey, value);\n    } catch (error) {\n      console.error(error);\n    }\n    setState({ value });\n  };\n\n  const onDeleteFromStore = () => {\n    try {\n      store.delete(storageKey);\n    } catch (error) {\n      console.log(error);\n    }\n    setState({ value: defaultValue });\n  };\n\n  return <>{children(state.value, onSaveToStore, onDeleteFromStore)}</>;\n};\n","// https://github.com/facebook/react/issues/5465\n\nexport interface CancelablePromise<T> {\n  promise: Promise<T>;\n  cancel: () => void;\n}\n\nexport interface CancelablePromiseRejection {\n  isCanceled: boolean;\n}\n\nexport function isCancelablePromiseRejection(promise: unknown): promise is CancelablePromiseRejection {\n  return typeof promise === 'object' && promise !== null && 'isCanceled' in promise;\n}\n\nexport const makePromiseCancelable = <T>(promise: Promise<T>): CancelablePromise<T> => {\n  let hasCanceled_ = false;\n\n  const wrappedPromise = new Promise<T>((resolve, reject) => {\n    const canceledPromiseRejection: CancelablePromiseRejection = { isCanceled: true };\n    promise.then((val) => (hasCanceled_ ? reject(canceledPromiseRejection) : resolve(val)));\n    promise.catch((error) => (hasCanceled_ ? reject(canceledPromiseRejection) : reject(error)));\n  });\n\n  return {\n    promise: wrappedPromise,\n    cancel() {\n      hasCanceled_ = true;\n    },\n  };\n};\n","import { DataSourceJsonData } from '@grafana/data';\nimport { DataQuery } from '@grafana/schema';\n\nimport { Prometheus as GenPromQuery } from './dataquery';\nimport { QueryBuilderLabelFilter, QueryEditorMode } from './querybuilder/shared/types';\n\nexport interface PromQuery extends GenPromQuery, DataQuery {\n  /**\n   * Timezone offset to align start & end time on backend\n   */\n  utcOffsetSec?: number;\n  valueWithRefId?: boolean;\n  showingGraph?: boolean;\n  showingTable?: boolean;\n  hinting?: boolean;\n  interval?: string;\n  // store the metrics explorer additional settings\n  useBackend?: boolean;\n  disableTextWrap?: boolean;\n  fullMetaSearch?: boolean;\n  includeNullMetadata?: boolean;\n}\n\nexport enum PrometheusCacheLevel {\n  Low = 'Low',\n  Medium = 'Medium',\n  High = 'High',\n  None = 'None',\n}\n\nexport enum PromApplication {\n  Cortex = 'Cortex',\n  Mimir = 'Mimir',\n  Prometheus = 'Prometheus',\n  Thanos = 'Thanos',\n}\n\nexport interface PromOptions extends DataSourceJsonData {\n  timeInterval?: string;\n  queryTimeout?: string;\n  httpMethod?: string;\n  customQueryParameters?: string;\n  disableMetricsLookup?: boolean;\n  exemplarTraceIdDestinations?: ExemplarTraceIdDestination[];\n  prometheusType?: PromApplication;\n  prometheusVersion?: string;\n  cacheLevel?: PrometheusCacheLevel;\n  defaultEditor?: QueryEditorMode;\n  incrementalQuerying?: boolean;\n  incrementalQueryOverlapWindow?: string;\n  disableRecordingRules?: boolean;\n  sigV4Auth?: boolean;\n  oauthPassThru?: boolean;\n}\n\nexport type ExemplarTraceIdDestination = {\n  name: string;\n  url?: string;\n  urlDisplayLabel?: string;\n  datasourceUid?: string;\n};\n\nexport interface PromQueryRequest extends PromQuery {\n  step?: number;\n  requestId?: string;\n  start: number;\n  end: number;\n  headers?: any;\n}\n\nexport interface PromMetricsMetadataItem {\n  type: string;\n  help: string;\n  unit?: string;\n}\n\nexport interface PromMetricsMetadata {\n  [metric: string]: PromMetricsMetadataItem;\n}\n\nexport type PromValue = [number, any];\n\nexport interface PromMetric {\n  __name__?: string;\n\n  [index: string]: any;\n}\n\nexport interface PromBuildInfoResponse {\n  data: {\n    application?: string;\n    version: string;\n    revision: string;\n    features?: {\n      ruler_config_api?: 'true' | 'false';\n      alertmanager_config_api?: 'true' | 'false';\n      query_sharding?: 'true' | 'false';\n      federated_rules?: 'true' | 'false';\n    };\n    [key: string]: unknown;\n  };\n  status: 'success';\n}\n\n/**\n * Auto = query.legendFormat == '__auto'\n * Verbose = query.legendFormat == null/undefined/''\n * Custom query.legendFormat.length > 0 && query.legendFormat !== '__auto'\n */\nexport enum LegendFormatMode {\n  Auto = '__auto',\n  Verbose = '__verbose',\n  Custom = '__custom',\n}\n\nexport enum PromVariableQueryType {\n  LabelNames,\n  LabelValues,\n  MetricNames,\n  VarQueryResult,\n  SeriesQuery,\n  ClassicQuery,\n}\n\nexport interface PromVariableQuery extends DataQuery {\n  query?: string;\n  expr?: string;\n  qryType?: PromVariableQueryType;\n  label?: string;\n  metric?: string;\n  varQuery?: string;\n  seriesQuery?: string;\n  labelFilters?: QueryBuilderLabelFilter[];\n  match?: string;\n  classicQuery?: string;\n}\n\nexport type StandardPromVariableQuery = {\n  query: string;\n  refId: string;\n};\n","import { once } from 'lodash';\nimport Prism from 'prismjs';\n\nimport {\n  AbstractLabelMatcher,\n  AbstractLabelOperator,\n  AbstractQuery,\n  getDefaultTimeRange,\n  LanguageProvider,\n  TimeRange,\n} from '@grafana/data';\nimport { BackendSrvRequest } from '@grafana/runtime';\n\nimport { Label } from './components/monaco-query-field/monaco-completion-provider/situation';\nimport { PrometheusDatasource } from './datasource';\nimport {\n  extractLabelMatchers,\n  fixSummariesMetadata,\n  processHistogramMetrics,\n  processLabels,\n  toPromLikeQuery,\n} from './language_utils';\nimport PromqlSyntax from './promql';\nimport { PrometheusCacheLevel, PromMetricsMetadata, PromQuery } from './types';\n\nconst DEFAULT_KEYS = ['job', 'instance'];\nconst EMPTY_SELECTOR = '{}';\n// Max number of items (metrics, labels, values) that we display as suggestions. Prevents from running out of memory.\nexport const SUGGESTIONS_LIMIT = 10000;\n\nconst buildCacheHeaders = (durationInSeconds: number) => {\n  return {\n    headers: {\n      'X-Grafana-Cache': `private, max-age=${durationInSeconds}`,\n    },\n  };\n};\n\nexport function getMetadataString(metric: string, metadata: PromMetricsMetadata): string | undefined {\n  if (!metadata[metric]) {\n    return undefined;\n  }\n  const { type, help } = metadata[metric];\n  return `${type.toUpperCase()}: ${help}`;\n}\n\nexport function getMetadataHelp(metric: string, metadata: PromMetricsMetadata): string | undefined {\n  if (!metadata[metric]) {\n    return undefined;\n  }\n  return metadata[metric].help;\n}\n\nexport function getMetadataType(metric: string, metadata: PromMetricsMetadata): string | undefined {\n  if (!metadata[metric]) {\n    return undefined;\n  }\n  return metadata[metric].type;\n}\n\nconst PREFIX_DELIMITER_REGEX =\n  /(=\"|!=\"|=~\"|!~\"|\\{|\\[|\\(|\\+|-|\\/|\\*|%|\\^|\\band\\b|\\bor\\b|\\bunless\\b|==|>=|!=|<=|>|<|=|~|,)/;\n\nconst secondsInDay = 86400;\nexport default class PromQlLanguageProvider extends LanguageProvider {\n  histogramMetrics: string[];\n  timeRange: TimeRange;\n  metrics: string[];\n  metricsMetadata?: PromMetricsMetadata;\n  declare startTask: Promise<any>;\n  datasource: PrometheusDatasource;\n  labelKeys: string[] = [];\n  declare labelFetchTs: number;\n\n  constructor(datasource: PrometheusDatasource, initialValues?: Partial<PromQlLanguageProvider>) {\n    super();\n\n    this.datasource = datasource;\n    this.histogramMetrics = [];\n    this.timeRange = getDefaultTimeRange();\n    this.metrics = [];\n\n    Object.assign(this, initialValues);\n  }\n\n  getDefaultCacheHeaders() {\n    if (this.datasource.cacheLevel !== PrometheusCacheLevel.None) {\n      return buildCacheHeaders(this.datasource.getCacheDurationInMinutes() * 60);\n    }\n    return;\n  }\n\n  // Strip syntax chars so that typeahead suggestions can work on clean inputs\n  cleanText(s: string) {\n    const parts = s.split(PREFIX_DELIMITER_REGEX);\n    const last = parts.pop()!;\n    return last.trimLeft().replace(/\"$/, '').replace(/^\"/, '');\n  }\n\n  get syntax() {\n    return PromqlSyntax;\n  }\n\n  request = async (url: string, defaultValue: any, params = {}, options?: Partial<BackendSrvRequest>): Promise<any> => {\n    try {\n      const res = await this.datasource.metadataRequest(url, params, options);\n      return res.data.data;\n    } catch (error) {\n      console.error(error);\n    }\n\n    return defaultValue;\n  };\n\n  start = async (timeRange?: TimeRange): Promise<any[]> => {\n    this.timeRange = timeRange ?? getDefaultTimeRange();\n\n    if (this.datasource.lookupsDisabled) {\n      return [];\n    }\n\n    this.metrics = (await this.fetchLabelValues('__name__')) || [];\n    this.histogramMetrics = processHistogramMetrics(this.metrics).sort();\n    return Promise.all([this.loadMetricsMetadata(), this.fetchLabels()]);\n  };\n\n  async loadMetricsMetadata() {\n    const headers = buildCacheHeaders(this.datasource.getDaysToCacheMetadata() * secondsInDay);\n    this.metricsMetadata = fixSummariesMetadata(\n      await this.request(\n        '/api/v1/metadata',\n        {},\n        {},\n        {\n          showErrorAlert: false,\n          ...headers,\n        }\n      )\n    );\n  }\n\n  getLabelKeys(): string[] {\n    return this.labelKeys;\n  }\n\n  importFromAbstractQuery(labelBasedQuery: AbstractQuery): PromQuery {\n    return toPromLikeQuery(labelBasedQuery);\n  }\n\n  exportToAbstractQuery(query: PromQuery): AbstractQuery {\n    const promQuery = query.expr;\n    if (!promQuery || promQuery.length === 0) {\n      return { refId: query.refId, labelMatchers: [] };\n    }\n    const tokens = Prism.tokenize(promQuery, PromqlSyntax);\n    const labelMatchers: AbstractLabelMatcher[] = extractLabelMatchers(tokens);\n    const nameLabelValue = getNameLabelValue(promQuery, tokens);\n    if (nameLabelValue && nameLabelValue.length > 0) {\n      labelMatchers.push({\n        name: '__name__',\n        operator: AbstractLabelOperator.Equal,\n        value: nameLabelValue,\n      });\n    }\n\n    return {\n      refId: query.refId,\n      labelMatchers,\n    };\n  }\n\n  async getSeries(selector: string, withName?: boolean): Promise<Record<string, string[]>> {\n    if (this.datasource.lookupsDisabled) {\n      return {};\n    }\n    try {\n      if (selector === EMPTY_SELECTOR) {\n        return await this.fetchDefaultSeries();\n      } else {\n        return await this.fetchSeriesLabels(selector, withName);\n      }\n    } catch (error) {\n      // TODO: better error handling\n      console.error(error);\n      return {};\n    }\n  }\n\n  /**\n   * @param key\n   */\n  fetchLabelValues = async (key: string): Promise<string[]> => {\n    const params = this.datasource.getAdjustedInterval(this.timeRange);\n    const interpolatedName = this.datasource.interpolateString(key);\n    const url = `/api/v1/label/${interpolatedName}/values`;\n    const value = await this.request(url, [], params, this.getDefaultCacheHeaders());\n    return value ?? [];\n  };\n\n  async getLabelValues(key: string): Promise<string[]> {\n    return await this.fetchLabelValues(key);\n  }\n\n  /**\n   * Fetches all label keys\n   */\n  async fetchLabels(timeRange?: TimeRange): Promise<string[]> {\n    if (timeRange) {\n      this.timeRange = timeRange;\n    }\n    const url = '/api/v1/labels';\n    const params = this.datasource.getAdjustedInterval(this.timeRange);\n    this.labelFetchTs = Date.now().valueOf();\n\n    const res = await this.request(url, [], params, this.getDefaultCacheHeaders());\n    if (Array.isArray(res)) {\n      this.labelKeys = res.slice().sort();\n    }\n\n    return [];\n  }\n\n  /**\n   * Gets series values\n   * Function to replace old getSeries calls in a way that will provide faster endpoints for new prometheus instances,\n   * while maintaining backward compatability\n   * @param labelName\n   * @param selector\n   */\n  getSeriesValues = async (labelName: string, selector: string): Promise<string[]> => {\n    if (!this.datasource.hasLabelsMatchAPISupport()) {\n      const data = await this.getSeries(selector);\n      return data[labelName] ?? [];\n    }\n    return await this.fetchSeriesValuesWithMatch(labelName, selector);\n  };\n\n  /**\n   * Fetches all values for a label, with optional match[]\n   * @param name\n   * @param match\n   * @param timeRange\n   */\n  fetchSeriesValuesWithMatch = async (\n    name: string,\n    match?: string,\n    timeRange: TimeRange = this.timeRange\n  ): Promise<string[]> => {\n    const interpolatedName = name ? this.datasource.interpolateString(name) : null;\n    const interpolatedMatch = match ? this.datasource.interpolateString(match) : null;\n    const range = this.datasource.getAdjustedInterval(timeRange);\n    const urlParams = {\n      ...range,\n      ...(interpolatedMatch && { 'match[]': interpolatedMatch }),\n    };\n\n    const value = await this.request(\n      `/api/v1/label/${interpolatedName}/values`,\n      [],\n      urlParams,\n      this.getDefaultCacheHeaders()\n    );\n    return value ?? [];\n  };\n\n  /**\n   * Gets series labels\n   * Function to replace old getSeries calls in a way that will provide faster endpoints for new prometheus instances,\n   * while maintaining backward compatability. The old API call got the labels and the values in a single query,\n   * but with the new query we need two calls, one to get the labels, and another to get the values.\n   *\n   * @param selector\n   * @param otherLabels\n   */\n  getSeriesLabels = async (selector: string, otherLabels: Label[]): Promise<string[]> => {\n    let possibleLabelNames, data: Record<string, string[]>;\n\n    if (!this.datasource.hasLabelsMatchAPISupport()) {\n      data = await this.getSeries(selector);\n      possibleLabelNames = Object.keys(data); // all names from prometheus\n    } else {\n      // Exclude __name__ from output\n      otherLabels.push({ name: '__name__', value: '', op: '!=' });\n      data = await this.fetchSeriesLabelsMatch(selector);\n      possibleLabelNames = Object.keys(data);\n    }\n\n    const usedLabelNames = new Set(otherLabels.map((l) => l.name)); // names used in the query\n    return possibleLabelNames.filter((l) => !usedLabelNames.has(l));\n  };\n\n  /**\n   * Fetch labels using the best endpoint that datasource supports.\n   * This is cached by its args but also by the global timeRange currently selected as they can change over requested time.\n   * @param name\n   * @param withName\n   */\n  fetchLabelsWithMatch = async (name: string, withName?: boolean): Promise<Record<string, string[]>> => {\n    if (this.datasource.hasLabelsMatchAPISupport()) {\n      return this.fetchSeriesLabelsMatch(name, withName);\n    } else {\n      return this.fetchSeriesLabels(name, withName);\n    }\n  };\n\n  /**\n   * Fetch labels for a series using /series endpoint. This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   * @param name\n   * @param withName\n   */\n  fetchSeriesLabels = async (name: string, withName?: boolean): Promise<Record<string, string[]>> => {\n    const interpolatedName = this.datasource.interpolateString(name);\n    const range = this.datasource.getAdjustedInterval(this.timeRange);\n    const urlParams = {\n      ...range,\n      'match[]': interpolatedName,\n    };\n    const url = `/api/v1/series`;\n\n    const data = await this.request(url, [], urlParams, this.getDefaultCacheHeaders());\n    const { values } = processLabels(data, withName);\n    return values;\n  };\n\n  /**\n   * Fetch labels for a series using /labels endpoint.  This is cached by its args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   * @param name\n   * @param withName\n   */\n  fetchSeriesLabelsMatch = async (name: string, withName?: boolean): Promise<Record<string, string[]>> => {\n    const interpolatedName = this.datasource.interpolateString(name);\n    const range = this.datasource.getAdjustedInterval(this.timeRange);\n    const urlParams = {\n      ...range,\n      'match[]': interpolatedName,\n    };\n    const url = `/api/v1/labels`;\n\n    const data: string[] = await this.request(url, [], urlParams, this.getDefaultCacheHeaders());\n    // Convert string array to Record<string , []>\n    return data.reduce((ac, a) => ({ ...ac, [a]: '' }), {});\n  };\n\n  /**\n   * Fetch series for a selector. Use this for raw results. Use fetchSeriesLabels() to get labels.\n   * @param match\n   */\n  fetchSeries = async (match: string): Promise<Array<Record<string, string>>> => {\n    const url = '/api/v1/series';\n    const range = this.datasource.getTimeRangeParams(this.timeRange);\n    const params = { ...range, 'match[]': match };\n    return await this.request(url, {}, params, this.getDefaultCacheHeaders());\n  };\n\n  /**\n   * Fetch this only one as we assume this won't change over time. This is cached differently from fetchSeriesLabels\n   * because we can cache more aggressively here and also we do not want to invalidate this cache the same way as in\n   * fetchSeriesLabels.\n   */\n  fetchDefaultSeries = once(async () => {\n    const values = await Promise.all(DEFAULT_KEYS.map((key) => this.fetchLabelValues(key)));\n    return DEFAULT_KEYS.reduce((acc, key, i) => ({ ...acc, [key]: values[i] }), {});\n  });\n}\n\nfunction getNameLabelValue(promQuery: string, tokens: any): string {\n  let nameLabelValue = '';\n\n  for (const token of tokens) {\n    if (typeof token === 'string') {\n      nameLabelValue = token;\n      break;\n    }\n  }\n  return nameLabelValue;\n}\n","import { cx } from '@emotion/css';\nimport { max } from 'lodash';\nimport React, { RefCallback } from 'react';\nimport { MenuListProps } from 'react-select';\nimport { FixedSizeList as List } from 'react-window';\n\nimport { SelectableValue, toIconName } from '@grafana/data';\nimport { CustomScrollbar, Icon, getSelectStyles, useTheme2 } from '@grafana/ui';\n\ninterface SelectMenuProps {\n  maxHeight: number;\n  innerRef: RefCallback<HTMLDivElement>;\n  innerProps: {};\n}\n\nexport const SelectMenu = ({ children, maxHeight, innerRef, innerProps }: React.PropsWithChildren<SelectMenuProps>) => {\n  const theme = useTheme2();\n  const styles = getSelectStyles(theme);\n\n  return (\n    <div {...innerProps} className={styles.menu} style={{ maxHeight }} aria-label=\"Select options menu\">\n      <CustomScrollbar scrollRefCallback={innerRef} autoHide={false} autoHeightMax=\"inherit\" hideHorizontalTrack>\n        {children}\n      </CustomScrollbar>\n    </div>\n  );\n};\n\nSelectMenu.displayName = 'SelectMenu';\n\nconst VIRTUAL_LIST_ITEM_HEIGHT = 37;\nconst VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER = 7;\n\n// A virtualized version of the SelectMenu, descriptions for SelectableValue options not supported since those are of a variable height.\n//\n// To support the virtualized list we have to \"guess\" the width of the menu container based on the longest available option.\n// the reason for this is because all of the options will be positioned absolute, this takes them out of the document and no space\n// is created for them, thus the container can't grow to accomodate.\n//\n// VIRTUAL_LIST_ITEM_HEIGHT and WIDTH_ESTIMATE_MULTIPLIER are both magic numbers.\n// Some characters (such as emojis and other unicode characters) may consist of multiple code points in which case the width would be inaccurate (but larger than needed).\nexport const VirtualizedSelectMenu = ({ children, maxHeight, options, getValue }: MenuListProps<SelectableValue>) => {\n  const theme = useTheme2();\n  const styles = getSelectStyles(theme);\n  const [value] = getValue();\n\n  const valueIndex = value ? options.findIndex((option: SelectableValue<unknown>) => option.value === value.value) : 0;\n  const initialOffset = valueIndex * VIRTUAL_LIST_ITEM_HEIGHT;\n\n  if (!Array.isArray(children)) {\n    return null;\n  }\n\n  const longestOption = max(options.map((option) => option.label?.length)) ?? 0;\n  const widthEstimate = longestOption * VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER;\n  const heightEstimate = Math.min(options.length * VIRTUAL_LIST_ITEM_HEIGHT, maxHeight);\n\n  return (\n    <List\n      className={styles.menu}\n      height={heightEstimate}\n      width={widthEstimate}\n      aria-label=\"Select options menu\"\n      itemCount={children.length}\n      itemSize={VIRTUAL_LIST_ITEM_HEIGHT}\n      initialScrollOffset={initialOffset}\n    >\n      {({ index, style }) => <div style={{ ...style, overflow: 'hidden' }}>{children[index]}</div>}\n    </List>\n  );\n};\n\nVirtualizedSelectMenu.displayName = 'VirtualizedSelectMenu';\n\ninterface SelectMenuOptionProps<T> {\n  isDisabled: boolean;\n  isFocused: boolean;\n  isSelected: boolean;\n  innerProps: JSX.IntrinsicElements['div'];\n  innerRef: RefCallback<HTMLDivElement>;\n  renderOptionLabel?: (value: SelectableValue<T>) => JSX.Element;\n  data: SelectableValue<T>;\n}\n\nexport const SelectMenuOptions = ({\n  children,\n  data,\n  innerProps,\n  innerRef,\n  isFocused,\n  isSelected,\n  renderOptionLabel,\n}: React.PropsWithChildren<SelectMenuOptionProps<unknown>>) => {\n  const theme = useTheme2();\n  const styles = getSelectStyles(theme);\n  const icon = data.icon ? toIconName(data.icon) : undefined;\n  // We are removing onMouseMove and onMouseOver from innerProps because they cause the whole\n  // list to re-render everytime the user hovers over an option. This is a performance issue.\n  // See https://github.com/JedWatson/react-select/issues/3128#issuecomment-451936743\n  const { onMouseMove, onMouseOver, ...rest } = innerProps;\n\n  return (\n    <div\n      ref={innerRef}\n      className={cx(\n        styles.option,\n        isFocused && styles.optionFocused,\n        isSelected && styles.optionSelected,\n        data.isDisabled && styles.optionDisabled\n      )}\n      {...rest}\n      aria-label=\"Select option\"\n      title={data.title}\n    >\n      {icon && <Icon name={icon} className={styles.optionIcon} />}\n      {data.imgUrl && <img className={styles.optionImage} src={data.imgUrl} alt={data.label || String(data.value)} />}\n      <div className={styles.optionBody}>\n        <span>{renderOptionLabel ? renderOptionLabel(data) : children}</span>\n        {data.description && <div className={styles.optionDescription}>{data.description}</div>}\n        {data.component && <data.component />}\n      </div>\n    </div>\n  );\n};\n\nSelectMenuOptions.displayName = 'SelectMenuOptions';\n","import { AnyAction } from '@reduxjs/toolkit';\n\nimport { reportInteraction } from '@grafana/runtime';\n\nimport { PrometheusDatasource } from '../../../../datasource';\nimport { getMetadataHelp, getMetadataType } from '../../../../language_provider';\nimport { regexifyLabelValuesQueryString } from '../../../parsingUtils';\nimport { QueryBuilderLabelFilter } from '../../../shared/types';\nimport { PromVisualQuery } from '../../../types';\nimport { setFilteredMetricCount } from '../MetricsModal';\nimport { HaystackDictionary, MetricData, MetricsData, PromFilterOption } from '../types';\n\nimport { MetricsModalMetadata, MetricsModalState } from './state';\n\n// const { setFilteredMetricCount } = stateSlice.actions;\n\nexport async function setMetrics(\n  datasource: PrometheusDatasource,\n  query: PromVisualQuery,\n  initialMetrics?: string[]\n): Promise<MetricsModalMetadata> {\n  // metadata is set in the metric select now\n  // use this to disable metadata search and display\n  let hasMetadata = true;\n  const metadata = datasource.languageProvider.metricsMetadata;\n  if (metadata && Object.keys(metadata).length === 0) {\n    hasMetadata = false;\n  }\n\n  let nameHaystackDictionaryData: HaystackDictionary = {};\n  let metaHaystackDictionaryData: HaystackDictionary = {};\n\n  // pass in metrics from getMetrics in the query builder, reduced in the metric select\n  let metricsData: MetricsData | undefined;\n\n  metricsData = initialMetrics?.map((m: string) => {\n    const metricData = buildMetricData(m, datasource);\n\n    const metaDataString = `${m}${metricData.description}`;\n\n    nameHaystackDictionaryData[m] = metricData;\n    metaHaystackDictionaryData[metaDataString] = metricData;\n\n    return metricData;\n  });\n\n  return {\n    isLoading: false,\n    hasMetadata: hasMetadata,\n    metrics: metricsData ?? [],\n    metaHaystackDictionary: metaHaystackDictionaryData,\n    nameHaystackDictionary: nameHaystackDictionaryData,\n    totalMetricCount: metricsData?.length ?? 0,\n    filteredMetricCount: metricsData?.length ?? 0,\n  };\n}\n\n/**\n * Builds the metric data object with type and description\n *\n * @param   metric  The metric name\n * @param   datasource  The Prometheus datasource for mapping metradata to the metric name\n * @returns A MetricData object.\n */\nfunction buildMetricData(metric: string, datasource: PrometheusDatasource): MetricData {\n  let type = getMetadataType(metric, datasource.languageProvider.metricsMetadata!);\n\n  const description = getMetadataHelp(metric, datasource.languageProvider.metricsMetadata!);\n\n  ['histogram', 'summary'].forEach((t) => {\n    if (description?.toLowerCase().includes(t) && type !== t) {\n      type += ` (${t})`;\n    }\n  });\n\n  const metricData: MetricData = {\n    value: metric,\n    type: type,\n    description: description,\n  };\n\n  return metricData;\n}\n\n/**\n * The filtered and paginated metrics displayed in the modal\n * */\nexport function displayedMetrics(state: MetricsModalState, dispatch: React.Dispatch<AnyAction>) {\n  const filteredSorted: MetricsData = filterMetrics(state);\n\n  if (!state.isLoading && state.filteredMetricCount !== filteredSorted.length) {\n    dispatch(setFilteredMetricCount(filteredSorted.length));\n  }\n\n  return sliceMetrics(filteredSorted, state.pageNum, state.resultsPerPage);\n}\n\n/**\n * Filter the metrics with all the options, fuzzy, type, null metadata\n */\nexport function filterMetrics(state: MetricsModalState): MetricsData {\n  let filteredMetrics: MetricsData = state.metrics;\n\n  if (state.fuzzySearchQuery && !state.useBackend) {\n    if (state.fullMetaSearch) {\n      filteredMetrics = state.metaHaystackOrder.map((needle: string) => state.metaHaystackDictionary[needle]);\n    } else {\n      filteredMetrics = state.nameHaystackOrder.map((needle: string) => state.nameHaystackDictionary[needle]);\n    }\n  }\n\n  if (state.selectedTypes.length > 0) {\n    filteredMetrics = filteredMetrics.filter((m: MetricData, idx) => {\n      // Matches type\n      const matchesSelectedType = state.selectedTypes.some((t) => {\n        if (m.type && t.value) {\n          return m.type.includes(t.value);\n        }\n\n        if (!m.type && t.value === 'no type') {\n          return true;\n        }\n\n        return false;\n      });\n\n      // when a user filters for type, only return metrics with defined types\n      return matchesSelectedType;\n    });\n  }\n\n  if (!state.includeNullMetadata) {\n    filteredMetrics = filteredMetrics.filter((m: MetricData) => {\n      return m.type !== undefined && m.description !== undefined;\n    });\n  }\n\n  return filteredMetrics;\n}\n\nexport function calculatePageList(state: MetricsModalState) {\n  if (!state.metrics.length) {\n    return [];\n  }\n\n  const calcResultsPerPage: number = state.resultsPerPage === 0 ? 1 : state.resultsPerPage;\n\n  const pages = Math.floor(filterMetrics(state).length / calcResultsPerPage) + 1;\n\n  return [...Array(pages).keys()].map((i) => i + 1);\n}\n\nexport function sliceMetrics(metrics: MetricsData, pageNum: number, resultsPerPage: number) {\n  const calcResultsPerPage: number = resultsPerPage === 0 ? 1 : resultsPerPage;\n  const start: number = pageNum === 1 ? 0 : (pageNum - 1) * calcResultsPerPage;\n  const end: number = start + calcResultsPerPage;\n  return metrics.slice(start, end);\n}\n\nexport const calculateResultsPerPage = (results: number, defaultResults: number, max: number) => {\n  if (results < 1) {\n    return 1;\n  }\n\n  if (results > max) {\n    return max;\n  }\n\n  return results ?? defaultResults;\n};\n\n/**\n * The backend query that replaces the uFuzzy search when the option 'useBackend' has been selected\n * this is a regex search either to the series or labels Prometheus endpoint\n * depending on which the Prometheus type or version supports\n * @param metricText\n * @param labels\n * @param datasource\n */\nexport async function getBackendSearchMetrics(\n  metricText: string,\n  labels: QueryBuilderLabelFilter[],\n  datasource: PrometheusDatasource\n): Promise<Array<{ value: string }>> {\n  const queryString = regexifyLabelValuesQueryString(metricText);\n\n  const labelsParams = labels.map((label) => {\n    return `,${label.label}=\"${label.value}\"`;\n  });\n\n  const params = `label_values({__name__=~\".*${queryString}\"${labels ? labelsParams.join() : ''}},__name__)`;\n\n  const results = datasource.metricFindQuery(params);\n\n  return await results.then((results) => {\n    return results.map((result) => buildMetricData(result.text, datasource));\n  });\n}\n\nexport function tracking(event: string, state?: MetricsModalState | null, metric?: string, query?: PromVisualQuery) {\n  switch (event) {\n    case 'grafana_prom_metric_encycopedia_tracking':\n      reportInteraction(event, {\n        metric: metric,\n        hasMetadata: state?.hasMetadata,\n        totalMetricCount: state?.totalMetricCount,\n        fuzzySearchQuery: state?.fuzzySearchQuery,\n        fullMetaSearch: state?.fullMetaSearch,\n        selectedTypes: state?.selectedTypes,\n        useRegexSearch: state?.useBackend,\n        includeResultsWithoutMetadata: state?.includeNullMetadata,\n      });\n    case 'grafana_prom_metric_encycopedia_disable_text_wrap_interaction':\n      reportInteraction(event, {\n        disableTextWrap: state?.disableTextWrap,\n      });\n    case 'grafana_prometheus_metric_encyclopedia_open':\n      reportInteraction(event, {\n        query: query,\n      });\n  }\n}\n\nexport const promTypes: PromFilterOption[] = [\n  {\n    value: 'counter',\n    description:\n      'A cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart.',\n  },\n  {\n    value: 'gauge',\n    description: 'A metric that represents a single numerical value that can arbitrarily go up and down.',\n  },\n  {\n    value: 'histogram',\n    description:\n      'A histogram samples observations (usually things like request durations or response sizes) and counts them in configurable buckets.',\n  },\n  {\n    value: 'summary',\n    description:\n      'A summary samples observations (usually things like request durations and response sizes) and can calculate configurable quantiles over a sliding time window.',\n  },\n  {\n    value: 'unknown',\n    description: 'These metrics have been given the type unknown in the metadata.',\n  },\n  {\n    value: 'no type',\n    description: 'These metrics have no defined type in the metadata.',\n  },\n];\n\nexport const placeholders = {\n  browse: 'Search metrics by name',\n  metadataSearchSwitch: 'Include description in search',\n  type: 'Filter by type',\n  includeNullMetadata: 'Include results with no metadata',\n  setUseBackend: 'Enable regex search',\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Icon, Switch, Tooltip, useTheme2 } from '@grafana/ui';\n\nimport { metricsModaltestIds } from './MetricsModal';\nimport { placeholders } from './state/helpers';\nimport { MetricsModalState } from './state/state';\n\ntype AdditionalSettingsProps = {\n  state: MetricsModalState;\n  onChangeFullMetaSearch: () => void;\n  onChangeIncludeNullMetadata: () => void;\n  onChangeDisableTextWrap: () => void;\n  onChangeUseBackend: () => void;\n};\n\nexport function AdditionalSettings(props: AdditionalSettingsProps) {\n  const { state, onChangeFullMetaSearch, onChangeIncludeNullMetadata, onChangeDisableTextWrap, onChangeUseBackend } =\n    props;\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  return (\n    <>\n      <div className={styles.selectItem}>\n        <Switch\n          data-testid={metricsModaltestIds.searchWithMetadata}\n          value={state.fullMetaSearch}\n          disabled={state.useBackend || !state.hasMetadata}\n          onChange={() => onChangeFullMetaSearch()}\n        />\n        <div className={styles.selectItemLabel}>{placeholders.metadataSearchSwitch}</div>\n      </div>\n      <div className={styles.selectItem}>\n        <Switch\n          value={state.includeNullMetadata}\n          disabled={!state.hasMetadata}\n          onChange={() => onChangeIncludeNullMetadata()}\n        />\n        <div className={styles.selectItemLabel}>{placeholders.includeNullMetadata}</div>\n      </div>\n      <div className={styles.selectItem}>\n        <Switch value={state.disableTextWrap} onChange={() => onChangeDisableTextWrap()} />\n        <div className={styles.selectItemLabel}>Disable text wrap</div>\n      </div>\n      <div className={styles.selectItem}>\n        <Switch\n          data-testid={metricsModaltestIds.setUseBackend}\n          value={state.useBackend}\n          onChange={() => onChangeUseBackend()}\n        />\n        <div className={styles.selectItemLabel}>{placeholders.setUseBackend}&nbsp;</div>\n        <Tooltip\n          content={'Filter metric names by regex search, using an additional call on the Prometheus API.'}\n          placement=\"bottom-end\"\n        >\n          <Icon name=\"info-circle\" size=\"xs\" className={styles.settingsIcon} />\n        </Tooltip>\n      </div>\n    </>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    settingsIcon: css`\n      color: ${theme.colors.text.secondary};\n    `,\n    selectItem: css`\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n      padding: 4px 0;\n    `,\n    selectItemLabel: css`\n      margin: 0 0 0 ${theme.spacing(1)};\n      align-self: center;\n      color: ${theme.colors.text.secondary};\n      font-size: 12px;\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Icon, useStyles2, Stack } from '@grafana/ui';\n\nexport interface Props {\n  feedbackUrl?: string;\n}\n\nexport function FeedbackLink({ feedbackUrl }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Stack>\n      <a\n        href={feedbackUrl}\n        className={styles.link}\n        title=\"The metrics explorer is new, please let us know how we can improve it\"\n        target=\"_blank\"\n        rel=\"noreferrer noopener\"\n      >\n        <Icon name=\"comment-alt-message\" /> Give feedback\n      </a>\n    </Stack>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    link: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      ':hover': {\n        color: theme.colors.text.link,\n      },\n      margin: `-25px 0 30px 0`,\n    }),\n  };\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, GrafanaTheme2 } from '@grafana/data';\nimport { ConfigSection, DataSourceDescription, AdvancedHttpSettings } from '@grafana/experimental';\nimport { config } from '@grafana/runtime';\nimport { Alert, FieldValidationMessage, useTheme2 } from '@grafana/ui';\n\nimport { PromOptions } from '../types';\n\nimport { AlertingSettingsOverhaul } from './AlertingSettingsOverhaul';\nimport { DataSourceHttpSettingsOverhaul } from './DataSourceHttpSettingsOverhaul';\nimport { PromSettings } from './PromSettings';\n\nexport const PROM_CONFIG_LABEL_WIDTH = 30;\n\nexport type PrometheusConfigProps = DataSourcePluginOptionsEditorProps<PromOptions>;\n\nexport const ConfigEditor = (props: PrometheusConfigProps) => {\n  const { options, onOptionsChange } = props;\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n\n  return (\n    <>\n      {options.access === 'direct' && (\n        <Alert title=\"Error\" severity=\"error\">\n          Browser access mode in the Prometheus data source is no longer available. Switch to server access mode.\n        </Alert>\n      )}\n      <DataSourceDescription\n        dataSourceName=\"Prometheus\"\n        docsLink=\"https://grafana.com/docs/grafana/latest/datasources/prometheus/configure-prometheus-data-source/\"\n      />\n      <hr className={`${styles.hrTopSpace} ${styles.hrBottomSpace}`} />\n      <DataSourceHttpSettingsOverhaul\n        options={options}\n        onOptionsChange={onOptionsChange}\n        secureSocksDSProxyEnabled={config.secureSocksDSProxyEnabled}\n      />\n      <hr />\n      <ConfigSection\n        className={styles.advancedSettings}\n        title=\"Advanced settings\"\n        description=\"Additional settings are optional settings that can be configured for more control over your data source.\"\n      >\n        <AdvancedHttpSettings\n          className={styles.advancedHTTPSettingsMargin}\n          config={options}\n          onChange={onOptionsChange}\n        />\n        <AlertingSettingsOverhaul<PromOptions> options={options} onOptionsChange={onOptionsChange} />\n        <PromSettings options={options} onOptionsChange={onOptionsChange} />\n      </ConfigSection>\n    </>\n  );\n};\n\n/**\n * Use this to return a url in a tooltip in a field. Don't forget to make the field interactive to be able to click on the tooltip\n * @param url\n * @returns\n */\nexport function docsTip(url?: string) {\n  const docsUrl = 'https://grafana.com/docs/grafana/latest/datasources/prometheus/#configure-the-data-source';\n\n  return (\n    <a href={url ? url : docsUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n      Visit docs for more details here.\n    </a>\n  );\n}\n\nexport const validateInput = (\n  input: string,\n  pattern: string | RegExp,\n  errorMessage?: string\n): boolean | JSX.Element => {\n  const defaultErrorMessage = 'Value is not valid';\n  if (input && !input.match(pattern)) {\n    return <FieldValidationMessage>{errorMessage ? errorMessage : defaultErrorMessage}</FieldValidationMessage>;\n  } else {\n    return true;\n  }\n};\n\nexport function overhaulStyles(theme: GrafanaTheme2) {\n  return {\n    additionalSettings: css`\n      margin-bottom: 25px;\n    `,\n    secondaryGrey: css`\n      color: ${theme.colors.secondary.text};\n      opacity: 65%;\n    `,\n    inlineError: css`\n      margin: 0px 0px 4px 245px;\n    `,\n    switchField: css`\n      align-items: center;\n    `,\n    sectionHeaderPadding: css`\n      padding-top: 32px;\n    `,\n    sectionBottomPadding: css`\n      padding-bottom: 28px;\n    `,\n    subsectionText: css`\n      font-size: 12px;\n    `,\n    hrBottomSpace: css`\n      margin-bottom: 56px;\n    `,\n    hrTopSpace: css`\n      margin-top: 50px;\n    `,\n    textUnderline: css`\n      text-decoration: underline;\n    `,\n    versionMargin: css`\n      margin-bottom: 12px;\n    `,\n    advancedHTTPSettingsMargin: css`\n      margin: 24px 0 8px 0;\n    `,\n    advancedSettings: css`\n      padding-top: 32px;\n    `,\n    alertingTop: css`\n      margin-top: 40px !important;\n    `,\n    overhaulPageHeading: css`\n      font-weight: 400;\n    `,\n    container: css`\n      maxwidth: 578;\n    `,\n  };\n}\n","import { css } from '@emotion/css';\nimport React, { ReactElement } from 'react';\nimport Highlighter from 'react-highlight-words';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Icon, Tooltip, useTheme2 } from '@grafana/ui';\n\nimport { docsTip } from '../../../configuration/ConfigEditor';\nimport { PromVisualQuery } from '../../types';\n\nimport { tracking } from './state/helpers';\nimport { MetricsModalState } from './state/state';\nimport { MetricData, MetricsData } from './types';\n\ntype ResultsTableProps = {\n  metrics: MetricsData;\n  onChange: (query: PromVisualQuery) => void;\n  onClose: () => void;\n  query: PromVisualQuery;\n  state: MetricsModalState;\n  disableTextWrap: boolean;\n};\n\nexport function ResultsTable(props: ResultsTableProps) {\n  const { metrics, onChange, onClose, query, state, disableTextWrap } = props;\n\n  const theme = useTheme2();\n  const styles = getStyles(theme, disableTextWrap);\n\n  function selectMetric(metric: MetricData) {\n    if (metric.value) {\n      onChange({ ...query, metric: metric.value });\n      tracking('grafana_prom_metric_encycopedia_tracking', state, metric.value);\n      onClose();\n    }\n  }\n\n  function metaRows(metric: MetricData) {\n    if (state.fullMetaSearch && metric) {\n      return (\n        <>\n          <td>{displayType(metric.type ?? '')}</td>\n          <td>\n            <Highlighter\n              textToHighlight={metric.description ?? ''}\n              searchWords={state.metaHaystackMatches}\n              autoEscape\n              highlightClassName={styles.matchHighLight}\n            />\n          </td>\n        </>\n      );\n    } else {\n      return (\n        <>\n          <td>{displayType(metric.type ?? '')}</td>\n          <td>{metric.description ?? ''}</td>\n        </>\n      );\n    }\n  }\n\n  function addHelpIcon(fullType: string, descriptiveType: string, link: string) {\n    return (\n      <>\n        {fullType}\n        <span className={styles.tooltipSpace}>\n          <Tooltip\n            content={\n              <>\n                When creating a {descriptiveType}, Prometheus exposes multiple series with the type counter.{' '}\n                {docsTip(link)}\n              </>\n            }\n            placement=\"bottom-start\"\n            interactive={true}\n          >\n            <Icon name=\"info-circle\" size=\"xs\" />\n          </Tooltip>\n        </span>\n      </>\n    );\n  }\n\n  function displayType(type: string | null) {\n    if (!type) {\n      return '';\n    }\n\n    if (type.includes('(summary)')) {\n      return addHelpIcon(type, 'summary', 'https://prometheus.io/docs/concepts/metric_types/#summary');\n    }\n\n    if (type.includes('(histogram)')) {\n      return addHelpIcon(type, 'histogram', 'https://prometheus.io/docs/concepts/metric_types/#histogram');\n    }\n\n    return type;\n  }\n\n  function noMetricsMessages(): ReactElement {\n    let message;\n\n    if (!state.fuzzySearchQuery) {\n      message = 'There are no metrics found in the data source.';\n    }\n\n    if (query.labels.length > 0) {\n      message = 'There are no metrics found. Try to expand your label filters.';\n    }\n\n    if (state.fuzzySearchQuery || state.selectedTypes.length > 0) {\n      message = 'There are no metrics found. Try to expand your search and filters.';\n    }\n\n    return (\n      <tr className={styles.noResults}>\n        <td colSpan={3}>{message}</td>\n      </tr>\n    );\n  }\n\n  function textHighlight(state: MetricsModalState) {\n    if (state.useBackend) {\n      // highlight the input only for the backend search\n      // this highlight is equivalent to how the metric select highlights\n      // look into matching on regex input\n      return [state.fuzzySearchQuery];\n    } else if (state.fullMetaSearch) {\n      // highlight the matches in the ufuzzy metaHaystack\n      return state.metaHaystackMatches;\n    } else {\n      // highlight the ufuzzy name matches\n      return state.nameHaystackMatches;\n    }\n  }\n\n  return (\n    <table className={styles.table}>\n      <thead className={styles.stickyHeader}>\n        <tr>\n          <th className={`${styles.nameWidth} ${styles.tableHeaderPadding}`}>Name</th>\n          {state.hasMetadata && (\n            <>\n              <th className={`${styles.typeWidth} ${styles.tableHeaderPadding}`}>Type</th>\n              <th className={`${styles.descriptionWidth} ${styles.tableHeaderPadding}`}>Description</th>\n            </>\n          )}\n          <th className={styles.selectButtonWidth}> </th>\n        </tr>\n      </thead>\n      <tbody>\n        <>\n          {metrics.length > 0 &&\n            metrics.map((metric: MetricData, idx: number) => {\n              return (\n                <tr key={metric?.value ?? idx} className={styles.row}>\n                  <td className={styles.nameOverflow}>\n                    <Highlighter\n                      textToHighlight={metric?.value ?? ''}\n                      searchWords={textHighlight(state)}\n                      autoEscape\n                      highlightClassName={styles.matchHighLight}\n                    />\n                  </td>\n                  {state.hasMetadata && metaRows(metric)}\n                  <td>\n                    <Button\n                      size=\"md\"\n                      variant=\"secondary\"\n                      onClick={() => selectMetric(metric)}\n                      className={styles.centerButton}\n                    >\n                      Select\n                    </Button>\n                  </td>\n                </tr>\n              );\n            })}\n          {metrics.length === 0 && !state.isLoading && noMetricsMessages()}\n        </>\n      </tbody>\n    </table>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2, disableTextWrap: boolean) => {\n  return {\n    table: css`\n      ${disableTextWrap ? '' : 'table-layout: fixed;'}\n      border-radius: ${theme.shape.radius.default};\n      width: 100%;\n      white-space: ${disableTextWrap ? 'nowrap' : 'normal'};\n      td {\n        padding: ${theme.spacing(1)};\n      }\n\n      td,\n      th {\n        min-width: ${theme.spacing(3)};\n        border-bottom: 1px solid ${theme.colors.border.weak};\n      }\n    `,\n    row: css`\n      label: row;\n      border-bottom: 1px solid ${theme.colors.border.weak}\n      &:last-child {\n        border-bottom: 0;\n      }\n    `,\n    tableHeaderPadding: css`\n      padding: 8px;\n    `,\n    matchHighLight: css`\n      background: inherit;\n      color: ${theme.components.textHighlight.text};\n      background-color: ${theme.components.textHighlight.background};\n    `,\n    nameWidth: css`\n      ${disableTextWrap ? '' : 'width: 37.5%;'}\n    `,\n    nameOverflow: css`\n      ${disableTextWrap ? '' : 'overflow-wrap: anywhere;'}\n    `,\n    typeWidth: css`\n      ${disableTextWrap ? '' : 'width: 15%;'}\n    `,\n    descriptionWidth: css`\n      ${disableTextWrap ? '' : 'width: 35%;'}\n    `,\n    selectButtonWidth: css`\n      ${disableTextWrap ? '' : 'width: 12.5%;'}\n    `,\n    stickyHeader: css`\n      position: sticky;\n      top: 0;\n      background-color: ${theme.colors.background.primary};\n    `,\n    noResults: css`\n      text-align: center;\n      color: ${theme.colors.text.secondary};\n    `,\n    tooltipSpace: css`\n      margin-left: 4px;\n    `,\n    centerButton: css`\n      display: block;\n      margin: auto;\n      border: none;\n    `,\n  };\n};\n","import { SelectableValue } from '@grafana/data';\n\nimport { PromVisualQuery } from '../../../types';\nimport { HaystackDictionary, MetricsData } from '../types';\n\nexport const DEFAULT_RESULTS_PER_PAGE = 100;\nexport const MAXIMUM_RESULTS_PER_PAGE = 1000;\n\n/**\n * Initial state for the metrics explorer\n * @returns\n */\nexport function initialState(query?: PromVisualQuery): MetricsModalState {\n  return {\n    isLoading: true,\n    metrics: [],\n    hasMetadata: true,\n    metaHaystackDictionary: {},\n    metaHaystackMatches: [],\n    metaHaystackOrder: [],\n    nameHaystackDictionary: {},\n    nameHaystackOrder: [],\n    nameHaystackMatches: [],\n    totalMetricCount: 0,\n    filteredMetricCount: null,\n    resultsPerPage: DEFAULT_RESULTS_PER_PAGE,\n    pageNum: 1,\n    fuzzySearchQuery: '',\n    fullMetaSearch: query?.fullMetaSearch ?? false,\n    includeNullMetadata: query?.includeNullMetadata ?? true,\n    selectedTypes: [],\n    useBackend: query?.useBackend ?? false,\n    disableTextWrap: query?.disableTextWrap ?? false,\n    showAdditionalSettings: false,\n  };\n}\n\n/**\n * The metrics explorer state object\n */\nexport interface MetricsModalState {\n  /** Used for the loading spinner */\n  isLoading: boolean;\n  /**\n   * Initial collection of metrics.\n   * The frontend filters do not impact this, but\n   * it is reduced by the backend search.\n   */\n  metrics: MetricsData;\n  /** Field for disabling type select and switches that rely on metadata */\n  hasMetadata: boolean;\n  /** Used to display metrics and help with fuzzy order */\n  nameHaystackDictionary: HaystackDictionary;\n  /** Used to sort name fuzzy search by relevance */\n  nameHaystackOrder: string[];\n  /** Used to highlight text in fuzzy matches */\n  nameHaystackMatches: string[];\n  /** Used to display metrics and help with fuzzy order for search across all metadata */\n  metaHaystackDictionary: HaystackDictionary;\n  /** Used to sort meta fuzzy search by relevance */\n  metaHaystackOrder: string[];\n  /** Used to highlight text in fuzzy matches */\n  metaHaystackMatches: string[];\n  /** Total results computed on initialization */\n  totalMetricCount: number;\n  /** Set after filtering metrics */\n  filteredMetricCount: number | null;\n  /** Pagination field for showing results in table */\n  resultsPerPage: number;\n  /** Pagination field */\n  pageNum: number;\n  /** The text query used to match metrics */\n  fuzzySearchQuery: string;\n  /** Enables the fuzzy meatadata search */\n  fullMetaSearch: boolean;\n  /** Includes results that are missing type and description */\n  includeNullMetadata: boolean;\n  /** Filter by prometheus type */\n  selectedTypes: Array<SelectableValue<string>>;\n  /** Filter by the series match endpoint instead of the fuzzy search */\n  useBackend: boolean;\n  /** Disable text wrap for descriptions in the results table */\n  disableTextWrap: boolean;\n  /** Display toggle switches for settings */\n  showAdditionalSettings: boolean;\n}\n\n/**\n * Type for the useEffect get metadata function\n */\nexport type MetricsModalMetadata = {\n  isLoading: boolean;\n  metrics: MetricsData;\n  hasMetadata: boolean;\n  metaHaystackDictionary: HaystackDictionary;\n  nameHaystackDictionary: HaystackDictionary;\n  totalMetricCount: number;\n  filteredMetricCount: number | null;\n};\n\n// for updating the settings in the PromQuery model\nexport function getSettings(visQuery: PromVisualQuery): MetricsModalSettings {\n  return {\n    useBackend: visQuery?.useBackend ?? false,\n    disableTextWrap: visQuery?.disableTextWrap ?? false,\n    fullMetaSearch: visQuery?.fullMetaSearch ?? false,\n    includeNullMetadata: visQuery.includeNullMetadata ?? false,\n  };\n}\n\nexport type MetricsModalSettings = {\n  useBackend?: boolean;\n  disableTextWrap?: boolean;\n  fullMetaSearch?: boolean;\n  includeNullMetadata?: boolean;\n};\n","import { css } from '@emotion/css';\n\nimport { GrafanaTheme2 } from '@grafana/data';\n\nexport const getStyles = (theme: GrafanaTheme2, disableTextWrap: boolean) => {\n  return {\n    modal: css`\n      width: 85vw;\n      ${theme.breakpoints.down('md')} {\n        width: 100%;\n      }\n      ${theme.breakpoints.up('xl')} {\n        width: 60%;\n      }\n    `,\n    inputWrapper: css`\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n    `,\n    inputItemFirst: css`\n      flex-basis: 40%;\n      padding-right: 16px;\n      ${theme.breakpoints.down('md')} {\n        padding-right: 0px;\n        padding-bottom: 16px;\n      }\n    `,\n    inputItem: css`\n      flex-grow: 1;\n      flex-basis: 20%;\n      ${theme.breakpoints.down('md')} {\n        min-width: 100%;\n      }\n    `,\n    selectWrapper: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n    resultsAmount: css`\n      color: ${theme.colors.text.secondary};\n      font-size: 0.85rem;\n      padding: 0 0 4px 0;\n    `,\n    resultsData: css`\n      margin: 4px 0 ${theme.spacing(2)} 0;\n    `,\n    resultsDataCount: css`\n      margin: 0;\n    `,\n    resultsDataFiltered: css`\n      color: ${theme.colors.text.secondary};\n      text-align: center;\n      border: solid 1px rgba(204, 204, 220, 0.25);\n      padding: 7px;\n    `,\n    resultsDataFilteredText: css`\n      display: inline;\n      vertical-align: text-top;\n    `,\n    results: css`\n      height: calc(80vh - 310px);\n      overflow-y: scroll;\n    `,\n    resultsFooter: css`\n      margin-top: 24px;\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      justify-content: space-between;\n      align-items: center;\n      position: sticky;\n    `,\n    currentlySelected: css`\n      color: grey;\n      opacity: 75%;\n      font-size: 0.75rem;\n    `,\n    loadingSpinner: css`\n      visibility: hidden;\n    `,\n    visible: css`\n      visibility: visible;\n    `,\n    settingsBtn: css`\n      float: right;\n    `,\n    noBorder: css`\n      border: none;\n    `,\n    resultsPerPageLabel: css`\n      color: ${theme.colors.text.secondary};\n      opacity: 75%;\n      padding-top: 5px;\n      font-size: 0.85rem;\n      margin-right: 8px;\n    `,\n    resultsPerPageWrapper: css`\n      display: flex;\n    `,\n  };\n};\n","import uFuzzy from '@leeoniya/ufuzzy';\nimport { debounce as debounceLodash } from 'lodash';\n\nconst uf = new uFuzzy({\n  intraMode: 1,\n  intraIns: 1,\n  intraSub: 1,\n  intraTrn: 1,\n  intraDel: 1,\n});\n\nexport function fuzzySearch(haystack: string[], query: string, dispatcher: (data: string[][]) => void) {\n  const [idxs, info, order] = uf.search(haystack, query, 0, 1e5);\n\n  let haystackOrder: string[] = [];\n  let matchesSet: Set<string> = new Set();\n  if (idxs && order) {\n    /**\n     * get the fuzzy matches for hilighting\n     * @param part\n     * @param matched\n     */\n    const mark = (part: string, matched: boolean) => {\n      if (matched) {\n        matchesSet.add(part);\n      }\n    };\n\n    // Iterate to create the order of needles(queries) and the matches\n    for (let i = 0; i < order.length; i++) {\n      let infoIdx = order[i];\n\n      /** Evaluate the match, get the matches for highlighting */\n      uFuzzy.highlight(haystack[info.idx[infoIdx]], info.ranges[infoIdx], mark);\n      /** Get the order */\n      haystackOrder.push(haystack[info.idx[infoIdx]]);\n    }\n\n    dispatcher([haystackOrder, [...matchesSet]]);\n  } else if (!query) {\n    dispatcher([[], []]);\n  }\n}\n\nexport const debouncedFuzzySearch = debounceLodash(fuzzySearch, 300);\n","import { cx } from '@emotion/css';\nimport { PayloadAction, createSlice } from '@reduxjs/toolkit';\nimport debounce from 'debounce-promise';\nimport React, { useCallback, useEffect, useMemo, useReducer } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport {\n  Button,\n  ButtonGroup,\n  Icon,\n  Input,\n  Modal,\n  MultiSelect,\n  Pagination,\n  Spinner,\n  Toggletip,\n  useTheme2,\n} from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../../datasource';\nimport { PromVisualQuery } from '../../types';\n\nimport { AdditionalSettings } from './AdditionalSettings';\nimport { FeedbackLink } from './FeedbackLink';\nimport { ResultsTable } from './ResultsTable';\nimport {\n  calculatePageList,\n  calculateResultsPerPage,\n  displayedMetrics,\n  getBackendSearchMetrics,\n  placeholders,\n  promTypes,\n  setMetrics,\n  tracking,\n} from './state/helpers';\nimport {\n  DEFAULT_RESULTS_PER_PAGE,\n  initialState,\n  MAXIMUM_RESULTS_PER_PAGE,\n  MetricsModalMetadata,\n  // stateSlice,\n} from './state/state';\nimport { getStyles } from './styles';\nimport { MetricsData, PromFilterOption } from './types';\nimport { debouncedFuzzySearch } from './uFuzzy';\n\nexport type MetricsModalProps = {\n  datasource: PrometheusDatasource;\n  isOpen: boolean;\n  query: PromVisualQuery;\n  onClose: () => void;\n  onChange: (query: PromVisualQuery) => void;\n  initialMetrics: string[];\n};\n\nexport const MetricsModal = (props: MetricsModalProps) => {\n  const { datasource, isOpen, onClose, onChange, query, initialMetrics } = props;\n\n  const [state, dispatch] = useReducer(stateSlice.reducer, initialState(query));\n\n  const theme = useTheme2();\n  const styles = getStyles(theme, state.disableTextWrap);\n\n  /**\n   * loads metrics and metadata on opening modal and switching off useBackend\n   */\n  const updateMetricsMetadata = useCallback(async () => {\n    // *** Loading Gif\n    dispatch(setIsLoading(true));\n\n    const data: MetricsModalMetadata = await setMetrics(datasource, query, initialMetrics);\n    dispatch(\n      buildMetrics({\n        isLoading: false,\n        hasMetadata: data.hasMetadata,\n        metrics: data.metrics,\n        metaHaystackDictionary: data.metaHaystackDictionary,\n        nameHaystackDictionary: data.nameHaystackDictionary,\n        totalMetricCount: data.metrics.length,\n        filteredMetricCount: data.metrics.length,\n      })\n    );\n  }, [query, datasource, initialMetrics]);\n\n  useEffect(() => {\n    updateMetricsMetadata();\n  }, [updateMetricsMetadata]);\n\n  const typeOptions: SelectableValue[] = promTypes.map((t: PromFilterOption) => {\n    return {\n      value: t.value,\n      label: t.value,\n      description: t.description,\n    };\n  });\n\n  /**\n   * The backend debounced search\n   */\n  const debouncedBackendSearch = useMemo(\n    () =>\n      debounce(async (metricText: string) => {\n        dispatch(setIsLoading(true));\n\n        const metrics = await getBackendSearchMetrics(metricText, query.labels, datasource);\n\n        dispatch(\n          filterMetricsBackend({\n            metrics: metrics,\n            filteredMetricCount: metrics.length,\n            isLoading: false,\n          })\n        );\n      }, datasource.getDebounceTimeInMilliseconds()),\n    [datasource, query]\n  );\n\n  function fuzzyNameDispatch(haystackData: string[][]) {\n    dispatch(setNameHaystack(haystackData));\n  }\n\n  function fuzzyMetaDispatch(haystackData: string[][]) {\n    dispatch(setMetaHaystack(haystackData));\n  }\n\n  function searchCallback(query: string, fullMetaSearchVal: boolean) {\n    if (state.useBackend && query === '') {\n      // get all metrics data if a user erases everything in the input\n      updateMetricsMetadata();\n    } else if (state.useBackend) {\n      debouncedBackendSearch(query);\n    } else {\n      // search either the names or all metadata\n      // fuzzy search go!\n      if (fullMetaSearchVal) {\n        debouncedFuzzySearch(Object.keys(state.metaHaystackDictionary), query, fuzzyMetaDispatch);\n      } else {\n        debouncedFuzzySearch(Object.keys(state.nameHaystackDictionary), query, fuzzyNameDispatch);\n      }\n    }\n  }\n\n  /* Settings switches */\n  const additionalSettings = (\n    <AdditionalSettings\n      state={state}\n      onChangeFullMetaSearch={() => {\n        const newVal = !state.fullMetaSearch;\n        dispatch(setFullMetaSearch(newVal));\n        onChange({ ...query, fullMetaSearch: newVal });\n        searchCallback(state.fuzzySearchQuery, newVal);\n      }}\n      onChangeIncludeNullMetadata={() => {\n        dispatch(setIncludeNullMetadata(!state.includeNullMetadata));\n        onChange({ ...query, includeNullMetadata: !state.includeNullMetadata });\n      }}\n      onChangeDisableTextWrap={() => {\n        dispatch(setDisableTextWrap());\n        onChange({ ...query, disableTextWrap: !state.disableTextWrap });\n        tracking('grafana_prom_metric_encycopedia_disable_text_wrap_interaction', state, '');\n      }}\n      onChangeUseBackend={() => {\n        const newVal = !state.useBackend;\n        dispatch(setUseBackend(newVal));\n        onChange({ ...query, useBackend: newVal });\n        if (newVal === false) {\n          // rebuild the metrics metadata if we turn off useBackend\n          updateMetricsMetadata();\n        } else {\n          // check if there is text in the browse search and update\n          if (state.fuzzySearchQuery !== '') {\n            debouncedBackendSearch(state.fuzzySearchQuery);\n          }\n          // otherwise wait for user typing\n        }\n      }}\n    />\n  );\n\n  return (\n    <Modal\n      data-testid={metricsModaltestIds.metricModal}\n      isOpen={isOpen}\n      title=\"Metrics explorer\"\n      onDismiss={onClose}\n      aria-label=\"Browse metrics\"\n      className={styles.modal}\n    >\n      <FeedbackLink feedbackUrl=\"https://forms.gle/DEMAJHoAMpe3e54CA\" />\n      <div\n        className={styles.inputWrapper}\n        data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.metricsExplorer}\n      >\n        <div className={cx(styles.inputItem, styles.inputItemFirst)}>\n          <Input\n            autoFocus={true}\n            data-testid={metricsModaltestIds.searchMetric}\n            placeholder={placeholders.browse}\n            value={state.fuzzySearchQuery}\n            onInput={(e) => {\n              const value = e.currentTarget.value ?? '';\n              dispatch(setFuzzySearchQuery(value));\n              searchCallback(value, state.fullMetaSearch);\n            }}\n          />\n        </div>\n        {state.hasMetadata && (\n          <div className={styles.inputItem}>\n            <MultiSelect\n              data-testid={metricsModaltestIds.selectType}\n              inputId=\"my-select\"\n              options={typeOptions}\n              value={state.selectedTypes}\n              placeholder={placeholders.type}\n              onChange={(v) => dispatch(setSelectedTypes(v))}\n            />\n          </div>\n        )}\n        <div>\n          <Spinner className={`${styles.loadingSpinner} ${state.isLoading ? styles.visible : ''}`} />\n        </div>\n        <div className={styles.inputItem}>\n          <Toggletip\n            aria-label=\"Additional settings\"\n            content={additionalSettings}\n            placement=\"bottom-end\"\n            closeButton={false}\n          >\n            <ButtonGroup className={styles.settingsBtn}>\n              <Button\n                variant=\"secondary\"\n                size=\"md\"\n                onClick={() => dispatch(showAdditionalSettings())}\n                data-testid={metricsModaltestIds.showAdditionalSettings}\n                className={styles.noBorder}\n              >\n                Additional Settings\n              </Button>\n              <Button\n                className={styles.noBorder}\n                variant=\"secondary\"\n                icon={state.showAdditionalSettings ? 'angle-up' : 'angle-down'}\n              />\n            </ButtonGroup>\n          </Toggletip>\n        </div>\n      </div>\n      <div className={styles.resultsData}>\n        {query.metric && <i className={styles.currentlySelected}>Currently selected: {query.metric}</i>}\n        {query.labels.length > 0 && (\n          <div className={styles.resultsDataFiltered}>\n            <Icon name=\"info-circle\" size=\"sm\" />\n            <div className={styles.resultsDataFilteredText}>\n              &nbsp;These metrics have been pre-filtered by labels chosen in the label filters.\n            </div>\n          </div>\n        )}\n      </div>\n      <div className={styles.results}>\n        {state.metrics && (\n          <ResultsTable\n            metrics={displayedMetrics(state, dispatch)}\n            onChange={onChange}\n            onClose={onClose}\n            query={query}\n            state={state}\n            disableTextWrap={state.disableTextWrap}\n          />\n        )}\n      </div>\n      <div className={styles.resultsFooter}>\n        <div className={styles.resultsAmount}>\n          Showing {state.filteredMetricCount} of {state.totalMetricCount} results\n        </div>\n        <Pagination\n          currentPage={state.pageNum ?? 1}\n          numberOfPages={calculatePageList(state).length}\n          onNavigate={(val: number) => {\n            const page = val ?? 1;\n            dispatch(setPageNum(page));\n          }}\n        />\n        <div className={styles.resultsPerPageWrapper}>\n          <p className={styles.resultsPerPageLabel}># Results per page&nbsp;</p>\n          <Input\n            data-testid={metricsModaltestIds.resultsPerPage}\n            value={calculateResultsPerPage(state.resultsPerPage, DEFAULT_RESULTS_PER_PAGE, MAXIMUM_RESULTS_PER_PAGE)}\n            placeholder=\"results per page\"\n            width={10}\n            title={'The maximum results per page is ' + MAXIMUM_RESULTS_PER_PAGE}\n            type=\"number\"\n            onInput={(e) => {\n              const value = +e.currentTarget.value;\n\n              if (isNaN(value) || value >= MAXIMUM_RESULTS_PER_PAGE) {\n                return;\n              }\n\n              dispatch(setResultsPerPage(value));\n            }}\n          />\n        </div>\n      </div>\n    </Modal>\n  );\n};\n\nexport const metricsModaltestIds = {\n  metricModal: 'metric-modal',\n  searchMetric: 'search-metric',\n  searchWithMetadata: 'search-with-metadata',\n  selectType: 'select-type',\n  metricCard: 'metric-card',\n  useMetric: 'use-metric',\n  searchPage: 'search-page',\n  resultsPerPage: 'results-per-page',\n  setUseBackend: 'set-use-backend',\n  showAdditionalSettings: 'show-additional-settings',\n};\n\nconst stateSlice = createSlice({\n  name: 'metrics-modal-state',\n  initialState: initialState(),\n  reducers: {\n    filterMetricsBackend: (\n      state,\n      action: PayloadAction<{\n        metrics: MetricsData;\n        filteredMetricCount: number;\n        isLoading: boolean;\n      }>\n    ) => {\n      state.metrics = action.payload.metrics;\n      state.filteredMetricCount = action.payload.filteredMetricCount;\n      state.isLoading = action.payload.isLoading;\n    },\n    buildMetrics: (state, action: PayloadAction<MetricsModalMetadata>) => {\n      state.isLoading = action.payload.isLoading;\n      state.metrics = action.payload.metrics;\n      state.hasMetadata = action.payload.hasMetadata;\n      state.metaHaystackDictionary = action.payload.metaHaystackDictionary;\n      state.nameHaystackDictionary = action.payload.nameHaystackDictionary;\n      state.totalMetricCount = action.payload.totalMetricCount;\n      state.filteredMetricCount = action.payload.filteredMetricCount;\n    },\n    setIsLoading: (state, action: PayloadAction<boolean>) => {\n      state.isLoading = action.payload;\n    },\n    setFilteredMetricCount: (state, action: PayloadAction<number>) => {\n      state.filteredMetricCount = action.payload;\n    },\n    setResultsPerPage: (state, action: PayloadAction<number>) => {\n      state.resultsPerPage = action.payload;\n    },\n    setPageNum: (state, action: PayloadAction<number>) => {\n      state.pageNum = action.payload;\n    },\n    setFuzzySearchQuery: (state, action: PayloadAction<string>) => {\n      state.fuzzySearchQuery = action.payload;\n      state.pageNum = 1;\n    },\n    setNameHaystack: (state, action: PayloadAction<string[][]>) => {\n      state.nameHaystackOrder = action.payload[0];\n      state.nameHaystackMatches = action.payload[1];\n    },\n    setMetaHaystack: (state, action: PayloadAction<string[][]>) => {\n      state.metaHaystackOrder = action.payload[0];\n      state.metaHaystackMatches = action.payload[1];\n    },\n    setFullMetaSearch: (state, action: PayloadAction<boolean>) => {\n      state.fullMetaSearch = action.payload;\n      state.pageNum = 1;\n    },\n    setIncludeNullMetadata: (state, action: PayloadAction<boolean>) => {\n      state.includeNullMetadata = action.payload;\n      state.pageNum = 1;\n    },\n    setSelectedTypes: (state, action: PayloadAction<Array<SelectableValue<string>>>) => {\n      state.selectedTypes = action.payload;\n      state.pageNum = 1;\n    },\n    setUseBackend: (state, action: PayloadAction<boolean>) => {\n      state.useBackend = action.payload;\n      state.fullMetaSearch = false;\n      state.pageNum = 1;\n    },\n    setDisableTextWrap: (state) => {\n      state.disableTextWrap = !state.disableTextWrap;\n    },\n    showAdditionalSettings: (state) => {\n      state.showAdditionalSettings = !state.showAdditionalSettings;\n    },\n  },\n});\n\n// actions to update the state\nexport const {\n  setIsLoading,\n  buildMetrics,\n  filterMetricsBackend,\n  setResultsPerPage,\n  setPageNum,\n  setFuzzySearchQuery,\n  setNameHaystack,\n  setMetaHaystack,\n  setFullMetaSearch,\n  setIncludeNullMetadata,\n  setSelectedTypes,\n  setUseBackend,\n  setDisableTextWrap,\n  showAdditionalSettings,\n  setFilteredMetricCount,\n} = stateSlice.actions;\n","import { css } from '@emotion/css';\nimport debounce from 'debounce-promise';\nimport React, { RefCallback, useCallback, useState } from 'react';\nimport Highlighter from 'react-highlight-words';\n\nimport { GrafanaTheme2, SelectableValue, toOption } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField, EditorFieldGroup } from '@grafana/experimental';\nimport { config } from '@grafana/runtime';\nimport {\n  AsyncSelect,\n  Button,\n  CustomScrollbar,\n  FormatOptionLabelMeta,\n  getSelectStyles,\n  Icon,\n  InlineField,\n  InlineFieldRow,\n  useStyles2,\n  useTheme2,\n} from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { SelectMenuOptions } from '../../gcopypaste/packages/grafana-ui/src/components/Select/SelectBase';\nimport { truncateResult } from '../../language_utils';\nimport { regexifyLabelValuesQueryString } from '../parsingUtils';\nimport { QueryBuilderLabelFilter } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { MetricsModal } from './metrics-modal/MetricsModal';\nimport { tracking } from './metrics-modal/state/helpers';\n\n// We are matching words split with space\nconst splitSeparator = ' ';\n\nexport interface MetricSelectProps {\n  metricLookupDisabled: boolean;\n  query: PromVisualQuery;\n  onChange: (query: PromVisualQuery) => void;\n  onGetMetrics: () => Promise<SelectableValue[]>;\n  datasource: PrometheusDatasource;\n  labelsFilters: QueryBuilderLabelFilter[];\n  onBlur?: () => void;\n  variableEditor?: boolean;\n}\n\nexport const PROMETHEUS_QUERY_BUILDER_MAX_RESULTS = 1000;\n\nexport function MetricSelect({\n  datasource,\n  query,\n  onChange,\n  onGetMetrics,\n  labelsFilters,\n  metricLookupDisabled,\n  onBlur,\n  variableEditor,\n}: MetricSelectProps) {\n  const styles = useStyles2(getStyles);\n  const [state, setState] = useState<{\n    metrics?: Array<SelectableValue<any>>;\n    isLoading?: boolean;\n    metricsModalOpen?: boolean;\n    initialMetrics?: string[];\n    resultsTruncated?: boolean;\n  }>({});\n\n  const prometheusMetricEncyclopedia = config.featureToggles.prometheusMetricEncyclopedia;\n\n  const metricsModalOption: SelectableValue[] = [\n    {\n      value: 'BrowseMetrics',\n      label: 'Metrics explorer',\n      description: 'Browse and filter all metrics and metadata with a fuzzy search',\n    },\n  ];\n\n  const customFilterOption = useCallback(\n    (option: SelectableValue<any>, searchQuery: string) => {\n      const label = option.label ?? option.value;\n      if (!label) {\n        return false;\n      }\n\n      // custom value is not a string label but a react node\n      if (!label.toLowerCase) {\n        return true;\n      }\n\n      const searchWords = searchQuery.split(splitSeparator);\n\n      return searchWords.reduce((acc, cur) => {\n        const matcheSearch = label.toLowerCase().includes(cur.toLowerCase());\n\n        let browseOption = false;\n        if (prometheusMetricEncyclopedia) {\n          browseOption = label === 'Metrics explorer';\n        }\n\n        return acc && (matcheSearch || browseOption);\n      }, true);\n    },\n    [prometheusMetricEncyclopedia]\n  );\n\n  const formatOptionLabel = useCallback(\n    (option: SelectableValue<any>, meta: FormatOptionLabelMeta<any>) => {\n      // For newly created custom value we don't want to add highlight\n      if (option['__isNew__']) {\n        return option.label;\n      }\n      // only matches on input, does not match on regex\n      // look into matching for regex input\n      return (\n        <Highlighter\n          searchWords={meta.inputValue.split(splitSeparator)}\n          textToHighlight={option.label ?? ''}\n          highlightClassName={styles.highlight}\n        />\n      );\n    },\n    [styles.highlight]\n  );\n\n  /**\n   * Reformat the query string and label filters to return all valid results for current query editor state\n   */\n  const formatKeyValueStringsForLabelValuesQuery = (\n    query: string,\n    labelsFilters?: QueryBuilderLabelFilter[]\n  ): string => {\n    const queryString = regexifyLabelValuesQueryString(query);\n\n    return formatPrometheusLabelFiltersToString(queryString, labelsFilters);\n  };\n\n  /**\n   * Gets label_values response from prometheus API for current autocomplete query string and any existing labels filters\n   */\n  const getMetricLabels = (query: string) => {\n    // Since some customers can have millions of metrics, whenever the user changes the autocomplete text we want to call the backend and request all metrics that match the current query string\n    const results = datasource.metricFindQuery(formatKeyValueStringsForLabelValuesQuery(query, labelsFilters));\n    return results.then((results) => {\n      const resultsLength = results.length;\n      truncateResult(results);\n\n      if (resultsLength > results.length) {\n        setState({ ...state, resultsTruncated: true });\n      } else {\n        setState({ ...state, resultsTruncated: false });\n      }\n\n      const resultsOptions = results.map((result) => {\n        return {\n          label: result.text,\n          value: result.text,\n        };\n      });\n\n      if (prometheusMetricEncyclopedia) {\n        return [...metricsModalOption, ...resultsOptions];\n      } else {\n        return resultsOptions;\n      }\n    });\n  };\n\n  // When metric and label lookup is disabled we won't request labels\n  const metricLookupDisabledSearch = () => Promise.resolve([]);\n\n  const debouncedSearch = debounce(\n    (query: string) => getMetricLabels(query),\n    datasource.getDebounceTimeInMilliseconds()\n  );\n\n  // No type found for the common select props so typing as any\n  // https://github.com/grafana/grafana/blob/main/packages/grafana-ui/src/components/Select/SelectBase.tsx/#L212-L263\n  // eslint-disable-next-line\n  const CustomOption = (props: any) => {\n    const option = props.data;\n\n    if (option.value === 'BrowseMetrics') {\n      const isFocused = props.isFocused ? styles.focus : '';\n\n      return (\n        // TODO: fix keyboard a11y\n        // eslint-disable-next-line jsx-a11y/no-static-element-interactions\n        <div\n          {...props.innerProps}\n          ref={props.innerRef}\n          className={`${styles.customOptionWidth} metric-encyclopedia-open`}\n          aria-label=\"Select option\"\n          onKeyDown={(e) => {\n            // if there is no metric and the m.e. is enabled, open the modal\n            if (e.code === 'Enter') {\n              setState({ ...state, metricsModalOpen: true });\n            }\n          }}\n        >\n          {\n            <div className={`${styles.customOption} ${isFocused} metric-encyclopedia-open`}>\n              <div>\n                <div className=\"metric-encyclopedia-open\">{option.label}</div>\n                <div className={`${styles.customOptionDesc} metric-encyclopedia-open`}>{option.description}</div>\n              </div>\n              <Button\n                fill=\"text\"\n                size=\"sm\"\n                variant=\"secondary\"\n                onClick={() => setState({ ...state, metricsModalOpen: true })}\n                className=\"metric-encyclopedia-open\"\n              >\n                Open\n                <Icon name=\"arrow-right\" />\n              </Button>\n            </div>\n          }\n        </div>\n      );\n    }\n\n    return SelectMenuOptions(props);\n  };\n\n  interface SelectMenuProps {\n    maxHeight: number;\n    innerRef: RefCallback<HTMLDivElement>;\n    innerProps: {};\n  }\n\n  const CustomMenu = ({ children, maxHeight, innerRef, innerProps }: React.PropsWithChildren<SelectMenuProps>) => {\n    const theme = useTheme2();\n    const stylesMenu = getSelectStyles(theme);\n\n    // Show the results trucated warning only if the options are loaded and the results are truncated\n    // The children are a react node(options loading node) or an array(not a valid element)\n    const optionsLoaded = !React.isValidElement(children) && state.resultsTruncated;\n\n    return (\n      <div\n        {...innerProps}\n        className={`${stylesMenu.menu} ${styles.customMenuContainer}`}\n        style={{ maxHeight }}\n        aria-label=\"Select options menu\"\n      >\n        <CustomScrollbar scrollRefCallback={innerRef} autoHide={false} autoHeightMax=\"inherit\" hideHorizontalTrack>\n          {children}\n        </CustomScrollbar>\n        {optionsLoaded && (\n          <div className={styles.customMenuFooter}>\n            <div>\n              Only the top 1000 metrics are displayed in the metric select. Use the metrics explorer to view all\n              metrics.\n            </div>\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  const asyncSelect = () => {\n    return (\n      <AsyncSelect\n        data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.metricSelect}\n        isClearable={variableEditor ? true : false}\n        inputId=\"prometheus-metric-select\"\n        className={styles.select}\n        value={query.metric ? toOption(query.metric) : undefined}\n        placeholder={'Select metric'}\n        allowCustomValue\n        formatOptionLabel={formatOptionLabel}\n        filterOption={customFilterOption}\n        onOpenMenu={async () => {\n          if (metricLookupDisabled) {\n            return;\n          }\n          setState({ isLoading: true });\n          const metrics = await onGetMetrics();\n          const initialMetrics: string[] = metrics.map((m) => m.value);\n          const resultsLength = metrics.length;\n\n          if (metrics.length > PROMETHEUS_QUERY_BUILDER_MAX_RESULTS) {\n            truncateResult(metrics);\n          }\n\n          if (prometheusMetricEncyclopedia) {\n            setState({\n              // add the modal butoon option to the options\n              metrics: [...metricsModalOption, ...metrics],\n              isLoading: undefined,\n              // pass the initial metrics into the metrics explorer\n              initialMetrics: initialMetrics,\n              resultsTruncated: resultsLength > metrics.length,\n            });\n          } else {\n            setState({\n              metrics,\n              isLoading: undefined,\n              resultsTruncated: resultsLength > metrics.length,\n            });\n          }\n        }}\n        loadOptions={metricLookupDisabled ? metricLookupDisabledSearch : debouncedSearch}\n        isLoading={state.isLoading}\n        defaultOptions={state.metrics}\n        onChange={(input) => {\n          const value = input?.value;\n          if (value) {\n            // if there is no metric and the m.e. is enabled, open the modal\n            if (prometheusMetricEncyclopedia && value === 'BrowseMetrics') {\n              tracking('grafana_prometheus_metric_encyclopedia_open', null, '', query);\n              setState({ ...state, metricsModalOpen: true });\n            } else {\n              onChange({ ...query, metric: value });\n            }\n          } else {\n            onChange({ ...query, metric: '' });\n          }\n        }}\n        components={\n          prometheusMetricEncyclopedia ? { Option: CustomOption, MenuList: CustomMenu } : { MenuList: CustomMenu }\n        }\n        onBlur={onBlur ? onBlur : () => {}}\n      />\n    );\n  };\n\n  return (\n    <>\n      {prometheusMetricEncyclopedia && !datasource.lookupsDisabled && state.metricsModalOpen && (\n        <MetricsModal\n          datasource={datasource}\n          isOpen={state.metricsModalOpen}\n          onClose={() => setState({ ...state, metricsModalOpen: false })}\n          query={query}\n          onChange={onChange}\n          initialMetrics={state.initialMetrics ?? []}\n        />\n      )}\n      {/* format the ui for either the query editor or the variable editor */}\n      {variableEditor ? (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Metric\"\n            labelWidth={20}\n            tooltip={<div>Optional: returns a list of label values for the label name in the specified metric.</div>}\n          >\n            {asyncSelect()}\n          </InlineField>\n        </InlineFieldRow>\n      ) : (\n        <EditorFieldGroup>\n          <EditorField label=\"Metric\">{asyncSelect()}</EditorField>\n        </EditorFieldGroup>\n      )}\n    </>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  select: css`\n    min-width: 125px;\n  `,\n  highlight: css`\n    label: select__match-highlight;\n    background: inherit;\n    padding: inherit;\n    color: ${theme.colors.warning.contrastText};\n    background-color: ${theme.colors.warning.main};\n  `,\n  customOption: css`\n    padding: 8px;\n    display: flex;\n    justify-content: space-between;\n    cursor: pointer;\n    :hover {\n      background-color: ${theme.colors.emphasize(theme.colors.background.primary, 0.1)};\n    }\n  `,\n  customOptionlabel: css`\n    color: ${theme.colors.text.primary};\n  `,\n  customOptionDesc: css`\n    color: ${theme.colors.text.secondary};\n    font-size: ${theme.typography.size.xs};\n    opacity: 50%;\n  `,\n  focus: css`\n    background-color: ${theme.colors.emphasize(theme.colors.background.primary, 0.1)};\n  `,\n  customOptionWidth: css`\n    min-width: 400px;\n  `,\n  customMenuFooter: css`\n    flex: 0;\n    display: flex;\n    justify-content: space-between;\n    padding: ${theme.spacing(1.5)};\n    border-top: 1px solid ${theme.colors.border.weak};\n    color: ${theme.colors.text.secondary};\n  `,\n  customMenuContainer: css`\n    display: flex;\n    flex-direction: column;\n    background: ${theme.colors.background.primary};\n    box-shadow: ${theme.shadows.z3};\n  `,\n});\n\nexport const formatPrometheusLabelFiltersToString = (\n  queryString: string,\n  labelsFilters: QueryBuilderLabelFilter[] | undefined\n): string => {\n  const filterArray = labelsFilters ? formatPrometheusLabelFilters(labelsFilters) : [];\n\n  return `label_values({__name__=~\".*${queryString}\"${filterArray ? filterArray.join('') : ''}},__name__)`;\n};\n\nexport const formatPrometheusLabelFilters = (labelsFilters: QueryBuilderLabelFilter[]): string[] => {\n  return labelsFilters.map((label) => {\n    return `,${label.label}=\"${label.value}\"`;\n  });\n};\n","import { invert } from 'lodash';\nimport { Token } from 'prismjs';\n\nimport {\n  AbstractLabelMatcher,\n  AbstractLabelOperator,\n  AbstractQuery,\n  DataQuery,\n  dateMath,\n  DateTime,\n  incrRoundDn,\n  TimeRange,\n} from '@grafana/data';\n\nimport { addLabelToQuery } from './add_label_to_query';\nimport { SUGGESTIONS_LIMIT } from './language_provider';\nimport { PROMETHEUS_QUERY_BUILDER_MAX_RESULTS } from './querybuilder/components/MetricSelect';\nimport { PrometheusCacheLevel, PromMetricsMetadata, PromMetricsMetadataItem } from './types';\n\nexport const processHistogramMetrics = (metrics: string[]) => {\n  const resultSet: Set<string> = new Set();\n  const regexp = new RegExp('_bucket($|:)');\n  for (let index = 0; index < metrics.length; index++) {\n    const metric = metrics[index];\n    const isHistogramValue = regexp.test(metric);\n    if (isHistogramValue) {\n      resultSet.add(metric);\n    }\n  }\n  return [...resultSet];\n};\n\nexport function processLabels(labels: Array<{ [key: string]: string }>, withName = false) {\n  // For processing we are going to use sets as they have significantly better performance than arrays\n  // After we process labels, we will convert sets to arrays and return object with label values in arrays\n  const valueSet: { [key: string]: Set<string> } = {};\n  labels.forEach((label) => {\n    const { __name__, ...rest } = label;\n    if (withName) {\n      valueSet['__name__'] = valueSet['__name__'] || new Set();\n      if (!valueSet['__name__'].has(__name__)) {\n        valueSet['__name__'].add(__name__);\n      }\n    }\n\n    Object.keys(rest).forEach((key) => {\n      if (!valueSet[key]) {\n        valueSet[key] = new Set();\n      }\n      if (!valueSet[key].has(rest[key])) {\n        valueSet[key].add(rest[key]);\n      }\n    });\n  });\n\n  // valueArray that we are going to return in the object\n  const valueArray: { [key: string]: string[] } = {};\n  limitSuggestions(Object.keys(valueSet)).forEach((key) => {\n    valueArray[key] = limitSuggestions(Array.from(valueSet[key]));\n  });\n\n  return { values: valueArray, keys: Object.keys(valueArray) };\n}\n\n// const cleanSelectorRegexp = /\\{(\\w+=\"[^\"\\n]*?\")(,\\w+=\"[^\"\\n]*?\")*\\}/;\nexport const selectorRegexp = /\\{[^}]*?(\\}|$)/;\n\n// This will capture 4 groups. Example label filter => {instance=\"10.4.11.4:9003\"}\n// 1. label:    instance\n// 2. operator: =\n// 3. value:    \"10.4.11.4:9003\"\n// 4. comma:    if there is a comma it will give ,\n// 5. space:    if there is a space after comma it will give the whole space\n// comma and space is useful for addLabelsToExpression function\nexport const labelRegexp = /\\b(\\w+)(!?=~?)(\"[^\"\\n]*?\")(,)?(\\s*)?/g;\n\nexport function parseSelector(query: string, cursorOffset = 1): { labelKeys: any[]; selector: string } {\n  if (!query.match(selectorRegexp)) {\n    // Special matcher for metrics\n    if (query.match(/^[A-Za-z:][\\w:]*$/)) {\n      return {\n        selector: `{__name__=\"${query}\"}`,\n        labelKeys: ['__name__'],\n      };\n    }\n    throw new Error('Query must contain a selector: ' + query);\n  }\n\n  // Check if inside a selector\n  const prefix = query.slice(0, cursorOffset);\n  const prefixOpen = prefix.lastIndexOf('{');\n  const prefixClose = prefix.lastIndexOf('}');\n  if (prefixOpen === -1) {\n    throw new Error('Not inside selector, missing open brace: ' + prefix);\n  }\n  if (prefixClose > -1 && prefixClose > prefixOpen) {\n    throw new Error('Not inside selector, previous selector already closed: ' + prefix);\n  }\n  const suffix = query.slice(cursorOffset);\n  const suffixCloseIndex = suffix.indexOf('}');\n  const suffixClose = suffixCloseIndex + cursorOffset;\n  const suffixOpenIndex = suffix.indexOf('{');\n  const suffixOpen = suffixOpenIndex + cursorOffset;\n  if (suffixClose === -1) {\n    throw new Error('Not inside selector, missing closing brace in suffix: ' + suffix);\n  }\n  if (suffixOpenIndex > -1 && suffixOpen < suffixClose) {\n    throw new Error('Not inside selector, next selector opens before this one closed: ' + suffix);\n  }\n\n  // Extract clean labels to form clean selector, incomplete labels are dropped\n  const selector = query.slice(prefixOpen, suffixClose);\n  const labels: { [key: string]: { value: string; operator: string } } = {};\n  selector.replace(labelRegexp, (label, key, operator, value) => {\n    const labelOffset = query.indexOf(label);\n    const valueStart = labelOffset + key.length + operator.length + 1;\n    const valueEnd = labelOffset + key.length + operator.length + value.length - 1;\n    // Skip label if cursor is in value\n    if (cursorOffset < valueStart || cursorOffset > valueEnd) {\n      labels[key] = { value, operator };\n    }\n    return '';\n  });\n\n  // Add metric if there is one before the selector\n  const metricPrefix = query.slice(0, prefixOpen);\n  const metricMatch = metricPrefix.match(/[A-Za-z:][\\w:]*$/);\n  if (metricMatch) {\n    labels['__name__'] = { value: `\"${metricMatch[0]}\"`, operator: '=' };\n  }\n\n  // Build sorted selector\n  const labelKeys = Object.keys(labels).sort();\n  const cleanSelector = labelKeys.map((key) => `${key}${labels[key].operator}${labels[key].value}`).join(',');\n\n  const selectorString = ['{', cleanSelector, '}'].join('');\n\n  return { labelKeys, selector: selectorString };\n}\n\nexport function expandRecordingRules(query: string, mapping: { [name: string]: string }): string {\n  const getRuleRegex = (ruleName: string) => new RegExp(`(\\\\s|\\\\(|^)(${ruleName})(\\\\s|$|\\\\(|\\\\[|\\\\{)`, 'ig');\n\n  // For each mapping key we iterate over the query and split them in parts.\n  // recording:rule{label=~\"/label/value\"} * some:other:rule{other_label=\"value\"}\n  // We want to keep parts in here like this:\n  // recording:rule\n  // {label=~\"/label/value\"} *\n  // some:other:rule\n  // {other_label=\"value\"}\n  const tmpSplitParts = Object.keys(mapping).reduce<string[]>(\n    (prev, curr) => {\n      let parts: string[] = [];\n      let tmpParts: string[] = [];\n      let removeIdx: number[] = [];\n\n      // we iterate over prev because it might be like this after first loop\n      // recording:rule and {label=~\"/label/value\"} * some:other:rule{other_label=\"value\"}\n      // so we need to split the second part too\n      prev.filter(Boolean).forEach((p, i) => {\n        const doesMatch = p.match(getRuleRegex(curr));\n        if (doesMatch) {\n          parts = p.split(curr);\n          if (parts.length === 2) {\n            // this is the case when we have such result for this query\n            // max (metric{label=\"value\"})\n            // \"max(\", \"{label=\"value\"}\"\n            removeIdx.push(i);\n            tmpParts.push(...[parts[0], curr, parts[1]].filter(Boolean));\n          } else if (parts.length > 2) {\n            // this is the case when we have such query\n            // metric + metric\n            // when we split it we have such data\n            // \"\", \" + \", \"\"\n            removeIdx.push(i);\n            parts = parts.map((p) => (p === '' ? curr : p));\n            tmpParts.push(...parts);\n          }\n        }\n      });\n\n      // if we have idx to remove that means we split the value in that index.\n      // No need to keep it. Have the new split values instead.\n      removeIdx.forEach((ri) => (prev[ri] = ''));\n      prev = prev.filter(Boolean);\n      prev.push(...tmpParts);\n\n      return prev;\n    },\n    [query]\n  );\n\n  // we have the separate parts. we need to replace the metric and apply the labels if there is any\n  let labelFound = false;\n  const trulyExpandedQuery = tmpSplitParts.map((tsp, i) => {\n    // if we know this loop tsp is a label, not the metric we want to expand\n    if (labelFound) {\n      labelFound = false;\n      return '';\n    }\n\n    // check if the mapping is there\n    if (mapping[tsp]) {\n      const recordingRule = mapping[tsp];\n      // it is a recording rule. if the following is a label then apply it\n      if (i + 1 !== tmpSplitParts.length && tmpSplitParts[i + 1].match(labelRegexp)) {\n        // the next value in the loop is label. Let's apply labels to the metric\n        labelFound = true;\n        const labels = tmpSplitParts[i + 1];\n        const invalidLabelsRegex = /(\\)\\{|\\}\\{|\\]\\{)/;\n        return addLabelsToExpression(recordingRule + labels, invalidLabelsRegex);\n      } else {\n        // it is not a recording rule and might be a binary operation in between two recording rules\n        // So no need to do anything. just return it.\n        return recordingRule;\n      }\n    }\n\n    return tsp;\n  });\n\n  // Remove empty strings and merge them\n  return trulyExpandedQuery.filter(Boolean).join('');\n}\n\nfunction addLabelsToExpression(expr: string, invalidLabelsRegexp: RegExp) {\n  const match = expr.match(invalidLabelsRegexp);\n  if (!match) {\n    return expr;\n  }\n\n  // Split query into 2 parts - before the invalidLabelsRegex match and after.\n  const indexOfRegexMatch = match.index ?? 0;\n  const exprBeforeRegexMatch = expr.slice(0, indexOfRegexMatch + 1);\n  const exprAfterRegexMatch = expr.slice(indexOfRegexMatch + 1);\n\n  // Create arrayOfLabelObjects with label objects that have key, operator and value.\n  const arrayOfLabelObjects: Array<{\n    key: string;\n    operator: string;\n    value: string;\n    comma?: string;\n    space?: string;\n  }> = [];\n  exprAfterRegexMatch.replace(labelRegexp, (label, key, operator, value, comma, space) => {\n    arrayOfLabelObjects.push({ key, operator, value, comma, space });\n    return '';\n  });\n\n  // Loop through all label objects and add them to query.\n  // As a starting point we have valid query without the labels.\n  let result = exprBeforeRegexMatch;\n  arrayOfLabelObjects.filter(Boolean).forEach((obj) => {\n    // Remove extra set of quotes from obj.value\n    const value = obj.value.slice(1, -1);\n    result = addLabelToQuery(result, obj.key, value, obj.operator);\n  });\n\n  // reconstruct the labels\n  let existingLabel = arrayOfLabelObjects.reduce((prev, curr) => {\n    prev += `${curr.key}${curr.operator}${curr.value}${curr.comma ?? ''}${curr.space ?? ''}`;\n    return prev;\n  }, '');\n\n  // Check if there is anything besides labels\n  // Useful for this kind of metrics sum (recording_rule_metric{label1=\"value1\"}) by (env)\n  // if we don't check this part, ) by (env) part will be lost\n  existingLabel = '{' + existingLabel + '}';\n  const potentialLeftOver = exprAfterRegexMatch.replace(existingLabel, '');\n\n  return result + potentialLeftOver;\n}\n\n/**\n * Adds metadata for synthetic metrics for which the API does not provide metadata.\n * See https://github.com/grafana/grafana/issues/22337 for details.\n *\n * @param metadata HELP and TYPE metadata from /api/v1/metadata\n */\nexport function fixSummariesMetadata(metadata: { [metric: string]: PromMetricsMetadataItem[] }): PromMetricsMetadata {\n  if (!metadata) {\n    return metadata;\n  }\n  const baseMetadata: PromMetricsMetadata = {};\n  const summaryMetadata: PromMetricsMetadata = {};\n  for (const metric in metadata) {\n    // NOTE: based on prometheus-documentation, we can receive\n    // multiple metadata-entries for the given metric, it seems\n    // it happens when the same metric is on multiple targets\n    // and their help-text differs\n    // (https://prometheus.io/docs/prometheus/latest/querying/api/#querying-metric-metadata)\n    // for now we just use the first entry.\n    const item = metadata[metric][0];\n    baseMetadata[metric] = item;\n\n    if (item.type === 'histogram') {\n      summaryMetadata[`${metric}_bucket`] = {\n        type: 'counter',\n        help: `Cumulative counters for the observation buckets (${item.help})`,\n      };\n      summaryMetadata[`${metric}_count`] = {\n        type: 'counter',\n        help: `Count of events that have been observed for the histogram metric (${item.help})`,\n      };\n      summaryMetadata[`${metric}_sum`] = {\n        type: 'counter',\n        help: `Total sum of all observed values for the histogram metric (${item.help})`,\n      };\n    }\n    if (item.type === 'summary') {\n      summaryMetadata[`${metric}_count`] = {\n        type: 'counter',\n        help: `Count of events that have been observed for the base metric (${item.help})`,\n      };\n      summaryMetadata[`${metric}_sum`] = {\n        type: 'counter',\n        help: `Total sum of all observed values for the base metric (${item.help})`,\n      };\n    }\n  }\n  // Synthetic series\n  const syntheticMetadata: PromMetricsMetadata = {};\n  syntheticMetadata['ALERTS'] = {\n    type: 'counter',\n    help: 'Time series showing pending and firing alerts. The sample value is set to 1 as long as the alert is in the indicated active (pending or firing) state.',\n  };\n\n  return { ...baseMetadata, ...summaryMetadata, ...syntheticMetadata };\n}\n\nexport function roundMsToMin(milliseconds: number): number {\n  return roundSecToMin(milliseconds / 1000);\n}\n\nexport function roundSecToMin(seconds: number): number {\n  return Math.floor(seconds / 60);\n}\n\n// Returns number of minutes rounded up to the nearest nth minute\nexport function roundSecToNextMin(seconds: number, secondsToRound = 1): number {\n  return Math.ceil(seconds / 60) - (Math.ceil(seconds / 60) % secondsToRound);\n}\n\nexport function limitSuggestions(items: string[]) {\n  return items.slice(0, SUGGESTIONS_LIMIT);\n}\n\nexport function addLimitInfo(items: any[] | undefined): string {\n  return items && items.length >= SUGGESTIONS_LIMIT ? `, limited to the first ${SUGGESTIONS_LIMIT} received items` : '';\n}\n\n// NOTE: the following 2 exported functions are very similar to the prometheus*Escape\n// functions in datasource.ts, but they are not exactly the same algorithm, and we found\n// no way to reuse one in the another or vice versa.\n\n// Prometheus regular-expressions use the RE2 syntax (https://github.com/google/re2/wiki/Syntax),\n// so every character that matches something in that list has to be escaped.\n// the list of metacharacters is: *+?()|\\.[]{}^$\n// we make a javascript regular expression that matches those characters:\nconst RE2_METACHARACTERS = /[*+?()|\\\\.\\[\\]{}^$]/g;\n\nfunction escapePrometheusRegexp(value: string): string {\n  return value.replace(RE2_METACHARACTERS, '\\\\$&');\n}\n\n// based on the openmetrics-documentation, the 3 symbols we have to handle are:\n// - \\n ... the newline character\n// - \\  ... the backslash character\n// - \"  ... the double-quote character\nexport function escapeLabelValueInExactSelector(labelValue: string): string {\n  return labelValue.replace(/\\\\/g, '\\\\\\\\').replace(/\\n/g, '\\\\n').replace(/\"/g, '\\\\\"');\n}\n\nexport function escapeLabelValueInRegexSelector(labelValue: string): string {\n  return escapeLabelValueInExactSelector(escapePrometheusRegexp(labelValue));\n}\n\nconst FromPromLikeMap: Record<string, AbstractLabelOperator> = {\n  '=': AbstractLabelOperator.Equal,\n  '!=': AbstractLabelOperator.NotEqual,\n  '=~': AbstractLabelOperator.EqualRegEx,\n  '!~': AbstractLabelOperator.NotEqualRegEx,\n};\n\nconst ToPromLikeMap: Record<AbstractLabelOperator, string> = invert(FromPromLikeMap) as Record<\n  AbstractLabelOperator,\n  string\n>;\n\nexport function toPromLikeExpr(labelBasedQuery: AbstractQuery): string {\n  const expr = labelBasedQuery.labelMatchers\n    .map((selector: AbstractLabelMatcher) => {\n      const operator = ToPromLikeMap[selector.operator];\n      if (operator) {\n        return `${selector.name}${operator}\"${selector.value}\"`;\n      } else {\n        return '';\n      }\n    })\n    .filter((e: string) => e !== '')\n    .join(', ');\n\n  return expr ? `{${expr}}` : '';\n}\n\nexport function toPromLikeQuery(labelBasedQuery: AbstractQuery): PromLikeQuery {\n  return {\n    refId: labelBasedQuery.refId,\n    expr: toPromLikeExpr(labelBasedQuery),\n    range: true,\n  };\n}\n\nexport interface PromLikeQuery extends DataQuery {\n  expr: string;\n  range: boolean;\n}\n\nfunction getMaybeTokenStringContent(token: Token): string {\n  if (typeof token.content === 'string') {\n    return token.content;\n  }\n\n  return '';\n}\n\nexport function extractLabelMatchers(tokens: Array<string | Token>): AbstractLabelMatcher[] {\n  const labelMatchers: AbstractLabelMatcher[] = [];\n\n  for (const token of tokens) {\n    if (!(token instanceof Token)) {\n      continue;\n    }\n\n    if (token.type === 'context-labels') {\n      let labelKey = '';\n      let labelValue = '';\n      let labelOperator = '';\n\n      const contentTokens = Array.isArray(token.content) ? token.content : [token.content];\n\n      for (let currentToken of contentTokens) {\n        if (typeof currentToken === 'string') {\n          let currentStr: string;\n          currentStr = currentToken;\n          if (currentStr === '=' || currentStr === '!=' || currentStr === '=~' || currentStr === '!~') {\n            labelOperator = currentStr;\n          }\n        } else if (currentToken instanceof Token) {\n          switch (currentToken.type) {\n            case 'label-key':\n              labelKey = getMaybeTokenStringContent(currentToken);\n              break;\n            case 'label-value':\n              labelValue = getMaybeTokenStringContent(currentToken);\n              labelValue = labelValue.substring(1, labelValue.length - 1);\n              const labelComparator = FromPromLikeMap[labelOperator];\n              if (labelComparator) {\n                labelMatchers.push({ name: labelKey, operator: labelComparator, value: labelValue });\n              }\n              break;\n          }\n        }\n      }\n    }\n  }\n\n  return labelMatchers;\n}\n\n/**\n * Calculates new interval \"snapped\" to the closest Nth minute, depending on cache level datasource setting\n * @param cacheLevel\n * @param range\n */\nexport function getRangeSnapInterval(\n  cacheLevel: PrometheusCacheLevel,\n  range: TimeRange\n): { start: string; end: string } {\n  // Don't round the range if we're not caching\n  if (cacheLevel === PrometheusCacheLevel.None) {\n    return {\n      start: getPrometheusTime(range.from, false).toString(),\n      end: getPrometheusTime(range.to, true).toString(),\n    };\n  }\n  // Otherwise round down to the nearest nth minute for the start time\n  const startTime = getPrometheusTime(range.from, false);\n  // const startTimeQuantizedSeconds = roundSecToLastMin(startTime, getClientCacheDurationInMinutes(cacheLevel)) * 60;\n  const startTimeQuantizedSeconds = incrRoundDn(startTime, getClientCacheDurationInMinutes(cacheLevel) * 60);\n\n  // And round up to the nearest nth minute for the end time\n  const endTime = getPrometheusTime(range.to, true);\n  const endTimeQuantizedSeconds = roundSecToNextMin(endTime, getClientCacheDurationInMinutes(cacheLevel)) * 60;\n\n  // If the interval was too short, we could have rounded both start and end to the same time, if so let's add one step to the end\n  if (startTimeQuantizedSeconds === endTimeQuantizedSeconds) {\n    const endTimePlusOneStep = endTimeQuantizedSeconds + getClientCacheDurationInMinutes(cacheLevel) * 60;\n    return { start: startTimeQuantizedSeconds.toString(), end: endTimePlusOneStep.toString() };\n  }\n\n  const start = startTimeQuantizedSeconds.toString();\n  const end = endTimeQuantizedSeconds.toString();\n\n  return { start, end };\n}\n\nexport function getClientCacheDurationInMinutes(cacheLevel: PrometheusCacheLevel) {\n  switch (cacheLevel) {\n    case PrometheusCacheLevel.Medium:\n      return 10;\n    case PrometheusCacheLevel.High:\n      return 60;\n    default:\n      return 1;\n  }\n}\n\nexport function getPrometheusTime(date: string | DateTime, roundUp: boolean) {\n  if (typeof date === 'string') {\n    date = dateMath.parse(date, roundUp)!;\n  }\n\n  return Math.ceil(date.valueOf() / 1000);\n}\n\nexport function truncateResult<T>(array: T[], limit?: number): T[] {\n  if (limit === undefined) {\n    limit = PROMETHEUS_QUERY_BUILDER_MAX_RESULTS;\n  }\n  array.length = Math.min(array.length, limit);\n  return array;\n}\n","import { css, cx } from '@emotion/css';\nimport React, { ChangeEvent } from 'react';\nimport { FixedSizeList } from 'react-window';\n\nimport { GrafanaTheme2, TimeRange } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport {\n  BrowserLabel as PromLabel,\n  Button,\n  HorizontalGroup,\n  Input,\n  Label,\n  LoadingPlaceholder,\n  stylesFactory,\n  withTheme2,\n} from '@grafana/ui';\n\nimport PromQlLanguageProvider from '../language_provider';\nimport { escapeLabelValueInExactSelector, escapeLabelValueInRegexSelector } from '../language_utils';\n\n// Hard limit on labels to render\nconst EMPTY_SELECTOR = '{}';\nconst METRIC_LABEL = '__name__';\nconst LIST_ITEM_SIZE = 25;\n\nexport interface BrowserProps {\n  languageProvider: PromQlLanguageProvider;\n  onChange: (selector: string) => void;\n  theme: GrafanaTheme2;\n  autoSelect?: number;\n  hide?: () => void;\n  lastUsedLabels: string[];\n  storeLastUsedLabels: (labels: string[]) => void;\n  deleteLastUsedLabels: () => void;\n  timeRange?: TimeRange;\n}\n\ninterface BrowserState {\n  labels: SelectableLabel[];\n  labelSearchTerm: string;\n  metricSearchTerm: string;\n  status: string;\n  error: string;\n  validationStatus: string;\n  valueSearchTerm: string;\n}\n\ninterface FacettableValue {\n  name: string;\n  selected?: boolean;\n  details?: string;\n}\n\nexport interface SelectableLabel {\n  name: string;\n  selected?: boolean;\n  loading?: boolean;\n  values?: FacettableValue[];\n  hidden?: boolean;\n  facets?: number;\n}\n\nexport function buildSelector(labels: SelectableLabel[]): string {\n  let singleMetric = '';\n  const selectedLabels = [];\n  for (const label of labels) {\n    if ((label.name === METRIC_LABEL || label.selected) && label.values && label.values.length > 0) {\n      const selectedValues = label.values.filter((value) => value.selected).map((value) => value.name);\n      if (selectedValues.length > 1) {\n        selectedLabels.push(`${label.name}=~\"${selectedValues.map(escapeLabelValueInRegexSelector).join('|')}\"`);\n      } else if (selectedValues.length === 1) {\n        if (label.name === METRIC_LABEL) {\n          singleMetric = selectedValues[0];\n        } else {\n          selectedLabels.push(`${label.name}=\"${escapeLabelValueInExactSelector(selectedValues[0])}\"`);\n        }\n      }\n    }\n  }\n  return [singleMetric, '{', selectedLabels.join(','), '}'].join('');\n}\n\nexport function facetLabels(\n  labels: SelectableLabel[],\n  possibleLabels: Record<string, string[]>,\n  lastFacetted?: string\n): SelectableLabel[] {\n  return labels.map((label) => {\n    const possibleValues = possibleLabels[label.name];\n    if (possibleValues) {\n      let existingValues: FacettableValue[];\n      if (label.name === lastFacetted && label.values) {\n        // Facetting this label, show all values\n        existingValues = label.values;\n      } else {\n        // Keep selection in other facets\n        const selectedValues: Set<string> = new Set(\n          label.values?.filter((value) => value.selected).map((value) => value.name) || []\n        );\n        // Values for this label have not been requested yet, let's use the facetted ones as the initial values\n        existingValues = possibleValues.map((value) => ({ name: value, selected: selectedValues.has(value) }));\n      }\n      return {\n        ...label,\n        loading: false,\n        values: existingValues,\n        hidden: !possibleValues,\n        facets: existingValues.length,\n      };\n    }\n\n    // Label is facetted out, hide all values\n    return { ...label, loading: false, hidden: !possibleValues, values: undefined, facets: 0 };\n  });\n}\n\nconst getStyles = stylesFactory((theme: GrafanaTheme2) => ({\n  wrapper: css`\n    background-color: ${theme.colors.background.secondary};\n    padding: ${theme.spacing(1)};\n    width: 100%;\n  `,\n  list: css`\n    margin-top: ${theme.spacing(1)};\n    display: flex;\n    flex-wrap: wrap;\n    max-height: 200px;\n    overflow: auto;\n    align-content: flex-start;\n  `,\n  section: css`\n    & + & {\n      margin: ${theme.spacing(2)} 0;\n    }\n    position: relative;\n  `,\n  selector: css`\n    font-family: ${theme.typography.fontFamilyMonospace};\n    margin-bottom: ${theme.spacing(1)};\n  `,\n  status: css`\n    padding: ${theme.spacing(0.5)};\n    color: ${theme.colors.text.secondary};\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    /* using absolute positioning because flex interferes with ellipsis */\n    position: absolute;\n    width: 50%;\n    right: 0;\n    text-align: right;\n    transition: opacity 100ms linear;\n    opacity: 0;\n  `,\n  statusShowing: css`\n    opacity: 1;\n  `,\n  error: css`\n    color: ${theme.colors.error.main};\n  `,\n  valueList: css`\n    margin-right: ${theme.spacing(1)};\n    resize: horizontal;\n  `,\n  valueListWrapper: css`\n    border-left: 1px solid ${theme.colors.border.medium};\n    margin: ${theme.spacing(1)} 0;\n    padding: ${theme.spacing(1)} 0 ${theme.spacing(1)} ${theme.spacing(1)};\n  `,\n  valueListArea: css`\n    display: flex;\n    flex-wrap: wrap;\n    margin-top: ${theme.spacing(1)};\n  `,\n  valueTitle: css`\n    margin-left: -${theme.spacing(0.5)};\n    margin-bottom: ${theme.spacing(1)};\n  `,\n  validationStatus: css`\n    padding: ${theme.spacing(0.5)};\n    margin-bottom: ${theme.spacing(1)};\n    color: ${theme.colors.text.maxContrast};\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  `,\n}));\n\n/**\n * TODO #33976: Remove duplicated code. The component is very similar to LokiLabelBrowser.tsx. Check if it's possible\n *              to create a single, generic component.\n */\nexport class UnthemedPrometheusMetricsBrowser extends React.Component<BrowserProps, BrowserState> {\n  valueListsRef = React.createRef<HTMLDivElement>();\n  state: BrowserState = {\n    labels: [],\n    labelSearchTerm: '',\n    metricSearchTerm: '',\n    status: 'Ready',\n    error: '',\n    validationStatus: '',\n    valueSearchTerm: '',\n  };\n\n  onChangeLabelSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ labelSearchTerm: event.target.value });\n  };\n\n  onChangeMetricSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ metricSearchTerm: event.target.value });\n  };\n\n  onChangeValueSearch = (event: ChangeEvent<HTMLInputElement>) => {\n    this.setState({ valueSearchTerm: event.target.value });\n  };\n\n  onClickRunQuery = () => {\n    const selector = buildSelector(this.state.labels);\n    this.props.onChange(selector);\n  };\n\n  onClickRunRateQuery = () => {\n    const selector = buildSelector(this.state.labels);\n    const query = `rate(${selector}[$__rate_interval])`;\n    this.props.onChange(query);\n  };\n\n  onClickClear = () => {\n    this.setState((state) => {\n      const labels: SelectableLabel[] = state.labels.map((label) => ({\n        ...label,\n        values: undefined,\n        selected: false,\n        loading: false,\n        hidden: false,\n        facets: undefined,\n      }));\n      return {\n        labels,\n        labelSearchTerm: '',\n        metricSearchTerm: '',\n        status: '',\n        error: '',\n        validationStatus: '',\n        valueSearchTerm: '',\n      };\n    });\n    this.props.deleteLastUsedLabels();\n    // Get metrics\n    this.fetchValues(METRIC_LABEL, EMPTY_SELECTOR);\n  };\n\n  onClickLabel = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label) {\n      return;\n    }\n    // Toggle selected state\n    const selected = !label.selected;\n    let nextValue: Partial<SelectableLabel> = { selected };\n    if (label.values && !selected) {\n      // Deselect all values if label was deselected\n      const values = label.values.map((value) => ({ ...value, selected: false }));\n      nextValue = { ...nextValue, facets: 0, values };\n    }\n    // Resetting search to prevent empty results\n    this.setState({ labelSearchTerm: '' });\n    this.updateLabelState(name, nextValue, '', () => this.doFacettingForLabel(name));\n  };\n\n  onClickValue = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label || !label.values) {\n      return;\n    }\n    // Resetting search to prevent empty results\n    this.setState({ labelSearchTerm: '' });\n    // Toggling value for selected label, leaving other values intact\n    const values = label.values.map((v) => ({ ...v, selected: v.name === value ? !v.selected : v.selected }));\n    this.updateLabelState(name, { values }, '', () => this.doFacetting(name));\n  };\n\n  onClickMetric = (name: string, value: string | undefined, event: React.MouseEvent<HTMLElement>) => {\n    // Finding special metric label\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label || !label.values) {\n      return;\n    }\n    // Resetting search to prevent empty results\n    this.setState({ metricSearchTerm: '' });\n    // Toggling value for selected label, leaving other values intact\n    const values = label.values.map((v) => ({\n      ...v,\n      selected: v.name === value || v.selected ? !v.selected : v.selected,\n    }));\n    // Toggle selected state of special metrics label\n    const selected = values.some((v) => v.selected);\n    this.updateLabelState(name, { selected, values }, '', () => this.doFacetting(name));\n  };\n\n  onClickValidate = () => {\n    const selector = buildSelector(this.state.labels);\n    this.validateSelector(selector);\n  };\n\n  updateLabelState(name: string, updatedFields: Partial<SelectableLabel>, status = '', cb?: () => void) {\n    this.setState((state) => {\n      const labels: SelectableLabel[] = state.labels.map((label) => {\n        if (label.name === name) {\n          return { ...label, ...updatedFields };\n        }\n        return label;\n      });\n      // New status overrides errors\n      const error = status ? '' : state.error;\n      return { labels, status, error, validationStatus: '' };\n    }, cb);\n  }\n\n  componentDidMount() {\n    const { languageProvider, lastUsedLabels } = this.props;\n    if (languageProvider) {\n      const selectedLabels: string[] = lastUsedLabels;\n      languageProvider.start(this.props.timeRange).then(() => {\n        let rawLabels: string[] = languageProvider.getLabelKeys();\n        // Get metrics\n        this.fetchValues(METRIC_LABEL, EMPTY_SELECTOR);\n        // Auto-select previously selected labels\n        const labels: SelectableLabel[] = rawLabels.map((label, i, arr) => ({\n          name: label,\n          selected: selectedLabels.includes(label),\n          loading: false,\n        }));\n        // Pre-fetch values for selected labels\n        this.setState({ labels }, () => {\n          this.state.labels.forEach((label) => {\n            if (label.selected) {\n              this.fetchValues(label.name, EMPTY_SELECTOR);\n            }\n          });\n        });\n      });\n    }\n  }\n\n  doFacettingForLabel(name: string) {\n    const label = this.state.labels.find((l) => l.name === name);\n    if (!label) {\n      return;\n    }\n    const selectedLabels = this.state.labels.filter((label) => label.selected).map((label) => label.name);\n    this.props.storeLastUsedLabels(selectedLabels);\n    if (label.selected) {\n      // Refetch values for newly selected label...\n      if (!label.values) {\n        this.fetchValues(name, buildSelector(this.state.labels));\n      }\n    } else {\n      // Only need to facet when deselecting labels\n      this.doFacetting();\n    }\n  }\n\n  doFacetting = (lastFacetted?: string) => {\n    const selector = buildSelector(this.state.labels);\n    if (selector === EMPTY_SELECTOR) {\n      // Clear up facetting\n      const labels: SelectableLabel[] = this.state.labels.map((label) => {\n        return { ...label, facets: 0, values: undefined, hidden: false };\n      });\n      this.setState({ labels }, () => {\n        // Get fresh set of values\n        this.state.labels.forEach(\n          (label) => (label.selected || label.name === METRIC_LABEL) && this.fetchValues(label.name, selector)\n        );\n      });\n    } else {\n      // Do facetting\n      this.fetchSeries(selector, lastFacetted);\n    }\n  };\n\n  async fetchValues(name: string, selector: string) {\n    const { languageProvider } = this.props;\n    this.updateLabelState(name, { loading: true }, `Fetching values for ${name}`);\n    try {\n      let rawValues = await languageProvider.getLabelValues(name);\n      // If selector changed, clear loading state and discard result by returning early\n      if (selector !== buildSelector(this.state.labels)) {\n        this.updateLabelState(name, { loading: false });\n        return;\n      }\n      const values: FacettableValue[] = [];\n      const { metricsMetadata } = languageProvider;\n      for (const labelValue of rawValues) {\n        const value: FacettableValue = { name: labelValue };\n        // Adding type/help text to metrics\n        if (name === METRIC_LABEL && metricsMetadata) {\n          const meta = metricsMetadata[labelValue];\n          if (meta) {\n            value.details = `(${meta.type}) ${meta.help}`;\n          }\n        }\n        values.push(value);\n      }\n      this.updateLabelState(name, { values, loading: false });\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async fetchSeries(selector: string, lastFacetted?: string) {\n    const { languageProvider } = this.props;\n    if (lastFacetted) {\n      this.updateLabelState(lastFacetted, { loading: true }, `Facetting labels for ${selector}`);\n    }\n    try {\n      const possibleLabels = await languageProvider.fetchSeriesLabels(selector, true);\n      // If selector changed, clear loading state and discard result by returning early\n      if (selector !== buildSelector(this.state.labels)) {\n        if (lastFacetted) {\n          this.updateLabelState(lastFacetted, { loading: false });\n        }\n        return;\n      }\n      if (Object.keys(possibleLabels).length === 0) {\n        this.setState({ error: `Empty results, no matching label for ${selector}` });\n        return;\n      }\n      const labels: SelectableLabel[] = facetLabels(this.state.labels, possibleLabels, lastFacetted);\n      this.setState({ labels, error: '' });\n      if (lastFacetted) {\n        this.updateLabelState(lastFacetted, { loading: false });\n      }\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async validateSelector(selector: string) {\n    const { languageProvider } = this.props;\n    this.setState({ validationStatus: `Validating selector ${selector}`, error: '' });\n    const streams = await languageProvider.fetchSeries(selector);\n    this.setState({ validationStatus: `Selector is valid (${streams.length} series found)` });\n  }\n\n  render() {\n    const { theme } = this.props;\n    const { labels, labelSearchTerm, metricSearchTerm, status, error, validationStatus, valueSearchTerm } = this.state;\n    const styles = getStyles(theme);\n    if (labels.length === 0) {\n      return (\n        <div className={styles.wrapper}>\n          <LoadingPlaceholder text=\"Loading labels...\" />\n        </div>\n      );\n    }\n\n    // Filter metrics\n    let metrics = labels.find((label) => label.name === METRIC_LABEL);\n    if (metrics && metricSearchTerm) {\n      metrics = {\n        ...metrics,\n        values: metrics.values?.filter((value) => value.selected || value.name.includes(metricSearchTerm)),\n      };\n    }\n\n    // Filter labels\n    let nonMetricLabels = labels.filter((label) => !label.hidden && label.name !== METRIC_LABEL);\n    if (labelSearchTerm) {\n      nonMetricLabels = nonMetricLabels.filter((label) => label.selected || label.name.includes(labelSearchTerm));\n    }\n\n    // Filter non-metric label values\n    let selectedLabels = nonMetricLabels.filter((label) => label.selected && label.values);\n    if (valueSearchTerm) {\n      selectedLabels = selectedLabels.map((label) => ({\n        ...label,\n        values: label.values?.filter((value) => value.selected || value.name.includes(valueSearchTerm)),\n      }));\n    }\n    const selector = buildSelector(this.state.labels);\n    const empty = selector === EMPTY_SELECTOR;\n    const metricCount = metrics?.values?.length || 0;\n\n    return (\n      <div className={styles.wrapper}>\n        <HorizontalGroup align=\"flex-start\" spacing=\"lg\">\n          <div>\n            <div className={styles.section}>\n              <Label description=\"Once a metric is selected only possible labels are shown.\">1. Select a metric</Label>\n              <div>\n                <Input\n                  onChange={this.onChangeMetricSearch}\n                  aria-label=\"Filter expression for metric\"\n                  value={metricSearchTerm}\n                  data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.selectMetric}\n                />\n              </div>\n              <div\n                role=\"list\"\n                className={styles.valueListWrapper}\n                data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.metricList}\n              >\n                <FixedSizeList\n                  height={Math.min(450, metricCount * LIST_ITEM_SIZE)}\n                  itemCount={metricCount}\n                  itemSize={LIST_ITEM_SIZE}\n                  itemKey={(i) => metrics!.values![i].name}\n                  width={300}\n                  className={styles.valueList}\n                >\n                  {({ index, style }) => {\n                    const value = metrics?.values?.[index];\n                    if (!value) {\n                      return null;\n                    }\n                    return (\n                      <div style={style}>\n                        <PromLabel\n                          name={metrics!.name}\n                          value={value?.name}\n                          title={value.details}\n                          active={value?.selected}\n                          onClick={this.onClickMetric}\n                          searchTerm={metricSearchTerm}\n                        />\n                      </div>\n                    );\n                  }}\n                </FixedSizeList>\n              </div>\n            </div>\n          </div>\n\n          <div>\n            <div className={styles.section}>\n              <Label description=\"Once label values are selected, only possible label combinations are shown.\">\n                2. Select labels to search in\n              </Label>\n              <div>\n                <Input\n                  onChange={this.onChangeLabelSearch}\n                  aria-label=\"Filter expression for label\"\n                  value={labelSearchTerm}\n                  data-testid={\n                    selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.labelNamesFilter\n                  }\n                />\n              </div>\n              {/* Using fixed height here to prevent jumpy layout */}\n              <div className={styles.list} style={{ height: 120 }}>\n                {nonMetricLabels.map((label) => (\n                  <PromLabel\n                    key={label.name}\n                    name={label.name}\n                    loading={label.loading}\n                    active={label.selected}\n                    hidden={label.hidden}\n                    facets={label.facets}\n                    onClick={this.onClickLabel}\n                    searchTerm={labelSearchTerm}\n                  />\n                ))}\n              </div>\n            </div>\n            <div className={styles.section}>\n              <Label description=\"Use the search field to find values across selected labels.\">\n                3. Select (multiple) values for your labels\n              </Label>\n              <div>\n                <Input\n                  onChange={this.onChangeValueSearch}\n                  aria-label=\"Filter expression for label values\"\n                  value={valueSearchTerm}\n                  data-testid={\n                    selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.labelValuesFilter\n                  }\n                />\n              </div>\n              <div className={styles.valueListArea} ref={this.valueListsRef}>\n                {selectedLabels.map((label) => (\n                  <div\n                    role=\"list\"\n                    key={label.name}\n                    aria-label={`Values for ${label.name}`}\n                    className={styles.valueListWrapper}\n                  >\n                    <div className={styles.valueTitle}>\n                      <PromLabel\n                        name={label.name}\n                        loading={label.loading}\n                        active={label.selected}\n                        hidden={label.hidden}\n                        //If no facets, we want to show number of all label values\n                        facets={label.facets || label.values?.length}\n                        onClick={this.onClickLabel}\n                      />\n                    </div>\n                    <FixedSizeList\n                      height={Math.min(200, LIST_ITEM_SIZE * (label.values?.length || 0))}\n                      itemCount={label.values?.length || 0}\n                      itemSize={28}\n                      itemKey={(i) => label.values![i].name}\n                      width={200}\n                      className={styles.valueList}\n                    >\n                      {({ index, style }) => {\n                        const value = label.values?.[index];\n                        if (!value) {\n                          return null;\n                        }\n                        return (\n                          <div style={style}>\n                            <PromLabel\n                              name={label.name}\n                              value={value?.name}\n                              active={value?.selected}\n                              onClick={this.onClickValue}\n                              searchTerm={valueSearchTerm}\n                            />\n                          </div>\n                        );\n                      }}\n                    </FixedSizeList>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </HorizontalGroup>\n\n        <div className={styles.section}>\n          <Label>4. Resulting selector</Label>\n          <div aria-label=\"selector\" className={styles.selector}>\n            {selector}\n          </div>\n          {validationStatus && <div className={styles.validationStatus}>{validationStatus}</div>}\n          <HorizontalGroup>\n            <Button\n              data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.useQuery}\n              aria-label=\"Use selector for query button\"\n              disabled={empty}\n              onClick={this.onClickRunQuery}\n            >\n              Use query\n            </Button>\n            <Button\n              data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.useAsRateQuery}\n              aria-label=\"Use selector as metrics button\"\n              variant=\"secondary\"\n              disabled={empty}\n              onClick={this.onClickRunRateQuery}\n            >\n              Use as rate query\n            </Button>\n            <Button\n              data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.validateSelector}\n              aria-label=\"Validate submit button\"\n              variant=\"secondary\"\n              disabled={empty}\n              onClick={this.onClickValidate}\n            >\n              Validate selector\n            </Button>\n            <Button\n              data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.clear}\n              aria-label=\"Selector clear button\"\n              variant=\"secondary\"\n              onClick={this.onClickClear}\n            >\n              Clear\n            </Button>\n            <div className={cx(styles.status, (status || error) && styles.statusShowing)}>\n              <span className={error ? styles.error : ''}>{error || status}</span>\n            </div>\n          </HorizontalGroup>\n        </div>\n      </div>\n    );\n  }\n}\n\nexport const PrometheusMetricsBrowser = withTheme2(UnthemedPrometheusMetricsBrowser);\n","import { monacoTypes } from '@grafana/ui';\n\n// this thing here is a workaround in a way.\n// what we want to achieve, is that when the autocomplete-window\n// opens, the \"second, extra popup\" with the extra help,\n// also opens automatically.\n// but there is no API to achieve it.\n// the way to do it is to implement the `storageService`\n// interface, and provide our custom implementation,\n// which will default to `true` for the correct string-key.\n// unfortunately, while the typescript-interface exists,\n// it is not exported from monaco-editor,\n// so we cannot rely on typescript to make sure\n// we do it right. all we can do is to manually\n// lookup the interface, and make sure we code our code right.\n// our code is a \"best effort\" approach,\n// i am not 100% how the `scope` and `target` things work,\n// but so far it seems to work ok.\n// i would use an another approach, if there was one available.\n\nfunction makeStorageService() {\n  // we need to return an object that fulfills this interface:\n  // https://github.com/microsoft/vscode/blob/ff1e16eebb93af79fd6d7af1356c4003a120c563/src/vs/platform/storage/common/storage.ts#L37\n  // unfortunately it is not export from monaco-editor\n\n  const strings = new Map<string, string>();\n\n  // we want this to be true by default\n  strings.set('expandSuggestionDocs', true.toString());\n\n  return {\n    // we do not implement the on* handlers\n    onDidChangeValue: (data: unknown): void => undefined,\n    onDidChangeTarget: (data: unknown): void => undefined,\n    onWillSaveState: (data: unknown): void => undefined,\n\n    get: (key: string, scope: unknown, fallbackValue?: string): string | undefined => {\n      return strings.get(key) ?? fallbackValue;\n    },\n\n    getBoolean: (key: string, scope: unknown, fallbackValue?: boolean): boolean | undefined => {\n      const val = strings.get(key);\n      if (val !== undefined) {\n        // the interface-docs say the value will be converted\n        // to a boolean but do not specify how, so we improvise\n        return val === 'true';\n      } else {\n        return fallbackValue;\n      }\n    },\n\n    getNumber: (key: string, scope: unknown, fallbackValue?: number): number | undefined => {\n      const val = strings.get(key);\n      if (val !== undefined) {\n        return parseInt(val, 10);\n      } else {\n        return fallbackValue;\n      }\n    },\n\n    store: (\n      key: string,\n      value: string | boolean | number | undefined | null,\n      scope: unknown,\n      target: unknown\n    ): void => {\n      // the interface-docs say if the value is nullish, it should act as delete\n      if (value === null || value === undefined) {\n        strings.delete(key);\n      } else {\n        strings.set(key, value.toString());\n      }\n    },\n\n    remove: (key: string, scope: unknown): void => {\n      strings.delete(key);\n    },\n\n    keys: (scope: unknown, target: unknown): string[] => {\n      return Array.from(strings.keys());\n    },\n\n    logStorage: (): void => {\n      console.log('logStorage: not implemented');\n    },\n\n    migrate: (): Promise<void> => {\n      // we do not implement this\n      return Promise.resolve(undefined);\n    },\n\n    isNew: (scope: unknown): boolean => {\n      // we create a new storage for every session, we do not persist it,\n      // so we return `true`.\n      return true;\n    },\n\n    flush: (reason?: unknown): Promise<void> => {\n      // we do not implement this\n      return Promise.resolve(undefined);\n    },\n  };\n}\n\nlet overrideServices: monacoTypes.editor.IEditorOverrideServices | null = null;\n\nexport function getOverrideServices(): monacoTypes.editor.IEditorOverrideServices {\n  // only have one instance of this for every query editor\n  if (overrideServices === null) {\n    overrideServices = {\n      storageService: makeStorageService(),\n    };\n  }\n\n  return overrideServices;\n}\n","// this helper class is used to make typescript warn you when you forget\n// a case-block in a switch statement.\n// example code that triggers the typescript-error:\n//\n// const x:'A'|'B'|'C' = 'A';\n//\n// switch(x) {\n//   case 'A':\n//     // something\n//   case 'B':\n//     // something\n//   default:\n//     throw new NeverCaseError(x);\n// }\n//\n//\n// typescript will show an error in this case,\n// when you add the missing `case 'C'` code,\n// the problem will be fixed.\n\nexport class NeverCaseError extends Error {\n  constructor(value: never) {\n    super('should never happen');\n  }\n}\n","import { escapeLabelValueInExactSelector } from '../../../language_utils';\nimport { FUNCTIONS } from '../../../promql';\n\nimport type { Label, Situation } from './situation';\nimport { NeverCaseError } from './util';\n// FIXME: we should not load this from the \"outside\", but we cannot do that while we have the \"old\" query-field too\n\nexport type CompletionType = 'HISTORY' | 'FUNCTION' | 'METRIC_NAME' | 'DURATION' | 'LABEL_NAME' | 'LABEL_VALUE';\n\ntype Completion = {\n  type: CompletionType;\n  label: string;\n  insertText: string;\n  detail?: string;\n  documentation?: string;\n  triggerOnInsert?: boolean;\n};\n\ntype Metric = {\n  name: string;\n  help: string;\n  type: string;\n};\n\nexport type DataProvider = {\n  getHistory: () => Promise<string[]>;\n  getAllMetricNames: () => Promise<Metric[]>;\n  getAllLabelNames: () => Promise<string[]>;\n  getLabelValues: (labelName: string) => Promise<string[]>;\n  getSeriesValues: (name: string, match: string) => Promise<string[]>;\n  getSeriesLabels: (selector: string, otherLabels: Label[]) => Promise<string[]>;\n};\n\n// we order items like: history, functions, metrics\n\nasync function getAllMetricNamesCompletions(dataProvider: DataProvider): Promise<Completion[]> {\n  const metrics = await dataProvider.getAllMetricNames();\n  return metrics.map((metric) => ({\n    type: 'METRIC_NAME',\n    label: metric.name,\n    insertText: metric.name,\n    detail: `${metric.name} : ${metric.type}`,\n    documentation: metric.help,\n  }));\n}\n\nconst FUNCTION_COMPLETIONS: Completion[] = FUNCTIONS.map((f) => ({\n  type: 'FUNCTION',\n  label: f.label,\n  insertText: f.insertText ?? '', // i don't know what to do when this is nullish. it should not be.\n  detail: f.detail,\n  documentation: f.documentation,\n}));\n\nasync function getAllFunctionsAndMetricNamesCompletions(dataProvider: DataProvider): Promise<Completion[]> {\n  const metricNames = await getAllMetricNamesCompletions(dataProvider);\n  return [...FUNCTION_COMPLETIONS, ...metricNames];\n}\n\nconst DURATION_COMPLETIONS: Completion[] = [\n  '$__interval',\n  '$__range',\n  '$__rate_interval',\n  '1m',\n  '5m',\n  '10m',\n  '30m',\n  '1h',\n  '1d',\n].map((text) => ({\n  type: 'DURATION',\n  label: text,\n  insertText: text,\n}));\n\nasync function getAllHistoryCompletions(dataProvider: DataProvider): Promise<Completion[]> {\n  // function getAllHistoryCompletions(queryHistory: PromHistoryItem[]): Completion[] {\n  // NOTE: the typescript types are wrong. historyItem.query.expr can be undefined\n  const allHistory = await dataProvider.getHistory();\n  // FIXME: find a better history-limit\n  return allHistory.slice(0, 10).map((expr) => ({\n    type: 'HISTORY',\n    label: expr,\n    insertText: expr,\n  }));\n}\n\nfunction makeSelector(metricName: string | undefined, labels: Label[]): string {\n  const allLabels = [...labels];\n\n  // we transform the metricName to a label, if it exists\n  if (metricName !== undefined) {\n    allLabels.push({ name: '__name__', value: metricName, op: '=' });\n  }\n\n  const allLabelTexts = allLabels.map(\n    (label) => `${label.name}${label.op}\"${escapeLabelValueInExactSelector(label.value)}\"`\n  );\n\n  return `{${allLabelTexts.join(',')}}`;\n}\n\nasync function getLabelNames(\n  metric: string | undefined,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<string[]> {\n  if (metric === undefined && otherLabels.length === 0) {\n    // if there is no filtering, we have to use a special endpoint\n    return dataProvider.getAllLabelNames();\n  } else {\n    const selector = makeSelector(metric, otherLabels);\n    return await dataProvider.getSeriesLabels(selector, otherLabels);\n  }\n}\n\nasync function getLabelNamesForCompletions(\n  metric: string | undefined,\n  suffix: string,\n  triggerOnInsert: boolean,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<Completion[]> {\n  const labelNames = await getLabelNames(metric, otherLabels, dataProvider);\n  return labelNames.map((text) => ({\n    type: 'LABEL_NAME',\n    label: text,\n    insertText: `${text}${suffix}`,\n    triggerOnInsert,\n  }));\n}\n\nasync function getLabelNamesForSelectorCompletions(\n  metric: string | undefined,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<Completion[]> {\n  return getLabelNamesForCompletions(metric, '=', true, otherLabels, dataProvider);\n}\n\nasync function getLabelNamesForByCompletions(\n  metric: string | undefined,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<Completion[]> {\n  return getLabelNamesForCompletions(metric, '', false, otherLabels, dataProvider);\n}\n\nasync function getLabelValues(\n  metric: string | undefined,\n  labelName: string,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<string[]> {\n  if (metric === undefined && otherLabels.length === 0) {\n    // if there is no filtering, we have to use a special endpoint\n    return dataProvider.getLabelValues(labelName);\n  } else {\n    const selector = makeSelector(metric, otherLabels);\n    return await dataProvider.getSeriesValues(labelName, selector);\n  }\n}\n\nasync function getLabelValuesForMetricCompletions(\n  metric: string | undefined,\n  labelName: string,\n  betweenQuotes: boolean,\n  otherLabels: Label[],\n  dataProvider: DataProvider\n): Promise<Completion[]> {\n  const values = await getLabelValues(metric, labelName, otherLabels, dataProvider);\n  return values.map((text) => ({\n    type: 'LABEL_VALUE',\n    label: text,\n    insertText: betweenQuotes ? text : `\"${text}\"`, // FIXME: escaping strange characters?\n  }));\n}\n\nexport async function getCompletions(situation: Situation, dataProvider: DataProvider): Promise<Completion[]> {\n  switch (situation.type) {\n    case 'IN_DURATION':\n      return DURATION_COMPLETIONS;\n    case 'IN_FUNCTION':\n      return getAllFunctionsAndMetricNamesCompletions(dataProvider);\n    case 'AT_ROOT': {\n      return getAllFunctionsAndMetricNamesCompletions(dataProvider);\n    }\n    case 'EMPTY': {\n      const metricNames = await getAllMetricNamesCompletions(dataProvider);\n      const historyCompletions = await getAllHistoryCompletions(dataProvider);\n      return [...historyCompletions, ...FUNCTION_COMPLETIONS, ...metricNames];\n    }\n    case 'IN_LABEL_SELECTOR_NO_LABEL_NAME':\n      return getLabelNamesForSelectorCompletions(situation.metricName, situation.otherLabels, dataProvider);\n    case 'IN_GROUPING':\n      return getLabelNamesForByCompletions(situation.metricName, situation.otherLabels, dataProvider);\n    case 'IN_LABEL_SELECTOR_WITH_LABEL_NAME':\n      return getLabelValuesForMetricCompletions(\n        situation.metricName,\n        situation.labelName,\n        situation.betweenQuotes,\n        situation.otherLabels,\n        dataProvider\n      );\n    default:\n      throw new NeverCaseError(situation);\n  }\n}\n","import type { SyntaxNode, Tree } from '@lezer/common';\nimport {\n  AggregateExpr,\n  AggregateModifier,\n  EqlRegex,\n  EqlSingle,\n  FunctionCallBody,\n  GroupingLabels,\n  Identifier,\n  LabelMatcher,\n  LabelMatchers,\n  LabelMatchList,\n  LabelName,\n  MatchOp,\n  MatrixSelector,\n  MetricIdentifier,\n  Neq,\n  NeqRegex,\n  parser,\n  PromQL,\n  StringLiteral,\n  VectorSelector,\n} from '@prometheus-io/lezer-promql';\n\nimport { NeverCaseError } from './util';\n\ntype Direction = 'parent' | 'firstChild' | 'lastChild' | 'nextSibling';\n\ntype NodeTypeId =\n  | 0 // this is used as error-id\n  | typeof AggregateExpr\n  | typeof AggregateModifier\n  | typeof FunctionCallBody\n  | typeof GroupingLabels\n  | typeof Identifier\n  | typeof LabelMatcher\n  | typeof LabelMatchers\n  | typeof LabelMatchList\n  | typeof LabelName\n  | typeof MetricIdentifier\n  | typeof PromQL\n  | typeof StringLiteral\n  | typeof VectorSelector\n  | typeof MatrixSelector\n  | typeof MatchOp\n  | typeof EqlSingle\n  | typeof Neq\n  | typeof EqlRegex\n  | typeof NeqRegex;\n\ntype Path = Array<[Direction, NodeTypeId]>;\n\nfunction move(node: SyntaxNode, direction: Direction): SyntaxNode | null {\n  switch (direction) {\n    case 'parent':\n      return node.parent;\n    case 'firstChild':\n      return node.firstChild;\n    case 'lastChild':\n      return node.lastChild;\n    case 'nextSibling':\n      return node.nextSibling;\n    default:\n      throw new NeverCaseError(direction);\n  }\n}\n\nfunction walk(node: SyntaxNode, path: Path): SyntaxNode | null {\n  let current: SyntaxNode | null = node;\n  for (const [direction, expectedType] of path) {\n    current = move(current, direction);\n    if (current === null) {\n      // we could not move in the direction, we stop\n      return null;\n    }\n    if (current.type.id !== expectedType) {\n      // the reached node has wrong type, we stop\n      return null;\n    }\n  }\n  return current;\n}\n\nfunction getNodeText(node: SyntaxNode, text: string): string {\n  return text.slice(node.from, node.to);\n}\n\nfunction parsePromQLStringLiteral(text: string): string {\n  // if it is a string-literal, it is inside quotes of some kind\n  const inside = text.slice(1, text.length - 1);\n\n  // FIXME: support https://prometheus.io/docs/prometheus/latest/querying/basics/#string-literals\n  // FIXME: maybe check other promql code, if all is supported or not\n\n  // for now we do only some very simple un-escaping\n\n  // we start with double-quotes\n  if (text.startsWith('\"') && text.endsWith('\"')) {\n    // NOTE: this is not 100% perfect, we only unescape the double-quote,\n    // there might be other characters too\n    return inside.replace(/\\\\\"/, '\"');\n  }\n\n  // then single-quote\n  if (text.startsWith(\"'\") && text.endsWith(\"'\")) {\n    // NOTE: this is not 100% perfect, we only unescape the single-quote,\n    // there might be other characters too\n    return inside.replace(/\\\\'/, \"'\");\n  }\n\n  // then backticks\n  if (text.startsWith('`') && text.endsWith('`')) {\n    return inside;\n  }\n\n  throw new Error('FIXME: invalid string literal');\n}\n\ntype LabelOperator = '=' | '!=' | '=~' | '!~';\n\nexport type Label = {\n  name: string;\n  value: string;\n  op: LabelOperator;\n};\n\nexport type Situation =\n  | {\n      type: 'IN_FUNCTION';\n    }\n  | {\n      type: 'AT_ROOT';\n    }\n  | {\n      type: 'EMPTY';\n    }\n  | {\n      type: 'IN_DURATION';\n    }\n  | {\n      type: 'IN_LABEL_SELECTOR_NO_LABEL_NAME';\n      metricName?: string;\n      otherLabels: Label[];\n    }\n  | {\n      type: 'IN_GROUPING';\n      metricName: string;\n      otherLabels: Label[];\n    }\n  | {\n      type: 'IN_LABEL_SELECTOR_WITH_LABEL_NAME';\n      metricName?: string;\n      labelName: string;\n      betweenQuotes: boolean;\n      otherLabels: Label[];\n    };\n\ntype Resolver = {\n  path: NodeTypeId[];\n  fun: (node: SyntaxNode, text: string, pos: number) => Situation | null;\n};\n\nfunction isPathMatch(resolverPath: NodeTypeId[], cursorPath: number[]): boolean {\n  return resolverPath.every((item, index) => item === cursorPath[index]);\n}\n\nconst ERROR_NODE_NAME: NodeTypeId = 0; // this is used as error-id\n\nconst RESOLVERS: Resolver[] = [\n  {\n    path: [LabelMatchers, VectorSelector],\n    fun: resolveLabelKeysWithEquals,\n  },\n  {\n    path: [PromQL],\n    fun: resolveTopLevel,\n  },\n  {\n    path: [FunctionCallBody],\n    fun: resolveInFunction,\n  },\n  {\n    path: [StringLiteral, LabelMatcher],\n    fun: resolveLabelMatcher,\n  },\n  {\n    path: [ERROR_NODE_NAME, LabelMatcher],\n    fun: resolveLabelMatcher,\n  },\n  {\n    path: [ERROR_NODE_NAME, MatrixSelector],\n    fun: resolveDurations,\n  },\n  {\n    path: [GroupingLabels],\n    fun: resolveLabelsForGrouping,\n  },\n];\n\nconst LABEL_OP_MAP = new Map<number, LabelOperator>([\n  [EqlSingle, '='],\n  [EqlRegex, '=~'],\n  [Neq, '!='],\n  [NeqRegex, '!~'],\n]);\n\nfunction getLabelOp(opNode: SyntaxNode): LabelOperator | null {\n  const opChild = opNode.firstChild;\n  if (opChild === null) {\n    return null;\n  }\n\n  return LABEL_OP_MAP.get(opChild.type.id) ?? null;\n}\n\nfunction getLabel(labelMatcherNode: SyntaxNode, text: string): Label | null {\n  if (labelMatcherNode.type.id !== LabelMatcher) {\n    return null;\n  }\n\n  const nameNode = walk(labelMatcherNode, [['firstChild', LabelName]]);\n\n  if (nameNode === null) {\n    return null;\n  }\n\n  const opNode = walk(nameNode, [['nextSibling', MatchOp]]);\n  if (opNode === null) {\n    return null;\n  }\n\n  const op = getLabelOp(opNode);\n  if (op === null) {\n    return null;\n  }\n\n  const valueNode = walk(labelMatcherNode, [['lastChild', StringLiteral]]);\n\n  if (valueNode === null) {\n    return null;\n  }\n\n  const name = getNodeText(nameNode, text);\n  const value = parsePromQLStringLiteral(getNodeText(valueNode, text));\n\n  return { name, value, op };\n}\n\nfunction getLabels(labelMatchersNode: SyntaxNode, text: string): Label[] {\n  if (labelMatchersNode.type.id !== LabelMatchers) {\n    return [];\n  }\n\n  let listNode: SyntaxNode | null = walk(labelMatchersNode, [['firstChild', LabelMatchList]]);\n\n  const labels: Label[] = [];\n\n  while (listNode !== null) {\n    const matcherNode = walk(listNode, [['lastChild', LabelMatcher]]);\n    if (matcherNode === null) {\n      // unexpected, we stop\n      return [];\n    }\n\n    const label = getLabel(matcherNode, text);\n    if (label !== null) {\n      labels.push(label);\n    }\n\n    // there might be more labels\n    listNode = walk(listNode, [['firstChild', LabelMatchList]]);\n  }\n\n  // our labels-list is last-first, so we reverse it\n  labels.reverse();\n\n  return labels;\n}\n\nfunction getNodeChildren(node: SyntaxNode): SyntaxNode[] {\n  let child: SyntaxNode | null = node.firstChild;\n  const children: SyntaxNode[] = [];\n  while (child !== null) {\n    children.push(child);\n    child = child.nextSibling;\n  }\n  return children;\n}\n\nfunction getNodeInSubtree(node: SyntaxNode, typeId: NodeTypeId): SyntaxNode | null {\n  // first we try the current node\n  if (node.type.id === typeId) {\n    return node;\n  }\n\n  // then we try the children\n  const children = getNodeChildren(node);\n  for (const child of children) {\n    const n = getNodeInSubtree(child, typeId);\n    if (n !== null) {\n      return n;\n    }\n  }\n\n  return null;\n}\n\nfunction resolveLabelsForGrouping(node: SyntaxNode, text: string, pos: number): Situation | null {\n  const aggrExpNode = walk(node, [\n    ['parent', AggregateModifier],\n    ['parent', AggregateExpr],\n  ]);\n  if (aggrExpNode === null) {\n    return null;\n  }\n  const bodyNode = aggrExpNode.getChild(FunctionCallBody);\n  if (bodyNode === null) {\n    return null;\n  }\n\n  const metricIdNode = getNodeInSubtree(bodyNode, MetricIdentifier);\n  if (metricIdNode === null) {\n    return null;\n  }\n\n  const idNode = walk(metricIdNode, [['firstChild', Identifier]]);\n  if (idNode === null) {\n    return null;\n  }\n\n  const metricName = getNodeText(idNode, text);\n  return {\n    type: 'IN_GROUPING',\n    metricName,\n    otherLabels: [],\n  };\n}\n\nfunction resolveLabelMatcher(node: SyntaxNode, text: string, pos: number): Situation | null {\n  // we can arrive here in two situation. `node` is either:\n  // - a StringNode (like in `{job=\"^\"}`)\n  // - or an error node (like in `{job=^}`)\n  const inStringNode = !node.type.isError;\n\n  const parent = walk(node, [['parent', LabelMatcher]]);\n  if (parent === null) {\n    return null;\n  }\n\n  const labelNameNode = walk(parent, [['firstChild', LabelName]]);\n  if (labelNameNode === null) {\n    return null;\n  }\n\n  const labelName = getNodeText(labelNameNode, text);\n\n  // now we need to go up, to the parent of LabelMatcher,\n  // there can be one or many `LabelMatchList` parents, we have\n  // to go through all of them\n\n  const firstListNode = walk(parent, [['parent', LabelMatchList]]);\n  if (firstListNode === null) {\n    return null;\n  }\n\n  let listNode = firstListNode;\n\n  // we keep going through the parent-nodes\n  // as long as they are LabelMatchList.\n  // as soon as we reawch LabelMatchers, we stop\n  let labelMatchersNode: SyntaxNode | null = null;\n  while (labelMatchersNode === null) {\n    const p = listNode.parent;\n    if (p === null) {\n      return null;\n    }\n\n    const { id } = p.type;\n\n    switch (id) {\n      case LabelMatchList:\n        //we keep looping\n        listNode = p;\n        continue;\n      case LabelMatchers:\n        // we reached the end, we can stop the loop\n        labelMatchersNode = p;\n        continue;\n      default:\n        // we reached some other node, we stop\n        return null;\n    }\n  }\n\n  // now we need to find the other names\n  const allLabels = getLabels(labelMatchersNode, text);\n\n  // we need to remove \"our\" label from all-labels, if it is in there\n  const otherLabels = allLabels.filter((label) => label.name !== labelName);\n\n  const metricNameNode = walk(labelMatchersNode, [\n    ['parent', VectorSelector],\n    ['firstChild', MetricIdentifier],\n    ['firstChild', Identifier],\n  ]);\n\n  if (metricNameNode === null) {\n    // we are probably in a situation without a metric name\n    return {\n      type: 'IN_LABEL_SELECTOR_WITH_LABEL_NAME',\n      labelName,\n      betweenQuotes: inStringNode,\n      otherLabels,\n    };\n  }\n\n  const metricName = getNodeText(metricNameNode, text);\n\n  return {\n    type: 'IN_LABEL_SELECTOR_WITH_LABEL_NAME',\n    metricName,\n    labelName,\n    betweenQuotes: inStringNode,\n    otherLabels,\n  };\n}\n\nfunction resolveTopLevel(node: SyntaxNode, text: string, pos: number): Situation {\n  return {\n    type: 'AT_ROOT',\n  };\n}\n\nfunction resolveInFunction(node: SyntaxNode, text: string, pos: number): Situation {\n  return {\n    type: 'IN_FUNCTION',\n  };\n}\n\nfunction resolveDurations(node: SyntaxNode, text: string, pos: number): Situation {\n  return {\n    type: 'IN_DURATION',\n  };\n}\n\nfunction subTreeHasError(node: SyntaxNode): boolean {\n  return getNodeInSubtree(node, ERROR_NODE_NAME) !== null;\n}\n\nfunction resolveLabelKeysWithEquals(node: SyntaxNode, text: string, pos: number): Situation | null {\n  // for example `something{^}`\n\n  // there are some false positives that can end up in this situation, that we want\n  // to eliminate:\n  // `something{a~^}` (if this subtree contains any error-node, we stop)\n  if (subTreeHasError(node)) {\n    return null;\n  }\n\n  // next false positive:\n  // `something{a=\"1\"^}`\n  const child = walk(node, [['firstChild', LabelMatchList]]);\n  if (child !== null) {\n    // means the label-matching part contains at least one label already.\n    //\n    // in this case, we will need to have a `,` character at the end,\n    // to be able to suggest adding the next label.\n    // the area between the end-of-the-child-node and the cursor-pos\n    // must contain a `,` in this case.\n    const textToCheck = text.slice(child.to, pos);\n\n    if (!textToCheck.includes(',')) {\n      return null;\n    }\n  }\n\n  const metricNameNode = walk(node, [\n    ['parent', VectorSelector],\n    ['firstChild', MetricIdentifier],\n    ['firstChild', Identifier],\n  ]);\n\n  const otherLabels = getLabels(node, text);\n\n  if (metricNameNode === null) {\n    // we are probably in a situation without a metric name.\n    return {\n      type: 'IN_LABEL_SELECTOR_NO_LABEL_NAME',\n      otherLabels,\n    };\n  }\n\n  const metricName = getNodeText(metricNameNode, text);\n\n  return {\n    type: 'IN_LABEL_SELECTOR_NO_LABEL_NAME',\n    metricName,\n    otherLabels,\n  };\n}\n\n// we find the first error-node in the tree that is at the cursor-position.\n// NOTE: this might be too slow, might need to optimize it\n// (ideas: we do not need to go into every subtree, based on from/to)\n// also, only go to places that are in the sub-tree of the node found\n// by default by lezer. problem is, `next()` will go upward too,\n// and we do not want to go higher than our node\nfunction getErrorNode(tree: Tree, pos: number): SyntaxNode | null {\n  const cur = tree.cursorAt(pos);\n  while (true) {\n    if (cur.from === pos && cur.to === pos) {\n      const { node } = cur;\n      if (node.type.isError) {\n        return node;\n      }\n    }\n\n    if (!cur.next()) {\n      break;\n    }\n  }\n  return null;\n}\n\nexport function getSituation(text: string, pos: number): Situation | null {\n  // there is a special-case when we are at the start of writing text,\n  // so we handle that case first\n\n  if (text === '') {\n    return {\n      type: 'EMPTY',\n    };\n  }\n\n  /*\n      PromQL\n    Expr\n    VectorSelector\n    LabelMatchers\n    */\n  const tree = parser.parse(text);\n\n  // if the tree contains error, it is very probable that\n  // our node is one of those error-nodes.\n  // also, if there are errors, the node lezer finds us,\n  // might not be the best node.\n  // so first we check if there is an error-node at the cursor-position\n  // @ts-ignore\n  const maybeErrorNode = getErrorNode(tree, pos);\n\n  const cur = maybeErrorNode != null ? maybeErrorNode.cursor() : tree.cursorAt(pos);\n  const currentNode = cur.node;\n\n  const ids = [cur.type.id];\n  while (cur.parent()) {\n    ids.push(cur.type.id);\n  }\n\n  for (let resolver of RESOLVERS) {\n    // i do not use a foreach because i want to stop as soon\n    // as i find something\n    if (isPathMatch(resolver.path, ids)) {\n      // @ts-ignore\n      return resolver.fun(currentNode, text, pos);\n    }\n  }\n\n  return null;\n}\n","import type { Monaco, monacoTypes } from '@grafana/ui';\n\nimport { CompletionType, DataProvider, getCompletions } from './completions';\nimport { getSituation } from './situation';\nimport { NeverCaseError } from './util';\n\nexport function getSuggestOptions(): monacoTypes.editor.ISuggestOptions {\n  return {\n    // monaco-editor sometimes provides suggestions automatically, i am not\n    // sure based on what, seems to be by analyzing the words already\n    // written.\n    // to try it out:\n    // - enter `go_goroutines{job~`\n    // - have the cursor at the end of the string\n    // - press ctrl-enter\n    // - you will get two suggestions\n    // those were not provided by grafana, they are offered automatically.\n    // i want to remove those. the only way i found is:\n    // - every suggestion-item has a `kind` attribute,\n    //   that controls the icon to the left of the suggestion.\n    // - items auto-generated by monaco have `kind` set to `text`.\n    // - we make sure grafana-provided suggestions do not have `kind` set to `text`.\n    // - and then we tell monaco not to show suggestions of kind `text`\n    showWords: false,\n  };\n}\n\nfunction getMonacoCompletionItemKind(type: CompletionType, monaco: Monaco): monacoTypes.languages.CompletionItemKind {\n  switch (type) {\n    case 'DURATION':\n      return monaco.languages.CompletionItemKind.Unit;\n    case 'FUNCTION':\n      return monaco.languages.CompletionItemKind.Variable;\n    case 'HISTORY':\n      return monaco.languages.CompletionItemKind.Snippet;\n    case 'LABEL_NAME':\n      return monaco.languages.CompletionItemKind.Enum;\n    case 'LABEL_VALUE':\n      return monaco.languages.CompletionItemKind.EnumMember;\n    case 'METRIC_NAME':\n      return monaco.languages.CompletionItemKind.Constructor;\n    default:\n      throw new NeverCaseError(type);\n  }\n}\n\nexport function getCompletionProvider(\n  monaco: Monaco,\n  dataProvider: DataProvider\n): monacoTypes.languages.CompletionItemProvider {\n  const provideCompletionItems = (\n    model: monacoTypes.editor.ITextModel,\n    position: monacoTypes.Position\n  ): monacoTypes.languages.ProviderResult<monacoTypes.languages.CompletionList> => {\n    const word = model.getWordAtPosition(position);\n    const range =\n      word != null\n        ? monaco.Range.lift({\n            startLineNumber: position.lineNumber,\n            endLineNumber: position.lineNumber,\n            startColumn: word.startColumn,\n            endColumn: word.endColumn,\n          })\n        : monaco.Range.fromPositions(position);\n    // documentation says `position` will be \"adjusted\" in `getOffsetAt`\n    // i don't know what that means, to be sure i clone it\n\n    const positionClone = {\n      column: position.column,\n      lineNumber: position.lineNumber,\n    };\n\n    // Check to see if the browser supports window.getSelection()\n    if (window.getSelection) {\n      const selectedText = window.getSelection()?.toString();\n      // If the user has selected text, adjust the cursor position to be at the start of the selection, instead of the end\n      if (selectedText && selectedText.length > 0) {\n        positionClone.column = positionClone.column - selectedText.length;\n      }\n    }\n\n    const offset = model.getOffsetAt(positionClone);\n    const situation = getSituation(model.getValue(), offset);\n    const completionsPromise = situation != null ? getCompletions(situation, dataProvider) : Promise.resolve([]);\n    return completionsPromise.then((items) => {\n      // monaco by-default alphabetically orders the items.\n      // to stop it, we use a number-as-string sortkey,\n      // so that monaco keeps the order we use\n      const maxIndexDigits = items.length.toString().length;\n      const suggestions: monacoTypes.languages.CompletionItem[] = items.map((item, index) => ({\n        kind: getMonacoCompletionItemKind(item.type, monaco),\n        label: item.label,\n        insertText: item.insertText,\n        detail: item.detail,\n        documentation: item.documentation,\n        sortText: index.toString().padStart(maxIndexDigits, '0'), // to force the order we have\n        range,\n        command: item.triggerOnInsert\n          ? {\n              id: 'editor.action.triggerSuggest',\n              title: '',\n            }\n          : undefined,\n      }));\n      return { suggestions };\n    });\n  };\n\n  return {\n    triggerCharacters: ['{', ',', '[', '(', '=', '~', ' ', '\"'],\n    provideCompletionItems,\n  };\n}\n","import { SyntaxNode } from '@lezer/common';\nimport { LRParser } from '@lezer/lr';\n\n// Although 0 isn't explicitly provided in the @grafana/lezer-logql library as the error node ID, it does appear to be the ID of error nodes within lezer.\nexport const ErrorId = 0;\n\ninterface ParserErrorBoundary {\n  startLineNumber: number;\n  startColumn: number;\n  endLineNumber: number;\n  endColumn: number;\n  error: string;\n}\n\ninterface ParseError {\n  text: string;\n  node: SyntaxNode;\n}\n\n/**\n * Conceived to work in combination with the MonacoQueryField component.\n * Given an original query, and it's interpolated version, it will return an array of ParserErrorBoundary\n * objects containing nodes which are actual errors. The interpolated version (even with placeholder variables)\n * is required because variables look like errors for Lezer.\n * @internal\n */\nexport function validateQuery(\n  query: string,\n  interpolatedQuery: string,\n  queryLines: string[],\n  parser: LRParser\n): ParserErrorBoundary[] | false {\n  if (!query) {\n    return false;\n  }\n\n  /**\n   * To provide support to variable interpolation in query validation, we run the parser in the interpolated\n   * query. If there are errors there, we trace them back to the original unparsed query, so we can more\n   * accurately highlight the error in the query, since it's likely that the variable name and variable value\n   * have different lengths. With this, we also exclude irrelevant parser errors that are produced by\n   * lezer not understanding $variables and $__variables, which usually generate 2 or 3 error SyntaxNode.\n   */\n  const interpolatedErrors: ParseError[] = parseQuery(interpolatedQuery, parser);\n  if (!interpolatedErrors.length) {\n    return false;\n  }\n\n  let parseErrors: ParseError[] = interpolatedErrors;\n  if (query !== interpolatedQuery) {\n    const queryErrors: ParseError[] = parseQuery(query, parser);\n    parseErrors = interpolatedErrors.flatMap(\n      (interpolatedError) =>\n        queryErrors.filter((queryError) => interpolatedError.text === queryError.text) || interpolatedError\n    );\n  }\n\n  return parseErrors.map((parseError) => findErrorBoundary(query, queryLines, parseError)).filter(isErrorBoundary);\n}\n\nfunction parseQuery(query: string, parser: LRParser) {\n  const parseErrors: ParseError[] = [];\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (nodeRef): false | void => {\n      if (nodeRef.type.id === ErrorId) {\n        const node = nodeRef.node;\n        parseErrors.push({\n          node: node,\n          text: query.substring(node.from, node.to),\n        });\n      }\n    },\n  });\n  return parseErrors;\n}\n\nfunction findErrorBoundary(query: string, queryLines: string[], parseError: ParseError): ParserErrorBoundary | null {\n  if (queryLines.length === 1) {\n    const isEmptyString = parseError.node.from === parseError.node.to;\n    const errorNode = isEmptyString && parseError.node.parent ? parseError.node.parent : parseError.node;\n    const error = isEmptyString ? query.substring(errorNode.from, errorNode.to) : parseError.text;\n    return {\n      startLineNumber: 1,\n      startColumn: errorNode.from + 1,\n      endLineNumber: 1,\n      endColumn: errorNode.to + 1,\n      error,\n    };\n  }\n\n  let startPos = 0,\n    endPos = 0;\n  for (let line = 0; line < queryLines.length; line++) {\n    endPos = startPos + queryLines[line].length;\n\n    if (parseError.node.from > endPos) {\n      startPos += queryLines[line].length + 1;\n      continue;\n    }\n\n    return {\n      startLineNumber: line + 1,\n      startColumn: parseError.node.from - startPos + 1,\n      endLineNumber: line + 1,\n      endColumn: parseError.node.to - startPos + 1,\n      error: parseError.text,\n    };\n  }\n\n  return null;\n}\n\nfunction isErrorBoundary(boundary: ParserErrorBoundary | null): boundary is ParserErrorBoundary {\n  return boundary !== null;\n}\n\nexport const placeHolderScopedVars = {\n  __interval: { text: '1s', value: '1s' },\n  __rate_interval: { text: '1s', value: '1s' },\n  __auto: { text: '1s', value: '1s' },\n  __interval_ms: { text: '1000', value: 1000 },\n  __range_ms: { text: '1000', value: 1000 },\n  __range_s: { text: '1', value: 1 },\n  __range: { text: '1s', value: '1s' },\n};\n","// The MIT License (MIT)\n//\n// Copyright (c) Celian Garcia and Augustin Husson @ Amadeus IT Group\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n'use strict';\n// import { languages } from \"monaco-editor\";\n// noinspection JSUnusedGlobalSymbols\nexport const languageConfiguration = {\n  // the default separators except `@$`\n  wordPattern: /(-?\\d*\\.\\d\\w*)|([^`~!#%^&*()\\-=+\\[{\\]}\\\\|;:'\",.<>\\/?\\s]+)/g,\n  // Not possible to make comments in PromQL syntax\n  comments: {\n    lineComment: '#',\n  },\n  brackets: [\n    ['{', '}'],\n    ['[', ']'],\n    ['(', ')'],\n  ],\n  autoClosingPairs: [\n    { open: '{', close: '}' },\n    { open: '[', close: ']' },\n    { open: '(', close: ')' },\n    { open: '\"', close: '\"' },\n    { open: \"'\", close: \"'\" },\n  ],\n  surroundingPairs: [\n    { open: '{', close: '}' },\n    { open: '[', close: ']' },\n    { open: '(', close: ')' },\n    { open: '\"', close: '\"' },\n    { open: \"'\", close: \"'\" },\n    { open: '<', close: '>' },\n  ],\n  folding: {},\n};\n// PromQL Aggregation Operators\n// (https://prometheus.io/docs/prometheus/latest/querying/operators/#aggregation-operators)\nconst aggregations = [\n  'sum',\n  'min',\n  'max',\n  'avg',\n  'group',\n  'stddev',\n  'stdvar',\n  'count',\n  'count_values',\n  'bottomk',\n  'topk',\n  'quantile',\n];\n// PromQL functions\n// (https://prometheus.io/docs/prometheus/latest/querying/functions/)\nconst functions = [\n  'abs',\n  'absent',\n  'ceil',\n  'changes',\n  'clamp_max',\n  'clamp_min',\n  'day_of_month',\n  'day_of_week',\n  'days_in_month',\n  'delta',\n  'deriv',\n  'exp',\n  'floor',\n  'histogram_quantile',\n  'holt_winters',\n  'hour',\n  'idelta',\n  'increase',\n  'irate',\n  'label_join',\n  'label_replace',\n  'ln',\n  'log2',\n  'log10',\n  'minute',\n  'month',\n  'predict_linear',\n  'rate',\n  'resets',\n  'round',\n  'scalar',\n  'sort',\n  'sort_desc',\n  'sqrt',\n  'time',\n  'timestamp',\n  'vector',\n  'year',\n];\n// PromQL specific functions: Aggregations over time\n// (https://prometheus.io/docs/prometheus/latest/querying/functions/#aggregation_over_time)\nconst aggregationsOverTime = [];\nfor (let _i = 0, aggregations_1 = aggregations; _i < aggregations_1.length; _i++) {\n  let agg = aggregations_1[_i];\n  aggregationsOverTime.push(agg + '_over_time');\n}\n// PromQL vector matching + the by and without clauses\n// (https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching)\nconst vectorMatching = ['on', 'ignoring', 'group_right', 'group_left', 'by', 'without'];\n// Produce a regex matching elements : (elt1|elt2|...)\nconst vectorMatchingRegex =\n  '(' +\n  vectorMatching.reduce(function (prev, curr) {\n    return prev + '|' + curr;\n  }) +\n  ')';\n// PromQL Operators\n// (https://prometheus.io/docs/prometheus/latest/querying/operators/)\nconst operators = ['+', '-', '*', '/', '%', '^', '==', '!=', '>', '<', '>=', '<=', 'and', 'or', 'unless'];\n// PromQL offset modifier\n// (https://prometheus.io/docs/prometheus/latest/querying/basics/#offset-modifier)\nconst offsetModifier = ['offset'];\n// Merging all the keywords in one list\nconst keywords = aggregations\n  .concat(functions)\n  .concat(aggregationsOverTime)\n  .concat(vectorMatching)\n  .concat(offsetModifier);\n// noinspection JSUnusedGlobalSymbols\nexport const language = {\n  ignoreCase: false,\n  defaultToken: '',\n  tokenPostfix: '.promql',\n  keywords: keywords,\n  operators: operators,\n  vectorMatching: vectorMatchingRegex,\n  // we include these common regular expressions\n  symbols: /[=><!~?:&|+\\-*\\/^%]+/,\n  escapes: /\\\\(?:[abfnrtv\\\\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,\n  digits: /\\d+(_+\\d+)*/,\n  octaldigits: /[0-7]+(_+[0-7]+)*/,\n  binarydigits: /[0-1]+(_+[0-1]+)*/,\n  hexdigits: /[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,\n  integersuffix: /(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,\n  floatsuffix: /[fFlL]?/,\n  // The main tokenizer for our languages\n  tokenizer: {\n    root: [\n      // 'by', 'without' and vector matching\n      [/@vectorMatching\\s*(?=\\()/, 'type', '@clauses'],\n      // labels\n      [/[a-z_]\\w*(?=\\s*(=|!=|=~|!~))/, 'tag'],\n      // comments\n      [/(^#.*$)/, 'comment'],\n      // all keywords have the same color\n      [\n        /[a-zA-Z_]\\w*/,\n        {\n          cases: {\n            '@keywords': 'type',\n            '@default': 'identifier',\n          },\n        },\n      ],\n      // strings\n      [/\"([^\"\\\\]|\\\\.)*$/, 'string.invalid'],\n      [/'([^'\\\\]|\\\\.)*$/, 'string.invalid'],\n      [/\"/, 'string', '@string_double'],\n      [/'/, 'string', '@string_single'],\n      [/`/, 'string', '@string_backtick'],\n      // whitespace\n      { include: '@whitespace' },\n      // delimiters and operators\n      [/[{}()\\[\\]]/, '@brackets'],\n      [/[<>](?!@symbols)/, '@brackets'],\n      [\n        /@symbols/,\n        {\n          cases: {\n            '@operators': 'delimiter',\n            '@default': '',\n          },\n        },\n      ],\n      // numbers\n      [/\\d+[smhdwy]/, 'number'],\n      [/\\d*\\d+[eE]([\\-+]?\\d+)?(@floatsuffix)/, 'number.float'],\n      [/\\d*\\.\\d+([eE][\\-+]?\\d+)?(@floatsuffix)/, 'number.float'],\n      [/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/, 'number.hex'],\n      [/0[0-7']*[0-7](@integersuffix)/, 'number.octal'],\n      [/0[bB][0-1']*[0-1](@integersuffix)/, 'number.binary'],\n      [/\\d[\\d']*\\d(@integersuffix)/, 'number'],\n      [/\\d(@integersuffix)/, 'number'],\n    ],\n    string_double: [\n      [/[^\\\\\"]+/, 'string'],\n      [/@escapes/, 'string.escape'],\n      [/\\\\./, 'string.escape.invalid'],\n      [/\"/, 'string', '@pop'],\n    ],\n    string_single: [\n      [/[^\\\\']+/, 'string'],\n      [/@escapes/, 'string.escape'],\n      [/\\\\./, 'string.escape.invalid'],\n      [/'/, 'string', '@pop'],\n    ],\n    string_backtick: [\n      [/[^\\\\`$]+/, 'string'],\n      [/@escapes/, 'string.escape'],\n      [/\\\\./, 'string.escape.invalid'],\n      [/`/, 'string', '@pop'],\n    ],\n    clauses: [\n      [/[^(,)]/, 'tag'],\n      [/\\)/, 'identifier', '@pop'],\n    ],\n    whitespace: [[/[ \\t\\r\\n]+/, 'white']],\n  },\n};\n// noinspection JSUnusedGlobalSymbols\n// export const completionItemProvider = {\n//     provideCompletionItems: function () {\n//         // To simplify, we made the choice to never create automatically the parenthesis behind keywords\n//         // It is because in PromQL, some keywords need parenthesis behind, some don't, some can have but it's optional.\n//         const suggestions = keywords.map(function (value) {\n//             return {\n//                 label: value,\n//                 kind: languages.CompletionItemKind.Keyword,\n//                 insertText: value,\n//                 insertTextRules: languages.CompletionItemInsertTextRule.InsertAsSnippet\n//             };\n//         });\n//         return { suggestions: suggestions };\n//     }\n// };\n","import { css } from '@emotion/css';\nimport { parser } from '@prometheus-io/lezer-promql';\nimport { debounce } from 'lodash';\nimport { promLanguageDefinition } from 'monaco-promql';\nimport React, { useEffect, useRef } from 'react';\nimport { useLatest } from 'react-use';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Monaco, monacoTypes, ReactMonacoEditor, useTheme2 } from '@grafana/ui';\n\nimport { Props } from './MonacoQueryFieldProps';\nimport { getOverrideServices } from './getOverrideServices';\nimport { getCompletionProvider, getSuggestOptions } from './monaco-completion-provider';\nimport { placeHolderScopedVars, validateQuery } from './monaco-completion-provider/validation';\nimport { language, languageConfiguration } from './promql';\n\nconst options: monacoTypes.editor.IStandaloneEditorConstructionOptions = {\n  codeLens: false,\n  contextmenu: false,\n  // we need `fixedOverflowWidgets` because otherwise in grafana-dashboards\n  // the popup is clipped by the panel-visualizations.\n  fixedOverflowWidgets: true,\n  folding: false,\n  fontSize: 14,\n  lineDecorationsWidth: 8, // used as \"padding-left\"\n  lineNumbers: 'off',\n  minimap: { enabled: false },\n  overviewRulerBorder: false,\n  overviewRulerLanes: 0,\n  padding: {\n    // these numbers were picked so that visually this matches the previous version\n    // of the query-editor the best\n    top: 4,\n    bottom: 5,\n  },\n  renderLineHighlight: 'none',\n  scrollbar: {\n    vertical: 'hidden',\n    verticalScrollbarSize: 8, // used as \"padding-right\"\n    horizontal: 'hidden',\n    horizontalScrollbarSize: 0,\n    alwaysConsumeMouseWheel: false,\n  },\n  scrollBeyondLastLine: false,\n  suggest: getSuggestOptions(),\n  suggestFontSize: 12,\n  wordWrap: 'on',\n};\n\n// this number was chosen by testing various values. it might be necessary\n// because of the width of the border, not sure.\n//it needs to do 2 things:\n// 1. when the editor is single-line, it should make the editor height be visually correct\n// 2. when the editor is multi-line, the editor should not be \"scrollable\" (meaning,\n//    you do a scroll-movement in the editor, and it will scroll the content by a couple pixels\n//    up & down. this we want to avoid)\nconst EDITOR_HEIGHT_OFFSET = 2;\n\nconst PROMQL_LANG_ID = promLanguageDefinition.id;\n\n// we must only run the promql-setup code once\nlet PROMQL_SETUP_STARTED = false;\n\nfunction ensurePromQL(monaco: Monaco) {\n  if (PROMQL_SETUP_STARTED === false) {\n    PROMQL_SETUP_STARTED = true;\n    const { aliases, extensions, mimetypes } = promLanguageDefinition;\n    monaco.languages.register({ id: PROMQL_LANG_ID, aliases, extensions, mimetypes });\n\n    // @ts-ignore\n    monaco.languages.setMonarchTokensProvider(PROMQL_LANG_ID, language);\n    // @ts-ignore\n    monaco.languages.setLanguageConfiguration(PROMQL_LANG_ID, languageConfiguration);\n  }\n}\n\nconst getStyles = (theme: GrafanaTheme2, placeholder: string) => {\n  return {\n    container: css`\n      border-radius: ${theme.shape.radius.default};\n      border: 1px solid ${theme.components.input.borderColor};\n    `,\n    placeholder: css`\n      ::after {\n        content: '${placeholder}';\n        font-family: ${theme.typography.fontFamilyMonospace};\n        opacity: 0.6;\n      }\n    `,\n  };\n};\n\nconst MonacoQueryField = (props: Props) => {\n  const id = uuidv4();\n\n  // we need only one instance of `overrideServices` during the lifetime of the react component\n  const overrideServicesRef = useRef(getOverrideServices());\n  const containerRef = useRef<HTMLDivElement>(null);\n  const { languageProvider, history, onBlur, onRunQuery, initialValue, placeholder, onChange, datasource } = props;\n\n  const lpRef = useLatest(languageProvider);\n  const historyRef = useLatest(history);\n  const onRunQueryRef = useLatest(onRunQuery);\n  const onBlurRef = useLatest(onBlur);\n  const onChangeRef = useLatest(onChange);\n\n  const autocompleteDisposeFun = useRef<(() => void) | null>(null);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme, placeholder);\n\n  useEffect(() => {\n    // when we unmount, we unregister the autocomplete-function, if it was registered\n    return () => {\n      autocompleteDisposeFun.current?.();\n    };\n  }, []);\n\n  return (\n    <div\n      data-testid={selectors.components.QueryField.container}\n      className={styles.container}\n      // NOTE: we will be setting inline-style-width/height on this element\n      ref={containerRef}\n    >\n      <ReactMonacoEditor\n        overrideServices={overrideServicesRef.current}\n        options={options}\n        language=\"promql\"\n        value={initialValue}\n        beforeMount={(monaco) => {\n          ensurePromQL(monaco);\n        }}\n        onMount={(editor, monaco) => {\n          const isEditorFocused = editor.createContextKey<boolean>('isEditorFocused' + id, false);\n          // we setup on-blur\n          editor.onDidBlurEditorWidget(() => {\n            isEditorFocused.set(false);\n            onBlurRef.current(editor.getValue());\n          });\n          editor.onDidFocusEditorText(() => {\n            isEditorFocused.set(true);\n          });\n\n          // we construct a DataProvider object\n          const getHistory = () =>\n            Promise.resolve(historyRef.current.map((h) => h.query.expr).filter((expr) => expr !== undefined));\n\n          const getAllMetricNames = () => {\n            const { metrics, metricsMetadata } = lpRef.current;\n            const result = metrics.map((m) => {\n              const metaItem = metricsMetadata?.[m];\n              return {\n                name: m,\n                help: metaItem?.help ?? '',\n                type: metaItem?.type ?? '',\n              };\n            });\n\n            return Promise.resolve(result);\n          };\n\n          const getAllLabelNames = () => Promise.resolve(lpRef.current.getLabelKeys());\n\n          const getLabelValues = (labelName: string) => lpRef.current.getLabelValues(labelName);\n\n          const getSeriesValues = lpRef.current.getSeriesValues;\n\n          const getSeriesLabels = lpRef.current.getSeriesLabels;\n\n          const dataProvider = {\n            getHistory,\n            getAllMetricNames,\n            getAllLabelNames,\n            getLabelValues,\n            getSeriesValues,\n            getSeriesLabels,\n          };\n          const completionProvider = getCompletionProvider(monaco, dataProvider);\n\n          // completion-providers in monaco are not registered directly to editor-instances,\n          // they are registered to languages. this makes it hard for us to have\n          // separate completion-providers for every query-field-instance\n          // (but we need that, because they might connect to different datasources).\n          // the trick we do is, we wrap the callback in a \"proxy\",\n          // and in the proxy, the first thing is, we check if we are called from\n          // \"our editor instance\", and if not, we just return nothing. if yes,\n          // we call the completion-provider.\n          const filteringCompletionProvider: monacoTypes.languages.CompletionItemProvider = {\n            ...completionProvider,\n            provideCompletionItems: (model, position, context, token) => {\n              // if the model-id does not match, then this call is from a different editor-instance,\n              // not \"our instance\", so return nothing\n              if (editor.getModel()?.id !== model.id) {\n                return { suggestions: [] };\n              }\n              return completionProvider.provideCompletionItems(model, position, context, token);\n            },\n          };\n\n          const { dispose } = monaco.languages.registerCompletionItemProvider(\n            PROMQL_LANG_ID,\n            filteringCompletionProvider\n          );\n\n          autocompleteDisposeFun.current = dispose;\n          // this code makes the editor resize itself so that the content fits\n          // (it will grow taller when necessary)\n          // FIXME: maybe move this functionality into CodeEditor, like:\n          // <CodeEditor resizingMode=\"single-line\"/>\n          const updateElementHeight = () => {\n            const containerDiv = containerRef.current;\n            if (containerDiv !== null) {\n              const pixelHeight = editor.getContentHeight();\n              containerDiv.style.height = `${pixelHeight + EDITOR_HEIGHT_OFFSET}px`;\n              containerDiv.style.width = '100%';\n              const pixelWidth = containerDiv.clientWidth;\n              editor.layout({ width: pixelWidth, height: pixelHeight });\n            }\n          };\n\n          editor.onDidContentSizeChange(updateElementHeight);\n          updateElementHeight();\n\n          // Whenever the editor changes, lets save the last value so the next query for this editor will be up-to-date.\n          // This change is being introduced to fix a bug where you can submit a query via shift+enter:\n          // If you clicked into another field and haven't un-blurred the active field,\n          // then the query that is run will be stale, as the reference is only updated\n          // with the value of the last blurred input.\n          // This can run quite slowly, so we're debouncing this which should accomplish two things\n          // 1. Should prevent this function from blocking the current call stack by pushing into the web API callback queue\n          // 2. Should prevent a bunch of duplicates of this function being called as the user is typing\n          const updateCurrentEditorValue = debounce(() => {\n            const editorValue = editor.getValue();\n            onChangeRef.current(editorValue);\n          }, lpRef.current.datasource.getDebounceTimeInMilliseconds());\n\n          editor.getModel()?.onDidChangeContent(() => {\n            updateCurrentEditorValue();\n          });\n\n          // handle: shift + enter\n          // FIXME: maybe move this functionality into CodeEditor?\n          editor.addCommand(\n            monaco.KeyMod.Shift | monaco.KeyCode.Enter,\n            () => {\n              onRunQueryRef.current(editor.getValue());\n            },\n            'isEditorFocused' + id\n          );\n\n          /* Something in this configuration of monaco doesn't bubble up [mod]+K, which the\n                    command palette uses. Pass the event out of monaco manually\n                    */\n          editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyK, function () {\n            global.dispatchEvent(new KeyboardEvent('keydown', { key: 'k', metaKey: true }));\n          });\n\n          if (placeholder) {\n            const placeholderDecorators = [\n              {\n                range: new monaco.Range(1, 1, 1, 1),\n                options: {\n                  className: styles.placeholder,\n                  isWholeLine: true,\n                },\n              },\n            ];\n\n            let decorators: string[] = [];\n\n            const checkDecorators: () => void = () => {\n              const model = editor.getModel();\n\n              if (!model) {\n                return;\n              }\n\n              const newDecorators = model.getValueLength() === 0 ? placeholderDecorators : [];\n              decorators = model.deltaDecorations(decorators, newDecorators);\n            };\n\n            checkDecorators();\n            editor.onDidChangeModelContent(checkDecorators);\n\n            editor.onDidChangeModelContent((e) => {\n              const model = editor.getModel();\n              if (!model) {\n                return;\n              }\n              const query = model.getValue();\n              const errors =\n                validateQuery(\n                  query,\n                  datasource.interpolateString(query, placeHolderScopedVars),\n                  model.getLinesContent(),\n                  parser\n                ) || [];\n\n              const markers = errors.map(({ error, ...boundary }) => ({\n                message: `${\n                  error ? `Error parsing \"${error}\"` : 'Parse error'\n                }. The query appears to be incorrect and could fail to be executed.`,\n                severity: monaco.MarkerSeverity.Error,\n                ...boundary,\n              }));\n\n              monaco.editor.setModelMarkers(model, 'owner', markers);\n            });\n          }\n        }}\n      />\n    </div>\n  );\n};\n\n// we will lazy-load this module using React.lazy,\n// and that only supports default-exports,\n// so we have to default-export this, even if\n// it is against the style-guidelines.\n\nexport default MonacoQueryField;\n","import React, { Suspense } from 'react';\n\nimport MonacoQueryField from './MonacoQueryField';\nimport { Props } from './MonacoQueryFieldProps';\n\n// const Field = React.lazy(() => import('./MonacoQueryField'));\n\nexport const MonacoQueryFieldLazy = (props: Props) => {\n  return (\n    <Suspense fallback={null}>\n      <MonacoQueryField {...props} />\n    </Suspense>\n  );\n};\n","import React, { useRef } from 'react';\n\nimport { MonacoQueryFieldLazy } from './MonacoQueryFieldLazy';\nimport { Props as MonacoProps } from './MonacoQueryFieldProps';\n\ntype Props = Omit<MonacoProps, 'onRunQuery' | 'onBlur'> & {\n  onChange: (query: string) => void;\n  onRunQuery: () => void;\n};\n\nexport const MonacoQueryFieldWrapper = (props: Props) => {\n  const lastRunValueRef = useRef<string | null>(null);\n  const { onRunQuery, onChange, ...rest } = props;\n\n  const handleRunQuery = (value: string) => {\n    lastRunValueRef.current = value;\n    onChange(value);\n    onRunQuery();\n  };\n\n  const handleBlur = (value: string) => {\n    onChange(value);\n  };\n\n  /**\n   * Handles changes without running any queries\n   * @param value\n   */\n  const handleChange = (value: string) => {\n    onChange(value);\n  };\n\n  return <MonacoQueryFieldLazy onChange={handleChange} onRunQuery={handleRunQuery} onBlur={handleBlur} {...rest} />;\n};\n","import { cx } from '@emotion/css';\nimport React, { ReactNode } from 'react';\n\nimport { isDataFrame, QueryEditorProps, QueryHint, TimeRange, toLegacyResponseData } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { reportInteraction } from '@grafana/runtime';\nimport { clearButtonStyles, Icon, Themeable2, withTheme2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { LocalStorageValueProvider } from '../gcopypaste/app/core/components/LocalStorageValueProvider';\nimport {\n  CancelablePromise,\n  isCancelablePromiseRejection,\n  makePromiseCancelable,\n} from '../gcopypaste/app/core/utils/CancelablePromise';\nimport { roundMsToMin } from '../language_utils';\nimport { PromOptions, PromQuery } from '../types';\n\nimport { PrometheusMetricsBrowser } from './PrometheusMetricsBrowser';\nimport { MonacoQueryFieldWrapper } from './monaco-query-field/MonacoQueryFieldWrapper';\n\nconst LAST_USED_LABELS_KEY = 'grafana.datasources.prometheus.browser.labels';\n\nfunction getChooserText(metricsLookupDisabled: boolean, hasSyntax: boolean, hasMetrics: boolean) {\n  if (metricsLookupDisabled) {\n    return '(Disabled)';\n  }\n\n  if (!hasSyntax) {\n    return 'Loading metrics...';\n  }\n\n  if (!hasMetrics) {\n    return '(No metrics found)';\n  }\n\n  return 'Metrics browser';\n}\n\ninterface PromQueryFieldProps extends QueryEditorProps<PrometheusDatasource, PromQuery, PromOptions>, Themeable2 {\n  ExtraFieldElement?: ReactNode;\n  'data-testid'?: string;\n}\n\ninterface PromQueryFieldState {\n  labelBrowserVisible: boolean;\n  syntaxLoaded: boolean;\n  hint: QueryHint | null;\n}\n\nclass PromQueryFieldClass extends React.PureComponent<PromQueryFieldProps, PromQueryFieldState> {\n  declare languageProviderInitializationPromise: CancelablePromise<any>;\n\n  constructor(props: PromQueryFieldProps) {\n    super(props);\n\n    this.state = {\n      labelBrowserVisible: false,\n      syntaxLoaded: false,\n      hint: null,\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.datasource.languageProvider) {\n      this.refreshMetrics();\n    }\n    this.refreshHint();\n  }\n\n  componentWillUnmount() {\n    if (this.languageProviderInitializationPromise) {\n      this.languageProviderInitializationPromise.cancel();\n    }\n  }\n\n  componentDidUpdate(prevProps: PromQueryFieldProps) {\n    const {\n      data,\n      datasource: { languageProvider },\n      range,\n    } = this.props;\n\n    if (languageProvider !== prevProps.datasource.languageProvider) {\n      // We reset this only on DS change so we do not flesh loading state on every rangeChange which happens on every\n      // query run if using relative range.\n      this.setState({\n        syntaxLoaded: false,\n      });\n    }\n\n    const changedRangeToRefresh = this.rangeChangedToRefresh(range, prevProps.range);\n    // We want to refresh metrics when language provider changes and/or when range changes (we round up intervals to a minute)\n    if (languageProvider !== prevProps.datasource.languageProvider || changedRangeToRefresh) {\n      this.refreshMetrics();\n    }\n\n    if (data && prevProps.data && prevProps.data.series !== data.series) {\n      this.refreshHint();\n    }\n  }\n\n  refreshHint = () => {\n    const { datasource, query, data } = this.props;\n    const initHints = datasource.getInitHints();\n    const initHint = initHints.length > 0 ? initHints[0] : null;\n\n    if (!data || data.series.length === 0) {\n      this.setState({\n        hint: initHint,\n      });\n      return;\n    }\n\n    const result = isDataFrame(data.series[0]) ? data.series.map(toLegacyResponseData) : data.series;\n    const queryHints = datasource.getQueryHints(query, result);\n    let queryHint = queryHints.length > 0 ? queryHints[0] : null;\n\n    this.setState({ hint: queryHint ?? initHint });\n  };\n\n  refreshMetrics = async () => {\n    const {\n      range,\n      datasource: { languageProvider },\n    } = this.props;\n\n    this.languageProviderInitializationPromise = makePromiseCancelable(languageProvider.start(range));\n\n    try {\n      const remainingTasks = await this.languageProviderInitializationPromise.promise;\n      await Promise.all(remainingTasks);\n      this.onUpdateLanguage();\n    } catch (err) {\n      if (isCancelablePromiseRejection(err) && err.isCanceled) {\n        // do nothing, promise was canceled\n      } else {\n        throw err;\n      }\n    }\n  };\n\n  rangeChangedToRefresh(range?: TimeRange, prevRange?: TimeRange): boolean {\n    if (range && prevRange) {\n      const sameMinuteFrom = roundMsToMin(range.from.valueOf()) === roundMsToMin(prevRange.from.valueOf());\n      const sameMinuteTo = roundMsToMin(range.to.valueOf()) === roundMsToMin(prevRange.to.valueOf());\n      // If both are same, don't need to refresh.\n      return !(sameMinuteFrom && sameMinuteTo);\n    }\n    return false;\n  }\n\n  /**\n   * TODO #33976: Remove this, add histogram group (query = `histogram_quantile(0.95, sum(rate(${metric}[5m])) by (le))`;)\n   */\n  onChangeLabelBrowser = (selector: string) => {\n    this.onChangeQuery(selector, true);\n    this.setState({ labelBrowserVisible: false });\n  };\n\n  onChangeQuery = (value: string, override?: boolean) => {\n    // Send text change to parent\n    const { query, onChange, onRunQuery } = this.props;\n    if (onChange) {\n      const nextQuery: PromQuery = { ...query, expr: value };\n      onChange(nextQuery);\n\n      if (override && onRunQuery) {\n        onRunQuery();\n      }\n    }\n  };\n\n  onClickChooserButton = () => {\n    this.setState((state) => ({ labelBrowserVisible: !state.labelBrowserVisible }));\n\n    reportInteraction('user_grafana_prometheus_metrics_browser_clicked', {\n      editorMode: this.state.labelBrowserVisible ? 'metricViewClosed' : 'metricViewOpen',\n      app: this.props?.app ?? '',\n    });\n  };\n\n  onClickHintFix = () => {\n    const { datasource, query, onChange, onRunQuery } = this.props;\n    const { hint } = this.state;\n    if (hint?.fix?.action) {\n      onChange(datasource.modifyQuery(query, hint.fix.action));\n    }\n    onRunQuery();\n  };\n\n  onUpdateLanguage = () => {\n    const {\n      datasource: { languageProvider },\n    } = this.props;\n    const { metrics } = languageProvider;\n\n    if (!metrics) {\n      return;\n    }\n\n    this.setState({ syntaxLoaded: true });\n  };\n\n  render() {\n    const {\n      datasource,\n      datasource: { languageProvider },\n      query,\n      ExtraFieldElement,\n      history = [],\n      theme,\n    } = this.props;\n\n    const { labelBrowserVisible, syntaxLoaded, hint } = this.state;\n    const hasMetrics = languageProvider.metrics.length > 0;\n    const chooserText = getChooserText(datasource.lookupsDisabled, syntaxLoaded, hasMetrics);\n    const buttonDisabled = !(syntaxLoaded && hasMetrics);\n\n    return (\n      <LocalStorageValueProvider<string[]> storageKey={LAST_USED_LABELS_KEY} defaultValue={[]}>\n        {(lastUsedLabels, onLastUsedLabelsSave, onLastUsedLabelsDelete) => {\n          return (\n            <>\n              <div\n                className=\"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1\"\n                data-testid={this.props['data-testid']}\n              >\n                <button\n                  className=\"gf-form-label query-keyword pointer\"\n                  onClick={this.onClickChooserButton}\n                  disabled={buttonDisabled}\n                  type=\"button\"\n                  data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.metricsBrowser.openButton}\n                >\n                  {chooserText}\n                  <Icon name={labelBrowserVisible ? 'angle-down' : 'angle-right'} />\n                </button>\n\n                <div className=\"gf-form gf-form--grow flex-shrink-1 min-width-15\">\n                  <MonacoQueryFieldWrapper\n                    languageProvider={languageProvider}\n                    history={history}\n                    onChange={this.onChangeQuery}\n                    onRunQuery={this.props.onRunQuery}\n                    initialValue={query.expr ?? ''}\n                    placeholder=\"Enter a PromQL query\"\n                    datasource={datasource}\n                  />\n                </div>\n              </div>\n              {labelBrowserVisible && (\n                <div className=\"gf-form\">\n                  <PrometheusMetricsBrowser\n                    languageProvider={languageProvider}\n                    onChange={this.onChangeLabelBrowser}\n                    lastUsedLabels={lastUsedLabels || []}\n                    storeLastUsedLabels={onLastUsedLabelsSave}\n                    deleteLastUsedLabels={onLastUsedLabelsDelete}\n                    timeRange={this.props.range}\n                  />\n                </div>\n              )}\n\n              {ExtraFieldElement}\n              {hint ? (\n                <div className=\"query-row-break\">\n                  <div className=\"prom-query-field-info text-warning\">\n                    {hint.label}{' '}\n                    {hint.fix ? (\n                      <button\n                        type=\"button\"\n                        className={cx(clearButtonStyles(theme), 'text-link', 'muted')}\n                        onClick={this.onClickHintFix}\n                      >\n                        {hint.fix.label}\n                      </button>\n                    ) : null}\n                  </div>\n                </div>\n              ) : null}\n            </>\n          );\n        }}\n      </LocalStorageValueProvider>\n    );\n  }\n}\n\nexport const PromQueryField = withTheme2(PromQueryFieldClass);\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, renderMarkdown } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\n\nexport interface Props {\n  title?: React.ReactNode;\n  children?: React.ReactNode;\n  markdown?: string;\n  stepNumber?: number;\n}\n\nexport function OperationExplainedBox({ title, stepNumber, markdown, children }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.box}>\n      {stepNumber !== undefined && <div className={styles.stepNumber}>{stepNumber}</div>}\n      <div className={styles.boxInner}>\n        {title && (\n          <div className={styles.header}>\n            <span>{title}</span>\n          </div>\n        )}\n        <div className={styles.body}>\n          {markdown && <div dangerouslySetInnerHTML={{ __html: renderMarkdown(markdown) }}></div>}\n          {children}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    box: css({\n      background: theme.colors.background.secondary,\n      padding: theme.spacing(1),\n      borderRadius: theme.shape.radius.default,\n      position: 'relative',\n    }),\n    boxInner: css({\n      marginLeft: theme.spacing(4),\n    }),\n    stepNumber: css({\n      fontWeight: theme.typography.fontWeightMedium,\n      background: theme.colors.secondary.main,\n      width: '20px',\n      height: '20px',\n      borderRadius: theme.shape.radius.circle,\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      position: 'absolute',\n      top: '10px',\n      left: '11px',\n      fontSize: theme.typography.bodySmall.fontSize,\n    }),\n    header: css({\n      paddingBottom: theme.spacing(0.5),\n      display: 'flex',\n      alignItems: 'center',\n      fontFamily: theme.typography.fontFamilyMonospace,\n    }),\n    body: css({\n      color: theme.colors.text.secondary,\n      'p:last-child': {\n        margin: 0,\n      },\n      a: {\n        color: theme.colors.text.link,\n        textDecoration: 'underline',\n      },\n    }),\n  };\n};\n","import { css, cx } from '@emotion/css';\nimport Prism, { Grammar } from 'prismjs';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useTheme2 } from '@grafana/ui';\n\nexport interface Props {\n  query: string;\n  lang: {\n    grammar: Grammar;\n    name: string;\n  };\n  className?: string;\n}\n\nexport function RawQuery({ query, lang, className }: Props) {\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n  const highlighted = Prism.highlight(query, lang.grammar, lang.name);\n\n  return (\n    <div\n      className={cx(styles.editorField, 'prism-syntax-highlight', className)}\n      aria-label=\"selector\"\n      dangerouslySetInnerHTML={{ __html: highlighted }}\n    />\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    editorField: css({\n      fontFamily: theme.typography.fontFamilyMonospace,\n      fontSize: theme.typography.bodySmall.fontSize,\n    }),\n  };\n};\n","import { Grammar } from 'prismjs';\nimport React from 'react';\n\nimport { OperationExplainedBox } from './OperationExplainedBox';\nimport { RawQuery } from './RawQuery';\nimport { QueryBuilderOperation, QueryWithOperations, VisualQueryModeller } from './types';\n\nexport interface Props<T extends QueryWithOperations> {\n  query: T;\n  queryModeller: VisualQueryModeller;\n  explainMode?: boolean;\n  stepNumber: number;\n  lang: {\n    grammar: Grammar;\n    name: string;\n  };\n  onMouseEnter?: (op: QueryBuilderOperation, index: number) => void;\n  onMouseLeave?: (op: QueryBuilderOperation, index: number) => void;\n}\n\nexport function OperationListExplained<T extends QueryWithOperations>({\n  query,\n  queryModeller,\n  stepNumber,\n  lang,\n  onMouseEnter,\n  onMouseLeave,\n}: Props<T>) {\n  return (\n    <>\n      {query.operations.map((op, index) => {\n        const def = queryModeller.getOperationDef(op.id);\n        if (!def) {\n          return `Operation ${op.id} not found`;\n        }\n        const title = def.renderer(op, def, '<expr>');\n        const body = def.explainHandler ? def.explainHandler(op, def) : def.documentation ?? 'no docs';\n\n        return (\n          <div\n            key={index}\n            onMouseEnter={() => onMouseEnter?.(op, index)}\n            onMouseLeave={() => onMouseLeave?.(op, index)}\n          >\n            <OperationExplainedBox\n              stepNumber={index + stepNumber}\n              title={<RawQuery query={title} lang={lang} />}\n              markdown={body}\n            />\n          </div>\n        );\n      })}\n    </>\n  );\n}\n","import React from 'react';\n\nimport { Stack } from '@grafana/ui';\n\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { RawQuery } from '../shared/RawQuery';\nimport { PromVisualQuery } from '../types';\n\nexport const EXPLAIN_LABEL_FILTER_CONTENT = 'Fetch all series matching metric name and label filters.';\n\nexport interface PromQueryBuilderExplainedProps {\n  query: string;\n}\n\nexport const PromQueryBuilderExplained = React.memo<PromQueryBuilderExplainedProps>(({ query }) => {\n  const visQuery = buildVisualQueryFromString(query || '').query;\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Stack gap={0.5} direction=\"column\">\n      <OperationExplainedBox\n        stepNumber={1}\n        title={<RawQuery query={`${visQuery.metric} ${promQueryModeller.renderLabels(visQuery.labels)}`} lang={lang} />}\n      >\n        {EXPLAIN_LABEL_FILTER_CONTENT}\n      </OperationExplainedBox>\n      <OperationListExplained<PromVisualQuery>\n        stepNumber={2}\n        queryModeller={promQueryModeller}\n        query={visQuery}\n        lang={lang}\n      />\n    </Stack>\n  );\n});\n\nPromQueryBuilderExplained.displayName = 'PromQueryBuilderExplained';\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { useStyles2 } from '@grafana/ui';\n\nimport { PromQueryField } from '../../components/PromQueryField';\nimport { PromQueryEditorProps } from '../../components/types';\n\nimport { PromQueryBuilderExplained } from './PromQueryBuilderExplained';\n\ntype PromQueryCodeEditorProps = PromQueryEditorProps & {\n  showExplain: boolean;\n};\n\nexport function PromQueryCodeEditor(props: PromQueryCodeEditorProps) {\n  const { query, datasource, range, onRunQuery, onChange, data, app, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div\n      data-testid={selectors.components.DataSource.Prometheus.queryEditor.code.queryField}\n      className={styles.wrapper}\n    >\n      <PromQueryField\n        datasource={datasource}\n        query={query}\n        range={range}\n        onRunQuery={onRunQuery}\n        onChange={onChange}\n        history={[]}\n        data={data}\n        app={app}\n      />\n\n      {showExplain && <PromQueryBuilderExplained query={query.expr} />}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    // This wrapper styling can be removed after the old PromQueryEditor is removed.\n    // This is removing margin bottom on the old legacy inline form styles\n    wrapper: css`\n      .gf-form {\n        margin-bottom: 0;\n      }\n    `,\n  };\n};\n","import React from 'react';\n\nimport { AnnotationQuery } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField, EditorRow, EditorRows, EditorSwitch } from '@grafana/experimental';\nimport { AutoSizeInput, Input, Space } from '@grafana/ui';\n\nimport { PromQueryCodeEditor } from '../querybuilder/components/PromQueryCodeEditor';\nimport { PromQuery } from '../types';\n\nimport { PromQueryEditorProps } from './types';\n\ntype Props = PromQueryEditorProps & {\n  annotation?: AnnotationQuery<PromQuery>;\n  onAnnotationChange?: (annotation: AnnotationQuery<PromQuery>) => void;\n};\n\nexport function AnnotationQueryEditor(props: Props) {\n  // This is because of problematic typing. See AnnotationQueryEditorProps in grafana-data/annotations.ts.\n  const annotation = props.annotation!;\n  const onAnnotationChange = props.onAnnotationChange!;\n  const query = { expr: annotation.expr, refId: annotation.name, interval: annotation.step };\n\n  return (\n    <>\n      <EditorRows>\n        <PromQueryCodeEditor\n          {...props}\n          query={query}\n          showExplain={false}\n          onChange={(query) => {\n            onAnnotationChange({\n              ...annotation,\n              expr: query.expr,\n            });\n          }}\n        />\n        <EditorRow>\n          <EditorField\n            label=\"Min step\"\n            tooltip={\n              <>\n                An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n                <code>$__interval</code> and <code>$__rate_interval</code> variables.\n              </>\n            }\n          >\n            <AutoSizeInput\n              type=\"text\"\n              aria-label=\"Set lower limit for the step parameter\"\n              placeholder={'auto'}\n              minWidth={10}\n              onCommitChange={(ev) => {\n                onAnnotationChange({\n                  ...annotation,\n                  step: ev.currentTarget.value,\n                });\n              }}\n              defaultValue={query.interval}\n              id={selectors.components.DataSource.Prometheus.annotations.minStep}\n            />\n          </EditorField>\n        </EditorRow>\n      </EditorRows>\n      <Space v={0.5} />\n      <EditorRow>\n        <EditorField\n          label=\"Title\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"{{alertname}}\"\n            value={annotation.titleFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                titleFormat: event.currentTarget.value,\n              });\n            }}\n            data-testid={selectors.components.DataSource.Prometheus.annotations.title}\n          />\n        </EditorField>\n        <EditorField label=\"Tags\">\n          <Input\n            type=\"text\"\n            placeholder=\"label1,label2\"\n            value={annotation.tagKeys}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                tagKeys: event.currentTarget.value,\n              });\n            }}\n            data-testid={selectors.components.DataSource.Prometheus.annotations.tags}\n          />\n        </EditorField>\n        <EditorField\n          label=\"Text\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"{{instance}}\"\n            value={annotation.textFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                textFormat: event.currentTarget.value,\n              });\n            }}\n            data-testid={selectors.components.DataSource.Prometheus.annotations.text}\n          />\n        </EditorField>\n        <EditorField\n          label=\"Series value as timestamp\"\n          tooltip={\n            'The unit of timestamp is milliseconds. If the unit of the series value is seconds, multiply its range vector by 1000.'\n          }\n        >\n          <EditorSwitch\n            value={annotation.useValueForTime}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                useValueForTime: event.currentTarget.value,\n              });\n            }}\n            data-testid={selectors.components.DataSource.Prometheus.annotations.seriesValueAsTimestamp}\n          />\n        </EditorField>\n      </EditorRow>\n    </>\n  );\n}\n","import { promQueryModeller } from '../querybuilder/PromQueryModeller';\nimport { buildVisualQueryFromString } from '../querybuilder/parsing';\nimport { PromVariableQuery, PromVariableQueryType as QueryType } from '../types';\n\nexport const PrometheusLabelNamesRegex = /^label_names\\(\\)\\s*$/;\n// Note that this regex is different from the one in metric_find_query.ts because this is used pre-interpolation\nexport const PrometheusLabelValuesRegex = /^label_values\\((?:(.+),\\s*)?([a-zA-Z_$][a-zA-Z0-9_]*)\\)\\s*$/;\nexport const PrometheusMetricNamesRegex = /^metrics\\((.+)\\)\\s*$/;\nexport const PrometheusQueryResultRegex = /^query_result\\((.+)\\)\\s*$/;\nexport const PrometheusLabelNamesRegexWithMatch = /^label_names\\((.+)\\)\\s*$/;\n\nexport function migrateVariableQueryToEditor(rawQuery: string | PromVariableQuery): PromVariableQuery {\n  // If not string, we assume PromVariableQuery\n  if (typeof rawQuery !== 'string') {\n    return rawQuery;\n  }\n\n  const queryBase = {\n    refId: 'PrometheusDatasource-VariableQuery',\n    qryType: QueryType.LabelNames,\n  };\n\n  const labelNamesMatchQuery = rawQuery.match(PrometheusLabelNamesRegexWithMatch);\n\n  if (labelNamesMatchQuery) {\n    return {\n      ...queryBase,\n      qryType: QueryType.LabelNames,\n      match: labelNamesMatchQuery[1],\n    };\n  }\n\n  const labelNames = rawQuery.match(PrometheusLabelNamesRegex);\n  if (labelNames) {\n    return {\n      ...queryBase,\n      qryType: QueryType.LabelNames,\n    };\n  }\n\n  const labelValuesCheck = rawQuery.match(/^label_values\\(/);\n  if (labelValuesCheck) {\n    const labelValues = rawQuery.match(PrometheusLabelValuesRegex);\n    const label = labelValues ? labelValues[2] : '';\n    const metric = labelValues ? labelValues[1] : '';\n\n    if (metric) {\n      const visQuery = buildVisualQueryFromString(metric);\n      return {\n        ...queryBase,\n        qryType: QueryType.LabelValues,\n        label,\n        metric: visQuery.query.metric,\n        labelFilters: visQuery.query.labels,\n      };\n    } else {\n      return {\n        ...queryBase,\n        qryType: QueryType.LabelValues,\n        label,\n      };\n    }\n  }\n\n  const metricNamesCheck = rawQuery.match(/^metrics\\(/);\n  if (metricNamesCheck) {\n    const metricNames = rawQuery.match(PrometheusMetricNamesRegex);\n    const metric = metricNames ? metricNames[1] : '';\n    return {\n      ...queryBase,\n      qryType: QueryType.MetricNames,\n      metric,\n    };\n  }\n\n  const queryResultCheck = rawQuery.match(/^query_result\\(/);\n  if (queryResultCheck) {\n    const queryResult = rawQuery.match(PrometheusQueryResultRegex);\n    const varQuery = queryResult ? queryResult[1] : '';\n    return {\n      ...queryBase,\n      qryType: QueryType.VarQueryResult,\n      varQuery,\n    };\n  }\n\n  // seriesQuery does not have a function and no regex above\n  if (!labelNames && !labelValuesCheck && !metricNamesCheck && !queryResultCheck) {\n    return {\n      ...queryBase,\n      qryType: QueryType.SeriesQuery,\n      seriesQuery: rawQuery,\n    };\n  }\n\n  return queryBase;\n}\n\n// migrate it back to a string with the correct varialbes in place\nexport function migrateVariableEditorBackToVariableSupport(QueryVariable: PromVariableQuery): string {\n  switch (QueryVariable.qryType) {\n    case QueryType.LabelNames:\n      if (QueryVariable.match) {\n        return `label_names(${QueryVariable.match})`;\n      }\n      return 'label_names()';\n    case QueryType.LabelValues:\n      if (QueryVariable.metric || (QueryVariable.labelFilters && QueryVariable.labelFilters.length !== 0)) {\n        const visualQueryQuery = {\n          metric: QueryVariable.metric,\n          labels: QueryVariable.labelFilters ?? [],\n          operations: [],\n        };\n\n        const metric = promQueryModeller.renderQuery(visualQueryQuery);\n        return `label_values(${metric},${QueryVariable.label})`;\n      } else {\n        return `label_values(${QueryVariable.label})`;\n      }\n    case QueryType.MetricNames:\n      return `metrics(${QueryVariable.metric})`;\n    case QueryType.VarQueryResult:\n      const varQuery = removeLineBreaks(QueryVariable.varQuery);\n      return `query_result(${varQuery})`;\n    case QueryType.SeriesQuery:\n      return QueryVariable.seriesQuery ?? '';\n    case QueryType.ClassicQuery:\n      return QueryVariable.classicQuery ?? '';\n  }\n\n  return '';\n}\n\n// allow line breaks in query result textarea\nfunction removeLineBreaks(input?: string) {\n  return input ? input.replace(/[\\r\\n]+/gm, '') : '';\n}\n","import { chain, map as _map, uniq } from 'lodash';\n\nimport { getDefaultTimeRange, MetricFindValue, TimeRange } from '@grafana/data';\n\nimport { PrometheusDatasource } from './datasource';\nimport { getPrometheusTime } from './language_utils';\nimport {\n  PrometheusLabelNamesRegex,\n  PrometheusLabelNamesRegexWithMatch,\n  PrometheusMetricNamesRegex,\n  PrometheusQueryResultRegex,\n} from './migrations/variableMigration';\n\nexport class PrometheusMetricFindQuery {\n  range: TimeRange;\n\n  constructor(\n    private datasource: PrometheusDatasource,\n    private query: string\n  ) {\n    this.datasource = datasource;\n    this.query = query;\n    this.range = getDefaultTimeRange();\n  }\n\n  process(timeRange: TimeRange): Promise<MetricFindValue[]> {\n    this.range = timeRange;\n    const labelNamesRegex = PrometheusLabelNamesRegex;\n    const labelNamesRegexWithMatch = PrometheusLabelNamesRegexWithMatch;\n    const labelValuesRegex = /^label_values\\((?:(.+),\\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s*$/;\n    const metricNamesRegex = PrometheusMetricNamesRegex;\n    const queryResultRegex = PrometheusQueryResultRegex;\n    const labelNamesQuery = this.query.match(labelNamesRegex);\n    const labelNamesMatchQuery = this.query.match(labelNamesRegexWithMatch);\n\n    if (labelNamesMatchQuery) {\n      const selector = `{__name__=~\".*${labelNamesMatchQuery[1]}.*\"}`;\n      return this.datasource.languageProvider.getSeriesLabels(selector, []).then((results) =>\n        results.map((result) => ({\n          text: result,\n        }))\n      );\n    }\n\n    if (labelNamesQuery) {\n      return this.datasource.getTagKeys({ filters: [], timeRange });\n    }\n\n    const labelValuesQuery = this.query.match(labelValuesRegex);\n    if (labelValuesQuery) {\n      const filter = labelValuesQuery[1];\n      const label = labelValuesQuery[2];\n      if (isFilterDefined(filter)) {\n        return this.labelValuesQuery(label, filter);\n      } else {\n        // Exclude the filter part of the expression because it is blank or empty\n        return this.labelValuesQuery(label);\n      }\n    }\n\n    const metricNamesQuery = this.query.match(metricNamesRegex);\n    if (metricNamesQuery) {\n      return this.metricNameQuery(metricNamesQuery[1]);\n    }\n\n    const queryResultQuery = this.query.match(queryResultRegex);\n    if (queryResultQuery) {\n      return this.queryResultQuery(queryResultQuery[1]);\n    }\n\n    // if query contains full metric name, return metric name and label list\n    const expressions = ['label_values()', 'metrics()', 'query_result()'];\n    if (!expressions.includes(this.query)) {\n      return this.metricNameAndLabelsQuery(this.query);\n    }\n\n    return Promise.resolve([]);\n  }\n\n  labelValuesQuery(label: string, metric?: string) {\n    const start = getPrometheusTime(this.range.from, false);\n    const end = getPrometheusTime(this.range.to, true);\n    const params = { ...(metric && { 'match[]': metric }), start: start.toString(), end: end.toString() };\n\n    if (!metric || this.datasource.hasLabelsMatchAPISupport()) {\n      const url = `/api/v1/label/${label}/values`;\n\n      return this.datasource.metadataRequest(url, params).then((result: any) => {\n        return _map(result.data.data, (value) => {\n          return { text: value };\n        });\n      });\n    } else {\n      const url = `/api/v1/series`;\n\n      return this.datasource.metadataRequest(url, params).then((result: any) => {\n        const _labels = _map(result.data.data, (metric) => {\n          return metric[label] || '';\n        }).filter((label) => {\n          return label !== '';\n        });\n\n        return uniq(_labels).map((metric) => {\n          return {\n            text: metric,\n            expandable: true,\n          };\n        });\n      });\n    }\n  }\n\n  metricNameQuery(metricFilterPattern: string) {\n    const start = getPrometheusTime(this.range.from, false);\n    const end = getPrometheusTime(this.range.to, true);\n    const params = {\n      start: start.toString(),\n      end: end.toString(),\n    };\n    const url = `/api/v1/label/__name__/values`;\n\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      return chain(result.data.data)\n        .filter((metricName) => {\n          const r = new RegExp(metricFilterPattern);\n          return r.test(metricName);\n        })\n        .map((matchedMetricName) => {\n          return {\n            text: matchedMetricName,\n            expandable: true,\n          };\n        })\n        .value();\n    });\n  }\n\n  queryResultQuery(query: string) {\n    const url = '/api/v1/query';\n    const params = {\n      query,\n      time: getPrometheusTime(this.range.to, true).toString(),\n    };\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      switch (result.data.data.resultType) {\n        case 'scalar': // [ <unix_time>, \"<scalar_value>\" ]\n        case 'string': // [ <unix_time>, \"<string_value>\" ]\n          return [\n            {\n              text: result.data.data.result[1] || '',\n              expandable: false,\n            },\n          ];\n        case 'vector':\n          return _map(result.data.data.result, (metricData) => {\n            let text = metricData.metric.__name__ || '';\n            delete metricData.metric.__name__;\n            text +=\n              '{' +\n              _map(metricData.metric, (v, k) => {\n                return k + '=\"' + v + '\"';\n              }).join(',') +\n              '}';\n            text += ' ' + metricData.value[1] + ' ' + metricData.value[0] * 1000;\n\n            return {\n              text: text,\n              expandable: true,\n            };\n          });\n        default:\n          throw Error(`Unknown/Unhandled result type: [${result.data.data.resultType}]`);\n      }\n    });\n  }\n\n  metricNameAndLabelsQuery(query: string): Promise<MetricFindValue[]> {\n    const start = getPrometheusTime(this.range.from, false);\n    const end = getPrometheusTime(this.range.to, true);\n    const params = {\n      'match[]': query,\n      start: start.toString(),\n      end: end.toString(),\n    };\n\n    const url = `/api/v1/series`;\n    const self = this;\n\n    return this.datasource.metadataRequest(url, params).then((result: any) => {\n      return _map(result.data.data, (metric: { [key: string]: string }) => {\n        return {\n          text: self.datasource.getOriginalMetricName(metric),\n          expandable: true,\n        };\n      });\n    });\n  }\n}\n\nfunction isFilterDefined(filter: string) {\n  // We consider blank strings or the empty filter {} as an undefined filter\n  return filter && filter.split(' ').join('') !== '{}';\n}\n","import { size } from 'lodash';\n\nimport { QueryFix, QueryHint } from '@grafana/data';\n\nimport { PrometheusDatasource } from './datasource';\n\n/**\n * Number of time series results needed before starting to suggest sum aggregation hints\n */\nexport const SUM_HINT_THRESHOLD_COUNT = 20;\n\nexport function getQueryHints(query: string, series?: any[], datasource?: PrometheusDatasource): QueryHint[] {\n  const hints = [];\n\n  // ..._bucket metric needs a histogram_quantile()\n  const histogramMetric = query.trim().match(/^\\w+_bucket$|^\\w+_bucket{.*}$/);\n  if (histogramMetric) {\n    const label = 'Selected metric has buckets.';\n    hints.push({\n      type: 'HISTOGRAM_QUANTILE',\n      label,\n      fix: {\n        label: 'Consider calculating aggregated quantile by adding histogram_quantile().',\n        action: {\n          type: 'ADD_HISTOGRAM_QUANTILE',\n          query,\n        },\n      },\n    });\n  }\n\n  // Check for need of rate()\n  if (query.indexOf('rate(') === -1 && query.indexOf('increase(') === -1) {\n    // Use metric metadata for exact types\n    const nameMatch = query.match(/\\b((?<!:)\\w+_(total|sum|count)(?!:))\\b/);\n    let counterNameMetric = nameMatch ? nameMatch[1] : '';\n    const metricsMetadata = datasource?.languageProvider?.metricsMetadata;\n    let certain = false;\n\n    if (metricsMetadata) {\n      // Tokenize the query into its identifiers (see https://prometheus.io/docs/concepts/data_model/#metric-names-and-labels)\n      const queryTokens = Array.from(query.matchAll(/\\$?[a-zA-Z_:][a-zA-Z0-9_:]*/g))\n        .map(([match]) => match)\n        // Exclude variable identifiers\n        .filter((token) => !token.startsWith('$'))\n        // Split composite keys to match the tokens returned by the language provider\n        .flatMap((token) => token.split(':'));\n      // Determine whether any of the query identifier tokens refers to a counter metric\n      counterNameMetric =\n        queryTokens.find((metricName) => {\n          // Only considering first type information, could be non-deterministic\n          const metadata = metricsMetadata[metricName];\n          if (metadata && metadata.type.toLowerCase() === 'counter') {\n            certain = true;\n            return true;\n          } else {\n            return false;\n          }\n        }) ?? '';\n    }\n\n    if (counterNameMetric) {\n      // FixableQuery consists of metric name and optionally label-value pairs. We are not offering fix for complex queries yet.\n      const fixableQuery = query.trim().match(/^\\w+$|^\\w+{.*}$/);\n      const verb = certain ? 'is' : 'looks like';\n      let label = `Selected metric ${verb} a counter.`;\n      let fix: QueryFix | undefined;\n\n      if (fixableQuery) {\n        fix = {\n          label: 'Consider calculating rate of counter by adding rate().',\n          action: {\n            type: 'ADD_RATE',\n            query,\n          },\n        };\n      } else {\n        label = `${label} Consider calculating rate of counter by adding rate().`;\n      }\n\n      hints.push({\n        type: 'APPLY_RATE',\n        label,\n        fix,\n      });\n    }\n  }\n\n  // Check for recording rules expansion\n  if (datasource && datasource.ruleMappings) {\n    const mapping = datasource.ruleMappings;\n    const mappingForQuery = Object.keys(mapping).reduce((acc, ruleName) => {\n      if (query.search(ruleName) > -1) {\n        return {\n          ...acc,\n          [ruleName]: mapping[ruleName],\n        };\n      }\n      return acc;\n    }, {});\n    if (size(mappingForQuery) > 0) {\n      const label = 'Query contains recording rules.';\n      hints.push({\n        type: 'EXPAND_RULES',\n        label,\n        fix: {\n          label: 'Expand rules',\n          action: {\n            type: 'EXPAND_RULES',\n            query,\n            options: mappingForQuery,\n          },\n        },\n      });\n    }\n  }\n\n  if (series && series.length >= SUM_HINT_THRESHOLD_COUNT) {\n    const simpleMetric = query.trim().match(/^\\w+$/);\n    if (simpleMetric) {\n      hints.push({\n        type: 'ADD_SUM',\n        label: 'Many time series results returned.',\n        fix: {\n          label: 'Consider aggregating with sum().',\n          action: {\n            type: 'ADD_SUM',\n            query: query,\n            preventSubmit: true,\n          },\n        },\n      });\n    }\n  }\n\n  return hints;\n}\n\nexport function getInitHints(datasource: PrometheusDatasource): QueryHint[] {\n  const hints = [];\n\n  // Hint for big disabled lookups\n  if (datasource.lookupsDisabled) {\n    hints.push({\n      label: `Labels and metrics lookup was disabled in data source settings.`,\n      type: 'INFO',\n    });\n  }\n\n  return hints;\n}\n","import { setFaroOnGlobalObject } from './faroGlobalObject';\nimport { setInternalFaroOnGlobalObject } from './internalFaroGlobalObject';\nexport let faro = {};\nexport function registerFaro(unpatchedConsole, internalLogger, config, metas, transports, api, instrumentations) {\n    internalLogger.debug('Initializing Faro');\n    faro = {\n        api,\n        config,\n        instrumentations,\n        internalLogger,\n        metas,\n        pause: transports.pause,\n        transports,\n        unpatchedConsole,\n        unpause: transports.unpause,\n    };\n    setInternalFaroOnGlobalObject(faro);\n    setFaroOnGlobalObject(faro);\n    return faro;\n}\n//# sourceMappingURL=registerFaro.js.map","import { closestIdx } from '@grafana/data';\n\nexport type Table = [times: number[], ...values: any[][]];\n\n// prevTable and nextTable are assumed sorted ASC on reference [0] arrays\n// nextTable is assumed to be contiguous, only edges are checked for overlap\n// ...so prev: [1,2,5] + next: [3,4,6] -> [1,2,3,4,6]\nexport function amendTable(prevTable: Table, nextTable: Table): Table {\n    let [prevTimes] = prevTable;\n    let [nextTimes] = nextTable;\n\n    let pLen = prevTimes.length;\n    let pStart = prevTimes[0];\n    let pEnd = prevTimes[pLen - 1];\n\n    let nLen = nextTimes.length;\n    let nStart = nextTimes[0];\n    let nEnd = nextTimes[nLen - 1];\n\n    let outTable: Table;\n\n    if (pLen) {\n        if (nLen) {\n            // append, no overlap\n            if (nStart > pEnd) {\n                outTable = prevTable.map((_, i) => prevTable[i].concat(nextTable[i])) as Table;\n            }\n            // prepend, no overlap\n            else if (nEnd < pStart) {\n                outTable = nextTable.map((_, i) => nextTable[i].concat(prevTable[i])) as Table;\n            }\n            // full replace\n            else if (nStart <= pStart && nEnd >= pEnd) {\n                outTable = nextTable;\n            }\n            // partial replace\n            else if (nStart > pStart && nEnd < pEnd) {\n            }\n            // append, with overlap\n            else if (nStart >= pStart) {\n                let idx = closestIdx(nStart, prevTimes);\n                idx = prevTimes[idx] < nStart ? idx - 1 : idx;\n                outTable = prevTable.map((_, i) => prevTable[i].slice(0, idx).concat(nextTable[i])) as Table;\n            }\n            // prepend, with overlap\n            else if (nEnd >= pStart) {\n                let idx = closestIdx(nEnd, prevTimes);\n                idx = prevTimes[idx] < nEnd ? idx : idx + 1;\n                outTable = nextTable.map((_, i) => nextTable[i].concat(prevTable[i].slice(idx))) as Table;\n            }\n        } else {\n            outTable = prevTable;\n        }\n    } else {\n        if (nLen) {\n            outTable = nextTable;\n        } else {\n            outTable = [[]];\n        }\n    }\n\n    return outTable!;\n}\n\nexport function trimTable(table: Table, fromTime: number, toTime: number): Table {\n    let [times, ...vals] = table;\n    let fromIdx: number | undefined;\n    let toIdx: number | undefined;\n\n    // trim to bounds\n    if (times[0] < fromTime) {\n        fromIdx = closestIdx(fromTime, times);\n\n        if (times[fromIdx] < fromTime) {\n            fromIdx++;\n        }\n    }\n\n    if (times[times.length - 1] > toTime) {\n        toIdx = closestIdx(toTime, times);\n\n        if (times[toIdx] > toTime) {\n            toIdx--;\n        }\n    }\n\n    if (fromIdx != null || toIdx != null) {\n        times = times.slice(fromIdx ?? 0, toIdx);\n        vals = vals.map(vals2 => vals2.slice(fromIdx ?? 0, toIdx));\n    }\n\n    return [times, ...vals];\n}\n","import {\n  DataFrame,\n  DataQueryRequest,\n  dateTime,\n  durationToMilliseconds,\n  Field,\n  incrRoundDn,\n  isValidDuration,\n  parseDuration,\n} from '@grafana/data';\nimport { faro } from '@grafana/faro-web-sdk';\nimport { config, reportInteraction } from '@grafana/runtime';\n\nimport { amendTable, Table, trimTable } from '../gcopypaste/app/features/live/data/amendTimeSeries';\nimport { PromQuery } from '../types';\n\n// dashboardUID + panelId + refId\n// (must be stable across query changes, time range changes / interval changes / panel resizes / template variable changes)\ntype TargetIdent = string;\n\ntype RequestID = string;\n\n// query + template variables + interval + raw time range\n// used for full target cache busting -> full range re-query\ntype TargetSig = string;\n\ntype TimestampMs = number;\n\ntype SupportedQueryTypes = PromQuery;\n\n// string matching requirements defined in durationutil.ts\nexport const defaultPrometheusQueryOverlapWindow = '10m';\n\ninterface TargetCache {\n  sig: TargetSig;\n  prevTo: TimestampMs;\n  frames: DataFrame[];\n}\n\nexport interface CacheRequestInfo<T extends SupportedQueryTypes> {\n  requests: Array<DataQueryRequest<T>>;\n  targSigs: Map<TargetIdent, TargetSig>;\n  shouldCache: boolean;\n}\n\nexport interface DatasourceProfileData {\n  interval?: string;\n  expr: string;\n  datasource: string;\n}\n\ninterface ProfileData extends DatasourceProfileData {\n  identity: string;\n  bytes: number | null;\n  dashboardUID: string;\n  panelId?: number;\n  from: string;\n  queryRangeSeconds: number;\n  refreshIntervalMs: number;\n}\n\n/**\n * Get field identity\n * This is the string used to uniquely identify a field within a \"target\"\n * @param field\n */\nexport const getFieldIdent = (field: Field) => `${field.type}|${field.name}|${JSON.stringify(field.labels ?? '')}`;\n\n/**\n * NOMENCLATURE\n * Target: The request target (DataQueryRequest), i.e. a specific query reference within a panel\n * Ident: Identity: the string that is not expected to change\n * Sig: Signature: the string that is expected to change, upon which we wipe the cache fields\n */\nexport class QueryCache<T extends SupportedQueryTypes> {\n  private overlapWindowMs: number;\n  private getTargetSignature: (request: DataQueryRequest<T>, target: T) => string;\n  private getProfileData?: (request: DataQueryRequest<T>, target: T) => DatasourceProfileData;\n\n  private perfObeserver?: PerformanceObserver;\n  private shouldProfile: boolean;\n\n  // send profile events every 10 minutes\n  sendEventsInterval = 60000 * 10;\n\n  pendingRequestIdsToTargSigs = new Map<RequestID, ProfileData>();\n\n  pendingAccumulatedEvents = new Map<\n    string,\n    {\n      requestCount: number;\n      savedBytesTotal: number;\n      initialRequestSize: number;\n      lastRequestSize: number;\n      panelId: string;\n      dashId: string;\n      expr: string;\n      refreshIntervalMs: number;\n      sent: boolean;\n      datasource: string;\n      from: string;\n      queryRangeSeconds: number;\n    }\n  >();\n\n  cache = new Map<TargetIdent, TargetCache>();\n\n  constructor(options: {\n    getTargetSignature: (request: DataQueryRequest<T>, target: T) => string;\n    overlapString: string;\n    profileFunction?: (request: DataQueryRequest<T>, target: T) => DatasourceProfileData;\n  }) {\n    const unverifiedOverlap = options.overlapString;\n    if (isValidDuration(unverifiedOverlap)) {\n      const duration = parseDuration(unverifiedOverlap);\n      this.overlapWindowMs = durationToMilliseconds(duration);\n    } else {\n      const duration = parseDuration(defaultPrometheusQueryOverlapWindow);\n      this.overlapWindowMs = durationToMilliseconds(duration);\n    }\n\n    if (\n      (config.grafanaJavascriptAgent.enabled || config.featureToggles?.prometheusIncrementalQueryInstrumentation) &&\n      options.profileFunction !== undefined\n    ) {\n      this.profile();\n      this.shouldProfile = true;\n    } else {\n      this.shouldProfile = false;\n    }\n    this.getProfileData = options.profileFunction;\n    this.getTargetSignature = options.getTargetSignature;\n  }\n\n  private profile() {\n    // Check if PerformanceObserver is supported, and if we have Faro enabled for internal profiling\n    if (typeof PerformanceObserver === 'function') {\n      this.perfObeserver = new PerformanceObserver((list: PerformanceObserverEntryList) => {\n        list.getEntries().forEach((entry) => {\n          // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n          const entryTypeCast: PerformanceResourceTiming = entry as PerformanceResourceTiming;\n\n          // Safari support for this is coming in 16.4:\n          // https://caniuse.com/mdn-api_performanceresourcetiming_transfersize\n          // Gating that this exists to prevent runtime errors\n          const isSupported = typeof entryTypeCast?.transferSize === 'number';\n\n          if (entryTypeCast?.initiatorType === 'fetch' && isSupported) {\n            let fetchUrl = entryTypeCast.name;\n\n            if (fetchUrl.includes('/api/ds/query')) {\n              let match = fetchUrl.match(/requestId=([a-z\\d]+)/i);\n\n              if (match) {\n                let requestId = match[1];\n\n                const requestTransferSize = Math.round(entryTypeCast.transferSize);\n                const currentRequest = this.pendingRequestIdsToTargSigs.get(requestId);\n\n                if (currentRequest) {\n                  const entries = this.pendingRequestIdsToTargSigs.entries();\n\n                  for (let [, value] of entries) {\n                    if (value.identity === currentRequest.identity && value.bytes !== null) {\n                      const previous = this.pendingAccumulatedEvents.get(value.identity);\n\n                      const savedBytes = value.bytes - requestTransferSize;\n\n                      this.pendingAccumulatedEvents.set(value.identity, {\n                        datasource: value.datasource ?? 'N/A',\n                        requestCount: (previous?.requestCount ?? 0) + 1,\n                        savedBytesTotal: (previous?.savedBytesTotal ?? 0) + savedBytes,\n                        initialRequestSize: value.bytes,\n                        lastRequestSize: requestTransferSize,\n                        panelId: currentRequest.panelId?.toString() ?? '',\n                        dashId: currentRequest.dashboardUID ?? '',\n                        expr: currentRequest.expr ?? '',\n                        refreshIntervalMs: currentRequest.refreshIntervalMs ?? 0,\n                        sent: false,\n                        from: currentRequest.from ?? '',\n                        queryRangeSeconds: currentRequest.queryRangeSeconds ?? 0,\n                      });\n\n                      // We don't need to save each subsequent request, only the first one\n                      this.pendingRequestIdsToTargSigs.delete(requestId);\n\n                      return;\n                    }\n                  }\n\n                  // If we didn't return above, this should be the first request, let's save the observed size\n                  this.pendingRequestIdsToTargSigs.set(requestId, { ...currentRequest, bytes: requestTransferSize });\n                }\n              }\n            }\n          }\n        });\n      });\n\n      this.perfObeserver.observe({ type: 'resource', buffered: false });\n\n      setInterval(this.sendPendingTrackingEvents, this.sendEventsInterval);\n\n      // Send any pending profile information when the user navigates away\n      window.addEventListener('beforeunload', this.sendPendingTrackingEvents);\n    }\n  }\n\n  sendPendingTrackingEvents = () => {\n    const entries = this.pendingAccumulatedEvents.entries();\n\n    for (let [key, value] of entries) {\n      if (!value.sent) {\n        const event = {\n          datasource: value.datasource.toString(),\n          requestCount: value.requestCount.toString(),\n          savedBytesTotal: value.savedBytesTotal.toString(),\n          initialRequestSize: value.initialRequestSize.toString(),\n          lastRequestSize: value.lastRequestSize.toString(),\n          panelId: value.panelId.toString(),\n          dashId: value.dashId.toString(),\n          expr: value.expr.toString(),\n          refreshIntervalMs: value.refreshIntervalMs.toString(),\n          from: value.from.toString(),\n          queryRangeSeconds: value.queryRangeSeconds.toString(),\n        };\n\n        if (config.featureToggles.prometheusIncrementalQueryInstrumentation) {\n          reportInteraction('grafana_incremental_queries_profile', event);\n        } else if (faro.api.pushEvent) {\n          faro.api.pushEvent('incremental query response size', event, 'no-interaction', {\n            skipDedupe: true,\n          });\n        }\n\n        this.pendingAccumulatedEvents.set(key, {\n          ...value,\n          sent: true,\n          requestCount: 0,\n          savedBytesTotal: 0,\n          initialRequestSize: 0,\n          lastRequestSize: 0,\n        });\n      }\n    }\n  };\n\n  // can be used to change full range request to partial, split into multiple requests\n  requestInfo(request: DataQueryRequest<T>): CacheRequestInfo<T> {\n    // TODO: align from/to to interval to increase probability of hitting backend cache\n\n    const newFrom = request.range.from.valueOf();\n    const newTo = request.range.to.valueOf();\n\n    // only cache 'now'-relative queries (that can benefit from a backfill cache)\n    const shouldCache = request.rangeRaw?.to?.toString() === 'now';\n\n    // all targets are queried together, so we check for any that causes group cache invalidation & full re-query\n    let doPartialQuery = shouldCache;\n    let prevTo: TimestampMs | undefined = undefined;\n\n    const refreshIntervalMs = request.intervalMs;\n\n    // pre-compute reqTargSigs\n    const reqTargSigs = new Map<TargetIdent, TargetSig>();\n    request.targets.forEach((targ) => {\n      let targIdent = `${request.dashboardUID}|${request.panelId}|${targ.refId}`;\n      let targSig = this.getTargetSignature(request, targ); // ${request.maxDataPoints} ?\n\n      if (this.shouldProfile && this.getProfileData) {\n        this.pendingRequestIdsToTargSigs.set(request.requestId, {\n          ...this.getProfileData(request, targ),\n          identity: targIdent + '|' + targSig,\n          bytes: null,\n          panelId: request.panelId,\n          dashboardUID: request.dashboardUID ?? '',\n          from: request.rangeRaw?.from.toString() ?? '',\n          queryRangeSeconds: request.range.to.diff(request.range.from, 'seconds') ?? '',\n          refreshIntervalMs: refreshIntervalMs ?? 0,\n        });\n      }\n\n      reqTargSigs.set(targIdent, targSig);\n    });\n\n    // figure out if new query range or new target props trigger full cache invalidation & re-query\n    for (const [targIdent, targSig] of reqTargSigs) {\n      let cached = this.cache.get(targIdent);\n      let cachedSig = cached?.sig;\n\n      if (cachedSig !== targSig) {\n        doPartialQuery = false;\n      } else {\n        // only do partial queries when new request range follows prior request range (possibly with overlap)\n        // e.g. now-6h with refresh <= 6h\n        prevTo = cached?.prevTo ?? Infinity;\n\n        doPartialQuery = newTo > prevTo && newFrom <= prevTo;\n      }\n\n      if (!doPartialQuery) {\n        break;\n      }\n    }\n\n    if (doPartialQuery && prevTo) {\n      // clamp to make sure we don't re-query previous 10m when newFrom is ahead of it (e.g. 5min range, 30s refresh)\n      let newFromPartial = Math.max(prevTo - this.overlapWindowMs, newFrom);\n\n      const newToDate = dateTime(newTo);\n      const newFromPartialDate = dateTime(incrRoundDn(newFromPartial, request.intervalMs));\n\n      // modify to partial query\n      request = {\n        ...request,\n        range: {\n          ...request.range,\n          from: newFromPartialDate,\n          to: newToDate,\n        },\n      };\n    } else {\n      reqTargSigs.forEach((targSig, targIdent) => {\n        this.cache.delete(targIdent);\n      });\n    }\n\n    return {\n      requests: [request],\n      targSigs: reqTargSigs,\n      shouldCache,\n    };\n  }\n\n  // should amend existing cache with new frames and return full response\n  procFrames(\n    request: DataQueryRequest<T>,\n    requestInfo: CacheRequestInfo<T> | undefined,\n    respFrames: DataFrame[]\n  ): DataFrame[] {\n    if (requestInfo?.shouldCache) {\n      const newFrom = request.range.from.valueOf();\n      const newTo = request.range.to.valueOf();\n\n      // group frames by targets\n      const respByTarget = new Map<TargetIdent, DataFrame[]>();\n\n      respFrames.forEach((frame: DataFrame) => {\n        let targIdent = `${request.dashboardUID}|${request.panelId}|${frame.refId}`;\n\n        let frames = respByTarget.get(targIdent);\n\n        if (!frames) {\n          frames = [];\n          respByTarget.set(targIdent, frames);\n        }\n\n        frames.push(frame);\n      });\n\n      let outFrames: DataFrame[] = [];\n\n      respByTarget.forEach((respFrames, targIdent) => {\n        let cachedFrames = (targIdent ? this.cache.get(targIdent)?.frames : null) ?? [];\n\n        respFrames.forEach((respFrame: DataFrame) => {\n          // skip empty frames\n          if (respFrame.length === 0 || respFrame.fields.length === 0) {\n            return;\n          }\n\n          // frames are identified by their second (non-time) field's name + labels\n          // TODO: maybe also frame.meta.type?\n          let respFrameIdent = getFieldIdent(respFrame.fields[1]);\n\n          let cachedFrame = cachedFrames.find((cached) => getFieldIdent(cached.fields[1]) === respFrameIdent);\n\n          if (!cachedFrame) {\n            // append new unknown frames\n            cachedFrames.push(respFrame);\n          } else {\n            // we assume that fields cannot appear/disappear and will all exist in same order\n\n            // amend & re-cache\n            // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n            let prevTable: Table = cachedFrame.fields.map((field) => field.values) as Table;\n            // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n            let nextTable: Table = respFrame.fields.map((field) => field.values) as Table;\n\n            let amendedTable = amendTable(prevTable, nextTable);\n            if (amendedTable) {\n              for (let i = 0; i < amendedTable.length; i++) {\n                cachedFrame.fields[i].values = amendedTable[i];\n              }\n              cachedFrame.length = cachedFrame.fields[0].values.length;\n            }\n          }\n        });\n\n        // trim all frames to in-view range, evict those that end up with 0 length\n        let nonEmptyCachedFrames: DataFrame[] = [];\n\n        cachedFrames.forEach((frame) => {\n          // eslint-disable-next-line @typescript-eslint/consistent-type-assertions\n          let table: Table = frame.fields.map((field) => field.values) as Table;\n\n          let trimmed = trimTable(table, newFrom, newTo);\n\n          if (trimmed[0].length > 0) {\n            for (let i = 0; i < trimmed.length; i++) {\n              frame.fields[i].values = trimmed[i];\n            }\n            nonEmptyCachedFrames.push(frame);\n          }\n        });\n\n        this.cache.set(targIdent, {\n          sig: requestInfo.targSigs.get(targIdent)!,\n          frames: nonEmptyCachedFrames,\n          prevTo: newTo,\n        });\n\n        outFrames.push(...nonEmptyCachedFrames);\n      });\n\n      // transformV2 mutates field values for heatmap de-accum, and modifies field order, so we gotta clone here, for now :(\n      respFrames = outFrames.map((frame) => ({\n        ...frame,\n        fields: frame.fields.map((field) => ({\n          ...field,\n          config: {\n            ...field.config, // prevents mutatative exemplars links (re)enrichment\n          },\n          values: field.values.slice(),\n        })),\n      }));\n    }\n\n    return respFrames;\n  }\n}\n","import { flatten, forOwn, groupBy, partition } from 'lodash';\n\nimport {\n  CoreApp,\n  DataFrame,\n  DataFrameType,\n  DataLink,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataTopic,\n  Field,\n  FieldType,\n  getDisplayProcessor,\n  getFieldDisplayName,\n  Labels,\n  TIME_SERIES_TIME_FIELD_NAME,\n  TIME_SERIES_VALUE_FIELD_NAME,\n} from '@grafana/data';\nimport { config, getDataSourceSrv } from '@grafana/runtime';\n\nimport { ExemplarTraceIdDestination, PromMetric, PromQuery, PromValue } from './types';\n\n// handles case-insensitive Inf, +Inf, -Inf (with optional \"inity\" suffix)\nconst INFINITY_SAMPLE_REGEX = /^[+-]?inf(?:inity)?$/i;\n\nconst isTableResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  // We want to process vector and scalar results in Explore as table\n  if (\n    options.app === CoreApp.Explore &&\n    (dataFrame.meta?.custom?.resultType === 'vector' || dataFrame.meta?.custom?.resultType === 'scalar')\n  ) {\n    return true;\n  }\n\n  // We want to process all dataFrames with target.format === 'table' as table\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'table';\n};\n\nconst isCumulativeHeatmapResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  if (dataFrame.meta?.type === DataFrameType.HeatmapCells) {\n    return false;\n  }\n\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'heatmap';\n};\n\n// V2 result transformer used to transform query results from queries that were run through prometheus backend\nexport function transformV2(\n  response: DataQueryResponse,\n  request: DataQueryRequest<PromQuery>,\n  options: { exemplarTraceIdDestinations?: ExemplarTraceIdDestination[] }\n) {\n  // migration for dataplane field name issue\n  if (config.featureToggles.prometheusDataplane) {\n    // update displayNameFromDS in the field config\n    response.data.forEach((f: DataFrame) => {\n      const target = request.targets.find((t) => t.refId === f.refId);\n      // check that the legend is selected as auto\n      if (target && target.legendFormat === '__auto') {\n        f.fields.forEach((field) => {\n          if (field.labels?.__name__ && field.labels?.__name__ === field.name) {\n            const fieldCopy = { ...field, name: TIME_SERIES_VALUE_FIELD_NAME };\n            field.config.displayNameFromDS = getFieldDisplayName(fieldCopy, f, response.data);\n          }\n        });\n      }\n    });\n  }\n\n  const [tableFrames, framesWithoutTable] = partition<DataFrame>(response.data, (df) => isTableResult(df, request));\n  const processedTableFrames = transformDFToTable(tableFrames);\n\n  const [exemplarFrames, framesWithoutTableAndExemplars] = partition<DataFrame>(\n    framesWithoutTable,\n    (df) => df.meta?.custom?.resultType === 'exemplar'\n  );\n\n  // EXEMPLAR FRAMES: We enrich exemplar frames with data links and add dataTopic meta info\n  const { exemplarTraceIdDestinations: destinations } = options;\n  const processedExemplarFrames = exemplarFrames.map((dataFrame) => {\n    if (destinations?.length) {\n      for (const exemplarTraceIdDestination of destinations) {\n        const traceIDField = dataFrame.fields.find((field) => field.name === exemplarTraceIdDestination.name);\n        if (traceIDField) {\n          const links = getDataLinks(exemplarTraceIdDestination);\n          traceIDField.config.links = traceIDField.config.links?.length\n            ? [...traceIDField.config.links, ...links]\n            : links;\n        }\n      }\n    }\n\n    return { ...dataFrame, meta: { ...dataFrame.meta, dataTopic: DataTopic.Annotations } };\n  });\n\n  const [heatmapResults, framesWithoutTableHeatmapsAndExemplars] = partition<DataFrame>(\n    framesWithoutTableAndExemplars,\n    (df) => isCumulativeHeatmapResult(df, request)\n  );\n\n  // this works around the fact that we only get back frame.name with le buckets when legendFormat == {{le}}...which is not the default\n  heatmapResults.forEach((df) => {\n    if (df.name == null) {\n      let f = df.fields.find((f) => f.type === FieldType.number);\n\n      if (f) {\n        let le = f.labels?.le;\n\n        if (le) {\n          // this is used for sorting the frames by numeric ascending le labels for de-accum\n          df.name = le;\n          // this is used for renaming the Value fields to le label\n          f.config.displayNameFromDS = le;\n        }\n      }\n    }\n  });\n\n  // Group heatmaps by query\n  const heatmapResultsGroupedByQuery = groupBy<DataFrame>(heatmapResults, (h) => h.refId);\n\n  // Initialize empty array to push grouped histogram frames to\n  let processedHeatmapResultsGroupedByQuery: DataFrame[][] = [];\n\n  // Iterate through every query in this heatmap\n  for (const query in heatmapResultsGroupedByQuery) {\n    // Get reference to dataFrames for heatmap\n    const heatmapResultsGroup = heatmapResultsGroupedByQuery[query];\n\n    // Create a new grouping by iterating through the data frames...\n    const heatmapResultsGroupedByValues = groupBy<DataFrame>(heatmapResultsGroup, (dataFrame) => {\n      // Each data frame has `Time` and `Value` properties, we want to get the values\n      const values = dataFrame.fields.find((field) => field.type === FieldType.number);\n      // Specific functionality for special \"le\" quantile heatmap value, we know if this value exists, that we do not want to calculate the heatmap density across data frames from the same quartile\n      if (values?.labels && HISTOGRAM_QUANTILE_LABEL_NAME in values.labels) {\n        const { le, ...notLE } = values?.labels;\n        return Object.values(notLE).join();\n      }\n\n      // Return a string made from the concatenation of this frame's values to represent a grouping in the query\n      return Object.values(values?.labels ?? []).join();\n    });\n\n    // Then iterate through the resultant object\n    forOwn(heatmapResultsGroupedByValues, (dataFrames, key) => {\n      // Sort frames within each grouping\n      const sortedHeatmap = dataFrames.sort(sortSeriesByLabel);\n      // And push the sorted grouping with the rest\n      processedHeatmapResultsGroupedByQuery.push(mergeHeatmapFrames(transformToHistogramOverTime(sortedHeatmap)));\n    });\n  }\n\n  // Everything else is processed as time_series result and graph preferredVisualisationType\n  const otherFrames = framesWithoutTableHeatmapsAndExemplars.map((dataFrame) => {\n    const df: DataFrame = {\n      ...dataFrame,\n      meta: {\n        ...dataFrame.meta,\n        preferredVisualisationType: 'graph',\n      },\n    };\n    return df;\n  });\n\n  const flattenedProcessedHeatmapFrames = flatten(processedHeatmapResultsGroupedByQuery);\n\n  return {\n    ...response,\n    data: [...otherFrames, ...processedTableFrames, ...flattenedProcessedHeatmapFrames, ...processedExemplarFrames],\n  };\n}\n\nconst HISTOGRAM_QUANTILE_LABEL_NAME = 'le';\n\nexport function transformDFToTable(dfs: DataFrame[]): DataFrame[] {\n  // If no dataFrames or if 1 dataFrames with no values, return original dataFrame\n  if (dfs.length === 0 || (dfs.length === 1 && dfs[0].length === 0)) {\n    return dfs;\n  }\n\n  // Group results by refId and process dataFrames with the same refId as 1 dataFrame\n  const dataFramesByRefId = groupBy(dfs, 'refId');\n  const refIds = Object.keys(dataFramesByRefId);\n\n  const frames = refIds.map((refId) => {\n    // Create timeField, valueField and labelFields\n    const valueText = getValueText(refIds.length, refId);\n    const valueField = getValueField({ data: [], valueName: valueText });\n    const timeField = getTimeField([]);\n    const labelFields: Field[] = [];\n\n    // Fill labelsFields with labels from dataFrames\n    dataFramesByRefId[refId].forEach((df) => {\n      const frameValueField = df.fields[1];\n      const promLabels = frameValueField?.labels ?? {};\n\n      Object.keys(promLabels)\n        .sort()\n        .forEach((label) => {\n          // If we don't have label in labelFields, add it\n          if (!labelFields.some((l) => l.name === label)) {\n            const numberField = label === HISTOGRAM_QUANTILE_LABEL_NAME;\n            labelFields.push({\n              name: label,\n              config: { filterable: true },\n              type: numberField ? FieldType.number : FieldType.string,\n              values: [],\n            });\n          }\n        });\n    });\n\n    // Fill valueField, timeField and labelFields with values\n    dataFramesByRefId[refId].forEach((df) => {\n      const timeFields = df.fields[0]?.values ?? [];\n      const dataFields = df.fields[1]?.values ?? [];\n      timeFields.forEach((value) => timeField.values.push(value));\n      dataFields.forEach((value) => {\n        valueField.values.push(parseSampleValue(value));\n        const labelsForField = df.fields[1].labels ?? {};\n        labelFields.forEach((field) => field.values.push(getLabelValue(labelsForField, field.name)));\n      });\n    });\n\n    const fields = [timeField, ...labelFields, valueField];\n    return {\n      refId,\n      fields,\n      // Prometheus specific UI for instant queries\n      meta: {\n        ...dataFramesByRefId[refId][0].meta,\n        preferredVisualisationType: 'rawPrometheus' as const,\n      },\n      length: timeField.values.length,\n    };\n  });\n  return frames;\n}\n\nfunction getValueText(responseLength: number, refId = '') {\n  return responseLength > 1 ? `Value #${refId}` : 'Value';\n}\n\nfunction getDataLinks(options: ExemplarTraceIdDestination): DataLink[] {\n  const dataLinks: DataLink[] = [];\n\n  if (options.datasourceUid) {\n    const dataSourceSrv = getDataSourceSrv();\n    const dsSettings = dataSourceSrv.getInstanceSettings(options.datasourceUid);\n\n    // dsSettings is undefined because of the reasons below:\n    // - permissions issues (probably most likely)\n    // - deleted datasource\n    // - misconfiguration\n    if (dsSettings) {\n      dataLinks.push({\n        title: options.urlDisplayLabel || `Query with ${dsSettings?.name}`,\n        url: '',\n        internal: {\n          query: { query: '${__value.raw}', queryType: 'traceql' },\n          datasourceUid: options.datasourceUid,\n          datasourceName: dsSettings?.name ?? 'Data source not found',\n        },\n      });\n    }\n  }\n\n  if (options.url) {\n    dataLinks.push({\n      title: options.urlDisplayLabel || `Go to ${options.url}`,\n      url: options.url,\n      targetBlank: true,\n    });\n  }\n  return dataLinks;\n}\n\nfunction getLabelValue(metric: PromMetric, label: string): string | number {\n  if (metric.hasOwnProperty(label)) {\n    if (label === HISTOGRAM_QUANTILE_LABEL_NAME) {\n      return parseSampleValue(metric[label]);\n    }\n    return metric[label];\n  }\n  return '';\n}\n\nfunction getTimeField(data: PromValue[], isMs = false): Field<number> {\n  return {\n    name: TIME_SERIES_TIME_FIELD_NAME,\n    type: FieldType.time,\n    config: {},\n    values: data.map((val) => (isMs ? val[0] : val[0] * 1000)),\n  };\n}\n\ntype ValueFieldOptions = {\n  data: PromValue[];\n  valueName?: string;\n  parseValue?: boolean;\n  labels?: Labels;\n  displayNameFromDS?: string;\n};\n\nfunction getValueField({\n  data,\n  valueName = TIME_SERIES_VALUE_FIELD_NAME,\n  parseValue = true,\n  labels,\n  displayNameFromDS,\n}: ValueFieldOptions): Field {\n  return {\n    name: valueName,\n    type: FieldType.number,\n    display: getDisplayProcessor(),\n    config: {\n      displayNameFromDS,\n    },\n    labels,\n    values: data.map((val) => (parseValue ? parseSampleValue(val[1]) : val[1])),\n  };\n}\n\nexport function getOriginalMetricName(labelData: { [key: string]: string }) {\n  const metricName = labelData.__name__ || '';\n  delete labelData.__name__;\n  const labelPart = Object.entries(labelData)\n    .map((label) => `${label[0]}=\"${label[1]}\"`)\n    .join(',');\n  return `${metricName}{${labelPart}}`;\n}\n\nfunction mergeHeatmapFrames(frames: DataFrame[]): DataFrame[] {\n  if (frames.length === 0 || (frames.length === 1 && frames[0].length === 0)) {\n    return [];\n  }\n\n  const timeField = frames[0].fields.find((field) => field.type === FieldType.time)!;\n  const countFields = frames.map((frame) => {\n    let field = frame.fields.find((field) => field.type === FieldType.number)!;\n\n    return {\n      ...field,\n      name: field.config.displayNameFromDS!,\n    };\n  });\n\n  return [\n    {\n      ...frames[0],\n      meta: {\n        ...frames[0].meta,\n        type: DataFrameType.HeatmapRows,\n      },\n      fields: [timeField!, ...countFields],\n    },\n  ];\n}\n\n/** @internal */\nexport function transformToHistogramOverTime(seriesList: DataFrame[]): DataFrame[] {\n  /*      t1 = timestamp1, t2 = timestamp2 etc.\n            t1  t2  t3          t1  t2  t3\n    le10    10  10  0     =>    10  10  0\n    le20    20  10  30    =>    10  0   30\n    le30    30  10  35    =>    10  0   5\n    */\n\n  for (let i = seriesList.length - 1; i > 0; i--) {\n    const topSeries = seriesList[i].fields.find((s) => s.type === FieldType.number);\n    const bottomSeries = seriesList[i - 1].fields.find((s) => s.type === FieldType.number);\n    if (!topSeries || !bottomSeries) {\n      throw new Error('Prometheus heatmap transform error: data should be a time series');\n    }\n\n    for (let j = 0; j < topSeries.values.length; j++) {\n      const bottomPoint = bottomSeries.values[j] || [0];\n      topSeries.values[j] -= bottomPoint;\n\n      if (topSeries.values[j] < 1e-9) {\n        topSeries.values[j] = 0;\n      }\n    }\n  }\n\n  return seriesList;\n}\n\nexport function sortSeriesByLabel(s1: DataFrame, s2: DataFrame): number {\n  let le1, le2;\n\n  try {\n    // the state.displayName conditions are here because we also use this sorting util fn\n    // in panels where isHeatmapResult was false but we still want to sort numerically-named\n    // fields after the full unique displayName is cached in field state\n    le1 = parseSampleValue(s1.fields[1].state?.displayName ?? s1.name ?? s1.fields[1].name);\n    le2 = parseSampleValue(s2.fields[1].state?.displayName ?? s2.name ?? s2.fields[1].name);\n  } catch (err) {\n    // fail if not integer. might happen with bad queries\n    console.error(err);\n    return 0;\n  }\n\n  if (le1 > le2) {\n    return 1;\n  }\n\n  if (le1 < le2) {\n    return -1;\n  }\n\n  return 0;\n}\n\n/** @internal */\nexport function parseSampleValue(value: string): number {\n  if (INFINITY_SAMPLE_REGEX.test(value)) {\n    return value[0] === '-' ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY;\n  }\n  return parseFloat(value);\n}\n","import { CoreApp, DataQueryRequest, DataQueryResponse } from '@grafana/data';\nimport { config, reportInteraction } from '@grafana/runtime';\n\nimport { PromQuery } from './types';\n\nexport function trackQuery(\n  response: DataQueryResponse,\n  request: DataQueryRequest<PromQuery> & { targets: PromQuery[] },\n  startTime: Date\n): void {\n  const { app, targets: queries } = request;\n  // We do want to track panel-editor and explore\n  // We do not want to track queries from the dashboard or viewing a panel\n  // also included in the tracking is cloud-alerting, unified-alerting, and unknown\n  if (app === CoreApp.Dashboard || app === CoreApp.PanelViewer) {\n    return;\n  }\n\n  for (const query of queries) {\n    reportInteraction('grafana_prometheus_query_executed', {\n      app,\n      grafana_version: config.buildInfo.version,\n      has_data: response.data.some((frame) => frame.length > 0),\n      has_error: response.error !== undefined,\n      expr: query.expr,\n      format: query.format,\n      instant: query.instant,\n      range: query.range,\n      exemplar: query.exemplar,\n      hinting: query.hinting,\n      interval: query.interval,\n      intervalFactor: query.intervalFactor,\n      utcOffsetSec: query.utcOffsetSec,\n      legend: query.legendFormat,\n      valueWithRefId: query.valueWithRefId,\n      requestId: request.requestId,\n      showingGraph: query.showingGraph,\n      showingTable: query.showingTable,\n      editor_mode: query.editorMode,\n      simultaneously_sent_query_count: queries.length,\n      time_range_from: request?.range?.from?.toISOString(),\n      time_range_to: request?.range?.to?.toISOString(),\n      time_taken: Date.now() - startTime.getTime(),\n    });\n  }\n}\n","import debounce from 'debounce-promise';\nimport React, { useState } from 'react';\n\nimport { SelectableValue, toOption } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { AccessoryButton, InputGroup } from '@grafana/experimental';\nimport { AsyncSelect, Select } from '@grafana/ui';\n\nimport { truncateResult } from '../../language_utils';\nimport { QueryBuilderLabelFilter } from '../shared/types';\n\nexport interface LabelFilterItemProps {\n  defaultOp: string;\n  item: Partial<QueryBuilderLabelFilter>;\n  onChange: (value: QueryBuilderLabelFilter) => void;\n  onGetLabelNames: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onGetLabelValues: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onDelete: () => void;\n  invalidLabel?: boolean;\n  invalidValue?: boolean;\n  getLabelValuesAutofillSuggestions: (query: string, labelName?: string) => Promise<SelectableValue[]>;\n  debounceDuration: number;\n}\n\nexport function LabelFilterItem({\n  item,\n  defaultOp,\n  onChange,\n  onDelete,\n  onGetLabelNames,\n  onGetLabelValues,\n  invalidLabel,\n  invalidValue,\n  getLabelValuesAutofillSuggestions,\n  debounceDuration,\n}: LabelFilterItemProps) {\n  const [state, setState] = useState<{\n    labelNames?: SelectableValue[];\n    labelValues?: SelectableValue[];\n    isLoadingLabelNames?: boolean;\n    isLoadingLabelValues?: boolean;\n  }>({});\n  // there's a bug in react-select where the menu doesn't recalculate its position when the options are loaded asynchronously\n  // see https://github.com/grafana/grafana/issues/63558\n  // instead, we explicitly control the menu visibility and prevent showing it until the options have fully loaded\n  const [labelNamesMenuOpen, setLabelNamesMenuOpen] = useState(false);\n  const [labelValuesMenuOpen, setLabelValuesMenuOpen] = useState(false);\n\n  const isMultiSelect = (operator = item.op) => {\n    return operators.find((op) => op.label === operator)?.isMultiValue;\n  };\n\n  const getSelectOptionsFromString = (item?: string): string[] => {\n    if (item) {\n      const regExp = /\\(([^)]+)\\)/;\n      const matches = item?.match(regExp);\n\n      if (matches && matches[0].indexOf('|') > 0) {\n        return [item];\n      }\n\n      if (item.indexOf('|') > 0) {\n        return item.split('|');\n      }\n      return [item];\n    }\n    return [];\n  };\n\n  const labelValueSearch = debounce(\n    (query: string) => getLabelValuesAutofillSuggestions(query, item.label),\n    debounceDuration\n  );\n\n  const itemValue = item?.value ?? '';\n\n  return (\n    <div key={itemValue} data-testid=\"prometheus-dimensions-filter-item\">\n      <InputGroup>\n        {/* Label name select, loads all values at once */}\n        <Select\n          placeholder=\"Select label\"\n          data-testid={selectors.components.QueryBuilder.labelSelect}\n          inputId=\"prometheus-dimensions-filter-item-key\"\n          width=\"auto\"\n          value={item.label ? toOption(item.label) : null}\n          allowCustomValue\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelNames: true });\n            const labelNames = await onGetLabelNames(item);\n            setLabelNamesMenuOpen(true);\n            setState({ labelNames, isLoadingLabelNames: undefined });\n          }}\n          onCloseMenu={() => {\n            setLabelNamesMenuOpen(false);\n          }}\n          isOpen={labelNamesMenuOpen}\n          isLoading={state.isLoadingLabelNames ?? false}\n          options={state.labelNames}\n          onChange={(change) => {\n            if (change.label) {\n              onChange({\n                ...item,\n                op: item.op ?? defaultOp,\n                label: change.label,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidLabel}\n        />\n\n        {/* Operator select i.e.   = =~ != !~   */}\n        <Select\n          data-testid={selectors.components.QueryBuilder.matchOperatorSelect}\n          className=\"query-segment-operator\"\n          value={toOption(item.op ?? defaultOp)}\n          options={operators}\n          width=\"auto\"\n          onChange={(change) => {\n            if (change.value != null) {\n              onChange({\n                ...item,\n                op: change.value,\n                value: isMultiSelect(change.value) ? item.value : getSelectOptionsFromString(item?.value)[0],\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            }\n          }}\n        />\n\n        {/* Label value async select: autocomplete calls prometheus API */}\n        <AsyncSelect\n          placeholder=\"Select value\"\n          data-testid={selectors.components.QueryBuilder.valueSelect}\n          inputId=\"prometheus-dimensions-filter-item-value\"\n          width=\"auto\"\n          value={\n            isMultiSelect()\n              ? getSelectOptionsFromString(itemValue).map(toOption)\n              : getSelectOptionsFromString(itemValue).map(toOption)[0]\n          }\n          allowCustomValue\n          onOpenMenu={async () => {\n            setState({ isLoadingLabelValues: true });\n            const labelValues = await onGetLabelValues(item);\n            truncateResult(labelValues);\n            setLabelValuesMenuOpen(true);\n            setState({\n              ...state,\n              labelValues,\n              isLoadingLabelValues: undefined,\n            });\n          }}\n          onCloseMenu={() => {\n            setLabelValuesMenuOpen(false);\n          }}\n          isOpen={labelValuesMenuOpen}\n          defaultOptions={state.labelValues}\n          isMulti={isMultiSelect()}\n          isLoading={state.isLoadingLabelValues}\n          loadOptions={labelValueSearch}\n          onChange={(change) => {\n            if (change.value) {\n              onChange({\n                ...item,\n                value: change.value,\n                op: item.op ?? defaultOp,\n                // eslint-ignore\n              } as QueryBuilderLabelFilter);\n            } else {\n              const changes = change\n                .map((change: { label?: string }) => {\n                  return change.label;\n                })\n                .join('|');\n              // eslint-ignore\n              onChange({ ...item, value: changes, op: item.op ?? defaultOp } as QueryBuilderLabelFilter);\n            }\n          }}\n          invalid={invalidValue}\n        />\n        <AccessoryButton aria-label={`remove-${item.label}`} icon=\"times\" variant=\"secondary\" onClick={onDelete} />\n      </InputGroup>\n    </div>\n  );\n}\n\nconst operators = [\n  { label: '=', value: '=', isMultiValue: false },\n  { label: '!=', value: '!=', isMultiValue: false },\n  { label: '=~', value: '=~', isMultiValue: true },\n  { label: '!~', value: '!~', isMultiValue: true },\n];\n","import { css, cx } from '@emotion/css';\nimport { isEqual } from 'lodash';\nimport React, { useEffect, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { EditorField, EditorFieldGroup, EditorList } from '@grafana/experimental';\nimport { InlineFieldRow, InlineLabel } from '@grafana/ui';\n\nimport { QueryBuilderLabelFilter } from '../shared/types';\n\nimport { LabelFilterItem } from './LabelFilterItem';\n\nexport const MISSING_LABEL_FILTER_ERROR_MESSAGE = 'Select at least 1 label filter (label and value)';\n\nexport interface LabelFiltersProps {\n  labelsFilters: QueryBuilderLabelFilter[];\n  onChange: (labelFilters: Array<Partial<QueryBuilderLabelFilter>>) => void;\n  onGetLabelNames: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  onGetLabelValues: (forLabel: Partial<QueryBuilderLabelFilter>) => Promise<SelectableValue[]>;\n  /** If set to true, component will show error message until at least 1 filter is selected */\n  labelFilterRequired?: boolean;\n  getLabelValuesAutofillSuggestions: (query: string, labelName?: string) => Promise<SelectableValue[]>;\n  debounceDuration: number;\n  variableEditor?: boolean;\n}\n\nexport function LabelFilters({\n  labelsFilters,\n  onChange,\n  onGetLabelNames,\n  onGetLabelValues,\n  labelFilterRequired,\n  getLabelValuesAutofillSuggestions,\n  debounceDuration,\n  variableEditor,\n}: LabelFiltersProps) {\n  const defaultOp = '=';\n  const [items, setItems] = useState<Array<Partial<QueryBuilderLabelFilter>>>([{ op: defaultOp }]);\n\n  useEffect(() => {\n    if (labelsFilters.length > 0) {\n      setItems(labelsFilters);\n    } else {\n      setItems([{ op: defaultOp }]);\n    }\n  }, [labelsFilters]);\n\n  const onLabelsChange = (newItems: Array<Partial<QueryBuilderLabelFilter>>) => {\n    setItems(newItems);\n\n    // Extract full label filters with both label & value\n    const newLabels = newItems.filter((x) => x.label != null && x.value != null);\n    if (!isEqual(newLabels, labelsFilters)) {\n      onChange(newLabels);\n    }\n  };\n\n  const hasLabelFilter = items.some((item) => item.label && item.value);\n\n  const editorList = () => {\n    return (\n      <EditorList\n        items={items}\n        onChange={onLabelsChange}\n        renderItem={(item: Partial<QueryBuilderLabelFilter>, onChangeItem, onDelete) => (\n          <LabelFilterItem\n            debounceDuration={debounceDuration}\n            item={item}\n            defaultOp={defaultOp}\n            onChange={onChangeItem}\n            onDelete={onDelete}\n            onGetLabelNames={onGetLabelNames}\n            onGetLabelValues={onGetLabelValues}\n            invalidLabel={labelFilterRequired && !item.label}\n            invalidValue={labelFilterRequired && !item.value}\n            getLabelValuesAutofillSuggestions={getLabelValuesAutofillSuggestions}\n          />\n        )}\n      />\n    );\n  };\n\n  return (\n    <>\n      {variableEditor ? (\n        <InlineFieldRow>\n          <div\n            className={cx(css`\n              display: flex;\n            `)}\n          >\n            <InlineLabel\n              width={20}\n              tooltip={<div>Optional: used to filter the metric select for this query type.</div>}\n            >\n              Label filters\n            </InlineLabel>\n            {editorList()}\n          </div>\n        </InlineFieldRow>\n      ) : (\n        <EditorFieldGroup>\n          <EditorField\n            label=\"Label filters\"\n            error={MISSING_LABEL_FILTER_ERROR_MESSAGE}\n            invalid={labelFilterRequired && !hasLabelFilter}\n          >\n            {editorList()}\n          </EditorField>\n        </EditorFieldGroup>\n      )}\n    </>\n  );\n}\n","import React, { useCallback } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { getMetadataString } from '../../language_provider';\nimport { truncateResult } from '../../language_utils';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { regexifyLabelValuesQueryString } from '../parsingUtils';\nimport { QueryBuilderLabelFilter } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { LabelFilters } from './LabelFilters';\nimport { MetricSelect } from './MetricSelect';\n\nexport interface MetricsLabelsSectionProps {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromVisualQuery) => void;\n  variableEditor?: boolean;\n  onBlur?: () => void;\n}\n\nexport function MetricsLabelsSection({\n  datasource,\n  query,\n  onChange,\n  onBlur,\n  variableEditor,\n}: MetricsLabelsSectionProps) {\n  // fixing the use of 'as' from refactoring\n  // @ts-ignore\n  const onChangeLabels = (labels) => {\n    onChange({ ...query, labels });\n  };\n  /**\n   * Map metric metadata to SelectableValue for Select component and also adds defined template variables to the list.\n   */\n  const withTemplateVariableOptions = useCallback(\n    async (optionsPromise: Promise<SelectableValue[]>): Promise<SelectableValue[]> => {\n      const variables = datasource.getVariables();\n      const options = await optionsPromise;\n      return [\n        ...variables.map((value: string) => ({ label: value, value })),\n        ...options.map((option: SelectableValue) => ({\n          label: option.value,\n          value: option.value,\n          title: option.description,\n        })),\n      ];\n    },\n    [datasource]\n  );\n\n  /**\n   * Function kicked off when user interacts with label in label filters.\n   * Formats a promQL expression and passes that off to helper functions depending on API support\n   * @param forLabel\n   */\n  const onGetLabelNames = async (forLabel: Partial<QueryBuilderLabelFilter>): Promise<SelectableValue[]> => {\n    // If no metric we need to use a different method\n    if (!query.metric) {\n      await datasource.languageProvider.fetchLabels();\n      return datasource.languageProvider.getLabelKeys().map((k) => ({ value: k }));\n    }\n\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n    labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n    const expr = promQueryModeller.renderLabels(labelsToConsider);\n\n    let labelsIndex: Record<string, string[]> = await datasource.languageProvider.fetchLabelsWithMatch(expr);\n\n    // filter out already used labels\n    return Object.keys(labelsIndex)\n      .filter((labelName) => !labelsToConsider.find((filter) => filter.label === labelName))\n      .map((k) => ({ value: k }));\n  };\n\n  const getLabelValuesAutocompleteSuggestions = (\n    queryString?: string,\n    labelName?: string\n  ): Promise<SelectableValue[]> => {\n    const forLabel = {\n      label: labelName ?? '__name__',\n      op: '=~',\n      value: regexifyLabelValuesQueryString(`.*${queryString}`),\n    };\n    const labelsToConsider = query.labels.filter((x) => x.label !== forLabel.label);\n    labelsToConsider.push(forLabel);\n    if (query.metric) {\n      labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n    }\n    const interpolatedLabelsToConsider = labelsToConsider.map((labelObject) => ({\n      ...labelObject,\n      label: datasource.interpolateString(labelObject.label),\n      value: datasource.interpolateString(labelObject.value),\n    }));\n    const expr = promQueryModeller.renderLabels(interpolatedLabelsToConsider);\n    let response: Promise<SelectableValue[]>;\n    if (datasource.hasLabelsMatchAPISupport()) {\n      response = getLabelValuesFromLabelValuesAPI(forLabel, expr);\n    } else {\n      response = getLabelValuesFromSeriesAPI(forLabel, expr);\n    }\n\n    return response.then((response: SelectableValue[]) => {\n      truncateResult(response);\n      return response;\n    });\n  };\n\n  /**\n   * Helper function to fetch and format label value results from legacy API\n   * @param forLabel\n   * @param promQLExpression\n   */\n  const getLabelValuesFromSeriesAPI = (\n    forLabel: Partial<QueryBuilderLabelFilter>,\n    promQLExpression: string\n  ): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return Promise.resolve([]);\n    }\n    const result = datasource.languageProvider.fetchSeries(promQLExpression);\n    const forLabelInterpolated = datasource.interpolateString(forLabel.label);\n    return result.then((result) => {\n      // This query returns duplicate values, scrub them out\n      const set = new Set<string>();\n      result.forEach((labelValue) => {\n        const labelNameString = labelValue[forLabelInterpolated];\n        set.add(labelNameString);\n      });\n\n      return Array.from(set).map((labelValues: string) => ({ label: labelValues, value: labelValues }));\n    });\n  };\n\n  /**\n   * Helper function to fetch label values from a promql string expression and a label\n   * @param forLabel\n   * @param promQLExpression\n   */\n  const getLabelValuesFromLabelValuesAPI = (\n    forLabel: Partial<QueryBuilderLabelFilter>,\n    promQLExpression: string\n  ): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return Promise.resolve([]);\n    }\n    return datasource.languageProvider.fetchSeriesValuesWithMatch(forLabel.label, promQLExpression).then((response) => {\n      return response.map((v) => ({\n        value: v,\n        label: v,\n      }));\n    });\n  };\n\n  /**\n   * Function kicked off when users interact with the value of the label filters\n   * Formats a promQL expression and passes that into helper functions depending on API support\n   * @param forLabel\n   */\n  const onGetLabelValues = async (forLabel: Partial<QueryBuilderLabelFilter>): Promise<SelectableValue[]> => {\n    if (!forLabel.label) {\n      return [];\n    }\n    // If no metric is selected, we can get the raw list of labels\n    if (!query.metric) {\n      return (await datasource.languageProvider.getLabelValues(forLabel.label)).map((v) => ({ value: v }));\n    }\n\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n    labelsToConsider.push({ label: '__name__', op: '=', value: query.metric });\n\n    const interpolatedLabelsToConsider = labelsToConsider.map((labelObject) => ({\n      ...labelObject,\n      label: datasource.interpolateString(labelObject.label),\n      value: datasource.interpolateString(labelObject.value),\n    }));\n\n    const expr = promQueryModeller.renderLabels(interpolatedLabelsToConsider);\n\n    if (datasource.hasLabelsMatchAPISupport()) {\n      return getLabelValuesFromLabelValuesAPI(forLabel, expr);\n    } else {\n      return getLabelValuesFromSeriesAPI(forLabel, expr);\n    }\n  };\n\n  const onGetMetrics = useCallback(() => {\n    return withTemplateVariableOptions(getMetrics(datasource, query));\n  }, [datasource, query, withTemplateVariableOptions]);\n\n  return (\n    <>\n      <MetricSelect\n        query={query}\n        onChange={onChange}\n        onGetMetrics={onGetMetrics}\n        datasource={datasource}\n        labelsFilters={query.labels}\n        metricLookupDisabled={datasource.lookupsDisabled}\n        onBlur={onBlur ? onBlur : () => {}}\n        variableEditor={variableEditor}\n      />\n      <LabelFilters\n        debounceDuration={datasource.getDebounceTimeInMilliseconds()}\n        getLabelValuesAutofillSuggestions={getLabelValuesAutocompleteSuggestions}\n        labelsFilters={query.labels}\n        onChange={onChangeLabels}\n        onGetLabelNames={(forLabel) => withTemplateVariableOptions(onGetLabelNames(forLabel))}\n        onGetLabelValues={(forLabel) => withTemplateVariableOptions(onGetLabelValues(forLabel))}\n        variableEditor={variableEditor}\n      />\n    </>\n  );\n}\n\n/**\n * Returns list of metrics, either all or filtered by query param. It also adds description string to each metric if it\n * exists.\n * @param datasource\n * @param query\n */\nasync function getMetrics(\n  datasource: PrometheusDatasource,\n  query: PromVisualQuery\n): Promise<Array<{ value: string; description?: string }>> {\n  // Makes sure we loaded the metadata for metrics. Usually this is done in the start() method of the provider but we\n  // don't use it with the visual builder and there is no need to run all the start() setup anyway.\n  if (!datasource.languageProvider.metricsMetadata) {\n    await datasource.languageProvider.loadMetricsMetadata();\n  }\n\n  // Error handling for when metrics metadata returns as undefined\n  if (!datasource.languageProvider.metricsMetadata) {\n    datasource.languageProvider.metricsMetadata = {};\n  }\n\n  let metrics: string[];\n  if (query.labels.length > 0) {\n    const expr = promQueryModeller.renderLabels(query.labels);\n    metrics = (await datasource.languageProvider.getSeries(expr, true))['__name__'] ?? [];\n  } else {\n    metrics = (await datasource.languageProvider.getLabelValues('__name__')) ?? [];\n  }\n\n  return metrics.map((m) => ({\n    value: m,\n    description: getMetadataString(m, datasource.languageProvider.metricsMetadata!),\n  }));\n}\n","import React, { FormEvent, useCallback, useEffect, useState } from 'react';\n\nimport { QueryEditorProps, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { InlineField, InlineFieldRow, Input, Select, TextArea } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport {\n  migrateVariableEditorBackToVariableSupport,\n  migrateVariableQueryToEditor,\n} from '../migrations/variableMigration';\nimport { promQueryModeller } from '../querybuilder/PromQueryModeller';\nimport { MetricsLabelsSection } from '../querybuilder/components/MetricsLabelsSection';\nimport { QueryBuilderLabelFilter } from '../querybuilder/shared/types';\nimport { PromVisualQuery } from '../querybuilder/types';\nimport {\n  PromOptions,\n  PromQuery,\n  PromVariableQuery,\n  PromVariableQueryType as QueryType,\n  StandardPromVariableQuery,\n} from '../types';\n\nexport const variableOptions = [\n  { label: 'Label names', value: QueryType.LabelNames },\n  { label: 'Label values', value: QueryType.LabelValues },\n  { label: 'Metrics', value: QueryType.MetricNames },\n  { label: 'Query result', value: QueryType.VarQueryResult },\n  { label: 'Series query', value: QueryType.SeriesQuery },\n  { label: 'Classic query', value: QueryType.ClassicQuery },\n];\n\nexport type Props = QueryEditorProps<PrometheusDatasource, PromQuery, PromOptions, PromVariableQuery>;\n\nconst refId = 'PrometheusVariableQueryEditor-VariableQuery';\n\nexport const PromVariableQueryEditor = ({ onChange, query, datasource, range }: Props) => {\n  // to select the query type, i.e. label_names, label_values, etc.\n  const [qryType, setQryType] = useState<number | undefined>(undefined);\n  // list of variables for each function\n  const [label, setLabel] = useState('');\n\n  const [labelNamesMatch, setLabelNamesMatch] = useState('');\n\n  // metric is used for both label_values() and metric()\n  // label_values() metric requires a whole/complete metric\n  // metric() is expected to be a part of a metric string\n  const [metric, setMetric] = useState('');\n  // varQuery is a whole query, can include math/rates/etc\n  const [varQuery, setVarQuery] = useState('');\n  // seriesQuery is only a whole\n  const [seriesQuery, setSeriesQuery] = useState('');\n\n  // the original variable query implementation, e.g. label_value(metric, label_name)\n  const [classicQuery, setClassicQuery] = useState('');\n\n  // list of label names for label_values(), /api/v1/labels, contains the same results as label_names() function\n  const [labelOptions, setLabelOptions] = useState<Array<SelectableValue<string>>>([]);\n\n  // label filters have been added as a filter for metrics in label values query type\n  const [labelFilters, setLabelFilters] = useState<QueryBuilderLabelFilter[]>([]);\n\n  useEffect(() => {\n    datasource.languageProvider.start(range);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  useEffect(() => {\n    if (!query) {\n      return;\n    }\n\n    if (query.qryType === QueryType.ClassicQuery) {\n      setQryType(query.qryType);\n      setClassicQuery(query.query ?? '');\n    } else {\n      // 1. Changing from standard to custom variable editor changes the string attr from expr to query\n      // 2. jsonnet grafana as code passes a variable as a string\n      const variableQuery = variableMigration(query);\n\n      setLabelNamesMatch(variableQuery.match ?? '');\n      setQryType(variableQuery.qryType);\n      setLabel(variableQuery.label ?? '');\n      setMetric(variableQuery.metric ?? '');\n      setLabelFilters(variableQuery.labelFilters ?? []);\n      setVarQuery(variableQuery.varQuery ?? '');\n      setSeriesQuery(variableQuery.seriesQuery ?? '');\n      setClassicQuery(variableQuery.classicQuery ?? '');\n    }\n  }, [query]);\n\n  // set the label names options for the label values var query\n  useEffect(() => {\n    if (qryType !== QueryType.LabelValues) {\n      return;\n    }\n    const variables = datasource.getVariables().map((variable: string) => ({ label: variable, value: variable }));\n    if (!metric) {\n      // get all the labels\n      datasource.getTagKeys({ filters: [] }).then((labelNames: Array<{ text: string }>) => {\n        const names = labelNames.map(({ text }) => ({ label: text, value: text }));\n        setLabelOptions([...variables, ...names]);\n      });\n    } else {\n      // fetch the labels filtered by the metric\n      const labelToConsider = [{ label: '__name__', op: '=', value: metric }];\n      const expr = promQueryModeller.renderLabels(labelToConsider);\n\n      datasource.languageProvider.fetchLabelsWithMatch(expr).then((labelsIndex: Record<string, string[]>) => {\n        const labelNames = Object.keys(labelsIndex);\n        const names = labelNames.map((value) => ({ label: value, value: value }));\n        setLabelOptions([...variables, ...names]);\n      });\n    }\n  }, [datasource, qryType, metric]);\n\n  const onChangeWithVariableString = (\n    updateVar: { [key: string]: QueryType | string },\n    updLabelFilters?: QueryBuilderLabelFilter[]\n  ) => {\n    const queryVar = {\n      qryType,\n      label,\n      metric,\n      match: labelNamesMatch,\n      varQuery,\n      seriesQuery,\n      classicQuery,\n      refId: 'PrometheusVariableQueryEditor-VariableQuery',\n    };\n\n    let updateLabelFilters = updLabelFilters ? { labelFilters: updLabelFilters } : { labelFilters: labelFilters };\n\n    const updatedVar = { ...queryVar, ...updateVar, ...updateLabelFilters };\n\n    const queryString = migrateVariableEditorBackToVariableSupport(updatedVar);\n\n    // setting query.query property allows for update of variable definition\n    onChange({\n      query: queryString,\n      qryType: updatedVar.qryType,\n      refId,\n    });\n  };\n\n  /** Call onchange for label names query type change */\n  const onQueryTypeChange = (newType: SelectableValue<QueryType>) => {\n    setQryType(newType.value);\n    if (newType.value !== QueryType.SeriesQuery) {\n      onChangeWithVariableString({ qryType: newType.value ?? 0 });\n    }\n  };\n\n  /** Call onchange for label select when query type is label values */\n  const onLabelChange = (newLabel: SelectableValue<string>) => {\n    const newLabelvalue = newLabel && newLabel.value ? newLabel.value : '';\n    setLabel(newLabelvalue);\n    if (qryType === QueryType.LabelValues && newLabelvalue) {\n      onChangeWithVariableString({ label: newLabelvalue });\n    }\n  };\n\n  /**\n   * Call onChange for MetricsLabels component change for label values query type\n   * if there is a label (required) and\n   * if the labels or metric are updated.\n   */\n  const metricsLabelsChange = (update: PromVisualQuery) => {\n    setMetric(update.metric);\n    setLabelFilters(update.labels);\n\n    const updMetric = update.metric;\n    const updLabelFilters = update.labels ?? [];\n\n    if (qryType === QueryType.LabelValues && label && (updMetric || updLabelFilters)) {\n      onChangeWithVariableString({ qryType, metric: updMetric }, updLabelFilters);\n    }\n  };\n\n  const onLabelNamesMatchChange = (regex: string) => {\n    if (qryType === QueryType.LabelNames) {\n      onChangeWithVariableString({ qryType, match: regex });\n    }\n  };\n\n  /**\n   * Call onchange for metric change if metrics names (regex) query type\n   * Debounce this because to not call the API for every keystroke.\n   */\n  const onMetricChange = (value: string) => {\n    if (qryType === QueryType.MetricNames && value) {\n      onChangeWithVariableString({ metric: value });\n    }\n  };\n\n  /**\n   *  Do not call onchange for variable query result when query type is var query result\n   *  because the query may not be finished typing and an error is returned\n   *  for incorrectly formatted series. Call onchange for blur instead.\n   */\n  const onVarQueryChange = (e: FormEvent<HTMLTextAreaElement>) => {\n    setVarQuery(e.currentTarget.value);\n  };\n\n  /**\n   *  Do not call onchange for seriesQuery when query type is series query\n   *  because the series may not be finished typing and an error is returned\n   *  for incorrectly formatted series. Call onchange for blur instead.\n   */\n  const onSeriesQueryChange = (e: FormEvent<HTMLInputElement>) => {\n    setSeriesQuery(e.currentTarget.value);\n  };\n\n  const onClassicQueryChange = (e: FormEvent<HTMLInputElement>) => {\n    setClassicQuery(e.currentTarget.value);\n  };\n\n  const promVisualQuery = useCallback(() => {\n    return { metric: metric, labels: labelFilters, operations: [] };\n  }, [metric, labelFilters]);\n\n  return (\n    <>\n      <InlineFieldRow>\n        <InlineField\n          label=\"Query type\"\n          labelWidth={20}\n          tooltip={\n            <div>The Prometheus data source plugin provides the following query types for template variables.</div>\n          }\n        >\n          <Select\n            placeholder=\"Select query type\"\n            aria-label=\"Query type\"\n            onChange={onQueryTypeChange}\n            value={qryType}\n            options={variableOptions}\n            width={25}\n            data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.queryType}\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      {qryType === QueryType.LabelValues && (\n        <>\n          <InlineFieldRow>\n            <InlineField\n              label=\"Label\"\n              labelWidth={20}\n              required\n              aria-labelledby=\"label-select\"\n              tooltip={\n                <div>\n                  Returns a list of label values for the label name in all metrics unless the metric is specified.\n                </div>\n              }\n            >\n              <Select\n                aria-label=\"label-select\"\n                onChange={onLabelChange}\n                value={label}\n                options={labelOptions}\n                width={25}\n                allowCustomValue\n                isClearable={true}\n                data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.labelValues.labelSelect}\n              />\n            </InlineField>\n          </InlineFieldRow>\n          {/* Used to select an optional metric with optional label filters */}\n          <MetricsLabelsSection\n            query={promVisualQuery()}\n            datasource={datasource}\n            onChange={metricsLabelsChange}\n            variableEditor={true}\n          />\n        </>\n      )}\n\n      {qryType === QueryType.LabelNames && (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Metric regex\"\n            labelWidth={20}\n            aria-labelledby=\"Metric regex\"\n            tooltip={<div>Returns a list of label names, optionally filtering by specified metric regex.</div>}\n          >\n            <Input\n              type=\"text\"\n              aria-label=\"Metric regex\"\n              placeholder=\"Metric regex\"\n              value={labelNamesMatch}\n              onBlur={(event) => {\n                setLabelNamesMatch(event.currentTarget.value);\n                onLabelNamesMatchChange(event.currentTarget.value);\n              }}\n              onChange={(e) => {\n                setLabelNamesMatch(e.currentTarget.value);\n              }}\n              width={25}\n              data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.labelnames.metricRegex}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      )}\n\n      {qryType === QueryType.MetricNames && (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Metric regex\"\n            labelWidth={20}\n            aria-labelledby=\"Metric selector\"\n            tooltip={<div>Returns a list of metrics matching the specified metric regex.</div>}\n          >\n            <Input\n              type=\"text\"\n              aria-label=\"Metric selector\"\n              placeholder=\"Metric regex\"\n              value={metric}\n              onChange={(e) => {\n                setMetric(e.currentTarget.value);\n              }}\n              onBlur={(e) => {\n                setMetric(e.currentTarget.value);\n                onMetricChange(e.currentTarget.value);\n              }}\n              width={25}\n              data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.metricNames.metricRegex}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      )}\n\n      {qryType === QueryType.VarQueryResult && (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Query\"\n            labelWidth={20}\n            tooltip={\n              <div>\n                Returns a list of Prometheus query results for the query. This can include Prometheus functions, i.e.\n                sum(go_goroutines).\n              </div>\n            }\n          >\n            <TextArea\n              type=\"text\"\n              aria-label=\"Prometheus Query\"\n              placeholder=\"Prometheus Query\"\n              value={varQuery}\n              onChange={onVarQueryChange}\n              onBlur={() => {\n                if (qryType === QueryType.VarQueryResult && varQuery) {\n                  onChangeWithVariableString({ qryType });\n                }\n              }}\n              cols={100}\n              data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.varQueryResult}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      )}\n\n      {qryType === QueryType.SeriesQuery && (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Series Query\"\n            labelWidth={20}\n            tooltip={\n              <div>\n                Enter enter a metric with labels, only a metric or only labels, i.e.\n                go_goroutines&#123;instance=&quot;localhost:9090&quot;&#125;, go_goroutines, or\n                &#123;instance=&quot;localhost:9090&quot;&#125;. Returns a list of time series associated with the\n                entered data.\n              </div>\n            }\n          >\n            <Input\n              type=\"text\"\n              aria-label=\"Series Query\"\n              placeholder=\"Series Query\"\n              value={seriesQuery}\n              onChange={onSeriesQueryChange}\n              onBlur={() => {\n                if (qryType === QueryType.SeriesQuery && seriesQuery) {\n                  onChangeWithVariableString({ qryType });\n                }\n              }}\n              width={100}\n              data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.seriesQuery}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      )}\n\n      {qryType === QueryType.ClassicQuery && (\n        <InlineFieldRow>\n          <InlineField\n            label=\"Classic Query\"\n            labelWidth={20}\n            tooltip={\n              <div>\n                The original implemetation of the Prometheus variable query editor. Enter a string with the correct\n                query type and parameters as described in these docs. For example, label_values(label, metric).\n              </div>\n            }\n          >\n            <Input\n              type=\"text\"\n              aria-label=\"Classic Query\"\n              placeholder=\"Classic Query\"\n              value={classicQuery}\n              onChange={onClassicQueryChange}\n              onBlur={() => {\n                if (qryType === QueryType.ClassicQuery && classicQuery) {\n                  onChangeWithVariableString({ qryType });\n                }\n              }}\n              width={100}\n              data-testid={selectors.components.DataSource.Prometheus.variableQueryEditor.classicQuery}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      )}\n    </>\n  );\n};\n\nexport function variableMigration(query: string | PromVariableQuery | StandardPromVariableQuery): PromVariableQuery {\n  if (typeof query === 'string') {\n    return migrateVariableQueryToEditor(query);\n  } else if (query.query) {\n    return migrateVariableQueryToEditor(query.query);\n  } else {\n    return query;\n  }\n}\n","import { from, Observable, of } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport { CustomVariableSupport, DataQueryRequest, DataQueryResponse, rangeUtil } from '@grafana/data';\nimport { getTemplateSrv, TemplateSrv } from '@grafana/runtime';\n\nimport { PromVariableQueryEditor } from './components/VariableQueryEditor';\nimport { PrometheusDatasource } from './datasource';\nimport { PrometheusMetricFindQuery } from './metric_find_query';\nimport { PromVariableQuery } from './types';\n\nexport class PrometheusVariableSupport extends CustomVariableSupport<PrometheusDatasource> {\n  constructor(\n    private readonly datasource: PrometheusDatasource,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv()\n  ) {\n    super();\n  }\n\n  editor = PromVariableQueryEditor;\n\n  query(request: DataQueryRequest<PromVariableQuery>): Observable<DataQueryResponse> {\n    // Handling grafana as code from jsonnet variable queries which are strings and not objects\n    // Previously, when using StandardVariableSupport\n    // the variable query string was changed to be on the expr attribute\n    // Now, using CustomVariableSupport,\n    // the variable query is changed to the query attribute.\n    // So, without standard variable support changing the query string to the expr attribute,\n    // the variable query string is coming in as it is written in jsonnet,\n    // where it is just a string. Here is where we handle that.\n    let query: string | undefined;\n    if (typeof request.targets[0] === 'string') {\n      query = request.targets[0];\n    } else {\n      query = request.targets[0].query;\n    }\n\n    if (!query) {\n      return of({ data: [] });\n    }\n\n    const scopedVars = {\n      ...request.scopedVars,\n      __interval: { text: this.datasource.interval, value: this.datasource.interval },\n      __interval_ms: {\n        text: rangeUtil.intervalToMs(this.datasource.interval),\n        value: rangeUtil.intervalToMs(this.datasource.interval),\n      },\n      ...this.datasource.getRangeScopedVars(request.range),\n    };\n\n    const interpolated = this.templateSrv.replace(query, scopedVars, this.datasource.interpolateQueryExpr);\n    const metricFindQuery = new PrometheusMetricFindQuery(this.datasource, interpolated);\n    const metricFindStream = from(metricFindQuery.process(request.range));\n\n    return metricFindStream.pipe(map((results) => ({ data: results })));\n  }\n}\n","import { defaults } from 'lodash';\nimport { lastValueFrom, Observable, throwError } from 'rxjs';\nimport { map, tap } from 'rxjs/operators';\nimport semver from 'semver/preload';\n\nimport {\n  AbstractQuery,\n  AdHocVariableFilter,\n  AnnotationEvent,\n  AnnotationQueryRequest,\n  CoreApp,\n  DataFrame,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceGetTagKeysOptions,\n  DataSourceGetTagValuesOptions,\n  DataSourceInstanceSettings,\n  DataSourceWithQueryExportSupport,\n  DataSourceWithQueryImportSupport,\n  dateTime,\n  getDefaultTimeRange,\n  LegacyMetricFindQueryOptions,\n  MetricFindValue,\n  QueryFixAction,\n  rangeUtil,\n  renderLegendFormat,\n  ScopedVars,\n  TimeRange,\n} from '@grafana/data';\nimport {\n  BackendDataSourceResponse,\n  BackendSrvRequest,\n  config,\n  DataSourceWithBackend,\n  FetchResponse,\n  getBackendSrv,\n  getTemplateSrv,\n  isFetchError,\n  TemplateSrv,\n  toDataQueryResponse,\n} from '@grafana/runtime';\n\nimport { addLabelToQuery } from './add_label_to_query';\nimport { AnnotationQueryEditor } from './components/AnnotationQueryEditor';\nimport PrometheusLanguageProvider from './language_provider';\nimport {\n  expandRecordingRules,\n  getClientCacheDurationInMinutes,\n  getPrometheusTime,\n  getRangeSnapInterval,\n} from './language_utils';\nimport { PrometheusMetricFindQuery } from './metric_find_query';\nimport { getInitHints, getQueryHints } from './query_hints';\nimport { promQueryModeller } from './querybuilder/PromQueryModeller';\nimport { QueryBuilderLabelFilter, QueryEditorMode } from './querybuilder/shared/types';\nimport { CacheRequestInfo, defaultPrometheusQueryOverlapWindow, QueryCache } from './querycache/QueryCache';\nimport { getOriginalMetricName, transformV2 } from './result_transformer';\nimport { trackQuery } from './tracking';\nimport {\n  ExemplarTraceIdDestination,\n  PromApplication,\n  PrometheusCacheLevel,\n  PromOptions,\n  PromQuery,\n  PromQueryRequest,\n} from './types';\nimport { PrometheusVariableSupport } from './variables';\n\nconst ANNOTATION_QUERY_STEP_DEFAULT = '60s';\nconst GET_AND_POST_METADATA_ENDPOINTS = ['api/v1/query', 'api/v1/query_range', 'api/v1/series', 'api/v1/labels'];\n\nexport const InstantQueryRefIdIndex = '-Instant';\n\nexport class PrometheusDatasource\n  extends DataSourceWithBackend<PromQuery, PromOptions>\n  implements DataSourceWithQueryImportSupport<PromQuery>, DataSourceWithQueryExportSupport<PromQuery>\n{\n  type: string;\n  ruleMappings: { [index: string]: string };\n  hasIncrementalQuery: boolean;\n  url: string;\n  id: number;\n  access: 'direct' | 'proxy';\n  basicAuth: any;\n  withCredentials: any;\n  interval: string;\n  queryTimeout: string | undefined;\n  httpMethod: string;\n  languageProvider: PrometheusLanguageProvider;\n  exemplarTraceIdDestinations: ExemplarTraceIdDestination[] | undefined;\n  lookupsDisabled: boolean;\n  customQueryParameters: any;\n  datasourceConfigurationPrometheusFlavor?: PromApplication;\n  datasourceConfigurationPrometheusVersion?: string;\n  disableRecordingRules: boolean;\n  defaultEditor?: QueryEditorMode;\n  exemplarsAvailable: boolean;\n  cacheLevel: PrometheusCacheLevel;\n  cache: QueryCache<PromQuery>;\n\n  constructor(\n    instanceSettings: DataSourceInstanceSettings<PromOptions>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    languageProvider?: PrometheusLanguageProvider\n  ) {\n    super(instanceSettings);\n\n    this.type = 'prometheus';\n    this.id = instanceSettings.id;\n    this.url = instanceSettings.url!;\n    this.access = instanceSettings.access;\n    this.basicAuth = instanceSettings.basicAuth;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.interval = instanceSettings.jsonData.timeInterval || '15s';\n    this.queryTimeout = instanceSettings.jsonData.queryTimeout;\n    this.httpMethod = instanceSettings.jsonData.httpMethod || 'GET';\n    this.exemplarTraceIdDestinations = instanceSettings.jsonData.exemplarTraceIdDestinations;\n    this.hasIncrementalQuery = instanceSettings.jsonData.incrementalQuerying ?? false;\n    this.ruleMappings = {};\n    this.languageProvider = languageProvider ?? new PrometheusLanguageProvider(this);\n    this.lookupsDisabled = instanceSettings.jsonData.disableMetricsLookup ?? false;\n    this.customQueryParameters = new URLSearchParams(instanceSettings.jsonData.customQueryParameters);\n    this.datasourceConfigurationPrometheusFlavor = instanceSettings.jsonData.prometheusType;\n    this.datasourceConfigurationPrometheusVersion = instanceSettings.jsonData.prometheusVersion;\n    this.defaultEditor = instanceSettings.jsonData.defaultEditor;\n    this.disableRecordingRules = instanceSettings.jsonData.disableRecordingRules ?? false;\n    this.variables = new PrometheusVariableSupport(this, this.templateSrv);\n    this.exemplarsAvailable = true;\n    this.cacheLevel = instanceSettings.jsonData.cacheLevel ?? PrometheusCacheLevel.Low;\n\n    this.cache = new QueryCache({\n      getTargetSignature: this.getPrometheusTargetSignature.bind(this),\n      overlapString: instanceSettings.jsonData.incrementalQueryOverlapWindow ?? defaultPrometheusQueryOverlapWindow,\n      profileFunction: this.getPrometheusProfileData.bind(this),\n    });\n\n    // This needs to be here and cannot be static because of how annotations typing affects casting of data source\n    // objects to DataSourceApi types.\n    // We don't use the default processing for prometheus.\n    // See standardAnnotationSupport.ts/[shouldUseMappingUI|shouldUseLegacyRunner]\n    this.annotations = {\n      QueryEditor: AnnotationQueryEditor,\n    };\n  }\n\n  init = async () => {\n    if (!this.disableRecordingRules) {\n      this.loadRules();\n    }\n    this.exemplarsAvailable = await this.areExemplarsAvailable();\n  };\n\n  getQueryDisplayText(query: PromQuery) {\n    return query.expr;\n  }\n\n  getPrometheusProfileData(request: DataQueryRequest<PromQuery>, targ: PromQuery) {\n    return {\n      interval: targ.interval ?? request.interval,\n      expr: this.interpolateString(targ.expr),\n      datasource: 'Prometheus',\n    };\n  }\n\n  /**\n   * Get target signature for query caching\n   * @param request\n   * @param query\n   */\n  getPrometheusTargetSignature(request: DataQueryRequest<PromQuery>, query: PromQuery) {\n    const targExpr = this.interpolateString(query.expr);\n    return `${targExpr}|${query.interval ?? request.interval}|${JSON.stringify(request.rangeRaw ?? '')}|${\n      query.exemplar\n    }`;\n  }\n\n  hasLabelsMatchAPISupport(): boolean {\n    return (\n      // https://github.com/prometheus/prometheus/releases/tag/v2.24.0\n      this._isDatasourceVersionGreaterOrEqualTo('2.24.0', PromApplication.Prometheus) ||\n      // All versions of Mimir support matchers for labels API\n      this._isDatasourceVersionGreaterOrEqualTo('2.0.0', PromApplication.Mimir) ||\n      // https://github.com/cortexproject/cortex/discussions/4542\n      this._isDatasourceVersionGreaterOrEqualTo('1.11.0', PromApplication.Cortex) ||\n      // https://github.com/thanos-io/thanos/pull/3566\n      //https://github.com/thanos-io/thanos/releases/tag/v0.18.0\n      this._isDatasourceVersionGreaterOrEqualTo('0.18.0', PromApplication.Thanos)\n    );\n  }\n\n  _isDatasourceVersionGreaterOrEqualTo(targetVersion: string, targetFlavor: PromApplication): boolean {\n    // User hasn't configured flavor/version yet, default behavior is to support labels match api support\n    if (!this.datasourceConfigurationPrometheusVersion || !this.datasourceConfigurationPrometheusFlavor) {\n      return true;\n    }\n\n    if (targetFlavor !== this.datasourceConfigurationPrometheusFlavor) {\n      return false;\n    }\n\n    return semver.gte(this.datasourceConfigurationPrometheusVersion, targetVersion);\n  }\n\n  _addTracingHeaders(httpOptions: PromQueryRequest, options: DataQueryRequest<PromQuery>) {\n    httpOptions.headers = {};\n    if (this.access === 'proxy') {\n      httpOptions.headers['X-Dashboard-UID'] = options.dashboardUID;\n      httpOptions.headers['X-Panel-Id'] = options.panelId;\n    }\n  }\n\n  directAccessError() {\n    return throwError(\n      () =>\n        new Error(\n          'Browser access mode in the Prometheus datasource is no longer available. Switch to server access mode.'\n        )\n    );\n  }\n\n  /**\n   * Any request done from this data source should go through here as it contains some common processing for the\n   * request. Any processing done here needs to be also copied on the backend as this goes through data source proxy\n   * but not through the same code as alerting.\n   */\n  _request<T = unknown>(\n    url: string,\n    data: Record<string, string> | null,\n    overrides: Partial<BackendSrvRequest> = {}\n  ): Observable<FetchResponse<T>> {\n    if (this.access === 'direct') {\n      return this.directAccessError();\n    }\n\n    data = data || {};\n    for (const [key, value] of this.customQueryParameters) {\n      if (data[key] == null) {\n        data[key] = value;\n      }\n    }\n\n    let queryUrl = this.url + url;\n    if (url.startsWith(`/api/datasources/uid/${this.uid}`)) {\n      // This url is meant to be a replacement for the whole URL. Replace the entire URL\n      queryUrl = url;\n    }\n\n    const options: BackendSrvRequest = defaults(overrides, {\n      url: queryUrl,\n      method: this.httpMethod,\n      headers: {},\n    });\n\n    if (options.method === 'GET') {\n      if (data && Object.keys(data).length) {\n        options.url =\n          options.url +\n          (options.url.search(/\\?/) >= 0 ? '&' : '?') +\n          Object.entries(data)\n            .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n            .join('&');\n      }\n    } else {\n      options.headers!['Content-Type'] = 'application/x-www-form-urlencoded';\n      options.data = data;\n    }\n\n    if (this.basicAuth || this.withCredentials) {\n      options.withCredentials = true;\n    }\n\n    if (this.basicAuth) {\n      options.headers!.Authorization = this.basicAuth;\n    }\n\n    return getBackendSrv().fetch<T>(options);\n  }\n\n  async importFromAbstractQueries(abstractQueries: AbstractQuery[]): Promise<PromQuery[]> {\n    return abstractQueries.map((abstractQuery) => this.languageProvider.importFromAbstractQuery(abstractQuery));\n  }\n\n  async exportToAbstractQueries(queries: PromQuery[]): Promise<AbstractQuery[]> {\n    return queries.map((query) => this.languageProvider.exportToAbstractQuery(query));\n  }\n\n  // Use this for tab completion features, wont publish response to other components\n  async metadataRequest<T = any>(url: string, params = {}, options?: Partial<BackendSrvRequest>) {\n    // If URL includes endpoint that supports POST and GET method, try to use configured method. This might fail as POST is supported only in v2.10+.\n    if (GET_AND_POST_METADATA_ENDPOINTS.some((endpoint) => url.includes(endpoint))) {\n      try {\n        return await lastValueFrom(\n          this._request<T>(`/api/datasources/uid/${this.uid}/resources${url}`, params, {\n            method: this.httpMethod,\n            hideFromInspector: true,\n            showErrorAlert: false,\n            ...options,\n          })\n        );\n      } catch (err) {\n        // If status code of error is Method Not Allowed (405) and HTTP method is POST, retry with GET\n        if (this.httpMethod === 'POST' && isFetchError(err) && (err.status === 405 || err.status === 400)) {\n          console.warn(`Couldn't use configured POST HTTP method for this request. Trying to use GET method instead.`);\n        } else {\n          throw err;\n        }\n      }\n    }\n\n    return await lastValueFrom(\n      this._request<T>(`/api/datasources/uid/${this.uid}/resources${url}`, params, {\n        method: 'GET',\n        hideFromInspector: true,\n        ...options,\n      })\n    ); // toPromise until we change getTagValues, getLabelNames to Observable\n  }\n\n  interpolateQueryExpr(value: string | string[] = [], variable: any) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return prometheusRegularEscape(value);\n    }\n\n    if (typeof value === 'string') {\n      return prometheusSpecialRegexEscape(value);\n    }\n\n    const escapedValues = value.map((val) => prometheusSpecialRegexEscape(val));\n\n    if (escapedValues.length === 1) {\n      return escapedValues[0];\n    }\n\n    return '(' + escapedValues.join('|') + ')';\n  }\n\n  targetContainsTemplate(target: PromQuery) {\n    return this.templateSrv.containsTemplate(target.expr);\n  }\n\n  shouldRunExemplarQuery(target: PromQuery, request: DataQueryRequest<PromQuery>): boolean {\n    if (target.exemplar) {\n      // We check all already processed targets and only create exemplar target for not used metric names\n      const metricName = this.languageProvider.histogramMetrics.find((m) => target.expr.includes(m));\n      // Remove targets that weren't processed yet (in targets array they are after current target)\n      const currentTargetIdx = request.targets.findIndex((t) => t.refId === target.refId);\n      const targets = request.targets.slice(0, currentTargetIdx).filter((t) => !t.hide);\n\n      if (!metricName || (metricName && !targets.some((t) => t.expr.includes(metricName)))) {\n        return true;\n      }\n      return false;\n    }\n    return false;\n  }\n\n  processTargetV2(target: PromQuery, request: DataQueryRequest<PromQuery>) {\n    const processedTargets: PromQuery[] = [];\n    const processedTarget = {\n      ...target,\n      exemplar: this.shouldRunExemplarQuery(target, request),\n      requestId: request.panelId + target.refId,\n      // We need to pass utcOffsetSec to backend to calculate aligned range\n      utcOffsetSec: request.range.to.utcOffset() * 60,\n    };\n\n    if (config.featureToggles.promQLScope) {\n      processedTarget.scope = request.scope;\n    }\n\n    if (target.instant && target.range) {\n      // We have query type \"Both\" selected\n      // We should send separate queries with different refId\n      processedTargets.push(\n        {\n          ...processedTarget,\n          refId: processedTarget.refId,\n          instant: false,\n        },\n        {\n          ...processedTarget,\n          refId: processedTarget.refId + InstantQueryRefIdIndex,\n          range: false,\n        }\n      );\n    } else {\n      processedTargets.push(processedTarget);\n    }\n\n    return processedTargets;\n  }\n\n  query(request: DataQueryRequest<PromQuery>): Observable<DataQueryResponse> {\n    if (this.access === 'direct') {\n      return this.directAccessError();\n    }\n\n    let fullOrPartialRequest: DataQueryRequest<PromQuery>;\n    let requestInfo: CacheRequestInfo<PromQuery> | undefined = undefined;\n    const hasInstantQuery = request.targets.some((target) => target.instant);\n\n    // Don't cache instant queries\n    if (this.hasIncrementalQuery && !hasInstantQuery) {\n      requestInfo = this.cache.requestInfo(request);\n      fullOrPartialRequest = requestInfo.requests[0];\n    } else {\n      fullOrPartialRequest = request;\n    }\n\n    const targets = fullOrPartialRequest.targets.map((target) => this.processTargetV2(target, fullOrPartialRequest));\n    const startTime = new Date();\n    return super.query({ ...fullOrPartialRequest, targets: targets.flat() }).pipe(\n      map((response) => {\n        const amendedResponse = {\n          ...response,\n          data: this.cache.procFrames(request, requestInfo, response.data),\n        };\n        return transformV2(amendedResponse, request, {\n          exemplarTraceIdDestinations: this.exemplarTraceIdDestinations,\n        });\n      }),\n      tap((response: DataQueryResponse) => {\n        trackQuery(response, request, startTime);\n      })\n    );\n  }\n\n  createQuery(target: PromQuery, options: DataQueryRequest<PromQuery>, start: number, end: number) {\n    const query: PromQueryRequest = {\n      hinting: target.hinting,\n      instant: target.instant,\n      exemplar: target.exemplar,\n      step: 0,\n      expr: '',\n      refId: target.refId,\n      start: 0,\n      end: 0,\n    };\n    const range = Math.ceil(end - start);\n\n    // options.interval is the dynamically calculated interval\n    let interval: number = rangeUtil.intervalToSeconds(options.interval);\n    // Minimum interval (\"Min step\"), if specified for the query, or same as interval otherwise.\n    const minInterval = rangeUtil.intervalToSeconds(\n      this.templateSrv.replace(target.interval || options.interval, options.scopedVars)\n    );\n    // Scrape interval as specified for the query (\"Min step\") or otherwise taken from the datasource.\n    // Min step field can have template variables in it, make sure to replace it.\n    const scrapeInterval = target.interval\n      ? rangeUtil.intervalToSeconds(this.templateSrv.replace(target.interval, options.scopedVars))\n      : rangeUtil.intervalToSeconds(this.interval);\n\n    const intervalFactor = target.intervalFactor || 1;\n    // Adjust the interval to take into account any specified minimum and interval factor plus Prometheus limits\n    const adjustedInterval = this.adjustInterval(interval, minInterval, range, intervalFactor);\n    let scopedVars = {\n      ...options.scopedVars,\n      ...this.getRangeScopedVars(options.range),\n      ...this.getRateIntervalScopedVariable(adjustedInterval, scrapeInterval),\n    };\n    // If the interval was adjusted, make a shallow copy of scopedVars with updated interval vars\n    if (interval !== adjustedInterval) {\n      interval = adjustedInterval;\n      scopedVars = Object.assign({}, options.scopedVars, {\n        __interval: { text: interval + 's', value: interval + 's' },\n        __interval_ms: { text: interval * 1000, value: interval * 1000 },\n        ...this.getRateIntervalScopedVariable(interval, scrapeInterval),\n        ...this.getRangeScopedVars(options.range),\n      });\n    }\n\n    query.step = interval;\n\n    let expr = target.expr;\n\n    // Apply adhoc filters\n    expr = this.enhanceExprWithAdHocFilters(options.filters, expr);\n\n    // Only replace vars in expression after having (possibly) updated interval vars\n    query.expr = this.templateSrv.replace(expr, scopedVars, this.interpolateQueryExpr);\n\n    // Align query interval with step to allow query caching and to ensure\n    // that about-same-time query results look the same.\n    const adjusted = alignRange(start, end, query.step, options.range.to.utcOffset() * 60);\n    query.start = adjusted.start;\n    query.end = adjusted.end;\n    this._addTracingHeaders(query, options);\n\n    return query;\n  }\n\n  getRateIntervalScopedVariable(interval: number, scrapeInterval: number) {\n    // Fall back to the default scrape interval of 15s if scrapeInterval is 0 for some reason.\n    if (scrapeInterval === 0) {\n      scrapeInterval = 15;\n    }\n    const rateInterval = Math.max(interval + scrapeInterval, 4 * scrapeInterval);\n    return { __rate_interval: { text: rateInterval + 's', value: rateInterval + 's' } };\n  }\n\n  adjustInterval(interval: number, minInterval: number, range: number, intervalFactor: number) {\n    // Prometheus will drop queries that might return more than 11000 data points.\n    // Calculate a safe interval as an additional minimum to take into account.\n    // Fractional safeIntervals are allowed, however serve little purpose if the interval is greater than 1\n    // If this is the case take the ceil of the value.\n    let safeInterval = range / 11000;\n    if (safeInterval > 1) {\n      safeInterval = Math.ceil(safeInterval);\n    }\n    return Math.max(interval * intervalFactor, minInterval, safeInterval);\n  }\n\n  metricFindQuery(query: string, options?: LegacyMetricFindQueryOptions) {\n    if (!query) {\n      return Promise.resolve([]);\n    }\n\n    const scopedVars = {\n      __interval: { text: this.interval, value: this.interval },\n      __interval_ms: { text: rangeUtil.intervalToMs(this.interval), value: rangeUtil.intervalToMs(this.interval) },\n      ...this.getRangeScopedVars(options?.range ?? getDefaultTimeRange()),\n    };\n    const interpolated = this.templateSrv.replace(query, scopedVars, this.interpolateQueryExpr);\n    const metricFindQuery = new PrometheusMetricFindQuery(this, interpolated);\n    return metricFindQuery.process(options?.range ?? getDefaultTimeRange());\n  }\n\n  getRangeScopedVars(range: TimeRange) {\n    const msRange = range.to.diff(range.from);\n    const sRange = Math.round(msRange / 1000);\n    return {\n      __range_ms: { text: msRange, value: msRange },\n      __range_s: { text: sRange, value: sRange },\n      __range: { text: sRange + 's', value: sRange + 's' },\n    };\n  }\n\n  async annotationQuery(options: AnnotationQueryRequest<PromQuery>): Promise<AnnotationEvent[]> {\n    if (this.access === 'direct') {\n      const error = new Error(\n        'Browser access mode in the Prometheus datasource is no longer available. Switch to server access mode.'\n      );\n      return Promise.reject(error);\n    }\n\n    const annotation = options.annotation;\n    const { expr = '' } = annotation;\n\n    if (!expr) {\n      return Promise.resolve([]);\n    }\n\n    const step = options.annotation.step || ANNOTATION_QUERY_STEP_DEFAULT;\n    const queryModel = {\n      expr,\n      range: true,\n      instant: false,\n      exemplar: false,\n      interval: step,\n      refId: 'X',\n      datasource: this.getRef(),\n    };\n\n    return await lastValueFrom(\n      getBackendSrv()\n        .fetch<BackendDataSourceResponse>({\n          url: '/api/ds/query',\n          method: 'POST',\n          headers: this.getRequestHeaders(),\n          data: {\n            from: (getPrometheusTime(options.range.from, false) * 1000).toString(),\n            to: (getPrometheusTime(options.range.to, true) * 1000).toString(),\n            queries: [this.applyTemplateVariables(queryModel, {})],\n          },\n          requestId: `prom-query-${annotation.name}`,\n        })\n        .pipe(\n          map((rsp: FetchResponse<BackendDataSourceResponse>) => {\n            return this.processAnnotationResponse(options, rsp.data);\n          })\n        )\n    );\n  }\n\n  processAnnotationResponse = (options: AnnotationQueryRequest<PromQuery>, data: BackendDataSourceResponse) => {\n    const frames: DataFrame[] = toDataQueryResponse({ data: data }).data;\n    if (!frames || !frames.length) {\n      return [];\n    }\n\n    const annotation = options.annotation;\n    const { tagKeys = '', titleFormat = '', textFormat = '' } = annotation;\n\n    const step = rangeUtil.intervalToSeconds(annotation.step || ANNOTATION_QUERY_STEP_DEFAULT) * 1000;\n    const tagKeysArray = tagKeys.split(',');\n\n    const eventList: AnnotationEvent[] = [];\n\n    for (const frame of frames) {\n      if (frame.fields.length === 0) {\n        continue;\n      }\n      const timeField = frame.fields[0];\n      const valueField = frame.fields[1];\n      const labels = valueField?.labels || {};\n\n      const tags = Object.keys(labels)\n        .filter((label) => tagKeysArray.includes(label))\n        .map((label) => labels[label]);\n\n      const timeValueTuple: Array<[number, number]> = [];\n\n      let idx = 0;\n      valueField.values.forEach((value: string) => {\n        let timeStampValue: number;\n        let valueValue: number;\n        const time = timeField.values[idx];\n\n        // If we want to use value as a time, we use value as timeStampValue and valueValue will be 1\n        if (options.annotation.useValueForTime) {\n          timeStampValue = Math.floor(parseFloat(value));\n          valueValue = 1;\n        } else {\n          timeStampValue = Math.floor(parseFloat(time));\n          valueValue = parseFloat(value);\n        }\n\n        idx++;\n        timeValueTuple.push([timeStampValue, valueValue]);\n      });\n\n      const activeValues = timeValueTuple.filter((value) => value[1] > 0);\n      const activeValuesTimestamps = activeValues.map((value) => value[0]);\n\n      // Instead of creating singular annotation for each active event we group events into region if they are less\n      // or equal to `step` apart.\n      let latestEvent: AnnotationEvent | null = null;\n\n      for (const timestamp of activeValuesTimestamps) {\n        // We already have event `open` and we have new event that is inside the `step` so we just update the end.\n        if (latestEvent && (latestEvent.timeEnd ?? 0) + step >= timestamp) {\n          latestEvent.timeEnd = timestamp;\n          continue;\n        }\n\n        // Event exists but new one is outside of the `step` so we add it to eventList.\n        if (latestEvent) {\n          eventList.push(latestEvent);\n        }\n\n        // We start a new region.\n        latestEvent = {\n          time: timestamp,\n          timeEnd: timestamp,\n          annotation,\n          title: renderLegendFormat(titleFormat, labels),\n          tags,\n          text: renderLegendFormat(textFormat, labels),\n        };\n      }\n\n      if (latestEvent) {\n        // Finish up last point if we have one\n        latestEvent.timeEnd = activeValuesTimestamps[activeValuesTimestamps.length - 1];\n        eventList.push(latestEvent);\n      }\n    }\n\n    return eventList;\n  };\n\n  // By implementing getTagKeys and getTagValues we add ad-hoc filters functionality\n  // this is used to get label keys, a.k.a label names\n  // it is used in metric_find_query.ts\n  // and in Tempo here grafana/public/app/plugins/datasource/tempo/QueryEditor/ServiceGraphSection.tsx\n  async getTagKeys(options: DataSourceGetTagKeysOptions<PromQuery>): Promise<MetricFindValue[]> {\n    if (!options || options.filters.length === 0) {\n      await this.languageProvider.fetchLabels(options.timeRange);\n      return this.languageProvider.getLabelKeys().map((k) => ({ value: k, text: k }));\n    }\n\n    const labelFilters: QueryBuilderLabelFilter[] = options.filters.map((f) => ({\n      label: f.key,\n      value: f.value,\n      op: f.operator,\n    }));\n    const expr = promQueryModeller.renderLabels(labelFilters);\n\n    let labelsIndex: Record<string, string[]> = await this.languageProvider.fetchLabelsWithMatch(expr);\n\n    // filter out already used labels\n    return Object.keys(labelsIndex)\n      .filter((labelName) => !options.filters.find((filter) => filter.key === labelName))\n      .map((k) => ({ value: k, text: k }));\n  }\n\n  // By implementing getTagKeys and getTagValues we add ad-hoc filters functionality\n  async getTagValues(options: DataSourceGetTagValuesOptions) {\n    const labelFilters: QueryBuilderLabelFilter[] = options.filters.map((f) => ({\n      label: f.key,\n      value: f.value,\n      op: f.operator,\n    }));\n\n    const expr = promQueryModeller.renderLabels(labelFilters);\n\n    if (this.hasLabelsMatchAPISupport()) {\n      return (await this.languageProvider.fetchSeriesValuesWithMatch(options.key, expr, options.timeRange)).map(\n        (v) => ({\n          value: v,\n          text: v,\n        })\n      );\n    }\n\n    const params = this.getTimeRangeParams(options.timeRange ?? getDefaultTimeRange());\n    const result = await this.metadataRequest(`/api/v1/label/${options.key}/values`, params);\n    return result?.data?.data?.map((value: any) => ({ text: value })) ?? [];\n  }\n\n  interpolateVariablesInQueries(\n    queries: PromQuery[],\n    scopedVars: ScopedVars,\n    filters?: AdHocVariableFilter[]\n  ): PromQuery[] {\n    let expandedQueries = queries;\n    if (queries && queries.length) {\n      expandedQueries = queries.map((query) => {\n        const interpolatedQuery = this.templateSrv.replace(query.expr, scopedVars, this.interpolateQueryExpr);\n        const withAdhocFilters = this.enhanceExprWithAdHocFilters(filters, interpolatedQuery);\n\n        const expandedQuery = {\n          ...query,\n          datasource: this.getRef(),\n          expr: withAdhocFilters,\n          interval: this.templateSrv.replace(query.interval, scopedVars),\n        };\n        return expandedQuery;\n      });\n    }\n    return expandedQueries;\n  }\n\n  getQueryHints(query: PromQuery, result: any[]) {\n    return getQueryHints(query.expr ?? '', result, this);\n  }\n\n  getInitHints() {\n    return getInitHints(this);\n  }\n\n  async loadRules() {\n    try {\n      const res = await this.metadataRequest('/api/v1/rules', {}, { showErrorAlert: false });\n      const groups = res.data?.data?.groups;\n\n      if (groups) {\n        this.ruleMappings = extractRuleMappingFromGroups(groups);\n      }\n    } catch (e) {\n      console.log('Rules API is experimental. Ignore next error.');\n      console.error(e);\n    }\n  }\n\n  async areExemplarsAvailable() {\n    try {\n      const res = await this.metadataRequest(\n        '/api/v1/query_exemplars',\n        {\n          query: 'test',\n          start: dateTime().subtract(30, 'minutes').valueOf().toString(),\n          end: dateTime().valueOf().toString(),\n        },\n        {\n          // Avoid alerting the user if this test fails\n          showErrorAlert: false,\n        }\n      );\n      if (res.data.status === 'success') {\n        return true;\n      }\n      return false;\n    } catch (err) {\n      return false;\n    }\n  }\n\n  modifyQuery(query: PromQuery, action: QueryFixAction): PromQuery {\n    let expression = query.expr ?? '';\n    switch (action.type) {\n      case 'ADD_FILTER': {\n        const { key, value } = action.options ?? {};\n        if (key && value) {\n          expression = addLabelToQuery(expression, key, value);\n        }\n\n        break;\n      }\n      case 'ADD_FILTER_OUT': {\n        const { key, value } = action.options ?? {};\n        if (key && value) {\n          expression = addLabelToQuery(expression, key, value, '!=');\n        }\n        break;\n      }\n      case 'ADD_HISTOGRAM_QUANTILE': {\n        expression = `histogram_quantile(0.95, sum(rate(${expression}[$__rate_interval])) by (le))`;\n        break;\n      }\n      case 'ADD_RATE': {\n        expression = `rate(${expression}[$__rate_interval])`;\n        break;\n      }\n      case 'ADD_SUM': {\n        expression = `sum(${expression.trim()}) by ($1)`;\n        break;\n      }\n      case 'EXPAND_RULES': {\n        if (action.options) {\n          expression = expandRecordingRules(expression, action.options);\n        }\n        break;\n      }\n      default:\n        break;\n    }\n    return { ...query, expr: expression };\n  }\n\n  /**\n   * Returns the adjusted \"snapped\" interval parameters\n   */\n  getAdjustedInterval(timeRange: TimeRange): { start: string; end: string } {\n    return getRangeSnapInterval(this.cacheLevel, timeRange);\n  }\n\n  /**\n   * This will return a time range that always includes the users current time range,\n   * and then a little extra padding to round up/down to the nearest nth minute,\n   * defined by the result of the getCacheDurationInMinutes.\n   *\n   * For longer cache durations, and shorter query durations,\n   * the window we're calculating might be much bigger then the user's current window,\n   * resulting in us returning labels/values that might not be applicable for the given window,\n   * this is a necessary trade-off if we want to cache larger durations\n   */\n  getTimeRangeParams(timeRange: TimeRange): { start: string; end: string } {\n    return {\n      start: getPrometheusTime(timeRange.from, false).toString(),\n      end: getPrometheusTime(timeRange.to, true).toString(),\n    };\n  }\n\n  getOriginalMetricName(labelData: { [key: string]: string }) {\n    return getOriginalMetricName(labelData);\n  }\n\n  enhanceExprWithAdHocFilters(filters: AdHocVariableFilter[] | undefined, expr: string) {\n    if (!filters || filters.length === 0) {\n      return expr;\n    }\n\n    const finalQuery = filters.reduce((acc: string, filter: { key?: any; operator?: any; value?: any }) => {\n      const { key, operator } = filter;\n      let { value } = filter;\n      if (operator === '=~' || operator === '!~') {\n        value = prometheusRegularEscape(value);\n      }\n      return addLabelToQuery(acc, key, value, operator);\n    }, expr);\n    return finalQuery;\n  }\n\n  // Used when running queries through backend\n  filterQuery(query: PromQuery): boolean {\n    if (query.hide || !query.expr) {\n      return false;\n    }\n    return true;\n  }\n\n  // Used when running queries through backend\n  applyTemplateVariables(target: PromQuery, scopedVars: ScopedVars, filters?: AdHocVariableFilter[]) {\n    const variables = { ...scopedVars };\n\n    // We want to interpolate these variables on backend.\n    // The pre-calculated values are replaced withe the variable strings.\n    variables.__interval = {\n      value: '$__interval',\n    };\n    variables.__interval_ms = {\n      value: '$__interval_ms',\n    };\n\n    // interpolate expression\n    const expr = this.templateSrv.replace(target.expr, variables, this.interpolateQueryExpr);\n\n    // Add ad hoc filters\n    const exprWithAdHocFilters = this.enhanceExprWithAdHocFilters(filters, expr);\n\n    return {\n      ...target,\n      expr: exprWithAdHocFilters,\n      interval: this.templateSrv.replace(target.interval, variables),\n      legendFormat: this.templateSrv.replace(target.legendFormat, variables),\n    };\n  }\n\n  getVariables(): string[] {\n    return this.templateSrv.getVariables().map((v) => `$${v.name}`);\n  }\n\n  interpolateString(string: string, scopedVars?: ScopedVars) {\n    return this.templateSrv.replace(string, scopedVars, this.interpolateQueryExpr);\n  }\n\n  getDebounceTimeInMilliseconds(): number {\n    switch (this.cacheLevel) {\n      case PrometheusCacheLevel.Medium:\n        return 600;\n      case PrometheusCacheLevel.High:\n        return 1200;\n      default:\n        return 350;\n    }\n  }\n\n  getDaysToCacheMetadata(): number {\n    switch (this.cacheLevel) {\n      case PrometheusCacheLevel.Medium:\n        return 7;\n      case PrometheusCacheLevel.High:\n        return 30;\n      default:\n        return 1;\n    }\n  }\n\n  getCacheDurationInMinutes(): number {\n    return getClientCacheDurationInMinutes(this.cacheLevel);\n  }\n\n  getDefaultQuery(app: CoreApp): PromQuery {\n    const defaults = {\n      refId: 'A',\n      expr: '',\n      range: true,\n      instant: false,\n    };\n\n    if (app === CoreApp.UnifiedAlerting) {\n      return {\n        ...defaults,\n        instant: true,\n        range: false,\n      };\n    }\n\n    if (app === CoreApp.Explore) {\n      return {\n        ...defaults,\n        instant: true,\n        range: true,\n      };\n    }\n\n    return defaults;\n  }\n}\n\n/**\n * Align query range to step.\n * Rounds start and end down to a multiple of step.\n * @param start Timestamp marking the beginning of the range.\n * @param end Timestamp marking the end of the range.\n * @param step Interval to align start and end with.\n * @param utcOffsetSec Number of seconds current timezone is offset from UTC\n */\nexport function alignRange(\n  start: number,\n  end: number,\n  step: number,\n  utcOffsetSec: number\n): { end: number; start: number } {\n  const alignedEnd = Math.floor((end + utcOffsetSec) / step) * step - utcOffsetSec;\n  const alignedStart = Math.floor((start + utcOffsetSec) / step) * step - utcOffsetSec;\n  return {\n    end: alignedEnd,\n    start: alignedStart,\n  };\n}\n\nexport function extractRuleMappingFromGroups(groups: any[]) {\n  return groups.reduce(\n    (mapping, group) =>\n      group.rules\n        .filter((rule: any) => rule.type === 'recording')\n        .reduce(\n          (acc: { [key: string]: string }, rule: any) => ({\n            ...acc,\n            [rule.name]: rule.query,\n          }),\n          mapping\n        ),\n    {}\n  );\n}\n\n// NOTE: these two functions are very similar to the escapeLabelValueIn* functions\n// in language_utils.ts, but they are not exactly the same algorithm, and we found\n// no way to reuse one in the another or vice versa.\nexport function prometheusRegularEscape(value: unknown) {\n  return typeof value === 'string' ? value.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, \"\\\\\\\\'\") : value;\n}\n\nexport function prometheusSpecialRegexEscape(value: unknown) {\n  return typeof value === 'string' ? value.replace(/\\\\/g, '\\\\\\\\\\\\\\\\').replace(/[$^*{}\\[\\]\\'+?.()|]/g, '\\\\\\\\$&') : value;\n}\n","import { DataQuery } from '@grafana/data';\n\nexport const getNextRefIdChar = (queries: DataQuery[]): string => {\n  for (let num = 0; ; num++) {\n    const refId = getRefId(num);\n    if (!queries.some((query) => query.refId === refId)) {\n      return refId;\n    }\n  }\n};\n\nfunction getRefId(num: number): string {\n  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n\n  if (num < letters.length) {\n    return letters[num];\n  } else {\n    return getRefId(Math.floor(num / letters.length) - 1) + letters[num % letters.length];\n  }\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Card, useStyles2 } from '@grafana/ui';\n\nimport promqlGrammar from '../promql';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { RawQuery } from './shared/RawQuery';\nimport { PromQueryPattern } from './types';\n\ntype Props = {\n  pattern: PromQueryPattern;\n  hasNewQueryOption: boolean;\n  hasPreviousQuery: boolean | string;\n  selectedPatternName: string | null;\n  setSelectedPatternName: (name: string | null) => void;\n  onPatternSelect: (pattern: PromQueryPattern, selectAsNewQuery?: boolean) => void;\n};\n\nexport const QueryPattern = (props: Props) => {\n  const { pattern, onPatternSelect, hasNewQueryOption, hasPreviousQuery, selectedPatternName, setSelectedPatternName } =\n    props;\n\n  const styles = useStyles2(getStyles);\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Card className={styles.card}>\n      <Card.Heading>{pattern.name}</Card.Heading>\n      <div className={styles.rawQueryContainer}>\n        <RawQuery\n          aria-label={`${pattern.name} raw query`}\n          query={promQueryModeller.renderQuery({\n            labels: [],\n            operations: pattern.operations,\n            binaryQueries: pattern.binaryQueries,\n          })}\n          lang={lang}\n          className={styles.rawQuery}\n        />\n      </div>\n      <Card.Actions>\n        {selectedPatternName !== pattern.name ? (\n          <Button\n            size=\"sm\"\n            aria-label=\"use this query button\"\n            onClick={() => {\n              if (hasPreviousQuery) {\n                // If user has previous query, we need to confirm that they want to apply this query pattern\n                setSelectedPatternName(pattern.name);\n              } else {\n                onPatternSelect(pattern);\n              }\n            }}\n          >\n            Use this query\n          </Button>\n        ) : (\n          <>\n            <div className={styles.spacing}>\n              {`If you would like to use this query, ${\n                hasNewQueryOption\n                  ? 'you can either apply this query pattern or create a new query'\n                  : 'this query pattern will be applied to your current query'\n              }.`}\n            </div>\n            <Button size=\"sm\" aria-label=\"back button\" fill=\"outline\" onClick={() => setSelectedPatternName(null)}>\n              Back\n            </Button>\n            <Button\n              size=\"sm\"\n              aria-label=\"apply query starter button\"\n              onClick={() => {\n                onPatternSelect(pattern);\n              }}\n            >\n              Apply query\n            </Button>\n            {hasNewQueryOption && (\n              <Button\n                size=\"sm\"\n                aria-label=\"create new query button\"\n                onClick={() => {\n                  onPatternSelect(pattern, true);\n                }}\n              >\n                Create new query\n              </Button>\n            )}\n          </>\n        )}\n      </Card.Actions>\n    </Card>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css`\n      width: 49.5%;\n      display: flex;\n      flex-direction: column;\n    `,\n    rawQueryContainer: css`\n      flex-grow: 1;\n    `,\n    rawQuery: css`\n      background-color: ${theme.colors.background.primary};\n      padding: ${theme.spacing(1)};\n      margin-top: ${theme.spacing(1)};\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { capitalize } from 'lodash';\nimport React, { useMemo, useState } from 'react';\n\nimport { CoreApp, DataQuery, GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Collapse, Modal, useStyles2 } from '@grafana/ui';\n\nimport { getNextRefIdChar } from '../gcopypaste/app/core/utils/query';\nimport { PromQuery } from '../types';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { QueryPattern } from './QueryPattern';\nimport { buildVisualQueryFromString } from './parsing';\nimport { PromQueryPattern, PromQueryPatternType } from './types';\n\ntype Props = {\n  isOpen: boolean;\n  query: PromQuery;\n  queries: DataQuery[] | undefined;\n  app?: CoreApp;\n  onClose: () => void;\n  onChange: (query: PromQuery) => void;\n  onAddQuery?: (query: PromQuery) => void;\n};\n\nexport const QueryPatternsModal = (props: Props) => {\n  const { isOpen, onClose, onChange, onAddQuery, query, queries, app } = props;\n  const [openTabs, setOpenTabs] = useState<string[]>([]);\n  const [selectedPatternName, setSelectedPatternName] = useState<string | null>(null);\n\n  const styles = useStyles2(getStyles);\n  const hasNewQueryOption = !!onAddQuery;\n  const hasPreviousQuery = useMemo(() => {\n    const visualQuery = buildVisualQueryFromString(query.expr ?? '');\n    // has anything entered in the query, metric, labels, operations, or binary queries\n    const hasOperations = visualQuery.query.operations.length > 0,\n      hasMetric = visualQuery.query.metric,\n      hasLabels = visualQuery.query.labels.length > 0,\n      hasBinaryQueries = visualQuery.query.binaryQueries ? visualQuery.query.binaryQueries.length > 0 : false;\n\n    return hasOperations || hasMetric || hasLabels || hasBinaryQueries;\n  }, [query.expr]);\n\n  const onPatternSelect = (pattern: PromQueryPattern, selectAsNewQuery = false) => {\n    const visualQuery = buildVisualQueryFromString(selectAsNewQuery ? '' : query.expr);\n    reportInteraction('grafana_prom_kickstart_your_query_selected', {\n      app: app ?? '',\n      editorMode: query.editorMode,\n      selectedPattern: pattern.name,\n      preSelectedOperationsCount: visualQuery.query.operations.length,\n      preSelectedLabelsCount: visualQuery.query.labels.length,\n      createNewQuery: hasNewQueryOption && selectAsNewQuery,\n    });\n\n    visualQuery.query.operations = pattern.operations;\n    visualQuery.query.binaryQueries = pattern.binaryQueries;\n    if (hasNewQueryOption && selectAsNewQuery) {\n      onAddQuery({\n        ...query,\n        refId: getNextRefIdChar(queries ?? [query]),\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    } else {\n      onChange({\n        ...query,\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    }\n    setSelectedPatternName(null);\n    onClose();\n  };\n\n  return (\n    <Modal aria-label=\"Kick start your query modal\" isOpen={isOpen} title=\"Kick start your query\" onDismiss={onClose}>\n      <div className={styles.spacing}>\n        Kick start your query by selecting one of these queries. You can then continue to complete your query.\n      </div>\n      {Object.values(PromQueryPatternType).map((patternType) => {\n        return (\n          <Collapse\n            aria-label={`open and close ${patternType} query starter card`}\n            key={patternType}\n            label={`${capitalize(patternType)} query starters`}\n            isOpen={openTabs.includes(patternType)}\n            collapsible={true}\n            onToggle={() =>\n              setOpenTabs((tabs) =>\n                // close tab if it's already open, otherwise open it\n                tabs.includes(patternType) ? tabs.filter((t) => t !== patternType) : [...tabs, patternType]\n              )\n            }\n          >\n            <div className={styles.cardsContainer}>\n              {promQueryModeller\n                .getQueryPatterns()\n                .filter((pattern) => pattern.type === patternType)\n                .map((pattern) => (\n                  <QueryPattern\n                    key={pattern.name}\n                    pattern={pattern}\n                    hasNewQueryOption={hasNewQueryOption}\n                    hasPreviousQuery={hasPreviousQuery}\n                    onPatternSelect={onPatternSelect}\n                    selectedPatternName={selectedPatternName}\n                    setSelectedPatternName={setSelectedPatternName}\n                  />\n                ))}\n            </div>\n          </Collapse>\n        );\n      })}\n      <Button aria-label=\"close kick start your query modal\" variant=\"secondary\" onClick={onClose}>\n        Close\n      </Button>\n    </Modal>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    cardsContainer: css`\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      justify-content: space-between;\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { useCallback, useState } from 'react';\n\nimport store from '../../gcopypaste/app/core/store';\n\nexport const promQueryEditorExplainKey = 'PrometheusQueryEditorExplainDefault';\n\nexport type QueryEditorFlags = typeof promQueryEditorExplainKey;\n\nfunction getFlagValue(key: QueryEditorFlags, defaultValue = false): boolean {\n  const val = store.get(key);\n  return val === undefined ? defaultValue : Boolean(parseInt(val, 10));\n}\n\nfunction setFlagValue(key: QueryEditorFlags, value: boolean) {\n  store.set(key, value ? '1' : '0');\n}\n\ntype UseFlagHookReturnType = { flag: boolean; setFlag: (val: boolean) => void };\n\n/**\n *\n * Use and store value of explain switch in local storage.\n * Needs to be a hook with local state to trigger re-renders.\n */\nexport function useFlag(key: QueryEditorFlags, defaultValue = false): UseFlagHookReturnType {\n  const [flag, updateFlag] = useState(getFlagValue(key, defaultValue));\n  const setter = useCallback(\n    (value: boolean) => {\n      setFlagValue(key, value);\n      updateFlag(value);\n    },\n    [key]\n  );\n\n  return { flag, setFlag: setter };\n}\n","/**\n * Shared types that can be reused by Loki and other data sources\n */\nimport { ComponentType } from 'react';\n\nimport { DataSourceApi, RegistryItem, SelectableValue, TimeRange } from '@grafana/data';\n\nexport interface QueryBuilderLabelFilter {\n  label: string;\n  op: string;\n  value: string;\n}\n\nexport interface QueryBuilderOperation {\n  id: string;\n  params: QueryBuilderOperationParamValue[];\n}\n\nexport interface QueryWithOperations {\n  operations: QueryBuilderOperation[];\n}\n\nexport interface QueryBuilderOperationDef<T = any> extends RegistryItem {\n  documentation?: string;\n  params: QueryBuilderOperationParamDef[];\n  defaultParams: QueryBuilderOperationParamValue[];\n  category: string;\n  hideFromList?: boolean;\n  alternativesKey?: string;\n  /** Can be used to control operation placement when adding a new operations, lower are placed first */\n  orderRank?: number;\n  renderer: QueryBuilderOperationRenderer;\n  addOperationHandler: QueryBuilderAddOperationHandler<T>;\n  paramChangedHandler?: QueryBuilderOnParamChangedHandler;\n  explainHandler?: QueryBuilderExplainOperationHandler;\n  changeTypeHandler?: (op: QueryBuilderOperation, newDef: QueryBuilderOperationDef<T>) => QueryBuilderOperation;\n}\n\nexport type QueryBuilderAddOperationHandler<T> = (\n  def: QueryBuilderOperationDef,\n  query: T,\n  modeller: VisualQueryModeller\n) => T;\n\nexport type QueryBuilderExplainOperationHandler = (op: QueryBuilderOperation, def?: QueryBuilderOperationDef) => string;\n\nexport type QueryBuilderOnParamChangedHandler = (\n  index: number,\n  operation: QueryBuilderOperation,\n  operationDef: QueryBuilderOperationDef\n) => QueryBuilderOperation;\n\nexport type QueryBuilderOperationRenderer = (\n  model: QueryBuilderOperation,\n  def: QueryBuilderOperationDef,\n  innerExpr: string\n) => string;\n\nexport type QueryBuilderOperationParamValue = string | number | boolean;\n\nexport interface QueryBuilderOperationParamDef {\n  name: string;\n  type: 'string' | 'number' | 'boolean';\n  options?: string[] | number[] | Array<SelectableValue<string>>;\n  hideName?: boolean;\n  restParam?: boolean;\n  optional?: boolean;\n  placeholder?: string;\n  description?: string;\n  minWidth?: number;\n  editor?: ComponentType<QueryBuilderOperationParamEditorProps>;\n  runQueryOnEnter?: boolean;\n}\n\nexport interface QueryBuilderOperationEditorProps {\n  operation: QueryBuilderOperation;\n  index: number;\n  query: any;\n  datasource: DataSourceApi;\n  queryModeller: VisualQueryModeller;\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n}\n\nexport interface QueryBuilderOperationParamEditorProps {\n  value?: QueryBuilderOperationParamValue;\n  paramDef: QueryBuilderOperationParamDef;\n  /** Parameter index */\n  index: number;\n  operation: QueryBuilderOperation;\n  operationId: string;\n  query: any;\n  datasource: DataSourceApi;\n  timeRange?: TimeRange;\n  onChange: (index: number, value: QueryBuilderOperationParamValue) => void;\n  onRunQuery: () => void;\n}\n\nexport enum QueryEditorMode {\n  Code = 'code',\n  Builder = 'builder',\n}\n\nexport interface VisualQueryModeller {\n  getOperationsForCategory(category: string): QueryBuilderOperationDef[];\n\n  getAlternativeOperations(key: string): QueryBuilderOperationDef[];\n\n  getCategories(): string[];\n\n  getOperationDef(id: string): QueryBuilderOperationDef | undefined;\n}\n","import React from 'react';\n\nimport { RadioButtonGroup } from '@grafana/ui';\n\nimport { QueryEditorMode } from './types';\n\nexport interface Props {\n  mode: QueryEditorMode;\n  onChange: (mode: QueryEditorMode) => void;\n}\n\nconst editorModes = [\n  { label: 'Builder', value: QueryEditorMode.Builder },\n  { label: 'Code', value: QueryEditorMode.Code },\n];\n\nexport function QueryEditorModeToggle({ mode, onChange }: Props) {\n  return (\n    <div data-testid={'QueryEditorModeToggle'}>\n      <RadioButtonGroup options={editorModes} size=\"sm\" value={mode} onChange={onChange} />\n    </div>\n  );\n}\n","import { css } from '@emotion/css';\nimport { uniqueId } from 'lodash';\nimport React, { HTMLProps, useRef } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Switch, useStyles2, Stack } from '@grafana/ui';\n\nexport interface Props extends Omit<HTMLProps<HTMLInputElement>, 'value' | 'ref'> {\n  value?: boolean;\n  label: string;\n}\n\nexport function QueryHeaderSwitch({ label, ...inputProps }: Props) {\n  const dashedLabel = label.replace(' ', '-');\n  const switchIdRef = useRef(uniqueId(`switch-${dashedLabel}`));\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Stack gap={1}>\n      <label htmlFor={switchIdRef.current} className={styles.switchLabel}>\n        {label}\n      </label>\n      <Switch {...inputProps} id={switchIdRef.current} />\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    switchLabel: css({\n      color: theme.colors.text.secondary,\n      cursor: 'pointer',\n      fontSize: theme.typography.bodySmall.fontSize,\n      '&:hover': {\n        color: theme.colors.text.primary,\n      },\n    }),\n  };\n};\n","import { CoreApp } from '@grafana/data';\n\nimport store from '../gcopypaste/app/core/store';\nimport { LegendFormatMode, PromQuery } from '../types';\n\nimport { QueryEditorMode } from './shared/types';\n\nconst queryEditorModeDefaultLocalStorageKey = 'PrometheusQueryEditorModeDefault';\n\nexport function changeEditorMode(query: PromQuery, editorMode: QueryEditorMode, onChange: (query: PromQuery) => void) {\n  // If empty query store new mode as default\n  if (query.expr === '') {\n    store.set(queryEditorModeDefaultLocalStorageKey, editorMode);\n  }\n\n  onChange({ ...query, editorMode });\n}\n\nfunction getDefaultEditorMode(expr: string, defaultEditor: QueryEditorMode = QueryEditorMode.Builder): QueryEditorMode {\n  // If we already have an expression default to code view\n  if (expr != null && expr !== '') {\n    return QueryEditorMode.Code;\n  }\n\n  const value: QueryEditorMode = store.get(queryEditorModeDefaultLocalStorageKey);\n  switch (value) {\n    case QueryEditorMode.Builder:\n    case QueryEditorMode.Code:\n      return value;\n    default:\n      return defaultEditor;\n  }\n}\n\n/**\n * Returns query with defaults, and boolean true/false depending on change was required\n */\nexport function getQueryWithDefaults(\n  query: PromQuery & { expr?: string },\n  app: CoreApp | undefined,\n  defaultEditor?: QueryEditorMode\n): PromQuery {\n  let result = query;\n\n  if (!query.editorMode) {\n    result = { ...query, editorMode: getDefaultEditorMode(query.expr, defaultEditor) };\n  }\n\n  // default query expr is now empty string, set in getDefaultQuery\n  // While expr is required in the types, it is not always defined at runtime, so we need to check for undefined and default to an empty string to prevent runtime errors\n  if (!query.expr) {\n    result = { ...result, expr: '', legendFormat: LegendFormatMode.Auto };\n  }\n\n  if (query.range == null && query.instant == null) {\n    // Default to range query\n    result = { ...result, range: true };\n\n    // In explore we default to both instant & range\n    if (app === CoreApp.Explore) {\n      result.instant = true;\n    }\n  }\n\n  // Unified Alerting does not support \"both\" for query type  fall back to \"range\".\n  const isBothInstantAndRange = query.instant && query.range;\n  if (app === CoreApp.UnifiedAlerting && isBothInstantAndRange) {\n    result = { ...result, instant: false, range: true };\n  }\n\n  return result;\n}\n","import { css } from '@emotion/css';\nimport {\n  autoUpdate,\n  flip,\n  offset,\n  shift,\n  useClick,\n  useDismiss,\n  useFloating,\n  useInteractions,\n} from '@floating-ui/react';\nimport React, { useState } from 'react';\n\nimport { GrafanaTheme2, renderMarkdown } from '@grafana/data';\nimport { FlexItem } from '@grafana/experimental';\nimport { Button, Portal, useStyles2 } from '@grafana/ui';\n\nimport { QueryBuilderOperation, QueryBuilderOperationDef } from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  def: QueryBuilderOperationDef;\n}\n\nexport const OperationInfoButton = React.memo<Props>(({ def, operation }) => {\n  const styles = useStyles2(getStyles);\n  const [show, setShow] = useState(false);\n\n  // the order of middleware is important!\n  const middleware = [\n    offset(16),\n    flip({\n      fallbackAxisSideDirection: 'end',\n      // see https://floating-ui.com/docs/flip#combining-with-shift\n      crossAxis: false,\n      boundary: document.body,\n    }),\n    shift(),\n  ];\n\n  const { context, refs, floatingStyles } = useFloating({\n    open: show,\n    placement: 'top',\n    onOpenChange: setShow,\n    middleware,\n    whileElementsMounted: autoUpdate,\n  });\n\n  const click = useClick(context);\n  const dismiss = useDismiss(context);\n\n  const { getReferenceProps, getFloatingProps } = useInteractions([dismiss, click]);\n\n  return (\n    <>\n      <Button\n        title=\"Click to show description\"\n        ref={refs.setReference}\n        icon=\"info-circle\"\n        size=\"sm\"\n        variant=\"secondary\"\n        fill=\"text\"\n        {...getReferenceProps()}\n      />\n      {show && (\n        <Portal>\n          <div ref={refs.setFloating} style={floatingStyles} {...getFloatingProps()} className={styles.docBox}>\n            <div className={styles.docBoxHeader}>\n              <span>{def.renderer(operation, def, '<expr>')}</span>\n              <FlexItem grow={1} />\n              <Button\n                icon=\"times\"\n                onClick={() => setShow(false)}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Remove operation\"\n              />\n            </div>\n            <div\n              className={styles.docBoxBody}\n              dangerouslySetInnerHTML={{ __html: getOperationDocs(def, operation) }}\n            ></div>\n          </div>\n        </Portal>\n      )}\n    </>\n  );\n});\n\nOperationInfoButton.displayName = 'OperationDocs';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    docBox: css({\n      overflow: 'hidden',\n      background: theme.colors.background.primary,\n      border: `1px solid ${theme.colors.border.strong}`,\n      boxShadow: theme.shadows.z3,\n      maxWidth: '600px',\n      padding: theme.spacing(1),\n      borderRadius: theme.shape.radius.default,\n      zIndex: theme.zIndex.tooltip,\n    }),\n    docBoxHeader: css({\n      fontSize: theme.typography.h5.fontSize,\n      fontFamily: theme.typography.fontFamilyMonospace,\n      paddingBottom: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    docBoxBody: css({\n      // The markdown paragraph has a marginBottom this removes it\n      marginBottom: theme.spacing(-1),\n      color: theme.colors.text.secondary,\n    }),\n  };\n};\n\nfunction getOperationDocs(def: QueryBuilderOperationDef, op: QueryBuilderOperation): string {\n  return renderMarkdown(def.explainHandler ? def.explainHandler(op, def) : def.documentation ?? 'no docs');\n}\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\nimport { DraggableProvided } from 'react-beautiful-dnd';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { FlexItem } from '@grafana/experimental';\nimport { Button, Select, useStyles2 } from '@grafana/ui';\n\nimport { OperationInfoButton } from './OperationInfoButton';\nimport { QueryBuilderOperation, QueryBuilderOperationDef, VisualQueryModeller } from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  def: QueryBuilderOperationDef;\n  index: number;\n  queryModeller: VisualQueryModeller;\n  dragHandleProps?: DraggableProvided['dragHandleProps'];\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n}\n\ninterface State {\n  isOpen?: boolean;\n  alternatives?: Array<SelectableValue<QueryBuilderOperationDef>>;\n}\n\nexport const OperationHeader = React.memo<Props>(\n  ({ operation, def, index, onChange, onRemove, queryModeller, dragHandleProps }) => {\n    const styles = useStyles2(getStyles);\n    const [state, setState] = useState<State>({});\n\n    const onToggleSwitcher = () => {\n      if (state.isOpen) {\n        setState({ ...state, isOpen: false });\n      } else {\n        const alternatives = queryModeller\n          .getAlternativeOperations(def.alternativesKey!)\n          .map((alt) => ({ label: alt.name, value: alt }));\n        setState({ isOpen: true, alternatives });\n      }\n    };\n\n    return (\n      <div className={styles.header}>\n        {!state.isOpen && (\n          <>\n            <div {...dragHandleProps}>{def.name ?? def.id}</div>\n            <FlexItem grow={1} />\n            <div className={`${styles.operationHeaderButtons} operation-header-show-on-hover`}>\n              <Button\n                icon=\"angle-down\"\n                size=\"sm\"\n                onClick={onToggleSwitcher}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Click to view alternative operations\"\n              />\n              <OperationInfoButton def={def} operation={operation} />\n              <Button\n                icon=\"times\"\n                size=\"sm\"\n                onClick={() => onRemove(index)}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Remove operation\"\n              />\n            </div>\n          </>\n        )}\n        {state.isOpen && (\n          <div className={styles.selectWrapper}>\n            <Select\n              autoFocus\n              openMenuOnFocus\n              placeholder=\"Replace with\"\n              options={state.alternatives}\n              isOpen={true}\n              onCloseMenu={onToggleSwitcher}\n              onChange={(value) => {\n                if (value.value) {\n                  // Operation should exist if it is selectable\n                  const newDef = queryModeller.getOperationDef(value.value.id)!;\n\n                  // copy default params, and override with all current params\n                  const newParams = [...newDef.defaultParams];\n                  for (let i = 0; i < Math.min(operation.params.length, newParams.length); i++) {\n                    if (newDef.params[i].type === def.params[i].type) {\n                      newParams[i] = operation.params[i];\n                    }\n                  }\n\n                  const changedOp = { ...operation, params: newParams, id: value.value.id };\n                  onChange(index, def.changeTypeHandler ? def.changeTypeHandler(changedOp, newDef) : changedOp);\n                }\n              }}\n            />\n          </div>\n        )}\n      </div>\n    );\n  }\n);\n\nOperationHeader.displayName = 'OperationHeader';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    header: css({\n      borderBottom: `1px solid ${theme.colors.border.medium}`,\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    operationHeaderButtons: css({\n      opacity: 1,\n    }),\n    selectWrapper: css({\n      paddingRight: theme.spacing(2),\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport React, { ComponentType } from 'react';\n\nimport { GrafanaTheme2, SelectableValue, toOption } from '@grafana/data';\nimport { AutoSizeInput, Button, Checkbox, Select, useStyles2, Stack } from '@grafana/ui';\n\nimport { getOperationParamId } from '../operationUtils';\n\nimport { QueryBuilderOperationParamDef, QueryBuilderOperationParamEditorProps } from './types';\n\nexport function getOperationParamEditor(\n  paramDef: QueryBuilderOperationParamDef\n): ComponentType<QueryBuilderOperationParamEditorProps> {\n  if (paramDef.editor) {\n    return paramDef.editor;\n  }\n\n  if (paramDef.options) {\n    return SelectInputParamEditor;\n  }\n\n  switch (paramDef.type) {\n    case 'boolean':\n      return BoolInputParamEditor;\n    case 'number':\n    case 'string':\n    default:\n      return SimpleInputParamEditor;\n  }\n}\n\nfunction SimpleInputParamEditor(props: QueryBuilderOperationParamEditorProps) {\n  return (\n    <AutoSizeInput\n      id={getOperationParamId(props.operationId, props.index)}\n      defaultValue={props.value?.toString()}\n      minWidth={props.paramDef.minWidth}\n      placeholder={props.paramDef.placeholder}\n      title={props.paramDef.description}\n      maxWidth={(props.paramDef.minWidth || 20) * 3}\n      onCommitChange={(evt) => {\n        props.onChange(props.index, evt.currentTarget.value);\n        if (props.paramDef.runQueryOnEnter && evt.type === 'keydown') {\n          props.onRunQuery();\n        }\n      }}\n    />\n  );\n}\n\nfunction BoolInputParamEditor(props: QueryBuilderOperationParamEditorProps) {\n  return (\n    <Checkbox\n      id={getOperationParamId(props.operationId, props.index)}\n      value={Boolean(props.value)}\n      onChange={(evt) => props.onChange(props.index, evt.currentTarget.checked)}\n    />\n  );\n}\n\nfunction SelectInputParamEditor({\n  paramDef,\n  value,\n  index,\n  operationId,\n  onChange,\n}: QueryBuilderOperationParamEditorProps) {\n  const styles = useStyles2(getStyles);\n  let selectOptions = paramDef.options as SelectableValue[];\n\n  if (!selectOptions[0]?.label) {\n    selectOptions = paramDef.options!.map((option) => ({\n      label: option.toString(),\n      value: option,\n    }));\n  }\n\n  let valueOption = selectOptions.find((x) => x.value === value) ?? toOption(value as string);\n\n  // If we have optional options param and don't have value, we want to render button with which we add optional options.\n  // This makes it easier to understand what needs to be selected and what is optional.\n  if (!value && paramDef.optional) {\n    return (\n      <div className={styles.optionalParam}>\n        <Button\n          size=\"sm\"\n          variant=\"secondary\"\n          title={`Add ${paramDef.name}`}\n          icon=\"plus\"\n          onClick={() => onChange(index, selectOptions[0].value)}\n        >\n          {paramDef.name}\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <Stack gap={0.5} direction=\"row\" alignItems=\"center\">\n      <Select\n        id={getOperationParamId(operationId, index)}\n        value={valueOption}\n        options={selectOptions}\n        placeholder={paramDef.placeholder}\n        allowCustomValue={true}\n        onChange={(value) => onChange(index, value.value!)}\n        width={paramDef.minWidth || 'auto'}\n      />\n      {paramDef.optional && (\n        <Button\n          data-testid={`operations.${index}.remove-param`}\n          size=\"sm\"\n          fill=\"text\"\n          icon=\"times\"\n          variant=\"secondary\"\n          title={`Remove ${paramDef.name}`}\n          onClick={() => onChange(index, '')}\n        />\n      )}\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    optionalParam: css({\n      marginTop: theme.spacing(1),\n    }),\n  };\n};\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useId, useState } from 'react';\nimport { Draggable } from 'react-beautiful-dnd';\n\nimport { DataSourceApi, GrafanaTheme2, TimeRange } from '@grafana/data';\nimport { Button, Icon, Stack, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { getOperationParamId } from '../operationUtils';\n\nimport { OperationHeader } from './OperationHeader';\nimport { getOperationParamEditor } from './OperationParamEditor';\nimport {\n  QueryBuilderOperation,\n  QueryBuilderOperationDef,\n  QueryBuilderOperationParamDef,\n  QueryBuilderOperationParamValue,\n  VisualQueryModeller,\n} from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  index: number;\n  query: any;\n  datasource: DataSourceApi;\n  queryModeller: VisualQueryModeller;\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  flash?: boolean;\n  highlight?: boolean;\n  timeRange?: TimeRange;\n}\n\nexport function OperationEditor({\n  operation,\n  index,\n  onRemove,\n  onChange,\n  onRunQuery,\n  queryModeller,\n  query,\n  datasource,\n  flash,\n  highlight,\n  timeRange,\n}: Props) {\n  const styles = useStyles2(getStyles);\n  const def = queryModeller.getOperationDef(operation.id);\n  const shouldFlash = useFlash(flash);\n  const id = useId();\n\n  if (!def) {\n    return <span>Operation {operation.id} not found</span>;\n  }\n\n  const onParamValueChanged = (paramIdx: number, value: QueryBuilderOperationParamValue) => {\n    const update: QueryBuilderOperation = { ...operation, params: [...operation.params] };\n    update.params[paramIdx] = value;\n    callParamChangedThenOnChange(def, update, index, paramIdx, onChange);\n  };\n\n  const onAddRestParam = () => {\n    const update: QueryBuilderOperation = { ...operation, params: [...operation.params, ''] };\n    callParamChangedThenOnChange(def, update, index, operation.params.length, onChange);\n  };\n\n  const onRemoveRestParam = (paramIdx: number) => {\n    const update: QueryBuilderOperation = {\n      ...operation,\n      params: [...operation.params.slice(0, paramIdx), ...operation.params.slice(paramIdx + 1)],\n    };\n    callParamChangedThenOnChange(def, update, index, paramIdx, onChange);\n  };\n\n  const operationElements: React.ReactNode[] = [];\n\n  for (let paramIndex = 0; paramIndex < operation.params.length; paramIndex++) {\n    const paramDef = def.params[Math.min(def.params.length - 1, paramIndex)];\n    const Editor = getOperationParamEditor(paramDef);\n\n    operationElements.push(\n      <div className={styles.paramRow} key={`${paramIndex}-1`}>\n        {!paramDef.hideName && (\n          <div className={styles.paramName}>\n            <label htmlFor={getOperationParamId(id, paramIndex)}>{paramDef.name}</label>\n            {paramDef.description && (\n              <Tooltip placement=\"top\" content={paramDef.description} theme=\"info\">\n                <Icon name=\"info-circle\" size=\"sm\" className={styles.infoIcon} />\n              </Tooltip>\n            )}\n          </div>\n        )}\n        <div className={styles.paramValue}>\n          <Stack gap={0.5} direction=\"row\" alignItems=\"center\">\n            <Editor\n              index={paramIndex}\n              paramDef={paramDef}\n              value={operation.params[paramIndex]}\n              operation={operation}\n              operationId={id}\n              onChange={onParamValueChanged}\n              onRunQuery={onRunQuery}\n              query={query}\n              datasource={datasource}\n              timeRange={timeRange}\n            />\n            {paramDef.restParam && (operation.params.length > def.params.length || paramDef.optional) && (\n              <Button\n                data-testid={`operations.${index}.remove-rest-param`}\n                size=\"sm\"\n                fill=\"text\"\n                icon=\"times\"\n                variant=\"secondary\"\n                title={`Remove ${paramDef.name}`}\n                onClick={() => onRemoveRestParam(paramIndex)}\n              />\n            )}\n          </Stack>\n        </div>\n      </div>\n    );\n  }\n\n  // Handle adding button for rest params\n  let restParam: React.ReactNode | undefined;\n  if (def.params.length > 0) {\n    const lastParamDef = def.params[def.params.length - 1];\n    if (lastParamDef.restParam) {\n      restParam = renderAddRestParamButton(lastParamDef, onAddRestParam, index, operation.params.length, styles);\n    }\n  }\n\n  return (\n    <Draggable draggableId={`operation-${index}`} index={index}>\n      {(provided) => (\n        <div\n          className={cx(styles.card, (shouldFlash || highlight) && styles.cardHighlight)}\n          ref={provided.innerRef}\n          {...provided.draggableProps}\n          data-testid={`operations.${index}.wrapper`}\n        >\n          <OperationHeader\n            operation={operation}\n            dragHandleProps={provided.dragHandleProps}\n            def={def}\n            index={index}\n            onChange={onChange}\n            onRemove={onRemove}\n            queryModeller={queryModeller}\n          />\n          <div className={styles.body}>{operationElements}</div>\n          {restParam}\n          {index < query.operations.length - 1 && (\n            <div className={styles.arrow}>\n              <div className={styles.arrowLine} />\n              <div className={styles.arrowArrow} />\n            </div>\n          )}\n        </div>\n      )}\n    </Draggable>\n  );\n}\n\n/**\n * When flash is switched on makes sure it is switched of right away, so we just flash the highlight and then fade\n * out.\n * @param flash\n */\nfunction useFlash(flash?: boolean) {\n  const [keepFlash, setKeepFlash] = useState(true);\n  useEffect(() => {\n    let t: ReturnType<typeof setTimeout>;\n    if (flash) {\n      t = setTimeout(() => {\n        setKeepFlash(false);\n      }, 1000);\n    } else {\n      setKeepFlash(true);\n    }\n\n    return () => clearTimeout(t);\n  }, [flash]);\n\n  return keepFlash && flash;\n}\n\nfunction renderAddRestParamButton(\n  paramDef: QueryBuilderOperationParamDef,\n  onAddRestParam: () => void,\n  operationIndex: number,\n  paramIndex: number,\n  styles: OperationEditorStyles\n) {\n  return (\n    <div className={styles.restParam} key={`${paramIndex}-2`}>\n      <Button\n        size=\"sm\"\n        icon=\"plus\"\n        title={`Add ${paramDef.name}`.trimEnd()}\n        variant=\"secondary\"\n        onClick={onAddRestParam}\n        data-testid={`operations.${operationIndex}.add-rest-param`}\n      >\n        {paramDef.name}\n      </Button>\n    </div>\n  );\n}\n\nfunction callParamChangedThenOnChange(\n  def: QueryBuilderOperationDef,\n  operation: QueryBuilderOperation,\n  operationIndex: number,\n  paramIndex: number,\n  onChange: (index: number, update: QueryBuilderOperation) => void\n) {\n  if (def.paramChangedHandler) {\n    onChange(operationIndex, def.paramChangedHandler(paramIndex, operation, def));\n  } else {\n    onChange(operationIndex, operation);\n  }\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    cardWrapper: css({\n      alignItems: 'stretch',\n    }),\n    error: css({\n      marginBottom: theme.spacing(1),\n    }),\n    card: css({\n      background: theme.colors.background.primary,\n      border: `1px solid ${theme.colors.border.medium}`,\n      cursor: 'grab',\n      borderRadius: theme.shape.radius.default,\n      marginBottom: theme.spacing(1),\n      position: 'relative',\n      transition: 'all 0.5s ease-in 0s',\n      height: '100%',\n    }),\n    cardError: css({\n      boxShadow: `0px 0px 4px 0px ${theme.colors.warning.main}`,\n      border: `1px solid ${theme.colors.warning.main}`,\n    }),\n    cardHighlight: css({\n      boxShadow: `0px 0px 4px 0px ${theme.colors.primary.border}`,\n      border: `1px solid ${theme.colors.primary.border}`,\n    }),\n    infoIcon: css({\n      marginLeft: theme.spacing(0.5),\n      color: theme.colors.text.secondary,\n      ':hover': {\n        color: theme.colors.text.primary,\n      },\n    }),\n    body: css({\n      margin: theme.spacing(1, 1, 0.5, 1),\n      display: 'table',\n    }),\n    paramRow: css({\n      label: 'paramRow',\n      display: 'table-row',\n      verticalAlign: 'middle',\n    }),\n    paramName: css({\n      display: 'table-cell',\n      padding: theme.spacing(0, 1, 0, 0),\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      verticalAlign: 'middle',\n      height: '32px',\n    }),\n    paramValue: css({\n      label: 'paramValue',\n      display: 'table-cell',\n      verticalAlign: 'middle',\n    }),\n    restParam: css({\n      padding: theme.spacing(0, 1, 1, 1),\n    }),\n    arrow: css({\n      position: 'absolute',\n      top: '0',\n      right: '-18px',\n      display: 'flex',\n    }),\n    arrowLine: css({\n      height: '2px',\n      width: '8px',\n      backgroundColor: theme.colors.border.strong,\n      position: 'relative',\n      top: '14px',\n    }),\n    arrowArrow: css({\n      width: 0,\n      height: 0,\n      borderTop: `5px solid transparent`,\n      borderBottom: `5px solid transparent`,\n      borderLeft: `7px solid ${theme.colors.border.strong}`,\n      position: 'relative',\n      top: '10px',\n    }),\n  };\n};\n\ntype OperationEditorStyles = ReturnType<typeof getStyles>;\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\nimport { DragDropContext, Droppable, DropResult } from 'react-beautiful-dnd';\nimport { useMountedState, usePrevious } from 'react-use';\n\nimport { DataSourceApi, GrafanaTheme2, TimeRange } from '@grafana/data';\nimport { Button, Cascader, CascaderOption, useStyles2, Stack } from '@grafana/ui';\n\nimport { OperationEditor } from './OperationEditor';\nimport { QueryBuilderOperation, QueryWithOperations, VisualQueryModeller } from './types';\n\nexport interface Props<T extends QueryWithOperations> {\n  query: T;\n  datasource: DataSourceApi;\n  onChange: (query: T) => void;\n  onRunQuery: () => void;\n  queryModeller: VisualQueryModeller;\n  explainMode?: boolean;\n  highlightedOp?: QueryBuilderOperation;\n  timeRange?: TimeRange;\n}\n\nexport function OperationList<T extends QueryWithOperations>({\n  query,\n  datasource,\n  queryModeller,\n  onChange,\n  onRunQuery,\n  highlightedOp,\n  timeRange,\n}: Props<T>) {\n  const styles = useStyles2(getStyles);\n  const { operations } = query;\n\n  const opsToHighlight = useOperationsHighlight(operations);\n\n  const [cascaderOpen, setCascaderOpen] = useState(false);\n\n  const onOperationChange = (index: number, update: QueryBuilderOperation) => {\n    const updatedList = [...operations];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...operations.slice(0, index), ...operations.slice(index + 1)];\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const addOptions: CascaderOption[] = queryModeller.getCategories().map((category) => {\n    return {\n      value: category,\n      label: category,\n      items: queryModeller.getOperationsForCategory(category).map((operation) => ({\n        value: operation.id,\n        label: operation.name,\n        isLeaf: true,\n      })),\n    };\n  });\n\n  const onAddOperation = (value: string) => {\n    const operationDef = queryModeller.getOperationDef(value);\n    if (!operationDef) {\n      return;\n    }\n    onChange(operationDef.addOperationHandler(operationDef, query, queryModeller));\n    setCascaderOpen(false);\n  };\n\n  const onDragEnd = (result: DropResult) => {\n    if (!result.destination) {\n      return;\n    }\n\n    const updatedList = [...operations];\n    const element = updatedList[result.source.index];\n    updatedList.splice(result.source.index, 1);\n    updatedList.splice(result.destination.index, 0, element);\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const onCascaderBlur = () => {\n    setCascaderOpen(false);\n  };\n\n  return (\n    <Stack gap={1} direction=\"column\">\n      <Stack gap={1}>\n        {operations.length > 0 && (\n          <DragDropContext onDragEnd={onDragEnd}>\n            <Droppable droppableId=\"sortable-field-mappings\" direction=\"horizontal\">\n              {(provided) => (\n                <div className={styles.operationList} ref={provided.innerRef} {...provided.droppableProps}>\n                  {operations.map((op, index) => {\n                    return (\n                      <OperationEditor\n                        key={op.id + JSON.stringify(op.params) + index}\n                        queryModeller={queryModeller}\n                        index={index}\n                        operation={op}\n                        query={query}\n                        datasource={datasource}\n                        onChange={onOperationChange}\n                        onRemove={onRemove}\n                        onRunQuery={onRunQuery}\n                        flash={opsToHighlight[index]}\n                        highlight={highlightedOp === op}\n                        timeRange={timeRange}\n                      />\n                    );\n                  })}\n                  {provided.placeholder}\n                </div>\n              )}\n            </Droppable>\n          </DragDropContext>\n        )}\n        <div className={styles.addButton}>\n          {cascaderOpen ? (\n            <Cascader\n              options={addOptions}\n              onSelect={onAddOperation}\n              onBlur={onCascaderBlur}\n              autoFocus={true}\n              alwaysOpen={true}\n              hideActiveLevelLabel={true}\n              placeholder={'Search'}\n            />\n          ) : (\n            <Button icon={'plus'} variant={'secondary'} onClick={() => setCascaderOpen(true)} title={'Add operation'}>\n              Operations\n            </Button>\n          )}\n        </div>\n      </Stack>\n    </Stack>\n  );\n}\n\n/**\n * Returns indexes of operations that should be highlighted. We check the diff of operations added but at the same time\n * we want to highlight operations only after the initial render, so we check for mounted state and calculate the diff\n * only after.\n * @param operations\n */\nfunction useOperationsHighlight(operations: QueryBuilderOperation[]) {\n  const isMounted = useMountedState();\n  const prevOperations = usePrevious(operations);\n\n  if (!isMounted()) {\n    return operations.map(() => false);\n  }\n\n  if (!prevOperations) {\n    return operations.map(() => true);\n  }\n\n  let newOps: boolean[] = [];\n\n  if (prevOperations.length - 1 === operations.length && operations.every((op) => prevOperations.includes(op))) {\n    // In case we remove one op and does not change any ops then don't highlight anything.\n    return operations.map(() => false);\n  }\n  if (prevOperations.length + 1 === operations.length && prevOperations.every((op) => operations.includes(op))) {\n    // If we add a single op just find it and highlight just that.\n    const newOp = operations.find((op) => !prevOperations.includes(op));\n    newOps = operations.map((op) => {\n      return op === newOp;\n    });\n  } else {\n    // Default diff of all ops.\n    newOps = operations.map((op, index) => {\n      return !isSameOp(op.id, prevOperations[index]?.id);\n    });\n  }\n  return newOps;\n}\n\nfunction isSameOp(op1?: string, op2?: string) {\n  return op1 === op2 || `__${op1}_by` === op2 || op1 === `__${op2}_by`;\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    heading: css({\n      label: 'heading',\n      fontSize: 12,\n      fontWeight: theme.typography.fontWeightMedium,\n      marginBottom: 0,\n    }),\n    operationList: css({\n      label: 'operationList',\n      display: 'flex',\n      flexWrap: 'wrap',\n      gap: theme.spacing(2),\n    }),\n    addButton: css({\n      label: 'addButton',\n      width: 126,\n      paddingBottom: theme.spacing(1),\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useStyles2, Stack } from '@grafana/ui';\n\ninterface Props {\n  children: React.ReactNode;\n}\n\nexport function OperationsEditorRow({ children }: Props) {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.root}>\n      <Stack gap={1}>{children}</Stack>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    root: css({\n      padding: theme.spacing(1, 1, 0, 1),\n      backgroundColor: theme.colors.background.secondary,\n      borderRadius: theme.shape.radius.default,\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\n\nimport { GrafanaTheme2, PanelData, QueryHint } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\n\nimport { LokiAndPromQueryModellerBase, PromLokiVisualQuery } from './LokiAndPromQueryModellerBase';\n\nexport interface Props<T extends PromLokiVisualQuery> {\n  query: T;\n  datasource: PrometheusDatasource;\n  queryModeller: LokiAndPromQueryModellerBase;\n  buildVisualQueryFromString: (expr: string) => { query: T };\n  onChange: (update: T) => void;\n  data?: PanelData;\n}\n\nexport const QueryBuilderHints = <T extends PromLokiVisualQuery>({\n  datasource,\n  query: visualQuery,\n  onChange,\n  data,\n  queryModeller,\n  buildVisualQueryFromString,\n}: Props<T>) => {\n  const [hints, setHints] = useState<QueryHint[]>([]);\n  const styles = useStyles2(getStyles);\n\n  useEffect(() => {\n    const query = { expr: queryModeller.renderQuery(visualQuery), refId: '' };\n    // For now show only actionable hints\n    const hints = datasource.getQueryHints(query, data?.series || []).filter((hint) => hint.fix?.action);\n    setHints(hints);\n  }, [datasource, visualQuery, data, queryModeller]);\n\n  return (\n    <>\n      {hints.length > 0 && (\n        <div className={styles.container}>\n          {hints.map((hint) => {\n            return (\n              <Tooltip content={`${hint.label} ${hint.fix?.label}`} key={hint.type}>\n                <Button\n                  onClick={() => {\n                    reportInteraction('grafana_query_builder_hints_clicked', {\n                      hint: hint.type,\n                      datasourceType: datasource.type,\n                    });\n\n                    if (hint?.fix?.action) {\n                      const query = { expr: queryModeller.renderQuery(visualQuery), refId: '' };\n                      const newQuery = datasource.modifyQuery(query, hint.fix.action);\n                      const newVisualQuery = buildVisualQueryFromString(newQuery.expr);\n                      return onChange(newVisualQuery.query);\n                    }\n                  }}\n                  fill=\"outline\"\n                  size=\"sm\"\n                  className={styles.hint}\n                >\n                  hint: {hint.fix?.title || hint.fix?.action?.type.toLowerCase().replace('_', ' ')}\n                </Button>\n              </Tooltip>\n            );\n          })}\n        </div>\n      )}\n    </>\n  );\n};\n\nQueryBuilderHints.displayName = 'QueryBuilderHints';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    container: css`\n      display: flex;\n      align-items: start;\n    `,\n    hint: css`\n      margin-right: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, toOption } from '@grafana/data';\nimport { EditorRows, FlexItem } from '@grafana/experimental';\nimport { AutoSizeInput, IconButton, Select, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { binaryScalarDefs } from '../binaryScalarOperations';\nimport { PromVisualQueryBinary } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\n\nexport interface NestedQueryProps {\n  nestedQuery: PromVisualQueryBinary;\n  datasource: PrometheusDatasource;\n  index: number;\n  onChange: (index: number, update: PromVisualQueryBinary) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport const NestedQuery = React.memo<NestedQueryProps>((props) => {\n  const { nestedQuery, index, datasource, onChange, onRemove, onRunQuery, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.card}>\n      <div className={styles.header}>\n        <div className={styles.name}>Operator</div>\n        <Select\n          width=\"auto\"\n          options={operators}\n          value={toOption(nestedQuery.operator)}\n          onChange={(value) => {\n            onChange(index, {\n              ...nestedQuery,\n              operator: value.value!,\n            });\n          }}\n        />\n        <div className={styles.name}>Vector matches</div>\n        <div className={styles.vectorMatchWrapper}>\n          <Select<PromVisualQueryBinary['vectorMatchesType']>\n            width=\"auto\"\n            value={nestedQuery.vectorMatchesType || 'on'}\n            allowCustomValue\n            options={[\n              { value: 'on', label: 'on' },\n              { value: 'ignoring', label: 'ignoring' },\n            ]}\n            onChange={(val) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatchesType: val.value,\n              });\n            }}\n          />\n          <AutoSizeInput\n            className={styles.vectorMatchInput}\n            minWidth={20}\n            defaultValue={nestedQuery.vectorMatches}\n            onCommitChange={(evt) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatches: evt.currentTarget.value,\n                vectorMatchesType: nestedQuery.vectorMatchesType || 'on',\n              });\n            }}\n          />\n        </div>\n        <FlexItem grow={1} />\n        <IconButton name=\"times\" size=\"sm\" onClick={() => onRemove(index)} tooltip=\"Remove match\" />\n      </div>\n      <div className={styles.body}>\n        <EditorRows>\n          <PromQueryBuilder\n            showExplain={showExplain}\n            query={nestedQuery.query}\n            datasource={datasource}\n            onRunQuery={onRunQuery}\n            onChange={(update) => {\n              onChange(index, { ...nestedQuery, query: update });\n            }}\n          />\n        </EditorRows>\n      </div>\n    </div>\n  );\n});\n\nconst operators = binaryScalarDefs.map((def) => ({ label: def.sign, value: def.sign }));\n\nNestedQuery.displayName = 'NestedQuery';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css({\n      label: 'card',\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(0.5),\n    }),\n    header: css({\n      label: 'header',\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      gap: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    name: css({\n      label: 'name',\n      whiteSpace: 'nowrap',\n    }),\n    body: css({\n      label: 'body',\n      paddingLeft: theme.spacing(2),\n    }),\n    vectorMatchInput: css({\n      label: 'vectorMatchInput',\n      marginLeft: -1,\n    }),\n    vectorMatchWrapper: css({\n      label: 'vectorMatchWrapper',\n      display: 'flex',\n    }),\n  };\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromVisualQuery, PromVisualQueryBinary } from '../types';\n\nimport { NestedQuery } from './NestedQuery';\n\nexport interface NestedQueryListProps {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (query: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport function NestedQueryList(props: NestedQueryListProps) {\n  const { query, datasource, onChange, onRunQuery, showExplain } = props;\n  const nestedQueries = query.binaryQueries ?? [];\n\n  const onNestedQueryUpdate = (index: number, update: PromVisualQueryBinary) => {\n    const updatedList = [...nestedQueries];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...nestedQueries.slice(0, index), ...nestedQueries.slice(index + 1)];\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  return (\n    <Stack direction=\"column\" gap={1}>\n      {nestedQueries.map((nestedQuery, index) => (\n        <NestedQuery\n          key={index.toString()}\n          nestedQuery={nestedQuery}\n          index={index}\n          onChange={onNestedQueryUpdate}\n          datasource={datasource}\n          onRemove={onRemove}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      ))}\n    </Stack>\n  );\n}\n","import { cx } from '@emotion/css';\nimport React, { FormEvent, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, RadioButtonList, Spinner, TextArea, Toggletip, useTheme2 } from '@grafana/ui';\n\nimport { buildVisualQueryFromString } from '../../parsing';\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles } from './PromQail';\nimport { QuerySuggestion } from './types';\n\nexport type Props = {\n  querySuggestion: QuerySuggestion;\n  order: number;\n  queryExplain: (idx: number) => void;\n  historical: boolean;\n  onChange: (query: PromVisualQuery) => void;\n  closeDrawer: () => void;\n  last: boolean;\n  prompt: string;\n  allSuggestions: string | undefined;\n};\n\nconst suggestionOptions: SelectableValue[] = [\n  { label: 'Yes', value: 'yes' },\n  { label: 'No', value: 'no' },\n];\nconst explationOptions: SelectableValue[] = [\n  { label: 'Too vague', value: 'too vague' },\n  { label: 'Too technical', value: 'too technical' },\n  { label: 'Inaccurate', value: 'inaccurate' },\n  { label: 'Other', value: 'other' },\n];\n\nexport function QuerySuggestionItem(props: Props) {\n  const { querySuggestion, order, queryExplain, historical, onChange, closeDrawer, last, allSuggestions, prompt } =\n    props;\n  const [showExp, updShowExp] = useState<boolean>(false);\n\n  const [gaveExplanationFeedback, updateGaveExplanationFeedback] = useState<boolean>(false);\n  const [gaveSuggestionFeedback, updateGaveSuggestionFeedback] = useState<boolean>(false);\n\n  const [suggestionFeedback, setSuggestionFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const [explanationFeedback, setExplanationFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const { query, explanation } = querySuggestion;\n\n  const feedbackToggleTip = (type: string) => {\n    const updateRadioFeedback = (value: string) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          radioInput: value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          radioInput: value,\n        });\n      }\n    };\n\n    const updateTextFeedback = (e: FormEvent<HTMLTextAreaElement>) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          text: e.currentTarget.value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          text: e.currentTarget.value,\n        });\n      }\n    };\n\n    const disabledButton = () =>\n      type === 'explanation' ? !explanationFeedback.radioInput : !suggestionFeedback.radioInput;\n\n    const questionOne =\n      type === 'explanation' ? 'Why was the explanation not helpful?' : 'Were the query suggestions helpful?';\n\n    return (\n      <div className={styles.suggestionFeedback}>\n        <div>\n          <div className={styles.feedbackQuestion}>\n            <h6>{questionOne}</h6>\n            <i>(Required)</i>\n          </div>\n          <RadioButtonList\n            name=\"default\"\n            options={type === 'explanation' ? explationOptions : suggestionOptions}\n            value={type === 'explanation' ? explanationFeedback.radioInput : suggestionFeedback.radioInput}\n            onChange={updateRadioFeedback}\n          />\n        </div>\n        <div className={cx(type === 'explanation' && styles.explationTextInput)}>\n          {type !== 'explanation' && (\n            <div className={styles.feedbackQuestion}>\n              <h6>How can we improve the query suggestions?</h6>\n            </div>\n          )}\n          <TextArea\n            type=\"text\"\n            aria-label=\"Promqail suggestion text\"\n            placeholder=\"Enter your feedback\"\n            value={type === 'explanation' ? explanationFeedback.text : suggestionFeedback.text}\n            onChange={updateTextFeedback}\n            cols={100}\n          />\n        </div>\n\n        <div className={styles.submitFeedback}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            disabled={disabledButton()}\n            onClick={() => {\n              // submit the rudderstack event\n              if (type === 'explanation') {\n                explanationFeedbackEvent(\n                  explanationFeedback.radioInput,\n                  explanationFeedback.text,\n                  querySuggestion,\n                  historical,\n                  prompt\n                );\n                updateGaveExplanationFeedback(true);\n              } else {\n                suggestionFeedbackEvent(\n                  suggestionFeedback.radioInput,\n                  suggestionFeedback.text,\n                  allSuggestions ?? '',\n                  historical,\n                  prompt\n                );\n                updateGaveSuggestionFeedback(true);\n              }\n            }}\n          >\n            Submit\n          </Button>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <>\n      <div className={styles.querySuggestion}>\n        <div title={query} className={cx(styles.codeText, styles.longCode)}>\n          {`${order}.  ${query}`}\n        </div>\n        <div className={styles.useButton}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            onClick={() => {\n              reportInteraction('grafana_prometheus_promqail_use_query_button_clicked', {\n                query: querySuggestion.query,\n              });\n              const pvq = buildVisualQueryFromString(querySuggestion.query);\n              // check for errors!\n              onChange(pvq.query);\n              closeDrawer();\n            }}\n          >\n            Use\n          </Button>\n        </div>\n      </div>\n      <div>\n        <Button\n          fill=\"text\"\n          variant=\"secondary\"\n          icon={showExp ? 'angle-up' : 'angle-down'}\n          onClick={() => {\n            updShowExp(!showExp);\n            queryExplain(order - 1);\n          }}\n          className={cx(styles.bodySmall)}\n          size=\"sm\"\n        >\n          Explainer\n        </Button>\n        {!showExp && order !== 5 && <div className={styles.textPadding}></div>}\n\n        {showExp && !querySuggestion.explanation && (\n          <div className={styles.center}>\n            <Spinner />\n          </div>\n        )}\n        {showExp && querySuggestion.explanation && (\n          <>\n            <div className={cx(styles.bodySmall, styles.explainPadding)}>\n              <div className={styles.textPadding}>This query is trying to answer the question:</div>\n              <div className={styles.textPadding}>{explanation}</div>\n              <div className={styles.textPadding}>\n                Learn more with this{' '}\n                <a\n                  className={styles.doc}\n                  href={'https://prometheus.io/docs/prometheus/latest/querying/examples/#query-examples'}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                >\n                  Prometheus doc\n                </a>\n              </div>\n\n              <div className={cx(styles.rightButtons, styles.secondaryText)}>\n                Was this explanation helpful?\n                <div className={styles.floatRight}>\n                  {!gaveExplanationFeedback ? (\n                    <>\n                      <Button\n                        fill=\"outline\"\n                        variant=\"secondary\"\n                        size=\"sm\"\n                        className={styles.leftButton}\n                        onClick={() => {\n                          explanationFeedbackEvent('Yes', '', querySuggestion, historical, prompt);\n                          updateGaveExplanationFeedback(true);\n                        }}\n                      >\n                        Yes\n                      </Button>\n                      <Toggletip\n                        aria-label=\"Suggestion feedback\"\n                        content={feedbackToggleTip('explanation')}\n                        placement=\"bottom-end\"\n                        closeButton={true}\n                      >\n                        <Button variant=\"success\" size=\"sm\">\n                          No\n                        </Button>\n                      </Toggletip>\n                    </>\n                  ) : (\n                    'Thank you for your feedback!'\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {!last && <hr />}\n          </>\n        )}\n        {last && (\n          <div className={cx(styles.feedbackStyle)}>\n            {!gaveSuggestionFeedback ? (\n              <Toggletip\n                aria-label=\"Suggestion feedback\"\n                content={feedbackToggleTip('suggestion')}\n                placement=\"bottom-end\"\n                closeButton={true}\n              >\n                <Button fill=\"outline\" variant=\"secondary\" size=\"sm\">\n                  Give feedback on suggestions\n                </Button>\n              </Toggletip>\n            ) : (\n              // do this weird thing because the toggle tip doesn't allow an extra close function\n              <Button fill=\"outline\" variant=\"secondary\" size=\"sm\" disabled={true}>\n                Thank you for your feedback!\n              </Button>\n            )}\n          </div>\n        )}\n      </div>\n    </>\n  );\n}\n\nfunction explanationFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  querySuggestion: QuerySuggestion,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_explanation_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    query: querySuggestion.query,\n    explanation: querySuggestion.explanation,\n    prompt: prompt,\n  });\n}\n\nfunction suggestionFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  allSuggestions: string,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_suggestion_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    allSuggestions: allSuggestions,\n    prompt: prompt,\n  });\n}\n","export type QuerySuggestion = {\n  query: string;\n  explanation: string;\n};\n\nexport enum SuggestionType {\n  Historical = 'historical',\n  AI = 'AI',\n}\n\nexport type Interaction = {\n  prompt: string;\n  suggestionType: SuggestionType;\n  suggestions: QuerySuggestion[];\n  isLoading: boolean;\n  explanationIsLoading: boolean;\n};\n","import { cx } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { Button, useTheme2 } from '@grafana/ui';\n\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles, queryAssistanttestIds } from './PromQail';\nimport { QuerySuggestionItem } from './QuerySuggestionItem';\nimport { QuerySuggestion, SuggestionType } from './types';\n\nexport type Props = {\n  querySuggestions: QuerySuggestion[];\n  suggestionType: SuggestionType;\n  closeDrawer: () => void;\n  nextInteraction: () => void;\n  queryExplain: (idx: number) => void;\n  onChange: (query: PromVisualQuery) => void;\n  prompt: string;\n};\n\nexport function QuerySuggestionContainer(props: Props) {\n  const { suggestionType, querySuggestions, closeDrawer, nextInteraction, queryExplain, onChange, prompt } = props;\n\n  const [hasNextInteraction, updateHasNextInteraction] = useState<boolean>(false);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  let text, secondaryText, refineText;\n\n  if (suggestionType === SuggestionType.Historical) {\n    text = `Here are ${querySuggestions.length} query suggestions:`;\n    refineText = 'I want to write a prompt';\n  } else if (suggestionType === SuggestionType.AI) {\n    text = text = 'Here is your query suggestion:';\n    secondaryText =\n      'This query is based off of natural language descriptions of the most commonly used PromQL queries.';\n    refineText = 'Refine prompt';\n  }\n\n  return (\n    <>\n      {suggestionType === SuggestionType.Historical ? (\n        <div className={styles.bottomMargin}>{text}</div>\n      ) : (\n        <>\n          <div className={styles.textPadding}>{text}</div>\n          <div className={cx(styles.secondaryText, styles.bottomMargin)}>{secondaryText}</div>\n        </>\n      )}\n\n      <div className={styles.infoContainerWrapper}>\n        <div className={styles.infoContainer}>\n          {querySuggestions.map((qs: QuerySuggestion, idx: number) => {\n            return (\n              <QuerySuggestionItem\n                historical={suggestionType === SuggestionType.Historical}\n                querySuggestion={qs}\n                key={idx}\n                order={idx + 1}\n                queryExplain={queryExplain}\n                onChange={onChange}\n                closeDrawer={closeDrawer}\n                last={idx === querySuggestions.length - 1}\n                // for feedback rudderstack events\n                allSuggestions={querySuggestions.reduce((acc: string, qs: QuerySuggestion) => {\n                  return acc + '$$' + qs.query;\n                }, '')}\n                prompt={prompt ?? ''}\n              />\n            );\n          })}\n        </div>\n      </div>\n      {!hasNextInteraction && (\n        <div className={styles.nextInteractionHeight}>\n          <div className={cx(styles.afterButtons, styles.textPadding)}>\n            <Button\n              onClick={() => {\n                updateHasNextInteraction(true);\n                nextInteraction();\n              }}\n              data-testid={queryAssistanttestIds.refinePrompt}\n              fill=\"outline\"\n              variant=\"secondary\"\n              size=\"md\"\n            >\n              {refineText}\n            </Button>\n          </div>\n          <div className={cx(styles.textPadding, styles.floatRight)}>\n            <Button fill=\"outline\" variant=\"secondary\" size=\"md\" onClick={closeDrawer}>\n              Cancel\n            </Button>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","import { getBackendSrv, logDebug } from '@grafana/runtime';\nimport { LLM_PLUGIN_ROUTE, setLLMPluginVersion } from './constants.js';\n\nasync function search(request) {\n  const response = await getBackendSrv().post(\n    \"/api/plugins/grafana-llm-app/resources/vector/search\",\n    request,\n    {\n      headers: { \"Content-Type\": \"application/json\" }\n    }\n  );\n  return response.results;\n}\nlet loggedWarning = false;\nconst health = async () => {\n  try {\n    const settings = await getBackendSrv().get(`${LLM_PLUGIN_ROUTE}/settings`, void 0, void 0, {\n      showSuccessAlert: false,\n      showErrorAlert: false\n    });\n    if (!settings.enabled) {\n      return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not enabled.\" };\n    }\n  } catch (e) {\n    logDebug(String(e));\n    logDebug(\n      \"Failed to check if the vector service is enabled. This is expected if the Grafana LLM plugin is not installed, and the above error can be ignored.\"\n    );\n    loggedWarning = true;\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not installed.\" };\n  }\n  let response;\n  try {\n    response = await getBackendSrv().get(`${LLM_PLUGIN_ROUTE}/health`, void 0, void 0, {\n      showSuccessAlert: false,\n      showErrorAlert: false\n    });\n  } catch (e) {\n    if (!loggedWarning) {\n      logDebug(String(e));\n      logDebug(\n        \"Failed to check if vector service is enabled. This is expected if the Grafana LLM plugin is not installed, and the above error can be ignored.\"\n      );\n      loggedWarning = true;\n    }\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is not installed.\" };\n  }\n  const { details } = response;\n  if ((details == null ? void 0 : details.version) !== void 0) {\n    setLLMPluginVersion(details.version);\n  }\n  if ((details == null ? void 0 : details.vector) === void 0) {\n    return { enabled: false, ok: false, error: \"The Grafana LLM plugin is outdated; please update it.\" };\n  }\n  return typeof details.vector === \"boolean\" ? { enabled: details.vector, ok: details.vector } : details.vector;\n};\nconst enabled = async () => {\n  const healthDetails = await health();\n  return healthDetails.enabled && healthDetails.ok;\n};\n\nexport { enabled, health, search };\n//# sourceMappingURL=vector.js.map\n","export const ExplainSystemPrompt = `You are an expert in Prometheus, the event monitoring and alerting application.\n\nYou are given relevant PromQL documentation, a type and description for a Prometheus metric, and a PromQL query on that metric. Using the provided information for reference, please explain what the output of a given query is in 1 sentences. Do not walk through what the functions do separately, make your answer concise. \n\nInput will be in the form:\n\n\nPromQL Documentation:\n<PromQL documentation>\n\nPromQL Metrics Metadata:\n<metric_name>(<metric type of the metric queried>): <description of what the metric means>\n\nPromQL Expression: \n<PromQL query>\n\nExamples of input and output\n----------\nPromQL Documentation:\nA counter is a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart. For example, you can use a counter to represent the number of requests served, tasks completed, or errors.\ntopk (largest k elements by sample value)\nsum (calculate sum over dimensions)\nrate(v range-vector) calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. \n\nPromQL Metrics Metadata:\ntraces_exporter_sent_spans(counter): Number of spans successfully sent to destination.\n\nPromQL Expression:\ntopk(3, sum by(cluster) (rate(traces_exporter_sent_spans{exporter=\"otlp\"}[5m])))\n\nThis query is trying to answer the question:\nWhat is the top 3 clusters that have successfully sent the most number of spans to the destination?\n`;\n\nexport type ExplainUserPromptParams = {\n  documentation: string;\n  metricName: string;\n  metricType: string;\n  metricMetadata: string;\n  query: string;\n};\n\nexport function GetExplainUserPrompt({\n  documentation,\n  metricName,\n  metricType,\n  metricMetadata,\n  query,\n}: ExplainUserPromptParams): string {\n  if (documentation === '') {\n    documentation = 'No documentation provided.';\n  }\n  if (metricMetadata === '') {\n    metricMetadata = 'No description provided.';\n  }\n  return `\n        PromQL Documentation: \n        ${documentation}\n\n        PromQL Metrics Metadata:\n        ${metricName}(${metricType}): ${metricMetadata}\n\n        PromQL Expression: \n        ${query}\n\n        This query is trying to answer the question:\n    `;\n}\n\nexport const SuggestSystemPrompt = `You are a Prometheus Query Language (PromQL) expert assistant inside Grafana.\nWhen the user asks a question, respond with a valid PromQL query and only the query.\n\nTo help you answer the question, you will receive:\n- List of potentially relevant PromQL templates with descriptions, ranked by semantic search score\n- Prometheus metric\n- Metric type\n- Available Prometheus metric labels\n- User question\n\nPolicy:\n- Do not invent labels names, you can only use the available labels\n- For rate queries, use the $__rate_interval variable`;\n\n// rewrite with a type\nexport type SuggestUserPromptParams = {\n  promql: string;\n  question: string;\n  metricType: string;\n  labels: string;\n  templates: string;\n};\n\nexport function GetSuggestUserPrompt({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): string {\n  if (templates === '') {\n    templates = 'No templates provided.';\n  } else {\n    templates = templates.replace(/\\n/g, '\\n  ');\n  }\n  return `Relevant PromQL templates:\n  ${templates}\n  \n  Prometheus metric: ${promql}\n  Metric type: ${metricType}\n  Available Prometheus metric labels: ${labels}\n  User question: ${question}\n  \n  \\`\\`\\`promql`;\n}\n","import { PromVisualQuery } from '../../../types';\nimport { Interaction, SuggestionType } from '../types';\n\n/**\n * Initial state for PromQAIL\n * @param query the prometheus query with metric and possible labels\n */\nexport function initialState(query?: PromVisualQuery, showStartingMessage?: boolean): PromQailState {\n  return {\n    query: query ?? {\n      metric: '',\n      labels: [],\n      operations: [],\n    },\n    showExplainer: false,\n    showStartingMessage: showStartingMessage ?? true,\n    indicateCheckbox: false,\n    askForQueryHelp: false,\n    interactions: [],\n  };\n}\n\n/**\n * The PromQAIL state object\n */\nexport interface PromQailState {\n  query: PromVisualQuery;\n  showExplainer: boolean;\n  showStartingMessage: boolean;\n  indicateCheckbox: boolean;\n  askForQueryHelp: boolean;\n  interactions: Interaction[];\n}\n\nexport function createInteraction(suggestionType: SuggestionType, isLoading?: boolean): Interaction {\n  return {\n    suggestionType: suggestionType,\n    prompt: '',\n    suggestions: [],\n    isLoading: isLoading ?? false,\n    explanationIsLoading: false,\n  };\n}\n","import { QuerySuggestion } from '../types';\n\ninterface TemplateData {\n  template: string;\n  description: string;\n}\n\nexport const generalTemplates: TemplateData[] = [\n  {\n    template: 'metric_a{}',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'avg by(c) (metric_a{})',\n    description: 'Average of all series in \"metric_a\" grouped by the label \"c\"',\n  },\n  {\n    template: 'count by(d) (metric_a{})',\n    description: 'Number of series in the metric \"metric_a\" grouped by the label \"d\"',\n  },\n  {\n    template: 'sum by(g) (sum_over_time(metric_a{}[1h]))',\n    description:\n      'For each series in the metric \"metric_a\", sum all values over 1 hour, then group those series by label \"g\" and sum.',\n  },\n  {\n    template: 'count(metric_a{})',\n    description: 'Count of series in the metric \"metric_a\"',\n  },\n  {\n    template: '(metric_a{})',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'count_over_time(metric_a{}[1h])',\n    description: 'Number of series of metric_a in a 1 hour interval',\n  },\n  {\n    template: 'changes(metric_a{}[1m])',\n    description: 'Number of times the values of each series in metric_a have changed in 1 minute periods',\n  },\n  {\n    template: 'count(count by(g) (metric_a{}))',\n    description: 'Total number of series in metric_a',\n  },\n  {\n    template: 'last_over_time(metric_a{}[1h])',\n    description: 'For each series in metric_a, get the last value in the 1 hour period.',\n  },\n  {\n    template: 'sum by(g) (count_over_time(metric_a{}[1h]))',\n    description: 'Grouped sum over the label \"g\" of the number of series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'count(metric_a{} == 99)',\n    description: 'Number of series of metric_a that have value 99',\n  },\n  {\n    template: 'min(metric_a{})',\n    description: 'At each timestamp, find the minimum of all series of the metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} != 99',\n    description: 'Series of metric_a which do not have the value 99',\n  },\n  {\n    template: 'metric_a{} - 99',\n    description: 'metric_a minus 99',\n  },\n  {\n    template: 'quantile_over_time(0.99,metric_a{}[1h])',\n    description: 'The 99th quantile of values of metric_a in 1 hour',\n  },\n  {\n    template: 'count_values(\"aaaa\",metric_a{})',\n    description: 'Count number of label values for a label named \"aaaa\"',\n  },\n];\n\nexport const counterTemplates: TemplateData[] = [\n  {\n    template: 'sum by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Sum of the rate of increase or decrease of the metric \"metric_a\" per 1 hour period, grouped by the label \"d\"',\n  },\n  {\n    template: 'rate(metric_a{}[1m])',\n    description: 'Rate of change of the metric \"metric_a\" over 1 minute',\n  },\n  {\n    template: 'sum by(a) (increase(metric_a{}[5m]))',\n    description:\n      'Taking the metric \"metric_a\" find the increase in 5 minute periods of each series and aggregate sum over the label \"a\"',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1m]))',\n    description: 'Total rate of change of all series of metric \"metric_a\" in 1 minute intervals',\n  },\n  {\n    template: 'sum(increase(metric_a{}[10m]))',\n    description: 'Total increase for each series of metric \"metric_a\" in 10 minute intervals',\n  },\n  {\n    template: 'increase(metric_a{}[1h])',\n    description: 'Increase in all series of \"metric_a\" in 1 hour period',\n  },\n  {\n    template: 'sum by(d) (irate(metric_a{}[1h]))',\n    description: 'Sum of detailed rate of change of the metric \"metric_a\" over 1 hour grouped by label \"d\"',\n  },\n  {\n    template: 'irate(metric_a{}[1h])',\n    description: 'Detailed rate of change of the metric \"metric_a\" over 1 hour',\n  },\n  {\n    template: 'avg by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Taking the rate of change of the metric \"metric_a\" in a 1 hour period, group by the label \"d\" and find the average of each group',\n  },\n  {\n    template: 'topk(5,sum by(g) (rate(metric_a{}[1h])))',\n    description: 'Top 5 of the summed groups \"g\" of the rate of change of metric_a',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1h])) / sum(rate(metric_a{}[1h]))',\n    description: 'Relative sums of metric_a with different labels',\n  },\n  {\n    template: 'histogram_quantile(99,rate(metric_a{}[1h]))',\n    description: '99th percentile of the rate of change of metric_a in 1 hour periods',\n  },\n  {\n    template: 'avg(rate(metric_a{}[1m]))',\n    description: 'Average of the rate of all series of metric_a in 1 minute periods',\n  },\n  {\n    template: 'rate(metric_a{}[5m]) > 99',\n    description: 'Show series of metric_a only if their rate over 5 minutes is greater than 99',\n  },\n  {\n    template: 'count by(g) (rate(metric_a{}[1h]))',\n    description: 'Count of series of metric_a over all labels \"g\"',\n  },\n];\n\nexport const histogramTemplates: TemplateData[] = [\n  {\n    template: 'histogram_quantile(99,sum by(le) (rate(metric_a{}[1h])))',\n    description:\n      'Calculate the rate at which the metric \"metric_a\" is increasing or decreasing, summed over each bucket label \"le\", and then calculates the 99th percentile of those rates.',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (metric_a{}))',\n    description: '99th percentile of the sum of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (irate(metric_a{}[1h])))',\n    description: '99th percentile of the grouped by \"g\" sum of the rate of each series in metric_a in an hour',\n  },\n  {\n    template: 'histogram_quantile(99,metric_a{})',\n    description: '99th percentile of metric_a',\n  },\n];\n\nexport const gaugeTemplates: TemplateData[] = [\n  {\n    template: 'sum by(c) (metric_a{})',\n    description: 'Sum the metric \"metric_a\" by each value in label \"c\"',\n  },\n  {\n    template: 'sum(metric_a{})',\n    description: 'Total sum of all the series of the metric named \"metric_a\"',\n  },\n  {\n    template: 'max by(dd) (metric_a{})',\n    description: 'Grouping the series the metric \"metric_a\" by the label \"dd\", get the maximum value of each group',\n  },\n  {\n    template: 'max(metric_a{})',\n    description: 'Maximum value of all series of the metric \"metric_a\" ',\n  },\n  {\n    template: 'avg(metric_a{})',\n    description: 'Average value of all the series of metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} > 99',\n    description: 'Show only the series of metric \"metric_a\" which currently have value greater than 99',\n  },\n  {\n    template: 'metric_a{} / 99',\n    description: 'Values for \"metric_a\" all divided by 99',\n  },\n  {\n    template: 'metric_a{} == 99',\n    description: 'Show series of metric_a that have value 99',\n  },\n  {\n    template: 'sum_over_time(metric_a{}[1h])',\n    description: 'Sum each series of metric_a over 1 hour',\n  },\n  {\n    template: 'avg_over_time(metric_a{}[1h])',\n    description: 'Average of each series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'sum(sum_over_time(metric_a{}[1h]))',\n    description: 'Sum of all values in all series in a 1 hour period',\n  },\n  {\n    template: 'delta(metric_a{}[1m])',\n    description: 'Span or delta (maximum - minimum) of values of the metric \"metric_a\" in a 1 minute period. ',\n  },\n  {\n    template: 'avg by(g) (avg_over_time(metric_a{}[1h]))',\n    description:\n      'For 1 hour, take each series and find the average, then group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'max_over_time(metric_a{}[1h])',\n    description: 'Maximum values of each series in metric \"metric_a\" in a 1 hour period',\n  },\n  {\n    template: 'metric_a{} * 99',\n    description: 'Values of metric_a multiplied by 99',\n  },\n  {\n    template: 'metric_a{} < 99',\n    description: 'Series of metric_a that have values less than 99',\n  },\n  {\n    template: 'max by() (max_over_time(metric_a{}[1h]))',\n    description: 'Find maximum value of all series in 1 hour periods',\n  },\n  {\n    template: 'topk(99,metric_a{})',\n    description: 'First 5 series of metric_a that have the highest values',\n  },\n  {\n    template: 'min by(g) (metric_a{})',\n    description: 'Minimum values of the series of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'topk(10,sum by(g) (metric_a{}))',\n    description: \"Top 10 of the series of metric_a grouped and summed by the label 'g'\",\n  },\n  {\n    template: 'avg(avg_over_time(metric_a{}[1h]))',\n    description: 'Average of all values inside a 1 hour period',\n  },\n  {\n    template: 'quantile by(h) (0.95,metric_a{})',\n    description: 'Calculate 95th percentile of metric_a when aggregated by the label \"h\"',\n  },\n  {\n    template: 'avg by(g) (metric_a{} > 99)',\n    description:\n      'Taking all series of metric_a with value greater than 99, group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'sum(metric_a{}) / 99',\n    description: 'Sum of all series of metric_a divided by 99',\n  },\n  {\n    template: 'count(sum by(g) (metric_a{}))',\n    description: 'Number of series of metric_a grouped by the label \"g\"',\n  },\n  {\n    template: 'max(max_over_time(metric_a{}[1h]))',\n    description: 'Find the max value of all series of metric_a in a 1 hour period',\n  },\n];\n\nfunction processTemplate(templateData: TemplateData, metric: string, labels: string): QuerySuggestion {\n  return {\n    query: templateData.template.replace('metric_a', metric).replace('{}', labels),\n    explanation: templateData.description.replace('metric_a', metric),\n  };\n}\n\nexport function getTemplateSuggestions(metricName: string, metricType: string, labels: string): QuerySuggestion[] {\n  let templateSuggestions: QuerySuggestion[] = [];\n  switch (metricType) {\n    case 'counter':\n      templateSuggestions = templateSuggestions.concat(\n        counterTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'gauge':\n      templateSuggestions = templateSuggestions.concat(\n        gaugeTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'histogram':\n      templateSuggestions = templateSuggestions.concat(\n        histogramTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    default:\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 5)\n      );\n      break;\n  }\n  return templateSuggestions;\n}\n","import { AnyAction } from 'redux';\n\nimport { llms } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\n\nimport { PrometheusDatasource } from '../../../../datasource';\nimport { getMetadataHelp, getMetadataType } from '../../../../language_provider';\nimport { promQueryModeller } from '../../../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../../../parsing';\nimport { PromVisualQuery } from '../../../types';\nimport { updateInteraction } from '../PromQail';\nimport {\n  ExplainSystemPrompt,\n  GetExplainUserPrompt,\n  SuggestSystemPrompt,\n  GetSuggestUserPrompt,\n  SuggestUserPromptParams,\n} from '../prompts';\nimport { Interaction, QuerySuggestion, SuggestionType } from '../types';\n\nimport { createInteraction } from './state';\nimport { getTemplateSuggestions } from './templates';\n\nconst OPENAI_MODEL_NAME = 'gpt-3.5-turbo-1106';\nconst promQLTemplatesCollection = 'grafana.promql.templates';\n\ninterface TemplateSearchResult {\n  description: string | null;\n  metric_type: string | null;\n  promql: string | null;\n}\n\nexport function getExplainMessage(\n  query: string,\n  metric: string,\n  datasource: PrometheusDatasource\n): llms.openai.Message[] {\n  let metricMetadata = '';\n  let metricType = '';\n\n  const pvq = buildVisualQueryFromString(query);\n\n  if (datasource.languageProvider.metricsMetadata) {\n    metricType = getMetadataType(metric, datasource.languageProvider.metricsMetadata) ?? '';\n    metricMetadata = getMetadataHelp(metric, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n\n  const documentationBody = pvq.query.operations\n    .map((op) => {\n      const def = promQueryModeller.getOperationDef(op.id);\n      if (!def) {\n        return '';\n      }\n      const title = def.renderer(op, def, '<expr>');\n      const body = def.explainHandler ? def.explainHandler(op, def) : def.documentation;\n\n      if (!body) {\n        return '';\n      }\n      return `### ${title}:\\n${body}`;\n    })\n    .filter((item) => item !== '')\n    .join('\\n');\n\n  return [\n    { role: 'system', content: ExplainSystemPrompt },\n    {\n      role: 'user',\n      content: GetExplainUserPrompt({\n        documentation: documentationBody,\n        metricName: metric,\n        metricType: metricType,\n        metricMetadata: metricMetadata,\n        query: query,\n      }),\n    },\n  ];\n}\n\nfunction getSuggestMessages({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): llms.openai.Message[] {\n  return [\n    { role: 'system', content: SuggestSystemPrompt },\n    { role: 'user', content: GetSuggestUserPrompt({ promql, question, metricType, labels, templates }) },\n  ];\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailExplain(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  interaction: Interaction,\n  suggIdx: number,\n  datasource: PrometheusDatasource\n) {\n  const suggestedQuery = interaction.suggestions[suggIdx].query;\n\n  const promptMessages = getExplainMessage(suggestedQuery, query.metric, datasource);\n  const interactionToUpdate = interaction;\n\n  return llms.openai\n    .streamChatCompletions({\n      model: OPENAI_MODEL_NAME,\n      messages: promptMessages,\n      temperature: 0,\n    })\n    .pipe(llms.openai.accumulateContent())\n    .subscribe((response) => {\n      const updatedSuggestions = interactionToUpdate.suggestions.map((sg: QuerySuggestion, sidx: number) => {\n        if (suggIdx === sidx) {\n          return {\n            query: interactionToUpdate.suggestions[suggIdx].query,\n            explanation: response,\n          };\n        }\n\n        return sg;\n      });\n\n      const payload = {\n        idx,\n        interaction: {\n          ...interactionToUpdate,\n          suggestions: updatedSuggestions,\n          explanationIsLoading: false,\n        },\n      };\n      dispatch(updateInteraction(payload));\n    });\n}\n\n/**\n * Check if sublist is fully contained in the superlist\n *\n * @param sublist\n * @param superlist\n * @returns true if fully contained, else false\n */\nfunction isContainedIn(sublist: string[], superlist: string[]): boolean {\n  for (const item of sublist) {\n    if (!superlist.includes(item)) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Guess the type of a metric, based on its name and its relation to other metrics available\n *\n * @param metric     - name of metric whose type to guess\n * @param allMetrics - list of all available metrics\n * @returns          - the guess of the type (string): counter,gauge,summary,histogram,'histogram,summary'\n */\nexport function guessMetricType(metric: string, allMetrics: string[]): string {\n  const synthetic_metrics = new Set<string>([\n    'up',\n    'scrape_duration_seconds',\n    'scrape_samples_post_metric_relabeling',\n    'scrape_series_added',\n    'scrape_samples_scraped',\n    'ALERTS',\n    'ALERTS_FOR_STATE',\n  ]);\n\n  if (synthetic_metrics.has(metric)) {\n    // these are all known to be counters\n    return 'counter';\n  }\n  if (metric.startsWith(':')) {\n    // probably recording rule\n    return 'gauge';\n  }\n  if (metric.endsWith('_info')) {\n    // typically series of 1s only, the labels are the useful part. TODO: add 'info' type\n    return 'counter';\n  }\n\n  if (metric.endsWith('_created') || metric.endsWith('_total')) {\n    // prometheus naming style recommends counters to have these suffixes.\n    return 'counter';\n  }\n\n  const underscoreIndex = metric.lastIndexOf('_');\n  if (underscoreIndex < 0) {\n    // No underscores in the name at all, very little info to go on. Guess\n    return 'gauge';\n  }\n\n  // See if the suffix is histogram-y or summary-y\n  const [root, suffix] = [metric.slice(0, underscoreIndex), metric.slice(underscoreIndex + 1)];\n\n  if (['bucket', 'count', 'sum'].includes(suffix)) {\n    // Might be histogram + summary\n    let familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram,summary';\n    }\n\n    // Might be a histogram, if so all these metrics should exist too:\n    familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram';\n    }\n\n    // Or might be a summary\n    familyMetrics = [`${root}_sum`, `${root}_count`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'summary';\n    }\n\n    // Otherwise it's probably just a counter!\n    return 'counter';\n  }\n\n  // One case above doesn't catch: summary or histogram,summary where the non-suffixed metric is chosen\n  const familyMetrics = [`${metric}_sum`, `${metric}_count`, metric];\n  if (isContainedIn(familyMetrics, allMetrics)) {\n    if (allMetrics.includes(`${metric}_bucket`)) {\n      return 'histogram,summary';\n    } else {\n      return 'summary';\n    }\n  }\n\n  // All else fails, guess gauge\n  return 'gauge';\n}\n\n/**\n * Generate a suitable filter structure for the VectorDB call\n * @param types: list of metric types to include in the result\n * @returns the structure to pass to the vectorDB call.\n */\nfunction generateMetricTypeFilters(types: string[]) {\n  return types.map((type) => ({\n    metric_type: {\n      $eq: type,\n    },\n  }));\n}\n\n/**\n * Taking in a metric name, try to guess its corresponding metric _family_ name\n * @param metric name\n * @returns metric family name\n */\nfunction guessMetricFamily(metric: string): string {\n  if (metric.endsWith('_bucket') || metric.endsWith('_count') || metric.endsWith('_sum')) {\n    return metric.slice(0, metric.lastIndexOf('_'));\n  }\n  return metric;\n}\n\n/**\n * Check if the LLM plugin is enabled.\n * Used in the PromQueryBuilder to enable/disable the button based on openai and vector db checks\n * @returns true if the LLM plugin is enabled.\n */\nexport async function isLLMPluginEnabled(): Promise<boolean> {\n  // Check if the LLM plugin is enabled.\n  // If not, we won't be able to make requests, so return early.\n  const openaiEnabled = llms.openai.health().then((response) => response.ok);\n  const vectorEnabled = llms.vector.health().then((response) => response.ok);\n  // combine 2 promises\n  return Promise.all([openaiEnabled, vectorEnabled]).then((results) => {\n    return results.every((result) => result);\n  });\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailSuggest(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  labelNames: string[],\n  datasource: PrometheusDatasource,\n  interaction?: Interaction\n) {\n  const interactionToUpdate = interaction ? interaction : createInteraction(SuggestionType.Historical);\n\n  // Decide metric type\n  let metricType = '';\n  // Makes sure we loaded the metadata for metrics. Usually this is done in the start() method of the\n  // provider but we only need the metadata here.\n  if (!datasource.languageProvider.metricsMetadata) {\n    await datasource.languageProvider.loadMetricsMetadata();\n  }\n  if (datasource.languageProvider.metricsMetadata) {\n    // `datasource.languageProvider.metricsMetadata` is a list of metric family names (with desired type)\n    // from the datasource metadata endoint, but unfortunately the expanded _sum, _count, _bucket raw\n    // metric names are also generated and populating this list (all of type counter). We want the metric\n    // family type, so need to guess the metric family name from the chosen metric name, and test if that\n    // metric family has a type specified.\n    const metricFamilyGuess = guessMetricFamily(query.metric);\n    metricType = getMetadataType(metricFamilyGuess, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n  if (metricType === '') {\n    // fallback to heuristic guess\n    metricType = guessMetricType(query.metric, datasource.languageProvider.metrics);\n  }\n\n  if (interactionToUpdate.suggestionType === SuggestionType.Historical) {\n    return new Promise<void>((resolve) => {\n      return setTimeout(() => {\n        const suggestions = getTemplateSuggestions(\n          query.metric,\n          metricType,\n          promQueryModeller.renderLabels(query.labels)\n        );\n\n        const payload = {\n          idx,\n          interaction: { ...interactionToUpdate, suggestions: suggestions, isLoading: false },\n        };\n        dispatch(updateInteraction(payload));\n        resolve();\n      }, 1000);\n    });\n  } else {\n    type SuggestionBody = {\n      metric: string;\n      labels: string;\n      prompt?: string;\n    };\n\n    // get all available labels\n    const metricLabels = await datasource.languageProvider.fetchLabelsWithMatch(query.metric);\n\n    let feedTheAI: SuggestionBody = {\n      metric: query.metric,\n      // drop __name__ label because it's not useful\n      labels: Object.keys(metricLabels)\n        .filter((label) => label !== '__name__')\n        .join(','),\n    };\n\n    // @ts-ignore llms types issue\n    let results: Array<llms.vector.SearchResult<TemplateSearchResult>> = [];\n    if (interaction?.suggestionType === SuggestionType.AI) {\n      feedTheAI = { ...feedTheAI, prompt: interaction.prompt };\n\n      // @ts-ignore llms types issue\n      results = await llms.vector.search<TemplateSearchResult>({\n        query: interaction.prompt,\n        collection: promQLTemplatesCollection,\n        topK: 5,\n        filter: {\n          $or: generateMetricTypeFilters(metricType.split(',').concat(['*'])),\n        },\n      });\n      reportInteraction('grafana_prometheus_promqail_vector_results', {\n        metric: query.metric,\n        prompt: interaction.prompt,\n        results: results,\n      });\n      // TODO: handle errors from vector search\n    }\n\n    const resultsString = results\n      .map((r) => {\n        return `${r.payload.promql} | ${r.payload.description} (score=${(r.score * 100).toFixed(1)})`;\n      })\n      .join('\\n');\n\n    const promptMessages = getSuggestMessages({\n      promql: query.metric,\n      question: interaction ? interaction.prompt : '',\n      metricType: metricType,\n      labels: labelNames.join(', '),\n      templates: resultsString,\n    });\n\n    return llms.openai\n      .streamChatCompletions({\n        model: OPENAI_MODEL_NAME,\n        messages: promptMessages,\n        temperature: 0.5,\n      })\n      .pipe(llms.openai.accumulateContent())\n      .subscribe((response) => {\n        const payload = {\n          idx,\n          interaction: {\n            ...interactionToUpdate,\n            suggestions: [\n              {\n                query: response,\n                explanation: '',\n              },\n            ],\n            isLoading: false,\n          },\n        };\n        dispatch(updateInteraction(payload));\n      });\n  }\n}\n","import { css, cx } from '@emotion/css';\nimport { PayloadAction, createSlice } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer, useRef, useState } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Alert, Button, Checkbox, Input, Spinner, useTheme2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../../datasource';\nimport store from '../../../gcopypaste/app/core/store';\nimport { PromVisualQuery } from '../../types';\n\nimport { QuerySuggestionContainer } from './QuerySuggestionContainer';\n// @ts-ignore until we can get these added for icons\nimport AI_Logo_color from './resources/AI_Logo_color.svg';\nimport { promQailExplain, promQailSuggest } from './state/helpers';\nimport { createInteraction, initialState } from './state/state';\nimport { Interaction, SuggestionType } from './types';\n\nexport type PromQailProps = {\n  query: PromVisualQuery;\n  closeDrawer: () => void;\n  onChange: (query: PromVisualQuery) => void;\n  datasource: PrometheusDatasource;\n};\n\nconst SKIP_STARTING_MESSAGE = 'SKIP_STARTING_MESSAGE';\n\nexport const PromQail = (props: PromQailProps) => {\n  const { query, closeDrawer, onChange, datasource } = props;\n  const skipStartingMessage = store.getBool(SKIP_STARTING_MESSAGE, false);\n\n  const [state, dispatch] = useReducer(stateSlice.reducer, initialState(query, !skipStartingMessage));\n\n  const [labelNames, setLabelNames] = useState<string[]>([]);\n\n  const suggestions = state.interactions.reduce((acc, int) => acc + int.suggestions.length, 0);\n\n  const responsesEndRef = useRef(null);\n\n  const scrollToBottom = () => {\n    if (responsesEndRef) {\n      // @ts-ignore for React.MutableRefObject\n      responsesEndRef?.current?.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    // only scroll when an interaction has been added or the suggestions have been updated\n    scrollToBottom();\n  }, [state.interactions.length, suggestions]);\n\n  useEffect(() => {\n    const fetchLabels = async () => {\n      let labelsIndex: Record<string, string[]> = await datasource.languageProvider.fetchLabelsWithMatch(query.metric);\n      setLabelNames(Object.keys(labelsIndex));\n    };\n    fetchLabels();\n  }, [query, datasource]);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  return (\n    <div className={styles.containerPadding}>\n      {/* Query Advisor */}\n      {/* header */}\n      <div className={styles.header}>\n        <h3>Query advisor</h3>\n        <Button icon=\"times\" fill=\"text\" variant=\"secondary\" onClick={closeDrawer} />\n      </div>\n      {/* Starting message */}\n      <div>\n        <div className={styles.iconSection}>\n          <img src={AI_Logo_color} alt=\"AI logo color\" /> Assistant\n        </div>\n        {state.showStartingMessage ? (\n          <>\n            <div className={styles.dataList}>\n              <ol>\n                <li className={styles.textPadding}>\n                  Query Advisor suggests queries based on a metric and requests you type in.\n                </li>\n                <li className={styles.textPadding}>\n                  Query Advisor sends Prometheus metrics, labels and metadata to the LLM provider you&#39;ve configured.\n                  Be sure to align its usage with your company&#39;s internal policies.\n                </li>\n                <li className={styles.textPadding}>\n                  An AI-suggested query may not fully answer your question. Always take a moment to understand a query\n                  before you use it.\n                </li>\n              </ol>\n            </div>\n            <Alert\n              title={''}\n              severity={'info'}\n              key={'promqail-llm-app'}\n              className={cx(styles.textPadding, styles.noMargin)}\n            >\n              Query Advisor is currently in Private Preview. Feedback is appreciated and can be provided on explanations\n              and suggestions.\n            </Alert>\n\n            {/* don't show this message again, store in localstorage */}\n            <div className={styles.textPadding}>\n              <Checkbox\n                checked={state.indicateCheckbox}\n                value={state.indicateCheckbox}\n                onChange={() => {\n                  const val = store.getBool(SKIP_STARTING_MESSAGE, false);\n                  store.set(SKIP_STARTING_MESSAGE, !val);\n                  dispatch(indicateCheckbox(!val));\n                }}\n                label=\"Don't show this message again\"\n              />\n            </div>\n            <div className={styles.rightButtonsWrapper}>\n              <div className={styles.rightButtons}>\n                <Button className={styles.leftButton} fill=\"outline\" variant=\"secondary\" onClick={closeDrawer}>\n                  Cancel\n                </Button>\n                <Button\n                  fill=\"solid\"\n                  variant=\"primary\"\n                  onClick={() => dispatch(showStartingMessage(false))}\n                  data-testid={queryAssistanttestIds.securityInfoButton}\n                >\n                  Continue\n                </Button>\n              </div>\n            </div>\n          </>\n        ) : (\n          <div className={styles.bodySmall}>\n            {/* MAKE THIS TABLE RESPONSIVE */}\n            {/* FIT SUPER LONG METRICS AND LABELS IN HERE */}\n            <div className={styles.textPadding}>Here is the metric you have selected:</div>\n            <div className={styles.infoContainerWrapper}>\n              <div className={styles.infoContainer}>\n                <table className={styles.metricTable}>\n                  <tbody>\n                    <tr>\n                      <td className={styles.metricTableName}>metric</td>\n                      <td className={styles.metricTableValue}>{state.query.metric}</td>\n                      <td>\n                        <Button\n                          fill=\"outline\"\n                          variant=\"secondary\"\n                          onClick={closeDrawer}\n                          className={styles.metricTableButton}\n                          size={'sm'}\n                        >\n                          Choose new metric\n                        </Button>\n                      </td>\n                    </tr>\n                    {state.query.labels.map((label, idx) => {\n                      const text = idx === 0 ? 'labels' : '';\n                      return (\n                        <tr key={`${label.label}-${idx}`}>\n                          <td>{text}</td>\n                          <td className={styles.metricTableValue}>{`${label.label}${label.op}${label.value}`}</td>\n                          <td> </td>\n                        </tr>\n                      );\n                    })}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Ask if you know what you want to query? */}\n            {!state.askForQueryHelp && state.interactions.length === 0 && (\n              <>\n                <div className={styles.queryQuestion}>Do you know what you want to query?</div>\n                <div className={styles.rightButtonsWrapper}>\n                  <div className={styles.rightButtons}>\n                    <Button\n                      className={styles.leftButton}\n                      fill=\"solid\"\n                      variant=\"secondary\"\n                      data-testid={queryAssistanttestIds.clickForHistorical}\n                      onClick={() => {\n                        const isLoading = true;\n                        const suggestionType = SuggestionType.Historical;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'no',\n                        });\n                        promQailSuggest(dispatch, 0, query, labelNames, datasource);\n                      }}\n                    >\n                      No\n                    </Button>\n                    <Button\n                      fill=\"solid\"\n                      variant=\"primary\"\n                      data-testid={queryAssistanttestIds.clickForAi}\n                      onClick={() => {\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'yes',\n                        });\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                    >\n                      Yes\n                    </Button>\n                  </div>\n                </div>\n              </>\n            )}\n\n            {state.interactions.map((interaction: Interaction, idx: number) => {\n              return (\n                <div key={idx}>\n                  {interaction.suggestionType === SuggestionType.AI ? (\n                    <>\n                      <div className={styles.textPadding}>What kind of data do you want to see with your metric?</div>\n                      <div className={cx(styles.secondaryText, styles.bottomMargin)}>\n                        <div>You do not need to enter in a metric or a label again in the prompt.</div>\n                        <div>Example: I want to monitor request latency, not errors.</div>\n                      </div>\n                      <div className={styles.inputPadding}>\n                        <Input\n                          value={interaction.prompt}\n                          spellCheck={false}\n                          placeholder=\"Enter prompt\"\n                          disabled={interaction.suggestions.length > 0}\n                          onChange={(e) => {\n                            const prompt = e.currentTarget.value;\n\n                            const payload = {\n                              idx: idx,\n                              interaction: { ...interaction, prompt },\n                            };\n\n                            dispatch(updateInteraction(payload));\n                          }}\n                        />\n                      </div>\n                      {interaction.suggestions.length === 0 ? (\n                        interaction.isLoading ? (\n                          <>\n                            <div className={styles.loadingMessageContainer}>\n                              Waiting for OpenAI <Spinner className={styles.floatRight} />\n                            </div>\n                          </>\n                        ) : (\n                          <>\n                            <div className={styles.rightButtonsWrapper}>\n                              <div className={styles.rightButtons}>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={closeDrawer}\n                                >\n                                  Cancel\n                                </Button>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={() => {\n                                    // JUST SUGGEST QUERIES AND SHOW THE LIST\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      suggestionType: SuggestionType.Historical,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_suggest_query_instead', {\n                                      promVisualQuery: query,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, newInteraction);\n                                  }}\n                                >\n                                  Suggest queries instead\n                                </Button>\n                                <Button\n                                  fill=\"solid\"\n                                  variant=\"primary\"\n                                  data-testid={queryAssistanttestIds.submitPrompt + idx}\n                                  onClick={() => {\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_prompt_submitted', {\n                                      promVisualQuery: query,\n                                      prompt: interaction.prompt,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    // add the suggestions in the API call\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, interaction);\n                                  }}\n                                >\n                                  Submit\n                                </Button>\n                              </div>\n                            </div>\n                          </>\n                        )\n                      ) : (\n                        // LIST OF SUGGESTED QUERIES FROM AI\n                        <QuerySuggestionContainer\n                          suggestionType={SuggestionType.AI}\n                          querySuggestions={interaction.suggestions}\n                          closeDrawer={closeDrawer}\n                          nextInteraction={() => {\n                            const isLoading = false;\n                            const suggestionType = SuggestionType.AI;\n                            dispatch(addInteraction({ suggestionType, isLoading }));\n                          }}\n                          queryExplain={(suggIdx: number) =>\n                            interaction.suggestions[suggIdx].explanation === ''\n                              ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                              : interaction.suggestions[suggIdx].explanation\n                          }\n                          onChange={onChange}\n                          prompt={interaction.prompt ?? ''}\n                        />\n                      )}\n                    </>\n                  ) : // HISTORICAL SUGGESTIONS\n                  interaction.isLoading ? (\n                    <>\n                      <div className={styles.loadingMessageContainer}>\n                        Waiting for OpenAI <Spinner className={styles.floatRight} />\n                      </div>\n                    </>\n                  ) : (\n                    // LIST OF SUGGESTED QUERIES FROM HISTORICAL DATA\n                    <QuerySuggestionContainer\n                      suggestionType={SuggestionType.Historical}\n                      querySuggestions={interaction.suggestions}\n                      closeDrawer={closeDrawer}\n                      nextInteraction={() => {\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                      queryExplain={(suggIdx: number) =>\n                        interaction.suggestions[suggIdx].explanation === ''\n                          ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                          : interaction.suggestions[suggIdx].explanation\n                      }\n                      onChange={onChange}\n                      prompt={interaction.prompt ?? ''}\n                    />\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n      <div ref={responsesEndRef} />\n    </div>\n  );\n};\n\nexport const getStyles = (theme: GrafanaTheme2) => {\n  return {\n    sectionPadding: css({\n      padding: '20px',\n    }),\n    header: css({\n      display: 'flex',\n\n      button: {\n        marginLeft: 'auto',\n      },\n    }),\n    iconSection: css({\n      padding: '0 0 10px 0',\n      color: `${theme.colors.text.secondary}`,\n\n      img: {\n        paddingRight: '4px',\n      },\n    }),\n    rightButtonsWrapper: css({\n      display: 'flex',\n    }),\n    rightButtons: css({\n      marginLeft: 'auto',\n    }),\n    leftButton: css({\n      marginRight: '10px',\n    }),\n    dataList: css({\n      padding: '0px 28px 0px 28px',\n    }),\n    textPadding: css({\n      paddingBottom: '12px',\n    }),\n    containerPadding: css({\n      padding: '28px',\n    }),\n    infoContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: '16px',\n      backgroundColor: `${theme.colors.background.secondary}`,\n      borderRadius: `8px`,\n      borderBottomLeftRadius: 0,\n    }),\n    infoContainerWrapper: css({\n      paddingBottom: '24px',\n    }),\n    metricTable: css({\n      width: '100%',\n    }),\n    metricTableName: css({\n      width: '15%',\n    }),\n    metricTableValue: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n      overflow: 'scroll',\n      textWrap: 'nowrap',\n      maxWidth: '150px',\n      width: '60%',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n    }),\n    metricTableButton: css({\n      float: 'right',\n    }),\n    queryQuestion: css({\n      textAlign: 'end',\n      padding: '8px 0',\n    }),\n    secondaryText: css({\n      color: `${theme.colors.text.secondary}`,\n    }),\n    loadingMessageContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: `16px`,\n      backgroundColor: `${theme.colors.background.secondary}`,\n      marginBottom: `20px`,\n      borderRadius: `8px`,\n      color: `${theme.colors.text.secondary}`,\n      fontStyle: 'italic',\n    }),\n    floatRight: css({\n      float: 'right',\n    }),\n    codeText: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    bodySmall: css({\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    explainPadding: css({\n      paddingLeft: '26px',\n    }),\n    bottomMargin: css({\n      marginBottom: '20px',\n    }),\n    topPadding: css({\n      paddingTop: '22px',\n    }),\n    doc: css({\n      textDecoration: 'underline',\n    }),\n    afterButtons: css({\n      display: 'flex',\n      justifyContent: 'flex-end',\n    }),\n    feedbackStyle: css({\n      margin: 0,\n      textAlign: 'right',\n      paddingTop: '22px',\n      paddingBottom: '22px',\n    }),\n    nextInteractionHeight: css({\n      height: '88px',\n    }),\n    center: css({\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n    }),\n    inputPadding: css({\n      paddingBottom: '24px',\n    }),\n    querySuggestion: css({\n      display: 'flex',\n      flexWrap: 'nowrap',\n    }),\n    longCode: css({\n      width: '90%',\n      textWrap: 'nowrap',\n      overflow: 'scroll',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n\n      div: {\n        display: 'inline-block',\n      },\n    }),\n    useButton: css({\n      marginLeft: 'auto',\n    }),\n    suggestionFeedback: css({\n      textAlign: 'left',\n    }),\n    feedbackQuestion: css({\n      display: 'flex',\n      padding: '8px 0px',\n      h6: { marginBottom: 0 },\n      i: {\n        marginTop: '1px',\n      },\n    }),\n    explationTextInput: css({\n      paddingLeft: '24px',\n    }),\n    submitFeedback: css({\n      padding: '16px 0',\n    }),\n    noMargin: css({\n      margin: 0,\n    }),\n    enableButtonTooltip: css({\n      padding: 8,\n    }),\n    enableButtonTooltipText: css({\n      color: `${theme.colors.text.secondary}`,\n      ul: {\n        marginLeft: 16,\n      },\n    }),\n    link: css({\n      color: `${theme.colors.text.link} !important`,\n    }),\n  };\n};\n\nexport const queryAssistanttestIds = {\n  promQail: 'prom-qail',\n  securityInfoButton: 'security-info-button',\n  clickForHistorical: 'click-for-historical',\n  clickForAi: 'click-for-ai',\n  submitPrompt: 'submit-prompt',\n  refinePrompt: 'refine-prompt',\n};\n\nconst stateSlice = createSlice({\n  name: 'metrics-modal-state',\n  initialState: initialState(),\n  reducers: {\n    showExplainer: (state, action: PayloadAction<boolean>) => {\n      state.showExplainer = action.payload;\n    },\n    showStartingMessage: (state, action: PayloadAction<boolean>) => {\n      state.showStartingMessage = action.payload;\n    },\n    indicateCheckbox: (state, action: PayloadAction<boolean>) => {\n      state.indicateCheckbox = action.payload;\n    },\n    askForQueryHelp: (state, action: PayloadAction<boolean>) => {\n      state.askForQueryHelp = action.payload;\n    },\n    /*\n     * start working on a collection of interactions\n     * {\n     *  askForhelp y n\n     *  prompt question\n     *  queries querySuggestions\n     * }\n     *\n     */\n    addInteraction: (state, action: PayloadAction<{ suggestionType: SuggestionType; isLoading: boolean }>) => {\n      // AI or Historical?\n      const interaction = createInteraction(action.payload.suggestionType, action.payload.isLoading);\n      const interactions = state.interactions;\n      state.interactions = interactions.concat([interaction]);\n    },\n    updateInteraction: (state, action: PayloadAction<{ idx: number; interaction: Interaction }>) => {\n      // update the interaction by index\n      // will most likely be the last interaction but we might update previous by giving them cues of helpful or not\n      const index = action.payload.idx;\n      const updInteraction = action.payload.interaction;\n\n      state.interactions = state.interactions.map((interaction: Interaction, idx: number) => {\n        if (idx === index) {\n          return updInteraction;\n        }\n\n        return interaction;\n      });\n    },\n  },\n});\n\n// actions to update the state\nexport const { showStartingMessage, indicateCheckbox, addInteraction, updateInteraction } = stateSlice.actions;\n","import React from 'react';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Tooltip, useTheme2 } from '@grafana/ui';\n\nimport { getStyles } from './PromQail';\nimport AI_Logo_color from './resources/AI_Logo_color.svg';\n\nexport type Props = {\n  llmAppEnabled: boolean;\n  metric: string;\n  setShowDrawer: (show: boolean) => void;\n};\n\nexport function QueryAssistantButton(props: Props) {\n  const { llmAppEnabled, metric, setShowDrawer } = props;\n\n  const llmAppDisabled = !llmAppEnabled;\n  const noMetricSelected = !metric;\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const button = () => {\n    return (\n      <Button\n        variant={'secondary'}\n        onClick={() => {\n          reportInteraction('grafana_prometheus_promqail_ai_button_clicked', {\n            metric: metric,\n          });\n          setShowDrawer(true);\n        }}\n        disabled={!metric || !llmAppEnabled}\n        data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.queryAdvisor}\n      >\n        <img height={16} src={AI_Logo_color} alt=\"AI logo black and white\" />\n        {'\\u00A0'}Get query suggestions\n      </Button>\n    );\n  };\n\n  const selectMetricMessage = (\n    <Tooltip content={'First, select a metric.'} placement={'bottom-end'}>\n      {button()}\n    </Tooltip>\n  );\n\n  const llmAppMessage = (\n    <Tooltip\n      interactive={true}\n      placement={'auto-end'}\n      content={\n        <div className={styles.enableButtonTooltip}>\n          <h6>Query Advisor is disabled</h6>\n          <div className={styles.enableButtonTooltipText}>To enable Query Advisor you must:</div>\n          <div className={styles.enableButtonTooltipText}>\n            <ul>\n              <li>\n                <a\n                  href={'https://grafana.com/docs/grafana-cloud/alerting-and-irm/machine-learning/llm-plugin/'}\n                  target=\"_blank\"\n                  rel=\"noreferrer noopener\"\n                  className={styles.link}\n                >\n                  Install and enable the LLM plugin\n                </a>\n              </li>\n              <li>Select a metric</li>\n            </ul>\n          </div>\n        </div>\n      }\n    >\n      {button()}\n    </Tooltip>\n  );\n\n  if (llmAppDisabled) {\n    return llmAppMessage;\n  } else if (noMetricSelected) {\n    return selectMetricMessage;\n  } else {\n    return button();\n  }\n}\n","import { css } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\n\nimport { DataSourceApi, PanelData } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorRow } from '@grafana/experimental';\nimport { config } from '@grafana/runtime';\nimport { Drawer } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationList } from '../shared/OperationList';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { OperationsEditorRow } from '../shared/OperationsEditorRow';\nimport { QueryBuilderHints } from '../shared/QueryBuilderHints';\nimport { RawQuery } from '../shared/RawQuery';\nimport { QueryBuilderOperation } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { MetricsLabelsSection } from './MetricsLabelsSection';\nimport { NestedQueryList } from './NestedQueryList';\nimport { EXPLAIN_LABEL_FILTER_CONTENT } from './PromQueryBuilderExplained';\nimport { PromQail } from './promQail/PromQail';\nimport { QueryAssistantButton } from './promQail/QueryAssistantButton';\nimport { isLLMPluginEnabled } from './promQail/state/helpers';\n\nexport interface PromQueryBuilderProps {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport const PromQueryBuilder = React.memo<PromQueryBuilderProps>((props) => {\n  const { datasource, query, onChange, onRunQuery, data, showExplain } = props;\n  const [highlightedOp, setHighlightedOp] = useState<QueryBuilderOperation | undefined>();\n  const [showDrawer, setShowDrawer] = useState<boolean>(false);\n  const [llmAppEnabled, updateLlmAppEnabled] = useState<boolean>(false);\n  const { prometheusPromQAIL } = config.featureToggles; // AI/ML + Prometheus\n\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  const initHints = datasource.getInitHints();\n\n  useEffect(() => {\n    async function checkLlms() {\n      const check = await isLLMPluginEnabled();\n      updateLlmAppEnabled(check);\n    }\n\n    if (prometheusPromQAIL) {\n      checkLlms();\n    }\n  }, [prometheusPromQAIL]);\n\n  return (\n    <>\n      {prometheusPromQAIL && showDrawer && (\n        <Drawer closeOnMaskClick={false} onClose={() => setShowDrawer(false)}>\n          <PromQail\n            query={query}\n            closeDrawer={() => setShowDrawer(false)}\n            onChange={onChange}\n            datasource={datasource}\n          />\n        </Drawer>\n      )}\n      <EditorRow>\n        <MetricsLabelsSection query={query} onChange={onChange} datasource={datasource} />\n      </EditorRow>\n      {initHints.length ? (\n        <div className=\"query-row-break\">\n          <div className=\"prom-query-field-info text-warning\">\n            {initHints[0].label}{' '}\n            {initHints[0].fix ? (\n              <button type=\"button\" className={'text-warning'}>\n                {initHints[0].fix.label}\n              </button>\n            ) : null}\n          </div>\n        </div>\n      ) : null}\n      {showExplain && (\n        <OperationExplainedBox\n          stepNumber={1}\n          title={<RawQuery query={`${query.metric} ${promQueryModeller.renderLabels(query.labels)}`} lang={lang} />}\n        >\n          {EXPLAIN_LABEL_FILTER_CONTENT}\n        </OperationExplainedBox>\n      )}\n      <OperationsEditorRow>\n        <OperationList<PromVisualQuery>\n          queryModeller={promQueryModeller}\n          // eslint-ignore\n          datasource={datasource as DataSourceApi}\n          query={query}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          highlightedOp={highlightedOp}\n        />\n        {prometheusPromQAIL && (\n          <div\n            className={css({\n              padding: '0 0 0 6px',\n            })}\n          >\n            <QueryAssistantButton llmAppEnabled={llmAppEnabled} metric={query.metric} setShowDrawer={setShowDrawer} />\n          </div>\n        )}\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.hints}>\n          <QueryBuilderHints<PromVisualQuery>\n            datasource={datasource}\n            query={query}\n            onChange={onChange}\n            data={data}\n            queryModeller={promQueryModeller}\n            buildVisualQueryFromString={buildVisualQueryFromString}\n          />\n        </div>\n      </OperationsEditorRow>\n      {showExplain && (\n        <OperationListExplained<PromVisualQuery>\n          lang={lang}\n          query={query}\n          stepNumber={2}\n          queryModeller={promQueryModeller}\n          onMouseEnter={(op) => setHighlightedOp(op)}\n          onMouseLeave={() => setHighlightedOp(undefined)}\n        />\n      )}\n      {query.binaryQueries && query.binaryQueries.length > 0 && (\n        <NestedQueryList\n          query={query}\n          datasource={datasource}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      )}\n    </>\n  );\n});\n\nPromQueryBuilder.displayName = 'PromQueryBuilder';\n","import React from 'react';\n\nimport { EditorFieldGroup, EditorRow } from '@grafana/experimental';\n\nimport promqlGrammar from '../../promql';\nimport { RawQuery } from '../shared/RawQuery';\n\nexport interface QueryPreviewProps {\n  query: string;\n}\n\nexport function QueryPreview({ query }: QueryPreviewProps) {\n  if (!query) {\n    return null;\n  }\n\n  return (\n    <EditorRow>\n      <EditorFieldGroup>\n        <RawQuery query={query} lang={{ grammar: promqlGrammar, name: 'promql' }} />\n      </EditorFieldGroup>\n    </EditorRow>\n  );\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer } from 'react';\n\nimport { PanelData } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromQuery } from '../../types';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { PromVisualQuery } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\nimport { QueryPreview } from './QueryPreview';\nimport { getSettings, MetricsModalSettings } from './metrics-modal/state/state';\n\nexport interface PromQueryBuilderContainerProps {\n  query: PromQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport interface State {\n  visQuery?: PromVisualQuery;\n  expr: string;\n}\n\nconst prometheusMetricEncyclopedia = config.featureToggles.prometheusMetricEncyclopedia;\n\n/**\n * This component is here just to contain the translation logic between string query and the visual query builder model.\n */\nexport function PromQueryBuilderContainer(props: PromQueryBuilderContainerProps) {\n  const { query, onChange, onRunQuery, datasource, data, showExplain } = props;\n  const [state, dispatch] = useReducer(stateSlice.reducer, { expr: query.expr });\n  // Only rebuild visual query if expr changes from outside\n  useEffect(() => {\n    dispatch(exprChanged(query.expr));\n\n    if (prometheusMetricEncyclopedia) {\n      dispatch(\n        setMetricsModalSettings({\n          useBackend: query.useBackend ?? false,\n          disableTextWrap: query.disableTextWrap ?? false,\n          fullMetaSearch: query.fullMetaSearch ?? false,\n          includeNullMetadata: query.includeNullMetadata ?? true,\n        })\n      );\n    }\n  }, [query]);\n\n  useEffect(() => {\n    datasource.languageProvider.start(data?.timeRange);\n  }, [data?.timeRange, datasource.languageProvider]);\n\n  const onVisQueryChange = (visQuery: PromVisualQuery) => {\n    const expr = promQueryModeller.renderQuery(visQuery);\n    dispatch(visualQueryChange({ visQuery, expr }));\n\n    if (prometheusMetricEncyclopedia) {\n      const metricsModalSettings = getSettings(visQuery);\n      onChange({ ...props.query, expr: expr, ...metricsModalSettings });\n    } else {\n      onChange({ ...props.query, expr: expr });\n    }\n  };\n\n  if (!state.visQuery) {\n    return null;\n  }\n\n  return (\n    <>\n      <PromQueryBuilder\n        query={state.visQuery}\n        datasource={datasource}\n        onChange={onVisQueryChange}\n        onRunQuery={onRunQuery}\n        data={data}\n        showExplain={showExplain}\n      />\n      {<QueryPreview query={query.expr} />}\n    </>\n  );\n}\n\nconst initialState: State = {\n  expr: '',\n};\n\nconst stateSlice = createSlice({\n  name: 'prom-builder-container',\n  initialState,\n  reducers: {\n    visualQueryChange: (state, action: PayloadAction<{ visQuery: PromVisualQuery; expr: string }>) => {\n      state.expr = action.payload.expr;\n      state.visQuery = action.payload.visQuery;\n    },\n    exprChanged: (state, action: PayloadAction<string>) => {\n      if (!state.visQuery || state.expr !== action.payload) {\n        state.expr = action.payload;\n        const parseResult = buildVisualQueryFromString(action.payload ?? '');\n\n        state.visQuery = parseResult.query;\n      }\n    },\n    setMetricsModalSettings: (state, action: PayloadAction<MetricsModalSettings>) => {\n      if (state.visQuery && prometheusMetricEncyclopedia) {\n        state.visQuery.useBackend = action.payload.useBackend;\n        state.visQuery.disableTextWrap = action.payload.disableTextWrap;\n        state.visQuery.fullMetaSearch = action.payload.fullMetaSearch;\n        state.visQuery.includeNullMetadata = action.payload.includeNullMetadata;\n      }\n    },\n  },\n});\n\nconst { visualQueryChange, exprChanged, setMetricsModalSettings } = stateSlice.actions;\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { IconButton, InlineLabel, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\ninterface Props {\n  onChange: (exemplar: boolean) => void;\n  datasource: PrometheusDatasource;\n  query: PromQuery;\n  'data-testid'?: string;\n}\n\nexport function PromExemplarField({ datasource, onChange, query, ...rest }: Props) {\n  const [error, setError] = useState<string | null>(null);\n  const styles = useStyles2(getStyles);\n  const prevError = usePrevious(error);\n\n  useEffect(() => {\n    if (!datasource.exemplarsAvailable) {\n      setError('Exemplars for this query are not available');\n      onChange(false);\n    } else if (query.instant && !query.range) {\n      setError('Exemplars are not available for instant queries');\n      onChange(false);\n    } else {\n      setError(null);\n      // If error is cleared, we want to change exemplar to true\n      if (prevError && !error) {\n        onChange(true);\n      }\n    }\n  }, [datasource.exemplarsAvailable, query.instant, query.range, onChange, prevError, error]);\n\n  const iconButtonStyles = cx(\n    {\n      [styles.activeIcon]: !!query.exemplar,\n    },\n    styles.eyeIcon\n  );\n\n  return (\n    <InlineLabel width=\"auto\" data-testid={rest['data-testid']}>\n      <Tooltip content={error ?? ''}>\n        <div className={styles.iconWrapper}>\n          Exemplars\n          <IconButton\n            name=\"eye\"\n            tooltip={!!query.exemplar ? 'Disable query with exemplars' : 'Enable query with exemplars'}\n            disabled={!!error}\n            className={iconButtonStyles}\n            onClick={() => {\n              onChange(!query.exemplar);\n            }}\n          />\n        </div>\n      </Tooltip>\n    </InlineLabel>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    eyeIcon: css`\n      margin-left: ${theme.spacing(2)};\n    `,\n    activeIcon: css`\n      color: ${theme.colors.primary.main};\n    `,\n    iconWrapper: css`\n      display: flex;\n      align-items: center;\n    `,\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { isEqual } from 'lodash';\nimport React, { memo, useCallback } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { InlineFormLabel, RadioButtonGroup } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\nimport { PromExemplarField } from './PromExemplarField';\n\nexport interface PromExploreExtraFieldProps {\n  query: PromQuery;\n  onChange: (value: PromQuery) => void;\n  onRunQuery: () => void;\n  datasource: PrometheusDatasource;\n}\n\nexport const PromExploreExtraField = memo(({ query, datasource, onChange, onRunQuery }: PromExploreExtraFieldProps) => {\n  const rangeOptions = getQueryTypeOptions(true);\n  const prevQuery = usePrevious(query);\n\n  const onExemplarChange = useCallback(\n    (exemplar: boolean) => {\n      if (!isEqual(query, prevQuery) || exemplar !== query.exemplar) {\n        onChange({ ...query, exemplar });\n      }\n    },\n    [prevQuery, query, onChange]\n  );\n\n  function onChangeQueryStep(interval: string) {\n    onChange({ ...query, interval });\n  }\n\n  function onStepChange(e: React.SyntheticEvent<HTMLInputElement>) {\n    if (e.currentTarget.value !== query.interval) {\n      onChangeQueryStep(e.currentTarget.value);\n    }\n  }\n\n  function onReturnKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === 'Enter' && e.shiftKey) {\n      onRunQuery();\n    }\n  }\n\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  return (\n    <div\n      aria-label=\"Prometheus extra field\"\n      className=\"gf-form-inline\"\n      data-testid={promExploreExtraFieldTestIds.extraFieldEditor}\n    >\n      {/*Query type field*/}\n      <div\n        data-testid={promExploreExtraFieldTestIds.queryTypeField}\n        className={cx(\n          'gf-form explore-input-margin',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Query type field\"\n      >\n        <InlineFormLabel width=\"auto\">Query type</InlineFormLabel>\n\n        <RadioButtonGroup\n          options={rangeOptions}\n          value={query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range'}\n          onChange={onQueryTypeChange}\n        />\n      </div>\n      {/*Step field*/}\n      <div\n        data-testid={promExploreExtraFieldTestIds.stepField}\n        className={cx(\n          'gf-form',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Step field\"\n      >\n        <InlineFormLabel\n          width={6}\n          tooltip={\n            'Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)'\n          }\n        >\n          Min step\n        </InlineFormLabel>\n        <input\n          type={'text'}\n          className=\"gf-form-input width-4\"\n          placeholder={'auto'}\n          onChange={onStepChange}\n          onKeyDown={onReturnKeyDown}\n          value={query.interval ?? ''}\n        />\n      </div>\n\n      <PromExemplarField onChange={onExemplarChange} datasource={datasource} query={query} />\n    </div>\n  );\n});\n\nPromExploreExtraField.displayName = 'PromExploreExtraField';\n\nexport function getQueryTypeOptions(includeBoth: boolean) {\n  const rangeOptions = [\n    { value: 'range', label: 'Range', description: 'Run query over a range of time' },\n    {\n      value: 'instant',\n      label: 'Instant',\n      description: 'Run query against a single point in time. For this query, the \"To\" time is used',\n    },\n  ];\n\n  if (includeBoth) {\n    rangeOptions.push({ value: 'both', label: 'Both', description: 'Run an Instant query and a Range query' });\n  }\n\n  return rangeOptions;\n}\n\nexport function getQueryTypeChangeHandler(query: PromQuery, onChange: (update: PromQuery) => void) {\n  return (queryType: string) => {\n    if (queryType === 'instant') {\n      onChange({ ...query, instant: true, range: false, exemplar: false });\n    } else if (queryType === 'range') {\n      onChange({ ...query, instant: false, range: true });\n    } else {\n      onChange({ ...query, instant: true, range: true });\n    }\n  };\n}\n\nexport const promExploreExtraFieldTestIds = {\n  extraFieldEditor: 'prom-editor-extra-field',\n  stepField: 'prom-editor-extra-field-step',\n  queryTypeField: 'prom-editor-extra-field-query-type',\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport { useToggle } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Collapse, useStyles2, Stack } from '@grafana/ui';\n\nexport interface Props {\n  title: string;\n  collapsedInfo: string[];\n  children: React.ReactNode;\n}\n\nexport function QueryOptionGroup({ title, children, collapsedInfo }: Props) {\n  const [isOpen, toggleOpen] = useToggle(false);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      <Collapse\n        className={styles.collapse}\n        collapsible\n        isOpen={isOpen}\n        onToggle={toggleOpen}\n        label={\n          <Stack gap={0}>\n            <h6 className={styles.title}>{title}</h6>\n            {!isOpen && (\n              <div className={styles.description}>\n                {collapsedInfo.map((x, i) => (\n                  <span key={i}>{x}</span>\n                ))}\n              </div>\n            )}\n          </Stack>\n        }\n      >\n        <div className={styles.body}>{children}</div>\n      </Collapse>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    collapse: css({\n      backgroundColor: 'unset',\n      border: 'unset',\n      marginBottom: 0,\n\n      ['> button']: {\n        padding: theme.spacing(0, 1),\n      },\n    }),\n    wrapper: css({\n      width: '100%',\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'baseline',\n    }),\n    title: css({\n      flexGrow: 1,\n      overflow: 'hidden',\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      margin: 0,\n    }),\n    description: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.bodySmall.fontWeight,\n      paddingLeft: theme.spacing(2),\n      gap: theme.spacing(2),\n      display: 'flex',\n    }),\n    body: css({\n      display: 'flex',\n      gap: theme.spacing(2),\n      flexWrap: 'wrap',\n    }),\n    tooltip: css({\n      marginRight: theme.spacing(0.25),\n    }),\n  };\n};\n","import React, { useRef } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField } from '@grafana/experimental';\nimport { AutoSizeInput, Select } from '@grafana/ui';\n\nimport { LegendFormatMode } from '../../types';\n\nexport interface PromQueryLegendEditorProps {\n  legendFormat: string | undefined;\n  onChange: (legendFormat: string) => void;\n  onRunQuery: () => void;\n}\n\nconst legendModeOptions = [\n  {\n    label: 'Auto',\n    value: LegendFormatMode.Auto,\n    description: 'Only includes unique labels',\n  },\n  { label: 'Verbose', value: LegendFormatMode.Verbose, description: 'All label names and values' },\n  { label: 'Custom', value: LegendFormatMode.Custom, description: 'Provide a naming template' },\n];\n\n/**\n * Tests for this component are on the parent level (PromQueryBuilderOptions).\n */\nexport const PromQueryLegendEditor = React.memo<PromQueryLegendEditorProps>(\n  ({ legendFormat, onChange, onRunQuery }) => {\n    const mode = getLegendMode(legendFormat);\n    const inputRef = useRef<HTMLInputElement | null>(null);\n\n    const onLegendFormatChanged = (evt: React.FormEvent<HTMLInputElement>) => {\n      let newFormat = evt.currentTarget.value;\n      if (newFormat.length === 0) {\n        newFormat = LegendFormatMode.Auto;\n      }\n\n      if (newFormat !== legendFormat) {\n        onChange(newFormat);\n        onRunQuery();\n      }\n    };\n\n    const onLegendModeChanged = (value: SelectableValue<LegendFormatMode>) => {\n      switch (value.value!) {\n        case LegendFormatMode.Auto:\n          onChange(LegendFormatMode.Auto);\n          break;\n        case LegendFormatMode.Custom:\n          onChange('{{label_name}}');\n          setTimeout(() => {\n            inputRef.current?.focus();\n            inputRef.current?.setSelectionRange(2, 12, 'forward');\n          }, 10);\n          break;\n        case LegendFormatMode.Verbose:\n          onChange('');\n          break;\n      }\n      onRunQuery();\n    };\n\n    return (\n      <EditorField\n        label=\"Legend\"\n        tooltip=\"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.\"\n        data-testid={selectors.components.DataSource.Prometheus.queryEditor.legend}\n      >\n        <>\n          {mode === LegendFormatMode.Custom && (\n            <AutoSizeInput\n              id=\"legendFormat\"\n              minWidth={22}\n              placeholder=\"auto\"\n              defaultValue={legendFormat}\n              onCommitChange={onLegendFormatChanged}\n              ref={inputRef}\n            />\n          )}\n          {mode !== LegendFormatMode.Custom && (\n            <Select\n              inputId=\"legend.mode\"\n              isSearchable={false}\n              placeholder=\"Select legend mode\"\n              options={legendModeOptions}\n              width={22}\n              onChange={onLegendModeChanged}\n              value={legendModeOptions.find((x) => x.value === mode)}\n            />\n          )}\n        </>\n      </EditorField>\n    );\n  }\n);\n\nPromQueryLegendEditor.displayName = 'PromQueryLegendEditor';\n\nfunction getLegendMode(legendFormat: string | undefined) {\n  // This special value means the new smart minimal series naming\n  if (legendFormat === LegendFormatMode.Auto) {\n    return LegendFormatMode.Auto;\n  }\n\n  // Missing or empty legend format is the old verbose behavior\n  if (legendFormat == null || legendFormat === '') {\n    return LegendFormatMode.Verbose;\n  }\n\n  return LegendFormatMode.Custom;\n}\n\nexport function getLegendModeLabel(legendFormat: string | undefined) {\n  const mode = getLegendMode(legendFormat);\n  if (mode !== LegendFormatMode.Custom) {\n    return legendModeOptions.find((x) => x.value === mode)?.label;\n  }\n  return legendFormat;\n}\n","import React, { SyntheticEvent } from 'react';\n\nimport { CoreApp, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField, EditorRow, EditorSwitch } from '@grafana/experimental';\nimport { AutoSizeInput, RadioButtonGroup, Select } from '@grafana/ui';\n\nimport { getQueryTypeChangeHandler, getQueryTypeOptions } from '../../components/PromExploreExtraField';\nimport { PromQueryFormat } from '../../dataquery';\nimport { PromQuery } from '../../types';\nimport { QueryOptionGroup } from '../shared/QueryOptionGroup';\n\nimport { FORMAT_OPTIONS, INTERVAL_FACTOR_OPTIONS } from './PromQueryEditorSelector';\nimport { getLegendModeLabel, PromQueryLegendEditor } from './PromQueryLegendEditor';\n\nexport interface UIOptions {\n  exemplars: boolean;\n  type: boolean;\n  format: boolean;\n  minStep: boolean;\n  legend: boolean;\n  resolution: boolean;\n}\n\nexport interface PromQueryBuilderOptionsProps {\n  query: PromQuery;\n  app?: CoreApp;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport const PromQueryBuilderOptions = React.memo<PromQueryBuilderOptionsProps>(\n  ({ query, app, onChange, onRunQuery }) => {\n    const onChangeFormat = (value: SelectableValue<PromQueryFormat>) => {\n      onChange({ ...query, format: value.value });\n      onRunQuery();\n    };\n\n    const onChangeStep = (evt: React.FormEvent<HTMLInputElement>) => {\n      onChange({ ...query, interval: evt.currentTarget.value.trim() });\n      onRunQuery();\n    };\n\n    const queryTypeOptions = getQueryTypeOptions(\n      app === CoreApp.Explore || app === CoreApp.Correlations || app === CoreApp.PanelEditor\n    );\n\n    const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n    const onExemplarChange = (event: SyntheticEvent<HTMLInputElement>) => {\n      const isEnabled = event.currentTarget.checked;\n      onChange({ ...query, exemplar: isEnabled });\n      onRunQuery();\n    };\n\n    const onIntervalFactorChange = (value: SelectableValue<number>) => {\n      onChange({ ...query, intervalFactor: value.value });\n      onRunQuery();\n    };\n\n    const formatOption = FORMAT_OPTIONS.find((option) => option.value === query.format) || FORMAT_OPTIONS[0];\n    const queryTypeValue = getQueryTypeValue(query);\n    const queryTypeLabel = queryTypeOptions.find((x) => x.value === queryTypeValue)!.label;\n\n    return (\n      <EditorRow>\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.options}>\n          <QueryOptionGroup\n            title=\"Options\"\n            collapsedInfo={getCollapsedInfo(query, formatOption.label!, queryTypeLabel, app)}\n          >\n            <PromQueryLegendEditor\n              legendFormat={query.legendFormat}\n              onChange={(legendFormat) => onChange({ ...query, legendFormat })}\n              onRunQuery={onRunQuery}\n            />\n            <EditorField\n              label=\"Min step\"\n              tooltip={\n                <>\n                  An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n                  <code>$__interval</code> and <code>$__rate_interval</code> variables.\n                </>\n              }\n            >\n              <AutoSizeInput\n                type=\"text\"\n                aria-label=\"Set lower limit for the step parameter\"\n                placeholder={'auto'}\n                minWidth={10}\n                onCommitChange={onChangeStep}\n                defaultValue={query.interval}\n                id={selectors.components.DataSource.Prometheus.queryEditor.step}\n              />\n            </EditorField>\n            <EditorField label=\"Format\">\n              <Select\n                data-testid={selectors.components.DataSource.Prometheus.queryEditor.format}\n                value={formatOption}\n                allowCustomValue\n                onChange={onChangeFormat}\n                options={FORMAT_OPTIONS}\n              />\n            </EditorField>\n            <EditorField label=\"Type\" data-testid={selectors.components.DataSource.Prometheus.queryEditor.type}>\n              <RadioButtonGroup options={queryTypeOptions} value={queryTypeValue} onChange={onQueryTypeChange} />\n            </EditorField>\n            {shouldShowExemplarSwitch(query, app) && (\n              <EditorField label=\"Exemplars\">\n                <EditorSwitch\n                  value={query.exemplar || false}\n                  onChange={onExemplarChange}\n                  id={selectors.components.DataSource.Prometheus.queryEditor.exemplars}\n                />\n              </EditorField>\n            )}\n            {query.intervalFactor && query.intervalFactor > 1 && (\n              <EditorField label=\"Resolution\">\n                <Select\n                  aria-label=\"Select resolution\"\n                  isSearchable={false}\n                  options={INTERVAL_FACTOR_OPTIONS}\n                  onChange={onIntervalFactorChange}\n                  value={INTERVAL_FACTOR_OPTIONS.find((option) => option.value === query.intervalFactor)}\n                />\n              </EditorField>\n            )}\n          </QueryOptionGroup>\n        </div>\n      </EditorRow>\n    );\n  }\n);\n\nfunction shouldShowExemplarSwitch(query: PromQuery, app?: CoreApp) {\n  if (app === CoreApp.UnifiedAlerting || !query.range) {\n    return false;\n  }\n\n  return true;\n}\n\nfunction getQueryTypeValue(query: PromQuery) {\n  return query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range';\n}\n\nfunction getCollapsedInfo(query: PromQuery, formatOption: string, queryType: string, app?: CoreApp): string[] {\n  const items: string[] = [];\n\n  items.push(`Legend: ${getLegendModeLabel(query.legendFormat)}`);\n  items.push(`Format: ${formatOption}`);\n  items.push(`Step: ${query.interval ?? 'auto'}`);\n  items.push(`Type: ${queryType}`);\n\n  if (shouldShowExemplarSwitch(query, app)) {\n    if (query.exemplar) {\n      items.push(`Exemplars: true`);\n    } else {\n      items.push(`Exemplars: false`);\n    }\n  }\n  return items;\n}\n\nPromQueryBuilderOptions.displayName = 'PromQueryBuilderOptions';\n","import { isEqual, map } from 'lodash';\nimport React, { SyntheticEvent, useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, LoadingState, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorHeader, EditorRows, FlexItem } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, ConfirmModal, Space } from '@grafana/ui';\n\nimport { PromQueryEditorProps } from '../../components/types';\nimport { PromQueryFormat } from '../../dataquery';\nimport { PromQuery } from '../../types';\nimport { QueryPatternsModal } from '../QueryPatternsModal';\nimport { promQueryEditorExplainKey, useFlag } from '../hooks/useFlag';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { QueryEditorModeToggle } from '../shared/QueryEditorModeToggle';\nimport { QueryHeaderSwitch } from '../shared/QueryHeaderSwitch';\nimport { QueryEditorMode } from '../shared/types';\nimport { changeEditorMode, getQueryWithDefaults } from '../state';\n\nimport { PromQueryBuilderContainer } from './PromQueryBuilderContainer';\nimport { PromQueryBuilderOptions } from './PromQueryBuilderOptions';\nimport { PromQueryCodeEditor } from './PromQueryCodeEditor';\n\nexport const FORMAT_OPTIONS: Array<SelectableValue<PromQueryFormat>> = [\n  { label: 'Time series', value: 'time_series' },\n  { label: 'Table', value: 'table' },\n  { label: 'Heatmap', value: 'heatmap' },\n];\n\nexport const INTERVAL_FACTOR_OPTIONS: Array<SelectableValue<number>> = map([1, 2, 3, 4, 5, 10], (value: number) => ({\n  value,\n  label: '1/' + value,\n}));\n\ntype Props = PromQueryEditorProps;\n\nexport const PromQueryEditorSelector = React.memo<Props>((props) => {\n  const {\n    onChange,\n    onRunQuery,\n    data,\n    app,\n    onAddQuery,\n    datasource: { defaultEditor },\n    queries,\n  } = props;\n\n  const [parseModalOpen, setParseModalOpen] = useState(false);\n  const [queryPatternsModalOpen, setQueryPatternsModalOpen] = useState(false);\n  const [dataIsStale, setDataIsStale] = useState(false);\n  const { flag: explain, setFlag: setExplain } = useFlag(promQueryEditorExplainKey);\n\n  const query = getQueryWithDefaults(props.query, app, defaultEditor);\n  // This should be filled in from the defaults by now.\n  const editorMode = query.editorMode!;\n\n  const onEditorModeChange = useCallback(\n    (newMetricEditorMode: QueryEditorMode) => {\n      reportInteraction('user_grafana_prometheus_editor_mode_clicked', {\n        newEditor: newMetricEditorMode,\n        previousEditor: query.editorMode ?? '',\n        newQuery: !query.expr,\n        app: app ?? '',\n      });\n\n      if (newMetricEditorMode === QueryEditorMode.Builder) {\n        const result = buildVisualQueryFromString(query.expr || '');\n        // If there are errors, give user a chance to decide if they want to go to builder as that can lose some data.\n        if (result.errors.length) {\n          setParseModalOpen(true);\n          return;\n        }\n      }\n      changeEditorMode(query, newMetricEditorMode, onChange);\n    },\n    [onChange, query, app]\n  );\n\n  useEffect(() => {\n    setDataIsStale(false);\n  }, [data]);\n\n  const onChangeInternal = (query: PromQuery) => {\n    if (!isEqual(query, props.query)) {\n      setDataIsStale(true);\n    }\n    onChange(query);\n  };\n\n  const onShowExplainChange = (e: SyntheticEvent<HTMLInputElement>) => {\n    setExplain(e.currentTarget.checked);\n  };\n\n  return (\n    <>\n      <ConfirmModal\n        isOpen={parseModalOpen}\n        title=\"Parsing error: Switch to the builder mode?\"\n        body=\"There is a syntax error, or the query structure cannot be visualized when switching to the builder mode. Parts of the query may be lost. \"\n        confirmText=\"Continue\"\n        onConfirm={() => {\n          changeEditorMode(query, QueryEditorMode.Builder, onChange);\n          setParseModalOpen(false);\n        }}\n        onDismiss={() => setParseModalOpen(false)}\n      />\n      <QueryPatternsModal\n        isOpen={queryPatternsModalOpen}\n        onClose={() => setQueryPatternsModalOpen(false)}\n        query={query}\n        queries={queries}\n        app={app}\n        onChange={onChange}\n        onAddQuery={onAddQuery}\n      />\n      <EditorHeader>\n        <Button\n          data-testid={selectors.components.QueryBuilder.queryPatterns}\n          variant=\"secondary\"\n          size=\"sm\"\n          onClick={() => setQueryPatternsModalOpen((prevValue) => !prevValue)}\n        >\n          Kick start your query\n        </Button>\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.explain}>\n          <QueryHeaderSwitch label=\"Explain\" value={explain} onChange={onShowExplainChange} />\n        </div>\n        <FlexItem grow={1} />\n        {app !== CoreApp.Explore && app !== CoreApp.Correlations && (\n          <Button\n            variant={dataIsStale ? 'primary' : 'secondary'}\n            size=\"sm\"\n            onClick={onRunQuery}\n            icon={data?.state === LoadingState.Loading ? 'spinner' : undefined}\n            disabled={data?.state === LoadingState.Loading}\n          >\n            Run queries\n          </Button>\n        )}\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.editorToggle}>\n          <QueryEditorModeToggle mode={editorMode} onChange={onEditorModeChange} />\n        </div>\n      </EditorHeader>\n      <Space v={0.5} />\n      <EditorRows>\n        {editorMode === QueryEditorMode.Code && (\n          <PromQueryCodeEditor {...props} query={query} showExplain={explain} onChange={onChangeInternal} />\n        )}\n        {editorMode === QueryEditorMode.Builder && (\n          <PromQueryBuilderContainer\n            query={query}\n            datasource={props.datasource}\n            onChange={onChangeInternal}\n            onRunQuery={props.onRunQuery}\n            data={data}\n            showExplain={explain}\n          />\n        )}\n        <PromQueryBuilderOptions query={query} app={props.app} onChange={onChange} onRunQuery={onRunQuery} />\n      </EditorRows>\n    </>\n  );\n});\n\nPromQueryEditorSelector.displayName = 'PromQueryEditorSelector';\n","import React from 'react';\n\nimport { PromQueryField } from './PromQueryField';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorForAlerting(props: PromQueryEditorProps) {\n  const { datasource, query, range, data, onChange, onRunQuery } = props;\n\n  return (\n    <PromQueryField\n      datasource={datasource}\n      query={query}\n      onRunQuery={onRunQuery}\n      onChange={onChange}\n      history={[]}\n      range={range}\n      data={data}\n      data-testid={alertingTestIds.editor}\n    />\n  );\n}\n\nexport const alertingTestIds = {\n  editor: 'prom-editor-cloud-alerting',\n};\n","import React, { memo } from 'react';\n\nimport { CoreApp } from '@grafana/data';\n\nimport { PromQueryEditorSelector } from '../querybuilder/components/PromQueryEditorSelector';\n\nimport { PromQueryEditorForAlerting } from './PromQueryEditorForAlerting';\nimport { PromQueryEditorProps } from './types';\n\nfunction PromQueryEditorByAppBase(props: PromQueryEditorProps) {\n  const { app } = props;\n\n  switch (app) {\n    case CoreApp.CloudAlerting:\n      return <PromQueryEditorForAlerting {...props} />;\n    default:\n      return <PromQueryEditorSelector {...props} />;\n  }\n}\n\nexport const PromQueryEditorByApp = memo(PromQueryEditorByAppBase);\n","import React from 'react';\n\nimport { QueryEditorHelpProps } from '@grafana/data';\n\nimport { PromQuery } from '../types';\n\nconst CHEAT_SHEET_ITEMS = [\n  {\n    title: 'Request Rate',\n    expression: 'rate(http_request_total[5m])',\n    label:\n      'Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes.',\n  },\n  {\n    title: '95th Percentile of Request Latencies',\n    expression: 'histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))',\n    label: 'Calculates the 95th percentile of HTTP request rate over 5 minute windows.',\n  },\n  {\n    title: 'Alerts Firing',\n    expression: 'sort_desc(sum(sum_over_time(ALERTS{alertstate=\"firing\"}[24h])) by (alertname))',\n    label: 'Sums up the alerts that have been firing over the last 24 hours.',\n  },\n  {\n    title: 'Step',\n    label:\n      'Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically.',\n  },\n];\n\nexport const PromCheatSheet = (props: QueryEditorHelpProps<PromQuery>) => (\n  <div>\n    <h2>PromQL Cheat Sheet</h2>\n    {CHEAT_SHEET_ITEMS.map((item, index) => (\n      <div className=\"cheat-sheet-item\" key={index}>\n        <div className=\"cheat-sheet-item__title\">{item.title}</div>\n        {item.expression ? (\n          <button\n            type=\"button\"\n            className=\"cheat-sheet-item__example\"\n            onClick={(e) => props.onClickExample({ refId: 'A', expr: item.expression })}\n          >\n            <code>{item.expression}</code>\n          </button>\n        ) : null}\n        <div className=\"cheat-sheet-item__label\">{item.label}</div>\n      </div>\n    ))}\n  </div>\n);\n","import React from 'react';\n\nimport { QueryEditorHelpProps } from '@grafana/data';\n\nimport { PromQuery } from '../types';\n\nconst CHEAT_SHEET_ITEMS = [\n  {\n    title: 'Request Rate',\n    expression: 'rate(http_request_total[5m])',\n    label:\n      'Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes.',\n  },\n  {\n    title: '95th Percentile of Request Latencies',\n    expression: 'histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))',\n    label: 'Calculates the 95th percentile of HTTP request rate over 5 minute windows.',\n  },\n  {\n    title: 'Alerts Firing',\n    expression: 'sort_desc(sum(sum_over_time(ALERTS{alertstate=\"firing\"}[24h])) by (alertname))',\n    label: 'Sums up the alerts that have been firing over the last 24 hours.',\n  },\n  {\n    title: 'Step',\n    label:\n      'Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically.',\n  },\n];\n\nconst PromCheatSheet = (props: QueryEditorHelpProps<PromQuery>) => (\n  <div>\n    <h2>PromQL Cheat Sheet</h2>\n    {CHEAT_SHEET_ITEMS.map((item, index) => (\n      <div className=\"cheat-sheet-item\" key={index}>\n        <div className=\"cheat-sheet-item__title\">{item.title}</div>\n        {item.expression ? (\n          <button\n            type=\"button\"\n            className=\"cheat-sheet-item__example\"\n            onClick={(e) => props.onClickExample({ refId: 'A', expr: item.expression })}\n          >\n            <code>{item.expression}</code>\n          </button>\n        ) : null}\n        <div className=\"cheat-sheet-item__label\">{item.label}</div>\n      </div>\n    ))}\n  </div>\n);\n\nexport default PromCheatSheet;\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Button, Card, useStyles2 } from '@grafana/ui';\nimport { RawQuery } from 'app/plugins/datasource/prometheus/querybuilder/shared/RawQuery';\n\nimport promqlGrammar from '../promql';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { PromQueryPattern } from './types';\n\ntype Props = {\n  pattern: PromQueryPattern;\n  hasNewQueryOption: boolean;\n  hasPreviousQuery: boolean | string;\n  selectedPatternName: string | null;\n  setSelectedPatternName: (name: string | null) => void;\n  onPatternSelect: (pattern: PromQueryPattern, selectAsNewQuery?: boolean) => void;\n};\n\nexport const QueryPattern = (props: Props) => {\n  const { pattern, onPatternSelect, hasNewQueryOption, hasPreviousQuery, selectedPatternName, setSelectedPatternName } =\n    props;\n\n  const styles = useStyles2(getStyles);\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  return (\n    <Card className={styles.card}>\n      <Card.Heading>{pattern.name}</Card.Heading>\n      <div className={styles.rawQueryContainer}>\n        <RawQuery\n          aria-label={`${pattern.name} raw query`}\n          query={promQueryModeller.renderQuery({\n            labels: [],\n            operations: pattern.operations,\n            binaryQueries: pattern.binaryQueries,\n          })}\n          lang={lang}\n          className={styles.rawQuery}\n        />\n      </div>\n      <Card.Actions>\n        {selectedPatternName !== pattern.name ? (\n          <Button\n            size=\"sm\"\n            aria-label=\"use this query button\"\n            onClick={() => {\n              if (hasPreviousQuery) {\n                // If user has previous query, we need to confirm that they want to apply this query pattern\n                setSelectedPatternName(pattern.name);\n              } else {\n                onPatternSelect(pattern);\n              }\n            }}\n          >\n            Use this query\n          </Button>\n        ) : (\n          <>\n            <div className={styles.spacing}>\n              {`If you would like to use this query, ${\n                hasNewQueryOption\n                  ? 'you can either apply this query pattern or create a new query'\n                  : 'this query pattern will be applied to your current query'\n              }.`}\n            </div>\n            <Button size=\"sm\" aria-label=\"back button\" fill=\"outline\" onClick={() => setSelectedPatternName(null)}>\n              Back\n            </Button>\n            <Button\n              size=\"sm\"\n              aria-label=\"apply query starter button\"\n              onClick={() => {\n                onPatternSelect(pattern);\n              }}\n            >\n              Apply query\n            </Button>\n            {hasNewQueryOption && (\n              <Button\n                size=\"sm\"\n                aria-label=\"create new query button\"\n                onClick={() => {\n                  onPatternSelect(pattern, true);\n                }}\n              >\n                Create new query\n              </Button>\n            )}\n          </>\n        )}\n      </Card.Actions>\n    </Card>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css`\n      width: 49.5%;\n      display: flex;\n      flex-direction: column;\n    `,\n    rawQueryContainer: css`\n      flex-grow: 1;\n    `,\n    rawQuery: css`\n      background-color: ${theme.colors.background.primary};\n      padding: ${theme.spacing(1)};\n      margin-top: ${theme.spacing(1)};\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { capitalize } from 'lodash';\nimport React, { useMemo, useState } from 'react';\n\nimport { CoreApp, DataQuery, GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Collapse, Modal, useStyles2 } from '@grafana/ui';\nimport { getNextRefIdChar } from 'app/core/utils/query';\n\nimport { PromQuery } from '../types';\n\nimport { promQueryModeller } from './PromQueryModeller';\nimport { QueryPattern } from './QueryPattern';\nimport { buildVisualQueryFromString } from './parsing';\nimport { PromQueryPattern, PromQueryPatternType } from './types';\n\ntype Props = {\n  isOpen: boolean;\n  query: PromQuery;\n  queries: DataQuery[] | undefined;\n  app?: CoreApp;\n  onClose: () => void;\n  onChange: (query: PromQuery) => void;\n  onAddQuery?: (query: PromQuery) => void;\n};\n\nexport const QueryPatternsModal = (props: Props) => {\n  const { isOpen, onClose, onChange, onAddQuery, query, queries, app } = props;\n  const [openTabs, setOpenTabs] = useState<string[]>([]);\n  const [selectedPatternName, setSelectedPatternName] = useState<string | null>(null);\n\n  const styles = useStyles2(getStyles);\n  const hasNewQueryOption = !!onAddQuery;\n  const hasPreviousQuery = useMemo(() => {\n    const visualQuery = buildVisualQueryFromString(query.expr ?? '');\n    // has anything entered in the query, metric, labels, operations, or binary queries\n    const hasOperations = visualQuery.query.operations.length > 0,\n      hasMetric = visualQuery.query.metric,\n      hasLabels = visualQuery.query.labels.length > 0,\n      hasBinaryQueries = visualQuery.query.binaryQueries ? visualQuery.query.binaryQueries.length > 0 : false;\n\n    return hasOperations || hasMetric || hasLabels || hasBinaryQueries;\n  }, [query.expr]);\n\n  const onPatternSelect = (pattern: PromQueryPattern, selectAsNewQuery = false) => {\n    const visualQuery = buildVisualQueryFromString(selectAsNewQuery ? '' : query.expr);\n    reportInteraction('grafana_prom_kickstart_your_query_selected', {\n      app: app ?? '',\n      editorMode: query.editorMode,\n      selectedPattern: pattern.name,\n      preSelectedOperationsCount: visualQuery.query.operations.length,\n      preSelectedLabelsCount: visualQuery.query.labels.length,\n      createNewQuery: hasNewQueryOption && selectAsNewQuery,\n    });\n\n    visualQuery.query.operations = pattern.operations;\n    visualQuery.query.binaryQueries = pattern.binaryQueries;\n    if (hasNewQueryOption && selectAsNewQuery) {\n      onAddQuery({\n        ...query,\n        refId: getNextRefIdChar(queries ?? [query]),\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    } else {\n      onChange({\n        ...query,\n        expr: promQueryModeller.renderQuery(visualQuery.query),\n      });\n    }\n    setSelectedPatternName(null);\n    onClose();\n  };\n\n  return (\n    <Modal aria-label=\"Kick start your query modal\" isOpen={isOpen} title=\"Kick start your query\" onDismiss={onClose}>\n      <div className={styles.spacing}>\n        Kick start your query by selecting one of these queries. You can then continue to complete your query.\n      </div>\n      {Object.values(PromQueryPatternType).map((patternType) => {\n        return (\n          <Collapse\n            aria-label={`open and close ${patternType} query starter card`}\n            key={patternType}\n            label={`${capitalize(patternType)} query starters`}\n            isOpen={openTabs.includes(patternType)}\n            collapsible={true}\n            onToggle={() =>\n              setOpenTabs((tabs) =>\n                // close tab if it's already open, otherwise open it\n                tabs.includes(patternType) ? tabs.filter((t) => t !== patternType) : [...tabs, patternType]\n              )\n            }\n          >\n            <div className={styles.cardsContainer}>\n              {promQueryModeller\n                .getQueryPatterns()\n                .filter((pattern) => pattern.type === patternType)\n                .map((pattern) => (\n                  <QueryPattern\n                    key={pattern.name}\n                    pattern={pattern}\n                    hasNewQueryOption={hasNewQueryOption}\n                    hasPreviousQuery={hasPreviousQuery}\n                    onPatternSelect={onPatternSelect}\n                    selectedPatternName={selectedPatternName}\n                    setSelectedPatternName={setSelectedPatternName}\n                  />\n                ))}\n            </div>\n          </Collapse>\n        );\n      })}\n      <Button aria-label=\"close kick start your query modal\" variant=\"secondary\" onClick={onClose}>\n        Close\n      </Button>\n    </Modal>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    cardsContainer: css`\n      display: flex;\n      flex-direction: row;\n      flex-wrap: wrap;\n      justify-content: space-between;\n    `,\n    spacing: css`\n      margin-bottom: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { useCallback, useState } from 'react';\n\nimport store from '../../../../../core/store';\n\nexport const promQueryEditorExplainKey = 'PrometheusQueryEditorExplainDefault';\n\nexport type QueryEditorFlags = typeof promQueryEditorExplainKey;\n\nfunction getFlagValue(key: QueryEditorFlags, defaultValue = false): boolean {\n  const val = store.get(key);\n  return val === undefined ? defaultValue : Boolean(parseInt(val, 10));\n}\n\nfunction setFlagValue(key: QueryEditorFlags, value: boolean) {\n  store.set(key, value ? '1' : '0');\n}\n\ntype UseFlagHookReturnType = { flag: boolean; setFlag: (val: boolean) => void };\n\n/**\n *\n * Use and store value of explain switch in local storage.\n * Needs to be a hook with local state to trigger re-renders.\n */\nexport function useFlag(key: QueryEditorFlags, defaultValue = false): UseFlagHookReturnType {\n  const [flag, updateFlag] = useState(getFlagValue(key, defaultValue));\n  const setter = useCallback(\n    (value: boolean) => {\n      setFlagValue(key, value);\n      updateFlag(value);\n    },\n    [key]\n  );\n\n  return { flag, setFlag: setter };\n}\n","import React from 'react';\n\nimport { RadioButtonGroup } from '@grafana/ui';\n\nimport { QueryEditorMode } from './types';\n\nexport interface Props {\n  mode: QueryEditorMode;\n  onChange: (mode: QueryEditorMode) => void;\n}\n\nconst editorModes = [\n  { label: 'Builder', value: QueryEditorMode.Builder },\n  { label: 'Code', value: QueryEditorMode.Code },\n];\n\nexport function QueryEditorModeToggle({ mode, onChange }: Props) {\n  return (\n    <div data-testid={'QueryEditorModeToggle'}>\n      <RadioButtonGroup options={editorModes} size=\"sm\" value={mode} onChange={onChange} />\n    </div>\n  );\n}\n","import { css } from '@emotion/css';\nimport { uniqueId } from 'lodash';\nimport React, { HTMLProps, useRef } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Switch, useStyles2, Stack } from '@grafana/ui';\n\nexport interface Props extends Omit<HTMLProps<HTMLInputElement>, 'value' | 'ref'> {\n  value?: boolean;\n  label: string;\n}\n\nexport function QueryHeaderSwitch({ label, ...inputProps }: Props) {\n  const dashedLabel = label.replace(' ', '-');\n  const switchIdRef = useRef(uniqueId(`switch-${dashedLabel}`));\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Stack gap={1}>\n      <label htmlFor={switchIdRef.current} className={styles.switchLabel}>\n        {label}\n      </label>\n      <Switch {...inputProps} id={switchIdRef.current} />\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    switchLabel: css({\n      color: theme.colors.text.secondary,\n      cursor: 'pointer',\n      fontSize: theme.typography.bodySmall.fontSize,\n      '&:hover': {\n        color: theme.colors.text.primary,\n      },\n    }),\n  };\n};\n","import { CoreApp } from '@grafana/data';\nimport store from 'app/core/store';\n\nimport { LegendFormatMode, PromQuery } from '../types';\n\nimport { QueryEditorMode } from './shared/types';\n\nconst queryEditorModeDefaultLocalStorageKey = 'PrometheusQueryEditorModeDefault';\n\nexport function changeEditorMode(query: PromQuery, editorMode: QueryEditorMode, onChange: (query: PromQuery) => void) {\n  // If empty query store new mode as default\n  if (query.expr === '') {\n    store.set(queryEditorModeDefaultLocalStorageKey, editorMode);\n  }\n\n  onChange({ ...query, editorMode });\n}\n\nfunction getDefaultEditorMode(expr: string, defaultEditor: QueryEditorMode = QueryEditorMode.Builder): QueryEditorMode {\n  // If we already have an expression default to code view\n  if (expr != null && expr !== '') {\n    return QueryEditorMode.Code;\n  }\n\n  const value: QueryEditorMode = store.get(queryEditorModeDefaultLocalStorageKey);\n  switch (value) {\n    case QueryEditorMode.Builder:\n    case QueryEditorMode.Code:\n      return value;\n    default:\n      return defaultEditor;\n  }\n}\n\n/**\n * Returns query with defaults, and boolean true/false depending on change was required\n */\nexport function getQueryWithDefaults(\n  query: PromQuery & { expr?: string },\n  app: CoreApp | undefined,\n  defaultEditor?: QueryEditorMode\n): PromQuery {\n  let result = query;\n\n  if (!query.editorMode) {\n    result = { ...query, editorMode: getDefaultEditorMode(query.expr, defaultEditor) };\n  }\n\n  // default query expr is now empty string, set in getDefaultQuery\n  // While expr is required in the types, it is not always defined at runtime, so we need to check for undefined and default to an empty string to prevent runtime errors\n  if (!query.expr) {\n    result = { ...result, expr: '', legendFormat: LegendFormatMode.Auto };\n  }\n\n  if (query.range == null && query.instant == null) {\n    // Default to range query\n    result = { ...result, range: true };\n\n    // In explore we default to both instant & range\n    if (app === CoreApp.Explore) {\n      result.instant = true;\n    }\n  }\n\n  // Unified Alerting does not support \"both\" for query type  fall back to \"range\".\n  const isBothInstantAndRange = query.instant && query.range;\n  if (app === CoreApp.UnifiedAlerting && isBothInstantAndRange) {\n    result = { ...result, instant: false, range: true };\n  }\n\n  return result;\n}\n","import { css } from '@emotion/css';\nimport {\n  autoUpdate,\n  flip,\n  offset,\n  shift,\n  useClick,\n  useDismiss,\n  useFloating,\n  useInteractions,\n} from '@floating-ui/react';\nimport React, { useState } from 'react';\n\nimport { GrafanaTheme2, renderMarkdown } from '@grafana/data';\nimport { FlexItem } from '@grafana/experimental';\nimport { Button, Portal, useStyles2 } from '@grafana/ui';\n\nimport { QueryBuilderOperation, QueryBuilderOperationDef } from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  def: QueryBuilderOperationDef;\n}\n\nexport const OperationInfoButton = React.memo<Props>(({ def, operation }) => {\n  const styles = useStyles2(getStyles);\n  const [show, setShow] = useState(false);\n\n  // the order of middleware is important!\n  const middleware = [\n    offset(16),\n    flip({\n      fallbackAxisSideDirection: 'end',\n      // see https://floating-ui.com/docs/flip#combining-with-shift\n      crossAxis: false,\n      boundary: document.body,\n    }),\n    shift(),\n  ];\n\n  const { context, refs, floatingStyles } = useFloating({\n    open: show,\n    placement: 'top',\n    onOpenChange: setShow,\n    middleware,\n    whileElementsMounted: autoUpdate,\n  });\n\n  const click = useClick(context);\n  const dismiss = useDismiss(context);\n\n  const { getReferenceProps, getFloatingProps } = useInteractions([dismiss, click]);\n\n  return (\n    <>\n      <Button\n        title=\"Click to show description\"\n        ref={refs.setReference}\n        icon=\"info-circle\"\n        size=\"sm\"\n        variant=\"secondary\"\n        fill=\"text\"\n        {...getReferenceProps()}\n      />\n      {show && (\n        <Portal>\n          <div ref={refs.setFloating} style={floatingStyles} {...getFloatingProps()} className={styles.docBox}>\n            <div className={styles.docBoxHeader}>\n              <span>{def.renderer(operation, def, '<expr>')}</span>\n              <FlexItem grow={1} />\n              <Button\n                icon=\"times\"\n                onClick={() => setShow(false)}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Remove operation\"\n              />\n            </div>\n            <div\n              className={styles.docBoxBody}\n              dangerouslySetInnerHTML={{ __html: getOperationDocs(def, operation) }}\n            ></div>\n          </div>\n        </Portal>\n      )}\n    </>\n  );\n});\n\nOperationInfoButton.displayName = 'OperationDocs';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    docBox: css({\n      overflow: 'hidden',\n      background: theme.colors.background.primary,\n      border: `1px solid ${theme.colors.border.strong}`,\n      boxShadow: theme.shadows.z3,\n      maxWidth: '600px',\n      padding: theme.spacing(1),\n      borderRadius: theme.shape.radius.default,\n      zIndex: theme.zIndex.tooltip,\n    }),\n    docBoxHeader: css({\n      fontSize: theme.typography.h5.fontSize,\n      fontFamily: theme.typography.fontFamilyMonospace,\n      paddingBottom: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    docBoxBody: css({\n      // The markdown paragraph has a marginBottom this removes it\n      marginBottom: theme.spacing(-1),\n      color: theme.colors.text.secondary,\n    }),\n  };\n};\nfunction getOperationDocs(def: QueryBuilderOperationDef, op: QueryBuilderOperation): string {\n  return renderMarkdown(def.explainHandler ? def.explainHandler(op, def) : def.documentation ?? 'no docs');\n}\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\nimport { DraggableProvided } from 'react-beautiful-dnd';\n\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { FlexItem } from '@grafana/experimental';\nimport { Button, Select, useStyles2 } from '@grafana/ui';\n\nimport { OperationInfoButton } from './OperationInfoButton';\nimport { VisualQueryModeller, QueryBuilderOperation, QueryBuilderOperationDef } from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  def: QueryBuilderOperationDef;\n  index: number;\n  queryModeller: VisualQueryModeller;\n  dragHandleProps?: DraggableProvided['dragHandleProps'];\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n}\n\ninterface State {\n  isOpen?: boolean;\n  alternatives?: Array<SelectableValue<QueryBuilderOperationDef>>;\n}\n\nexport const OperationHeader = React.memo<Props>(\n  ({ operation, def, index, onChange, onRemove, queryModeller, dragHandleProps }) => {\n    const styles = useStyles2(getStyles);\n    const [state, setState] = useState<State>({});\n\n    const onToggleSwitcher = () => {\n      if (state.isOpen) {\n        setState({ ...state, isOpen: false });\n      } else {\n        const alternatives = queryModeller\n          .getAlternativeOperations(def.alternativesKey!)\n          .map((alt) => ({ label: alt.name, value: alt }));\n        setState({ isOpen: true, alternatives });\n      }\n    };\n\n    return (\n      <div className={styles.header}>\n        {!state.isOpen && (\n          <>\n            <div {...dragHandleProps}>{def.name ?? def.id}</div>\n            <FlexItem grow={1} />\n            <div className={`${styles.operationHeaderButtons} operation-header-show-on-hover`}>\n              <Button\n                icon=\"angle-down\"\n                size=\"sm\"\n                onClick={onToggleSwitcher}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Click to view alternative operations\"\n              />\n              <OperationInfoButton def={def} operation={operation} />\n              <Button\n                icon=\"times\"\n                size=\"sm\"\n                onClick={() => onRemove(index)}\n                fill=\"text\"\n                variant=\"secondary\"\n                title=\"Remove operation\"\n              />\n            </div>\n          </>\n        )}\n        {state.isOpen && (\n          <div className={styles.selectWrapper}>\n            <Select\n              autoFocus\n              openMenuOnFocus\n              placeholder=\"Replace with\"\n              options={state.alternatives}\n              isOpen={true}\n              onCloseMenu={onToggleSwitcher}\n              onChange={(value) => {\n                if (value.value) {\n                  // Operation should exist if it is selectable\n                  const newDef = queryModeller.getOperationDef(value.value.id)!;\n\n                  // copy default params, and override with all current params\n                  const newParams = [...newDef.defaultParams];\n                  for (let i = 0; i < Math.min(operation.params.length, newParams.length); i++) {\n                    if (newDef.params[i].type === def.params[i].type) {\n                      newParams[i] = operation.params[i];\n                    }\n                  }\n\n                  const changedOp = { ...operation, params: newParams, id: value.value.id };\n                  onChange(index, def.changeTypeHandler ? def.changeTypeHandler(changedOp, newDef) : changedOp);\n                }\n              }}\n            />\n          </div>\n        )}\n      </div>\n    );\n  }\n);\n\nOperationHeader.displayName = 'OperationHeader';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    header: css({\n      borderBottom: `1px solid ${theme.colors.border.medium}`,\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    operationHeaderButtons: css({\n      opacity: 1,\n    }),\n    selectWrapper: css({\n      paddingRight: theme.spacing(2),\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport React, { ComponentType } from 'react';\n\nimport { GrafanaTheme2, SelectableValue, toOption } from '@grafana/data';\nimport { AutoSizeInput, Button, Checkbox, Select, useStyles2, Stack } from '@grafana/ui';\n\nimport { getOperationParamId } from '../operationUtils';\nimport { QueryBuilderOperationParamDef, QueryBuilderOperationParamEditorProps } from '../shared/types';\n\nexport function getOperationParamEditor(\n  paramDef: QueryBuilderOperationParamDef\n): ComponentType<QueryBuilderOperationParamEditorProps> {\n  if (paramDef.editor) {\n    return paramDef.editor;\n  }\n\n  if (paramDef.options) {\n    return SelectInputParamEditor;\n  }\n\n  switch (paramDef.type) {\n    case 'boolean':\n      return BoolInputParamEditor;\n    case 'number':\n    case 'string':\n    default:\n      return SimpleInputParamEditor;\n  }\n}\n\nfunction SimpleInputParamEditor(props: QueryBuilderOperationParamEditorProps) {\n  return (\n    <AutoSizeInput\n      id={getOperationParamId(props.operationId, props.index)}\n      defaultValue={props.value?.toString()}\n      minWidth={props.paramDef.minWidth}\n      placeholder={props.paramDef.placeholder}\n      title={props.paramDef.description}\n      maxWidth={(props.paramDef.minWidth || 20) * 3}\n      onCommitChange={(evt) => {\n        props.onChange(props.index, evt.currentTarget.value);\n        if (props.paramDef.runQueryOnEnter && evt.type === 'keydown') {\n          props.onRunQuery();\n        }\n      }}\n    />\n  );\n}\n\nfunction BoolInputParamEditor(props: QueryBuilderOperationParamEditorProps) {\n  return (\n    <Checkbox\n      id={getOperationParamId(props.operationId, props.index)}\n      value={Boolean(props.value)}\n      onChange={(evt) => props.onChange(props.index, evt.currentTarget.checked)}\n    />\n  );\n}\n\nfunction SelectInputParamEditor({\n  paramDef,\n  value,\n  index,\n  operationId,\n  onChange,\n}: QueryBuilderOperationParamEditorProps) {\n  const styles = useStyles2(getStyles);\n  let selectOptions = paramDef.options as SelectableValue[];\n\n  if (!selectOptions[0]?.label) {\n    selectOptions = paramDef.options!.map((option) => ({\n      label: option.toString(),\n      value: option,\n    }));\n  }\n\n  let valueOption = selectOptions.find((x) => x.value === value) ?? toOption(value as string);\n\n  // If we have optional options param and don't have value, we want to render button with which we add optional options.\n  // This makes it easier to understand what needs to be selected and what is optional.\n  if (!value && paramDef.optional) {\n    return (\n      <div className={styles.optionalParam}>\n        <Button\n          size=\"sm\"\n          variant=\"secondary\"\n          title={`Add ${paramDef.name}`}\n          icon=\"plus\"\n          onClick={() => onChange(index, selectOptions[0].value)}\n        >\n          {paramDef.name}\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <Stack gap={0.5} direction=\"row\" alignItems=\"center\">\n      <Select\n        id={getOperationParamId(operationId, index)}\n        value={valueOption}\n        options={selectOptions}\n        placeholder={paramDef.placeholder}\n        allowCustomValue={true}\n        onChange={(value) => onChange(index, value.value!)}\n        width={paramDef.minWidth || 'auto'}\n      />\n      {paramDef.optional && (\n        <Button\n          data-testid={`operations.${index}.remove-param`}\n          size=\"sm\"\n          fill=\"text\"\n          icon=\"times\"\n          variant=\"secondary\"\n          title={`Remove ${paramDef.name}`}\n          onClick={() => onChange(index, '')}\n        />\n      )}\n    </Stack>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    optionalParam: css({\n      marginTop: theme.spacing(1),\n    }),\n  };\n};\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useId, useState } from 'react';\nimport { Draggable } from 'react-beautiful-dnd';\n\nimport { DataSourceApi, GrafanaTheme2, TimeRange } from '@grafana/data';\nimport { Button, Icon, InlineField, Tooltip, useTheme2, Stack } from '@grafana/ui';\nimport { isConflictingFilter } from 'app/plugins/datasource/loki/querybuilder/operationUtils';\nimport { LokiOperationId } from 'app/plugins/datasource/loki/querybuilder/types';\n\nimport { getOperationParamId } from '../operationUtils';\n\nimport { OperationHeader } from './OperationHeader';\nimport { getOperationParamEditor } from './OperationParamEditor';\nimport {\n  QueryBuilderOperation,\n  QueryBuilderOperationDef,\n  QueryBuilderOperationParamDef,\n  QueryBuilderOperationParamValue,\n  VisualQueryModeller,\n} from './types';\n\nexport interface Props {\n  operation: QueryBuilderOperation;\n  index: number;\n  query: any;\n  datasource: DataSourceApi;\n  queryModeller: VisualQueryModeller;\n  onChange: (index: number, update: QueryBuilderOperation) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  flash?: boolean;\n  highlight?: boolean;\n  timeRange?: TimeRange;\n}\n\nexport function OperationEditor({\n  operation,\n  index,\n  onRemove,\n  onChange,\n  onRunQuery,\n  queryModeller,\n  query,\n  datasource,\n  flash,\n  highlight,\n  timeRange,\n}: Props) {\n  const def = queryModeller.getOperationDef(operation.id);\n  const shouldFlash = useFlash(flash);\n  const id = useId();\n\n  const isConflicting =\n    operation.id === LokiOperationId.LabelFilter && isConflictingFilter(operation, query.operations);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme, isConflicting);\n\n  if (!def) {\n    return <span>Operation {operation.id} not found</span>;\n  }\n\n  const onParamValueChanged = (paramIdx: number, value: QueryBuilderOperationParamValue) => {\n    const update: QueryBuilderOperation = { ...operation, params: [...operation.params] };\n    update.params[paramIdx] = value;\n    callParamChangedThenOnChange(def, update, index, paramIdx, onChange);\n  };\n\n  const onAddRestParam = () => {\n    const update: QueryBuilderOperation = { ...operation, params: [...operation.params, ''] };\n    callParamChangedThenOnChange(def, update, index, operation.params.length, onChange);\n  };\n\n  const onRemoveRestParam = (paramIdx: number) => {\n    const update: QueryBuilderOperation = {\n      ...operation,\n      params: [...operation.params.slice(0, paramIdx), ...operation.params.slice(paramIdx + 1)],\n    };\n    callParamChangedThenOnChange(def, update, index, paramIdx, onChange);\n  };\n\n  const operationElements: React.ReactNode[] = [];\n\n  for (let paramIndex = 0; paramIndex < operation.params.length; paramIndex++) {\n    const paramDef = def.params[Math.min(def.params.length - 1, paramIndex)];\n    const Editor = getOperationParamEditor(paramDef);\n\n    operationElements.push(\n      <div className={styles.paramRow} key={`${paramIndex}-1`}>\n        {!paramDef.hideName && (\n          <div className={styles.paramName}>\n            <label htmlFor={getOperationParamId(id, paramIndex)}>{paramDef.name}</label>\n            {paramDef.description && (\n              <Tooltip placement=\"top\" content={paramDef.description} theme=\"info\">\n                <Icon name=\"info-circle\" size=\"sm\" className={styles.infoIcon} />\n              </Tooltip>\n            )}\n          </div>\n        )}\n        <div className={styles.paramValue}>\n          <Stack gap={0.5} direction=\"row\" alignItems=\"center\">\n            <Editor\n              index={paramIndex}\n              paramDef={paramDef}\n              value={operation.params[paramIndex]}\n              operation={operation}\n              operationId={id}\n              onChange={onParamValueChanged}\n              onRunQuery={onRunQuery}\n              query={query}\n              datasource={datasource}\n              timeRange={timeRange}\n            />\n            {paramDef.restParam && (operation.params.length > def.params.length || paramDef.optional) && (\n              <Button\n                data-testid={`operations.${index}.remove-rest-param`}\n                size=\"sm\"\n                fill=\"text\"\n                icon=\"times\"\n                variant=\"secondary\"\n                title={`Remove ${paramDef.name}`}\n                onClick={() => onRemoveRestParam(paramIndex)}\n              />\n            )}\n          </Stack>\n        </div>\n      </div>\n    );\n  }\n\n  // Handle adding button for rest params\n  let restParam: React.ReactNode | undefined;\n  if (def.params.length > 0) {\n    const lastParamDef = def.params[def.params.length - 1];\n    if (lastParamDef.restParam) {\n      restParam = renderAddRestParamButton(lastParamDef, onAddRestParam, index, operation.params.length, styles);\n    }\n  }\n\n  const isInvalid = (isDragging: boolean) => {\n    if (isDragging) {\n      return undefined;\n    }\n\n    return isConflicting ? true : undefined;\n  };\n\n  return (\n    <Draggable draggableId={`operation-${index}`} index={index}>\n      {(provided, snapshot) => (\n        <InlineField\n          error={'You have conflicting label filters'}\n          invalid={isInvalid(snapshot.isDragging)}\n          className={cx(styles.error, styles.cardWrapper)}\n        >\n          <div\n            className={cx(\n              styles.card,\n              (shouldFlash || highlight) && styles.cardHighlight,\n              isConflicting && styles.cardError\n            )}\n            ref={provided.innerRef}\n            {...provided.draggableProps}\n            data-testid={`operations.${index}.wrapper`}\n          >\n            <OperationHeader\n              operation={operation}\n              dragHandleProps={provided.dragHandleProps}\n              def={def}\n              index={index}\n              onChange={onChange}\n              onRemove={onRemove}\n              queryModeller={queryModeller}\n            />\n            <div className={styles.body}>{operationElements}</div>\n            {restParam}\n            {index < query.operations.length - 1 && (\n              <div className={styles.arrow}>\n                <div className={styles.arrowLine} />\n                <div className={styles.arrowArrow} />\n              </div>\n            )}\n          </div>\n        </InlineField>\n      )}\n    </Draggable>\n  );\n}\n\n/**\n * When flash is switched on makes sure it is switched of right away, so we just flash the highlight and then fade\n * out.\n * @param flash\n */\nfunction useFlash(flash?: boolean) {\n  const [keepFlash, setKeepFlash] = useState(true);\n  useEffect(() => {\n    let t: ReturnType<typeof setTimeout>;\n    if (flash) {\n      t = setTimeout(() => {\n        setKeepFlash(false);\n      }, 1000);\n    } else {\n      setKeepFlash(true);\n    }\n\n    return () => clearTimeout(t);\n  }, [flash]);\n\n  return keepFlash && flash;\n}\n\nfunction renderAddRestParamButton(\n  paramDef: QueryBuilderOperationParamDef,\n  onAddRestParam: () => void,\n  operationIndex: number,\n  paramIndex: number,\n  styles: OperationEditorStyles\n) {\n  return (\n    <div className={styles.restParam} key={`${paramIndex}-2`}>\n      <Button\n        size=\"sm\"\n        icon=\"plus\"\n        title={`Add ${paramDef.name}`.trimEnd()}\n        variant=\"secondary\"\n        onClick={onAddRestParam}\n        data-testid={`operations.${operationIndex}.add-rest-param`}\n      >\n        {paramDef.name}\n      </Button>\n    </div>\n  );\n}\n\nfunction callParamChangedThenOnChange(\n  def: QueryBuilderOperationDef,\n  operation: QueryBuilderOperation,\n  operationIndex: number,\n  paramIndex: number,\n  onChange: (index: number, update: QueryBuilderOperation) => void\n) {\n  if (def.paramChangedHandler) {\n    onChange(operationIndex, def.paramChangedHandler(paramIndex, operation, def));\n  } else {\n    onChange(operationIndex, operation);\n  }\n}\n\nconst getStyles = (theme: GrafanaTheme2, isConflicting: boolean) => {\n  return {\n    cardWrapper: css({\n      alignItems: 'stretch',\n    }),\n    error: css({\n      marginBottom: theme.spacing(1),\n    }),\n    card: css({\n      background: theme.colors.background.primary,\n      border: `1px solid ${theme.colors.border.medium}`,\n      cursor: 'grab',\n      borderRadius: theme.shape.radius.default,\n      position: 'relative',\n      transition: 'all 0.5s ease-in 0s',\n      height: isConflicting ? 'auto' : '100%',\n    }),\n    cardError: css({\n      boxShadow: `0px 0px 4px 0px ${theme.colors.warning.main}`,\n      border: `1px solid ${theme.colors.warning.main}`,\n    }),\n    cardHighlight: css({\n      boxShadow: `0px 0px 4px 0px ${theme.colors.primary.border}`,\n      border: `1px solid ${theme.colors.primary.border}`,\n    }),\n    infoIcon: css({\n      marginLeft: theme.spacing(0.5),\n      color: theme.colors.text.secondary,\n      ':hover': {\n        color: theme.colors.text.primary,\n      },\n    }),\n    body: css({\n      margin: theme.spacing(1, 1, 0.5, 1),\n      display: 'table',\n    }),\n    paramRow: css({\n      label: 'paramRow',\n      display: 'table-row',\n      verticalAlign: 'middle',\n    }),\n    paramName: css({\n      display: 'table-cell',\n      padding: theme.spacing(0, 1, 0, 0),\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      verticalAlign: 'middle',\n      height: '32px',\n    }),\n    paramValue: css({\n      label: 'paramValue',\n      display: 'table-cell',\n      verticalAlign: 'middle',\n    }),\n    restParam: css({\n      padding: theme.spacing(0, 1, 1, 1),\n    }),\n    arrow: css({\n      position: 'absolute',\n      top: '0',\n      right: '-18px',\n      display: 'flex',\n    }),\n    arrowLine: css({\n      height: '2px',\n      width: '8px',\n      backgroundColor: theme.colors.border.strong,\n      position: 'relative',\n      top: '14px',\n    }),\n    arrowArrow: css({\n      width: 0,\n      height: 0,\n      borderTop: `5px solid transparent`,\n      borderBottom: `5px solid transparent`,\n      borderLeft: `7px solid ${theme.colors.border.strong}`,\n      position: 'relative',\n      top: '10px',\n    }),\n  };\n};\n\ntype OperationEditorStyles = ReturnType<typeof getStyles>;\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\nimport { DragDropContext, Droppable, DropResult } from 'react-beautiful-dnd';\nimport { useMountedState, usePrevious } from 'react-use';\n\nimport { DataSourceApi, GrafanaTheme2, TimeRange } from '@grafana/data';\nimport { Button, Cascader, CascaderOption, useStyles2, Stack } from '@grafana/ui';\n\nimport { OperationEditor } from './OperationEditor';\nimport { QueryBuilderOperation, QueryWithOperations, VisualQueryModeller } from './types';\n\nexport interface Props<T extends QueryWithOperations> {\n  query: T;\n  datasource: DataSourceApi;\n  onChange: (query: T) => void;\n  onRunQuery: () => void;\n  queryModeller: VisualQueryModeller;\n  explainMode?: boolean;\n  highlightedOp?: QueryBuilderOperation;\n  timeRange?: TimeRange;\n}\n\nexport function OperationList<T extends QueryWithOperations>({\n  query,\n  datasource,\n  queryModeller,\n  onChange,\n  onRunQuery,\n  highlightedOp,\n  timeRange,\n}: Props<T>) {\n  const styles = useStyles2(getStyles);\n  const { operations } = query;\n\n  const opsToHighlight = useOperationsHighlight(operations);\n\n  const [cascaderOpen, setCascaderOpen] = useState(false);\n\n  const onOperationChange = (index: number, update: QueryBuilderOperation) => {\n    const updatedList = [...operations];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...operations.slice(0, index), ...operations.slice(index + 1)];\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const addOptions: CascaderOption[] = queryModeller.getCategories().map((category) => {\n    return {\n      value: category,\n      label: category,\n      items: queryModeller.getOperationsForCategory(category).map((operation) => ({\n        value: operation.id,\n        label: operation.name,\n        isLeaf: true,\n      })),\n    };\n  });\n\n  const onAddOperation = (value: string) => {\n    const operationDef = queryModeller.getOperationDef(value);\n    if (!operationDef) {\n      return;\n    }\n    onChange(operationDef.addOperationHandler(operationDef, query, queryModeller));\n    setCascaderOpen(false);\n  };\n\n  const onDragEnd = (result: DropResult) => {\n    if (!result.destination) {\n      return;\n    }\n\n    const updatedList = [...operations];\n    const element = updatedList[result.source.index];\n    updatedList.splice(result.source.index, 1);\n    updatedList.splice(result.destination.index, 0, element);\n    onChange({ ...query, operations: updatedList });\n  };\n\n  const onCascaderBlur = () => {\n    setCascaderOpen(false);\n  };\n\n  return (\n    <Stack gap={1} direction=\"column\">\n      <Stack gap={1}>\n        {operations.length > 0 && (\n          <DragDropContext onDragEnd={onDragEnd}>\n            <Droppable droppableId=\"sortable-field-mappings\" direction=\"horizontal\">\n              {(provided) => (\n                <div className={styles.operationList} ref={provided.innerRef} {...provided.droppableProps}>\n                  {operations.map((op, index) => {\n                    return (\n                      <OperationEditor\n                        key={op.id + JSON.stringify(op.params) + index}\n                        queryModeller={queryModeller}\n                        index={index}\n                        operation={op}\n                        query={query}\n                        datasource={datasource}\n                        onChange={onOperationChange}\n                        onRemove={onRemove}\n                        onRunQuery={onRunQuery}\n                        flash={opsToHighlight[index]}\n                        highlight={highlightedOp === op}\n                        timeRange={timeRange}\n                      />\n                    );\n                  })}\n                  {provided.placeholder}\n                </div>\n              )}\n            </Droppable>\n          </DragDropContext>\n        )}\n        <div className={styles.addButton}>\n          {cascaderOpen ? (\n            <Cascader\n              options={addOptions}\n              onSelect={onAddOperation}\n              onBlur={onCascaderBlur}\n              autoFocus={true}\n              alwaysOpen={true}\n              hideActiveLevelLabel={true}\n              placeholder={'Search'}\n            />\n          ) : (\n            <Button icon={'plus'} variant={'secondary'} onClick={() => setCascaderOpen(true)} title={'Add operation'}>\n              Operations\n            </Button>\n          )}\n        </div>\n      </Stack>\n    </Stack>\n  );\n}\n\n/**\n * Returns indexes of operations that should be highlighted. We check the diff of operations added but at the same time\n * we want to highlight operations only after the initial render, so we check for mounted state and calculate the diff\n * only after.\n * @param operations\n */\nfunction useOperationsHighlight(operations: QueryBuilderOperation[]) {\n  const isMounted = useMountedState();\n  const prevOperations = usePrevious(operations);\n\n  if (!isMounted()) {\n    return operations.map(() => false);\n  }\n\n  if (!prevOperations) {\n    return operations.map(() => true);\n  }\n\n  let newOps: boolean[] = [];\n\n  if (prevOperations.length - 1 === operations.length && operations.every((op) => prevOperations.includes(op))) {\n    // In case we remove one op and does not change any ops then don't highlight anything.\n    return operations.map(() => false);\n  }\n  if (prevOperations.length + 1 === operations.length && prevOperations.every((op) => operations.includes(op))) {\n    // If we add a single op just find it and highlight just that.\n    const newOp = operations.find((op) => !prevOperations.includes(op));\n    newOps = operations.map((op) => {\n      return op === newOp;\n    });\n  } else {\n    // Default diff of all ops.\n    newOps = operations.map((op, index) => {\n      return !isSameOp(op.id, prevOperations[index]?.id);\n    });\n  }\n  return newOps;\n}\n\nfunction isSameOp(op1?: string, op2?: string) {\n  return op1 === op2 || `__${op1}_by` === op2 || op1 === `__${op2}_by`;\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    heading: css({\n      label: 'heading',\n      fontSize: 12,\n      fontWeight: theme.typography.fontWeightMedium,\n      marginBottom: 0,\n    }),\n    operationList: css({\n      label: 'operationList',\n      display: 'flex',\n      flexWrap: 'wrap',\n      gap: theme.spacing(2),\n    }),\n    addButton: css({\n      label: 'addButton',\n      width: 126,\n      paddingBottom: theme.spacing(1),\n    }),\n  };\n};\n","import { css } from '@emotion/css';\nimport React, { useState, useEffect } from 'react';\n\nimport { GrafanaTheme2, PanelData, QueryHint } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Tooltip, useStyles2 } from '@grafana/ui';\nimport { LokiDatasource } from 'app/plugins/datasource/loki/datasource';\n\nimport { PrometheusDatasource } from '../../datasource';\n\nimport { LokiAndPromQueryModellerBase, PromLokiVisualQuery } from './LokiAndPromQueryModellerBase';\n\nexport interface Props<T extends PromLokiVisualQuery> {\n  query: T;\n  datasource: PrometheusDatasource | LokiDatasource;\n  queryModeller: LokiAndPromQueryModellerBase;\n  buildVisualQueryFromString: (expr: string) => { query: T };\n  onChange: (update: T) => void;\n  data?: PanelData;\n}\n\nexport const QueryBuilderHints = <T extends PromLokiVisualQuery>({\n  datasource,\n  query: visualQuery,\n  onChange,\n  data,\n  queryModeller,\n  buildVisualQueryFromString,\n}: Props<T>) => {\n  const [hints, setHints] = useState<QueryHint[]>([]);\n  const styles = useStyles2(getStyles);\n\n  useEffect(() => {\n    const query = { expr: queryModeller.renderQuery(visualQuery), refId: '' };\n    // For now show only actionable hints\n    const hints = datasource.getQueryHints(query, data?.series || []).filter((hint) => hint.fix?.action);\n    setHints(hints);\n  }, [datasource, visualQuery, data, queryModeller]);\n\n  return (\n    <>\n      {hints.length > 0 && (\n        <div className={styles.container}>\n          {hints.map((hint) => {\n            return (\n              <Tooltip content={`${hint.label} ${hint.fix?.label}`} key={hint.type}>\n                <Button\n                  onClick={() => {\n                    reportInteraction('grafana_query_builder_hints_clicked', {\n                      hint: hint.type,\n                      datasourceType: datasource.type,\n                    });\n\n                    if (hint?.fix?.action) {\n                      const query = { expr: queryModeller.renderQuery(visualQuery), refId: '' };\n                      const newQuery = datasource.modifyQuery(query, hint.fix.action);\n                      const newVisualQuery = buildVisualQueryFromString(newQuery.expr);\n                      return onChange(newVisualQuery.query);\n                    }\n                  }}\n                  fill=\"outline\"\n                  size=\"sm\"\n                  className={styles.hint}\n                >\n                  hint: {hint.fix?.title || hint.fix?.action?.type.toLowerCase().replace('_', ' ')}\n                </Button>\n              </Tooltip>\n            );\n          })}\n        </div>\n      )}\n    </>\n  );\n};\n\nQueryBuilderHints.displayName = 'QueryBuilderHints';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    container: css`\n      display: flex;\n      align-items: start;\n    `,\n    hint: css`\n      margin-right: ${theme.spacing(1)};\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, toOption } from '@grafana/data';\nimport { EditorRows, FlexItem } from '@grafana/experimental';\nimport { AutoSizeInput, IconButton, Select, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { binaryScalarDefs } from '../binaryScalarOperations';\nimport { PromVisualQueryBinary } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\n\nexport interface Props {\n  nestedQuery: PromVisualQueryBinary;\n  datasource: PrometheusDatasource;\n  index: number;\n  onChange: (index: number, update: PromVisualQueryBinary) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport const NestedQuery = React.memo<Props>((props) => {\n  const { nestedQuery, index, datasource, onChange, onRemove, onRunQuery, showExplain } = props;\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.card}>\n      <div className={styles.header}>\n        <div className={styles.name}>Operator</div>\n        <Select\n          width=\"auto\"\n          options={operators}\n          value={toOption(nestedQuery.operator)}\n          onChange={(value) => {\n            onChange(index, {\n              ...nestedQuery,\n              operator: value.value!,\n            });\n          }}\n        />\n        <div className={styles.name}>Vector matches</div>\n        <div className={styles.vectorMatchWrapper}>\n          <Select<PromVisualQueryBinary['vectorMatchesType']>\n            width=\"auto\"\n            value={nestedQuery.vectorMatchesType || 'on'}\n            allowCustomValue\n            options={[\n              { value: 'on', label: 'on' },\n              { value: 'ignoring', label: 'ignoring' },\n            ]}\n            onChange={(val) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatchesType: val.value,\n              });\n            }}\n          />\n          <AutoSizeInput\n            className={styles.vectorMatchInput}\n            minWidth={20}\n            defaultValue={nestedQuery.vectorMatches}\n            onCommitChange={(evt) => {\n              onChange(index, {\n                ...nestedQuery,\n                vectorMatches: evt.currentTarget.value,\n                vectorMatchesType: nestedQuery.vectorMatchesType || 'on',\n              });\n            }}\n          />\n        </div>\n        <FlexItem grow={1} />\n        <IconButton name=\"times\" size=\"sm\" onClick={() => onRemove(index)} tooltip=\"Remove match\" />\n      </div>\n      <div className={styles.body}>\n        <EditorRows>\n          <PromQueryBuilder\n            showExplain={showExplain}\n            query={nestedQuery.query}\n            datasource={datasource}\n            onRunQuery={onRunQuery}\n            onChange={(update) => {\n              onChange(index, { ...nestedQuery, query: update });\n            }}\n          />\n        </EditorRows>\n      </div>\n    </div>\n  );\n});\n\nconst operators = binaryScalarDefs.map((def) => ({ label: def.sign, value: def.sign }));\n\nNestedQuery.displayName = 'NestedQuery';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css({\n      label: 'card',\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(0.5),\n    }),\n    header: css({\n      label: 'header',\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      gap: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    name: css({\n      label: 'name',\n      whiteSpace: 'nowrap',\n    }),\n    body: css({\n      label: 'body',\n      paddingLeft: theme.spacing(2),\n    }),\n    vectorMatchInput: css({\n      label: 'vectorMatchInput',\n      marginLeft: -1,\n    }),\n    vectorMatchWrapper: css({\n      label: 'vectorMatchWrapper',\n      display: 'flex',\n    }),\n  };\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromVisualQuery, PromVisualQueryBinary } from '../types';\n\nimport { NestedQuery } from './NestedQuery';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (query: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  showExplain: boolean;\n}\n\nexport function NestedQueryList(props: Props) {\n  const { query, datasource, onChange, onRunQuery, showExplain } = props;\n  const nestedQueries = query.binaryQueries ?? [];\n\n  const onNestedQueryUpdate = (index: number, update: PromVisualQueryBinary) => {\n    const updatedList = [...nestedQueries];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...nestedQueries.slice(0, index), ...nestedQueries.slice(index + 1)];\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  return (\n    <Stack direction=\"column\" gap={1}>\n      {nestedQueries.map((nestedQuery, index) => (\n        <NestedQuery\n          key={index.toString()}\n          nestedQuery={nestedQuery}\n          index={index}\n          onChange={onNestedQueryUpdate}\n          datasource={datasource}\n          onRemove={onRemove}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      ))}\n    </Stack>\n  );\n}\n","import { cx } from '@emotion/css';\nimport React, { FormEvent, useState } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, RadioButtonList, Spinner, TextArea, Toggletip, useTheme2 } from '@grafana/ui';\n\nimport { buildVisualQueryFromString } from '../../parsing';\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles } from './PromQail';\nimport { QuerySuggestion } from './types';\n\nexport type Props = {\n  querySuggestion: QuerySuggestion;\n  order: number;\n  queryExplain: (idx: number) => void;\n  historical: boolean;\n  onChange: (query: PromVisualQuery) => void;\n  closeDrawer: () => void;\n  last: boolean;\n  prompt: string;\n  allSuggestions: string | undefined;\n};\n\nconst suggestionOptions: SelectableValue[] = [\n  { label: 'Yes', value: 'yes' },\n  { label: 'No', value: 'no' },\n];\nconst explationOptions: SelectableValue[] = [\n  { label: 'Too vague', value: 'too vague' },\n  { label: 'Too technical', value: 'too technical' },\n  { label: 'Inaccurate', value: 'inaccurate' },\n  { label: 'Other', value: 'other' },\n];\n\nexport function QuerySuggestionItem(props: Props) {\n  const { querySuggestion, order, queryExplain, historical, onChange, closeDrawer, last, allSuggestions, prompt } =\n    props;\n  const [showExp, updShowExp] = useState<boolean>(false);\n\n  const [gaveExplanationFeedback, updateGaveExplanationFeedback] = useState<boolean>(false);\n  const [gaveSuggestionFeedback, updateGaveSuggestionFeedback] = useState<boolean>(false);\n\n  const [suggestionFeedback, setSuggestionFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const [explanationFeedback, setExplanationFeedback] = useState({\n    radioInput: '',\n    text: '',\n  });\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const { query, explanation } = querySuggestion;\n\n  const feedbackToggleTip = (type: string) => {\n    const updateRadioFeedback = (value: string) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          radioInput: value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          radioInput: value,\n        });\n      }\n    };\n\n    const updateTextFeedback = (e: FormEvent<HTMLTextAreaElement>) => {\n      if (type === 'explanation') {\n        setExplanationFeedback({\n          ...explanationFeedback,\n          text: e.currentTarget.value,\n        });\n      } else {\n        setSuggestionFeedback({\n          ...suggestionFeedback,\n          text: e.currentTarget.value,\n        });\n      }\n    };\n\n    const disabledButton = () =>\n      type === 'explanation' ? !explanationFeedback.radioInput : !suggestionFeedback.radioInput;\n\n    const questionOne =\n      type === 'explanation' ? 'Why was the explanation not helpful?' : 'Were the query suggestions helpful?';\n\n    return (\n      <div className={styles.suggestionFeedback}>\n        <div>\n          <div className={styles.feedbackQuestion}>\n            <h6>{questionOne}</h6>\n            <i>(Required)</i>\n          </div>\n          <RadioButtonList\n            name=\"default\"\n            options={type === 'explanation' ? explationOptions : suggestionOptions}\n            value={type === 'explanation' ? explanationFeedback.radioInput : suggestionFeedback.radioInput}\n            onChange={updateRadioFeedback}\n          />\n        </div>\n        <div className={cx(type === 'explanation' && styles.explationTextInput)}>\n          {type !== 'explanation' && (\n            <div className={styles.feedbackQuestion}>\n              <h6>How can we improve the query suggestions?</h6>\n            </div>\n          )}\n          <TextArea\n            type=\"text\"\n            aria-label=\"Promqail suggestion text\"\n            placeholder=\"Enter your feedback\"\n            value={type === 'explanation' ? explanationFeedback.text : suggestionFeedback.text}\n            onChange={updateTextFeedback}\n            cols={100}\n          />\n        </div>\n\n        <div className={styles.submitFeedback}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            disabled={disabledButton()}\n            onClick={() => {\n              // submit the rudderstack event\n              if (type === 'explanation') {\n                explanationFeedbackEvent(\n                  explanationFeedback.radioInput,\n                  explanationFeedback.text,\n                  querySuggestion,\n                  historical,\n                  prompt\n                );\n                updateGaveExplanationFeedback(true);\n              } else {\n                suggestionFeedbackEvent(\n                  suggestionFeedback.radioInput,\n                  suggestionFeedback.text,\n                  allSuggestions ?? '',\n                  historical,\n                  prompt\n                );\n                updateGaveSuggestionFeedback(true);\n              }\n            }}\n          >\n            Submit\n          </Button>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <>\n      <div className={styles.querySuggestion}>\n        <div title={query} className={cx(styles.codeText, styles.longCode)}>\n          {`${order}.  ${query}`}\n        </div>\n        <div className={styles.useButton}>\n          <Button\n            variant=\"primary\"\n            size=\"sm\"\n            onClick={() => {\n              reportInteraction('grafana_prometheus_promqail_use_query_button_clicked', {\n                query: querySuggestion.query,\n              });\n              const pvq = buildVisualQueryFromString(querySuggestion.query);\n              // check for errors!\n              onChange(pvq.query);\n              closeDrawer();\n            }}\n          >\n            Use\n          </Button>\n        </div>\n      </div>\n      <div>\n        <Button\n          fill=\"text\"\n          variant=\"secondary\"\n          icon={showExp ? 'angle-up' : 'angle-down'}\n          onClick={() => {\n            updShowExp(!showExp);\n            queryExplain(order - 1);\n          }}\n          className={cx(styles.bodySmall)}\n          size=\"sm\"\n        >\n          Explainer\n        </Button>\n        {!showExp && order !== 5 && <div className={styles.textPadding}></div>}\n\n        {showExp && !querySuggestion.explanation && (\n          <div className={styles.center}>\n            <Spinner />\n          </div>\n        )}\n        {showExp && querySuggestion.explanation && (\n          <>\n            <div className={cx(styles.bodySmall, styles.explainPadding)}>\n              <div className={styles.textPadding}>This query is trying to answer the question:</div>\n              <div className={styles.textPadding}>{explanation}</div>\n              <div className={styles.textPadding}>\n                Learn more with this{' '}\n                <a\n                  className={styles.doc}\n                  href={'https://prometheus.io/docs/prometheus/latest/querying/examples/#query-examples'}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                >\n                  Prometheus doc\n                </a>\n              </div>\n\n              <div className={cx(styles.rightButtons, styles.secondaryText)}>\n                Was this explanation helpful?\n                <div className={styles.floatRight}>\n                  {!gaveExplanationFeedback ? (\n                    <>\n                      <Button\n                        fill=\"outline\"\n                        variant=\"secondary\"\n                        size=\"sm\"\n                        className={styles.leftButton}\n                        onClick={() => {\n                          explanationFeedbackEvent('Yes', '', querySuggestion, historical, prompt);\n                          updateGaveExplanationFeedback(true);\n                        }}\n                      >\n                        Yes\n                      </Button>\n                      <Toggletip\n                        aria-label=\"Suggestion feedback\"\n                        content={feedbackToggleTip('explanation')}\n                        placement=\"bottom-end\"\n                        closeButton={true}\n                      >\n                        <Button variant=\"success\" size=\"sm\">\n                          No\n                        </Button>\n                      </Toggletip>\n                    </>\n                  ) : (\n                    'Thank you for your feedback!'\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {!last && <hr />}\n          </>\n        )}\n        {last && (\n          <div className={cx(styles.feedbackStyle)}>\n            {!gaveSuggestionFeedback ? (\n              <Toggletip\n                aria-label=\"Suggestion feedback\"\n                content={feedbackToggleTip('suggestion')}\n                placement=\"bottom-end\"\n                closeButton={true}\n              >\n                <Button fill=\"outline\" variant=\"secondary\" size=\"sm\">\n                  Give feedback on suggestions\n                </Button>\n              </Toggletip>\n            ) : (\n              // do this weird thing because the toggle tip doesn't allow an extra close function\n              <Button fill=\"outline\" variant=\"secondary\" size=\"sm\" disabled={true}>\n                Thank you for your feedback!\n              </Button>\n            )}\n          </div>\n        )}\n      </div>\n    </>\n  );\n}\n\nfunction explanationFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  querySuggestion: QuerySuggestion,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_explanation_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    query: querySuggestion.query,\n    explanation: querySuggestion.explanation,\n    prompt: prompt,\n  });\n}\n\nfunction suggestionFeedbackEvent(\n  radioInputFeedback: string,\n  textFeedback: string,\n  allSuggestions: string,\n  historical: boolean,\n  prompt: string\n) {\n  const event = 'grafana_prometheus_promqail_suggestion_feedback';\n\n  reportInteraction(event, {\n    helpful: radioInputFeedback,\n    textFeedback: textFeedback,\n    suggestionType: historical ? 'historical' : 'AI',\n    allSuggestions: allSuggestions,\n    prompt: prompt,\n  });\n}\n","export type QuerySuggestion = {\n  query: string;\n  explanation: string;\n};\n\nexport enum SuggestionType {\n  Historical = 'historical',\n  AI = 'AI',\n}\n\nexport type Interaction = {\n  prompt: string;\n  suggestionType: SuggestionType;\n  suggestions: QuerySuggestion[];\n  isLoading: boolean;\n  explanationIsLoading: boolean;\n};\n","import { cx } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { Button, useTheme2 } from '@grafana/ui';\n\nimport { PromVisualQuery } from '../../types';\n\nimport { getStyles, testIds } from './PromQail';\nimport { QuerySuggestionItem } from './QuerySuggestionItem';\nimport { QuerySuggestion, SuggestionType } from './types';\n\nexport type Props = {\n  querySuggestions: QuerySuggestion[];\n  suggestionType: SuggestionType;\n  closeDrawer: () => void;\n  nextInteraction: () => void;\n  queryExplain: (idx: number) => void;\n  onChange: (query: PromVisualQuery) => void;\n  prompt: string;\n};\n\nexport function QuerySuggestionContainer(props: Props) {\n  const { suggestionType, querySuggestions, closeDrawer, nextInteraction, queryExplain, onChange, prompt } = props;\n\n  const [hasNextInteraction, updateHasNextInteraction] = useState<boolean>(false);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  let text, secondaryText, refineText;\n\n  if (suggestionType === SuggestionType.Historical) {\n    text = `Here are ${querySuggestions.length} query suggestions:`;\n    refineText = 'I want to write a prompt';\n  } else if (suggestionType === SuggestionType.AI) {\n    text = text = 'Here is your query suggestion:';\n    secondaryText =\n      'This query is based off of natural language descriptions of the most commonly used PromQL queries.';\n    refineText = 'Refine prompt';\n  }\n\n  return (\n    <>\n      {suggestionType === SuggestionType.Historical ? (\n        <div className={styles.bottomMargin}>{text}</div>\n      ) : (\n        <>\n          <div className={styles.textPadding}>{text}</div>\n          <div className={cx(styles.secondaryText, styles.bottomMargin)}>{secondaryText}</div>\n        </>\n      )}\n\n      <div className={styles.infoContainerWrapper}>\n        <div className={styles.infoContainer}>\n          {querySuggestions.map((qs: QuerySuggestion, idx: number) => {\n            return (\n              <QuerySuggestionItem\n                historical={suggestionType === SuggestionType.Historical}\n                querySuggestion={qs}\n                key={idx}\n                order={idx + 1}\n                queryExplain={queryExplain}\n                onChange={onChange}\n                closeDrawer={closeDrawer}\n                last={idx === querySuggestions.length - 1}\n                // for feedback rudderstack events\n                allSuggestions={querySuggestions.reduce((acc: string, qs: QuerySuggestion) => {\n                  return acc + '$$' + qs.query;\n                }, '')}\n                prompt={prompt ?? ''}\n              />\n            );\n          })}\n        </div>\n      </div>\n      {!hasNextInteraction && (\n        <div className={styles.nextInteractionHeight}>\n          <div className={cx(styles.afterButtons, styles.textPadding)}>\n            <Button\n              onClick={() => {\n                updateHasNextInteraction(true);\n                nextInteraction();\n              }}\n              data-testid={testIds.refinePrompt}\n              fill=\"outline\"\n              variant=\"secondary\"\n              size=\"md\"\n            >\n              {refineText}\n            </Button>\n          </div>\n          <div className={cx(styles.textPadding, styles.floatRight)}>\n            <Button fill=\"outline\" variant=\"secondary\" size=\"md\" onClick={closeDrawer}>\n              Cancel\n            </Button>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","export const ExplainSystemPrompt = `You are an expert in Prometheus, the event monitoring and alerting application.\n\nYou are given relevant PromQL documentation, a type and description for a Prometheus metric, and a PromQL query on that metric. Using the provided information for reference, please explain what the output of a given query is in 1 sentences. Do not walk through what the functions do separately, make your answer concise. \n\nInput will be in the form:\n\n\nPromQL Documentation:\n<PromQL documentation>\n\nPromQL Metrics Metadata:\n<metric_name>(<metric type of the metric queried>): <description of what the metric means>\n\nPromQL Expression: \n<PromQL query>\n\nExamples of input and output\n----------\nPromQL Documentation:\nA counter is a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart. For example, you can use a counter to represent the number of requests served, tasks completed, or errors.\ntopk (largest k elements by sample value)\nsum (calculate sum over dimensions)\nrate(v range-vector) calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. \n\nPromQL Metrics Metadata:\ntraces_exporter_sent_spans(counter): Number of spans successfully sent to destination.\n\nPromQL Expression:\ntopk(3, sum by(cluster) (rate(traces_exporter_sent_spans{exporter=\"otlp\"}[5m])))\n\nThis query is trying to answer the question:\nWhat is the top 3 clusters that have successfully sent the most number of spans to the destination?\n`;\n\nexport type ExplainUserPromptParams = {\n  documentation: string;\n  metricName: string;\n  metricType: string;\n  metricMetadata: string;\n  query: string;\n};\n\nexport function GetExplainUserPrompt({\n  documentation,\n  metricName,\n  metricType,\n  metricMetadata,\n  query,\n}: ExplainUserPromptParams): string {\n  if (documentation === '') {\n    documentation = 'No documentation provided.';\n  }\n  if (metricMetadata === '') {\n    metricMetadata = 'No description provided.';\n  }\n  return `\n        PromQL Documentation: \n        ${documentation}\n\n        PromQL Metrics Metadata:\n        ${metricName}(${metricType}): ${metricMetadata}\n\n        PromQL Expression: \n        ${query}\n\n        This query is trying to answer the question:\n    `;\n}\n\nexport const SuggestSystemPrompt = `You are a Prometheus Query Language (PromQL) expert assistant inside Grafana.\nWhen the user asks a question, respond with a valid PromQL query and only the query.\n\nTo help you answer the question, you will receive:\n- List of potentially relevant PromQL templates with descriptions, ranked by semantic search score\n- Prometheus metric\n- Metric type\n- Available Prometheus metric labels\n- User question\n\nPolicy:\n- Do not invent labels names, you can only use the available labels\n- For rate queries, use the $__rate_interval variable`;\n\n// rewrite with a type\nexport type SuggestUserPromptParams = {\n  promql: string;\n  question: string;\n  metricType: string;\n  labels: string;\n  templates: string;\n};\n\nexport function GetSuggestUserPrompt({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): string {\n  if (templates === '') {\n    templates = 'No templates provided.';\n  } else {\n    templates = templates.replace(/\\n/g, '\\n  ');\n  }\n  return `Relevant PromQL templates:\n  ${templates}\n  \n  Prometheus metric: ${promql}\n  Metric type: ${metricType}\n  Available Prometheus metric labels: ${labels}\n  User question: ${question}\n  \n  \\`\\`\\`promql`;\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\n\nimport { PromVisualQuery } from '../../../types';\nimport { Interaction, SuggestionType } from '../types';\n\nexport const stateSlice = createSlice({\n  name: 'metrics-modal-state',\n  initialState: initialState(),\n  reducers: {\n    showExplainer: (state, action: PayloadAction<boolean>) => {\n      state.showExplainer = action.payload;\n    },\n    showStartingMessage: (state, action: PayloadAction<boolean>) => {\n      state.showStartingMessage = action.payload;\n    },\n    indicateCheckbox: (state, action: PayloadAction<boolean>) => {\n      state.indicateCheckbox = action.payload;\n    },\n    askForQueryHelp: (state, action: PayloadAction<boolean>) => {\n      state.askForQueryHelp = action.payload;\n    },\n    /*\n     * start working on a collection of interactions\n     * {\n     *  askForhelp y n\n     *  prompt question\n     *  queries querySuggestions\n     * }\n     *\n     */\n    addInteraction: (state, action: PayloadAction<{ suggestionType: SuggestionType; isLoading: boolean }>) => {\n      // AI or Historical?\n      const interaction = createInteraction(action.payload.suggestionType, action.payload.isLoading);\n      const interactions = state.interactions;\n      state.interactions = interactions.concat([interaction]);\n    },\n    updateInteraction: (state, action: PayloadAction<{ idx: number; interaction: Interaction }>) => {\n      // update the interaction by index\n      // will most likely be the last interaction but we might update previous by giving them cues of helpful or not\n      const index = action.payload.idx;\n      const updInteraction = action.payload.interaction;\n\n      state.interactions = state.interactions.map((interaction: Interaction, idx: number) => {\n        if (idx === index) {\n          return updInteraction;\n        }\n\n        return interaction;\n      });\n    },\n  },\n});\n\n/**\n * Initial state for PromQAIL\n * @param query the prometheus query with metric and possible labels\n */\nexport function initialState(query?: PromVisualQuery, showStartingMessage?: boolean): PromQailState {\n  return {\n    query: query ?? {\n      metric: '',\n      labels: [],\n      operations: [],\n    },\n    showExplainer: false,\n    showStartingMessage: showStartingMessage ?? true,\n    indicateCheckbox: false,\n    askForQueryHelp: false,\n    interactions: [],\n  };\n}\n\n/**\n * The PromQAIL state object\n */\nexport interface PromQailState {\n  query: PromVisualQuery;\n  showExplainer: boolean;\n  showStartingMessage: boolean;\n  indicateCheckbox: boolean;\n  askForQueryHelp: boolean;\n  interactions: Interaction[];\n}\n\nexport function createInteraction(suggestionType: SuggestionType, isLoading?: boolean): Interaction {\n  return {\n    suggestionType: suggestionType,\n    prompt: '',\n    suggestions: [],\n    isLoading: isLoading ?? false,\n    explanationIsLoading: false,\n  };\n}\n","import { QuerySuggestion } from '../types';\n\ninterface TemplateData {\n  template: string;\n  description: string;\n}\n\nexport const generalTemplates: TemplateData[] = [\n  {\n    template: 'metric_a{}',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'avg by(c) (metric_a{})',\n    description: 'Average of all series in \"metric_a\" grouped by the label \"c\"',\n  },\n  {\n    template: 'count by(d) (metric_a{})',\n    description: 'Number of series in the metric \"metric_a\" grouped by the label \"d\"',\n  },\n  {\n    template: 'sum by(g) (sum_over_time(metric_a{}[1h]))',\n    description:\n      'For each series in the metric \"metric_a\", sum all values over 1 hour, then group those series by label \"g\" and sum.',\n  },\n  {\n    template: 'count(metric_a{})',\n    description: 'Count of series in the metric \"metric_a\"',\n  },\n  {\n    template: '(metric_a{})',\n    description: 'Get the data for \"metric_a\"',\n  },\n  {\n    template: 'count_over_time(metric_a{}[1h])',\n    description: 'Number of series of metric_a in a 1 hour interval',\n  },\n  {\n    template: 'changes(metric_a{}[1m])',\n    description: 'Number of times the values of each series in metric_a have changed in 1 minute periods',\n  },\n  {\n    template: 'count(count by(g) (metric_a{}))',\n    description: 'Total number of series in metric_a',\n  },\n  {\n    template: 'last_over_time(metric_a{}[1h])',\n    description: 'For each series in metric_a, get the last value in the 1 hour period.',\n  },\n  {\n    template: 'sum by(g) (count_over_time(metric_a{}[1h]))',\n    description: 'Grouped sum over the label \"g\" of the number of series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'count(metric_a{} == 99)',\n    description: 'Number of series of metric_a that have value 99',\n  },\n  {\n    template: 'min(metric_a{})',\n    description: 'At each timestamp, find the minimum of all series of the metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} != 99',\n    description: 'Series of metric_a which do not have the value 99',\n  },\n  {\n    template: 'metric_a{} - 99',\n    description: 'metric_a minus 99',\n  },\n  {\n    template: 'quantile_over_time(0.99,metric_a{}[1h])',\n    description: 'The 99th quantile of values of metric_a in 1 hour',\n  },\n  {\n    template: 'count_values(\"aaaa\",metric_a{})',\n    description: 'Count number of label values for a label named \"aaaa\"',\n  },\n];\n\nexport const counterTemplates: TemplateData[] = [\n  {\n    template: 'sum by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Sum of the rate of increase or decrease of the metric \"metric_a\" per 1 hour period, grouped by the label \"d\"',\n  },\n  {\n    template: 'rate(metric_a{}[1m])',\n    description: 'Rate of change of the metric \"metric_a\" over 1 minute',\n  },\n  {\n    template: 'sum by(a) (increase(metric_a{}[5m]))',\n    description:\n      'Taking the metric \"metric_a\" find the increase in 5 minute periods of each series and aggregate sum over the label \"a\"',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1m]))',\n    description: 'Total rate of change of all series of metric \"metric_a\" in 1 minute intervals',\n  },\n  {\n    template: 'sum(increase(metric_a{}[10m]))',\n    description: 'Total increase for each series of metric \"metric_a\" in 10 minute intervals',\n  },\n  {\n    template: 'increase(metric_a{}[1h])',\n    description: 'Increase in all series of \"metric_a\" in 1 hour period',\n  },\n  {\n    template: 'sum by(d) (irate(metric_a{}[1h]))',\n    description: 'Sum of detailed rate of change of the metric \"metric_a\" over 1 hour grouped by label \"d\"',\n  },\n  {\n    template: 'irate(metric_a{}[1h])',\n    description: 'Detailed rate of change of the metric \"metric_a\" over 1 hour',\n  },\n  {\n    template: 'avg by(d) (rate(metric_a{}[1h]))',\n    description:\n      'Taking the rate of change of the metric \"metric_a\" in a 1 hour period, group by the label \"d\" and find the average of each group',\n  },\n  {\n    template: 'topk(5,sum by(g) (rate(metric_a{}[1h])))',\n    description: 'Top 5 of the summed groups \"g\" of the rate of change of metric_a',\n  },\n  {\n    template: 'sum(rate(metric_a{}[1h])) / sum(rate(metric_a{}[1h]))',\n    description: 'Relative sums of metric_a with different labels',\n  },\n  {\n    template: 'histogram_quantile(99,rate(metric_a{}[1h]))',\n    description: '99th percentile of the rate of change of metric_a in 1 hour periods',\n  },\n  {\n    template: 'avg(rate(metric_a{}[1m]))',\n    description: 'Average of the rate of all series of metric_a in 1 minute periods',\n  },\n  {\n    template: 'rate(metric_a{}[5m]) > 99',\n    description: 'Show series of metric_a only if their rate over 5 minutes is greater than 99',\n  },\n  {\n    template: 'count by(g) (rate(metric_a{}[1h]))',\n    description: 'Count of series of metric_a over all labels \"g\"',\n  },\n];\n\nexport const histogramTemplates: TemplateData[] = [\n  {\n    template: 'histogram_quantile(99,sum by(le) (rate(metric_a{}[1h])))',\n    description:\n      'Calculate the rate at which the metric \"metric_a\" is increasing or decreasing, summed over each bucket label \"le\", and then calculates the 99th percentile of those rates.',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (metric_a{}))',\n    description: '99th percentile of the sum of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'histogram_quantile(99,sum by(g) (irate(metric_a{}[1h])))',\n    description: '99th percentile of the grouped by \"g\" sum of the rate of each series in metric_a in an hour',\n  },\n  {\n    template: 'histogram_quantile(99,metric_a{})',\n    description: '99th percentile of metric_a',\n  },\n];\n\nexport const gaugeTemplates: TemplateData[] = [\n  {\n    template: 'sum by(c) (metric_a{})',\n    description: 'Sum the metric \"metric_a\" by each value in label \"c\"',\n  },\n  {\n    template: 'sum(metric_a{})',\n    description: 'Total sum of all the series of the metric named \"metric_a\"',\n  },\n  {\n    template: 'max by(dd) (metric_a{})',\n    description: 'Grouping the series the metric \"metric_a\" by the label \"dd\", get the maximum value of each group',\n  },\n  {\n    template: 'max(metric_a{})',\n    description: 'Maximum value of all series of the metric \"metric_a\" ',\n  },\n  {\n    template: 'avg(metric_a{})',\n    description: 'Average value of all the series of metric \"metric_a\"',\n  },\n  {\n    template: 'metric_a{} > 99',\n    description: 'Show only the series of metric \"metric_a\" which currently have value greater than 99',\n  },\n  {\n    template: 'metric_a{} / 99',\n    description: 'Values for \"metric_a\" all divided by 99',\n  },\n  {\n    template: 'metric_a{} == 99',\n    description: 'Show series of metric_a that have value 99',\n  },\n  {\n    template: 'sum_over_time(metric_a{}[1h])',\n    description: 'Sum each series of metric_a over 1 hour',\n  },\n  {\n    template: 'avg_over_time(metric_a{}[1h])',\n    description: 'Average of each series of metric_a in a 1 hour period',\n  },\n  {\n    template: 'sum(sum_over_time(metric_a{}[1h]))',\n    description: 'Sum of all values in all series in a 1 hour period',\n  },\n  {\n    template: 'delta(metric_a{}[1m])',\n    description: 'Span or delta (maximum - minimum) of values of the metric \"metric_a\" in a 1 minute period. ',\n  },\n  {\n    template: 'avg by(g) (avg_over_time(metric_a{}[1h]))',\n    description:\n      'For 1 hour, take each series and find the average, then group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'max_over_time(metric_a{}[1h])',\n    description: 'Maximum values of each series in metric \"metric_a\" in a 1 hour period',\n  },\n  {\n    template: 'metric_a{} * 99',\n    description: 'Values of metric_a multiplied by 99',\n  },\n  {\n    template: 'metric_a{} < 99',\n    description: 'Series of metric_a that have values less than 99',\n  },\n  {\n    template: 'max by() (max_over_time(metric_a{}[1h]))',\n    description: 'Find maximum value of all series in 1 hour periods',\n  },\n  {\n    template: 'topk(99,metric_a{})',\n    description: 'First 5 series of metric_a that have the highest values',\n  },\n  {\n    template: 'min by(g) (metric_a{})',\n    description: 'Minimum values of the series of metric_a grouped by label \"g\"',\n  },\n  {\n    template: 'topk(10,sum by(g) (metric_a{}))',\n    description: \"Top 10 of the series of metric_a grouped and summed by the label 'g'\",\n  },\n  {\n    template: 'avg(avg_over_time(metric_a{}[1h]))',\n    description: 'Average of all values inside a 1 hour period',\n  },\n  {\n    template: 'quantile by(h) (0.95,metric_a{})',\n    description: 'Calculate 95th percentile of metric_a when aggregated by the label \"h\"',\n  },\n  {\n    template: 'avg by(g) (metric_a{} > 99)',\n    description:\n      'Taking all series of metric_a with value greater than 99, group by label \"g\" and find the average of each group',\n  },\n  {\n    template: 'sum(metric_a{}) / 99',\n    description: 'Sum of all series of metric_a divided by 99',\n  },\n  {\n    template: 'count(sum by(g) (metric_a{}))',\n    description: 'Number of series of metric_a grouped by the label \"g\"',\n  },\n  {\n    template: 'max(max_over_time(metric_a{}[1h]))',\n    description: 'Find the max value of all series of metric_a in a 1 hour period',\n  },\n];\n\nfunction processTemplate(templateData: TemplateData, metric: string, labels: string): QuerySuggestion {\n  return {\n    query: templateData.template.replace('metric_a', metric).replace('{}', labels),\n    explanation: templateData.description.replace('metric_a', metric),\n  };\n}\n\nexport function getTemplateSuggestions(metricName: string, metricType: string, labels: string): QuerySuggestion[] {\n  let templateSuggestions: QuerySuggestion[] = [];\n  switch (metricType) {\n    case 'counter':\n      templateSuggestions = templateSuggestions.concat(\n        counterTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'gauge':\n      templateSuggestions = templateSuggestions.concat(\n        gaugeTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    case 'histogram':\n      templateSuggestions = templateSuggestions.concat(\n        histogramTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 2)\n      );\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 3)\n      );\n      break;\n    default:\n      templateSuggestions = templateSuggestions.concat(\n        generalTemplates\n          .map((t) => processTemplate(t, metricName, labels))\n          .sort(() => Math.random() - 0.5)\n          .slice(0, 5)\n      );\n      break;\n  }\n  return templateSuggestions;\n}\n","import { AnyAction } from 'redux';\n\nimport { llms } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { PrometheusDatasource } from 'app/plugins/datasource/prometheus/datasource';\nimport { getMetadataHelp, getMetadataType } from 'app/plugins/datasource/prometheus/language_provider';\n\nimport { promQueryModeller } from '../../../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../../../parsing';\nimport { PromVisualQuery } from '../../../types';\nimport {\n  ExplainSystemPrompt,\n  GetExplainUserPrompt,\n  SuggestSystemPrompt,\n  GetSuggestUserPrompt,\n  SuggestUserPromptParams,\n} from '../prompts';\nimport { Interaction, QuerySuggestion, SuggestionType } from '../types';\n\nimport { createInteraction, stateSlice } from './state';\nimport { getTemplateSuggestions } from './templates';\n\nconst OPENAI_MODEL_NAME = 'gpt-3.5-turbo-1106';\nconst promQLTemplatesCollection = 'grafana.promql.templates';\n// actions to update the state\nconst { updateInteraction } = stateSlice.actions;\n\ninterface TemplateSearchResult {\n  description: string | null;\n  metric_type: string | null;\n  promql: string | null;\n}\n\nexport function getExplainMessage(\n  query: string,\n  metric: string,\n  datasource: PrometheusDatasource\n): llms.openai.Message[] {\n  let metricMetadata = '';\n  let metricType = '';\n\n  const pvq = buildVisualQueryFromString(query);\n\n  if (datasource.languageProvider.metricsMetadata) {\n    metricType = getMetadataType(metric, datasource.languageProvider.metricsMetadata) ?? '';\n    metricMetadata = getMetadataHelp(metric, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n\n  const documentationBody = pvq.query.operations\n    .map((op) => {\n      const def = promQueryModeller.getOperationDef(op.id);\n      if (!def) {\n        return '';\n      }\n      const title = def.renderer(op, def, '<expr>');\n      const body = def.explainHandler ? def.explainHandler(op, def) : def.documentation;\n\n      if (!body) {\n        return '';\n      }\n      return `### ${title}:\\n${body}`;\n    })\n    .filter((item) => item !== '')\n    .join('\\n');\n\n  return [\n    { role: 'system', content: ExplainSystemPrompt },\n    {\n      role: 'user',\n      content: GetExplainUserPrompt({\n        documentation: documentationBody,\n        metricName: metric,\n        metricType: metricType,\n        metricMetadata: metricMetadata,\n        query: query,\n      }),\n    },\n  ];\n}\n\nfunction getSuggestMessages({\n  promql,\n  question,\n  metricType,\n  labels,\n  templates,\n}: SuggestUserPromptParams): llms.openai.Message[] {\n  return [\n    { role: 'system', content: SuggestSystemPrompt },\n    { role: 'user', content: GetSuggestUserPrompt({ promql, question, metricType, labels, templates }) },\n  ];\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailExplain(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  interaction: Interaction,\n  suggIdx: number,\n  datasource: PrometheusDatasource\n) {\n  const suggestedQuery = interaction.suggestions[suggIdx].query;\n\n  const promptMessages = getExplainMessage(suggestedQuery, query.metric, datasource);\n  const interactionToUpdate = interaction;\n\n  return llms.openai\n    .streamChatCompletions({\n      model: OPENAI_MODEL_NAME,\n      messages: promptMessages,\n      temperature: 0,\n    })\n    .pipe(llms.openai.accumulateContent())\n    .subscribe((response) => {\n      const updatedSuggestions = interactionToUpdate.suggestions.map((sg: QuerySuggestion, sidx: number) => {\n        if (suggIdx === sidx) {\n          return {\n            query: interactionToUpdate.suggestions[suggIdx].query,\n            explanation: response,\n          };\n        }\n\n        return sg;\n      });\n\n      const payload = {\n        idx,\n        interaction: {\n          ...interactionToUpdate,\n          suggestions: updatedSuggestions,\n          explanationIsLoading: false,\n        },\n      };\n      dispatch(updateInteraction(payload));\n    });\n}\n\n/**\n * Check if sublist is fully contained in the superlist\n *\n * @param sublist\n * @param superlist\n * @returns true if fully contained, else false\n */\nfunction isContainedIn(sublist: string[], superlist: string[]): boolean {\n  for (const item of sublist) {\n    if (!superlist.includes(item)) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Guess the type of a metric, based on its name and its relation to other metrics available\n *\n * @param metric     - name of metric whose type to guess\n * @param allMetrics - list of all available metrics\n * @returns          - the guess of the type (string): counter,gauge,summary,histogram,'histogram,summary'\n */\nexport function guessMetricType(metric: string, allMetrics: string[]): string {\n  const synthetic_metrics = new Set<string>([\n    'up',\n    'scrape_duration_seconds',\n    'scrape_samples_post_metric_relabeling',\n    'scrape_series_added',\n    'scrape_samples_scraped',\n    'ALERTS',\n    'ALERTS_FOR_STATE',\n  ]);\n\n  if (synthetic_metrics.has(metric)) {\n    // these are all known to be counters\n    return 'counter';\n  }\n  if (metric.startsWith(':')) {\n    // probably recording rule\n    return 'gauge';\n  }\n  if (metric.endsWith('_info')) {\n    // typically series of 1s only, the labels are the useful part. TODO: add 'info' type\n    return 'counter';\n  }\n\n  if (metric.endsWith('_created') || metric.endsWith('_total')) {\n    // prometheus naming style recommends counters to have these suffixes.\n    return 'counter';\n  }\n\n  const underscoreIndex = metric.lastIndexOf('_');\n  if (underscoreIndex < 0) {\n    // No underscores in the name at all, very little info to go on. Guess\n    return 'gauge';\n  }\n\n  // See if the suffix is histogram-y or summary-y\n  const [root, suffix] = [metric.slice(0, underscoreIndex), metric.slice(underscoreIndex + 1)];\n\n  if (['bucket', 'count', 'sum'].includes(suffix)) {\n    // Might be histogram + summary\n    let familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram,summary';\n    }\n\n    // Might be a histogram, if so all these metrics should exist too:\n    familyMetrics = [`${root}_bucket`, `${root}_count`, `${root}_sum`];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'histogram';\n    }\n\n    // Or might be a summary\n    familyMetrics = [`${root}_sum`, `${root}_count`, root];\n    if (isContainedIn(familyMetrics, allMetrics)) {\n      return 'summary';\n    }\n\n    // Otherwise it's probably just a counter!\n    return 'counter';\n  }\n\n  // One case above doesn't catch: summary or histogram,summary where the non-suffixed metric is chosen\n  const familyMetrics = [`${metric}_sum`, `${metric}_count`, metric];\n  if (isContainedIn(familyMetrics, allMetrics)) {\n    if (allMetrics.includes(`${metric}_bucket`)) {\n      return 'histogram,summary';\n    } else {\n      return 'summary';\n    }\n  }\n\n  // All else fails, guess gauge\n  return 'gauge';\n}\n\n/**\n * Generate a suitable filter structure for the VectorDB call\n * @param types: list of metric types to include in the result\n * @returns the structure to pass to the vectorDB call.\n */\nfunction generateMetricTypeFilters(types: string[]) {\n  return types.map((type) => ({\n    metric_type: {\n      $eq: type,\n    },\n  }));\n}\n\n/**\n * Taking in a metric name, try to guess its corresponding metric _family_ name\n * @param metric name\n * @returns metric family name\n */\nfunction guessMetricFamily(metric: string): string {\n  if (metric.endsWith('_bucket') || metric.endsWith('_count') || metric.endsWith('_sum')) {\n    return metric.slice(0, metric.lastIndexOf('_'));\n  }\n  return metric;\n}\n\n/**\n * Check if the LLM plugin is enabled.\n * Used in the PromQueryBuilder to enable/disable the button based on openai and vector db checks\n * @returns true if the LLM plugin is enabled.\n */\nexport async function isLLMPluginEnabled(): Promise<boolean> {\n  // Check if the LLM plugin is enabled.\n  // If not, we won't be able to make requests, so return early.\n  const openaiEnabled = llms.openai.health().then((response) => response.ok);\n  const vectorEnabled = llms.vector.health().then((response) => response.ok);\n  // combine 2 promises\n  return Promise.all([openaiEnabled, vectorEnabled]).then((results) => {\n    return results.every((result) => result);\n  });\n}\n\n/**\n * Calls the API and adds suggestions to the interaction\n *\n * @param dispatch\n * @param idx\n * @param interaction\n * @returns\n */\nexport async function promQailSuggest(\n  dispatch: React.Dispatch<AnyAction>,\n  idx: number,\n  query: PromVisualQuery,\n  labelNames: string[],\n  datasource: PrometheusDatasource,\n  interaction?: Interaction\n) {\n  const interactionToUpdate = interaction ? interaction : createInteraction(SuggestionType.Historical);\n\n  // Decide metric type\n  let metricType = '';\n  // Makes sure we loaded the metadata for metrics. Usually this is done in the start() method of the\n  // provider but we only need the metadata here.\n  if (!datasource.languageProvider.metricsMetadata) {\n    await datasource.languageProvider.loadMetricsMetadata();\n  }\n  if (datasource.languageProvider.metricsMetadata) {\n    // `datasource.languageProvider.metricsMetadata` is a list of metric family names (with desired type)\n    // from the datasource metadata endoint, but unfortunately the expanded _sum, _count, _bucket raw\n    // metric names are also generated and populating this list (all of type counter). We want the metric\n    // family type, so need to guess the metric family name from the chosen metric name, and test if that\n    // metric family has a type specified.\n    const metricFamilyGuess = guessMetricFamily(query.metric);\n    metricType = getMetadataType(metricFamilyGuess, datasource.languageProvider.metricsMetadata) ?? '';\n  }\n  if (metricType === '') {\n    // fallback to heuristic guess\n    metricType = guessMetricType(query.metric, datasource.languageProvider.metrics);\n  }\n\n  if (interactionToUpdate.suggestionType === SuggestionType.Historical) {\n    return new Promise<void>((resolve) => {\n      return setTimeout(() => {\n        const suggestions = getTemplateSuggestions(\n          query.metric,\n          metricType,\n          promQueryModeller.renderLabels(query.labels)\n        );\n\n        const payload = {\n          idx,\n          interaction: { ...interactionToUpdate, suggestions: suggestions, isLoading: false },\n        };\n        dispatch(updateInteraction(payload));\n        resolve();\n      }, 1000);\n    });\n  } else {\n    type SuggestionBody = {\n      metric: string;\n      labels: string;\n      prompt?: string;\n    };\n\n    // get all available labels\n    const metricLabels = await datasource.languageProvider.fetchLabelsWithMatch(query.metric);\n\n    let feedTheAI: SuggestionBody = {\n      metric: query.metric,\n      // drop __name__ label because it's not useful\n      labels: Object.keys(metricLabels)\n        .filter((label) => label !== '__name__')\n        .join(','),\n    };\n\n    // @ts-ignore llms types issue\n    let results: Array<llms.vector.SearchResult<TemplateSearchResult>> = [];\n    if (interaction?.suggestionType === SuggestionType.AI) {\n      feedTheAI = { ...feedTheAI, prompt: interaction.prompt };\n\n      // @ts-ignore llms types issue\n      results = await llms.vector.search<TemplateSearchResult>({\n        query: interaction.prompt,\n        collection: promQLTemplatesCollection,\n        topK: 5,\n        filter: {\n          $or: generateMetricTypeFilters(metricType.split(',').concat(['*'])),\n        },\n      });\n      reportInteraction('grafana_prometheus_promqail_vector_results', {\n        metric: query.metric,\n        prompt: interaction.prompt,\n        results: results,\n      });\n      // TODO: handle errors from vector search\n    }\n\n    const resultsString = results\n      .map((r) => {\n        return `${r.payload.promql} | ${r.payload.description} (score=${(r.score * 100).toFixed(1)})`;\n      })\n      .join('\\n');\n\n    const promptMessages = getSuggestMessages({\n      promql: query.metric,\n      question: interaction ? interaction.prompt : '',\n      metricType: metricType,\n      labels: labelNames.join(', '),\n      templates: resultsString,\n    });\n\n    return llms.openai\n      .streamChatCompletions({\n        model: OPENAI_MODEL_NAME,\n        messages: promptMessages,\n        temperature: 0.5,\n      })\n      .pipe(llms.openai.accumulateContent())\n      .subscribe((response) => {\n        const payload = {\n          idx,\n          interaction: {\n            ...interactionToUpdate,\n            suggestions: [\n              {\n                query: response,\n                explanation: '',\n              },\n            ],\n            isLoading: false,\n          },\n        };\n        dispatch(updateInteraction(payload));\n      });\n  }\n}\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useReducer, useRef, useState } from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Alert, Button, Checkbox, Input, Spinner, useTheme2 } from '@grafana/ui';\nimport store from 'app/core/store';\n\nimport { PrometheusDatasource } from '../../../datasource';\nimport { PromVisualQuery } from '../../types';\n\nimport { QuerySuggestionContainer } from './QuerySuggestionContainer';\n// @ts-ignore until we can get these added for icons\nimport AI_Logo_color from './resources/AI_Logo_color.svg';\nimport { promQailExplain, promQailSuggest } from './state/helpers';\nimport { initialState, stateSlice } from './state/state';\nimport { Interaction, SuggestionType } from './types';\n\n// actions to update the state\nconst { showStartingMessage, indicateCheckbox, addInteraction, updateInteraction } = stateSlice.actions;\n\nexport type PromQailProps = {\n  query: PromVisualQuery;\n  closeDrawer: () => void;\n  onChange: (query: PromVisualQuery) => void;\n  datasource: PrometheusDatasource;\n};\n\nconst SKIP_STARTING_MESSAGE = 'SKIP_STARTING_MESSAGE';\n\nexport const PromQail = (props: PromQailProps) => {\n  const { query, closeDrawer, onChange, datasource } = props;\n  const skipStartingMessage = store.getBool(SKIP_STARTING_MESSAGE, false);\n\n  const [state, dispatch] = useReducer(stateSlice.reducer, initialState(query, !skipStartingMessage));\n\n  const [labelNames, setLabelNames] = useState<string[]>([]);\n\n  const suggestions = state.interactions.reduce((acc, int) => acc + int.suggestions.length, 0);\n\n  const responsesEndRef = useRef(null);\n\n  const scrollToBottom = () => {\n    if (responsesEndRef) {\n      // @ts-ignore for React.MutableRefObject\n      responsesEndRef?.current?.scrollIntoView({ behavior: 'smooth' });\n    }\n  };\n\n  useEffect(() => {\n    // only scroll when an interaction has been added or the suggestions have been updated\n    scrollToBottom();\n  }, [state.interactions.length, suggestions]);\n\n  useEffect(() => {\n    const fetchLabels = async () => {\n      let labelsIndex: Record<string, string[]> = await datasource.languageProvider.fetchLabelsWithMatch(query.metric);\n      setLabelNames(Object.keys(labelsIndex));\n    };\n    fetchLabels();\n  }, [query, datasource]);\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  return (\n    <div className={styles.containerPadding}>\n      {/* Query Advisor */}\n      {/* header */}\n      <div className={styles.header}>\n        <h3>Query advisor</h3>\n        <Button icon=\"times\" fill=\"text\" variant=\"secondary\" onClick={closeDrawer} />\n      </div>\n      {/* Starting message */}\n      <div>\n        <div className={styles.iconSection}>\n          <img src={AI_Logo_color} alt=\"AI logo color\" /> Assistant\n        </div>\n        {state.showStartingMessage ? (\n          <>\n            <div className={styles.dataList}>\n              <ol>\n                <li className={styles.textPadding}>\n                  Query Advisor suggests queries based on a metric and requests you type in.\n                </li>\n                <li className={styles.textPadding}>\n                  Query Advisor sends Prometheus metrics, labels and metadata to the LLM provider you&#39;ve configured.\n                  Be sure to align its usage with your company&#39;s internal policies.\n                </li>\n                <li className={styles.textPadding}>\n                  An AI-suggested query may not fully answer your question. Always take a moment to understand a query\n                  before you use it.\n                </li>\n              </ol>\n            </div>\n            <Alert\n              title={''}\n              severity={'info'}\n              key={'promqail-llm-app'}\n              className={cx(styles.textPadding, styles.noMargin)}\n            >\n              Query Advisor is currently in Private Preview. Feedback is appreciated and can be provided on explanations\n              and suggestions.\n            </Alert>\n\n            {/* don't show this message again, store in localstorage */}\n            <div className={styles.textPadding}>\n              <Checkbox\n                checked={state.indicateCheckbox}\n                value={state.indicateCheckbox}\n                onChange={() => {\n                  const val = store.getBool(SKIP_STARTING_MESSAGE, false);\n                  store.set(SKIP_STARTING_MESSAGE, !val);\n                  dispatch(indicateCheckbox(!val));\n                }}\n                label=\"Don't show this message again\"\n              />\n            </div>\n            <div className={styles.rightButtonsWrapper}>\n              <div className={styles.rightButtons}>\n                <Button className={styles.leftButton} fill=\"outline\" variant=\"secondary\" onClick={closeDrawer}>\n                  Cancel\n                </Button>\n                <Button\n                  fill=\"solid\"\n                  variant=\"primary\"\n                  onClick={() => dispatch(showStartingMessage(false))}\n                  data-testid={testIds.securityInfoButton}\n                >\n                  Continue\n                </Button>\n              </div>\n            </div>\n          </>\n        ) : (\n          <div className={styles.bodySmall}>\n            {/* MAKE THIS TABLE RESPONSIVE */}\n            {/* FIT SUPER LONG METRICS AND LABELS IN HERE */}\n            <div className={styles.textPadding}>Here is the metric you have selected:</div>\n            <div className={styles.infoContainerWrapper}>\n              <div className={styles.infoContainer}>\n                <table className={styles.metricTable}>\n                  <tbody>\n                    <tr>\n                      <td className={styles.metricTableName}>metric</td>\n                      <td className={styles.metricTableValue}>{state.query.metric}</td>\n                      <td>\n                        <Button\n                          fill=\"outline\"\n                          variant=\"secondary\"\n                          onClick={closeDrawer}\n                          className={styles.metricTableButton}\n                          size={'sm'}\n                        >\n                          Choose new metric\n                        </Button>\n                      </td>\n                    </tr>\n                    {state.query.labels.map((label, idx) => {\n                      const text = idx === 0 ? 'labels' : '';\n                      return (\n                        <tr key={`${label.label}-${idx}`}>\n                          <td>{text}</td>\n                          <td className={styles.metricTableValue}>{`${label.label}${label.op}${label.value}`}</td>\n                          <td> </td>\n                        </tr>\n                      );\n                    })}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Ask if you know what you want to query? */}\n            {!state.askForQueryHelp && state.interactions.length === 0 && (\n              <>\n                <div className={styles.queryQuestion}>Do you know what you want to query?</div>\n                <div className={styles.rightButtonsWrapper}>\n                  <div className={styles.rightButtons}>\n                    <Button\n                      className={styles.leftButton}\n                      fill=\"solid\"\n                      variant=\"secondary\"\n                      data-testid={testIds.clickForHistorical}\n                      onClick={() => {\n                        const isLoading = true;\n                        const suggestionType = SuggestionType.Historical;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'no',\n                        });\n                        promQailSuggest(dispatch, 0, query, labelNames, datasource);\n                      }}\n                    >\n                      No\n                    </Button>\n                    <Button\n                      fill=\"solid\"\n                      variant=\"primary\"\n                      data-testid={testIds.clickForAi}\n                      onClick={() => {\n                        reportInteraction('grafana_prometheus_promqail_know_what_you_want_to_query', {\n                          promVisualQuery: query,\n                          doYouKnow: 'yes',\n                        });\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                    >\n                      Yes\n                    </Button>\n                  </div>\n                </div>\n              </>\n            )}\n\n            {state.interactions.map((interaction: Interaction, idx: number) => {\n              return (\n                <div key={idx}>\n                  {interaction.suggestionType === SuggestionType.AI ? (\n                    <>\n                      <div className={styles.textPadding}>What kind of data do you want to see with your metric?</div>\n                      <div className={cx(styles.secondaryText, styles.bottomMargin)}>\n                        <div>You do not need to enter in a metric or a label again in the prompt.</div>\n                        <div>Example: I want to monitor request latency, not errors.</div>\n                      </div>\n                      <div className={styles.inputPadding}>\n                        <Input\n                          value={interaction.prompt}\n                          spellCheck={false}\n                          placeholder=\"Enter prompt\"\n                          disabled={interaction.suggestions.length > 0}\n                          onChange={(e) => {\n                            const prompt = e.currentTarget.value;\n\n                            const payload = {\n                              idx: idx,\n                              interaction: { ...interaction, prompt },\n                            };\n\n                            dispatch(updateInteraction(payload));\n                          }}\n                        />\n                      </div>\n                      {interaction.suggestions.length === 0 ? (\n                        interaction.isLoading ? (\n                          <>\n                            <div className={styles.loadingMessageContainer}>\n                              Waiting for OpenAI <Spinner className={styles.floatRight} />\n                            </div>\n                          </>\n                        ) : (\n                          <>\n                            <div className={styles.rightButtonsWrapper}>\n                              <div className={styles.rightButtons}>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={closeDrawer}\n                                >\n                                  Cancel\n                                </Button>\n                                <Button\n                                  className={styles.leftButton}\n                                  fill=\"outline\"\n                                  variant=\"secondary\"\n                                  onClick={() => {\n                                    // JUST SUGGEST QUERIES AND SHOW THE LIST\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      suggestionType: SuggestionType.Historical,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_suggest_query_instead', {\n                                      promVisualQuery: query,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, newInteraction);\n                                  }}\n                                >\n                                  Suggest queries instead\n                                </Button>\n                                <Button\n                                  fill=\"solid\"\n                                  variant=\"primary\"\n                                  data-testid={testIds.submitPrompt + idx}\n                                  onClick={() => {\n                                    const newInteraction: Interaction = {\n                                      ...interaction,\n                                      isLoading: true,\n                                    };\n\n                                    const payload = {\n                                      idx: idx,\n                                      interaction: newInteraction,\n                                    };\n\n                                    reportInteraction('grafana_prometheus_promqail_prompt_submitted', {\n                                      promVisualQuery: query,\n                                      prompt: interaction.prompt,\n                                    });\n\n                                    dispatch(updateInteraction(payload));\n                                    // add the suggestions in the API call\n                                    promQailSuggest(dispatch, idx, query, labelNames, datasource, interaction);\n                                  }}\n                                >\n                                  Submit\n                                </Button>\n                              </div>\n                            </div>\n                          </>\n                        )\n                      ) : (\n                        // LIST OF SUGGESTED QUERIES FROM AI\n                        <QuerySuggestionContainer\n                          suggestionType={SuggestionType.AI}\n                          querySuggestions={interaction.suggestions}\n                          closeDrawer={closeDrawer}\n                          nextInteraction={() => {\n                            const isLoading = false;\n                            const suggestionType = SuggestionType.AI;\n                            dispatch(addInteraction({ suggestionType, isLoading }));\n                          }}\n                          queryExplain={(suggIdx: number) =>\n                            interaction.suggestions[suggIdx].explanation === ''\n                              ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                              : interaction.suggestions[suggIdx].explanation\n                          }\n                          onChange={onChange}\n                          prompt={interaction.prompt ?? ''}\n                        />\n                      )}\n                    </>\n                  ) : // HISTORICAL SUGGESTIONS\n                  interaction.isLoading ? (\n                    <>\n                      <div className={styles.loadingMessageContainer}>\n                        Waiting for OpenAI <Spinner className={styles.floatRight} />\n                      </div>\n                    </>\n                  ) : (\n                    // LIST OF SUGGESTED QUERIES FROM HISTORICAL DATA\n                    <QuerySuggestionContainer\n                      suggestionType={SuggestionType.Historical}\n                      querySuggestions={interaction.suggestions}\n                      closeDrawer={closeDrawer}\n                      nextInteraction={() => {\n                        const isLoading = false;\n                        const suggestionType = SuggestionType.AI;\n                        dispatch(addInteraction({ suggestionType, isLoading }));\n                      }}\n                      queryExplain={(suggIdx: number) =>\n                        interaction.suggestions[suggIdx].explanation === ''\n                          ? promQailExplain(dispatch, idx, query, interaction, suggIdx, datasource)\n                          : interaction.suggestions[suggIdx].explanation\n                      }\n                      onChange={onChange}\n                      prompt={interaction.prompt ?? ''}\n                    />\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n      <div ref={responsesEndRef} />\n    </div>\n  );\n};\n\nexport const getStyles = (theme: GrafanaTheme2) => {\n  return {\n    sectionPadding: css({\n      padding: '20px',\n    }),\n    header: css({\n      display: 'flex',\n\n      button: {\n        marginLeft: 'auto',\n      },\n    }),\n    iconSection: css({\n      padding: '0 0 10px 0',\n      color: `${theme.colors.text.secondary}`,\n\n      img: {\n        paddingRight: '4px',\n      },\n    }),\n    rightButtonsWrapper: css({\n      display: 'flex',\n    }),\n    rightButtons: css({\n      marginLeft: 'auto',\n    }),\n    leftButton: css({\n      marginRight: '10px',\n    }),\n    dataList: css({\n      padding: '0px 28px 0px 28px',\n    }),\n    textPadding: css({\n      paddingBottom: '12px',\n    }),\n    containerPadding: css({\n      padding: '28px',\n    }),\n    infoContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: '16px',\n      backgroundColor: `${theme.colors.background.secondary}`,\n      borderRadius: `8px`,\n      borderBottomLeftRadius: 0,\n    }),\n    infoContainerWrapper: css({\n      paddingBottom: '24px',\n    }),\n    metricTable: css({\n      width: '100%',\n    }),\n    metricTableName: css({\n      width: '15%',\n    }),\n    metricTableValue: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n      overflow: 'scroll',\n      textWrap: 'nowrap',\n      maxWidth: '150px',\n      width: '60%',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n    }),\n    metricTableButton: css({\n      float: 'right',\n    }),\n    queryQuestion: css({\n      textAlign: 'end',\n      padding: '8px 0',\n    }),\n    secondaryText: css({\n      color: `${theme.colors.text.secondary}`,\n    }),\n    loadingMessageContainer: css({\n      border: `${theme.colors.border.strong}`,\n      padding: `16px`,\n      backgroundColor: `${theme.colors.background.secondary}`,\n      marginBottom: `20px`,\n      borderRadius: `8px`,\n      color: `${theme.colors.text.secondary}`,\n      fontStyle: 'italic',\n    }),\n    floatRight: css({\n      float: 'right',\n    }),\n    codeText: css({\n      fontFamily: `${theme.typography.fontFamilyMonospace}`,\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    bodySmall: css({\n      fontSize: `${theme.typography.bodySmall.fontSize}`,\n    }),\n    explainPadding: css({\n      paddingLeft: '26px',\n    }),\n    bottomMargin: css({\n      marginBottom: '20px',\n    }),\n    topPadding: css({\n      paddingTop: '22px',\n    }),\n    doc: css({\n      textDecoration: 'underline',\n    }),\n    afterButtons: css({\n      display: 'flex',\n      justifyContent: 'flex-end',\n    }),\n    feedbackStyle: css({\n      margin: 0,\n      textAlign: 'right',\n      paddingTop: '22px',\n      paddingBottom: '22px',\n    }),\n    nextInteractionHeight: css({\n      height: '88px',\n    }),\n    center: css({\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n    }),\n    inputPadding: css({\n      paddingBottom: '24px',\n    }),\n    querySuggestion: css({\n      display: 'flex',\n      flexWrap: 'nowrap',\n    }),\n    longCode: css({\n      width: '90%',\n      textWrap: 'nowrap',\n      overflow: 'scroll',\n      maskImage: `linear-gradient(to right, rgba(0, 0, 0, 1) 90%, rgba(0, 0, 0, 0))`,\n\n      div: {\n        display: 'inline-block',\n      },\n    }),\n    useButton: css({\n      marginLeft: 'auto',\n    }),\n    suggestionFeedback: css({\n      textAlign: 'left',\n    }),\n    feedbackQuestion: css({\n      display: 'flex',\n      padding: '8px 0px',\n      h6: { marginBottom: 0 },\n      i: {\n        marginTop: '1px',\n      },\n    }),\n    explationTextInput: css({\n      paddingLeft: '24px',\n    }),\n    submitFeedback: css({\n      padding: '16px 0',\n    }),\n    noMargin: css({\n      margin: 0,\n    }),\n    enableButtonTooltip: css({\n      padding: 8,\n    }),\n    enableButtonTooltipText: css({\n      color: `${theme.colors.text.secondary}`,\n      ul: {\n        marginLeft: 16,\n      },\n    }),\n    link: css({\n      color: `${theme.colors.text.link} !important`,\n    }),\n  };\n};\n\nexport const testIds = {\n  promQail: 'prom-qail',\n  securityInfoButton: 'security-info-button',\n  clickForHistorical: 'click-for-historical',\n  clickForAi: 'click-for-ai',\n  submitPrompt: 'submit-prompt',\n  refinePrompt: 'refine-prompt',\n};\n","import React from 'react';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, Tooltip, useTheme2 } from '@grafana/ui';\n\nimport { getStyles } from './PromQail';\nimport AI_Logo_color from './resources/AI_Logo_color.svg';\n\nexport type Props = {\n  llmAppEnabled: boolean;\n  metric: string;\n  setShowDrawer: (show: boolean) => void;\n};\n\nexport function QueryAssistantButton(props: Props) {\n  const { llmAppEnabled, metric, setShowDrawer } = props;\n\n  const llmAppDisabled = !llmAppEnabled;\n  const noMetricSelected = !metric;\n\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const button = () => {\n    return (\n      <Button\n        variant={'secondary'}\n        onClick={() => {\n          reportInteraction('grafana_prometheus_promqail_ai_button_clicked', {\n            metric: metric,\n          });\n          setShowDrawer(true);\n        }}\n        disabled={!metric || !llmAppEnabled}\n        data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.queryAdvisor}\n      >\n        <img height={16} src={AI_Logo_color} alt=\"AI logo black and white\" />\n        {'\\u00A0'}Get query suggestions\n      </Button>\n    );\n  };\n\n  const selectMetricMessage = (\n    <Tooltip content={'First, select a metric.'} placement={'bottom-end'}>\n      {button()}\n    </Tooltip>\n  );\n\n  const llmAppMessage = (\n    <Tooltip\n      interactive={true}\n      placement={'auto-end'}\n      content={\n        <div className={styles.enableButtonTooltip}>\n          <h6>Query Advisor is disabled</h6>\n          <div className={styles.enableButtonTooltipText}>To enable Query Advisor you must:</div>\n          <div className={styles.enableButtonTooltipText}>\n            <ul>\n              <li>\n                <a\n                  href={'https://grafana.com/docs/grafana-cloud/alerting-and-irm/machine-learning/llm-plugin/'}\n                  target=\"_blank\"\n                  rel=\"noreferrer noopener\"\n                  className={styles.link}\n                >\n                  Install and enable the LLM plugin\n                </a>\n              </li>\n              <li>Select a metric</li>\n            </ul>\n          </div>\n        </div>\n      }\n    >\n      {button()}\n    </Tooltip>\n  );\n\n  if (llmAppDisabled) {\n    return llmAppMessage;\n  } else if (noMetricSelected) {\n    return selectMetricMessage;\n  } else {\n    return button();\n  }\n}\n","import { css } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\n\nimport { DataSourceApi, PanelData } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorRow } from '@grafana/experimental';\nimport { config } from '@grafana/runtime';\nimport { Drawer } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport promqlGrammar from '../../promql';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { OperationExplainedBox } from '../shared/OperationExplainedBox';\nimport { OperationList } from '../shared/OperationList';\nimport { OperationListExplained } from '../shared/OperationListExplained';\nimport { OperationsEditorRow } from '../shared/OperationsEditorRow';\nimport { QueryBuilderHints } from '../shared/QueryBuilderHints';\nimport { RawQuery } from '../shared/RawQuery';\nimport { QueryBuilderOperation } from '../shared/types';\nimport { PromVisualQuery } from '../types';\n\nimport { MetricsLabelsSection } from './MetricsLabelsSection';\nimport { NestedQueryList } from './NestedQueryList';\nimport { EXPLAIN_LABEL_FILTER_CONTENT } from './PromQueryBuilderExplained';\nimport { PromQail } from './promQail/PromQail';\nimport { QueryAssistantButton } from './promQail/QueryAssistantButton';\nimport { isLLMPluginEnabled } from './promQail/state/helpers';\n\nexport interface Props {\n  query: PromVisualQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromVisualQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport const PromQueryBuilder = React.memo<Props>((props) => {\n  const { datasource, query, onChange, onRunQuery, data, showExplain } = props;\n  const [highlightedOp, setHighlightedOp] = useState<QueryBuilderOperation | undefined>();\n  const [showDrawer, setShowDrawer] = useState<boolean>(false);\n  const [llmAppEnabled, updateLlmAppEnabled] = useState<boolean>(false);\n  const { prometheusPromQAIL } = config.featureToggles; // AI/ML + Prometheus\n\n  const lang = { grammar: promqlGrammar, name: 'promql' };\n\n  const initHints = datasource.getInitHints();\n\n  useEffect(() => {\n    async function checkLlms() {\n      const check = await isLLMPluginEnabled();\n      updateLlmAppEnabled(check);\n    }\n\n    if (prometheusPromQAIL) {\n      checkLlms();\n    }\n  }, [prometheusPromQAIL]);\n\n  return (\n    <>\n      {prometheusPromQAIL && showDrawer && (\n        <Drawer closeOnMaskClick={false} onClose={() => setShowDrawer(false)}>\n          <PromQail\n            query={query}\n            closeDrawer={() => setShowDrawer(false)}\n            onChange={onChange}\n            datasource={datasource}\n          />\n        </Drawer>\n      )}\n      <EditorRow>\n        <MetricsLabelsSection query={query} onChange={onChange} datasource={datasource} />\n      </EditorRow>\n      {initHints.length ? (\n        <div className=\"query-row-break\">\n          <div className=\"prom-query-field-info text-warning\">\n            {initHints[0].label}{' '}\n            {initHints[0].fix ? (\n              <button type=\"button\" className={'text-warning'}>\n                {initHints[0].fix.label}\n              </button>\n            ) : null}\n          </div>\n        </div>\n      ) : null}\n      {showExplain && (\n        <OperationExplainedBox\n          stepNumber={1}\n          title={<RawQuery query={`${query.metric} ${promQueryModeller.renderLabels(query.labels)}`} lang={lang} />}\n        >\n          {EXPLAIN_LABEL_FILTER_CONTENT}\n        </OperationExplainedBox>\n      )}\n      <OperationsEditorRow>\n        <OperationList<PromVisualQuery>\n          queryModeller={promQueryModeller}\n          // eslint-ignore\n          datasource={datasource as DataSourceApi}\n          query={query}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          highlightedOp={highlightedOp}\n        />\n        {prometheusPromQAIL && (\n          <div\n            className={css({\n              padding: '0 0 0 6px',\n            })}\n          >\n            <QueryAssistantButton llmAppEnabled={llmAppEnabled} metric={query.metric} setShowDrawer={setShowDrawer} />\n          </div>\n        )}\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.builder.hints}>\n          <QueryBuilderHints<PromVisualQuery>\n            datasource={datasource}\n            query={query}\n            onChange={onChange}\n            data={data}\n            queryModeller={promQueryModeller}\n            buildVisualQueryFromString={buildVisualQueryFromString}\n          />\n        </div>\n      </OperationsEditorRow>\n      {showExplain && (\n        <OperationListExplained<PromVisualQuery>\n          lang={lang}\n          query={query}\n          stepNumber={2}\n          queryModeller={promQueryModeller}\n          onMouseEnter={(op) => setHighlightedOp(op)}\n          onMouseLeave={() => setHighlightedOp(undefined)}\n        />\n      )}\n      {query.binaryQueries && query.binaryQueries.length > 0 && (\n        <NestedQueryList\n          query={query}\n          datasource={datasource}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      )}\n    </>\n  );\n});\n\nPromQueryBuilder.displayName = 'PromQueryBuilder';\n","import React from 'react';\n\nimport { EditorFieldGroup, EditorRow } from '@grafana/experimental';\n\nimport promqlGrammar from '../../promql';\nimport { RawQuery } from '../shared/RawQuery';\n\nexport interface Props {\n  query: string;\n}\n\nexport function QueryPreview({ query }: Props) {\n  if (!query) {\n    return null;\n  }\n\n  return (\n    <EditorRow>\n      <EditorFieldGroup>\n        <RawQuery query={query} lang={{ grammar: promqlGrammar, name: 'promql' }} />\n      </EditorFieldGroup>\n    </EditorRow>\n  );\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer } from 'react';\n\nimport { PanelData } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { PrometheusDatasource } from '../../datasource';\nimport { PromQuery } from '../../types';\nimport { promQueryModeller } from '../PromQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { PromVisualQuery } from '../types';\n\nimport { PromQueryBuilder } from './PromQueryBuilder';\nimport { QueryPreview } from './QueryPreview';\nimport { getSettings, MetricsModalSettings } from './metrics-modal/state/state';\n\nexport interface Props {\n  query: PromQuery;\n  datasource: PrometheusDatasource;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n  data?: PanelData;\n  showExplain: boolean;\n}\n\nexport interface State {\n  visQuery?: PromVisualQuery;\n  expr: string;\n}\n\nconst prometheusMetricEncyclopedia = config.featureToggles.prometheusMetricEncyclopedia;\n/**\n * This component is here just to contain the translation logic between string query and the visual query builder model.\n */\nexport function PromQueryBuilderContainer(props: Props) {\n  const { query, onChange, onRunQuery, datasource, data, showExplain } = props;\n  const [state, dispatch] = useReducer(stateSlice.reducer, { expr: query.expr });\n  // Only rebuild visual query if expr changes from outside\n  useEffect(() => {\n    dispatch(exprChanged(query.expr));\n\n    if (prometheusMetricEncyclopedia) {\n      dispatch(\n        setMetricsModalSettings({\n          useBackend: query.useBackend ?? false,\n          disableTextWrap: query.disableTextWrap ?? false,\n          fullMetaSearch: query.fullMetaSearch ?? false,\n          includeNullMetadata: query.includeNullMetadata ?? true,\n        })\n      );\n    }\n  }, [query]);\n\n  useEffect(() => {\n    datasource.languageProvider.start(data?.timeRange);\n  }, [data?.timeRange, datasource.languageProvider]);\n\n  const onVisQueryChange = (visQuery: PromVisualQuery) => {\n    const expr = promQueryModeller.renderQuery(visQuery);\n    dispatch(visualQueryChange({ visQuery, expr }));\n\n    if (prometheusMetricEncyclopedia) {\n      const metricsModalSettings = getSettings(visQuery);\n      onChange({ ...props.query, expr: expr, ...metricsModalSettings });\n    } else {\n      onChange({ ...props.query, expr: expr });\n    }\n  };\n\n  if (!state.visQuery) {\n    return null;\n  }\n\n  return (\n    <>\n      <PromQueryBuilder\n        query={state.visQuery}\n        datasource={datasource}\n        onChange={onVisQueryChange}\n        onRunQuery={onRunQuery}\n        data={data}\n        showExplain={showExplain}\n      />\n      <QueryPreview query={query.expr} />\n    </>\n  );\n}\n\nconst initialState: State = {\n  expr: '',\n};\n\nconst stateSlice = createSlice({\n  name: 'prom-builder-container',\n  initialState,\n  reducers: {\n    visualQueryChange: (state, action: PayloadAction<{ visQuery: PromVisualQuery; expr: string }>) => {\n      state.expr = action.payload.expr;\n      state.visQuery = action.payload.visQuery;\n    },\n    exprChanged: (state, action: PayloadAction<string>) => {\n      if (!state.visQuery || state.expr !== action.payload) {\n        state.expr = action.payload;\n        const parseResult = buildVisualQueryFromString(action.payload ?? '');\n\n        state.visQuery = parseResult.query;\n      }\n    },\n    setMetricsModalSettings: (state, action: PayloadAction<MetricsModalSettings>) => {\n      if (state.visQuery && prometheusMetricEncyclopedia) {\n        state.visQuery.useBackend = action.payload.useBackend;\n        state.visQuery.disableTextWrap = action.payload.disableTextWrap;\n        state.visQuery.fullMetaSearch = action.payload.fullMetaSearch;\n        state.visQuery.includeNullMetadata = action.payload.includeNullMetadata;\n      }\n    },\n  },\n});\n\nconst { visualQueryChange, exprChanged, setMetricsModalSettings } = stateSlice.actions;\n","import { css, cx } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { IconButton, InlineLabel, Tooltip, useStyles2 } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\ninterface Props {\n  onChange: (exemplar: boolean) => void;\n  datasource: PrometheusDatasource;\n  query: PromQuery;\n  'data-testid'?: string;\n}\n\nexport function PromExemplarField({ datasource, onChange, query, ...rest }: Props) {\n  const [error, setError] = useState<string | null>(null);\n  const styles = useStyles2(getStyles);\n  const prevError = usePrevious(error);\n\n  useEffect(() => {\n    if (!datasource.exemplarsAvailable) {\n      setError('Exemplars for this query are not available');\n      onChange(false);\n    } else if (query.instant && !query.range) {\n      setError('Exemplars are not available for instant queries');\n      onChange(false);\n    } else {\n      setError(null);\n      // If error is cleared, we want to change exemplar to true\n      if (prevError && !error) {\n        onChange(true);\n      }\n    }\n  }, [datasource.exemplarsAvailable, query.instant, query.range, onChange, prevError, error]);\n\n  const iconButtonStyles = cx(\n    {\n      [styles.activeIcon]: !!query.exemplar,\n    },\n    styles.eyeIcon\n  );\n\n  return (\n    <InlineLabel width=\"auto\" data-testid={rest['data-testid']}>\n      <Tooltip content={error ?? ''}>\n        <div className={styles.iconWrapper}>\n          Exemplars\n          <IconButton\n            name=\"eye\"\n            tooltip={!!query.exemplar ? 'Disable query with exemplars' : 'Enable query with exemplars'}\n            disabled={!!error}\n            className={iconButtonStyles}\n            onClick={() => {\n              onChange(!query.exemplar);\n            }}\n          />\n        </div>\n      </Tooltip>\n    </InlineLabel>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    eyeIcon: css`\n      margin-left: ${theme.spacing(2)};\n    `,\n    activeIcon: css`\n      color: ${theme.colors.primary.main};\n    `,\n    iconWrapper: css`\n      display: flex;\n      align-items: center;\n    `,\n  };\n}\n","import { css, cx } from '@emotion/css';\nimport { isEqual } from 'lodash';\nimport React, { memo, useCallback } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { InlineFormLabel, RadioButtonGroup } from '@grafana/ui';\n\nimport { PrometheusDatasource } from '../datasource';\nimport { PromQuery } from '../types';\n\nimport { PromExemplarField } from './PromExemplarField';\n\nexport interface PromExploreExtraFieldProps {\n  query: PromQuery;\n  onChange: (value: PromQuery) => void;\n  onRunQuery: () => void;\n  datasource: PrometheusDatasource;\n}\n\nexport const PromExploreExtraField = memo(({ query, datasource, onChange, onRunQuery }: PromExploreExtraFieldProps) => {\n  const rangeOptions = getQueryTypeOptions(true);\n  const prevQuery = usePrevious(query);\n\n  const onExemplarChange = useCallback(\n    (exemplar: boolean) => {\n      if (!isEqual(query, prevQuery) || exemplar !== query.exemplar) {\n        onChange({ ...query, exemplar });\n      }\n    },\n    [prevQuery, query, onChange]\n  );\n\n  function onChangeQueryStep(interval: string) {\n    onChange({ ...query, interval });\n  }\n\n  function onStepChange(e: React.SyntheticEvent<HTMLInputElement>) {\n    if (e.currentTarget.value !== query.interval) {\n      onChangeQueryStep(e.currentTarget.value);\n    }\n  }\n\n  function onReturnKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === 'Enter' && e.shiftKey) {\n      onRunQuery();\n    }\n  }\n\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  return (\n    <div aria-label=\"Prometheus extra field\" className=\"gf-form-inline\" data-testid={testIds.extraFieldEditor}>\n      {/*Query type field*/}\n      <div\n        data-testid={testIds.queryTypeField}\n        className={cx(\n          'gf-form explore-input-margin',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Query type field\"\n      >\n        <InlineFormLabel width=\"auto\">Query type</InlineFormLabel>\n\n        <RadioButtonGroup\n          options={rangeOptions}\n          value={query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range'}\n          onChange={onQueryTypeChange}\n        />\n      </div>\n      {/*Step field*/}\n      <div\n        data-testid={testIds.stepField}\n        className={cx(\n          'gf-form',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Step field\"\n      >\n        <InlineFormLabel\n          width={6}\n          tooltip={\n            'Time units and built-in variables can be used here, for example: $__interval, $__rate_interval, 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)'\n          }\n        >\n          Min step\n        </InlineFormLabel>\n        <input\n          type={'text'}\n          className=\"gf-form-input width-4\"\n          placeholder={'auto'}\n          onChange={onStepChange}\n          onKeyDown={onReturnKeyDown}\n          value={query.interval ?? ''}\n        />\n      </div>\n\n      <PromExemplarField onChange={onExemplarChange} datasource={datasource} query={query} />\n    </div>\n  );\n});\n\nPromExploreExtraField.displayName = 'PromExploreExtraField';\n\nexport function getQueryTypeOptions(includeBoth: boolean) {\n  const rangeOptions = [\n    { value: 'range', label: 'Range', description: 'Run query over a range of time' },\n    {\n      value: 'instant',\n      label: 'Instant',\n      description: 'Run query against a single point in time. For this query, the \"To\" time is used',\n    },\n  ];\n\n  if (includeBoth) {\n    rangeOptions.push({ value: 'both', label: 'Both', description: 'Run an Instant query and a Range query' });\n  }\n\n  return rangeOptions;\n}\n\nexport function getQueryTypeChangeHandler(query: PromQuery, onChange: (update: PromQuery) => void) {\n  return (queryType: string) => {\n    if (queryType === 'instant') {\n      onChange({ ...query, instant: true, range: false, exemplar: false });\n    } else if (queryType === 'range') {\n      onChange({ ...query, instant: false, range: true });\n    } else {\n      onChange({ ...query, instant: true, range: true });\n    }\n  };\n}\n\nexport const testIds = {\n  extraFieldEditor: 'prom-editor-extra-field',\n  stepField: 'prom-editor-extra-field-step',\n  queryTypeField: 'prom-editor-extra-field-query-type',\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\nimport { useToggle } from 'react-use';\n\nimport { getValueFormat, GrafanaTheme2 } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { Collapse, Icon, Tooltip, useStyles2, Stack } from '@grafana/ui';\nimport { QueryStats } from 'app/plugins/datasource/loki/types';\n\nexport interface Props {\n  title: string;\n  collapsedInfo: string[];\n  queryStats?: QueryStats | null;\n  children: React.ReactNode;\n}\n\nexport function QueryOptionGroup({ title, children, collapsedInfo, queryStats }: Props) {\n  const [isOpen, toggleOpen] = useToggle(false);\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.wrapper}>\n      <Collapse\n        className={styles.collapse}\n        collapsible\n        isOpen={isOpen}\n        onToggle={toggleOpen}\n        label={\n          <Stack gap={0}>\n            <h6 className={styles.title}>{title}</h6>\n            {!isOpen && (\n              <div className={styles.description}>\n                {collapsedInfo.map((x, i) => (\n                  <span key={i}>{x}</span>\n                ))}\n              </div>\n            )}\n          </Stack>\n        }\n      >\n        <div className={styles.body}>{children}</div>\n      </Collapse>\n\n      {queryStats && config.featureToggles.lokiQuerySplitting && (\n        <Tooltip content=\"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part.\">\n          <Icon tabIndex={0} name=\"info-circle\" className={styles.tooltip} size=\"sm\" />\n        </Tooltip>\n      )}\n\n      {queryStats && <p className={styles.stats}>{generateQueryStats(queryStats)}</p>}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    collapse: css({\n      backgroundColor: 'unset',\n      border: 'unset',\n      marginBottom: 0,\n\n      ['> button']: {\n        padding: theme.spacing(0, 1),\n      },\n    }),\n    wrapper: css({\n      width: '100%',\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'baseline',\n    }),\n    title: css({\n      flexGrow: 1,\n      overflow: 'hidden',\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.fontWeightMedium,\n      margin: 0,\n    }),\n    description: css({\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n      fontWeight: theme.typography.bodySmall.fontWeight,\n      paddingLeft: theme.spacing(2),\n      gap: theme.spacing(2),\n      display: 'flex',\n    }),\n    body: css({\n      display: 'flex',\n      gap: theme.spacing(2),\n      flexWrap: 'wrap',\n    }),\n    stats: css({\n      margin: '0px',\n      color: theme.colors.text.secondary,\n      fontSize: theme.typography.bodySmall.fontSize,\n    }),\n    tooltip: css({\n      marginRight: theme.spacing(0.25),\n    }),\n  };\n};\n\nconst generateQueryStats = (queryStats: QueryStats) => {\n  if (queryStats.message) {\n    return queryStats.message;\n  }\n\n  return `This query will process approximately ${convertUnits(queryStats)}.`;\n};\n\nconst convertUnits = (queryStats: QueryStats): string => {\n  const { text, suffix } = getValueFormat('bytes')(queryStats.bytes, 1);\n  return text + suffix;\n};\n","import React, { useRef } from 'react';\n\nimport { SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField } from '@grafana/experimental';\nimport { Select, AutoSizeInput } from '@grafana/ui';\n\nimport { LegendFormatMode } from '../../types';\n\nexport interface Props {\n  legendFormat: string | undefined;\n  onChange: (legendFormat: string) => void;\n  onRunQuery: () => void;\n}\n\nconst legendModeOptions = [\n  {\n    label: 'Auto',\n    value: LegendFormatMode.Auto,\n    description: 'Only includes unique labels',\n  },\n  { label: 'Verbose', value: LegendFormatMode.Verbose, description: 'All label names and values' },\n  { label: 'Custom', value: LegendFormatMode.Custom, description: 'Provide a naming template' },\n];\n\n/**\n * Tests for this component are on the parent level (PromQueryBuilderOptions).\n */\nexport const PromQueryLegendEditor = React.memo<Props>(({ legendFormat, onChange, onRunQuery }) => {\n  const mode = getLegendMode(legendFormat);\n  const inputRef = useRef<HTMLInputElement | null>(null);\n\n  const onLegendFormatChanged = (evt: React.FormEvent<HTMLInputElement>) => {\n    let newFormat = evt.currentTarget.value;\n    if (newFormat.length === 0) {\n      newFormat = LegendFormatMode.Auto;\n    }\n\n    if (newFormat !== legendFormat) {\n      onChange(newFormat);\n      onRunQuery();\n    }\n  };\n\n  const onLegendModeChanged = (value: SelectableValue<LegendFormatMode>) => {\n    switch (value.value!) {\n      case LegendFormatMode.Auto:\n        onChange(LegendFormatMode.Auto);\n        break;\n      case LegendFormatMode.Custom:\n        onChange('{{label_name}}');\n        setTimeout(() => {\n          inputRef.current?.focus();\n          inputRef.current?.setSelectionRange(2, 12, 'forward');\n        }, 10);\n        break;\n      case LegendFormatMode.Verbose:\n        onChange('');\n        break;\n    }\n    onRunQuery();\n  };\n\n  return (\n    <EditorField\n      label=\"Legend\"\n      tooltip=\"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.\"\n      data-testid={selectors.components.DataSource.Prometheus.queryEditor.legend}\n    >\n      <>\n        {mode === LegendFormatMode.Custom && (\n          <AutoSizeInput\n            id=\"legendFormat\"\n            minWidth={22}\n            placeholder=\"auto\"\n            defaultValue={legendFormat}\n            onCommitChange={onLegendFormatChanged}\n            ref={inputRef}\n          />\n        )}\n        {mode !== LegendFormatMode.Custom && (\n          <Select\n            inputId=\"legend.mode\"\n            isSearchable={false}\n            placeholder=\"Select legend mode\"\n            options={legendModeOptions}\n            width={22}\n            onChange={onLegendModeChanged}\n            value={legendModeOptions.find((x) => x.value === mode)}\n          />\n        )}\n      </>\n    </EditorField>\n  );\n});\n\nPromQueryLegendEditor.displayName = 'PromQueryLegendEditor';\n\nfunction getLegendMode(legendFormat: string | undefined) {\n  // This special value means the new smart minimal series naming\n  if (legendFormat === LegendFormatMode.Auto) {\n    return LegendFormatMode.Auto;\n  }\n\n  // Missing or empty legend format is the old verbose behavior\n  if (legendFormat == null || legendFormat === '') {\n    return LegendFormatMode.Verbose;\n  }\n\n  return LegendFormatMode.Custom;\n}\n\nexport function getLegendModeLabel(legendFormat: string | undefined) {\n  const mode = getLegendMode(legendFormat);\n  if (mode !== LegendFormatMode.Custom) {\n    return legendModeOptions.find((x) => x.value === mode)?.label;\n  }\n  return legendFormat;\n}\n","import React, { SyntheticEvent } from 'react';\n\nimport { CoreApp, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorField, EditorRow, EditorSwitch } from '@grafana/experimental';\nimport { AutoSizeInput, RadioButtonGroup, Select } from '@grafana/ui';\n\nimport { getQueryTypeChangeHandler, getQueryTypeOptions } from '../../components/PromExploreExtraField';\nimport { PromQueryFormat } from '../../dataquery';\nimport { PromQuery } from '../../types';\nimport { QueryOptionGroup } from '../shared/QueryOptionGroup';\n\nimport { FORMAT_OPTIONS, INTERVAL_FACTOR_OPTIONS } from './PromQueryEditorSelector';\nimport { getLegendModeLabel, PromQueryLegendEditor } from './PromQueryLegendEditor';\n\nexport interface UIOptions {\n  exemplars: boolean;\n  type: boolean;\n  format: boolean;\n  minStep: boolean;\n  legend: boolean;\n  resolution: boolean;\n}\n\nexport interface Props {\n  query: PromQuery;\n  app?: CoreApp;\n  onChange: (update: PromQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport const PromQueryBuilderOptions = React.memo<Props>(({ query, app, onChange, onRunQuery }) => {\n  const onChangeFormat = (value: SelectableValue<PromQueryFormat>) => {\n    onChange({ ...query, format: value.value });\n    onRunQuery();\n  };\n\n  const onChangeStep = (evt: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, interval: evt.currentTarget.value.trim() });\n    onRunQuery();\n  };\n\n  const queryTypeOptions = getQueryTypeOptions(\n    app === CoreApp.Explore || app === CoreApp.Correlations || app === CoreApp.PanelEditor\n  );\n  const onQueryTypeChange = getQueryTypeChangeHandler(query, onChange);\n\n  const onExemplarChange = (event: SyntheticEvent<HTMLInputElement>) => {\n    const isEnabled = event.currentTarget.checked;\n    onChange({ ...query, exemplar: isEnabled });\n    onRunQuery();\n  };\n\n  const onIntervalFactorChange = (value: SelectableValue<number>) => {\n    onChange({ ...query, intervalFactor: value.value });\n    onRunQuery();\n  };\n\n  const formatOption = FORMAT_OPTIONS.find((option) => option.value === query.format) || FORMAT_OPTIONS[0];\n  const queryTypeValue = getQueryTypeValue(query);\n  const queryTypeLabel = queryTypeOptions.find((x) => x.value === queryTypeValue)!.label;\n\n  return (\n    <EditorRow>\n      <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.options}>\n        <QueryOptionGroup\n          title=\"Options\"\n          collapsedInfo={getCollapsedInfo(query, formatOption.label!, queryTypeLabel, app)}\n        >\n          <PromQueryLegendEditor\n            legendFormat={query.legendFormat}\n            onChange={(legendFormat) => onChange({ ...query, legendFormat })}\n            onRunQuery={onRunQuery}\n          />\n          <EditorField\n            label=\"Min step\"\n            tooltip={\n              <>\n                An additional lower limit for the step parameter of the Prometheus query and for the{' '}\n                <code>$__interval</code> and <code>$__rate_interval</code> variables.\n              </>\n            }\n          >\n            <AutoSizeInput\n              id={selectors.components.DataSource.Prometheus.queryEditor.step}\n              type=\"text\"\n              aria-label=\"Set lower limit for the step parameter\"\n              placeholder={'auto'}\n              minWidth={10}\n              onCommitChange={onChangeStep}\n              defaultValue={query.interval}\n            />\n          </EditorField>\n          <EditorField label=\"Format\">\n            <Select\n              data-testid={selectors.components.DataSource.Prometheus.queryEditor.format}\n              value={formatOption}\n              allowCustomValue\n              onChange={onChangeFormat}\n              options={FORMAT_OPTIONS}\n            />\n          </EditorField>\n          <EditorField label=\"Type\" data-testid={selectors.components.DataSource.Prometheus.queryEditor.type}>\n            <RadioButtonGroup options={queryTypeOptions} value={queryTypeValue} onChange={onQueryTypeChange} />\n          </EditorField>\n          {shouldShowExemplarSwitch(query, app) && (\n            <EditorField label=\"Exemplars\">\n              <EditorSwitch\n                value={query.exemplar || false}\n                onChange={onExemplarChange}\n                id={selectors.components.DataSource.Prometheus.queryEditor.exemplars}\n              />\n            </EditorField>\n          )}\n          {query.intervalFactor && query.intervalFactor > 1 && (\n            <EditorField label=\"Resolution\">\n              <Select\n                aria-label=\"Select resolution\"\n                isSearchable={false}\n                options={INTERVAL_FACTOR_OPTIONS}\n                onChange={onIntervalFactorChange}\n                value={INTERVAL_FACTOR_OPTIONS.find((option) => option.value === query.intervalFactor)}\n              />\n            </EditorField>\n          )}\n        </QueryOptionGroup>\n      </div>\n    </EditorRow>\n  );\n});\n\nfunction shouldShowExemplarSwitch(query: PromQuery, app?: CoreApp) {\n  if (app === CoreApp.UnifiedAlerting || !query.range) {\n    return false;\n  }\n\n  return true;\n}\n\nfunction getQueryTypeValue(query: PromQuery) {\n  return query.range && query.instant ? 'both' : query.instant ? 'instant' : 'range';\n}\n\nfunction getCollapsedInfo(query: PromQuery, formatOption: string, queryType: string, app?: CoreApp): string[] {\n  const items: string[] = [];\n\n  items.push(`Legend: ${getLegendModeLabel(query.legendFormat)}`);\n  items.push(`Format: ${formatOption}`);\n  items.push(`Step: ${query.interval ?? 'auto'}`);\n  items.push(`Type: ${queryType}`);\n\n  if (shouldShowExemplarSwitch(query, app)) {\n    if (query.exemplar) {\n      items.push(`Exemplars: true`);\n    } else {\n      items.push(`Exemplars: false`);\n    }\n  }\n  return items;\n}\n\nPromQueryBuilderOptions.displayName = 'PromQueryBuilderOptions';\n","import { isEqual, map } from 'lodash';\nimport React, { SyntheticEvent, useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, LoadingState, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorHeader, EditorRows, FlexItem } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, ConfirmModal, Space } from '@grafana/ui';\n\nimport { PromQueryEditorProps } from '../../components/types';\nimport { PromQueryFormat } from '../../dataquery';\nimport { PromQuery } from '../../types';\nimport { QueryPatternsModal } from '../QueryPatternsModal';\nimport { promQueryEditorExplainKey, useFlag } from '../hooks/useFlag';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { QueryEditorModeToggle } from '../shared/QueryEditorModeToggle';\nimport { QueryHeaderSwitch } from '../shared/QueryHeaderSwitch';\nimport { QueryEditorMode } from '../shared/types';\nimport { changeEditorMode, getQueryWithDefaults } from '../state';\n\nimport { PromQueryBuilderContainer } from './PromQueryBuilderContainer';\nimport { PromQueryBuilderOptions } from './PromQueryBuilderOptions';\nimport { PromQueryCodeEditor } from './PromQueryCodeEditor';\n\nexport const FORMAT_OPTIONS: Array<SelectableValue<PromQueryFormat>> = [\n  { label: 'Time series', value: 'time_series' },\n  { label: 'Table', value: 'table' },\n  { label: 'Heatmap', value: 'heatmap' },\n];\n\nexport const INTERVAL_FACTOR_OPTIONS: Array<SelectableValue<number>> = map([1, 2, 3, 4, 5, 10], (value: number) => ({\n  value,\n  label: '1/' + value,\n}));\n\ntype Props = PromQueryEditorProps;\n\nexport const PromQueryEditorSelector = React.memo<Props>((props) => {\n  const {\n    onChange,\n    onRunQuery,\n    data,\n    app,\n    onAddQuery,\n    datasource: { defaultEditor },\n    queries,\n  } = props;\n\n  const [parseModalOpen, setParseModalOpen] = useState(false);\n  const [queryPatternsModalOpen, setQueryPatternsModalOpen] = useState(false);\n  const [dataIsStale, setDataIsStale] = useState(false);\n  const { flag: explain, setFlag: setExplain } = useFlag(promQueryEditorExplainKey);\n\n  const query = getQueryWithDefaults(props.query, app, defaultEditor);\n  // This should be filled in from the defaults by now.\n  const editorMode = query.editorMode!;\n\n  const onEditorModeChange = useCallback(\n    (newMetricEditorMode: QueryEditorMode) => {\n      reportInteraction('user_grafana_prometheus_editor_mode_clicked', {\n        newEditor: newMetricEditorMode,\n        previousEditor: query.editorMode ?? '',\n        newQuery: !query.expr,\n        app: app ?? '',\n      });\n\n      if (newMetricEditorMode === QueryEditorMode.Builder) {\n        const result = buildVisualQueryFromString(query.expr || '');\n        // If there are errors, give user a chance to decide if they want to go to builder as that can lose some data.\n        if (result.errors.length) {\n          setParseModalOpen(true);\n          return;\n        }\n      }\n      changeEditorMode(query, newMetricEditorMode, onChange);\n    },\n    [onChange, query, app]\n  );\n\n  useEffect(() => {\n    setDataIsStale(false);\n  }, [data]);\n\n  const onChangeInternal = (query: PromQuery) => {\n    if (!isEqual(query, props.query)) {\n      setDataIsStale(true);\n    }\n    onChange(query);\n  };\n\n  const onShowExplainChange = (e: SyntheticEvent<HTMLInputElement>) => {\n    setExplain(e.currentTarget.checked);\n  };\n\n  return (\n    <>\n      <ConfirmModal\n        isOpen={parseModalOpen}\n        title=\"Parsing error: Switch to the builder mode?\"\n        body=\"There is a syntax error, or the query structure cannot be visualized when switching to the builder mode. Parts of the query may be lost. \"\n        confirmText=\"Continue\"\n        onConfirm={() => {\n          changeEditorMode(query, QueryEditorMode.Builder, onChange);\n          setParseModalOpen(false);\n        }}\n        onDismiss={() => setParseModalOpen(false)}\n      />\n      <QueryPatternsModal\n        isOpen={queryPatternsModalOpen}\n        onClose={() => setQueryPatternsModalOpen(false)}\n        query={query}\n        queries={queries}\n        app={app}\n        onChange={onChange}\n        onAddQuery={onAddQuery}\n      />\n      <EditorHeader>\n        <Button\n          data-testid={selectors.components.QueryBuilder.queryPatterns}\n          variant=\"secondary\"\n          size=\"sm\"\n          onClick={() => setQueryPatternsModalOpen((prevValue) => !prevValue)}\n        >\n          Kick start your query\n        </Button>\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.explain}>\n          <QueryHeaderSwitch label=\"Explain\" value={explain} onChange={onShowExplainChange} />\n        </div>\n        <FlexItem grow={1} />\n        {app !== CoreApp.Explore && app !== CoreApp.Correlations && (\n          <Button\n            variant={dataIsStale ? 'primary' : 'secondary'}\n            size=\"sm\"\n            onClick={onRunQuery}\n            icon={data?.state === LoadingState.Loading ? 'spinner' : undefined}\n            disabled={data?.state === LoadingState.Loading}\n          >\n            Run queries\n          </Button>\n        )}\n        <div data-testid={selectors.components.DataSource.Prometheus.queryEditor.editorToggle}>\n          <QueryEditorModeToggle mode={editorMode} onChange={onEditorModeChange} />\n        </div>\n      </EditorHeader>\n      <Space v={0.5} />\n      <EditorRows>\n        {editorMode === QueryEditorMode.Code && (\n          <PromQueryCodeEditor {...props} query={query} showExplain={explain} onChange={onChangeInternal} />\n        )}\n        {editorMode === QueryEditorMode.Builder && (\n          <PromQueryBuilderContainer\n            query={query}\n            datasource={props.datasource}\n            onChange={onChangeInternal}\n            onRunQuery={props.onRunQuery}\n            data={data}\n            showExplain={explain}\n          />\n        )}\n        <PromQueryBuilderOptions query={query} app={props.app} onChange={onChange} onRunQuery={onRunQuery} />\n      </EditorRows>\n    </>\n  );\n});\n\nPromQueryEditorSelector.displayName = 'PromQueryEditorSelector';\n","import React from 'react';\n\nimport PromQueryField from './PromQueryField';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorForAlerting(props: PromQueryEditorProps) {\n  const { datasource, query, range, data, onChange, onRunQuery } = props;\n\n  return (\n    <PromQueryField\n      datasource={datasource}\n      query={query}\n      onRunQuery={onRunQuery}\n      onChange={onChange}\n      history={[]}\n      range={range}\n      data={data}\n      data-testid={testIds.editor}\n    />\n  );\n}\n\nexport const testIds = {\n  editor: 'prom-editor-cloud-alerting',\n};\n","import React, { memo } from 'react';\n\nimport { CoreApp } from '@grafana/data';\n\nimport { PromQueryEditorSelector } from '../querybuilder/components/PromQueryEditorSelector';\n\nimport { PromQueryEditorForAlerting } from './PromQueryEditorForAlerting';\nimport { PromQueryEditorProps } from './types';\n\nexport function PromQueryEditorByApp(props: PromQueryEditorProps) {\n  const { app } = props;\n\n  switch (app) {\n    case CoreApp.CloudAlerting:\n      return <PromQueryEditorForAlerting {...props} />;\n    default:\n      return <PromQueryEditorSelector {...props} />;\n  }\n}\n\nexport default memo(PromQueryEditorByApp);\n","import { cx } from '@emotion/css';\nimport React from 'react';\n\nimport { DataSourceJsonData, DataSourcePluginOptionsEditorProps } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { ConfigSubSection } from '@grafana/experimental';\nimport { InlineField, Switch, useTheme2 } from '@grafana/ui';\n\nimport { docsTip, overhaulStyles } from './ConfigEditor';\n\ninterface Props<T extends DataSourceJsonData>\n  extends Pick<DataSourcePluginOptionsEditorProps<T>, 'options' | 'onOptionsChange'> {}\n\ninterface AlertingConfig extends DataSourceJsonData {\n  manageAlerts?: boolean;\n}\n\nexport function AlertingSettingsOverhaul<T extends AlertingConfig>({\n  options,\n  onOptionsChange,\n}: Props<T>): JSX.Element {\n  const theme = useTheme2();\n  // imported GrafanaTheme2 from @grafana/data does not match type of same from @grafana/ui\n  // @ts-ignore\n  const styles = overhaulStyles(theme);\n\n  return (\n    <ConfigSubSection title=\"Alerting\" className={cx(styles.container, styles.alertingTop)}>\n      <div className=\"gf-form-group\">\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <InlineField\n              labelWidth={30}\n              label=\"Manage alerts via Alerting UI\"\n              disabled={options.readOnly}\n              tooltip={\n                <>\n                  Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data\n                  source. {docsTip()}\n                </>\n              }\n              interactive={true}\n              className={styles.switchField}\n            >\n              <Switch\n                value={options.jsonData.manageAlerts !== false}\n                onChange={(event) =>\n                  onOptionsChange({\n                    ...options,\n                    jsonData: { ...options.jsonData, manageAlerts: event!.currentTarget.checked },\n                  })\n                }\n                id={selectors.components.DataSource.Prometheus.configPage.manageAlerts}\n              />\n            </InlineField>\n          </div>\n        </div>\n      </div>\n    </ConfigSubSection>\n  );\n}\n","import React, { useState } from 'react';\n\nimport { DataSourceInstanceSettings } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, InlineField, Input, Switch, useTheme2 } from '@grafana/ui';\n\nimport { ExemplarTraceIdDestination } from '../types';\n\nimport { docsTip, overhaulStyles, PROM_CONFIG_LABEL_WIDTH } from './ConfigEditor';\n\ntype Props = {\n  value: ExemplarTraceIdDestination;\n  onChange: (value: ExemplarTraceIdDestination) => void;\n  onDelete: () => void;\n  disabled?: boolean;\n};\n\nexport function ExemplarSetting({ value, onChange, onDelete, disabled }: Props) {\n  const [isInternalLink, setIsInternalLink] = useState(Boolean(value.datasourceUid));\n\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n\n  return (\n    <div className=\"gf-form-group\">\n      <InlineField\n        label=\"Internal link\"\n        labelWidth={PROM_CONFIG_LABEL_WIDTH}\n        disabled={disabled}\n        tooltip={\n          <>\n            Enable this option if you have an internal link. When enabled, this reveals the data source selector. Select\n            the backend tracing data store for your exemplar data. {docsTip()}\n          </>\n        }\n        interactive={true}\n        className={styles.switchField}\n      >\n        <>\n          <Switch\n            value={isInternalLink}\n            data-testid={selectors.components.DataSource.Prometheus.configPage.internalLinkSwitch}\n            onChange={(ev) => setIsInternalLink(ev.currentTarget.checked)}\n          />\n        </>\n      </InlineField>\n\n      {isInternalLink ? (\n        <InlineField\n          label=\"Data source\"\n          labelWidth={PROM_CONFIG_LABEL_WIDTH}\n          tooltip={<>The data source the exemplar is going to navigate to. {docsTip()}</>}\n          disabled={disabled}\n          interactive={true}\n        >\n          <DataSourcePicker\n            tracing={true}\n            current={value.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds: DataSourceInstanceSettings) =>\n              onChange({\n                ...value,\n                datasourceUid: ds.uid,\n                url: undefined,\n              })\n            }\n          />\n        </InlineField>\n      ) : (\n        <InlineField\n          label=\"URL\"\n          labelWidth={PROM_CONFIG_LABEL_WIDTH}\n          tooltip={<>The URL of the trace backend the user would go to see its trace. {docsTip()}</>}\n          disabled={disabled}\n          interactive={true}\n        >\n          <Input\n            placeholder=\"https://example.com/${__value.raw}\"\n            spellCheck={false}\n            width={40}\n            value={value.url}\n            onChange={(event) =>\n              onChange({\n                ...value,\n                datasourceUid: undefined,\n                url: event.currentTarget.value,\n              })\n            }\n          />\n        </InlineField>\n      )}\n\n      <InlineField\n        label=\"URL Label\"\n        labelWidth={PROM_CONFIG_LABEL_WIDTH}\n        tooltip={<>Use to override the button label on the exemplar traceID field. {docsTip()}</>}\n        disabled={disabled}\n        interactive={true}\n      >\n        <Input\n          placeholder=\"Go to example.com\"\n          spellCheck={false}\n          width={40}\n          value={value.urlDisplayLabel}\n          onChange={(event) =>\n            onChange({\n              ...value,\n              urlDisplayLabel: event.currentTarget.value,\n            })\n          }\n        />\n      </InlineField>\n      <InlineField\n        label=\"Label name\"\n        labelWidth={PROM_CONFIG_LABEL_WIDTH}\n        tooltip={<>The name of the field in the labels object that should be used to get the traceID. {docsTip()}</>}\n        disabled={disabled}\n        interactive={true}\n      >\n        <Input\n          placeholder=\"traceID\"\n          spellCheck={false}\n          width={40}\n          value={value.name}\n          onChange={(event) =>\n            onChange({\n              ...value,\n              name: event.currentTarget.value,\n            })\n          }\n        />\n      </InlineField>\n      {!disabled && (\n        <InlineField label=\"Remove exemplar link\" labelWidth={PROM_CONFIG_LABEL_WIDTH} disabled={disabled}>\n          <Button\n            variant=\"destructive\"\n            title=\"Remove exemplar link\"\n            icon=\"times\"\n            onClick={(event) => {\n              event.preventDefault();\n              onDelete();\n            }}\n          />\n        </InlineField>\n      )}\n    </div>\n  );\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { selectors } from '@grafana/e2e-selectors';\nimport { ConfigSubSection } from '@grafana/experimental';\nimport { Button, useTheme2 } from '@grafana/ui';\n\nimport { ExemplarTraceIdDestination } from '../types';\n\nimport { overhaulStyles } from './ConfigEditor';\nimport { ExemplarSetting } from './ExemplarSetting';\n\ntype Props = {\n  options?: ExemplarTraceIdDestination[];\n  onChange: (value: ExemplarTraceIdDestination[]) => void;\n  disabled?: boolean;\n};\n\nexport function ExemplarsSettings({ options, onChange, disabled }: Props) {\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n  return (\n    <div className={styles.sectionBottomPadding}>\n      <ConfigSubSection title=\"Exemplars\" className={styles.container}>\n        {options &&\n          options.map((option, index) => {\n            return (\n              <ExemplarSetting\n                key={index}\n                value={option}\n                onChange={(newField) => {\n                  const newOptions = [...options];\n                  newOptions.splice(index, 1, newField);\n                  onChange(newOptions);\n                }}\n                onDelete={() => {\n                  const newOptions = [...options];\n                  newOptions.splice(index, 1);\n                  onChange(newOptions);\n                }}\n                disabled={disabled}\n              />\n            );\n          })}\n\n        {!disabled && (\n          <Button\n            variant=\"secondary\"\n            data-testid={selectors.components.DataSource.Prometheus.configPage.exemplarsAddButton}\n            className={css`\n              margin-bottom: 10px;\n            `}\n            icon=\"plus\"\n            onClick={(event) => {\n              event.preventDefault();\n              const newOptions = [...(options || []), { name: 'traceID' }];\n              onChange(newOptions);\n            }}\n          >\n            Add\n          </Button>\n        )}\n        {disabled && !options && <i>No exemplars configurations</i>}\n      </ConfigSubSection>\n    </div>\n  );\n}\n","export const PromFlavorVersions: { [index: string]: Array<{ value?: string; label: string }> } = {\n  Prometheus: [\n    { value: undefined, label: 'Please select' },\n    { value: '2.0.0', label: '< 2.14.x' },\n    { value: '2.14.0', label: '2.14.x' },\n    { value: '2.15.0', label: '2.15.x' },\n    { value: '2.16.0', label: '2.16.x' },\n    { value: '2.17.0', label: '2.17.x' },\n    { value: '2.18.0', label: '2.18.x' },\n    { value: '2.19.0', label: '2.19.x' },\n    { value: '2.20.0', label: '2.20.x' },\n    { value: '2.21.0', label: '2.21.x' },\n    { value: '2.22.0', label: '2.22.x' },\n    { value: '2.23.0', label: '2.23.x' },\n    { value: '2.24.0', label: '2.24.x' },\n    { value: '2.25.0', label: '2.25.x' },\n    { value: '2.26.0', label: '2.26.x' },\n    { value: '2.27.0', label: '2.27.x' },\n    { value: '2.28.0', label: '2.28.x' },\n    { value: '2.29.0', label: '2.29.x' },\n    { value: '2.30.0', label: '2.30.x' },\n    { value: '2.31.0', label: '2.31.x' },\n    { value: '2.32.0', label: '2.32.x' },\n    { value: '2.33.0', label: '2.33.x' },\n    { value: '2.34.0', label: '2.34.x' },\n    { value: '2.35.0', label: '2.35.x' },\n    { value: '2.36.0', label: '2.36.x' },\n    { value: '2.37.0', label: '2.37.x' },\n    { value: '2.38.0', label: '2.38.x' },\n    { value: '2.39.0', label: '2.39.x' },\n    { value: '2.40.0', label: '2.40.x' },\n    { value: '2.41.0', label: '2.41.x' },\n    { value: '2.42.0', label: '2.42.x' },\n    { value: '2.43.0', label: '2.43.x' },\n    { value: '2.44.0', label: '2.44.x' },\n    { value: '2.45.0', label: '2.45.x' },\n    { value: '2.46.0', label: '2.46.x' },\n    { value: '2.47.0', label: '2.47.x' },\n    { value: '2.48.0', label: '2.48.x' },\n    { value: '2.49.0', label: '2.49.x' },\n    { value: '2.50.0', label: '2.50.x' },\n\n    // This value will be returned for future versions of prometheus until we add new entries to this object\n    { value: '2.50.1', label: '> 2.50.x' },\n  ],\n  Mimir: [\n    { value: undefined, label: 'Please select' },\n    { value: '2.0.0', label: '2.0.x' },\n    { value: '2.1.0', label: '2.1.x' },\n    { value: '2.2.0', label: '2.2.x' },\n    { value: '2.3.0', label: '2.3.x' },\n    { value: '2.4.0', label: '2.4.x' },\n    { value: '2.5.0', label: '2.5.x' },\n    { value: '2.6.0', label: '2.6.x' },\n    { value: '2.7.0', label: '2.7.x' },\n    { value: '2.8.0', label: '2.8.x' },\n    { value: '2.9.0', label: '2.9.x' },\n    { value: '2.9.1', label: '> 2.9.x' },\n  ],\n  Thanos: [\n    { value: undefined, label: 'Please select' },\n    { value: '0.0.0', label: '< 0.16.x' },\n    { value: '0.16.0', label: '0.16.x' },\n    { value: '0.17.0', label: '0.17.x' },\n    { value: '0.18.0', label: '0.18.x' },\n    { value: '0.19.0', label: '0.19.x' },\n    { value: '0.20.0', label: '0.20.x' },\n    { value: '0.21.0', label: '0.21.x' },\n    { value: '0.22.0', label: '0.22.x' },\n    { value: '0.23.0', label: '0.23.x' },\n    { value: '0.24.0', label: '0.24.x' },\n    { value: '0.25.0', label: '0.25.x' },\n    { value: '0.26.0', label: '0.26.x' },\n    { value: '0.27.0', label: '0.27.x' },\n    { value: '0.28.0', label: '0.28.x' },\n    { value: '0.29.0', label: '0.29.x' },\n    { value: '0.30.0', label: '0.30.x' },\n    { value: '0.31.0', label: '0.31.x' },\n    { value: '0.31.1', label: '> 0.31.x' },\n  ],\n  Cortex: [\n    { value: undefined, label: 'Please select' },\n    { value: '0.0.0', label: '< 1.0.0' },\n    { value: '1.0.0', label: '1.0.0' },\n    { value: '1.1.0', label: '1.1.x' },\n    { value: '1.2.0', label: '1.2.x' },\n    { value: '1.3.0', label: '1.3.x' },\n    { value: '1.4.0', label: '1.4.x' },\n    { value: '1.5.0', label: '1.5.x' },\n    { value: '1.6.0', label: '1.6.x' },\n    { value: '1.7.0', label: '1.7.x' },\n    { value: '1.8.0', label: '1.8.x' },\n    { value: '1.9.0', label: '1.9.x' },\n    { value: '1.10.0', label: '1.10.x' },\n    { value: '1.11.0', label: '1.11.x' },\n    { value: '1.13.0', label: '1.13.x' },\n    { value: '1.14.0', label: '> 1.13.x' },\n  ],\n};\n","import React, { SyntheticEvent, useState } from 'react';\n\nimport {\n  DataSourcePluginOptionsEditorProps,\n  onUpdateDatasourceJsonDataOptionChecked,\n  SelectableValue,\n  updateDatasourcePluginJsonDataOption,\n} from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { ConfigSubSection } from '@grafana/experimental';\nimport { InlineField, Input, Select, Switch, useTheme2 } from '@grafana/ui';\n\nimport { QueryEditorMode } from '../querybuilder/shared/types';\nimport { defaultPrometheusQueryOverlapWindow } from '../querycache/QueryCache';\nimport { PromApplication, PrometheusCacheLevel, PromOptions } from '../types';\n\nimport { docsTip, overhaulStyles, PROM_CONFIG_LABEL_WIDTH, validateInput } from './ConfigEditor';\nimport { ExemplarsSettings } from './ExemplarsSettings';\nimport { PromFlavorVersions } from './PromFlavorVersions';\n\nconst httpOptions = [\n  { value: 'POST', label: 'POST' },\n  { value: 'GET', label: 'GET' },\n];\n\nconst editorOptions = [\n  { value: QueryEditorMode.Builder, label: 'Builder' },\n  { value: QueryEditorMode.Code, label: 'Code' },\n];\n\nconst cacheValueOptions = [\n  { value: PrometheusCacheLevel.Low, label: 'Low' },\n  { value: PrometheusCacheLevel.Medium, label: 'Medium' },\n  { value: PrometheusCacheLevel.High, label: 'High' },\n  { value: PrometheusCacheLevel.None, label: 'None' },\n];\n\ntype PrometheusSelectItemsType = Array<{ value: PromApplication; label: PromApplication }>;\n\nconst prometheusFlavorSelectItems: PrometheusSelectItemsType = [\n  { value: PromApplication.Prometheus, label: PromApplication.Prometheus },\n  { value: PromApplication.Cortex, label: PromApplication.Cortex },\n  { value: PromApplication.Mimir, label: PromApplication.Mimir },\n  { value: PromApplication.Thanos, label: PromApplication.Thanos },\n];\n\ntype Props = Pick<DataSourcePluginOptionsEditorProps<PromOptions>, 'options' | 'onOptionsChange'>;\n\n// single duration input\nexport const DURATION_REGEX = /^$|^\\d+(ms|[Mwdhmsy])$/;\n\n// multiple duration input\nexport const MULTIPLE_DURATION_REGEX = /(\\d+)(.+)/;\n\nconst durationError = 'Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s';\n\nexport const PromSettings = (props: Props) => {\n  const { options, onOptionsChange } = props;\n\n  // We are explicitly adding httpMethod so, it is correctly displayed in dropdown.\n  // This way, it is more predictable for users.\n  if (!options.jsonData.httpMethod) {\n    options.jsonData.httpMethod = 'POST';\n  }\n\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n\n  type ValidDuration = {\n    timeInterval: string;\n    queryTimeout: string;\n    incrementalQueryOverlapWindow: string;\n  };\n\n  const [validDuration, updateValidDuration] = useState<ValidDuration>({\n    timeInterval: '',\n    queryTimeout: '',\n    incrementalQueryOverlapWindow: '',\n  });\n\n  return (\n    <>\n      <ConfigSubSection title=\"Interval behaviour\" className={styles.container}>\n        <div className=\"gf-form-group\">\n          {/* Scrape interval */}\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineField\n                label=\"Scrape interval\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    This interval is how frequently Prometheus scrapes targets. Set this to the typical scrape and\n                    evaluation interval configured in your Prometheus config file. If you set this to a greater value\n                    than your Prometheus config file interval, Grafana will evaluate the data according to this interval\n                    and you will see less data points. Defaults to 15s. {docsTip()}\n                  </>\n                }\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <>\n                  <Input\n                    className=\"width-20\"\n                    value={options.jsonData.timeInterval}\n                    spellCheck={false}\n                    placeholder=\"15s\"\n                    onChange={onChangeHandler('timeInterval', options, onOptionsChange)}\n                    onBlur={(e) =>\n                      updateValidDuration({\n                        ...validDuration,\n                        timeInterval: e.currentTarget.value,\n                      })\n                    }\n                    data-testid={selectors.components.DataSource.Prometheus.configPage.scrapeInterval}\n                  />\n                  {validateInput(validDuration.timeInterval, DURATION_REGEX, durationError)}\n                </>\n              </InlineField>\n            </div>\n          </div>\n          {/* Query Timeout */}\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineField\n                label=\"Query timeout\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={<>Set the Prometheus query timeout. {docsTip()}</>}\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <>\n                  <Input\n                    className=\"width-20\"\n                    value={options.jsonData.queryTimeout}\n                    onChange={onChangeHandler('queryTimeout', options, onOptionsChange)}\n                    spellCheck={false}\n                    placeholder=\"60s\"\n                    onBlur={(e) =>\n                      updateValidDuration({\n                        ...validDuration,\n                        queryTimeout: e.currentTarget.value,\n                      })\n                    }\n                    data-testid={selectors.components.DataSource.Prometheus.configPage.queryTimeout}\n                  />\n                  {validateInput(validDuration.queryTimeout, DURATION_REGEX, durationError)}\n                </>\n              </InlineField>\n            </div>\n          </div>\n        </div>\n      </ConfigSubSection>\n\n      <ConfigSubSection title=\"Query editor\" className={styles.container}>\n        <div className=\"gf-form-group\">\n          <div className=\"gf-form\">\n            <InlineField\n              label=\"Default editor\"\n              labelWidth={PROM_CONFIG_LABEL_WIDTH}\n              tooltip={<>Set default editor option for all users of this data source. {docsTip()}</>}\n              interactive={true}\n              disabled={options.readOnly}\n            >\n              <Select\n                aria-label={`Default Editor (Code or Builder)`}\n                options={editorOptions}\n                value={\n                  editorOptions.find((o) => o.value === options.jsonData.defaultEditor) ??\n                  editorOptions.find((o) => o.value === QueryEditorMode.Builder)\n                }\n                onChange={onChangeHandler('defaultEditor', options, onOptionsChange)}\n                width={40}\n                data-testid={selectors.components.DataSource.Prometheus.configPage.defaultEditor}\n              />\n            </InlineField>\n          </div>\n          <div className=\"gf-form\">\n            <InlineField\n              labelWidth={PROM_CONFIG_LABEL_WIDTH}\n              label=\"Disable metrics lookup\"\n              tooltip={\n                <>\n                  Checking this option will disable the metrics chooser and metric/label support in the query\n                  field&apos;s autocomplete. This helps if you have performance issues with bigger Prometheus instances.{' '}\n                  {docsTip()}\n                </>\n              }\n              interactive={true}\n              disabled={options.readOnly}\n              className={styles.switchField}\n            >\n              <Switch\n                value={options.jsonData.disableMetricsLookup ?? false}\n                onChange={onUpdateDatasourceJsonDataOptionChecked(props, 'disableMetricsLookup')}\n                id={selectors.components.DataSource.Prometheus.configPage.disableMetricLookup}\n              />\n            </InlineField>\n          </div>\n        </div>\n      </ConfigSubSection>\n\n      <ConfigSubSection title=\"Performance\" className={styles.container}>\n        {!options.jsonData.prometheusType && !options.jsonData.prometheusVersion && options.readOnly && (\n          <div className={styles.versionMargin}>\n            For more information on configuring prometheus type and version in data sources, see the{' '}\n            <a\n              className={styles.textUnderline}\n              href=\"https://grafana.com/docs/grafana/latest/administration/provisioning/\"\n            >\n              provisioning documentation\n            </a>\n            .\n          </div>\n        )}\n        <div className=\"gf-form-group\">\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineField\n                label=\"Prometheus type\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    {/* , and attempt to detect the version */}\n                    Set this to the type of your prometheus database, e.g. Prometheus, Cortex, Mimir or Thanos. Changing\n                    this field will save your current settings. Certain types of Prometheus supports or does not support\n                    various APIs. For example, some types support regex matching for label queries to improve\n                    performance. Some types have an API for metadata. If you set this incorrectly you may experience odd\n                    behavior when querying metrics and labels. Please check your Prometheus documentation to ensure you\n                    enter the correct type. {docsTip()}\n                  </>\n                }\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <Select\n                  aria-label=\"Prometheus type\"\n                  options={prometheusFlavorSelectItems}\n                  value={prometheusFlavorSelectItems.find((o) => o.value === options.jsonData.prometheusType)}\n                  onChange={onChangeHandler('prometheusType', options, onOptionsChange)}\n                  width={40}\n                  data-testid={selectors.components.DataSource.Prometheus.configPage.prometheusType}\n                />\n              </InlineField>\n            </div>\n          </div>\n          <div className=\"gf-form-inline\">\n            {options.jsonData.prometheusType && (\n              <div className=\"gf-form\">\n                <InlineField\n                  label={`${options.jsonData.prometheusType} version`}\n                  labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                  tooltip={\n                    <>\n                      Use this to set the version of your {options.jsonData.prometheusType} instance if it is not\n                      automatically configured. {docsTip()}\n                    </>\n                  }\n                  interactive={true}\n                  disabled={options.readOnly}\n                >\n                  <Select\n                    aria-label={`${options.jsonData.prometheusType} type`}\n                    options={PromFlavorVersions[options.jsonData.prometheusType]}\n                    value={PromFlavorVersions[options.jsonData.prometheusType]?.find(\n                      (o) => o.value === options.jsonData.prometheusVersion\n                    )}\n                    onChange={onChangeHandler('prometheusVersion', options, onOptionsChange)}\n                    width={40}\n                    data-testid={selectors.components.DataSource.Prometheus.configPage.prometheusVersion}\n                  />\n                </InlineField>\n              </div>\n            )}\n          </div>\n\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form max-width-30\">\n              <InlineField\n                label=\"Cache level\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    Sets the browser caching level for editor queries. Higher cache settings are recommended for high\n                    cardinality data sources.\n                  </>\n                }\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <Select\n                  width={40}\n                  onChange={onChangeHandler('cacheLevel', options, onOptionsChange)}\n                  options={cacheValueOptions}\n                  value={\n                    cacheValueOptions.find((o) => o.value === options.jsonData.cacheLevel) ?? PrometheusCacheLevel.Low\n                  }\n                  data-testid={selectors.components.DataSource.Prometheus.configPage.cacheLevel}\n                />\n              </InlineField>\n            </div>\n          </div>\n\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form max-width-30\">\n              <InlineField\n                label=\"Incremental querying (beta)\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    This feature will change the default behavior of relative queries to always request fresh data from\n                    the prometheus instance, instead query results will be cached, and only new records are requested.\n                    Turn this on to decrease database and network load.\n                  </>\n                }\n                interactive={true}\n                className={styles.switchField}\n                disabled={options.readOnly}\n              >\n                <Switch\n                  value={options.jsonData.incrementalQuerying ?? false}\n                  onChange={onUpdateDatasourceJsonDataOptionChecked(props, 'incrementalQuerying')}\n                  id={selectors.components.DataSource.Prometheus.configPage.incrementalQuerying}\n                />\n              </InlineField>\n            </div>\n          </div>\n\n          <div className=\"gf-form-inline\">\n            {options.jsonData.incrementalQuerying && (\n              <InlineField\n                label=\"Query overlap window\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    Set a duration like 10m or 120s or 0s. Default of 10 minutes. This duration will be added to the\n                    duration of each incremental request.\n                  </>\n                }\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <>\n                  <Input\n                    onBlur={(e) =>\n                      updateValidDuration({\n                        ...validDuration,\n                        incrementalQueryOverlapWindow: e.currentTarget.value,\n                      })\n                    }\n                    className=\"width-20\"\n                    value={options.jsonData.incrementalQueryOverlapWindow ?? defaultPrometheusQueryOverlapWindow}\n                    onChange={onChangeHandler('incrementalQueryOverlapWindow', options, onOptionsChange)}\n                    spellCheck={false}\n                    data-testid={selectors.components.DataSource.Prometheus.configPage.queryOverlapWindow}\n                  />\n                  {validateInput(validDuration.incrementalQueryOverlapWindow, MULTIPLE_DURATION_REGEX, durationError)}\n                </>\n              </InlineField>\n            )}\n          </div>\n\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form max-width-30\">\n              <InlineField\n                label=\"Disable recording rules (beta)\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={<>This feature will disable recording rules Turn this on to improve dashboard performance</>}\n                interactive={true}\n                className={styles.switchField}\n                disabled={options.readOnly}\n              >\n                <Switch\n                  value={options.jsonData.disableRecordingRules ?? false}\n                  onChange={onUpdateDatasourceJsonDataOptionChecked(props, 'disableRecordingRules')}\n                  id={selectors.components.DataSource.Prometheus.configPage.disableRecordingRules}\n                />\n              </InlineField>\n            </div>\n          </div>\n        </div>\n      </ConfigSubSection>\n\n      <ConfigSubSection title=\"Other\" className={styles.container}>\n        <div className=\"gf-form-group\">\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form max-width-30\">\n              <InlineField\n                label=\"Custom query parameters\"\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    Add custom parameters to the Prometheus query URL. For example timeout, partial_response, dedup, or\n                    max_source_resolution. Multiple parameters should be concatenated together with an &. {docsTip()}\n                  </>\n                }\n                interactive={true}\n                disabled={options.readOnly}\n              >\n                <Input\n                  className=\"width-20\"\n                  value={options.jsonData.customQueryParameters}\n                  onChange={onChangeHandler('customQueryParameters', options, onOptionsChange)}\n                  spellCheck={false}\n                  placeholder=\"Example: max_source_resolution=5m&timeout=10\"\n                  data-testid={selectors.components.DataSource.Prometheus.configPage.customQueryParameters}\n                />\n              </InlineField>\n            </div>\n          </div>\n          <div className=\"gf-form-inline\">\n            {/* HTTP Method */}\n            <div className=\"gf-form\">\n              <InlineField\n                labelWidth={PROM_CONFIG_LABEL_WIDTH}\n                tooltip={\n                  <>\n                    You can use either POST or GET HTTP method to query your Prometheus data source. POST is the\n                    recommended method as it allows bigger queries. Change this to GET if you have a Prometheus version\n                    older than 2.1 or if POST requests are restricted in your network. {docsTip()}\n                  </>\n                }\n                interactive={true}\n                label=\"HTTP method\"\n                disabled={options.readOnly}\n              >\n                <Select\n                  width={40}\n                  aria-label=\"Select HTTP method\"\n                  options={httpOptions}\n                  value={httpOptions.find((o) => o.value === options.jsonData.httpMethod)}\n                  onChange={onChangeHandler('httpMethod', options, onOptionsChange)}\n                  data-testid={selectors.components.DataSource.Prometheus.configPage.httpMethod}\n                />\n              </InlineField>\n            </div>\n          </div>\n        </div>\n      </ConfigSubSection>\n\n      <ExemplarsSettings\n        options={options.jsonData.exemplarTraceIdDestinations}\n        onChange={(exemplarOptions) =>\n          updateDatasourcePluginJsonDataOption(\n            { onOptionsChange, options },\n            'exemplarTraceIdDestinations',\n            exemplarOptions\n          )\n        }\n        disabled={options.readOnly}\n      />\n    </>\n  );\n};\n\nexport const getValueFromEventItem = (eventItem: SyntheticEvent<HTMLInputElement> | SelectableValue<string>) => {\n  if (!eventItem) {\n    return '';\n  }\n\n  if ('currentTarget' in eventItem) {\n    return eventItem.currentTarget.value;\n  }\n\n  return eventItem.value;\n};\n\nconst onChangeHandler =\n  (key: keyof PromOptions, options: Props['options'], onOptionsChange: Props['onOptionsChange']) =>\n  (eventItem: SyntheticEvent<HTMLInputElement> | SelectableValue<string>) => {\n    onOptionsChange({\n      ...options,\n      jsonData: {\n        ...options.jsonData,\n        [key]: getValueFromEventItem(eventItem),\n      },\n    });\n  };\n","import React, { ReactElement, useState } from 'react';\n\nimport { DataSourceSettings } from '@grafana/data';\nimport { Auth, ConnectionSettings, convertLegacyAuthProps, AuthMethod } from '@grafana/experimental';\nimport { PromOptions, docsTip, overhaulStyles } from '@grafana/prometheus';\nimport { SecureSocksProxySettings, useTheme2 } from '@grafana/ui';\n// NEED TO EXPORT THIS FROM GRAFANA/UI FOR EXTERNAL DS\nimport { AzureAuthSettings } from '@grafana/ui/src/components/DataSourceSettings/types';\n\ntype Props = {\n  options: DataSourceSettings<PromOptions, {}>;\n  onOptionsChange: (options: DataSourceSettings<PromOptions, {}>) => void;\n  azureAuthSettings: AzureAuthSettings;\n  sigV4AuthToggleEnabled: boolean | undefined;\n  renderSigV4Editor: React.ReactNode;\n  secureSocksDSProxyEnabled: boolean;\n};\n\n// these are not available yet in grafana\nexport type CustomMethodId = `custom-${string}`;\n\nexport type CustomMethod = {\n  id: CustomMethodId;\n  label: string;\n  description: string;\n  component: ReactElement;\n};\n\nexport const DataSourcehttpSettingsOverhaul = (props: Props) => {\n  const {\n    options,\n    onOptionsChange,\n    azureAuthSettings,\n    sigV4AuthToggleEnabled,\n    renderSigV4Editor,\n    secureSocksDSProxyEnabled,\n  } = props;\n\n  const newAuthProps = convertLegacyAuthProps({\n    config: options,\n    onChange: onOptionsChange,\n  });\n\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n\n  // for custom auth methods sigV4 and azure auth\n  let customMethods: CustomMethod[] = [];\n\n  const [sigV4Selected, setSigV4Selected] = useState<boolean>(options.jsonData.sigV4Auth || false);\n\n  const sigV4Id = 'custom-sigV4Id';\n\n  const sigV4Option: CustomMethod = {\n    id: sigV4Id,\n    label: 'SigV4 auth',\n    description: 'This is SigV4 auth description',\n    component: <>{renderSigV4Editor}</>,\n  };\n\n  if (sigV4AuthToggleEnabled) {\n    customMethods.push(sigV4Option);\n  }\n\n  const azureAuthEnabled: boolean =\n    (azureAuthSettings?.azureAuthSupported && azureAuthSettings.getAzureAuthEnabled(options)) || false;\n\n  const [azureAuthSelected, setAzureAuthSelected] = useState<boolean>(azureAuthEnabled);\n\n  const azureAuthId = 'custom-azureAuthId';\n\n  const azureAuthOption: CustomMethod = {\n    id: azureAuthId,\n    label: 'Azure auth',\n    description: 'This is Azure auth description',\n    component: (\n      <>\n        {azureAuthSettings.azureSettingsUI && (\n          <azureAuthSettings.azureSettingsUI dataSourceConfig={options} onChange={onOptionsChange} />\n        )}\n      </>\n    ),\n  };\n\n  // allow the option to show in the dropdown\n  if (azureAuthSettings?.azureAuthSupported) {\n    customMethods.push(azureAuthOption);\n  }\n\n  function returnSelectedMethod() {\n    if (sigV4Selected) {\n      return sigV4Id;\n    }\n\n    if (azureAuthSelected) {\n      return azureAuthId;\n    }\n\n    return newAuthProps.selectedMethod;\n  }\n\n  // Do we need this switch anymore? Update the language.\n  let urlTooltip;\n  switch (options.access) {\n    case 'direct':\n      urlTooltip = (\n        <>\n          Your access method is <em>Browser</em>, this means the URL needs to be accessible from the browser.\n          {docsTip()}\n        </>\n      );\n      break;\n    case 'proxy':\n      urlTooltip = (\n        <>\n          Your access method is <em>Server</em>, this means the URL needs to be accessible from the grafana\n          backend/server.\n          {docsTip()}\n        </>\n      );\n      break;\n    default:\n      urlTooltip = <>Specify a complete HTTP URL (for example http://your_server:8080) {docsTip()}</>;\n  }\n\n  return (\n    <>\n      <ConnectionSettings\n        urlPlaceholder=\"http://localhost:9090\"\n        config={options}\n        onChange={onOptionsChange}\n        urlLabel=\"Prometheus server URL\"\n        urlTooltip={urlTooltip}\n      />\n      <hr className={`${styles.hrTopSpace} ${styles.hrBottomSpace}`} />\n      <Auth\n        {...newAuthProps}\n        customMethods={customMethods}\n        onAuthMethodSelect={(method) => {\n          // sigV4Id\n          if (sigV4AuthToggleEnabled) {\n            setSigV4Selected(method === sigV4Id);\n          }\n\n          // Azure\n          if (azureAuthSettings?.azureAuthSupported) {\n            setAzureAuthSelected(method === azureAuthId);\n            azureAuthSettings.setAzureAuthEnabled(options, method === azureAuthId);\n          }\n\n          onOptionsChange({\n            ...options,\n            basicAuth: method === AuthMethod.BasicAuth,\n            withCredentials: method === AuthMethod.CrossSiteCredentials,\n            jsonData: {\n              ...options.jsonData,\n              sigV4Auth: method === sigV4Id,\n              oauthPassThru: method === AuthMethod.OAuthForward,\n            },\n          });\n        }}\n        // If your method is selected pass its id to `selectedMethod`,\n        // otherwise pass the id from converted legacy data\n        selectedMethod={returnSelectedMethod()}\n      />\n      <div className={styles.sectionBottomPadding} />\n      {secureSocksDSProxyEnabled && (\n        <>\n          <SecureSocksProxySettings options={options} onOptionsChange={onOptionsChange} />\n          <div className={styles.sectionBottomPadding} />\n        </>\n      )}\n    </>\n  );\n};\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { SIGV4ConnectionConfig } from '@grafana/aws-sdk';\nimport { DataSourcePluginOptionsEditorProps, DataSourceSettings, GrafanaTheme2 } from '@grafana/data';\nimport { AdvancedHttpSettings, ConfigSection, DataSourceDescription } from '@grafana/experimental';\nimport { AlertingSettingsOverhaul, PromOptions, PromSettings } from '@grafana/prometheus';\nimport { config } from '@grafana/runtime';\nimport { Alert, FieldValidationMessage, useTheme2 } from '@grafana/ui';\n\nimport { AzureAuthSettings } from './AzureAuthSettings';\nimport { hasCredentials, setDefaultCredentials, resetCredentials } from './AzureCredentialsConfig';\nimport { DataSourcehttpSettingsOverhaul } from './DataSourceHttpSettingsOverhaulPackage';\n\nexport const PROM_CONFIG_LABEL_WIDTH = 30;\n\nexport type Props = DataSourcePluginOptionsEditorProps<PromOptions>;\n\nexport const ConfigEditor = (props: Props) => {\n  const { options, onOptionsChange } = props;\n\n  const azureAuthSettings = {\n    azureAuthSupported: config.azureAuthEnabled,\n    getAzureAuthEnabled: (config: DataSourceSettings<any, any>): boolean => hasCredentials(config),\n    setAzureAuthEnabled: (config: DataSourceSettings<any, any>, enabled: boolean) =>\n      enabled ? setDefaultCredentials(config) : resetCredentials(config),\n    azureSettingsUI: AzureAuthSettings,\n  };\n\n  const theme = useTheme2();\n  const styles = overhaulStyles(theme);\n\n  return (\n    <>\n      {options.access === 'direct' && (\n        <Alert title=\"Error\" severity=\"error\">\n          Browser access mode in the Prometheus data source is no longer available. Switch to server access mode.\n        </Alert>\n      )}\n      <DataSourceDescription\n        dataSourceName=\"Prometheus\"\n        docsLink=\"https://grafana.com/docs/grafana/latest/datasources/prometheus/configure-prometheus-data-source/\"\n      />\n      <hr className={`${styles.hrTopSpace} ${styles.hrBottomSpace}`} />\n      <DataSourcehttpSettingsOverhaul\n        options={options}\n        onOptionsChange={onOptionsChange}\n        azureAuthSettings={azureAuthSettings}\n        sigV4AuthToggleEnabled={config.sigV4AuthEnabled}\n        renderSigV4Editor={\n          <SIGV4ConnectionConfig inExperimentalAuthComponent={true} {...props}></SIGV4ConnectionConfig>\n        }\n        secureSocksDSProxyEnabled={config.secureSocksDSProxyEnabled}\n      />\n      <hr />\n      <ConfigSection\n        className={styles.advancedSettings}\n        title=\"Advanced settings\"\n        description=\"Additional settings are optional settings that can be configured for more control over your data source.\"\n      >\n        <AdvancedHttpSettings\n          className={styles.advancedHTTPSettingsMargin}\n          config={options}\n          onChange={onOptionsChange}\n        />\n        <AlertingSettingsOverhaul<PromOptions> options={options} onOptionsChange={onOptionsChange} />\n        <PromSettings options={options} onOptionsChange={onOptionsChange} />\n      </ConfigSection>\n    </>\n  );\n};\n/**\n * Use this to return a url in a tooltip in a field. Don't forget to make the field interactive to be able to click on the tooltip\n * @param url\n * @returns\n */\nexport function docsTip(url?: string) {\n  const docsUrl = 'https://grafana.com/docs/grafana/latest/datasources/prometheus/#configure-the-data-source';\n\n  return (\n    <a href={url ? url : docsUrl} target=\"_blank\" rel=\"noopener noreferrer\">\n      Visit docs for more details here.\n    </a>\n  );\n}\n\nexport const validateInput = (\n  input: string,\n  pattern: string | RegExp,\n  errorMessage?: string\n): boolean | JSX.Element => {\n  const defaultErrorMessage = 'Value is not valid';\n  if (input && !input.match(pattern)) {\n    return <FieldValidationMessage>{errorMessage ? errorMessage : defaultErrorMessage}</FieldValidationMessage>;\n  } else {\n    return true;\n  }\n};\n\nexport function overhaulStyles(theme: GrafanaTheme2) {\n  return {\n    additionalSettings: css({\n      marginBottom: '25px',\n    }),\n    secondaryGrey: css({\n      color: `${theme.colors.secondary.text}`,\n      opacity: '65%',\n    }),\n    inlineError: css({\n      margin: '0px 0px 4px 245px',\n    }),\n    switchField: css({\n      alignItems: 'center',\n    }),\n    sectionHeaderPadding: css({\n      paddingTop: '32px',\n    }),\n    sectionBottomPadding: css({\n      paddingBottom: '28px',\n    }),\n    subsectionText: css({\n      fontSize: '12px',\n    }),\n    hrBottomSpace: css({\n      marginBottom: '56px',\n    }),\n    hrTopSpace: css({\n      marginTop: '50px',\n    }),\n    textUnderline: css({\n      textDecoration: 'underline',\n    }),\n    versionMargin: css({\n      marginBottom: '12px',\n    }),\n    advancedHTTPSettingsMargin: css({\n      margin: '24px 0 8px 0',\n    }),\n    advancedSettings: css({\n      paddingTop: '32px',\n    }),\n    alertingTop: css({\n      marginTop: '40px !important',\n    }),\n    overhaulPageHeading: css({\n      fontWeight: '400',\n    }),\n    container: css({\n      maxwidth: '578',\n    }),\n  };\n}\n","import { DataSourcePlugin } from '@grafana/data';\nimport {\n  PrometheusDatasource as PrometheusDatasourcePackage,\n  PromQueryEditorByApp as PromQueryEditorByAppPackage,\n  PromCheatSheet as PromCheatSheetPackage,\n} from '@grafana/prometheus';\nimport { config } from '@grafana/runtime';\n\nimport PromCheatSheet from './components/PromCheatSheet';\nimport PromQueryEditorByApp from './components/PromQueryEditorByApp';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { ConfigEditor as ConfigEditorPackage } from './configuration/ConfigEditorPackage';\nimport { PrometheusDatasource } from './datasource';\n\nconst usePackage = config.featureToggles.usePrometheusFrontendPackage;\n\nconst PrometheusDataSourceUsed = usePackage ? PrometheusDatasourcePackage : PrometheusDatasource;\nconst PromQueryEditorByAppUsed = usePackage ? PromQueryEditorByAppPackage : PromQueryEditorByApp;\nconst ConfigEditorUsed = usePackage ? ConfigEditorPackage : ConfigEditor;\nconst PromCheatSheetUsed = usePackage ? PromCheatSheetPackage : PromCheatSheet;\n\n// @ts-ignore These type errors will be removed when we fully migrate to the @grafana/prometheus package\nexport const plugin = new DataSourcePlugin(PrometheusDataSourceUsed)\n  // @ts-ignore These type errors will be removed when we fully migrate to the @grafana/prometheus package\n  .setQueryEditor(PromQueryEditorByAppUsed)\n  .setConfigEditor(ConfigEditorUsed)\n  .setQueryEditorHelp(PromCheatSheetUsed);\n","// The MIT License (MIT)\n//\n// Copyright (c) Celian Garcia and Augustin Husson @ Amadeus IT Group\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in all\n// copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n// SOFTWARE.\n'use strict';\n// noinspection JSUnusedGlobalSymbols\nexport var promLanguageDefinition = {\n    id: 'promql',\n    extensions: ['.promql'],\n    aliases: ['Prometheus', 'prometheus', 'prom', 'Prom', 'promql', 'Promql', 'promQL', 'PromQL'],\n    mimetypes: [],\n    loader: function () { return import('./promql'); } // eslint-disable-line @typescript-eslint/explicit-function-return-type\n};\n","import { useRef } from 'react';\nvar useLatest = function (value) {\n    var ref = useRef(value);\n    ref.current = value;\n    return ref;\n};\nexport default useLatest;\n"],"names":["addLabelToQuery","query","key","value","operator","vectorSelectorPositions","getVectorSelectorPositions","filter","toLabelFilter","addFilter","tree","positions","to","from","type","visQuery","transformedValue","modeller","PromQueryModeller","newQuery","prev","match","isLast","start","end","labelExists","newLabels","labels","label","Store","def","ret","json","error","errorToThrow","LocalStorageValueProvider","props","children","storageKey","defaultValue","state","setState","onStorageUpdate","v","onSaveToStore","onDeleteFromStore","isCancelablePromiseRejection","promise","makePromiseCancelable","hasCanceled_","resolve","reject","canceledPromiseRejection","val","PrometheusCacheLevel","PromApplication","LegendFormatMode","PromVariableQueryType","DEFAULT_KEYS","EMPTY_SELECTOR","buildCacheHeaders","durationInSeconds","getMetadataString","metric","metadata","help","getMetadataHelp","getMetadataType","PREFIX_DELIMITER_REGEX","secondsInDay","PromQlLanguageProvider","datasource","initialValues","url","params","options","timeRange","processHistogramMetrics","labelName","selector","name","interpolatedName","interpolatedMatch","urlParams","otherLabels","possibleLabelNames","data","usedLabelNames","l","withName","values","processLabels","ac","a","acc","s","headers","fixSummariesMetadata","labelBasedQuery","toPromLikeQuery","promQuery","tokens","labelMatchers","extractLabelMatchers","nameLabelValue","getNameLabelValue","res","token","SelectMenu","maxHeight","innerRef","innerProps","theme","styles","getSelectStyles","CustomScrollbar","VIRTUAL_LIST_ITEM_HEIGHT","VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER","VirtualizedSelectMenu","getValue","initialOffset","option","widthEstimate","heightEstimate","index","style","SelectMenuOptions","isFocused","isSelected","renderOptionLabel","icon","onMouseMove","onMouseOver","rest","Icon","setMetrics","initialMetrics","hasMetadata","nameHaystackDictionaryData","metaHaystackDictionaryData","metricsData","m","metricData","buildMetricData","metaDataString","description","t","displayedMetrics","dispatch","filteredSorted","filterMetrics","setFilteredMetricCount","sliceMetrics","filteredMetrics","needle","idx","calculatePageList","calcResultsPerPage","pages","i","metrics","pageNum","resultsPerPage","calculateResultsPerPage","results","defaultResults","max","getBackendSearchMetrics","metricText","queryString","labelsParams","result","tracking","event","promTypes","placeholders","AdditionalSettings","onChangeFullMetaSearch","onChangeIncludeNullMetadata","onChangeDisableTextWrap","onChangeUseBackend","getStyles","Switch","metricsModaltestIds","Tooltip","FeedbackLink","feedbackUrl","Stack","PROM_CONFIG_LABEL_WIDTH","ConfigEditor","onOptionsChange","overhaulStyles","docsTip","validateInput","input","pattern","errorMessage","defaultErrorMessage","ResultsTable","onChange","onClose","disableTextWrap","selectMetric","metaRows","displayType","addHelpIcon","fullType","descriptiveType","link","noMetricsMessages","message","textHighlight","Button","DEFAULT_RESULTS_PER_PAGE","MAXIMUM_RESULTS_PER_PAGE","initialState","getSettings","uf","fuzzySearch","haystack","dispatcher","idxs","info","order","haystackOrder","matchesSet","mark","part","matched","infoIdx","debouncedFuzzySearch","MetricsModal","isOpen","stateSlice","updateMetricsMetadata","setIsLoading","buildMetrics","typeOptions","debouncedBackendSearch","filterMetricsBackend","fuzzyNameDispatch","haystackData","setNameHaystack","fuzzyMetaDispatch","setMetaHaystack","searchCallback","fullMetaSearchVal","additionalSettings","newVal","setFullMetaSearch","setIncludeNullMetadata","setDisableTextWrap","setUseBackend","Modal","selectors","Input","e","setFuzzySearchQuery","setSelectedTypes","Spinner","Toggletip","ButtonGroup","showAdditionalSettings","Pagination","setPageNum","setResultsPerPage","action","splitSeparator","PROMETHEUS_QUERY_BUILDER_MAX_RESULTS","MetricSelect","onGetMetrics","labelsFilters","metricLookupDisabled","onBlur","variableEditor","prometheusMetricEncyclopedia","metricsModalOption","customFilterOption","searchQuery","cur","matcheSearch","browseOption","formatOptionLabel","meta","formatKeyValueStringsForLabelValuesQuery","formatPrometheusLabelFiltersToString","getMetricLabels","resultsLength","truncateResult","resultsOptions","metricLookupDisabledSearch","debouncedSearch","CustomOption","CustomMenu","stylesMenu","optionsLoaded","asyncSelect","InlineFieldRow","InlineField","EditorFieldGroup","EditorField","filterArray","formatPrometheusLabelFilters","resultSet","regexp","valueSet","__name__","valueArray","limitSuggestions","selectorRegexp","labelRegexp","parseSelector","cursorOffset","prefix","prefixOpen","prefixClose","suffix","suffixClose","suffixOpenIndex","suffixOpen","labelOffset","valueStart","valueEnd","metricMatch","labelKeys","selectorString","expandRecordingRules","mapping","getRuleRegex","ruleName","tmpSplitParts","curr","parts","tmpParts","removeIdx","p","ri","labelFound","tsp","recordingRule","invalidLabelsRegex","addLabelsToExpression","expr","invalidLabelsRegexp","indexOfRegexMatch","exprBeforeRegexMatch","exprAfterRegexMatch","arrayOfLabelObjects","comma","space","obj","existingLabel","potentialLeftOver","baseMetadata","summaryMetadata","item","syntheticMetadata","roundMsToMin","milliseconds","roundSecToMin","seconds","roundSecToNextMin","secondsToRound","items","addLimitInfo","RE2_METACHARACTERS","escapePrometheusRegexp","escapeLabelValueInExactSelector","labelValue","escapeLabelValueInRegexSelector","FromPromLikeMap","ToPromLikeMap","toPromLikeExpr","getMaybeTokenStringContent","labelKey","labelOperator","contentTokens","currentToken","currentStr","labelComparator","getRangeSnapInterval","cacheLevel","range","getPrometheusTime","startTime","startTimeQuantizedSeconds","getClientCacheDurationInMinutes","endTime","endTimeQuantizedSeconds","endTimePlusOneStep","date","roundUp","array","limit","METRIC_LABEL","LIST_ITEM_SIZE","buildSelector","singleMetric","selectedLabels","selectedValues","facetLabels","possibleLabels","lastFacetted","possibleValues","existingValues","stylesFactory","UnthemedPrometheusMetricsBrowser","selected","nextValue","updatedFields","status","cb","languageProvider","lastUsedLabels","rawLabels","arr","rawValues","metricsMetadata","streams","labelSearchTerm","metricSearchTerm","validationStatus","valueSearchTerm","LoadingPlaceholder","nonMetricLabels","empty","metricCount","Label","PrometheusMetricsBrowser","makeStorageService","strings","scope","fallbackValue","target","reason","overrideServices","getOverrideServices","NeverCaseError","getAllMetricNamesCompletions","dataProvider","FUNCTION_COMPLETIONS","f","getAllFunctionsAndMetricNamesCompletions","metricNames","DURATION_COMPLETIONS","text","getAllHistoryCompletions","makeSelector","metricName","allLabels","getLabelNames","getLabelNamesForCompletions","triggerOnInsert","getLabelNamesForSelectorCompletions","getLabelNamesForByCompletions","getLabelValues","getLabelValuesForMetricCompletions","betweenQuotes","getCompletions","situation","move","node","direction","walk","path","current","expectedType","getNodeText","parsePromQLStringLiteral","inside","isPathMatch","resolverPath","cursorPath","ERROR_NODE_NAME","RESOLVERS","resolveLabelKeysWithEquals","resolveTopLevel","resolveInFunction","resolveLabelMatcher","resolveDurations","resolveLabelsForGrouping","LABEL_OP_MAP","getLabelOp","opNode","opChild","getLabel","labelMatcherNode","nameNode","op","valueNode","getLabels","labelMatchersNode","listNode","matcherNode","getNodeChildren","child","getNodeInSubtree","typeId","pos","aggrExpNode","bodyNode","metricIdNode","idNode","inStringNode","parent","labelNameNode","firstListNode","id","metricNameNode","subTreeHasError","getErrorNode","getSituation","maybeErrorNode","currentNode","ids","resolver","getSuggestOptions","getMonacoCompletionItemKind","monaco","getCompletionProvider","model","position","word","positionClone","selectedText","offset","maxIndexDigits","ErrorId","validateQuery","interpolatedQuery","queryLines","parser","interpolatedErrors","parseQuery","parseErrors","queryErrors","interpolatedError","queryError","parseError","findErrorBoundary","isErrorBoundary","nodeRef","isEmptyString","errorNode","startPos","endPos","line","boundary","placeHolderScopedVars","languageConfiguration","aggregations","functions","aggregationsOverTime","_i","aggregations_1","agg","vectorMatching","vectorMatchingRegex","operators","offsetModifier","language","EDITOR_HEIGHT_OFFSET","PROMQL_LANG_ID","PROMQL_SETUP_STARTED","ensurePromQL","aliases","extensions","mimetypes","placeholder","overrideServicesRef","containerRef","history","onRunQuery","initialValue","lpRef","useLatest","historyRef","onRunQueryRef","onBlurRef","onChangeRef","autocompleteDisposeFun","editor","isEditorFocused","getHistory","h","getAllMetricNames","metaItem","getAllLabelNames","getSeriesValues","getSeriesLabels","completionProvider","filteringCompletionProvider","context","dispose","updateElementHeight","containerDiv","pixelHeight","pixelWidth","updateCurrentEditorValue","editorValue","placeholderDecorators","decorators","checkDecorators","newDecorators","markers","MonacoQueryFieldLazy","MonacoQueryFieldWrapper","lastRunValueRef","handleRunQuery","handleBlur","handleChange","LAST_USED_LABELS_KEY","getChooserText","metricsLookupDisabled","hasSyntax","hasMetrics","PromQueryFieldClass","initHints","initHint","queryHints","queryHint","remainingTasks","err","override","nextQuery","hint","prevProps","changedRangeToRefresh","prevRange","sameMinuteFrom","sameMinuteTo","ExtraFieldElement","labelBrowserVisible","syntaxLoaded","chooserText","buttonDisabled","onLastUsedLabelsSave","onLastUsedLabelsDelete","PromQueryField","OperationExplainedBox","title","stepNumber","markdown","RawQuery","lang","className","highlighted","OperationListExplained","queryModeller","onMouseEnter","onMouseLeave","body","EXPLAIN_LABEL_FILTER_CONTENT","PromQueryBuilderExplained","promql","PromQueryCodeEditor","app","showExplain","AnnotationQueryEditor","annotation","onAnnotationChange","EditorRows","EditorRow","AutoSizeInput","ev","Space","EditorSwitch","PrometheusLabelNamesRegex","PrometheusLabelValuesRegex","PrometheusMetricNamesRegex","PrometheusQueryResultRegex","PrometheusLabelNamesRegexWithMatch","migrateVariableQueryToEditor","rawQuery","queryBase","labelNamesMatchQuery","labelNames","labelValuesCheck","labelValues","metricNamesCheck","queryResultCheck","queryResult","varQuery","migrateVariableEditorBackToVariableSupport","QueryVariable","visualQueryQuery","removeLineBreaks","PrometheusMetricFindQuery","labelNamesRegex","labelNamesRegexWithMatch","labelValuesRegex","metricNamesRegex","queryResultRegex","labelNamesQuery","labelValuesQuery","isFilterDefined","metricNamesQuery","queryResultQuery","_labels","metricFilterPattern","matchedMetricName","k","self","SUM_HINT_THRESHOLD_COUNT","getQueryHints","series","hints","nameMatch","counterNameMetric","certain","fixableQuery","fix","mappingForQuery","getInitHints","faro","registerFaro","unpatchedConsole","internalLogger","config","metas","transports","api","instrumentations","amendTable","prevTable","nextTable","prevTimes","nextTimes","pLen","pStart","pEnd","nLen","nStart","nEnd","outTable","_","trimTable","table","fromTime","toTime","times","vals","fromIdx","toIdx","vals2","defaultPrometheusQueryOverlapWindow","getFieldIdent","field","QueryCache","entries","unverifiedOverlap","duration","list","entry","entryTypeCast","isSupported","fetchUrl","requestId","requestTransferSize","currentRequest","previous","savedBytes","request","newFrom","newTo","shouldCache","doPartialQuery","prevTo","refreshIntervalMs","reqTargSigs","targ","targIdent","targSig","cached","newFromPartial","newToDate","newFromPartialDate","requestInfo","respFrames","respByTarget","frame","frames","outFrames","cachedFrames","respFrame","respFrameIdent","cachedFrame","amendedTable","nonEmptyCachedFrames","trimmed","INFINITY_SAMPLE_REGEX","isTableResult","dataFrame","isCumulativeHeatmapResult","transformV2","response","fieldCopy","tableFrames","framesWithoutTable","df","processedTableFrames","transformDFToTable","exemplarFrames","framesWithoutTableAndExemplars","destinations","processedExemplarFrames","exemplarTraceIdDestination","traceIDField","links","getDataLinks","heatmapResults","framesWithoutTableHeatmapsAndExemplars","le","heatmapResultsGroupedByQuery","processedHeatmapResultsGroupedByQuery","heatmapResultsGroup","heatmapResultsGroupedByValues","HISTOGRAM_QUANTILE_LABEL_NAME","notLE","dataFrames","sortedHeatmap","sortSeriesByLabel","mergeHeatmapFrames","transformToHistogramOverTime","otherFrames","flattenedProcessedHeatmapFrames","dfs","dataFramesByRefId","refIds","refId","valueText","getValueText","valueField","getValueField","timeField","getTimeField","labelFields","promLabels","numberField","timeFields","dataFields","parseSampleValue","labelsForField","getLabelValue","fields","responseLength","dataLinks","dsSettings","isMs","valueName","parseValue","displayNameFromDS","getOriginalMetricName","labelData","labelPart","countFields","seriesList","topSeries","bottomSeries","j","bottomPoint","s1","s2","le1","le2","trackQuery","queries","LabelFilterItem","defaultOp","onDelete","onGetLabelNames","onGetLabelValues","invalidLabel","invalidValue","getLabelValuesAutofillSuggestions","debounceDuration","labelNamesMenuOpen","setLabelNamesMenuOpen","labelValuesMenuOpen","setLabelValuesMenuOpen","isMultiSelect","getSelectOptionsFromString","regExp","matches","labelValueSearch","itemValue","InputGroup","Select","change","changes","AccessoryButton","MISSING_LABEL_FILTER_ERROR_MESSAGE","LabelFilters","labelFilterRequired","setItems","onLabelsChange","newItems","x","hasLabelFilter","editorList","EditorList","onChangeItem","InlineLabel","MetricsLabelsSection","onChangeLabels","withTemplateVariableOptions","optionsPromise","variables","forLabel","labelsToConsider","labelsIndex","getLabelValuesAutocompleteSuggestions","interpolatedLabelsToConsider","labelObject","getLabelValuesFromLabelValuesAPI","getLabelValuesFromSeriesAPI","promQLExpression","forLabelInterpolated","set","labelNameString","getMetrics","variableOptions","PromVariableQueryEditor","qryType","setQryType","setLabel","labelNamesMatch","setLabelNamesMatch","setMetric","setVarQuery","seriesQuery","setSeriesQuery","classicQuery","setClassicQuery","labelOptions","setLabelOptions","labelFilters","setLabelFilters","variableQuery","variableMigration","variable","names","labelToConsider","onChangeWithVariableString","updateVar","updLabelFilters","updatedVar","onQueryTypeChange","newType","onLabelChange","newLabel","newLabelvalue","metricsLabelsChange","update","updMetric","onLabelNamesMatchChange","regex","onMetricChange","onVarQueryChange","onSeriesQueryChange","onClassicQueryChange","promVisualQuery","TextArea","PrometheusVariableSupport","templateSrv","of","scopedVars","interpolated","metricFindQuery","map","ANNOTATION_QUERY_STEP_DEFAULT","GET_AND_POST_METADATA_ENDPOINTS","InstantQueryRefIdIndex","PrometheusDatasource","DataSourceWithBackend","instanceSettings","tagKeys","titleFormat","textFormat","step","tagKeysArray","eventList","tags","timeValueTuple","timeStampValue","valueValue","time","activeValuesTimestamps","latestEvent","timestamp","targetVersion","targetFlavor","httpOptions","throwError","overrides","queryUrl","abstractQueries","abstractQuery","endpoint","lastValueFrom","prometheusRegularEscape","prometheusSpecialRegexEscape","escapedValues","currentTargetIdx","targets","processedTargets","processedTarget","fullOrPartialRequest","hasInstantQuery","amendedResponse","tap","interval","minInterval","scrapeInterval","intervalFactor","adjustedInterval","adjusted","alignRange","rateInterval","safeInterval","msRange","sRange","queryModel","rsp","filters","expandedQueries","withAdhocFilters","groups","extractRuleMappingFromGroups","expression","exprWithAdHocFilters","string","defaults","utcOffsetSec","alignedEnd","alignedStart","group","rule","getNextRefIdChar","num","getRefId","letters","QueryPattern","onPatternSelect","hasNewQueryOption","hasPreviousQuery","selectedPatternName","setSelectedPatternName","Card","QueryPatternsModal","onAddQuery","openTabs","setOpenTabs","visualQuery","hasOperations","hasMetric","hasLabels","hasBinaryQueries","selectAsNewQuery","patternType","Collapse","tabs","promQueryEditorExplainKey","getFlagValue","setFlagValue","useFlag","flag","updateFlag","setter","QueryEditorMode","editorModes","QueryEditorModeToggle","mode","RadioButtonGroup","QueryHeaderSwitch","inputProps","dashedLabel","switchIdRef","queryEditorModeDefaultLocalStorageKey","changeEditorMode","editorMode","getDefaultEditorMode","defaultEditor","getQueryWithDefaults","isBothInstantAndRange","OperationInfoButton","operation","show","setShow","middleware","refs","floatingStyles","click","dismiss","getReferenceProps","getFloatingProps","Portal","FlexItem","getOperationDocs","OperationHeader","onRemove","dragHandleProps","onToggleSwitcher","alternatives","alt","newDef","newParams","changedOp","getOperationParamEditor","paramDef","SelectInputParamEditor","BoolInputParamEditor","SimpleInputParamEditor","evt","Checkbox","operationId","selectOptions","valueOption","OperationEditor","flash","highlight","shouldFlash","useFlash","onParamValueChanged","paramIdx","callParamChangedThenOnChange","onAddRestParam","onRemoveRestParam","operationElements","paramIndex","Editor","restParam","lastParamDef","renderAddRestParamButton","provided","keepFlash","setKeepFlash","operationIndex","OperationList","highlightedOp","operations","opsToHighlight","useOperationsHighlight","cascaderOpen","setCascaderOpen","onOperationChange","updatedList","addOptions","category","onAddOperation","operationDef","onDragEnd","element","onCascaderBlur","Cascader","isMounted","useMountedState","prevOperations","usePrevious","newOps","newOp","isSameOp","op1","op2","OperationsEditorRow","QueryBuilderHints","buildVisualQueryFromString","setHints","newVisualQuery","NestedQuery","nestedQuery","IconButton","PromQueryBuilder","NestedQueryList","nestedQueries","onNestedQueryUpdate","suggestionOptions","explationOptions","QuerySuggestionItem","querySuggestion","queryExplain","historical","closeDrawer","last","allSuggestions","prompt","showExp","updShowExp","gaveExplanationFeedback","updateGaveExplanationFeedback","gaveSuggestionFeedback","updateGaveSuggestionFeedback","suggestionFeedback","setSuggestionFeedback","explanationFeedback","setExplanationFeedback","explanation","feedbackToggleTip","updateRadioFeedback","updateTextFeedback","disabledButton","questionOne","RadioButtonList","explanationFeedbackEvent","suggestionFeedbackEvent","pvq","radioInputFeedback","textFeedback","SuggestionType","QuerySuggestionContainer","suggestionType","querySuggestions","nextInteraction","hasNextInteraction","updateHasNextInteraction","secondaryText","refineText","qs","queryAssistanttestIds","search","loggedWarning","health","details","enabled","healthDetails","ExplainSystemPrompt","GetExplainUserPrompt","documentation","metricType","metricMetadata","SuggestSystemPrompt","GetSuggestUserPrompt","question","templates","showStartingMessage","createInteraction","isLoading","generalTemplates","counterTemplates","histogramTemplates","gaugeTemplates","processTemplate","templateData","getTemplateSuggestions","templateSuggestions","OPENAI_MODEL_NAME","promQLTemplatesCollection","getExplainMessage","documentationBody","getSuggestMessages","promQailExplain","interaction","suggIdx","suggestedQuery","promptMessages","interactionToUpdate","updatedSuggestions","sg","sidx","payload","updateInteraction","isContainedIn","sublist","superlist","guessMetricType","allMetrics","underscoreIndex","root","familyMetrics","generateMetricTypeFilters","types","guessMetricFamily","isLLMPluginEnabled","openaiEnabled","vectorEnabled","promQailSuggest","metricFamilyGuess","suggestions","metricLabels","feedTheAI","resultsString","r","SKIP_STARTING_MESSAGE","PromQail","skipStartingMessage","setLabelNames","int","responsesEndRef","scrollToBottom","AI_Logo_color","indicateCheckbox","addInteraction","newInteraction","interactions","updInteraction","QueryAssistantButton","llmAppEnabled","setShowDrawer","llmAppDisabled","noMetricSelected","button","selectMetricMessage","llmAppMessage","setHighlightedOp","showDrawer","updateLlmAppEnabled","prometheusPromQAIL","checkLlms","check","Drawer","QueryPreview","PromQueryBuilderContainer","exprChanged","setMetricsModalSettings","onVisQueryChange","visualQueryChange","metricsModalSettings","parseResult","PromExemplarField","setError","prevError","iconButtonStyles","PromExploreExtraField","rangeOptions","getQueryTypeOptions","prevQuery","onExemplarChange","exemplar","onChangeQueryStep","onStepChange","onReturnKeyDown","getQueryTypeChangeHandler","promExploreExtraFieldTestIds","includeBoth","queryType","QueryOptionGroup","collapsedInfo","toggleOpen","useToggle","legendModeOptions","PromQueryLegendEditor","legendFormat","getLegendMode","inputRef","onLegendFormatChanged","newFormat","onLegendModeChanged","getLegendModeLabel","PromQueryBuilderOptions","onChangeFormat","onChangeStep","queryTypeOptions","isEnabled","onIntervalFactorChange","formatOption","FORMAT_OPTIONS","queryTypeValue","getQueryTypeValue","queryTypeLabel","getCollapsedInfo","shouldShowExemplarSwitch","INTERVAL_FACTOR_OPTIONS","PromQueryEditorSelector","parseModalOpen","setParseModalOpen","queryPatternsModalOpen","setQueryPatternsModalOpen","dataIsStale","setDataIsStale","explain","setExplain","onEditorModeChange","newMetricEditorMode","onChangeInternal","onShowExplainChange","ConfirmModal","EditorHeader","prevValue","PromQueryEditorForAlerting","alertingTestIds","PromQueryEditorByAppBase","PromQueryEditorByApp","CHEAT_SHEET_ITEMS","PromCheatSheet","isConflicting","isInvalid","isDragging","snapshot","testIds","queryStats","generateQueryStats","convertUnits","ConfigSubSection","ExemplarSetting","disabled","isInternalLink","setIsInternalLink","DataSourcePicker","ds","ExemplarsSettings","newField","newOptions","PromFlavorVersions","editorOptions","cacheValueOptions","prometheusFlavorSelectItems","DURATION_REGEX","MULTIPLE_DURATION_REGEX","durationError","validDuration","updateValidDuration","onChangeHandler","exemplarOptions","getValueFromEventItem","eventItem","DataSourcehttpSettingsOverhaul","azureAuthSettings","sigV4AuthToggleEnabled","renderSigV4Editor","secureSocksDSProxyEnabled","newAuthProps","customMethods","sigV4Selected","setSigV4Selected","sigV4Id","sigV4Option","azureAuthEnabled","azureAuthSelected","setAzureAuthSelected","azureAuthId","azureAuthOption","returnSelectedMethod","urlTooltip","ConnectionSettings","Auth","method","SecureSocksProxySettings","AzureAuthSettings","usePackage","PrometheusDataSourceUsed","PromQueryEditorByAppUsed","ConfigEditorUsed","PromCheatSheetUsed","promLanguageDefinition","ref"],"sourceRoot":""}