(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2261],{32346:(Ie,j,b)=>{"use strict";b.d(j,{g:()=>q});var I=b(96540),h=b(32196),R=b(14186),i=b(79924),o=b(10354),Y=b(29020),ie=Object.defineProperty,Z=Object.defineProperties,fe=Object.getOwnPropertyDescriptors,J=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,L=(Q,W,H)=>W in Q?ie(Q,W,{enumerable:!0,configurable:!0,writable:!0,value:H}):Q[W]=H,X=(Q,W)=>{for(var H in W||(W={}))x.call(W,H)&&L(Q,H,W[H]);if(J)for(var H of J(W))w.call(W,H)&&L(Q,H,W[H]);return Q},pe=(Q,W)=>Z(Q,fe(W));const q=({config:Q,onChange:W,className:H})=>{const Pe=te=>{W(pe(X({},Q),{jsonData:pe(X({},Q.jsonData),{keepCookies:te})}))},we=te=>{W(pe(X({},Q),{jsonData:pe(X({},Q.jsonData),{timeout:parseInt(te.currentTarget.value,10)})}))},dt={container:(0,h.css)({maxWidth:578})};return I.createElement(Y.I,{title:"Advanced HTTP settings",className:(0,h.cx)(dt.container,H)},I.createElement(R.I,{htmlFor:"advanced-http-cookies",label:"Allowed cookies",labelWidth:24,tooltip:"Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should be forwarded to the data source.",disabled:Q.readOnly,grow:!0},I.createElement(i.u,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:Q.jsonData.keepCookies,onChange:Pe})),I.createElement(R.I,{htmlFor:"advanced-http-timeout",label:"Timeout",labelWidth:24,tooltip:"HTTP request timeout in seconds",disabled:Q.readOnly,grow:!0},I.createElement(o.p,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:Q.jsonData.timeout,onChange:we})))}},35931:(Ie,j,b)=>{"use strict";b.d(j,{H:()=>i});var I=b(32196),h=b(96540),R=b(40845);function i(Y){const{description:ie,suffix:Z,feature:fe}=Y,J=`Learn more about ${fe}`,x=(0,R.of)(o);return h.createElement("span",{className:x.container},ie,h.createElement("a",{"aria-label":J,href:`https://grafana.com/docs/grafana/next/datasources/${Z}`,rel:"noreferrer",target:"_blank"},J))}const o=Y=>({container:(0,I.css)({color:Y.colors.text.secondary,a:(0,I.css)({color:Y.colors.text.link,textDecoration:"underline",marginLeft:"5px","&:hover":{textDecoration:"none"}})})})},82261:(Ie,j,b)=>{"use strict";b.r(j),b.d(j,{plugin:()=>Hi});var I=b(40187),h=b(69129),R=b(3591),i=b(32196),o=b(96540),Y=b(43127),ie=b(42418),Z=b(40845),fe=b(20084),J=b(76892),x=b(14186),w=b(10354);const L=t=>(e,r)=>{const n={};for(const a in t)n[a]=t[a](e[a],r);return n},X=(t,e,r)=>(0,o.useCallback)(a=>{t(r(e,a))},[t,e,r]),pe=(0,o.createContext)(void 0),q=()=>{const t=(0,o.useContext)(pe);if(!t)throw new Error("Use DispatchContext first.");return t},Q=t=>({name:t,pipelineAgg:""}),W=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,H=t=>t.settings?.model==="ewma",Pe=t=>t.settings?.model==="holt",we=t=>t.settings?.model==="holt_winters",dt=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),te=t=>N[t.type].requiresField,Oe=t=>N[t.type].isPipelineAgg,ze=t=>N[t.type].supportsMultipleBucketPaths,Is=t=>N[t.type].supportsMissing,ft=t=>N[t.type].hasSettings,be=t=>N[t.type].hasMeta,ge=t=>N[t.type].supportsInlineScript,He=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],Lt=t=>He.includes(t),N={count:{label:"Count",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",impliedQueryType:"metrics",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",impliedQueryType:"metrics",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[Q(W([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,impliedQueryType:"raw_document",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,impliedQueryType:"raw_data",isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,impliedQueryType:"logs",supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",impliedQueryType:"metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",impliedQueryType:"metrics",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},ws={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},Qt=(t,e)=>{const r=e.filter(n=>ze(n)?n.pipelineVariables?.some(a=>a.pipelineAgg===t.id):te(n)&&t.id===n.field);return[...r,...r.flatMap(n=>Qt(n,e))]},pt=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],As=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],Ue={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"},gt="3";function Ee(t="1"){return{type:"count",id:t}}function $e(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const Bt=(t,e)=>t.find(r=>r.id===e);function Ae(t,e){return!!t?.metrics?.some(r=>r.type===e)}function Ke(t){return t in ws}function Ts(t){return!!N[t].supportsMultipleBucketPaths}var Re=b(99589);const me=t=>te(t)?`${N[t.type].label} ${t.field}`:N[t.type].label,Ge=t=>Object.entries(t).reduce((e,[r,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const a=Ge(n);return Object.keys(a).length===0?{...e}:{...e,[r]:a}}return{...e,[r]:n}},{}),mt=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},Te=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",ht=t=>!!(0,Re.gte)(t,"7.16.0"),yt="Support for Elasticsearch versions after their end-of-life (currently versions < 7.16) was removed. Using unsupported version of Elasticsearch may lead to unexpected and incorrect results.",vt=t=>t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram",bt=/\$(\w+)|\[\[(\w+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::([^\}]+))?}/g;function Et(t,e){e=e||{};const r=e.delimiter||".";let n=e.maxDepth||3,a=1;const u={};function f(g,y){Object.keys(g).forEach(p=>{const m=g[p],$=e?.safe&&Array.isArray(m),P=Object.prototype.toString.call(m)==="[object Object]",V=y?y+r+p:p;if(e?.maxDepth||(n=a+1),!$&&P&&m&&Object.keys(m).length&&a<n)return++a,f({...m},V);u[V]=m})}return f(t,null),u}var k=b(30038);const Ye=(0,k.VP)("@metrics/add"),Ze=(0,k.VP)("@metrics/remove"),Je=(0,k.VP)("@metrics/toggle_visibility"),Ve=(0,k.VP)("@metrics/change_field"),Me=(0,k.VP)("@metrics/change_type"),$t=(0,k.VP)("@metrics/change_attr"),z=(0,k.VP)("@metrics/change_setting"),jt=(0,k.VP)("@metrics/change_meta"),Ne=(0,k.VP)("init"),Wt=(0,k.VP)("change_query"),qt=(0,k.VP)("change_alias_pattern"),Ms=(t,e)=>Wt.match(e)?e.payload:Ne.match(e)?t||"":t,Cs=(t,e)=>qt.match(e)?e.payload:Ne.match(e)?t||"":t;var Ft=b(91410);const zt=()=>({label:"",query:"*"}),B={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[zt()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:gt}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:Ft.g$.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}},nested:{label:"Nested (experimental)",requiresField:!0,defaultSettings:{}}},Ht=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],ke=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],St=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],Ut=(0,k.VP)("@bucketAggs/add"),Kt=(0,k.VP)("@bucketAggs/remove"),Gt=(0,k.VP)("@bucketAggs/change_type"),Yt=(0,k.VP)("@bucketAggs/change_field"),U=(0,k.VP)("@bucketAggs/change_setting"),Ds=t=>(e,r)=>{if(Ut.match(r)){const n={id:r.payload,type:"terms",settings:B.terms.defaultSettings},a=e[e.length-1];return a?.type==="date_histogram"?[...e.slice(0,e.length-1),n,a]:[...e,n]}return Kt.match(r)?e.filter(n=>n.id!==r.payload):Gt.match(r)?e.map(n=>n.id!==r.payload.id?n:{id:n.id,type:r.payload.newType,settings:B[r.payload.newType].defaultSettings}):Yt.match(r)?e.map(n=>n.id!==r.payload.id?n:{...n,field:r.payload.newField}):Me.match(r)?N[r.payload.type].impliedQueryType!=="metrics"?[]:e.length===0?[{...$e("2"),field:t}]:e:U.match(r)?e.map(n=>{if(n.id!==r.payload.bucketAgg.id)return n;const a=Ge({...n.settings,[r.payload.settingName]:r.payload.newValue});return{...n,settings:{...a}}}):Ne.match(r)?e&&e.length>0?e:[{...$e("2"),field:t}]:e},_s=(t,e)=>{if(Ye.match(e))return[...t,Ee(e.payload)];if(Ze.match(e)){const r=t.find(u=>u.id===e.payload),n=[r,...Qt(r,t)],a=t.filter(u=>!n.some(f=>f.id===u.id));return a.length===0?[Ee("1")]:a}return Me.match(e)?t.filter(r=>N[e.payload.type].impliedQueryType==="metrics"?!0:r.id===e.payload.id).map(r=>r.id!==e.payload.id?r:{id:r.id,type:e.payload.type,...N[e.payload.type].defaults}):Ve.match(e)?t.map(r=>{if(r.id!==e.payload.id)return r;const n={...r,field:e.payload.field};return Oe(r)?{...n,pipelineAgg:e.payload.field}:n}):Je.match(e)?t.map(r=>r.id!==e.payload?r:{...r,hide:!r.hide}):z.match(e)?t.map(r=>{if(r.id!==e.payload.metric.id)return r;if(ft(r)){const n=Ge({...r.settings,[e.payload.settingName]:e.payload.newValue});return{...r,settings:{...n}}}return r}):jt.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:be(r)?{...r,meta:{...r.meta,[e.payload.meta]:e.payload.newValue}}:r):$t.match(e)?t.map(r=>r.id!==e.payload.metric.id?r:{...r,[e.payload.attribute]:e.payload.newValue}):Ne.match(e)?t&&t.length>0?t:[Ee("1")]:t},xt=(0,o.createContext)(void 0),Zt=(0,o.createContext)(void 0),Le=(0,o.createContext)(void 0),Xe=({children:t,onChange:e,onRunQuery:r,query:n,datasource:a,range:u})=>{const f=(0,o.useCallback)(A=>{e(A),r()},[e,r]),g=L({query:Ms,alias:Cs,metrics:_s,bucketAggs:Ds(a.timeField)}),y=X(A=>f({...n,...A,timeField:a.timeField}),n,g),p=!n.metrics||!n.bucketAggs||n.query===void 0,[m,$]=(0,o.useState)(p);return(0,o.useEffect)(()=>{m&&p&&(y(Ne()),$(!1))},[m,y,p]),p?null:o.createElement(xt.Provider,{value:a},o.createElement(Zt.Provider,{value:n},o.createElement(Le.Provider,{value:u},o.createElement(pe.Provider,{value:y},t))))},It=t=>()=>{const e=(0,o.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},Fe=It(Zt),ce=It(xt),et=It(Le),Jt=t=>t.id,Ps=t=>parseInt(t,10),Os=()=>{const{metrics:t,bucketAggs:e}=Fe();return(0,o.useMemo)(()=>(Math.max(...[...t?.map(Jt)||["0"],...e?.map(Jt)||["0"]].map(Ps))+1).toString(),[t,e])};var Ce=b(55852),C=b(2543),tt=b(39268),Qe=b(63056),wt=b(29158);const Xt=({children:t,label:e,onRemoveClick:r,onHideClick:n,hidden:a=!1})=>{const u=(0,Z.of)(es);return o.createElement(tt.C,null,o.createElement(Qe.e,null,o.createElement(J.c,{width:17,as:"div"},o.createElement("span",null,e),o.createElement("span",{className:u.iconWrapper},n&&o.createElement(wt.K,{name:a?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":a,className:u.icon,tooltip:"Hide row"}),o.createElement(wt.K,{name:"trash-alt",size:"sm",className:u.icon,onClick:r||C.noop,disabled:!r,tooltip:"Remove row"})))),t)},es=t=>({iconWrapper:(0,i.css)`
      display: flex;
    `,icon:(0,i.css)`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var ts=b(38401),Be=b(83684),oe=b(75505);const st=t=>B[t.type].requiresField,Rs=["date_histogram","histogram","terms","filters","geohash_grid","nested"],ss=t=>Rs.includes(t),Vs=t=>{if(Lt(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(ss(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},rs=({text:t})=>({label:t,value:t}),rt=t=>{const e=ce(),r=et(),n=Array.isArray(t)?t:Vs(t);let a;return async u=>(a||(a=await(0,oe.s)(e.getFields(n,r))),a.filter(({text:f})=>u===void 0||f.includes(u)).map(rs))},De=(0,i.css)`
  min-width: 150px;
`;var is=b(14578);const ns=(t,e)=>({wrapper:(0,i.css)`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:(0,i.css)`
      padding-top: ${t.spacing(.5)};
    `,icon:(0,i.css)`
      margin-right: ${t.spacing(.5)};
    `,button:(0,i.css)`
      justify-content: start;
      ${e&&(0,i.css)`
        color: ${t.colors.text.disabled};
      `}
    `}),l=({label:t,children:e,hidden:r=!1})=>{const[n,a]=(0,o.useState)(!1),u=(0,Z.$j)(),f=ns(u,r);return o.createElement(Qe.e,null,o.createElement("div",{className:(0,i.cx)(f.wrapper)},o.createElement("button",{className:(0,i.cx)("gf-form-label query-part",f.button,De),onClick:()=>a(!n),"aria-expanded":n,type:"button"},o.createElement(is.I,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:f.icon}),t),n&&o.createElement("div",{className:f.settingsWrapper},e)))};var T=b(88323),it=b(20333);const ne=["1w","1M","1q","1y"];class At{constructor(e){this.timeField=e.timeField}getRangeFilter(){return{[this.timeField]:{gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"}}}buildTermsAgg(e,r,n){if(r.terms={field:e.field},!e.settings)return r;const a=e.settings?.size?parseInt(e.settings.size,10):500;if(r.terms.size=a===0?500:a,e.settings.orderBy!==void 0){r.terms.order={},e.settings.orderBy==="_term"?r.terms.order._key=e.settings.order:r.terms.order[e.settings.orderBy]=e.settings.order;const u=mt(e.settings.orderBy);if(u){for(let f of n.metrics||[])if(f.id===u){f.type==="count"?r.terms.order={_count:e.settings.order}:te(f)&&(r.aggs={},r.aggs[f.id]={[f.type]:{field:f.field}});break}}}return e.settings.min_doc_count!==void 0&&(r.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(r.terms.min_doc_count)&&(r.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(r.terms.missing=e.settings.missing),r}getDateHistogramAgg(e){const r={},n=e.settings||{};r.field=e.field||this.timeField,r.min_doc_count=n.min_doc_count||0,r.extended_bounds={min:"$timeFrom",max:"$timeTo"},r.format="epoch_millis",n.timeZone&&n.timeZone!==Ft.g$.utc&&(r.time_zone=n.timeZone),n.offset!==""&&(r.offset=n.offset);const a=n.interval==="auto"?"${__interval_ms}ms":n.interval;return a!==void 0&&ne.includes(a)?r.calendar_interval=a:r.fixed_interval=a,r}getHistogramAgg(e){return{interval:e.settings?.interval,field:e.field,min_doc_count:e.settings?.min_doc_count||0}}getFiltersAgg(e){const r={};for(let{query:n,label:a}of e.settings?.filters||[])r[a||n]={query_string:{query:n,analyze_wildcard:!0}};return r}documentQuery(e,r){return e.size=r,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}build(e){e.metrics=e.metrics||[Ee()],e.bucketAggs=e.bucketAggs||[$e()],e.timeField=this.timeField;let r,n,a,u,f;const g={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(g.query.bool.filter=[...g.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),e.bucketAggs.length===0&&(r=e.metrics[0],!r||!(r.type==="raw_document"||r.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){r=e.metrics[0];const y=r.settings?.size?parseInt(r.settings.size,10):500;return this.documentQuery(g,y||500)}for(f=g,n=0;n<e.bucketAggs.length;n++){const y=e.bucketAggs[n],p={};switch(y.type){case"date_histogram":{p.date_histogram=this.getDateHistogramAgg(y);break}case"histogram":{p.histogram=this.getHistogramAgg(y);break}case"filters":{p.filters={filters:this.getFiltersAgg(y)};break}case"terms":{this.buildTermsAgg(y,p,e);break}case"geohash_grid":{p.geohash_grid={field:y.field,precision:y.settings?.precision||gt};break}case"nested":{p.nested={path:y.field};break}}f.aggs=f.aggs||{},f.aggs[y.id]=p,f=p}for(f.aggs={},n=0;n<e.metrics.length;n++){if(r=e.metrics[n],r.type==="count")continue;const y={};let p={};if(Oe(r))if(ze(r))if(r.pipelineVariables){for(p={buckets_path:{}},a=0;a<r.pipelineVariables.length;a++)if(u=r.pipelineVariables[a],u.name&&u.pipelineAgg&&/^\d*$/.test(u.pipelineAgg)){const m=Bt(e.metrics,u.pipelineAgg);m&&(m.type==="count"?p.buckets_path[u.name]="_count":p.buckets_path[u.name]=u.pipelineAgg)}}else continue;else if(r.field&&/^\d*$/.test(r.field)){const m=Bt(e.metrics,r.field);m&&(m.type==="count"?p={buckets_path:"_count"}:p={buckets_path:r.field})}else continue;else te(r)&&(p={field:r.field});if(ft(r))switch(Object.entries(r.settings||{}).filter(([m,$])=>$!==null).forEach(([m,$])=>{p[m]=m==="script"?this.buildScript(Te(r)):$}),r.type){case"moving_avg":p={...p,...p?.window!==void 0&&{window:this.toNumber(p.window)},...p?.predict!==void 0&&{predict:this.toNumber(p.predict)},...dt(r)&&{settings:{...p.settings,...Object.fromEntries(Object.entries(p.settings||{}).filter(([m])=>["alpha","beta","gamma","period"].includes(m)).filter(([m,$])=>$!==void 0).map(([m,$])=>[m,this.toNumber($)]))}}};break;case"serial_diff":p={...p,...p.lag!==void 0&&{lag:this.toNumber(p.lag)}};break;case"top_metrics":p={metrics:r.settings?.metrics?.map(m=>({field:m})),size:1},r.settings?.orderBy&&(p.sort=[{[r.settings?.orderBy]:r.settings?.order}]);break}y[r.type]=p,f.aggs[r.id]=y}return g}buildScript(e){return e}toNumber(e){const r=parseFloat(`${e}`);return isNaN(r)?e:r}getTermsQuery(e){const r={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&r.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),r.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:a="key",order:u=a==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(u)<0)throw{message:`Invalid query sort order ${u}`};switch(a){case"key":case"term":const f="_key";r.aggs[1].terms.order[f]=u;break;case"doc_count":r.aggs[1].terms.order._count=u;break;default:throw{message:`Invalid query sort type ${a}`}}return r}getLogsQuery(e,r){let n={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return e.query&&n.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),n=this.documentQuery(n,r),{...n,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[Ue.pre],post_tags:[Ue.post],fragment_size:2147483647}}}}const F=t=>({value:e})=>e===t,nt=(t,e)=>e===void 0||t.some(F(e))?t:[...t,{value:e,label:e}],Ns=({options:t,value:e,onChange:r})=>{const[n,a]=(0,o.useState)(nt(t,e)),u=f=>a([...n,{value:f,label:f}]);return{onCreateOption:f=>{u(f),r({value:f})},onChange:r,allowCustomValue:!0,options:n,value:e}},at=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"},{label:"1w",value:"1w"},{label:"1M",value:"1M"},{label:"1q",value:"1q"},{label:"1y",value:"1y"}],ir=t=>({value:e})=>e===t,nr=(t,e,r)=>!r.some(ir(t))&&t.trim().length>0,O=(t,e)=>t.value?.startsWith(e)||!1,je=t=>t&&ne.includes(t)?"calendar":"fixed",ks=({bucketAgg:t})=>{const e=q(),{current:r}=(0,o.useRef)((0,C.uniqueId)("es-date_histogram-")),n=(0,o.useCallback)(({value:u})=>e(U({bucketAgg:t,settingName:"interval",newValue:u})),[t,e]),a=je(t.settings?.interval||B.date_histogram.defaultSettings?.interval);return o.createElement(o.Fragment,null,o.createElement(x.I,{label:a==="calendar"?"Calendar interval":"Fixed interval",tooltip:a==="calendar"?"Calendar-aware intervals adapt to varying day lengths, month durations, and leap seconds, considering the calendar context.":"Fixed intervals remain constant, always being multiples of SI units, independent of calendar changes.",...se},o.createElement(T.l6,{inputId:(0,C.uniqueId)("es-date_histogram-interval"),isValidNewOption:nr,filterOption:O,...Ns({options:at,value:t.settings?.interval||B.date_histogram.defaultSettings?.interval,onChange:n})})),o.createElement(x.I,{label:"Min Doc Count",...se},o.createElement(w.p,{id:`${r}-min_doc_count`,onBlur:u=>e(U({bucketAgg:t,settingName:"min_doc_count",newValue:u.target.value})),defaultValue:t.settings?.min_doc_count||B.date_histogram.defaultSettings?.min_doc_count})),o.createElement(x.I,{label:"Trim Edges",...se,tooltip:"Trim the edges on the timeseries datapoints"},o.createElement(w.p,{id:`${r}-trime_edges`,onBlur:u=>e(U({bucketAgg:t,settingName:"trimEdges",newValue:u.target.value})),defaultValue:t.settings?.trimEdges||B.date_histogram.defaultSettings?.trimEdges})),o.createElement(x.I,{label:"Offset",...se,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},o.createElement(w.p,{id:`${r}-offset`,onBlur:u=>e(U({bucketAgg:t,settingName:"offset",newValue:u.target.value})),defaultValue:t.settings?.offset||B.date_histogram.defaultSettings?.offset})),o.createElement(x.I,{label:"Timezone",...se},o.createElement(it.U,{value:t.settings?.timeZone||B.date_histogram.defaultSettings?.timeZone,includeInternal:[Ft.g$.utc],onChange:u=>{e(U({bucketAgg:t,settingName:"timeZone",newValue:u}))}})))},as=({index:t,onAdd:e,onRemove:r,elements:n})=>o.createElement("div",{className:(0,i.css)`
        display: flex;
      `},t===0&&o.createElement(Ce.$n,{variant:"secondary",fill:"text",icon:"plus",onClick:e,tooltip:"Add","aria-label":"Add"}),n.length>=2&&o.createElement(Ce.$n,{variant:"secondary",fill:"text",icon:"minus",onClick:r,tooltip:"Remove","aria-label":"Remove"})),lt=(0,k.VP)("@bucketAggregations/filter/add"),Tt=(0,k.VP)("@bucketAggregations/filter/remove"),Se=(0,k.VP)("@bucketAggregations/filter/change"),S=(t=[],e)=>lt.match(e)?[...t,zt()]:Tt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Se.match(e)?t.map((r,n)=>n!==e.payload.index?r:e.payload.filter):t,Ls=({bucketAgg:t})=>{const{current:e}=(0,o.useRef)((0,C.uniqueId)("es-filters-")),r=q(),n=X(a=>r(U({bucketAgg:t,settingName:"filters",newValue:a})),t.settings?.filters,S);return(0,o.useEffect)(()=>{t.settings?.filters?.length||n(lt())},[n,t.settings?.filters?.length]),o.createElement(o.Fragment,null,o.createElement("div",{className:(0,i.css)`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((a,u)=>o.createElement("div",{key:u,className:(0,i.css)`
              display: flex;
            `},o.createElement(x.I,{label:"Query",labelWidth:8},o.createElement("div",{className:(0,i.css)`
                  width: 150px;
                `},o.createElement(fe.X,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onChange:f=>n(Se({index:u,filter:{...a,query:f}})),query:a.query}))),o.createElement(x.I,{label:"Label",labelWidth:8},o.createElement(w.p,{width:16,id:`${e}-label-${u}`,placeholder:"Label",onBlur:f=>n(Se({index:u,filter:{...a,label:f.target.value}})),defaultValue:a.label})),o.createElement(as,{index:u,elements:t.settings?.filters||[],onAdd:()=>n(lt()),onRemove:()=>n(Tt(u))})))))},ls=({bucketAgg:t})=>{const{metrics:e}=Fe(),r=us(e),{current:n}=(0,o.useRef)((0,C.uniqueId)("es-terms-")),a=q();return o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Order",...se},o.createElement(T.l6,{inputId:`${n}-order`,onChange:u=>a(U({bucketAgg:t,settingName:"order",newValue:u.value})),options:ke,value:t.settings?.order||B.terms.defaultSettings?.order})),o.createElement(x.I,{label:"Size",...se},o.createElement(T.l6,{inputId:`${n}-size`,...Ns({options:St,value:t.settings?.size||B.terms.defaultSettings?.size,onChange({value:u}){a(U({bucketAgg:t,settingName:"size",newValue:u}))}})})),o.createElement(x.I,{label:"Min Doc Count",...se},o.createElement(w.p,{id:`${n}-min_doc_count`,onBlur:u=>a(U({bucketAgg:t,settingName:"min_doc_count",newValue:u.target.value})),defaultValue:t.settings?.min_doc_count||B.terms.defaultSettings?.min_doc_count})),o.createElement(x.I,{label:"Order By",...se},o.createElement(T.l6,{inputId:`${n}-order_by`,onChange:u=>a(U({bucketAgg:t,settingName:"orderBy",newValue:u.value})),options:r,value:t.settings?.orderBy||B.terms.defaultSettings?.orderBy})),o.createElement(x.I,{label:"Missing",...se},o.createElement(w.p,{id:`${n}-missing`,onBlur:u=>a(U({bucketAgg:t,settingName:"missing",newValue:u.target.value})),defaultValue:t.settings?.missing||B.terms.defaultSettings?.missing})))};function os(t){return t.meta?Object.keys(t.meta).filter(r=>t.meta?.[r]).map(r=>{let n=r;return r==="std_deviation_bounds_lower"&&(n="std_lower"),r==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${me(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function ue(t){return t.settings?.percents?t.settings.percents.map(e=>{const r=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${me(t)} (${e})`,value:`${t.id}[${r}]`}}):[]}function cs(t){return t.type!=="top_metrics"&&!Oe(t)}const us=(t=[])=>{const e=t.filter(cs).flatMap(r=>r.type==="extended_stats"?os(r):r.type==="percentiles"?ue(r):{label:me(r),value:r.id});return[...Ht,...e]},ds=t=>e=>e.value===t,Mt=t=>{const{metrics:e}=Fe();switch(t.type){case"terms":{const r=t.settings?.order||"desc",n=t.settings?.size||"10",a=parseInt(t.settings?.min_doc_count||"0",10),u=t.settings?.orderBy||"_term";let f="";n!=="0"&&(f=`${ke.find(ds(r))?.label} ${n}, `),a>0&&(f+=`Min Doc Count: ${a}, `),f+="Order by: ";const g=Ht.find(ds(u));if(g)f+=g.label;else{const y=e?.find(p=>p.id===mt(u));y?f+=me(y):f+="metric not found"}return n==="0"&&(f+=` (${r})`),f}case"histogram":{const r=t.settings?.interval||"1000",n=parseInt(t.settings?.min_doc_count||"1",10);return`Interval: ${r}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||B.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${parseInt(t.settings?.precision||gt,10)}`;case"date_histogram":{const r=t.settings?.interval||"auto",n=parseInt(t.settings?.min_doc_count||"0",10),a=parseInt(t.settings?.trimEdges||"0",10);let u=`Interval: ${r}`;return n>0&&(u+=`, Min Doc Count: ${n}`),a>0&&(u+=`, Trim edges: ${a}`),u}default:return"Settings"}},se={labelWidth:18},fs=({bucketAgg:t})=>{const{current:e}=(0,o.useRef)((0,C.uniqueId)("es-setting-")),r=q(),n=Mt(t);return o.createElement(l,{label:n},t.type==="terms"&&o.createElement(ls,{bucketAgg:t}),t.type==="date_histogram"&&o.createElement(ks,{bucketAgg:t}),t.type==="filters"&&o.createElement(Ls,{bucketAgg:t}),t.type==="geohash_grid"&&o.createElement(x.I,{label:"Precision",...se},o.createElement(w.p,{id:`${e}-geohash_grid-precision`,onBlur:a=>r(U({bucketAgg:t,settingName:"precision",newValue:a.target.value})),defaultValue:t.settings?.precision||B[t.type].defaultSettings?.precision})),t.type==="histogram"&&o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Interval",...se},o.createElement(w.p,{id:`${e}-histogram-interval`,onBlur:a=>r(U({bucketAgg:t,settingName:"interval",newValue:a.target.value})),defaultValue:t.settings?.interval||B[t.type].defaultSettings?.interval})),o.createElement(x.I,{label:"Min Doc Count",...se},o.createElement(w.p,{id:`${e}-histogram-min_doc_count`,onBlur:a=>r(U({bucketAgg:t,settingName:"min_doc_count",newValue:a.target.value})),defaultValue:t.settings?.min_doc_count||B[t.type].defaultSettings?.min_doc_count}))))},he=Object.entries(B).map(([t,{label:e}])=>({label:e,value:t})),ps=t=>({label:B[t.type].label,value:t.type}),gs=({value:t})=>{const e=q(),r=rt(t.type);return o.createElement(o.Fragment,null,o.createElement(Qe.e,null,o.createElement(ts.Y,{className:De,options:he,onChange:n=>e(Gt({id:t.id,newType:n.value})),value:ps(t)}),st(t)&&o.createElement(Be.s,{className:De,loadOptions:r,onChange:n=>e(Yt({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),o.createElement(fs,{bucketAgg:t}))},Qs=({nextId:t})=>{const e=q(),{bucketAggs:r}=Fe(),n=r?.length||0;return o.createElement(o.Fragment,null,r.map((a,u)=>o.createElement(Xt,{key:`${a.type}-${a.id}`,label:u===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(Kt(a.id)))},o.createElement(gs,{value:a}),u===0&&o.createElement(Ce.$n,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(Ut(t)),tooltip:"Add grouping condition","aria-label":"Add grouping condition"}))))};var We=b(15292);const ms=(0,i.css)`
  white-space: nowrap;
`,Ct=t=>({label:me(t),value:t}),ot=t=>t.map(Ct),hs=({options:t,onChange:e,className:r,value:n})=>{const a=t.find(u=>u.id===n);return o.createElement(ts.Y,{className:(0,i.cx)(r,ms),options:ot(t),onChange:e,placeholder:"Select Metric",value:a?Ct(a):void 0})};function K({label:t,settingName:e,metric:r,placeholder:n,tooltip:a}){const u=q(),[f]=(0,o.useState)((0,C.uniqueId)("es-field-id-"));let y=r.settings?.[e]||"";return e==="script"&&(y=Te(r)),o.createElement(x.I,{label:t,labelWidth:16,tooltip:a},o.createElement(w.p,{id:f,placeholder:n,onBlur:p=>u(z({metric:r,settingName:e,newValue:p.target.value})),defaultValue:y}))}const Dt=(0,k.VP)("@pipelineVariables/add"),ys=(0,k.VP)("@pipelineVariables/remove"),_t=(0,k.VP)("@pipelineVariables/rename"),Pt=(0,k.VP)("@pipelineVariables/change_metric"),Bs=(t=[],e)=>Dt.match(e)?[...t,Q(W(t))]:ys.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):_t.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,name:e.payload.newName}):Pt.match(e)?t.map((r,n)=>n!==e.payload.index?r:{...r,pipelineAgg:e.payload.newMetric}):t,xe=({value:t,previousMetrics:e})=>{const r=q(),n=X(a=>r($t({metric:t,attribute:"pipelineVariables",newValue:a})),t.pipelineVariables,Bs);return(0,o.useEffect)(()=>{t.pipelineVariables?.length||n(Dt())},[n,t.pipelineVariables?.length]),o.createElement(o.Fragment,null,o.createElement("div",{className:(0,i.css)`
          display: flex;
        `},o.createElement(J.c,{width:16},"Variables"),o.createElement("div",{className:(0,i.css)`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((a,u)=>o.createElement(o.Fragment,{key:(0,C.uniqueId)("es-bs-")},o.createElement("div",{className:(0,i.css)`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},o.createElement(w.p,{"aria-label":"Variable name",defaultValue:a.name,placeholder:"Variable Name",onBlur:f=>n(_t({newName:f.target.value,index:u}))}),o.createElement(hs,{onChange:f=>n(Pt({newMetric:f.value.id,index:u})),options:e,value:a.pipelineAgg})),o.createElement(as,{index:u,elements:t.pipelineVariables||[],onAdd:()=>n(Dt()),onRemove:()=>n(ys(u))}))))),o.createElement(K,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},vs=({metric:t})=>{const e=q(),{current:r}=(0,o.useRef)((0,C.uniqueId)("es-moving-avg-"));return o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Model",labelWidth:16},o.createElement(T.l6,{inputId:`${r}-model`,onChange:n=>e(z({metric:t,settingName:"model",newValue:n.value})),options:As,value:t.settings?.model})),o.createElement(K,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),o.createElement(K,{label:"Predict",settingName:"predict",metric:t}),(H(t)||Pe(t)||we(t))&&o.createElement(x.I,{label:"Alpha",labelWidth:16},o.createElement(w.p,{id:`${r}-alpha`,onBlur:n=>e(z({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(Pe(t)||we(t))&&o.createElement(x.I,{label:"Beta",labelWidth:16},o.createElement(w.p,{id:`${r}-beta`,onBlur:n=>e(z({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),we(t)&&o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Gamma",labelWidth:16},o.createElement(w.p,{id:`${r}-gamma`,onBlur:n=>e(z({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),o.createElement(x.I,{label:"Period",labelWidth:16},o.createElement(w.p,{id:`${r}-period`,onBlur:n=>e(z({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),o.createElement(x.I,{label:"Pad",labelWidth:16},o.createElement(We.K,{id:`${r}-pad`,onChange:n=>e(z({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(H(t)||Pe(t)||we(t))&&o.createElement(x.I,{label:"Minimize",labelWidth:16},o.createElement(We.K,{id:`${r}-minimize`,onChange:n=>e(z({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},Ot=t=>({value:t,label:t}),js=({metric:t})=>{const e=q(),r=rt(["number","date"]),n=rt(t.type);return o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Metrics",labelWidth:16},o.createElement(T.Iv,{onChange:a=>e(z({metric:t,settingName:"metrics",newValue:a.map(u=>u.value)})),loadOptions:n,value:t.settings?.metrics?.map(Ot),closeMenuOnSelect:!1,defaultOptions:!0})),o.createElement(x.I,{label:"Order",labelWidth:16},o.createElement(T.l6,{onChange:a=>e(z({metric:t,settingName:"order",newValue:a.value})),options:ke,value:t.settings?.order})),o.createElement(x.I,{label:"Order By",labelWidth:16,className:(0,i.css)`
          & > div {
            width: 100%;
          }
        `},o.createElement(Be.s,{className:(0,i.css)`
            margin-right: 0;
          `,loadOptions:r,onChange:a=>e(z({metric:t,settingName:"orderBy",newValue:a.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},D=t=>e=>e.value===t,Rt=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([r,n])=>n&&pt.find(D(r))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},s={labelWidth:16},c=({metric:t,previousMetrics:e})=>{const{current:r}=(0,o.useRef)((0,C.uniqueId)("es-setting-")),n=q(),a=Rt(t),u=(0,o.useId)(),f=(0,o.useId)(),g=(0,o.useId)(),y=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],p=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return o.createElement(l,{label:a,hidden:t.hide},t.type==="derivative"&&o.createElement(K,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&o.createElement(K,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&o.createElement(K,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&o.createElement(vs,{metric:t}),t.type==="moving_fn"&&o.createElement(o.Fragment,null,o.createElement(K,{label:"Window",metric:t,settingName:"window"}),o.createElement(K,{label:"Script",metric:t,settingName:"script"}),o.createElement(K,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&o.createElement(js,{metric:t}),t.type==="bucket_script"&&o.createElement(xe,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&o.createElement(x.I,{label:"Size",...s,htmlFor:u},o.createElement(w.p,{id:u,onBlur:m=>n(z({metric:t,settingName:"size",newValue:m.target.value})),defaultValue:t.settings?.size??N.raw_data.defaults.settings?.size})),t.type==="logs"&&o.createElement(K,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&o.createElement(K,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&o.createElement(o.Fragment,null,pt.map(m=>o.createElement(d,{key:m.value,stat:m,onChange:$=>n(jt({metric:t,meta:m.value,newValue:$})),value:t.meta?.[m.value]!==void 0?!!t.meta?.[m.value]:!!N.extended_stats.defaults.meta?.[m.value]})),o.createElement(K,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&o.createElement(x.I,{label:"Percentiles",...s},o.createElement(w.p,{id:`${r}-percentiles-percents`,onBlur:m=>n(z({metric:t,settingName:"percents",newValue:m.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||N.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&o.createElement(o.Fragment,null,o.createElement(x.I,{label:"Unit",...s,"data-testid":"unit-select",htmlFor:f},o.createElement(T.l6,{id:f,onChange:m=>n(z({metric:t,settingName:"unit",newValue:m.value})),options:y,value:t.settings?.unit})),o.createElement(x.I,{label:"Mode",...s,"data-testid":"mode-select",htmlFor:g},o.createElement(T.l6,{id:g,onChange:m=>n(z({metric:t,settingName:"mode",newValue:m.value})),options:p,value:t.settings?.unit}))),ge(t)&&o.createElement(K,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),Is(t)&&o.createElement(K,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},d=({stat:t,onChange:e,value:r})=>{const[n]=(0,o.useState)((0,C.uniqueId)("es-field-id-"));return o.createElement(x.I,{label:t.label,...s,key:t.value},o.createElement(We.K,{id:n,onChange:a=>e(a.target.checked),value:r}))},v=({name:t,metric:e})=>{const r=[];return o.createElement(tt.C,null,o.createElement(Qe.e,null,o.createElement(J.c,{width:17,as:"div"},o.createElement("span",null,t))),o.createElement(c,{metric:e,previousMetrics:r}))},E=(t,e)=>({color:e&&(0,i.css)`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),_=t=>({label:N[t.type].label,value:t.type}),M=t=>!N[t.type].isPipelineAgg,re=(t,e)=>{const r=t.some(M);return Object.entries(N).filter(([n,a])=>a.impliedQueryType==="metrics").filter(([n,{versionRange:a="*"}])=>e!=null?(0,Re.satisfies)(e,a):!0).filter(([n,a])=>r||!a.isPipelineAgg).map(([n,{label:a}])=>({label:a,value:n}))},Dr=({value:t})=>{const e=E((0,Z.$j)(),!!t.hide),r=ce(),n=Fe(),a=q(),u=rt(t.type),f=async p=>{const m=await r.getDatabaseVersion();return re(p,m)},g=(0,o.useCallback)(async()=>{const p=await u();return ge(t)?[{label:"None"},...p]:p},[u,t]),y=n.metrics.slice(0,n.metrics.findIndex(p=>p.id===t.id));return o.createElement(o.Fragment,null,o.createElement(Qe.e,null,o.createElement(Be.s,{className:(0,i.cx)(e.color,De),loadOptions:()=>f(y),onChange:p=>a(Me({id:t.id,type:p.value})),value:_(t)}),te(t)&&!Oe(t)&&o.createElement(Be.s,{className:(0,i.cx)(e.color,De),loadOptions:g,onChange:p=>a(Ve({id:t.id,field:p.value})),placeholder:"Select Field",value:t.field}),Oe(t)&&!ze(t)&&o.createElement(hs,{className:(0,i.cx)(e.color,De),onChange:p=>a(Ve({id:t.id,field:p.value?.id})),options:y,value:t.field})),ft(t)&&o.createElement(c,{metric:t,previousMetrics:y}))},_r=({nextId:t})=>{const e=q(),{metrics:r}=Fe(),n=r?.length||0;return o.createElement(o.Fragment,null,r?.map((a,u)=>{switch(a.type){case"logs":return o.createElement(v,{key:`${a.type}-${a.id}`,name:"Logs",metric:a});case"raw_data":return o.createElement(v,{key:`${a.type}-${a.id}`,name:"Raw Data",metric:a});case"raw_document":return o.createElement(o.Fragment,null,o.createElement(v,{key:`${a.type}-${a.id}`,name:"Raw Document",metric:a}),o.createElement(ie.F,{severity:"warning",title:"The 'Raw Document' query type is deprecated."}));default:return o.createElement(Xt,{key:`${a.type}-${a.id}`,label:`Metric (${a.id})`,hidden:a.hide,onHideClick:()=>e(Je(a.id)),onRemoveClick:n>1&&(()=>e(Ze(a.id)))},o.createElement(Dr,{value:a}),N[a.type].impliedQueryType==="metrics"&&u===0&&o.createElement(Ce.$n,{variant:"secondary",fill:"text",icon:"plus",onClick:()=>e(Ye(t)),tooltip:"Add metric","aria-label":"Add metric"}))}}))};var Pr=b(94354);const Or=[{value:"metrics",label:"Metrics"},{value:"logs",label:"Logs"},{value:"raw_data",label:"Raw Data"},{value:"raw_document",label:"Raw Document"}];function Rr(t){switch(t){case"logs":case"raw_data":case"raw_document":return t;case"metrics":return"count";default:throw new Error(`invalid query type: ${t}`)}}const Vr=()=>{const t=Fe(),e=q(),r=t.metrics?.[0];if(r==null)return null;const n=N[r.type].impliedQueryType,a=u=>{e(Me({id:r.id,type:Rr(u)}))};return o.createElement(Pr.z,{fullWidth:!1,options:Or,value:n,onChange:a})};function Nr(t){const[e,r]=(0,o.useState)(null);return(0,o.useEffect)(()=>{let n=!1;return t.getDatabaseVersion().then(a=>{n||r(a)},a=>{console.log(a)}),()=>{n=!0}},[t]),e}const kr=({query:t,onChange:e,onRunQuery:r,datasource:n,range:a})=>{const u=Nr(n),f=u!=null&&!ht(u);return o.createElement(Xe,{datasource:n,onChange:e,onRunQuery:r,query:t,range:a||(0,Y.E2)()},f&&o.createElement(ie.F,{title:yt}),o.createElement(Lr,{value:t}))},ar=t=>({root:(0,i.css)`
    display: flex;
  `,queryItem:(0,i.css)`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),lr=({value:t,onChange:e})=>{const r=(0,Z.of)(ar);return o.createElement("div",{className:r.queryItem},o.createElement(fe.X,{query:t,onChange:e,placeholder:"Enter a lucene query",portalOrigin:"elasticsearch"}))},Lr=({value:t})=>{const e=q(),r=Os(),n=(0,o.useId)(),a=(0,Z.of)(ar),u=vt(t),f=t.metrics?.every(g=>N[g.type].impliedQueryType==="metrics");return o.createElement(o.Fragment,null,o.createElement("div",{className:a.root},o.createElement(J.c,{width:17},"Query type"),o.createElement("div",{className:a.queryItem},o.createElement(Vr,null))),o.createElement("div",{className:a.root},o.createElement(J.c,{width:17},"Lucene Query"),o.createElement(lr,{onChange:g=>e(Wt(g)),value:t?.query}),u&&o.createElement(x.I,{label:"Alias",labelWidth:15,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored.",htmlFor:n},o.createElement(w.p,{id:n,placeholder:"Alias Pattern",onBlur:g=>e(qt(g.currentTarget.value)),defaultValue:t.alias}))),o.createElement(_r,{nextId:r}),f&&o.createElement(Qs,{nextId:r}))};var Qr=b(61765),Br=b(66025),jr=b(68704),Wr=b(77657),qr=b(17466),Ws=b(67861),zr=b(91062),Hr=b(32346),ye=b(32264),qs=b(25994),or=b(67061),Ur=b(17081),Kr=b(6709),Gr=b(91890),zs=b(29020),Hs=b(35931),Yr=b(84596),Zr=b(55882),Jr=b(64078);const Xr=t=>{const{value:e,onChange:r,onDelete:n,suggestions:a,className:u}=t,f=(0,Z.of)(ti),[g,y]=ei(e.datasourceUid),p=m=>$=>{r({...e,[m]:$.currentTarget.value})};return o.createElement("div",{className:u},o.createElement("div",{className:f.firstRow},o.createElement(x.I,{label:"Field",htmlFor:"elasticsearch-datasource-config-field",labelWidth:12,tooltip:"Can be exact field name or a regex pattern that will match on the field name."},o.createElement(w.p,{type:"text",id:"elasticsearch-datasource-config-field",value:e.field,onChange:p("field"),width:100})),o.createElement(Ce.$n,{variant:"destructive",title:"Remove field",icon:"times",onClick:m=>{m.preventDefault(),n()}})),o.createElement(tt.C,null,o.createElement("div",{className:f.urlField},o.createElement(J.c,{htmlFor:"elasticsearch-datasource-internal-link",width:12},g?"Query":"URL"),o.createElement(Jr.l,{placeholder:g?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:m=>r({...e,url:m}),suggestions:a})),o.createElement("div",{className:f.urlDisplayLabelField},o.createElement(x.I,{label:"URL Label",htmlFor:"elasticsearch-datasource-url-label",labelWidth:14,tooltip:"Use to override the button label."},o.createElement(w.p,{type:"text",id:"elasticsearch-datasource-url-label",value:e.urlDisplayLabel,onChange:p("urlDisplayLabel")})))),o.createElement("div",{className:f.row},o.createElement(x.I,{label:"Internal link",labelWidth:12},o.createElement(We.K,{label:"Internal link",value:g||!1,onChange:()=>{g&&r({...e,datasourceUid:void 0}),y(!g)}})),g&&o.createElement(Zr.s,{tracing:!0,onChange:m=>{r({...e,datasourceUid:m.uid})},current:e.datasourceUid})))};function ei(t){const[e,r]=(0,o.useState)(!!t),n=(0,Yr.A)(t);return(0,o.useEffect)(()=>{!n&&t&&!e&&r(!0),n&&!t&&e&&r(!1)},[n,t,e]),[e,r]}const ti=()=>({firstRow:(0,i.css)`
    display: flex;
  `,nameField:(0,i.css)`
    flex: 2;
  `,regexField:(0,i.css)`
    flex: 3;
  `,row:(0,i.css)`
    display: flex;
    align-items: baseline;
  `,urlField:(0,i.css)`
    display: flex;
    flex: 1;
  `,urlDisplayLabelField:(0,i.css)`
    flex: 1;
  `}),si=t=>({addButton:(0,i.css)`
      margin-right: 10px;
    `,container:(0,i.css)`
      margin-bottom: ${t.spacing(2)};
    `,dataLink:(0,i.css)`
      margin-bottom: ${t.spacing(1)};
    `}),ri=t=>{const{value:e,onChange:r}=t,n=(0,Z.of)(si);return o.createElement(zs.I,{title:"Data links",description:o.createElement(Hs.H,{description:"Add links to existing fields. Links will be shown in log row details next to the field value.",suffix:"elasticsearch/#data-links",feature:"Elasticsearch data links"})},o.createElement("div",{className:n.container},e&&e.length>0&&o.createElement("div",{className:"gf-form-group"},e.map((a,u)=>o.createElement(Xr,{className:n.dataLink,key:u,value:a,onChange:f=>{const g=[...e];g.splice(u,1,f),r(g)},onDelete:()=>{const f=[...e];f.splice(u,1),r(f)},suggestions:[{value:Kr.c.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:Gr.$0.Value}]}))),o.createElement(Ce.$n,{type:"button",variant:"secondary",className:n.addButton,icon:"plus",onClick:a=>{a.preventDefault();const u=[...e||[],{field:"",url:""}];r(u)}},"Add")))},Us=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],ii=({value:t,onChange:e})=>o.createElement(zs.I,{title:"Elasticsearch details",description:o.createElement(Hs.H,{description:"Specific settings for the Elasticsearch data source.",suffix:"elasticsearch/#index-settings",feature:"Elasticsearch details"})},o.createElement(x.I,{label:"Index name",htmlFor:"es_config_indexName",labelWidth:29,tooltip:"Name of your Elasticsearch index. You can use a time pattern, such as YYYY.MM.DD, or a wildcard for the index name."},o.createElement(w.p,{id:"es_config_indexName",value:t.jsonData.index??(t.database||""),onChange:ni(t,e),width:24,placeholder:"es-index-name",required:!0})),o.createElement(x.I,{label:"Pattern",htmlFor:"es_config_indexPattern",labelWidth:29,tooltip:"If you're using a pattern for your index, select the type, or no pattern."},o.createElement(T.l6,{inputId:"es_config_indexPattern",value:Us.find(r=>r.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:Us,onChange:li(t,e),width:24})),o.createElement(x.I,{label:"Time field name",htmlFor:"es_config_timeField",labelWidth:29,tooltip:"Name of your time field. Defaults to @timestamp."},o.createElement(w.p,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:Ks("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),o.createElement(x.I,{label:"Max concurrent Shard Requests",htmlFor:"es_config_shardRequests",labelWidth:29,tooltip:"Maximum number of concurrent shards a search request can hit per node. Defaults to 5."},o.createElement(w.p,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:Ks("maxConcurrentShardRequests",t,e),width:24})),o.createElement(x.I,{label:"Min time interval",htmlFor:"es_config_minTimeInterval",labelWidth:29,tooltip:o.createElement(o.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",o.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},o.createElement(w.p,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:Ks("timeInterval",t,e),width:24,placeholder:"10s"})),o.createElement(x.I,{label:"Include Frozen Indices",htmlFor:"es_config_frozenIndices",labelWidth:29,tooltip:"Include frozen indices in searches."},o.createElement(We.K,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:ai("includeFrozen",t,e)}))),ni=(t,e)=>r=>{e({...t,database:"",jsonData:{...t.jsonData,index:r.currentTarget.value}})},Ks=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},ai=(t,e,r)=>n=>{r({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},li=(t,e)=>r=>{const n=r.value==="none"?void 0:r.value,a=t.jsonData.index??t.database;if(!a||a.length===0||a.startsWith("[logstash-]")){let u="";if(n!==void 0){const f=Us.find(g=>g.value===n);f&&(u=f.example??"")}e({...t,database:"",jsonData:{...t.jsonData,index:u,interval:n}})}else e({...t,jsonData:{...t.jsonData,interval:n}})};function oi(){return 5}const ci=t=>{const{value:e,onChange:r}=t,n=a=>u=>{r({...e,[a]:u.currentTarget.value})};return o.createElement(zs.I,{title:"Logs",description:o.createElement(Hs.H,{description:"Configure which fields the data source uses for log messages and log levels.",suffix:"elasticsearch/#logs",feature:"Elasticsearch log fields"})},o.createElement(x.I,{label:"Message field name",labelWidth:22,tooltip:"Configure the field to be used for log messages."},o.createElement(w.p,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),o.createElement(x.I,{label:"Level field name",labelWidth:22,tooltip:"Configure the field that determines the level of each log message."},o.createElement(w.p,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},ui=t=>({...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||oi(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}),di=t=>!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,fi=t=>{const{options:e,onOptionsChange:r}=t;(0,o.useEffect)(()=>{di(e)||r(ui(e))},[r,e]);const n=(0,Br.pe)({config:e,onChange:r});return ye.$.sigV4AuthEnabled&&(n.customMethods=[{id:"custom-sigv4",label:"SigV4 auth",description:"AWS Signature Version 4 authentication",component:o.createElement(Qr._r,{inExperimentalAuthComponent:!0,...t})}],n.selectedMethod=e.jsonData.sigV4Auth?"custom-sigv4":n.selectedMethod),o.createElement(o.Fragment,null,e.access==="direct"&&o.createElement(ie.F,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),o.createElement(jr.I,{dataSourceName:"Elasticsearch",docsLink:"https://grafana.com/docs/grafana/latest/datasources/elasticsearch",hasRequiredFields:!1}),o.createElement(qs.c,{spacing:4}),o.createElement(Wr.u,{config:e,onChange:r,urlPlaceholder:"http://localhost:9200"}),o.createElement(qs.c,{spacing:4}),o.createElement(qr.N,{...n,onAuthMethodSelect:a=>{r({...e,basicAuth:a===Ws.q.BasicAuth,withCredentials:a===Ws.q.CrossSiteCredentials,jsonData:{...e.jsonData,sigV4Auth:a==="custom-sigv4",oauthPassThru:a===Ws.q.OAuthForward}})}}),o.createElement(qs.c,{spacing:4}),o.createElement(zr.A,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0},o.createElement(or.B,{gap:5,direction:"column"},o.createElement(Hr.g,{config:e,onChange:r}),ye.$.secureSocksDSProxyEnabled&&o.createElement(Ur.Y,{options:e,onOptionsChange:r}),o.createElement(ii,{value:e,onChange:r}),o.createElement(ci,{value:e.jsonData,onChange:a=>r({...e,jsonData:a})}),o.createElement(ri,{value:e.jsonData.dataLinks,onChange:a=>{r({...e,jsonData:{...e.jsonData,dataLinks:a}})}}))))};var pi=b(51553),bs=b(65474),Vt=b(62467),Es=b(66847),cr=b(69862),gi=b(2174),mi=b(41560),hi=b(57532),qe=b(81160),ur=b(59099),ee=b(9557),yi=b(65879),Gs=b(41987),G=b(47232),vi=b(26657),bi=b(72574),Ei=b(19347);const dr={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class $i{constructor(e,r){this.pattern=e,this.interval=r,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,G.yT)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,r){if(!this.interval)return this.pattern;const a=dr[this.interval],u=(0,G.KQ)(e||(0,G.KQ)(r).add(-7,a.amount)).utc().startOf(a.startOf),f=(0,G.KQ)(r||(0,G.KQ)(e).add(7,a.amount)).utc().startOf(a.startOf).valueOf(),g=[];for(;u.valueOf()<=f;)g.push(u.locale(this.dateLocale).format(this.pattern)),u.add(1,a.amount);return g}}var $s=b(73372);class Fi extends I.Is{constructor(e,r){super(),this.datasource=e,Object.assign(this,r)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(r=>{switch(r.operator){case $s.D_.Equal:return r.name+':"'+r.value+'"';case $s.D_.NotEqual:return"-"+r.name+':"'+r.value+'"';case $s.D_.EqualRegEx:return r.name+":/"+r.value+"/";case $s.D_.NotEqualRegEx:return"-"+r.name+":/"+r.value+"/"}}).join(" AND ")}}var Ys=b(13288),fr=b(50311),Si=b(17172),Zs=b(14236),_e=b(11261),xi=b(37471),pr=b(91950);const gr=`${Ue.pre}([^@]+)${Ue.post}`;class mr{constructor(e,r){this.targets=e,this.response=r,this.processResponseToSeries=()=>{const n=[];for(let a=0;a<this.response.responses.length;a++){const u=this.response.responses[a],f=this.targets[a];if(u.error)throw this.getErrorFromElasticResponse(this.response,u.error);if(u.hits&&u.hits.hits.length>0&&this.processHits(u.hits,n,f),u.aggregations){const g=u.aggregations,y=this.targets[a],p=[],m=new pr.A;m.refId=y.refId,this.processBuckets(g,y,p,m,{},0),this.trimDatapoints(p,y),this.nameSeries(p,y);for(let $=0;$<p.length;$++)n.push(p[$]);m.rows.length>0&&n.push(m)}}return{data:n}},this.targets=e,this.response=r}processMetrics(e,r,n,a){let u;for(let f=0;f<r.metrics.length;f++){const g=r.metrics[f];if(!g.hide)switch(g.type){case"count":{u={datapoints:[],metric:"count",props:a,refId:r.refId};for(let y=0;y<e.buckets.length;y++){const p=e.buckets[y],m=p.doc_count;u.datapoints.push([m,p.key])}n.push(u);break}case"percentiles":{if(e.buckets.length===0)break;const p=e.buckets[0][g.id].values;for(const m in p){u={datapoints:[],metric:"p"+m,props:a,field:g.field,refId:r.refId};for(let $=0;$<e.buckets.length;$++){const A=e.buckets[$],P=A[g.id].values;u.datapoints.push([P[m],A.key])}n.push(u)}break}case"extended_stats":{for(const y in g.meta)if(g.meta[y]){u={datapoints:[],metric:y,props:a,field:g.field,refId:r.refId};for(let p=0;p<e.buckets.length;p++){const m=e.buckets[p],$=m[g.id];$.std_deviation_bounds_upper=$.std_deviation_bounds.upper,$.std_deviation_bounds_lower=$.std_deviation_bounds.lower,u.datapoints.push([$[y],m.key])}n.push(u)}break}case"top_metrics":{if(g.settings?.metrics?.length)for(const y of g.settings?.metrics){u={datapoints:[],metric:g.type,props:a,refId:r.refId,field:y};for(let p=0;p<e.buckets.length;p++){const m=e.buckets[p],A=m[g.id].top.map(V=>V.metrics[y]?V.metrics[y]:null),P=[A[A.length-1],m.key];u.datapoints.push(P)}n.push(u)}break}default:{u={datapoints:[],metric:g.type,metricId:g.id,props:a,refId:r.refId},te(g)&&(u.field=g.field);for(let y=0;y<e.buckets.length;y++){const p=e.buckets[y],m=p[g.id];m!==void 0&&(m.normalized_value?u.datapoints.push([m.normalized_value,p.key]):u.datapoints.push([m.value,p.key]))}n.push(u);break}}}}processAggregationDocs(e,r,n,a,u){if(a.columns.length===0){for(const y of(0,C.keys)(u))a.addColumn({text:y,filterable:!0});a.addColumn({text:r.field,filterable:!0})}const f=(y,p,m)=>{a.addColumn({text:p}),y.push(m)},g=(0,C.isArray)(e.buckets)?e.buckets:[e.buckets];for(const y of g){const p=[];for(const m of(0,C.values)(u))p.push(m);p.push(y.key);for(const m of n.metrics||[])switch(m.type){case"count":{f(p,this.getMetricName(m.type),y.doc_count);break}case"extended_stats":{for(const $ in m.meta){if(!m.meta[$])continue;const A=y[m.id];A.std_deviation_bounds_upper=A.std_deviation_bounds.upper,A.std_deviation_bounds_lower=A.std_deviation_bounds.lower,f(p,this.getMetricName($),A[$])}break}case"percentiles":{const $=y[m.id].values;for(const A in $)f(p,`p${A} ${m.field}`,$[A]);break}case"top_metrics":{const $=this.getMetricName(m.type);if(m.settings?.metrics)for(const A of m.settings.metrics){const P=m.settings.metrics.length>1?`${$} ${A}`:$,V=y[m.id];f(p,P,V.top[0].metrics[A])}break}default:{let $=this.getMetricName(m.type);(0,C.filter)(n.metrics,{type:m.type}).length>1&&(te(m)&&($+=" "+m.field),m.type==="bucket_script"&&($=Te(m))),f(p,$,y[m.id].value);break}}a.rows.push(p)}}processBuckets(e,r,n,a,u,f){let g,y,p,m;const $=r.bucketAggs.length-1;for(m in e)if(y=(0,C.find)(r.bucketAggs,{id:m}),p=e[m],!!y){if(y.type==="nested"){this.processBuckets(p,r,n,a,u,f+1);continue}if(f===$)y.type==="date_histogram"?this.processMetrics(p,r,n,u):this.processAggregationDocs(p,y,r,a,u);else for(const A in p.buckets)g=p.buckets[A],u=(0,C.clone)(u),g.key!==void 0?u[y.field]=g.key:u.filter=A,g.key_as_string&&(u[y.field]=g.key_as_string),this.processBuckets(g,r,n,a,u,f+1)}}getMetricName(e){const r=Object.entries(N).filter(([a])=>a===e).map(([a,u])=>u)[0];if(r)return r.label;const n=pt.find(a=>a.value===e);return n?n.label:e}getSeriesName(e,r,n){let a=this.getMetricName(e.metric);if(r.alias){const g=/\{\{([\s\S]+?)\}\}/g;return r.alias.replace(g,(y,p,m)=>{const $=p||m;return $.indexOf("term ")===0?e.props[$.substring(5)]:e.props[$]!==void 0?e.props[$]:$==="metric"?a:$==="field"?e.field||"":y})}if(Ke(e.metric))if(e.metric&&Ts(e.metric)){const g=(0,C.find)(r.metrics,{id:e.metricId});if(g&&g.settings.script){a=Te(g);for(const y of g.pipelineVariables){const p=(0,C.find)(r.metrics,{id:y.pipelineAgg});p&&(a=a.replace("params."+y.name,me(p)))}}else a="Unset"}else{const g=(0,C.find)(r.metrics,{id:e.field});g?a+=" "+me(g):a="Unset"}else e.field&&(a+=" "+e.field);if((0,C.keys)(e.props).length===0)return a;let f="";for(const g in e.props)f+=e.props[g]+" ";return n?f.trim()+" "+a:f.trim()}nameSeries(e,r){const n=(0,C.uniq)((0,C.map)(e,"metric")).length,a=(r.metrics?.filter(u=>u.type==="top_metrics")).some(u=>(u?.settings?.metrics?.length||0)>1);for(let u=0;u<e.length;u++){const f=e[u];f.target=this.getSeriesName(f,r,n>1||a)}}processHits(e,r,n){const a=typeof e.total=="number"?e.total:e.total.value,u={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:a,filterable:!0};let f,g,y,p;for(p=0;p<e.hits.length;p++){if(g=e.hits[p],y={_id:g._id,_type:g._type,_index:g._index,sort:g.sort,highlight:g.highlight},g._source)for(f in g._source)y[f]=g._source[f];for(f in g.fields)y[f]=g.fields[f];u.datapoints.push(y)}r.push(u)}trimDatapoints(e,r){const n=(0,C.find)(r.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const u=n.settings.trimEdges;for(const f in e){const g=e[f];g.datapoints.length>u*2&&(g.datapoints=g.datapoints.slice(u,g.datapoints.length-u))}}}getErrorFromElasticResponse(e,r){const n={};return n.data=JSON.stringify(r,null,4),r.root_cause&&r.root_cause.length>0&&r.root_cause[0].reason?n.message=r.root_cause[0].reason:n.message=r.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(r=>Ae(r,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(r=>(0,Zs.Vc)(r))}}getLogs(e,r){return this.processResponseToDataFrames(!0,e,r)}processResponseToDataFrames(e,r,n){const a=[];for(let u=0;u<this.response.responses.length;u++){const f=this.response.responses[u];if(f.error)throw this.getErrorFromElasticResponse(this.response,f.error);if(f.hits){const{propNames:g,docs:y}=Ii(f.hits.hits),p=y.length?hr(g.map(wi(y)),e,this.targets[0].timeField,r,n):hr([],e);e&&yr(p,"logs");for(const $ of y){if(n&&($.level=$[n]),$.highlight){const A=new RegExp(gr,"g"),P=new RegExp(gr),V=Object.keys($.highlight).flatMap(de=>$.highlight[de].flatMap(ut=>{const le=ut.match(A);return le?le.map(ve=>{const Cr=ve.match(P);return Cr&&Cr[1]||null}):[]})).filter(C.identity),ae=p.meta?.searchWords?(0,C.uniq)([...p.meta.searchWords,...V]):[...V];p.meta=p.meta?{...p.meta,searchWords:ae}:{searchWords:ae}}p.add($)}const m=this.targets[u];p.refId=m.refId,a.push(p)}if(f.aggregations){const g=f.aggregations,y=this.targets[u],p=[],m=new pr.A;if(this.processBuckets(g,y,p,m,{},0),this.trimDatapoints(p,y),this.nameSeries(p,y),m.rows.length>0){const $=(0,Zs.Vc)(m);$.refId=y.refId,a.push($)}for(let $=0;$<p.length;$++){let A=(0,Zs.Vc)(p[$]);e&&yr(A,"graph"),A.refId=y.refId,a.push(A)}}}for(let u of a)for(let f of u.fields)f.type===_e.PU.time&&typeof f.values[0]!="number"&&(f.values=(0,fr.s7)(f,{destinationType:_e.PU.time}).values);return{data:a}}}const Ii=t=>{const e=[];let r=[];for(const n of t){const a=n._source?Et(n._source):{},u={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...a},...a};for(const f of Object.keys(u))r.indexOf(f)===-1&&r.push(f);e.push(u)}return r.sort(),{docs:e,propNames:r}},hr=(t,e,r,n,a)=>{const u=new xi.k({fields:[]});if(r&&u.addField({config:{filterable:!0},name:r,type:_e.PU.time}),n){const g=u.addField({name:n,type:_e.PU.string});u.setParser(g,y=>y||"")}if(a){const g=u.addField({name:"level",type:_e.PU.string});u.setParser(g,y=>y||"")}const f=u.fields.map(g=>g.name);for(const[g,y]of t){if(f.includes(g)||!e&&g==="_source")continue;const p=u.addField({config:{filterable:!0},name:g,type:y});u.setParser(p,m=>m||"")}return u},yr=(t,e)=>{let r=t;r.meta?r.meta.preferredVisualisationType=e:r.meta={preferredVisualisationType:e}},wi=t=>e=>[e,Ai(t.find(r=>r[e]!==void 0)?.[e])],Ai=t=>{switch(typeof t){case"number":return _e.PU.number;case"string":return _e.PU.string;default:return _e.PU.other}};var Js=b(14110),Ti=b(45622);const Mi=({payload:{dashboardId:t,orgId:e,grafanaVersion:r,queries:n}})=>{try{const a=n[Ti.id]?.filter(P=>!P.hide);if(!a?.length)return;const u=a.filter(Di),f=a.filter(P=>!!P.query),g=a.filter(P=>Nt(P)==="logs"),y=a.filter(P=>Nt(P)==="metric"),p=a.filter(P=>Nt(P)==="raw_data"),m=a.filter(P=>Nt(P)==="raw_document"),$=a.filter(Ci),A={grafana_version:r,dashboard_id:t,org_id:e,queries_count:a.length,logs_queries_count:g.length,metric_queries_count:y.length,raw_data_queries_count:p.length,raw_document_queries_count:m.length,queries_with_template_variables_count:u.length,queries_with_changed_line_limit_count:$.length,queries_with_lucene_query_count:f.length};(0,Js.rR)("grafana_elasticsearch_dashboard_loaded",A)}catch(a){console.error("error in elasticsearch tracking handler",a)}},Nt=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",vr=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},Ci=t=>{const e=vr(t);return e!==void 0&&e!==500},Di=t=>bt.test(t.query??""),_i=t=>!!t.startsWith(Ar);function br(t,e,r){const{targets:n,app:a}=e;if(!(a===Gs.Jk.Dashboard||a===Gs.Jk.PanelViewer))for(const u of n){if(_i(u.refId))return;(0,Js.rR)("grafana_elasticsearch_query_executed",{app:a,grafana_version:ye.$.buildInfo.version,with_lucene_query:!!u.query,query_type:Nt(u),line_limit:vr(u),alias:u.alias,has_error:t.error!==void 0,has_data:t.data.some(f=>f.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-r.getTime()})}}function Pi(t){(0,Js.rR)("grafana_elasticsearch_annotation_query_executed",{grafana_version:ye.$.buildInfo.version,has_target_query:!!t.target?.query,has_query:!!t.query,has_time_field:!!t.timeField,has_time_end_field:!!t.timeEndField,has_tags_field:!!t.tagsField,has_text_field:!!t.textField,has_index:!!t.index})}class Oi{constructor(e,r){this.datasource=e,this.templateSrv=r}request(e,r,n,a){if(!this.datasource.isProxyAccess){const f=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,Ys.$)(()=>f)}const u={url:this.datasource.url+"/"+r,method:e,data:n,headers:a};return e==="POST"&&(u.headers=u.headers??{},u.headers["Content-Type"]="application/x-ndjson"),(this.datasource.basicAuth||this.datasource.withCredentials)&&(u.withCredentials=!0),this.datasource.basicAuth&&(u.headers={Authorization:this.datasource.basicAuth}),(0,Si.AI)().fetch(u).pipe((0,qe.T)(f=>(f.data.$$config=f.config,f.data)),(0,Es.W)(f=>{if(f.data){const g=f.data.error?.reason??f.data.message??"Unknown error";return(0,Ys.$)({message:g,error:f.data.error})}return(0,Ys.$)(f)}))}async logContextQuery(e,r){const a=e.dataFrame.fields.find(ve=>ve.name==="sort")?.values[e.rowIndex]||[e.timeEpochMs],u=r?.direction===ee.ZF.Forward?"asc":"desc",f=r?.direction===ee.ZF.Forward?this.datasource.getQueryHeader("query_then_fetch",(0,G.KQ)(e.timeEpochMs)):this.datasource.getQueryHeader("query_then_fetch",void 0,(0,G.KQ)(e.timeEpochMs)),g=r?.limit??10,y=JSON.stringify({size:g,query:{bool:{filter:[{range:{[this.datasource.timeField]:{[r?.direction===ee.ZF.Forward?"gte":"lte"]:e.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.datasource.timeField]:u},{_doc:u}],search_after:a}),p=[f,y].join(`
`)+`
`,m=this.datasource.getMultiSearchUrl(),$=await(0,oe.s)(this.request("POST",m,p)),A=[{refId:`${e.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],V=new mr(A,Ri($,u)).getLogs(this.datasource.logMessageField,this.datasource.logLevelField),ae=(0,C.first)(V.data);if(!ae)return{data:[]};const de=ae.fields.find(ve=>ve.name===this.datasource.timeField),ut=ae.fields.find(ve=>ve.name===this.datasource.logMessageField),le=ae.fields.filter(ve=>ve!==de&&ve!==ut);return de&&ut?{data:[{...ae,fields:[(0,fr.ks)(de),ut,...le]}]}:V}query(e){let r="";const n=this.datasource.interpolateVariablesInQueries((0,C.cloneDeep)(e.targets),e.scopedVars,e.filters),a=[];let u=n.some(p=>Ae(p,"logs"));const f=[];for(const p of n){if(p.hide)continue;let m;if(Ae(p,"logs")){p.bucketAggs=[$e()];const V=p.metrics?.find(de=>de.type==="logs"),ae=V.settings?.limit?parseInt(V.settings?.limit,10):500;f.push(ae),p.metrics=[],m=this.datasource.queryBuilder.getLogsQuery(p,ae)}else f.push(),p.alias&&(p.alias=this.datasource.interpolateLuceneQuery(p.alias,e.scopedVars)),m=this.datasource.queryBuilder.build(p);const $=JSON.stringify(m),P=this.datasource.getQueryHeader("query_then_fetch",e.range.from,e.range.to);r+=P+`
`,r+=$+`
`,a.push(p)}if(a.length===0)return(0,Vt.of)({data:[]});r=r.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),r=r.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),r=this.templateSrv.replace(r,e.scopedVars);const g=this.datasource.getMultiSearchUrl(),y=new Date;return this.request("POST",g,r).pipe((0,qe.T)(p=>{const m=new mr(a,p);if(u){const $=m.getLogs(this.datasource.logMessageField,this.datasource.logLevelField);return $.data.forEach((A,P)=>{Vi(A,this.datasource.dataLinks,f[P])}),$}return m.getTimeSeries()}),(0,ur.M)(p=>br(p,e,y)))}}function Ri(t,e){if(e==="desc")return t;const r=t.responses[0];return{...t,responses:[{...r,hits:{...r.hits,hits:r.hits.hits.reverse()}}]}}function Vi(t,e,r){r&&(t.meta={...t.meta,limit:r}),Mr(t,e)}var Ni=b(9e4),Fs=b(81580);function ki(t){const e=t.annotation,r=t.onAnnotationChange;return o.createElement(or.B,{direction:"column",gap:5},o.createElement("div",null,o.createElement(lr,{value:e.target?.query,onChange:n=>{const u={...e.target??{refId:"annotation_query"},query:n};r({...e,target:u})}})),o.createElement("div",null,o.createElement("h6",null,"Field mappings"),o.createElement(Ni.U,null,o.createElement(Fs.c,{label:"Time"},o.createElement(w.p,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{r({...e,timeField:n.currentTarget.value})}})),o.createElement(Fs.c,{label:"Time End"},o.createElement(w.p,{type:"text",value:e.timeEndField,onChange:n=>{r({...e,timeEndField:n.currentTarget.value})}})),o.createElement(Fs.c,{label:"Text"},o.createElement(w.p,{type:"text",value:e.textField,onChange:n=>{r({...e,textField:n.currentTarget.value})}})),o.createElement(Fs.c,{label:"Tags"},o.createElement(w.p,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{r({...e,tagsField:n.currentTarget.value})}})))),o.createElement("div",null))}function Li(t){return!t||typeof t!="object"?!1:"meta"in t}var ct=b(94601);function Ss(t,e,r,n=""){return Er(t,e,r,n)!==null}function Er(t,e,r,n=""){const a=`${n}${ct.term.escape(e)}`;r=ct.phrase.escape(r);let u=Ir(t);return u?Xs(u,a,r):null}function Xs(t,e,r){return Object.keys(t).length===0?null:xr(t.left)?Xs(t.left,e,r):xs(t.left)&&t.left.field===e&&t.left.term===r?t.left:sr(t)?null:xs(t.right)&&t.right.field===e&&t.right.term===r?t.right:rr(t.right)?Xs(t.right,e,r):null}function kt(t,e,r,n=""){if(Ss(t,e,r,n))return t;e=Sr(e),r=tr(r);const a=`${n}${e}:"${r}"`;return $r(t,a)}function $r(t,e,r="AND"){return e?t.trim()===""?e:`${t} ${r} ${e}`:t}function Qi(t,e){if(!e.key||!e.value)return t;if(e={...e,value:e.value.toString()},["=","!="].includes(e.operator))return kt(t,e.key,e.value,e.operator==="="?"":"-");const n=Sr(e.key),a=tr(e.value);let u="";switch(e.operator){case"=~":u=`${n}:/${a}/`;break;case"!~":u=`-${n}:/${a}/`;break;case">":u=`${n}:>${a}`;break;case"<":u=`${n}:<${a}`;break}return $r(t,u)}function Fr(t,e,r,n=""){const a=Er(t,e,r,n),u=Ir(t);return!a||!u?t:ct.toString(er(u,a))}function er(t,e){return Object.keys(t).length===0?t:xr(t.left)?(t.left=er(t.left,e),t):xs(t.left)&&(0,C.isEqual)(t.left,e)?(Object.assign(t,{left:void 0,operator:void 0,right:void 0},"right"in t?t.right:{}),t):sr(t)?t:xs(t.right)&&(0,C.isEqual)(t.right,e)?(Object.assign(t,{right:void 0,operator:void 0}),t):(rr(t.right)&&(t.right=er(t.right,e)),t)}function Sr(t){return ct.term.escape(t)}function tr(t){return t=t.replace(/\\/g,"\\\\"),ct.phrase.escape(t)}function Bi(t){return t.replace(/(\w+)\s(:)/gi,"$1$2")}function sr(t){return!t||typeof t!="object"?!1:"left"in t&&!("right"in t)}function rr(t){return!t||typeof t!="object"?!1:"left"in t&&"right"in t}function xr(t){return sr(t)||rr(t)}function xs(t){return!!(t&&typeof t=="object"&&"term"in t)}function Ir(t){try{return ct.parse(Bi(t))}catch{return null}}function wr(t,e,r=!0){const n=`"${tr(e)}"`;return t.trim()?`${t} ${r?"AND":"NOT"} ${n}`:`${r?"":"NOT "}${n}`}const Ar="log-volume-",Tr="log-sample-",ji=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class Wi extends vi.iy{constructor(e,r=(0,bi.w)()){super(e),this.templateSrv=r,this.getLogRowContext=async(a,u)=>{const{enableElasticsearchBackendQuerying:f}=ye.$.featureToggles;if(f){const g=this.makeLogContextDataRequest(a,u);return(0,oe.s)(this.query(g).pipe((0,Es.W)(y=>{throw{message:"Error during context query. Please check JS console logs.",status:y.status,statusText:y.statusText}})))}else return this.legacyQueryRunner.logContextQuery(a,u)},this.makeLogContextDataRequest=(a,u)=>{const f=u?.direction||ee.ZF.Backward,g={type:"logs",id:"1",settings:{limit:u?.limit?u?.limit.toString():"10",sortDirection:f===ee.ZF.Backward?"desc":"asc",searchAfter:a.dataFrame.fields.find(P=>P.name==="sort")?.values[a.rowIndex]??[a.timeEpochMs]}},y={refId:`log-context-${a.dataFrame.refId}-${f}`,metrics:[g],query:""},p=zi(a.timeEpochMs,f,this.intervalPattern),m={from:p.from,to:p.to,raw:p},$=yi.calculateInterval(m,1);return{requestId:`log-context-request-${a.dataFrame.refId}-${u?.direction}`,targets:[y],interval:$.interval,intervalMs:$.intervalMs,range:m,scopedVars:{},timezone:"UTC",app:Gs.Jk.Explore,startTime:Date.now(),hideFromInspector:!0}},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.index=n.index??e.database??"",this.timeField=n.timeField,this.indexPattern=new $i(this.index,n.interval),this.intervalPattern=n.interval,this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new At({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.databaseVersion=null,this.annotations={QueryEditor:ki},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new Fi(this),this.legacyQueryRunner=new Oi(this,this.templateSrv)}getResourceRequest(e,r,n){return this.getResource(e,r,n)}postResourceRequest(e,r,n){const a=n??{};return a.headers=a.headers??{},a.headers["content-type"]="application/x-ndjson",this.postResource(e,r,a)}async importFromAbstractQueries(e){return e.map(r=>this.languageProvider.importFromAbstractQuery(r))}requestAllIndices(e=(0,Y.E2)()){let r=this.indexPattern.getIndexList(e.from,e.to);Array.isArray(r)||(r=[this.indexPattern.getIndexForToday()]);const n="_mapping",a=r.map(g=>(g=g.replace(/\/$/,""),g===""?n:`${g}/${n}`)),u=7,f=a.length;return(0,pi.c)({initialState:0,condition:g=>g<Math.min(f,u),iterate:g=>g+1}).pipe((0,cr.Z)(g=>{const y=a[f-g-1];return(ye.$.featureToggles.enableElasticsearchBackendQuerying?(0,bs.H)(this.getResource(y)):this.legacyQueryRunner.request("GET",y)).pipe((0,Es.W)(m=>(0,Vt.of)({err:m})))}),(0,gi.j)(g=>g?.err?.status===404),(0,mi.v)(()=>"Could not find an available index for this time range."),(0,hi.$)(),(0,qe.T)(g=>{if(g.err)throw g.err;return g}))}annotationQuery(e){const r=this.prepareAnnotationRequest(e);Pi(e.annotation);const n=ye.$.featureToggles.enableElasticsearchBackendQuerying?(0,bs.H)(this.postResourceRequest("_msearch",r)):this.legacyQueryRunner.request("POST","_msearch",r);return(0,oe.s)(n.pipe((0,qe.T)(a=>{const u=a.responses[0].hits.hits;return this.processHitsToAnnotationEvents(e.annotation,u)})))}prepareAnnotationRequest(e){const r=e.annotation,n=r.timeField||"@timestamp",a=r.timeEndField||null,y=e.dashboard.getVariables().filter(le=>le.type==="adhoc").filter(le=>le.datasource?.uid===r.datasource.uid).map(le=>le.filters).flat(),p=r.query??r.target?.query??"",m=[],$={};if($[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},m.push({range:$}),a){const le={};le[a]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},m.push({range:le})}const A=this.interpolateLuceneQuery(p),P=this.addAdHocFilters(A,y),V={bool:{filter:[{bool:{should:m,minimum_should_match:1}}]}};P&&V.bool.filter.push({query_string:{query:P}});const ae={query:V,size:1e4},de={search_type:"query_then_fetch",ignore_unavailable:!0};return r.index?de.index=r.index:de.index=this.indexPattern.getIndexList(e.range.from,e.range.to),JSON.stringify(de)+`
`+JSON.stringify(ae)+`
`}processHitsToAnnotationEvents(e,r){const n=e.timeField||"@timestamp",a=e.timeEndField||null,u=e.textField||"tags",f=e.tagsField||null,g=[],y=(p,m)=>{if(!m)return;const $=m.split(".");let A=p;for(let P=0;P<$.length;P++)if(A=A[$[P]],!A)return"";return A};for(let p=0;p<r.length;p++){const m=r[p]._source;let $=y(m,n);if(typeof r[p].fields<"u"){const V=r[p].fields;typeof V=="object"&&((0,C.isString)(V[n])||(0,C.isNumber)(V[n]))&&($=V[n])}const A={annotation:e,time:(0,G.yT)($).valueOf(),text:y(m,u)};if(a){const V=y(m,a);V&&(A.timeEnd=(0,G.yT)(V).valueOf())}if(e.titleField){const V=y(m,e.titleField);V&&(A.text=V+`
`+A.text)}const P=y(m,f);typeof P=="string"?A.tags=P.split(","):A.tags=P,g.push(A)}return g}interpolateLuceneQuery(e,r){return this.templateSrv.replace(e,r,"lucene")}interpolateVariablesInQueries(e,r,n){return e.map(a=>this.applyTemplateVariables(a,r,n))}async testDatasource(){const e=await this.getDatabaseVersion(!1),n=(e!=null?ht(e):!0)?"":`WARNING: ${yt} `;return(0,oe.s)(this.getFields(["date"]).pipe((0,cr.Z)(a=>(0,C.find)(a,{text:this.timeField})?(0,Vt.of)({status:"success",message:`${n}Data source successfully connected.`}):(0,Vt.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,Es.W)(a=>{const f=`Unable to connect with Elasticsearch${a.message?` (${a.message})`:""}. Please check the server logs for more details.`;return(0,Vt.of)({status:"error",message:f})})))}getQueryHeader(e,r,n){const a={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(r,n)};return JSON.stringify(a)}getQueryDisplayText(e){const r=e.metrics,n=e.bucketAggs;let a="";return e.query&&(a+="Query: "+e.query+", "),a+="Metrics: ",a+=r?.reduce((u,f)=>{let y=N[f.type].label+"(";return te(f)&&(y+=f.field),ze(f)&&(y+=Te(f).replace(new RegExp("params.","g"),"")),y+="), ",`${u} ${y}`},""),a+=n?.reduce((u,f,g)=>{const y=B[f.type];let p="";return g===0&&(p+=" Group by: "),p+=y.label+"(",st(f)&&(p+=f.field),`${u} ${p}), `},""),e.alias&&(a+="Alias: "+e.alias),a}getSupplementaryRequest(e,r){switch(e){case ee.cF.LogsVolume:return this.getLogsVolumeDataProvider(r);case ee.cF.LogsSample:return this.getLogsSampleDataProvider(r);default:return}}getSupportedSupplementaryQueryTypes(){return[ee.cF.LogsVolume,ee.cF.LogsSample]}getSupplementaryQuery(e,r){let n=!1;switch(e.type){case ee.cF.LogsVolume:if(n=r.metrics?.length===1&&r.metrics[0].type==="logs",!n)return;const a=[],u=this.timeField??"@timestamp";return this.logLevelField&&a.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:ee.$b.unknown},field:this.logLevelField}),a.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:u}),{refId:`${Ar}${r.refId}`,query:r.query,metrics:[{type:"count",id:"1"}],timeField:u,bucketAggs:a};case ee.cF.LogsSample:return n=vt(r),n?e.limit?{refId:`${Tr}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1",settings:{limit:e.limit.toString()}}]}:{refId:`${Tr}${r.refId}`,query:r.query,metrics:[{type:"logs",id:"1"}]}:void 0;default:return}}getLogsVolumeDataProvider(e){const r=(0,C.cloneDeep)(e),n=r.targets.map(a=>this.getSupplementaryQuery({type:ee.cF.LogsVolume},a)).filter(a=>!!a);if(n.length)return{...r,targets:n}}getLogsSampleDataProvider(e){const r=(0,C.cloneDeep)(e),u=r.targets.map(f=>this.getSupplementaryQuery({type:ee.cF.LogsSample,limit:100},f)).filter(f=>!!f);if(u.length)return{...r,targets:u}}query(e){const{enableElasticsearchBackendQuerying:r}=ye.$.featureToggles;if(r){const n=new Date;return super.query(e).pipe((0,ur.M)(a=>br(a,e,n)),(0,qe.T)(a=>(a.data.forEach(u=>{Mr(u,this.dataLinks)}),a)))}return this.legacyQueryRunner.query(e)}filterQuery(e){return!e.hide}isMetadataField(e){return ji.includes(e)}getFields(e,r){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.requestAllIndices(r).pipe((0,qe.T)(a=>{const u=(p,m)=>this.isMetadataField(m)?!1:!e||e.length===0?!0:e.includes(p.type)||e.includes(n[p.type]),f=[],g={};function y(p){for(const m in p){const $=p[m];if((0,C.isObject)($.properties)&&(f.push(m),y($.properties)),(0,C.isObject)($.fields)&&(f.push(m),y($.fields)),(0,C.isString)($.type)){const A=f.concat(m).join(".");u($,m)&&(g[A]={text:A,type:$.type})}}f.pop()}for(const p in a){const m=a[p];if(m&&m.mappings){const A=m.mappings.properties;y(A)}}return(0,C.map)(g,p=>p)}))}getTerms(e,r=(0,Y.E2)()){const a=this.getQueryHeader("query_then_fetch",r.from,r.to);let u=JSON.stringify(this.queryBuilder.getTermsQuery(e));u=u.replace(/\$timeFrom/g,r.from.valueOf().toString()),u=u.replace(/\$timeTo/g,r.to.valueOf().toString()),u=a+`
`+u+`
`;const f=this.getMultiSearchUrl();return(ye.$.featureToggles.enableElasticsearchBackendQuerying?(0,bs.H)(this.postResourceRequest(f,u)):this.legacyQueryRunner.request("POST",f,u)).pipe((0,qe.T)(y=>{if(!y.responses[0].aggregations)return[];const p=y.responses[0].aggregations[1].buckets;return(0,C.map)(p,m=>({text:m.key_as_string||m.key,value:m.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,r){const n=r?.range,a=JSON.parse(e);if(e){if(a.find==="fields")return a.type=this.interpolateLuceneQuery(a.type),(0,oe.s)(this.getFields(a.type,n));if(a.find==="terms")return a.field=this.interpolateLuceneQuery(a.field),a.query=this.interpolateLuceneQuery(a.query),(0,oe.s)(this.getTerms(a,n))}return Promise.resolve([])}getTagKeys(){return(0,oe.s)(this.getFields())}getTagValues(e){return(0,oe.s)(this.getTerms({field:e.key},e.timeRange))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;if(e.bucketAggs){for(const r of e.bucketAggs)if(st(r)&&this.templateSrv.containsTemplate(r.field)||this.objectContainsTemplate(r.settings))return!0}if(e.metrics){for(const r of e.metrics)if(te(r)&&(r.field&&this.templateSrv.containsTemplate(r.field)||r.settings&&this.objectContainsTemplate(r.settings)||Li(r)&&this.objectContainsTemplate(r.meta)))return!0}return!1}objectContainsTemplate(e){if(typeof e=="string")return this.templateSrv.containsTemplate(e);if(!e||typeof e!="object")return!1;for(const r of Object.keys(e))if(Array.isArray(e[r])){for(const n of e[r])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[r]))return!0;return!1}toggleQueryFilter(e,r){let n=e.query??"";switch(r.type){case"FILTER_FOR":{n=Ss(n,r.options.key,r.options.value)?Fr(n,r.options.key,r.options.value):kt(n,r.options.key,r.options.value);break}case"FILTER_OUT":{Ss(n,r.options.key,r.options.value)&&(n=Fr(n,r.options.key,r.options.value)),n=kt(n,r.options.key,r.options.value,"-");break}}return{...e,query:n}}queryHasFilter(e,r){let n=e.query??"";return Ss(n,r.key,r.value)}modifyQuery(e,r){if(!r.options)return e;let n=e.query??"";switch(r.type){case"ADD_FILTER":{n=kt(n,r.options.key,r.options.value);break}case"ADD_FILTER_OUT":{n=kt(n,r.options.key,r.options.value,"-");break}case"ADD_STRING_FILTER":{n=wr(n,r.options.value);break}case"ADD_STRING_FILTER_OUT":{n=wr(n,r.options.value,!1);break}}return{...e,query:n}}getSupportedQueryModifications(){return["ADD_FILTER","ADD_FILTER_OUT","ADD_STRING_FILTER","ADD_STRING_FILTER_OUT"]}addAdHocFilters(e,r){if(!r)return e;let n=e;return r.forEach(a=>{n=Qi(n,a)}),n}applyTemplateVariables(e,r,n){const a=g=>g.type==="filters"?{...g,settings:{...g.settings,filters:g.settings?.filters?.map(y=>({...y,query:this.interpolateLuceneQuery(y.query,r)||"*"}))}}:g,u={...e,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(e.query||"",r),n),bucketAggs:e.bucketAggs?.map(a)};return JSON.parse(this.templateSrv.replace(JSON.stringify(u),r))}getDatabaseVersionUncached(){const e=ye.$.featureToggles.enableElasticsearchBackendQuerying?(0,bs.H)(this.getResourceRequest("")):this.legacyQueryRunner.request("GET","/");return(0,oe.s)(e).then(r=>{const n=r?.version?.number;if(typeof n!="string")return null;try{return new Re.SemVer(n)}catch(a){return console.error(a),null}},r=>(console.error(r),null))}async getDatabaseVersion(e=!0){if(e){const n=this.databaseVersion;if(n!=null)return n}const r=await this.getDatabaseVersionUncached();return this.databaseVersion=r,r}}function Mr(t,e){if(e.length)for(const r of t.fields){const n=e.filter(a=>new RegExp(a.field).test(r.name));n.length!==0&&(r.config=r.config||{},r.config.links=[...(r.config.links,n.map(qi))])}}function qi(t){const e=(0,Ei.l)();if(t.datasourceUid){const r=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:r?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function zi(t,e,r){if(r){const a=dr[r];return e===ee.ZF.Forward?{from:(0,G.KQ)(t).utc(),to:(0,G.KQ)(t).add(7,a.amount).utc().startOf(a.startOf)}:{from:(0,G.KQ)(t).subtract(7,a.amount).utc().startOf(a.startOf),to:(0,G.KQ)(t).utc()}}else return e===ee.ZF.Forward?{from:(0,G.KQ)(t).utc(),to:(0,G.KQ)(t).add(7,"hours").utc()}:{from:(0,G.KQ)(t).subtract(7,"hours").utc(),to:(0,G.KQ)(t).utc()}}const Hi=new I.tD(Wi).setQueryEditor(kr).setConfigEditor(fi);(0,R.J7)().subscribe(h.gc,Mi)},27487:(Ie,j)=>{j.escape=function(R){return R.replace(/[\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~]/g,b)};function b(h){return"\\"+h}j.unescape=function(R){return R.replace(/\\([\+\-\!\(\)\{\}\[\]\^\"\?\:\\\&\|\'\/\s\*\~])/g,I)};function I(h,R){return R}j.escapePhrase=function(R){return R.replace(/"/g,b)},j.unescapePhrase=function(R){return R.replace(/\\(")/g,I)}},94601:(Ie,j,b)=>{"use strict";var I=b(79148),h=b(27487);j.parse=I.parse.bind(I),j.toString=b(20559),j.term={escape:h.escape,unescape:h.unescape},j.phrase={escape:h.escapePhrase,unescape:h.unescapePhrase}},79148:Ie=>{"use strict";function j(h,R){function i(){this.constructor=h}i.prototype=R.prototype,h.prototype=new i}function b(h,R,i,o){this.message=h,this.expected=R,this.found=i,this.location=o,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,b)}j(b,Error),b.buildMessage=function(h,R){var i={literal:function(x){return'"'+Y(x.text)+'"'},class:function(x){var w="",L;for(L=0;L<x.parts.length;L++)w+=x.parts[L]instanceof Array?ie(x.parts[L][0])+"-"+ie(x.parts[L][1]):ie(x.parts[L]);return"["+(x.inverted?"^":"")+w+"]"},any:function(x){return"any character"},end:function(x){return"end of input"},other:function(x){return x.description}};function o(x){return x.charCodeAt(0).toString(16).toUpperCase()}function Y(x){return x.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+o(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+o(w)})}function ie(x){return x.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(w){return"\\x0"+o(w)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(w){return"\\x"+o(w)})}function Z(x){return i[x.type](x)}function fe(x){var w=new Array(x.length),L,X;for(L=0;L<x.length;L++)w[L]=Z(x[L]);if(w.sort(),w.length>0){for(L=1,X=1;L<w.length;L++)w[L-1]!==w[L]&&(w[X]=w[L],X++);w.length=X}switch(w.length){case 1:return w[0];case 2:return w[0]+" or "+w[1];default:return w.slice(0,-1).join(", ")+", or "+w[w.length-1]}}function J(x){return x?'"'+Y(x)+'"':"end of input"}return"Expected "+fe(h)+" but "+J(R)+" found."};function I(h,R){R=R!==void 0?R:{};var i={},o={start:os},Y=os,ie=function(s){return s[0]},Z=function(){return{}},fe=function(s){return{operator:s}},J=function(s,c,d,_){var E={start:s,left:c},_=_.length==0?null:_[0].right==null?_[0].left:_[0];return _!=null&&(E.operator=d==""?"<implicit>":d[0],E.right=_),E},x=function(s,c){return c},w=function(s,c,E){var v={left:s},E=E.length==0?null:E[0].right==null?E[0].left:E[0];return E!=null&&(v.operator=c==""?"<implicit>":c[0],v.right=E),v},L=function(s){return s},X="(",pe=O("(",!1),q=")",Q=O(")",!1),W=function(s){return s[0].parenthesized=!0,s[0]},H=function(s,c){return c.field=s==null||s.label==""?"<implicit>":s.label,c.fieldLocation=s==null||s.label==""?null:s.location,c},Pe=function(s,c){return c.field=s.label,c.fieldLocation=s.location,c},we=function(s,c){var d={field:s==null||s.label==""?"<implicit>":s.label,fieldLocation:s==null||s.label==""?null:s.location};for(var v in c)d[v]=c[v];return d},dt=/^[:]/,te=je([":"],!1,!1),Oe=function(s){return{label:s.label,location:s.location}},ze=function(s,c,d,v){var E={term:c,quoted:!0,regex:!1,termLocation:at()};return d!=""&&(E.proximity=d),v!=""&&(E.boost=v),s!=""&&(E.prefix=s),E},Is=function(s,c){var d={term:c,quoted:!1,regex:!0,termLocation:at()};return d},ft=function(s,c,d,v){var E={term:c.label,quoted:!1,regex:!1,termLocation:at()};return d!=""&&(E.similarity=d),v!=""&&(E.boost=v),s!=""&&(E.prefix=s),E},be="\\",ge=O("\\",!1),He=function(s){return"\\"+s},Lt=".",N=O(".",!1),ws=/^[^ \t\r\n\f{}()"\/\^~[\]]/,Qt=je([" ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),pt=function(s){return s.join("")},As=function(s){return{label:s.join(""),location:at()}},Ue=/^[^: \t\r\n\f{}()"\/\^~[\]]/,gt=je([":"," ","	","\r",`
`,"\f","{","}","(",")",'"',"/","^","~","[","]"],!0,!1),Ee='"',$e=O('"',!1),Bt=function(s){return s.join("")},Ae="/",Ke=O("/",!1),Ts=function(s){return s.join("")},Re=ks(),me=function(s){return s},Ge="+",mt=O("+",!1),Te="-",ht=O("-",!1),yt="!",vt=O("!",!1),bt="{",Et=O("{",!1),k="}",Ye=O("}",!1),Ze="[",Je=O("[",!1),Ve="]",Me=O("]",!1),$t="^",z=O("^",!1),jt="?",Ne=O("?",!1),Wt=":",qt=O(":",!1),Ms="&",Cs=O("&",!1),Ft="|",zt=O("|",!1),B="'",Ht=O("'",!1),ke="~",St=O("~",!1),Ut="*",Kt=O("*",!1),Gt=" ",Yt=O(" ",!1),U=function(s){return s},Ds=function(s){return s},_s=function(s){return s==""||s==null?.5:s},xt="0.",Zt=O("0.",!1),Le=/^[0-9]/,Xe=je([["0","9"]],!1,!1),It=function(s){return parseFloat("0."+s.join(""))},Fe=function(s){return parseInt(s.join(""))},ce="TO",et=O("TO",!1),Jt=function(s,c){return{term_min:s,term_max:c,inclusive:"both"}},Ps=function(s,c){return{term_min:s,term_max:c,inclusive:"none"}},Os=function(s,c){return{term_min:s,term_max:c,inclusive:"left"}},Ce=function(s,c){return{term_min:s,term_max:c,inclusive:"right"}},C=function(s){return s},tt="OR NOT",Qe=O("OR NOT",!1),wt="AND NOT",Xt=O("AND NOT",!1),es="OR",ts=O("OR",!1),Be="AND",oe=O("AND",!1),st="NOT",Rs=O("NOT",!1),ss="||",Vs=O("||",!1),rs="&&",rt=O("&&",!1),De=lt("whitespace"),is=/^[ \t\r\n\f]/,ns=je([" ","	","\r",`
`,"\f"],!1,!1),l=0,T=0,it=[{line:1,column:1}],ne=0,At=[],F=0,nt;if("startRule"in R){if(!(R.startRule in o))throw new Error(`Can't start parsing from rule "`+R.startRule+'".');Y=o[R.startRule]}function Ns(){return h.substring(T,l)}function at(){return Se(T,l)}function ir(s,c){throw c=c!==void 0?c:Se(T,l),ls([lt(s)],h.substring(T,l),c)}function nr(s,c){throw c=c!==void 0?c:Se(T,l),Ls(s,c)}function O(s,c){return{type:"literal",text:s,ignoreCase:c}}function je(s,c,d){return{type:"class",parts:s,inverted:c,ignoreCase:d}}function ks(){return{type:"any"}}function as(){return{type:"end"}}function lt(s){return{type:"other",description:s}}function Tt(s){var c=it[s],d;if(c)return c;for(d=s-1;!it[d];)d--;for(c=it[d],c={line:c.line,column:c.column};d<s;)h.charCodeAt(d)===10?(c.line++,c.column=1):c.column++,d++;return it[s]=c,c}function Se(s,c){var d=Tt(s),v=Tt(c);return{start:{offset:s,line:d.line,column:d.column},end:{offset:c,line:v.line,column:v.column}}}function S(s){l<ne||(l>ne&&(ne=l,At=[]),At.push(s))}function Ls(s,c){return new b(s,null,null,c)}function ls(s,c,d){return new b(b.buildMessage(s,c),s,c,d)}function os(){var s,c,d,v;for(s=l,c=[],d=D();d!==i;)c.push(d),d=D();if(c!==i){if(d=[],v=ue(),v!==i)for(;v!==i;)d.push(v),v=ue();else d=i;d!==i?(T=s,c=ie(d),s=c):(l=s,s=i)}else l=s,s=i;if(s===i){for(s=l,c=[],d=D();d!==i;)c.push(d),d=D();c!==i&&(T=s,c=Z()),s=c,s===i&&(s=l,c=Rt(),c!==i&&(T=s,c=Z()),s=c)}return s}function ue(){var s,c,d,v,E,_;if(s=l,c=xe(),c!==i?(d=Rt(),d!==i?(T=s,c=fe(c),s=c):(l=s,s=i)):(l=s,s=i),s===i){if(s=l,c=xe(),c!==i)if(d=cs(),d!==i){for(v=[],E=xe();E!==i;)v.push(E),E=xe();if(v!==i){for(E=[],_=ue();_!==i;)E.push(_),_=ue();E!==i?(T=s,c=J(c,d,v,E),s=c):(l=s,s=i)}else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i&&(s=l,c=xe(),c!==i?(d=ue(),d!==i?(T=s,c=x(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i))if(s=l,c=cs(),c!==i){for(d=[],v=xe();v!==i;)d.push(v),v=xe();if(d!==i){for(v=[],E=ue();E!==i;)v.push(E),E=ue();v!==i?(T=s,c=w(c,d,v),s=c):(l=s,s=i)}else l=s,s=i}else l=s,s=i}return s}function cs(){var s,c,d,v;if(s=l,c=ds(),c!==i){for(d=[],v=D();v!==i;)d.push(v),v=D();d!==i?(T=s,c=L(c),s=c):(l=s,s=i)}else l=s,s=i;return s===i&&(s=us()),s}function us(){var s,c,d,v,E,_,M;if(s=l,h.charCodeAt(l)===40?(c=X,l++):(c=i,F===0&&S(pe)),c!==i){for(d=[],v=D();v!==i;)d.push(v),v=D();if(d!==i){if(v=[],E=ue(),E!==i)for(;E!==i;)v.push(E),E=ue();else v=i;if(v!==i)if(h.charCodeAt(l)===41?(E=q,l++):(E=i,F===0&&S(Q)),E!==i){for(_=[],M=D();M!==i;)_.push(M),M=D();_!==i?(T=s,c=W(v),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i}else l=s,s=i;return s}function ds(){var s,c,d;return s=l,c=Mt(),c===i&&(c=null),c!==i?(d=Bs(),d!==i?(T=s,c=H(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,c=Mt(),c!==i?(d=us(),d!==i?(T=s,c=Pe(c,d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,c=Mt(),c===i&&(c=null),c!==i?(d=se(),d!==i?(T=s,c=we(c,d),s=c):(l=s,s=i)):(l=s,s=i))),s}function Mt(){var s,c,d,v,E;if(s=l,c=ps(),c!==i)if(dt.test(h.charAt(l))?(d=h.charAt(l),l++):(d=i,F===0&&S(te)),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();v!==i?(T=s,c=Oe(c),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;return s}function se(){var s,c,d,v,E,_,M;if(s=l,c=Ot(),c===i&&(c=null),c!==i)if(d=Qs(),d!==i)if(v=hs(),v===i&&(v=null),v!==i)if(E=K(),E===i&&(E=null),E!==i){for(_=[],M=D();M!==i;)_.push(M),M=D();_!==i?(T=s,c=ze(c,d,v,E),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,c=Ot(),c===i&&(c=null),c!==i)if(d=We(),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();v!==i?(T=s,c=Is(c,d),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;if(s===i)if(s=l,c=Ot(),c===i&&(c=null),c!==i)if(d=ps(),d!==i)if(v=Dt(),v===i&&(v=null),v!==i)if(E=K(),E===i&&(E=null),E!==i){for(_=[],M=D();M!==i;)_.push(M),M=D();_!==i?(T=s,c=ft(c,d,v,E),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;else l=s,s=i;else l=s,s=i}return s}function fs(){var s,c,d;return s=l,h.charCodeAt(l)===92?(c=be,l++):(c=i,F===0&&S(ge)),c!==i?(d=ot(),d!==i?(T=s,c=He(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(h.charCodeAt(l)===46?(s=Lt,l++):(s=i,F===0&&S(N)),s===i&&(ws.test(h.charAt(l))?(s=h.charAt(l),l++):(s=i,F===0&&S(Qt)))),s}function he(){var s,c,d;if(s=l,c=[],d=fs(),d!==i)for(;d!==i;)c.push(d),d=fs();else c=i;return c!==i&&(T=s,c=pt(c)),s=c,s}function ps(){var s,c,d;if(s=l,c=[],d=gs(),d!==i)for(;d!==i;)c.push(d),d=gs();else c=i;return c!==i&&(T=s,c=As(c)),s=c,s}function gs(){var s,c,d;return s=l,h.charCodeAt(l)===92?(c=be,l++):(c=i,F===0&&S(ge)),c!==i?(d=ot(),d!==i?(T=s,c=He(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(h.charCodeAt(l)===46?(s=Lt,l++):(s=i,F===0&&S(N)),s===i&&(Ue.test(h.charAt(l))?(s=h.charAt(l),l++):(s=i,F===0&&S(gt)))),s}function Qs(){var s,c,d,v;if(s=l,h.charCodeAt(l)===34?(c=Ee,l++):(c=i,F===0&&S($e)),c!==i){for(d=[],v=ms();v!==i;)d.push(v),v=ms();d!==i?(h.charCodeAt(l)===34?(v=Ee,l++):(v=i,F===0&&S($e)),v!==i?(T=s,c=Bt(d),s=c):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;return s}function We(){var s,c,d,v;if(s=l,h.charCodeAt(l)===47?(c=Ae,l++):(c=i,F===0&&S(Ke)),c!==i){if(d=[],v=Ct(),v!==i)for(;v!==i;)d.push(v),v=Ct();else d=i;d!==i?(h.charCodeAt(l)===47?(v=Ae,l++):(v=i,F===0&&S(Ke)),v!==i?(T=s,c=Ts(d),s=c):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;return s}function ms(){var s,c,d;return s=l,c=l,F++,h.charCodeAt(l)===34?(d=Ee,l++):(d=i,F===0&&S($e)),d===i&&(h.charCodeAt(l)===92?(d=be,l++):(d=i,F===0&&S(ge))),F--,d===i?c=void 0:(l=c,c=i),c!==i?(h.length>l?(d=h.charAt(l),l++):(d=i,F===0&&S(Re)),d!==i?(T=s,c=me(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,h.charCodeAt(l)===92?(c=be,l++):(c=i,F===0&&S(ge)),c!==i?(d=ot(),d!==i?(T=s,c=He(d),s=c):(l=s,s=i)):(l=s,s=i)),s}function Ct(){var s,c,d;return s=l,c=l,F++,h.charCodeAt(l)===47?(d=Ae,l++):(d=i,F===0&&S(Ke)),d===i&&(h.charCodeAt(l)===92?(d=be,l++):(d=i,F===0&&S(ge))),F--,d===i?c=void 0:(l=c,c=i),c!==i?(h.length>l?(d=h.charAt(l),l++):(d=i,F===0&&S(Re)),d!==i?(T=s,c=me(d),s=c):(l=s,s=i)):(l=s,s=i),s===i&&(s=l,h.charCodeAt(l)===92?(c=be,l++):(c=i,F===0&&S(ge)),c!==i?(d=ot(),d!==i?(T=s,c=He(d),s=c):(l=s,s=i)):(l=s,s=i)),s}function ot(){var s;return h.charCodeAt(l)===43?(s=Ge,l++):(s=i,F===0&&S(mt)),s===i&&(h.charCodeAt(l)===45?(s=Te,l++):(s=i,F===0&&S(ht)),s===i&&(h.charCodeAt(l)===33?(s=yt,l++):(s=i,F===0&&S(vt)),s===i&&(h.charCodeAt(l)===40?(s=X,l++):(s=i,F===0&&S(pe)),s===i&&(h.charCodeAt(l)===41?(s=q,l++):(s=i,F===0&&S(Q)),s===i&&(h.charCodeAt(l)===123?(s=bt,l++):(s=i,F===0&&S(Et)),s===i&&(h.charCodeAt(l)===125?(s=k,l++):(s=i,F===0&&S(Ye)),s===i&&(h.charCodeAt(l)===91?(s=Ze,l++):(s=i,F===0&&S(Je)),s===i&&(h.charCodeAt(l)===93?(s=Ve,l++):(s=i,F===0&&S(Me)),s===i&&(h.charCodeAt(l)===94?(s=$t,l++):(s=i,F===0&&S(z)),s===i&&(h.charCodeAt(l)===34?(s=Ee,l++):(s=i,F===0&&S($e)),s===i&&(h.charCodeAt(l)===63?(s=jt,l++):(s=i,F===0&&S(Ne)),s===i&&(h.charCodeAt(l)===58?(s=Wt,l++):(s=i,F===0&&S(qt)),s===i&&(h.charCodeAt(l)===92?(s=be,l++):(s=i,F===0&&S(ge)),s===i&&(h.charCodeAt(l)===38?(s=Ms,l++):(s=i,F===0&&S(Cs)),s===i&&(h.charCodeAt(l)===124?(s=Ft,l++):(s=i,F===0&&S(zt)),s===i&&(h.charCodeAt(l)===39?(s=B,l++):(s=i,F===0&&S(Ht)),s===i&&(h.charCodeAt(l)===47?(s=Ae,l++):(s=i,F===0&&S(Ke)),s===i&&(h.charCodeAt(l)===126?(s=ke,l++):(s=i,F===0&&S(St)),s===i&&(h.charCodeAt(l)===42?(s=Ut,l++):(s=i,F===0&&S(Kt)),s===i&&(h.charCodeAt(l)===32?(s=Gt,l++):(s=i,F===0&&S(Yt)))))))))))))))))))))),s}function hs(){var s,c,d;return s=l,h.charCodeAt(l)===126?(c=ke,l++):(c=i,F===0&&S(St)),c!==i?(d=Pt(),d!==i?(T=s,c=U(d),s=c):(l=s,s=i)):(l=s,s=i),s}function K(){var s,c,d;return s=l,h.charCodeAt(l)===94?(c=$t,l++):(c=i,F===0&&S(z)),c!==i?(d=ys(),d!==i?(T=s,c=Ds(d),s=c):(l=s,s=i)):(l=s,s=i),s}function Dt(){var s,c,d;return s=l,h.charCodeAt(l)===126?(c=ke,l++):(c=i,F===0&&S(St)),c!==i?(d=_t(),d===i&&(d=null),d!==i?(T=s,c=_s(d),s=c):(l=s,s=i)):(l=s,s=i),s}function ys(){var s;return s=_t(),s===i&&(s=Pt()),s}function _t(){var s,c,d,v;if(s=l,h.substr(l,2)===xt?(c=xt,l+=2):(c=i,F===0&&S(Zt)),c!==i){if(d=[],Le.test(h.charAt(l))?(v=h.charAt(l),l++):(v=i,F===0&&S(Xe)),v!==i)for(;v!==i;)d.push(v),Le.test(h.charAt(l))?(v=h.charAt(l),l++):(v=i,F===0&&S(Xe));else d=i;d!==i?(T=s,c=It(d),s=c):(l=s,s=i)}else l=s,s=i;return s}function Pt(){var s,c,d;if(s=l,c=[],Le.test(h.charAt(l))?(d=h.charAt(l),l++):(d=i,F===0&&S(Xe)),d!==i)for(;d!==i;)c.push(d),Le.test(h.charAt(l))?(d=h.charAt(l),l++):(d=i,F===0&&S(Xe));else c=i;return c!==i&&(T=s,c=Fe(c)),s=c,s}function Bs(){var s,c,d,v,E,_,M,re;if(s=l,h.charCodeAt(l)===91?(c=Ze,l++):(c=i,F===0&&S(Je)),c!==i)if(d=he(),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();if(v!==i)if(h.substr(l,2)===ce?(E=ce,l+=2):(E=i,F===0&&S(et)),E!==i){if(_=[],M=D(),M!==i)for(;M!==i;)_.push(M),M=D();else _=i;_!==i?(M=he(),M!==i?(h.charCodeAt(l)===93?(re=Ve,l++):(re=i,F===0&&S(Me)),re!==i?(T=s,c=Jt(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,h.charCodeAt(l)===123?(c=bt,l++):(c=i,F===0&&S(Et)),c!==i)if(d=he(),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();if(v!==i)if(h.substr(l,2)===ce?(E=ce,l+=2):(E=i,F===0&&S(et)),E!==i){if(_=[],M=D(),M!==i)for(;M!==i;)_.push(M),M=D();else _=i;_!==i?(M=he(),M!==i?(h.charCodeAt(l)===125?(re=k,l++):(re=i,F===0&&S(Ye)),re!==i?(T=s,c=Ps(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i){if(s=l,h.charCodeAt(l)===91?(c=Ze,l++):(c=i,F===0&&S(Je)),c!==i)if(d=he(),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();if(v!==i)if(h.substr(l,2)===ce?(E=ce,l+=2):(E=i,F===0&&S(et)),E!==i){if(_=[],M=D(),M!==i)for(;M!==i;)_.push(M),M=D();else _=i;_!==i?(M=he(),M!==i?(h.charCodeAt(l)===125?(re=k,l++):(re=i,F===0&&S(Ye)),re!==i?(T=s,c=Os(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i;if(s===i)if(s=l,h.charCodeAt(l)===123?(c=bt,l++):(c=i,F===0&&S(Et)),c!==i)if(d=he(),d!==i){for(v=[],E=D();E!==i;)v.push(E),E=D();if(v!==i)if(h.substr(l,2)===ce?(E=ce,l+=2):(E=i,F===0&&S(et)),E!==i){if(_=[],M=D(),M!==i)for(;M!==i;)_.push(M),M=D();else _=i;_!==i?(M=he(),M!==i?(h.charCodeAt(l)===93?(re=Ve,l++):(re=i,F===0&&S(Me)),re!==i?(T=s,c=Ce(d,M),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}else l=s,s=i;else l=s,s=i}else l=s,s=i;else l=s,s=i}}return s}function xe(){var s,c,d,v,E;for(s=l,c=[],d=D();d!==i;)c.push(d),d=D();if(c!==i)if(d=vs(),d!==i){if(v=[],E=D(),E!==i)for(;E!==i;)v.push(E),E=D();else v=i;v!==i?(T=s,c=C(d),s=c):(l=s,s=i)}else l=s,s=i;else l=s,s=i;if(s===i){for(s=l,c=[],d=D();d!==i;)c.push(d),d=D();c!==i?(d=vs(),d!==i?(v=Rt(),v!==i?(T=s,c=C(d),s=c):(l=s,s=i)):(l=s,s=i)):(l=s,s=i)}return s}function vs(){var s;return h.substr(l,6)===tt?(s=tt,l+=6):(s=i,F===0&&S(Qe)),s===i&&(h.substr(l,7)===wt?(s=wt,l+=7):(s=i,F===0&&S(Xt)),s===i&&(h.substr(l,2)===es?(s=es,l+=2):(s=i,F===0&&S(ts)),s===i&&(h.substr(l,3)===Be?(s=Be,l+=3):(s=i,F===0&&S(oe)),s===i&&(h.substr(l,3)===st?(s=st,l+=3):(s=i,F===0&&S(Rs)),s===i&&(h.substr(l,2)===ss?(s=ss,l+=2):(s=i,F===0&&S(Vs)),s===i&&(h.substr(l,2)===rs?(s=rs,l+=2):(s=i,F===0&&S(rt)))))))),s}function Ot(){var s,c,d;for(s=l,c=[],d=D();d!==i;)c.push(d),d=D();return c!==i?(d=js(),d!==i?(T=s,c=C(d),s=c):(l=s,s=i)):(l=s,s=i),s}function js(){var s;return h.charCodeAt(l)===43?(s=Ge,l++):(s=i,F===0&&S(mt)),s===i&&(h.charCodeAt(l)===45?(s=Te,l++):(s=i,F===0&&S(ht)),s===i&&(h.charCodeAt(l)===33?(s=yt,l++):(s=i,F===0&&S(vt)))),s}function D(){var s,c;if(F++,s=[],is.test(h.charAt(l))?(c=h.charAt(l),l++):(c=i,F===0&&S(ns)),c!==i)for(;c!==i;)s.push(c),is.test(h.charAt(l))?(c=h.charAt(l),l++):(c=i,F===0&&S(ns));else s=i;return F--,s===i&&(c=i,F===0&&S(De)),s}function Rt(){var s,c;return s=l,F++,h.length>l?(c=h.charAt(l),l++):(c=i,F===0&&S(Re)),F--,c===i?s=void 0:(l=s,s=i),s}if(nt=Y(),nt!==i&&l===h.length)return nt;throw nt!==i&&l<h.length&&S(as()),ls(At,ne<h.length?h.charAt(ne):null,ne<h.length?Se(ne,ne+1):Se(ne,ne))}Ie.exports={SyntaxError:b,parse:I}},20559:Ie=>{"use strict";var j="<implicit>";Ie.exports=function b(I){if(!I)return"";var h="";return I.start!=null&&(h+=(I.parenthesized?"(":"")+I.start+" "),I.field&&I.field!==j&&(h+=I.field+":"),I.left&&(I.parenthesized&&!I.start&&(h+="("),h+=b(I.left),I.parenthesized&&!I.right&&(h+=")")),I.operator&&(I.left&&(h+=" "),I.operator!==j&&(h+=I.operator)),I.right&&(I.operator&&I.operator!==j&&(h+=" "),h+=b(I.right),I.parenthesized&&(h+=")")),(I.term||I.term===""&&I.quoted)&&(I.prefix&&(h+=I.prefix),I.quoted?(h+='"',h+=I.term,h+='"'):I.regex?(h+="/",h+=I.term,h+="/"):h+=I.term,I.proximity!=null&&(h+="~"+I.proximity),I.boost!=null&&(h+="^"+I.boost)),I.term_min&&(I.inclusive==="both"||I.inclusive==="left"?h+="[":h+="{",h+=I.term_min,h+=" TO ",h+=I.term_max,I.inclusive==="both"||I.inclusive==="right"?h+="]":h+="}"),I.similarity&&(h+="~",I.similarity!==.5&&(h+=I.similarity)),h}}}]);

//# sourceMappingURL=2261.8589669d17048beeb381.js.map