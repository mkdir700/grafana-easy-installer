"use strict";(self.webpackChunk_grafana_ui=self.webpackChunk_grafana_ui||[]).push([[5140],{"./src/components/QueryField/QueryField.story.tsx":function(Be,F,p){p.r(F),p.d(F,{Basic:function(){return V},default:function(){return kt}});var f=p("../../node_modules/react/index.js"),v=p("../../node_modules/@emotion/css/dist/emotion-css.esm.js"),C=p("../../node_modules/classnames/index.js"),E=p.n(C),w=p("../../node_modules/lodash/lodash.js"),_=p("../../node_modules/slate-plain-serializer/lib/slate-plain-serializer.es.js"),ee=p("../../node_modules/slate-react/lib/slate-react.es.js"),te=p("../grafana-e2e-selectors/src/selectors/index.ts"),L=p("../../node_modules/react-dom/index.js"),ne=p("../../node_modules/react-window/dist/index.esm.js"),re=p("../grafana-data/src/themes/context.tsx"),P=(t=>(t.GroupTitle="GroupTitle",t))(P||{}),ae=p("../../node_modules/calculate-size/lib/index.js");const z=t=>t.reduce((e,{items:n,label:r})=>(e.push({label:r,kind:P.GroupTitle}),n.reduce((a,s)=>(a.push(s),a),e)),[]),M=t=>t.reduce((e,n)=>e.length<n.label.length?n.label:e,""),Q=(t,e,n)=>{const r=(0,ae.A)(n,{font:t.typography.fontFamilyMonospace,fontSize:t.typography.bodySmall.fontSize,fontWeight:"normal"}),a=oe(r.width,t),s=se(r.height,t),o=ie(s,e);return{listWidth:a,listHeight:o,itemHeight:s}},se=(t,e)=>{const n=e.spacing.gridSize*2;return t+n},oe=(t,e)=>{const n=e.spacing.gridSize*3,r=800;return Math.min(Math.max(t+n,200),r)},ie=(t,e)=>{const n=Math.min(e.length,10),r=100,a=n*t;return Math.max(a,r)};var D=p("../../node_modules/marked/lib/marked.esm.js"),le=p("../../node_modules/marked-mangle/src/index.js"),ue=p("../grafana-data/src/text/sanitize.ts"),de=Object.defineProperty,H=Object.defineProperties,c=Object.getOwnPropertyDescriptors,y=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,Fe=Object.prototype.propertyIsEnumerable,xe=(t,e,n)=>e in t?de(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ce=(t,e)=>{for(var n in e||(e={}))x.call(e,n)&&xe(t,n,e[n]);if(y)for(var n of y(e))Fe.call(e,n)&&xe(t,n,e[n]);return t},Le=(t,e)=>H(t,c(e));let K=!1;const pe={pedantic:!1,gfm:!0,breaks:!1};function ze(t,e){K||(D.xI.use((0,le.z)()),D.xI.setOptions(ce({},pe)),K=!0);let n;e?.breaks&&(n=Le(ce({},pe),{breaks:!0}));const r=(0,D.xI)(t||"",n);if(typeof r!="string")throw new Error("Failed to process markdown synchronously.");return e?.noSanitize?r:(0,ue.G$)(r)}function Dt(t,e){K||(marked.use(mangle()),marked.setOptions(ce({},pe)),K=!0);const n=marked(t||"");if(typeof n!="string")throw new Error("Failed to process markdown synchronously.");return e?.noSanitize?n:sanitizeTextPanelContent(n)}var fe=p("./src/themes/ThemeContext.tsx");const Me=(t,e,n)=>({typeaheadItem:(0,v.AH)({label:"type-ahead-item",zIndex:11,padding:t.spacing(1,1,1,2),border:t.colors.border.medium,overflowY:"scroll",overflowX:"hidden",outline:"none",background:t.colors.background.secondary,color:t.colors.text.secondary,boxShadow:`0 0 20px ${t.v1.colors.dropdownShadow}`,visibility:n===!0?"visible":"hidden",width:"250px",minHeight:`${e+parseInt(t.spacing(.25),10)}px`,position:"relative",wordBreak:"break-word"})}),N=({item:t,height:e})=>{const n=t&&!!t.documentation,r=t?t.label:"",a=ze(t?.documentation),s=(0,fe.$j)(),o=Me(s,e,n);return f.createElement("div",{className:(0,v.cx)([o.typeaheadItem])},f.createElement("b",null,r),f.createElement("hr",null),f.createElement("div",{dangerouslySetInnerHTML:{__html:a}}))};try{N.displayName="TypeaheadInfo",N.__docgenInfo={description:"",displayName:"TypeaheadInfo",props:{item:{defaultValue:null,description:"",name:"item",required:!0,type:{name:"CompletionItem"}},height:{defaultValue:null,description:"",name:"height",required:!0,type:{name:"number"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/TypeaheadInfo.tsx#TypeaheadInfo"]={docgenInfo:N.__docgenInfo,name:"TypeaheadInfo",path:"src/components/Typeahead/TypeaheadInfo.tsx#TypeaheadInfo"})}catch{}var Qe=p("../../node_modules/react-highlight-words/dist/main.js"),He=p.n(Qe);function Ke(t,e){const n=[];return t.forEach(r=>{n.push(r.start,r.end+1)}),n[0]!==0&&n.unshift(0),n[n.length-1]!==e&&n.push(e),n}const j=t=>{let{highlightParts:e,text:n,highlightClassName:r}=t;if(!e?.length)return null;let a=[],s=Ke(e,n.length),o=e[0].start===0;for(let u=1;u<s.length;u++){let i=s[u-1],l=s[u];a.push((0,f.createElement)(o?"mark":"span",{key:u-1,className:o?r:void 0},n.substring(i,l))),o=!o}return f.createElement("div",null,a)};try{j.displayName="PartialHighlighter",j.__docgenInfo={description:"",displayName:"PartialHighlighter",props:{text:{defaultValue:null,description:"",name:"text",required:!0,type:{name:"string"}},highlightParts:{defaultValue:null,description:"",name:"highlightParts",required:!0,type:{name:"HighlightPart[]"}},highlightClassName:{defaultValue:null,description:"",name:"highlightClassName",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/PartialHighlighter.tsx#PartialHighlighter"]={docgenInfo:j.__docgenInfo,name:"PartialHighlighter",path:"src/components/Typeahead/PartialHighlighter.tsx#PartialHighlighter"})}catch{}const Ne=t=>({typeaheadItem:(0,v.AH)({border:"none",background:"none",textAlign:"left",label:"type-ahead-item",height:"auto",fontFamily:t.typography.fontFamilyMonospace,padding:t.spacing(1,1,1,2),fontSize:t.typography.bodySmall.fontSize,textOverflow:"ellipsis",overflow:"hidden",zIndex:11,display:"block",whiteSpace:"nowrap",cursor:"pointer",transition:"color 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), border-color 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), background 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), padding 0.15s cubic-bezier(0.645, 0.045, 0.355, 1)"}),typeaheadItemSelected:(0,v.AH)({label:"type-ahead-item-selected",backgroundColor:t.colors.background.secondary}),typeaheadItemMatch:(0,v.AH)({label:"type-ahead-item-match",color:t.v1.palette.yellow,borderBottom:`1px solid ${t.v1.palette.yellow}`,padding:"inherit",background:"inherit"}),typeaheadItemGroupTitle:(0,v.AH)({label:"type-ahead-item-group-title",color:t.colors.text.secondary,fontSize:t.typography.bodySmall.fontSize,lineHeight:t.typography.body.lineHeight,padding:t.spacing(1)})}),q=t=>{const e=(0,fe.of)(Ne),{isSelected:n,item:r,prefix:a,style:s,onMouseEnter:o,onMouseLeave:u,onClickItem:i}=t,l=n?(0,v.cx)([e.typeaheadItem,e.typeaheadItemSelected]):(0,v.cx)([e.typeaheadItem]),d=(0,v.cx)([e.typeaheadItemMatch]),T=(0,v.cx)([e.typeaheadItemGroupTitle]),m=r.label||"";return r.kind===P.GroupTitle?f.createElement("li",{className:T,style:s},f.createElement("span",null,m)):f.createElement("li",{role:"none"},f.createElement("button",{role:"menuitem",className:l,style:s,onMouseDown:i,onMouseEnter:o,onMouseLeave:u,type:"button"},r.highlightParts!==void 0?f.createElement(j,{text:m,highlightClassName:d,highlightParts:r.highlightParts}):f.createElement(He(),{textToHighlight:m,searchWords:[a??""],autoEscape:!0,highlightClassName:d})))};try{q.displayName="TypeaheadItem",q.__docgenInfo={description:"",displayName:"TypeaheadItem",props:{isSelected:{defaultValue:null,description:"",name:"isSelected",required:!0,type:{name:"boolean"}},item:{defaultValue:null,description:"",name:"item",required:!0,type:{name:"CompletionItem"}},style:{defaultValue:null,description:"",name:"style",required:!0,type:{name:"CSSProperties"}},prefix:{defaultValue:null,description:"",name:"prefix",required:!1,type:{name:"string"}},onClickItem:{defaultValue:null,description:"",name:"onClickItem",required:!1,type:{name:"((event: MouseEvent<Element, MouseEvent>) => void)"}},onMouseEnter:{defaultValue:null,description:"",name:"onMouseEnter",required:!1,type:{name:"(() => void)"}},onMouseLeave:{defaultValue:null,description:"",name:"onMouseLeave",required:!1,type:{name:"(() => void)"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/TypeaheadItem.tsx#TypeaheadItem"]={docgenInfo:q.__docgenInfo,name:"TypeaheadItem",path:"src/components/Typeahead/TypeaheadItem.tsx#TypeaheadItem"})}catch{}const Te=(t,e)=>t-e*Math.floor(t/e);class R extends f.PureComponent{constructor(){super(...arguments),this.listRef=(0,f.createRef)(),this.state={hoveredItem:null,typeaheadIndex:null,allItems:[],listWidth:-1,listHeight:-1,itemHeight:-1},this.componentDidMount=()=>{this.props.menuRef&&this.props.menuRef(this),document.addEventListener("selectionchange",this.handleSelectionChange);const e=z(this.props.groupedItems),n=M(e),{listWidth:r,listHeight:a,itemHeight:s}=Q(this.context,e,n);this.setState({listWidth:r,listHeight:a,itemHeight:s,allItems:e})},this.componentWillUnmount=()=>{document.removeEventListener("selectionchange",this.handleSelectionChange)},this.handleSelectionChange=()=>{this.forceUpdate()},this.componentDidUpdate=(e,n)=>{if(this.state.typeaheadIndex!==null&&n.typeaheadIndex!==this.state.typeaheadIndex&&this.listRef&&this.listRef.current){if(this.state.typeaheadIndex===1){this.listRef.current.scrollToItem(0);return}this.listRef.current.scrollToItem(this.state.typeaheadIndex)}if((0,w.isEqual)(e.groupedItems,this.props.groupedItems)===!1){const r=z(this.props.groupedItems),a=M(r),{listWidth:s,listHeight:o,itemHeight:u}=Q(this.context,r,a);this.setState({listWidth:s,listHeight:o,itemHeight:u,allItems:r,typeaheadIndex:null})}},this.onMouseEnter=e=>{this.setState({hoveredItem:e})},this.onMouseLeave=()=>{this.setState({hoveredItem:null})},this.moveMenuIndex=e=>{const n=this.state.allItems.length;if(n){const r=this.state.typeaheadIndex||0;let a=Te(r+e,n);this.state.allItems[a].kind===P.GroupTitle&&(a=Te(a+e,n)),this.setState({typeaheadIndex:a});return}},this.insertSuggestion=()=>{this.props.onSelectSuggestion&&this.state.typeaheadIndex!==null&&this.props.onSelectSuggestion(this.state.allItems[this.state.typeaheadIndex])}}get menuPosition(){if(!window.getSelection)return"";const e=window.getSelection(),n=e&&e.anchorNode;if(n&&n.parentElement){const r=n.parentElement.getBoundingClientRect(),a=window.scrollX,s=window.scrollY;return`position: absolute; display: flex; top: ${r.top+s+r.height+6}px; left: ${r.left+a-2}px`}return""}render(){const{prefix:e,isOpen:n=!1,origin:r}=this.props,{allItems:a,listWidth:s,listHeight:o,itemHeight:u,hoveredItem:i,typeaheadIndex:l}=this.state,d=i||l,T=a[i||l||0];return f.createElement(je,{origin:r,isOpen:n,style:this.menuPosition},f.createElement("ul",{role:"menu",className:"typeahead","data-testid":"typeahead"},f.createElement(ne.Y1,{ref:this.listRef,itemCount:a.length,itemSize:u,itemKey:m=>{const O=a&&a[m];return O?`${m}-${O.label}`:`${m}`},width:s,height:o},({index:m,style:O})=>{const g=a&&a[m];return g?f.createElement(q,{onClickItem:()=>this.props.onSelectSuggestion?this.props.onSelectSuggestion(g):{},isSelected:l===null?!1:a[l]===g,item:g,prefix:e,style:O,onMouseEnter:()=>this.onMouseEnter(m),onMouseLeave:this.onMouseLeave}):null})),d&&f.createElement(N,{height:o,item:T}))}}R.contextType=re.D;class je extends f.PureComponent{constructor(e){super(e);const{index:n=0,origin:r="query",style:a}=e;this.node=document.createElement("div"),this.node.setAttribute("style",a),this.node.classList.add("slate-typeahead",`slate-typeahead-${r}-${n}`),document.body.appendChild(this.node)}componentWillUnmount(){document.body.removeChild(this.node)}render(){return this.props.isOpen?(this.node.setAttribute("style",this.props.style),this.node.classList.add("slate-typeahead--open"),L.createPortal(this.props.children,this.node)):(this.node.classList.remove("slate-typeahead--open"),null)}}try{R.displayName="Typeahead",R.__docgenInfo={description:"",displayName:"Typeahead",props:{origin:{defaultValue:null,description:"",name:"origin",required:!0,type:{name:"string"}},groupedItems:{defaultValue:null,description:"",name:"groupedItems",required:!0,type:{name:"CompletionItemGroup[]"}},prefix:{defaultValue:null,description:"",name:"prefix",required:!1,type:{name:"string"}},menuRef:{defaultValue:null,description:"",name:"menuRef",required:!1,type:{name:"((el: Typeahead) => void)"}},onSelectSuggestion:{defaultValue:null,description:"",name:"onSelectSuggestion",required:!1,type:{name:"((suggestion: CompletionItem) => void)"}},isOpen:{defaultValue:null,description:"",name:"isOpen",required:!1,type:{name:"boolean"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/Typeahead.tsx#Typeahead"]={docgenInfo:R.__docgenInfo,name:"Typeahead",path:"src/components/Typeahead/Typeahead.tsx#Typeahead"})}catch{}try{contextType.displayName="Typeahead.contextType",contextType.__docgenInfo={description:`Context lets components pass information deep down without explicitly
passing props.

Created from {@link createContext}`,displayName:"Typeahead.contextType",props:{}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/Typeahead/Typeahead.tsx#Typeahead.contextType"]={docgenInfo:R.contextType.__docgenInfo,name:"Typeahead.contextType",path:"src/components/Typeahead/Typeahead.tsx#Typeahead.contextType"})}catch{}var A=p("../../node_modules/slate/lib/slate.es.js");const qe={document:{nodes:[{match:[{type:"paragraph"},{type:"code_block"},{type:"code_line"}]}]},inlines:{}},ve=(t,e)=>{const n=t.split(`
`).map(a=>A.eB.create({type:"code_line",nodes:[A.EY.create(a)]})),r=A.eB.create({data:{syntax:e},type:"code_block",nodes:n});return A.yo.create({nodes:[r]})},Se=(t,e)=>{const n=ve(t,e);return A.WT.create({document:n})};function We(t,e){let n=0,r=t.indexOf(e);e=e.replace(/\s/g,"");const a=[];if(r!==-1)return{distance:0,found:!0,ranges:[{start:r,end:r+e.length-1}]};for(const s of e){const o=t.indexOf(s,r);if(o===-1)return{distance:1/0,ranges:[],found:!1};if(r!==-1&&(n+=o-r),r=o+1,a.length===0)a.push({start:o,end:o});else{const u=(0,w.last)(a);o===u.end+1?u.end++:a.push({start:o,end:o})}}return{distance:n,ranges:a,found:!0}}var he=(t=>(t.Word="Word",t.Prefix="Prefix",t.Fuzzy="Fuzzy",t))(he||{});const Ue={Word:(t,e)=>t.filter(n=>(n.filterText||n.label).includes(e)),Prefix:(t,e)=>t.filter(n=>(n.filterText||n.label).startsWith(e)),Fuzzy:(t,e)=>(e=e.toLowerCase(),t.filter(n=>{const{distance:r,ranges:a,found:s}=We(n.label.toLowerCase(),e);return s?(n.sortValue=r,n.highlightParts=a,!0):!1}))};var Oe="prism-token",Ye=Object.defineProperty,Ge=Object.defineProperties,$e=Object.getOwnPropertyDescriptors,_e=Object.getOwnPropertySymbols,Xe=Object.prototype.hasOwnProperty,Je=Object.prototype.propertyIsEnumerable,Ie=(t,e,n)=>e in t?Ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,b=(t,e)=>{for(var n in e||(e={}))Xe.call(e,n)&&Ie(t,n,e[n]);if(_e)for(var n of _e(e))Je.call(e,n)&&Ie(t,n,e[n]);return t},W=(t,e)=>Ge(t,$e(e)),Ze=(t,e,n)=>new Promise((r,a)=>{var s=i=>{try{u(n.next(i))}catch(l){a(l)}},o=i=>{try{u(n.throw(i))}catch(l){a(l)}},u=i=>i.done?r(i.value):Promise.resolve(i.value).then(s,o);u((n=n.apply(t,e)).next())});const et=250;function U({onTypeahead:t,cleanText:e,onWillApplySuggestion:n,portalOrigin:r}){let a,s={groupedItems:[],typeaheadPrefix:"",typeaheadContext:"",typeaheadText:""};const o=(0,w.debounce)(tt,et),u=i=>{s=b(b({},s),i)};return{onBlur:(i,l,d)=>(s=W(b({},s),{groupedItems:[]}),d()),onClick:(i,l,d)=>(s=W(b({},s),{groupedItems:[]}),d()),onKeyDown:(i,l,d)=>{const m=s.groupedItems.length;switch(i.key){case"Escape":{if(m)return i.preventDefault(),s=W(b({},s),{groupedItems:[]}),l.insertText("");break}case"ArrowDown":case"ArrowUp":if(m){i.preventDefault(),a.moveMenuIndex(i.key==="ArrowDown"?1:-1);return}break;case"Enter":{if(!(i.shiftKey||i.ctrlKey)&&m)return i.preventDefault(),a.insertSuggestion();break}case"Tab":{if(m)return i.preventDefault(),a.insertSuggestion();break}default:{i.key.length===1&&o(l,u,t,e);break}}return d()},commands:{selectSuggestion:(i,l)=>{const d=s.groupedItems;if(!d||!d.length)return i;const T=i.applyTypeahead(l);return o(i,u,t,e),T},applyTypeahead:(i,l)=>{let d=l.insertText||l.label;const T=l.kind==="function",m=l.move||0,O=m>0?m:0,g=m<0?-m:0,{typeaheadPrefix:B,typeaheadText:J,typeaheadContext:ye}=s;n&&(d=n(d,{groupedItems:s.groupedItems,typeaheadContext:ye,typeaheadPrefix:B,typeaheadText:J}));const{forward:Z,backward:h}=nt(d,B,J,T,l.deleteBackwards,e);if(d.match(/\n/)){const ge=ve(d);return i.deleteBackward(h).deleteForward(Z).insertFragment(ge).focus(),i}return s=W(b({},s),{groupedItems:[]}),i.snapshotSelection().deleteBackward(h).deleteForward(Z).insertText(d).moveForward(O).moveBackward(g).focus(),i}},renderEditor(i,l,d){if(l.value.selection.isExpanded)return d();const T=d();return f.createElement(f.Fragment,null,T,f.createElement(R,{menuRef:m=>a=m,origin:r,prefix:s.typeaheadPrefix,isOpen:!!s.groupedItems.length,groupedItems:s.groupedItems,onSelectSuggestion:l.selectSuggestion}))}}}const tt=(t,e,n,r)=>Ze(void 0,null,function*(){if(!n)return;const{value:a}=t,{selection:s}=a,o=a.document.getClosestBlock(a.focusBlock.key),u=a.selection.start.offset-1,i=o&&o.getDecorations(t),l=i?i.filter(h=>h.start.offset<=u&&h.end.offset>u&&h.type===Oe).toArray():[],d=i&&i.filter(h=>h.end.offset<=u&&h.type===Oe&&h.data.get("className").includes("label-key")).last(),T=d&&a.focusText.text.slice(d.start.offset,d.end.offset),m=l.map(h=>h.data.get("className")).join(" ").split(" ").filter(h=>h.length);let O=a.focusText.text,g=O.slice(0,s.focus.offset);l.length&&(O=a.focusText.text.slice(l[0].start.offset,l[0].end.offset),g=a.focusText.text.slice(l[0].start.offset,s.focus.offset));const B=g.match(/(?:!?=~?"?|")(.*)/);B?g=B[1]:r&&(g=r(g));const{suggestions:J,context:ye}=yield n({prefix:g,text:O,value:a,wrapperClasses:m,labelKey:T||void 0,editor:t}),Z=J.map(h=>{if(!h.items)return h;const ge=h.searchFunctionType||(h.prefixMatch?he.Prefix:he.Word),Vt=Ue[ge];let I=b({},h);return g&&(h.skipFilter||(I.items=I.items.filter(S=>(S.filterText||S.label).length>=g.length),I.items=Vt(I.items,g)),I.items=I.items.filter(S=>{var De;return!(S.insertText===g||((De=S.filterText)!=null?De:S.label)===g)})),h.skipSort||(I.items=(0,w.sortBy)(I.items,S=>S.sortText===void 0?S.sortValue!==void 0?S.sortValue:S.label:S.sortText||S.label)),I}).filter(h=>h.items&&h.items.length);e({groupedItems:Z,typeaheadPrefix:g,typeaheadContext:ye,typeaheadText:O}),t.blur().focus()});function nt(t,e,n,r,a,s){const o=a||e.length,u=s?s(n):n,i=n.indexOf(e),l=i>-1?u.length-i-e.length:u.length-e.length;return{forward:!!(e&&l>0||t===n)&&!r?l+i:0,backward:o}}try{U.displayName="SuggestionsPlugin",U.__docgenInfo={description:"",displayName:"SuggestionsPlugin",props:{onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/slate-plugins/suggestions.tsx#SuggestionsPlugin"]={docgenInfo:U.__docgenInfo,name:"SuggestionsPlugin",path:"src/slate-plugins/suggestions.tsx#SuggestionsPlugin"})}catch{}function rt({handler:t}){return{onKeyDown(e,n,r){return t&&e.key==="Enter"&&(e.shiftKey||e.ctrlKey)?(e.preventDefault(),t(e),n):r()}}}function at(t){let e=t.length-t.trimLeft().length;if(e){let n=t[0];for(;--e;)n+=t[0];return n}return""}function st(){return{onKeyDown(t,e,n){const r=e.value;if(r.selection.isExpanded)return n();if(t.key==="Enter"){t.preventDefault();const{startBlock:a}=r,s=a.text,o=at(s);return e.splitBlock().insertText(o).focus()}return n()}}}function ot(){return{onKeyDown(t,e,n){const r=e.value;if(r.selection.isExpanded)return n();if(t.key==="k"&&t.ctrlKey){t.preventDefault();const a=r.anchorText.text,s=r.selection.anchor.offset,u=a.length-s;return e.deleteForward(u),!0}return n()}}}var Y=p("../../node_modules/is-hotkey/lib/index.js");const it=(0,Y.Sn)("mod+l");function lt(){return{onKeyDown(t,e,n){if(it(t)){t.preventDefault();const{focusBlock:r,document:a}=e.value;e.moveAnchorToStartOfBlock(),a.getNextBlock(r.key)?e.moveFocusToStartOfNextBlock():e.moveFocusToEndOfText()}else return n();return!0}}}const ut=(0,Y.Sn)("mod+["),dt=(0,Y.Sn)("shift+tab"),ct=(0,Y.Sn)("mod+]"),G="  ",pt=(t,e,n)=>{const{startBlock:r,endBlock:a,selection:{start:{offset:s,key:o},end:{offset:u,key:i}}}=e.value;if(_.A.serialize(e.value)==="")return;t.preventDefault();const l=r.getFirstText();l&&s===0&&o===l.key&&u===l.text.length&&i===l.key||!r.equals(a)?me(e,"right"):e.insertText(G)},me=(t,e)=>{const n=t.value.selection,r=t.value.document.getLeafBlocksAtRange(n).toArray();if(e==="left")for(const a of r){const s=a.text.length-a.text.trimLeft().length,o=a.getFirstText().key,u={anchor:{key:o,offset:s,path:[]},focus:{key:o,offset:s,path:[]}};t.deleteBackwardAtRange(A.Q6.create(u),Math.min(G.length,s))}else{const{startText:a}=t.value,s=a.text.slice(0,n.start.offset),o=/^\s*$/.test(s);for(const u of r)t.insertTextByKey(u.getFirstText().key,0,G);o&&t.moveStartBackward(G.length)}};function ft(){return{onKeyDown(t,e,n){if(ut(t)||dt(t))t.preventDefault(),me(e,"left");else if(ct(t))t.preventDefault(),me(e,"right");else if(t.key==="Tab")pt(t,e,n);else return n();return!0}}}var ht=Object.defineProperty,mt=Object.defineProperties,yt=Object.getOwnPropertyDescriptors,Ee=Object.getOwnPropertySymbols,gt=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable,Pe=(t,e,n)=>e in t?ht(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Tt=(t,e)=>{for(var n in e||(e={}))gt.call(e,n)&&Pe(t,n,e[n]);if(Ee)for(var n of Ee(e))xt.call(e,n)&&Pe(t,n,e[n]);return t},vt=(t,e)=>mt(t,yt(e));const St=(t,e,n)=>{if(!t.length)return;const r=t.slice(0,-1).join("").length+t.length-1;return t.join(`
`).slice(e,r+n)},be=t=>t?.replace(/[\uFEFF]/g,"");function Ot(){const t={onCopy(e,n,r){e.preventDefault();const{document:a,selection:s}=n.value,{start:{offset:o},end:{offset:u}}=s,i=a.getLeafBlocksAtRange(s).toArray().map(d=>d.text),l=be(St(i,o,u));return l&&e.clipboardData&&e.clipboardData.setData("Text",l),!0},onPaste(e,n,r){if(e.preventDefault(),e.clipboardData){const a=be(e.clipboardData.getData("Text")),s=a?.split(`
`);if(s&&s.length){n.insertText(s[0]);for(const o of s.slice(1))n.splitBlock().insertText(o)}}return!0}};return vt(Tt({},t),{onCut(e,n,r){return t.onCopy(e,n,r),n.deleteAtRange(n.value.selection),!0}})}var _t=p("./src/themes/mixins.ts");class $ extends f.PureComponent{constructor(e){super(e),this.lastExecutedValue=null,this.mounted=!1,this.editor=null,this.onChange=(o,u)=>{const i=o.document!==this.state.value.document,l=this.state.value;this.props.onRichValueChange&&this.props.onRichValueChange(o),this.setState({value:o},()=>{if(i){const d=_.A.serialize(l)!==_.A.serialize(o);d&&u&&this.runOnChangeAndRunQuery(),d&&!u&&this.runOnChangeDebounced()}})},this.runOnChange=()=>{const{onChange:o}=this.props,u=_.A.serialize(this.state.value);o&&o(this.cleanText(u))},this.runOnRunQuery=()=>{const{onRunQuery:o}=this.props;o&&(o(),this.lastExecutedValue=this.state.value)},this.runOnChangeAndRunQuery=()=>{this.runOnChange(),this.runOnRunQuery()},this.handleBlur=(o,u,i)=>{const{onBlur:l}=this.props;if(l)l();else{const d=this.lastExecutedValue?_.A.serialize(this.lastExecutedValue):"",T=_.A.serialize(u.value);d!==T&&this.runOnChangeAndRunQuery()}return i()},this.runOnChangeDebounced=(0,w.debounce)(this.runOnChange,500);const{onTypeahead:n,cleanText:r,portalOrigin:a,onWillApplySuggestion:s}=e;this.plugins=[U({onTypeahead:n,cleanText:r,portalOrigin:a,onWillApplySuggestion:s}),rt({handler:this.runOnChangeAndRunQuery}),st(),ot(),lt(),ft(),Ot(),...e.additionalPlugins||[]].filter(o=>o),this.state={suggestions:[],typeaheadContext:null,typeaheadPrefix:"",typeaheadText:"",value:Se(e.query||"",e.syntax)}}componentDidMount(){this.mounted=!0}componentWillUnmount(){this.mounted=!1}componentDidUpdate(e,n){const{query:r,syntax:a,syntaxLoaded:s}=this.props;if(!e.syntaxLoaded&&s&&this.editor){const u=this.editor.insertText(" ").deleteBackward(1);this.onChange(u.value,!0)}const{value:o}=this.state;r!==e.query&&r!==_.A.serialize(o)&&this.setState({value:Se(r||"",a)})}cleanText(e){return e.replace(/[\r]/g,"")}render(){const{disabled:e,theme:n}=this.props,r=E()("slate-query-field__wrapper",{"slate-query-field__wrapper--disabled":e}),a=It(n);return f.createElement("div",{className:(0,v.cx)(r,a.wrapper)},f.createElement("div",{className:"slate-query-field","data-testid":te.Tp.components.QueryField.container},f.createElement(ee.KE,{ref:s=>this.editor=s,schema:qe,autoCorrect:!1,readOnly:this.props.disabled,onBlur:this.handleBlur,onClick:this.props.onClick,onChange:s=>{this.onChange(s.value,!1)},placeholder:this.props.placeholder,plugins:this.plugins,spellCheck:!1,value:this.state.value})))}}const k=(0,fe.cV)($);k.defaultProps={onBlur:()=>{}};const It=t=>{const e=(0,_t.Hi)(t);return{wrapper:(0,v.AH)({"&:focus-within":e})}};try{$.displayName="UnThemedQueryField",$.__docgenInfo={description:`Renders an editor field.
Pass initial value as initialQuery and listen to changes in props.onValueChanged.
This component can only process strings. Internally it uses Slate Value.
Implement props.onTypeahead to use suggestions, see PromQueryField.tsx as an example.`,displayName:"UnThemedQueryField",props:{additionalPlugins:{defaultValue:null,description:"",name:"additionalPlugins",required:!1,type:{name:"Plugin<Editor>[]"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},disabled:{defaultValue:null,description:"",name:"disabled",required:!1,type:{name:"boolean"}},query:{defaultValue:null,description:"",name:"query",required:!1,type:{name:"string | null"}},onRunQuery:{defaultValue:null,description:"",name:"onRunQuery",required:!1,type:{name:"(() => void)"}},onBlur:{defaultValue:{value:"() => {}"},description:"",name:"onBlur",required:!1,type:{name:"(() => void)"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!1,type:{name:"((value: string) => void)"}},onRichValueChange:{defaultValue:null,description:"",name:"onRichValueChange",required:!1,type:{name:"((value: Value) => void)"}},onClick:{defaultValue:null,description:"",name:"onClick",required:!1,type:{name:"EventHook<MouseEvent<Element, MouseEvent>>"}},onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},placeholder:{defaultValue:null,description:"",name:"placeholder",required:!1,type:{name:"string"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}},syntax:{defaultValue:null,description:"",name:"syntax",required:!1,type:{name:"string"}},syntaxLoaded:{defaultValue:null,description:"",name:"syntaxLoaded",required:!1,type:{name:"boolean"}},theme:{defaultValue:null,description:"",name:"theme",required:!0,type:{name:"GrafanaTheme2"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/QueryField/QueryField.tsx#UnThemedQueryField"]={docgenInfo:$.__docgenInfo,name:"UnThemedQueryField",path:"src/components/QueryField/QueryField.tsx#UnThemedQueryField"})}catch{}try{k.displayName="QueryField",k.__docgenInfo={description:"",displayName:"QueryField",props:{onChange:{defaultValue:null,description:"",name:"onChange",required:!1,type:{name:"((value: string) => void)"}},onClick:{defaultValue:null,description:"",name:"onClick",required:!1,type:{name:"EventHook<MouseEvent<Element, MouseEvent>>"}},onBlur:{defaultValue:{value:"() => {}"},description:"",name:"onBlur",required:!1,type:{name:"(() => void)"}},disabled:{defaultValue:null,description:"",name:"disabled",required:!1,type:{name:"boolean"}},placeholder:{defaultValue:null,description:"",name:"placeholder",required:!1,type:{name:"string"}},additionalPlugins:{defaultValue:null,description:"",name:"additionalPlugins",required:!1,type:{name:"Plugin<Editor>[]"}},cleanText:{defaultValue:null,description:"",name:"cleanText",required:!1,type:{name:"((text: string) => string)"}},query:{defaultValue:null,description:"",name:"query",required:!1,type:{name:"string | null"}},onRunQuery:{defaultValue:null,description:"",name:"onRunQuery",required:!1,type:{name:"(() => void)"}},onRichValueChange:{defaultValue:null,description:"",name:"onRichValueChange",required:!1,type:{name:"((value: Value) => void)"}},onTypeahead:{defaultValue:null,description:"",name:"onTypeahead",required:!1,type:{name:"((typeahead: TypeaheadInput) => Promise<TypeaheadOutput>)"}},onWillApplySuggestion:{defaultValue:null,description:"",name:"onWillApplySuggestion",required:!1,type:{name:"((suggestion: string, state: SuggestionsState) => string)"}},portalOrigin:{defaultValue:null,description:"",name:"portalOrigin",required:!0,type:{name:"string"}},syntax:{defaultValue:null,description:"",name:"syntax",required:!1,type:{name:"string"}},syntaxLoaded:{defaultValue:null,description:"",name:"syntaxLoaded",required:!1,type:{name:"boolean"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/components/QueryField/QueryField.tsx#QueryField"]={docgenInfo:k.__docgenInfo,name:"QueryField",path:"src/components/QueryField/QueryField.tsx#QueryField"})}catch{}var Et=Object.defineProperty,Pt=Object.defineProperties,bt=Object.getOwnPropertyDescriptors,Ce=Object.getOwnPropertySymbols,Ct=Object.prototype.hasOwnProperty,wt=Object.prototype.propertyIsEnumerable,we=(t,e,n)=>e in t?Et(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,X=(t,e)=>{for(var n in e||(e={}))Ct.call(e,n)&&we(t,n,e[n]);if(Ce)for(var n of Ce(e))wt.call(e,n)&&we(t,n,e[n]);return t},Re=(t,e)=>Pt(t,bt(e)),Rt=(t,e,n)=>new Promise((r,a)=>{var s=i=>{try{u(n.next(i))}catch(l){a(l)}},o=i=>{try{u(n.throw(i))}catch(l){a(l)}},u=i=>i.done?r(i.value):Promise.resolve(i.value).then(s,o);u((n=n.apply(t,e)).next())}),Ae,ke,Ve;const At={title:"Data Source/QueryField",component:k,parameters:{controls:{exclude:["onTypeahead","onChange","onBlur","onClick","onRunQuery","onRichValueChange","onWillApplySuggestion","portalOrigin","additionalPlugins","cleanText","syntax","syntaxLoaded"]}},argTypes:{query:{control:"text"}}},V=t=>f.createElement(k,X({},t));V.args={onTypeahead:t=>Rt(void 0,null,function*(){return{suggestions:[]}}),query:"Query text",placeholder:"Placeholder text",disabled:!1};var kt=At;V.parameters=Re(X({},V.parameters),{docs:Re(X({},(Ae=V.parameters)==null?void 0:Ae.docs),{source:X({originalSource:"(args: Omit<QueryFieldProps, 'theme'>) => <QueryField {...args} />"},(Ve=(ke=V.parameters)==null?void 0:ke.docs)==null?void 0:Ve.source)})})},"../grafana-data/src/text/sanitize.ts":function(Be,F,p){p.d(F,{G$:function(){return D},Jf:function(){return ue},ZD:function(){return H},aj:function(){return se},kE:function(){return de},kc:function(){return oe},oI:function(){return ie},rX:function(){return le}});var f=p("../../node_modules/@braintree/sanitize-url/dist/index.js"),v=p("../../node_modules/dompurify/dist/purify.js"),C=p.n(v),E=p("../../node_modules/xss/lib/index.js"),w=p.n(E),_=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,P=(c,y,x)=>y in c?_(c,y,{enumerable:!0,configurable:!0,writable:!0,value:x}):c[y]=x,ae=(c,y)=>{for(var x in y||(y={}))ne.call(y,x)&&P(c,x,y[x]);if(L)for(var x of L(y))re.call(y,x)&&P(c,x,y[x]);return c},z=(c,y)=>ee(c,te(y));const M=Object.keys(E.whiteList).reduce((c,y)=>{var x;return c[y]=(x=E.whiteList[y])==null?void 0:x.concat(["class","style"]),c},{}),Q=new E.FilterXSS({whiteList:M,css:{whiteList:z(ae({},E.getDefaultCSSWhiteList()),{"flex-direction":!0,"flex-wrap":!0,"flex-basis":!0,"flex-grow":!0,"flex-shrink":!0,"flex-flow":!0,gap:!0,order:!0,"justify-content":!0,"justify-items":!0,"justify-self":!0,"align-items":!0,"align-content":!0,"align-self":!0})}});function se(c){try{return C().sanitize(c,{USE_PROFILES:{html:!0},FORBID_TAGS:["form","input"]})}catch{return console.error("String could not be sanitized",c),H(c)}}function oe(c){return C().sanitize(c,{RETURN_TRUSTED_TYPE:!0,ADD_ATTR:["xmlns:atom","version","property","content"],ADD_TAGS:["rss","meta","channel","title","link","description","atom:link","item","pubDate","guid"],PARSER_MEDIA_TYPE:"application/xhtml+xml"})}function ie(c){return C().sanitize(c,{RETURN_TRUSTED_TYPE:!0})}function D(c){try{return Q.process(c)}catch{return console.error("String could not be sanitized",c),"Text string could not be sanitized"}}function le(c){return C().sanitize(c,{USE_PROFILES:{svg:!0,svgFilters:!0}})}function ue(c){return(0,f.J)(c)}function de(c){return/\u001b\[\d{1,2}m/.test(c)}function H(c){return String(c).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")}}}]);
